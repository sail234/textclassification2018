计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 一个 新型 组播 会 话 目录 服务体系 舒 南燕 ， 方乐 ， 白雪 峰 ， 徐 公权 摘要 ： 介绍 分层 媒体 传输 模型 基础 上 的 新型 组播 会 话 目录 服务体系 ， 可 提高 分层 媒体 传输 中 的 信道 带宽 利用效率 ， 并 降低 目录 服务 客户端 的 启动 延迟 。 关键词 ： 组播 ； 目录 服务 ； 分层 媒体 NewArchitectureforMulticastSessionDirectoryServiceShuNanyanFangLeBaiXuefengXuGongquanCenterofCADCAIMultimediaMakingFuDanUniversityShanghai 【 Abstract 】 TheconceptoflayeredmediaishelpfultothesituationinthqatscalabilityofrealtimeapplicationremainschallengedbytheinherentheterogeneityoftheunderlyingInternetWeproposeanewarchitectureformulticastsessiondirectoryserviceclient 【 Keywords 】 MulticastDirectoryserviceLayeredmedia 　 　 近来 借助于 新型 协议 和 工具 ， 在 Internet 上 实时 组播 逐步 成熟 。 实时 组播 是 建立 在 一系列 协议 堆上 的 ， 协议 堆 的 底部 是 IP 组播 协议 ， 它 提供 有效 的 一对 多 数据传输 。 但 目前 的 组播 应用 尚存 在 以下 问题 。 　 　 各 主机 以 不同 速率 连接 在 Internet 上 ， 导致 了 Internet 底层 固有 的 异构 性 ， 而 IP 组播 服务 不 保证 可靠 传输 ， 也 不 提供 任何 形式 的 阻塞 控制 。 因此 ， 基于 一对 多 传输 的 组播 服务 需要 有 一定 的 控制 机制 以 防止 不合理 的 带宽 使用 － 避免 组播 信息 阻塞 通向 某些 主机 的 慢速 连接 而 另 一些 网段 负荷 不足 。 　 　 为了 确保 会话 公告 不 占用 过多 的 带宽 ， 送往 广域 Mbone 的 会 话 公告 的 带宽 被 限制 在 bs ， 当会话 发起方 个 公告 平均 信息 长度 为 B 的 会 话 时 ， 这种 限制 将 导致 单个 会话 的 多次 公告 间隔时间 达到 十几 到 几十分钟 。 同时 由于 不 可靠 的 组播 ， 目录 服务 客户端 必须 等待 分钟 才能 看到 某个 会话 公告 。 　 　 这是 Internet 上 发展 组播 应用程序 时 不能 回避 的 两个 问题 。 在 相当程度 上 ， 这 两个 问题 的 解决 情况 将 影响 组播 应用 在 Internet 上 的 推广 。 不仅 需要 有 针对 每个 问题 的 解决 方法 ， 更 需要 在 现有 协议 框架 上 综合 考虑 。 背景 知识 分层 媒体 传输 　 　 分层 媒体 传输 是 Deering 提出 的 一个 端 对 端的 解决方案 ， 针对 在 底层 异构 的 Internet 上 IP 组播 服务 缺乏 阻塞 控制 机制 的 问题 。 媒体 分层 的 思想 是 ： 使用 一个 层次化 的 编码 算法 ， 将源 数据编码 成 一系列 的 层 llln 一个 解码器 在 其余 层 缺失 的 情况 下能 将 一个 有序 的 层次 子集 llli ， in 解码 。 解码器 端 可用 的 层次 越 多 ， 重组 信号 产生 的 扭曲 就 越少 。 最底层 为 基层 ， 高层 为 提高 层 。 每个 层 对应 一个组 播组 。 在 基本 的 IP 组播 服务 模型 中 ， 接受 端 加入 或 离开 组播 组 接收 不同 的 层 ， 根据 其 本身 能力 调整 它 所 受 的 服务 。 这种 基本 架构 被 细化 为 一种 特殊 的 协议 框架 － 接收端 驱动 分层 组播 RLMReceiverdrivenLayeredMulticastscope － 组播 范围 界定 　 　 组播 范围 是 一种 限制 组播 数据 传播 范围 的 机制 。 通过 限制 只 在 有 管理 意义 的 网络 区域 内 传输 公告 信息 ， 降低 了 传输 带宽 ， 同时 在 不同 区域 之间 可 复用 有限 的 组播 地址 集 ， 提高 了 网络 的 可扩展性 。 　 　 如何 界定 组播 范围 ？ IP 组播 服务 模型 提供 两种 机制 。 当 IP 组播 最初 建立 时 ， IP 报文 头里 用来 限制 报文 在 路径 上 跳跃 时间 的 TimeToLiveTTL 域 被 用来 限制 区域 。 报文 经过 路由器 时 TTL 域 减 。 当 减少 到 时 ， 报文 被 丢弃 。 由于 用户 可能 对 网络 的 拓扑 情况 不是 很 了解 ， 导致 不能 正确 设置 合适 的 TTL ， 因此 TTL 限制 并 不 十分 有效 。 另 一种 方法 可以 让 网络管理员 通过 设置 TTL 阈值 定义 简单 的 管理 区域 。 设置 了 TTL 阈值 的 路由器 将 丢弃 任何 TTL 域 低于 阈值 的 组播 包 。 然而 TTL 界定 方法 缺乏 灵活性 ， 并且 TTL 界定 方法 与 某些 组播 路由 协议 的 交互性 很差 。 所以 系统管理 界定 被 提出 作为 TTL 界定 的 替代 。 　 　 在 系统管理 界定 中 ， 边界 由 组播 地址 而 不是 由 TTL 域来 界定 。 网络管理员 为 该 范围 选择 一系列 地址 ， 并 在 区域 边界 上 配置 所有 的 组播 路由器 ， 使 路由器 丢弃 所有 经过 区域 边界 准备 发 往 地址 范围 内 地址 的 包 。 　 　 系统管理 界定 的 一个 通常 用法 是 圈定 一个 使用 高速 带宽 连接 的 区域 ， 使 高速传输 不会 漏向 较 低速 的 网络 。 建立 IP 组播 基础 上 的 SAP 　 　 SAPSessionAnnouncementProtocol 服务 公告 协议 。 SAP 使用 会话 公告 模式 ， 定期 公告 会话 描述 至 一个 共知 的 引导 地址 ， 公告 中 描述 特定 媒体 流 和 特定 组播 地址 的 绑定 。 在 客户端 ， 会话 目录 工具 维护 一张 表格 ， 列出 了 所有 近来 通过 SAP 公告 的 会 话 描述 。 因为 会话 公告 包括 了 启动 实际 应用 所 需 的 所有 信息 ， 当 用户 选择 一个 程序 时 ， 会话 目录 工具 可以 运行 相应 的 应用 ， 使 用户 从 烦琐 的 命令行 参数 和 地址 处理 中 解脱 出来 。 当会话 目录 工具 收到 一个 描述 时 ， 定时器 被 设置 。 定时器 超时 后会 话 被 删除 。 定时器 时间 大约 被 设定 在 几倍 于 公告 间隔 。 正常 操作 时 ， 一个 激活 的 会 话 描述 被 定期 的 信息 不断 刷新 。 当 一个 会话 过期 或 应用程序 宣告 其 停止 运行 时 ， 会话 描述 最终 超时 。 使用 该项 技术 的 协议 称为 公告 监听 协议 ， 它 不仅 简单 而且 强壮 ， 如果 一个 信息 在 网络 上 丢失 ， 公告 描述 将 被 下 一次 传输 的 信息 刷新 ， 如果 应用程序 崩溃 ， 公告 会 自动 超时 。 　 　 SAP 及其 补充 地址 分配 算法 依靠 组播 范围 概念 提高 可扩展性 。 在 每个 管理 界定 的 区域 内 ， 运行 一个 SAP 实例 。 由 区域 边界 上 的 组播 路由器 限制 针对 局部 区域 的 会 话 公告 只 在 该 局部 区域 内 发送 ， 从而 降低 公告 带宽 ， 空间 复用 组播 地址 ， 同时 也 保证 了 主机 只 收到 他们 能够 参与 的 会 话 的 公告 。 　 　 SDPSessionDescriptionProtocol 会话 描述 协议 定义 了 一个 标准 格式 ， 包括 媒体 信道 描述 媒体 类型 和 格式 ， 传输 协议 ， 网络地址 和 端口 ， 时间 信息 和 其他 会话 描述 信息 。 SAP 会话 公告 以 SDP 报文 形式 传播 。 一个 新型 会话 目录 服务体系 新型 会话 目录 服务体系 及 代理 机制 的 引入 　 　 媒体 分层 传输 模型 简单 直观 ， 但是 其中 的 一些 问题 必须 在 具体 实现 中 加以解决 ： 　 　 首先 是 地址 分配 问题 。 使用 该 模型 ， 会话 目录 服务 必须 公布 媒体 流在 其 上 传输 的 一列 组播 组 的 地址 。 这些 地址 由会话 发起方 在 创建 会话 时 分配 。 一个 直接 的 方法 是 为 包括 所有 参与者 的 最 小组 播 范围 分配 一块 地址 。 但是 会 产生 如图所示 的 问题 ： 图多 数据源 的 分层 媒体 接收端 适应 　 　 媒体 流分 两层 ， 由 某 主机 发起 ， R ， S ， S 参加 。 两个 组播 地址 代表 两层 数据流 。 若 R 没有 针对 单独 数据源 修剪 流量 的 能力 。 R 只能 参加 基层 ， 否则 从 S 来 的 高速 数据流 将 阻塞 慢速 连接 。 若 R 具有 针对 数据源 的 修剪 能力 ， R 可以 加入 提高 层 传输 而 修剪 掉 由 S 来 的 提高 层 。 这样 R 接收 由 S 来 的 高速传输 就 不会 阻塞 与 S 的 链路 。 广而言之 ， 如果 所有 传输 的 参与方 共用 一套 组播 地址 ， 接收端 必须 有 能力 针对 单独 的 数据源 修剪 流量 。 目前 的 组播 服务 模型 不 提供 这种 特性 。 而且 至少 若干年 后 ， 才能 大规模 地 扩展 IP 组播 服务 使 之 有 这种 能力 。 　 　 其次 ， RLM 模型 通过 增加 订阅 的 层 定期 试探 未 使用 的 带宽 。 这种 试探 是 破坏性 的 ， 特别 当 接受方 知道 高带宽 的 提高 层 超过 其 与 发送 方 的 实际 物理 连接 能力 ， 而 仍然 做 未 使用 带宽 的 试探 ， 宝贵 的 带宽 将 浪费 在 超时 重传 上 。 这种 情况 类似 于 对 一条 建立 在 低速 调制 解调 连接 上 的 TCP 连接 ， 增大 拥塞 窗 以至于 超过 modem 线 的 实际 物理 能力 。 　 　 目录 服务体系 较 好地解决 上述 两个 问题 。 针对 第一个 问题 ， 管理 范围 边界 上 的 路由器 将 防止 高速 提高 层流 到 管理 范围 外 。 针对 第二个 问题 ， 由于 已 限定 了 不同 速率 媒体 流 的 传输 范围 ， 接收端 无需 再 做 带宽 的 探测 。 但是 ， 当前 Internet 会议 创建 体系 并 不 支持 这种 地址 分配 方式 。 在 当前 的 体系 中 ， 由会话 发起方 为 媒体 流 分配 所有 的 地址 ， 而 我们 需要 在 本地 管理 范围 内 分配 提高 层 地址 。 显然 ， 一个 会话 发起方 不 可能 为 网络 中 每 一个 能 使用 提高 层 的 局部 管理 范围 分配 所 需 的 地址 。 为此 ， 我们 进一步 引入 代理 机制 ， 由会话 发起方 为 其 所在 的 管理 范围 分配 提高 层 地址 ， 而 在 远程 区域 ， 由 代理 代为 在 当地 公告 地址 。 代理 机制 的 引入 可 解决 地址 分配 问题 ， 同时 ， 比起 其他 方法 ， 其 优点 在于 ： 代理 可以 由 一个 程序实现 ， 能 在 其中 实现 一些 其他 的 功能 ， 解决 目录 服务 中 的 其他 问题 。 由 代理 支持 分层 媒体格式 　 　 SDP 按 最初 的 定义 可以 描述 分层 会话 ， 并 允许 由 多个 SDP 信息 组成 一个 SDP 负荷 。 当 描述 所有 层 不 在 同一 范围 内 传输 的 分层 会话 时 ， 需要 多个 SDP 信息 ， 并且 SDP 信息 要 提供 相应 的 保障机制 ， 当 不同 层 传输 到 不同 范围 时 ， 能够 重组 已 分层 的 会 话 并 正确 公告 。 　 　 l 会话 描述 　 　 SDP 描述 分层 会话 ， 要 在 媒体 信道 描述 中 确定 一列 连续 地址 作为 将 公告 的 区域 。 不 连续 的 地址 不能 被 描述 。 当会 话 的 不同 层 被 传播 至 不同 的 范围 时 ， 如果 只用 一个 SDP 信息 ， 有 两种 情况 可能 发生 ： 如果 这时 一个 包含 所有 地址 的 公告 在 广域 内 被 公布 ， 所有 接收者 会 看见 提高 层 的 地址 ， 然而 这些 地址 对于 管理 区域 外 的 接收端 并 不 有效 ， 而 在 IP 组播 服务 模型 中 ， 接收端 难以确定 是否 和 另 一 主机 处于 同一 区域 。 所以 ， 如果 一个 公告 包含 了 提高 层 的 地址 ， 接收端 不易 确定 提高 层 是否 可用 ； 相反 ， 如果 会话 公告 只 在 管理 范围 内 传输 ， 这样 范围 外 的 接收端 不能 看见 对 基层 的 公告 ， 而 这 原本 是 应当 被 接收 到 的 。 所以 要 描述 上述 目录 服务体系 中 的 会 话 ， 须 使用 多个 SDP 信息 。 每个 SDP 信息 中 包含 同一 管理 范围 内 的 一列 连续 地址 ， 但 不 包括 不同 范围 内 的 地址 。 当 使用 SDP 信息 描述 SAP 公告 时 ， 信息 在 某个 范围 内 公告 ， 信息 也 在 同一 区域 内 组播 。 　 　 信息 重构 　 　 会话 目录 工具 必须 识别 组成 同一个 公告 的 单独 的 SDP 信息 。 这 由 SDP 中 的 一个 域 o 保证 。 在 每个 会话 中 ， 对 组成 同一个 公告 的 所有 信息 o 域 设置 得 一样 ， 客户端 可以 识别 组成 一个 公告 的 所有 信息 。 一旦 相应 的 信息 被 接收 到 ， 还 需要 启动 相应 的 媒体工具 重排 信息 。 这 由 SDP 属性 attribute 机制 完成 。 SDP 属性 采用 名字 ： 值 的 规范 形式 。 层 属性 句法 如下 ： alayersfirstlasttotal 　 　 带 括号 的 参数 为 可选 。 属性 包含 层数 或 一个 层 范围 如 或 ， 可选 的 是 总 层数 。 如果 出现 总数 ， 则 直到 所有 层 地址 被 接收 ， 一个 公告 才 算 完整 。 对 一些 分层 传输 方案 ， 层 总数 无需 对 每个 接收端 都 相同 。 在 这种 情况 下 ， 总 层数 不 确定 ， 如果 到 某个 时刻 的 全部 层 都 接收 到 ， 一个 公告 即 被 认为 完成 。 也 有 可能 一个 或 多个 包含 更 高层 地址 的 信息 尚未 到达 ， 公告 即 被 认为 完成 。 所以 在 决定 公告 已经 完整 前 ， 应用程序 应该 为 可能 到来 的 提高 层 等待 一小 段时间 。 　 　 代理 完成 缺失 层 的 分配 　 　 上述 的 SDP 信息结构 使会话 公告 代理 有 能力 发现 不 完整 的 会 话 公告 。 当 规定 了 会 话 总 层数 ， 而 在 本地 范围 内 一些 层 未 被 分配 时 ， 在 任何 本地 成员 加入 会话 前 ， 代理 必须 分配 缺少 的 层 。 如果 有 很多 类似 的 不 完整 会话 组 ， 为 所有 的 会 话 分配 地址 会 浪费 组播 地址 。 因为 广域 范围 内 公布 的 会 话 总数 不 多 ， 可以 暂时 不 考虑 这个 问题 。 可能 的 解决 方法 是 在 代理 内部 定义 一种 策略 ， 决定 哪些 会话 保留 不 完整 状态 。 另外 ， 可定义 一种 机制 ， 让 用户 自己 向 代理 表达 对 某个 会话 的 兴趣 ， 代理 分配 缺失 的 层 ， 完整 该 公告 来 回应 用户 。 　 　 对于 未定义 总 层数 的 会 话 ， 问题 比较 难 解决 。 一个 会话 无论 何时 都 可 被 认为 是 完整 的 。 但是 如果 局部 参与者 对会 话 有 一定 兴趣 ， 一个 代理 不 知道 是否 应该 分配 本地 高带宽 提高 层 。 在 实现 中 ， 可 设置 代理 对 每个 会话 具有 一个 目标 层数 。 当 遇到 一个 层数 少于 目标值 的 会 话 ， 另 分配 层 使 总 层数 达到目标 数 。 由 代理 实现 降低 目录 服务 客户端 启动 延迟 　 　 代理 是 人为 实现 的 程序 ， 在 代理 中 实现 其他 的 功能 可以 解决 目录 服务体系 中 的 其他 问题 。 　 　 如前所述 ， 由于 SAP 公告 所用 带宽 的 限制 ， 造成 目录 服务 客户端 较长 的 启动 延迟 。 一种 解决 方法 是 在 代理 中 加入 cache ， 当 代理 监听 所有 的 SAP 公告 时 ， 它 顺便 维护 一个 cache ， 其中 包括 当前 被 公告 的 会 话 。 当 一个 目录 服务 客户端 启动 时 ， cache 中 的 内容 被 迅速 传播 到 客户端 ， 而 降低 了 客户端 的 启动 时间 。 我们 可以 建立 一条 从 客户端 到 cache 的 TCP 连接 实现 会话 目录 客户端 和 cache 间 的 通信 。 通过 TCP 通道 传递 所有 的 变化 ， 如会 话 的 创建 ， 更新 ， 超时 等 。 对于 少量 客户端 而言 ， 这种 解决 方法 是 有效 的 ， 但是 不易 扩展 到 很多 客户端 的 环境 。 对于 很多 客户 ， cache 必须 承担 同时 维护 许多 TCP 连接 的 重荷 。 由于 所有 的 会 话 更新 必须 向 所有 的 客户 分别 传输 ， 到 cache 的 带宽 不能 得到 有效 利用 。 　 　 更好 的 解决 方法 是 在 代理 中 引入 由 Amir 提出 的 软 网关 的 概念 。 代理 中 软 网关 的 实现 如下 所述 ： 由 软件 实现 两个 SAP 会话 的 协议 实例 ， 一个 运行 在 全局 SAP 会话 范围 ， 一个 运行 在 本地 管理 界定 区域 。 前 一个 协议 实例 监听 广域 信道 上 的 SAP 公告 ， 输出 一个 描述 当前 会话 更新 的 列表 ， 该 列表 作为 后 一个 协议 实例 的 输入 。 广域 SAP 信道 上 被 接收 的 每个 会话 公告 被 该 软 网关 在 本地 范围 内 重新 公告 。 由于 在 本地 区域 内 的 带宽 上限 远高于 广域 范围 内 的 上限 ， 结果 使得 会话 描述 的 发送 更 频繁 ， 会话 客户端 的 列表 也 被 更 快 地 更新 。 　 　 软 网关 可以 大大降低 会话 目录 客户端 的 启动 时间 。 假设 总共 有 N 个会话 需要 公告 ， 平均 长度 为 size ， 累计 用于 SAP 的 带宽 为 bw ， SAP 信息 由 UDP 包 携带 发送 ， 而 UDP 不 保证 可靠 发送 。 那么 ， 在 会 话 目录 客户端 在 启动 阶段 ， 如果 一个 会话 公告 丢失 ， 则 客户端 必须 等到 公告 被 重传 。 n 表示 会话 目录 客户端 收到 所有 公告 前 预计 需 传输 的 公告 数 ， p 为 包 独立 丢失 率 。 会话 目录 客户端 接收 到 所有 公告 前 预计 的 时间 为 ： 　 　 由于 接收 方要 同时 监听 本地 和 广域 的 公告 ， 其中 参数 bw 是 本地 带宽 加 广域 带宽 固定 为 bs 。 预计 的 目录 工具 启动 时间 与 本地 带宽 的 关系 如图所示 。 其中 ， N ＝ ， sizeB ， p 。 图中 SAP 带宽 为 处 对应 没有 软 网关 的 情况 ， 即 客户端 只 在 广域 SAP 信道 上 接收 公告 。 由此可见 ， 软 网关 使会话 目录 工具 的 启动 延迟 大大降低 。 图 SAP 带宽 与会 话 目录 启动 时间 　 　 在 没有 软 网关 时 ， 包 丢失 率 是 影响 启动 延迟 的 关键 。 因为 在 大多数 情况 下 ， 软 网关 和 客户端 之间 的 包 丢失 可以 忽略不计 ， 所以 软 网关 相对 于 TCP 连接 有 两个 优点 ： 提高 带宽 带来 的 更 快 的 收敛 ， 降低 包 丢失 率 带来 启动 延迟 的 降低 。 总结 与 展望 　 　 底层 的 异构 性是 Internet 上 的 组播 应用程序 必须 注意 的 一个 问题 。 本文 在 分层 媒体 基础 上 介绍 的 这种 新 的 会 话 目录 服务体系 ， 避免 了 由于 接收端 不能 针对 数据源 修剪 流量 和 做 无谓 带宽 尝试 造成 的 性能 下降 ， 并且 引入 代理 机制 ， 实现 会话 公告 的 重播 ， 大大降低 了 目录 服务 客户端 的 启动 延迟 。 如前所述 ， 代理 机制 为 解决 组播 目录 服务 中 的 其他 问题 提供 了 空间 。 本文 所述 的 目录 服务 客户端 启动 延迟 的 降低 只是 一个 例子 。 代理 中 还 可以 实现 其他 功能 。 在 未来 的 工作 中 ， 我们 将 讨论 用户 根据 需要 加入 任意 服务 组合 的 可能性 ， 进一步 ， 讨论 在 代理 中 实现 针对 每个 用户 的 组播 服务质量 的 控制 。 总之 ， 以 代理 为 工具 ， 解决 组播 应用程序 在 目录 服务 方面 的 问题 ， 不断完善 该 目录 服务体系 将 是 我们 今后 工作 的 重点 。 　 　 Internet 上 的 组播 应用 是 Internet 上 新 出现 的 事物 。 由于 Internet 底层 的 异构 性 ， 组播 服务 比 一对一 的 数据传输 在 流量 控制 等 方面 更 复杂 。 如果 还有 大容量 的 多媒体 数据传输 ， 真正 实现 组播 应用 还 需要 更 多 的 努力 。 本文 所 介绍 的 会 话 目录 服务体系 只是 在 这方面 的 一个 尝试 ， 希望 能 和 大家 探讨 。 作者 单位 ： 复旦大学 CADCAI 多媒体 制作 中心 ， 上海 参考文献 TanenbaumAComputerNetworksThirdEditionUS ： PrenticeHallPTRDeeringSInternetMulticastRoutingStateoftheArtandOpenResearchIssuesStockholmMultimediaintegratedConferencingforEuropeMICESeminarattheSwedishInstituteofComputerScience