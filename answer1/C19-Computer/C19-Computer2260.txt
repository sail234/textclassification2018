计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 P 基于 景物 特征 的 粒子系统 建模 技术 杨冰 　 鲁敏 摘要 提出 一种 基于 景物 特征 的 粒子系统 建模 技术 。 与 传统 的 粒子系统 建模 方法 不同 ， 该 算法 首先 提取 景物 特征 ， 然后 就 特征 点以 粒子 表示 和 实现 ， 其余部分 利用 特征 的 空间 相关性 插值 得到 。 利用 该 技术 ， 可以 方便 解决 传统 的 粒子系统 建模 中 ， 大 运算量 和 大 存储量 问题 。 实验 表明 ， 该 方法 可 在 微机 环境 实现 不规则 模糊 景物 的 实时 动态 生成 和 显示 。 关键词 粒子系统 特征 实时 火焰 模拟 引言 　 　 在 现实 世界 中 ， 自然 景物 常常 具有 极其丰富 的 表面 纹理 细节 和 不规则 的 表面 外形 。 在 对 这些 景物 的 计算机 模拟 过程 中 ， 如果 仅仅 采用 传统 的 计算机 图形学 方法 对 表面 细节 一一 进行 造型 ， 然后 再 场景 绘制 、 渲染 显然 不切实际 。 由于 人眼 的 分辨率 和 计算机 显示器 的 分辨率 是 有限 的 ， 场景 中 过分 详尽 的 细节 并 不会 增加 人 对 场景 景物 的 理解 ； 并且 ， 对 在 微机 条件 下 场景 的 实时 生成 ， 巨大 的 计算 量 往往 使 之 成为 图形 生成 显示 的 瓶颈 ， 因此 ， 如何 简化 且 有效 地 模拟 如 火焰 、 烟云 等 自然 景物 成为 计算机 真实感图形 生成 的 关键技术 。 　 　 为了 用 计算机 绘制 出 各种 真实 的 自然 景物 ， 需要 对 景物 的 不规则 表面 几何 纹理 进行 有效 地 表示 及 绘制 。 近年来 国内外 主要 集中 在 两个 方面 的 研究 ： 一种 是 对 常规 景物 模型 进行 随机 扰动 ， 从而 获得 不规则 的 景物 表面 形状 ； 第二种 就是 所谓 算法 模型 ， 即 通过 使用 一种 递归 模式 ， 引入 随机变量 ， 实现 对 不规则 物体 的 造型 。 几种 成功 的 模拟 不规则 景物 表面 的 方法 如 ： Blinn 在 年 提出 的 法向 扰动 法 １ ， 主要 用于 模拟 表面 细微 的 凹凸不平 的 景物 ； fBm 方法 ６ ， 它 使用 随机 过程 来 模拟 不规则 物体 ， 很 好 地 描述 了 许多 自然 现象 如 地域 、 星球 表面 、 山脉 、 丛林 等 ； WTReeves 在 年 提出 的 粒子系统 方法 ， 它 不同于 传统 的 图形学 方法 ， 充分体现 了 不规则 模糊 物体 的 动态性 和 随机性 ， 很 好 地 模拟 了 火 、 云 、 水 、 森林 和 原野 等 许多 自然 景象 。 　 　 由于 粒子系统 考虑 物体 由 许多 形状 简单 的 如点 、 小 立方体 、 小 球体 等 的 微小 粒子 单元 构成 ， 因而 对于 空间 中 一个 不大 的 体 区域 ， 构成 它 的 粒子 数目 却是 惊人 的 。 传统 的 粒子系统 方法 对 计算机 的 存储量 和 计算速度 要求 过高 ， 使得 图形 实时 交互 显示 在 微机 环境 下 一般 不 可能 实现 。 本文 采用 在 三维 物体 表面 提取 特征 点 ， 并 利用 物体 特征 的 空间 连续性 ， 改进 传统 的 粒子系统 方法 ， 提出 基于 景物 特征 的 粒子系统 建模 算法 ， 方便 地 实现 微机 环境 下 的 模糊 不规则 物体 的 实时 生成 和 显示 。 粒子系统 基本原理 　 　 粒子系统 的 基本 设计 思想 是 采用 许多 形状 简单 的 微小 粒子 作为 基本 元素 来 表示 不规则 模糊 物体 。 这些 粒子 都 赋予 一定 的 “ 生命 ” ， 它们 在 系统 中 都 要 经历 “ 诞生 ” 、 “ 运动 和 生长 ” 及 “ 死亡 ” 三个 阶段 。 由于 粒子系统 是 一个 有 “ 生命 ” 的 系统 ， 因而 它 不 像 传统 方法 那样 只能 生成 瞬时 静态 景物 画面 ， 而 可 产生 一系列 运动 进化 的 画面 。 这 使得 模拟 动态 的 自然 景象 成为 可能 。 传统 的 基于 粒子系统 方法 的 物体 模型 是 用 粒子 的 诞生 、 活动 和 死亡 三个 阶段 来 描述 ， 并且 这 三个 阶段 具有 随机性 ， 在 某 一 时刻 存活 的 粒子 集合 就 构成 物体 模型 。 　 　 粒子 的 诞生 用 随机 函数 控制 ， 第 fi 帧 新 诞生 粒子 数目 PNfiPN — ParticleNumber 为 ： 式 中 rand 是 上 均匀分布 的 随机 函数 ， PMfiPM — ParticleMean 和 PVfiPV — ParticleVariance 是 第 fi 帧 新 诞生 粒子 数目 的 平均值 和 方差 ， 可定义 为 常数 也 可定义 为 变量 ， 如 定义 式 中 f 是 粒子系统 的 初始 帧 号 ， PMf 和 △ PM 是 第 f 帧 新 诞生 粒子 数目 的 平均值 和 变化率 ， 是 常数 。 对 新 产生 的 粒子 ， 系统 赋予 它们 一些 初始 随机 属性 ， 如 初始 运动 方向 、 初始 颜色 、 初始 透明度 、 粒子 形状 以及 生存期 等 。 粒子 的 初始 位置 sf 由 粒子 的 诞生 区域 决定 粒子 的 初始 速度 vf 粒子 的 平均速度 mvrand × 　 　 　 　 　 　 　 　 　 　 粒子 的 速度 方差 vv 粒子 的 初始 颜色 cf 粒子 的 平均 颜色 mcrand × 　 　 　 　 　 　 　 　 　 　 粒子 的 颜色 方差 vc 粒子 的 初始 透明度 tf 粒子 的 平均 透明度 mtrand × 　 　 　 　 　 　 　 　 　 　 　 粒子 的 透明度 方差 vt 粒子 的 生存期 lf 粒子 的 平均 生存期 mlrand × 　 　 　 　 　 　 　 　 　 粒子 的 生存期 方差 vl 　 　 在 计算 上述 初始 属性 时 ， 平均值 和 方差 都 是 用户 给定 的 常数 。 　 　 粒子 在 它 的 运动 和 生长 过程中将 随机 地 改变 其 自身 属性 。 已知 fi 帧 时 粒子 的 属性 值 ， 则 fi 帧 时 粒子 的 属性 值 可 按 下式 计算 ： 位置 ： 速度 ： 颜色 ： 透明度 ： 生存期 ： 式 中 fi 为 帧 号 ， i ， ， ， ， n ， 当 i 时为 粒子 的 初始 属性 ， a 、 △ c 、 △ t 为 粒子 的 加速度 、 颜色 变化率 、 透明度 变化率 。 可定义 为 常数 。 　 　 粒子 的 死亡 。 粒子 诞生 时 被 赋予 生存期 ， 该 生存期 以 帧 数 度量 ， 并 随 每 帧 的 播放 而 递减 ， 当 减至 零时 该 粒子 即 死亡 ， 应从 粒子系统 中 删除 掉 。 基于 特征 的 粒子系统 建模 　 　 本 节 我们 将 介绍 一种 利用 景物 特征 的 空间 相关性 ， 提取 特征 点 简化 粒子系统 建模 的 算法 。 该 算法 针对 不同 的 不规则 的 模糊 景物 ， 首先 勾画 景物 表面 特征 ， 抛弃 不 可见 的 内部 体 ， 然后 就 景物 表面 再 提取 关键点 ， 以 粒子 定义 它 的 属性 ， 表面 上 其余部分 的 属性 通过 空间 插值 得到 ， 下面 我们 以 火焰 模型 为例 ， 详细 介绍 这种 算法 的 建模 过程 。 火焰 的 表面 特征 勾画 　 　 传统 的 火焰 模型 ， 粒子 视作 点光源 ， 充满 空间 的 某 一 区域 ， 同一 视线 上 多个 重叠 粒子 的 颜色 调配 值 作为 对应 象素 的 颜色 ， 粒子 存在 的 整体 空间 作为 火焰 的 存在 空间 。 而 改进 的 算法 仅 考虑 景物 可见 的 表面 特性 ， 将 景物 视作 一个 中空 的 面 物体 ， 此时 景物 表面 特性 是 融合 了 内部 属性 后 的 特性 ， 是 火焰 整体 所 表现 的 属性 。 这 就 要求 在 进行 表面 勾画 时 ， 必须 充分体现 景物 所 表现 的 外部 形状 和 色彩 。 　 　 在 火焰 的 模拟 中 ， 由于 自然界 存在 的 真实 火焰 形状 和 色彩 是 不定 和 动态 的 ， 无法 以 一种 简单 同一 的 模型 定义 ， 因而 我们 将 它 细分 ， 以 火苗 作为 火焰 的 构成 单元 。 根据 我们 对 自然界 火焰 的 直观 观察 ， 提取 火焰 基本特征 ， 定义 火苗 的 空间 基本 形状 如图 。 采用 一端 平滑 ， 一端 较为 尖锐 的 纺锤体 模拟 火苗 的 基本 形状 ， 中轴线 将 控制 火苗 在 动态 变形 中 的 整体 扭曲 效果 。 考虑 到 算法 的 实时性 ， 对 空间 曲面 的 定义 不用 函数 的 形式 ， 而是 预先 计算 曲面 某些 特征 点 的 空间 坐标 ， 定义 时以 赋值 的 方法 直接 规定 它 的 大致 外形 。 火苗 表面 的 颜色 基本 分布 为 ： 焰底 是 较为 明亮 的 白 、 黄色 ， 火焰 中段 由 黄渐 红 过渡 ， 焰 顶 颜色 逐渐 变黑 ， 整体 颜色 分布 呈 连续 的 过渡形式 。 图 火苗 基本 形状 和 颜色 分布 　 　 为了 简化 运算 ， 火苗 表面 采用 简单 的 三角 剖分 ， 三角形 的 顶点 也 就是 曲面 表面 特征 点 。 一般 选择 特征 点 数目 为 × 即将 表面 分割 为层 ， 每层 均 为 一 圆形 ， 在 每 一个 圆形 上 等 间隔 取个 点 ， 这种 选法 一方面 考虑 到 必须 有 足够 的 点 以 保证 其 基本 外形 ； 另一方面 点数 过多 ， 将 不仅 增加 运算量 ， 还会 因为 火焰 表面 相近 的 两点 相关性 减弱 ， 使得 在 火焰 运动 时 ， 产生 表面 毛刺 ， 引起 图形 失真 。 至此 ， 我们 完成 了 火焰 模型 的 基本 外形 勾画 。 真实感 火焰 生成 技术 　 　 在 火苗 模型 的 基本 外形 基础 上 ， 将 表面 特征 点 按 一定 规则 定义 为 具备 一定 属性 的 发光 粒子 ， 实现 火苗 表面 的 随机 扰动 。 再 加入 火苗 整体 的 空间 扭动 参量 SpaceOffset ， 生成 真实感图形 ， 具体 实现 的 关键技术 有 ： 　 　 粒子 的 属性 参数 包括 粒子 的 空间 位置 、 运动 方向 、 运动 速度 、 颜色 、 透明度 和 生存期 的确 　 定 。 本文 第一节 已经 介绍 过 这些 参数 的 基本 确定 方法 。 对应 本 算法 ， 不同点 在于 ： 粒子 的 基本 属性 由该 粒子 对应 的 特征 点 的 基本 性质 决定 ， 它 的 变动 只是 一定 范围 内 的 随机 扰动 ； 一旦 有 某 一个 粒子 死亡 ， 将 立即 诞生 一个 新 的 粒子 以 对 应该 特征 点 ， 即 粒子 的 数目 在 整个 运动 过程 中 保持 恒定 。 　 　 特征 点 的 空间 位置 最终 是 由 粒子 的 位置 参数 和 火苗 整体 扰动 位置 参数 合成 的 结果 。 其中 Pi ： 第 i 个 粒子 ； Lj ： 粒子 Pi 所在 的 层 ； 　 　 对应 特征 点 的 最终 空间 位置 向量 ； 　 　 粒子 自身 的 位置 向量 ； 　 　 所在 层 的 空间 偏移 向量 特别 是 它 只有 两个 方向 的 自由度 。 　 　 粒子 在 新 诞生 时 颜色 值为 对应 特征 点 的 基本 颜色 ， 在 活动 过程 中 ， 颜色 的 各 分量 变化 如图 。 R 、 G 、 B 分量 均 为 分段 线性 函数 ， 保证 了 粒子 颜色 的 变化规律 为 ： 白 → 黄 → 红 → 黑 。 粒子 透明度 的 变化规律 是 由 生成 时 完全 不 透明 渐变 到 死亡 时 完全 透明 。 图 粒子 颜色 的 各 分量 变化 该 算法 流程 描述 如下 ： PROCEDUREFlameBuildingBEGIN 　 　 初始化 特征 点 的 空间 坐标 和 颜色 值 　 　 相应 所有 特征 点 生成 粒子 　 　 初始化 Flame 的 整体 偏移 参量 SpaceOffset 　 　 WHILENotQuitDO 　 　 BEGIN 　 　 根据 当前 粒子 属性 并 融合 SpaceOffset 刷新 显示 Flame 　 　 修改 粒子 属性 参数 　 　 IF 有 粒子 的 生存期 ifeTHEN 　 　 BEGIN 　 　 　 　 删除 该 粒子 　 　 　 　 对应 特征 点 生成 新 粒子 　 　 ENDif 　 　 修改 整体 空间 偏移 参量 SpaceOffset 　 　 WaitingTime 　 　 ENDwhile 　 　 ENDFlameBuilding 实验 结果 　 　 本 算法 已 在 微机 上 实现 。 微机 硬件 配置 ： CPU — Pentium 、 RAM — M 、 显存 — M 、 显卡 类型 一 SViGREDXGXPCI ； 软件 环境 ： VC 软件开发 平台 、 OpenGL 。 图 a 是 显示 的 单一 火苗 不同 时刻 的 图形 ； 图 b 是 多个 火苗 分布 在 空间 不同 位置 组合而成 的 火焰 图形 。 单个 火苗 × 的 动态 图形 显示 刷新率 可 达 每秒 帧 左右 ， 基本 满足 实时性 要求 ， 并 已 应用 于 作战 模拟系统 中 的 飞机 尾焰 等 的 模拟 。 由 得到 的 效果 看 ， 本 算法 在 满足 一定 逼真度 的 条件 下 很 好地解决 了 不规则 模糊 动态 景物 的 实时 生成 显示 问题 。 图 结论 　 　 本文 介绍 了 一种 基于 景物 特征 的 粒子系统 建模 方法 ， 该 方法 成功 解决 了 微机 环境 下 动态 不规则 模糊 景物 的 实时 生成 和 显示 。 与 传统 的 粒子系统 建模 方法 不同 ， 本 方法 是 先 对 自然 景物 提取 特征 点 ， 然后 将 特征 点用 粒子系统 表达 ， 利用 景物 特征 的 空间 相关性 ， 描绘 景物 整体 造型 。 最后 ， 我们 以 火焰 的 建模 为 实例 ， 描述 了 算法 流程 和 实验 结果 。 该 技术 具有 很强 的 应用 背景 ， 可 方便 地 融入 到 各个 三维动画 系统 中 。 杨冰 国防科技大学 电子 工程学院 ATR 实验室 长沙 鲁敏 国防科技大学 电子 工程学院 ATR 实验室 长沙 参考文献 ， BlinnJFSimulationofWrinkledSurfarcesComputerGraphics ～ ， ReevesWTParticleSystemaTechniqueforModelingaClassofFuzzyObjectsComputerGraphics ～ ， ReevesWTetalApproximateandProbabilisticAlgorithmsforShadingandRenderingStructuredParticleSystemComputerGraphics ～ ， JosStamEugeneFiumeDepictingFireandOtherGaseousPhenomenaUsingDiffusionProcessesComputerGraphicsProceedingsAnnualConferenceSeries ～ ， 宋万寿赖 建伟 基于 粒子系统 方法 的 焰火 及 树木 模拟 ChinaJCADampCG ～ ， 唐荣 锡 等 计算机 图形学 教程 北京 科学出版社 收稿 日期 ： － －