微型机 与 应用 WEIXINGJIYUYINGYONG 　 Vol 　 No 　 PMatlab 函数 转换 为 VB 可用 的 DLL 段晓君 摘要 ： 一种 利用 Matcom 将 Matlab 函数 转换 为 VB 中 可用 的 动态链接库 的 方法 ， 操作 简单易行 。 关键词 ： Matlab 函数 动态链接库 DLLM － 文件 VB 语言 Matlab 简介 　 　 Matlab 是 MathWorks 公司 开发 的 一种 工程 计算 语言 。 它 是 一个 交互 系统 ， 在 Matlab 中 的 基本 数据 元素 是 一个 不 要求 维数 的 复 矩阵 。 用 Matlab 可 解决 很多 工程 计算 问题 ， 特别 是 涉及 到 矩阵 和 矢量 形式 的 问题 。 Matlab 是 一个 高度 集成 的 语言 环境 ， 在 它 的 界面 下 可以 编写程序 、 运行 程序 并 可 进行 跟踪 调试 。 对于 广大 的 工程 技术人员 和 科学研究 人员 来说 ， Matlab 不失为 一种 很 好 的 工具 。 　 　 Matlab 也 有 局限性 ， 一般 它 不能 脱离 Matlab 集成 环境 工作 ； 而且 编写 界面 的 功能 比较 弱 。 　 　 Matcom 是 一个 从 Matlab 到 C ＋ ＋ 的 编译器 ， 它 可以 节省 用户 的 运算 时间 和 内存 要求 。 MathTools 公司 利用 Matcom 技术 编写 了 Mideva 工具软件 ， 它 可以 借用 C ＋ ＋ 编译器 将 Matlab 下 的 M － 文件 转换 为 可 被 VisualBasic 、 Excel 以及 Delphi 调用 的 DLL 动态链接库 或者 是 独立 的 可执行文件 。 本文 就 M － 文件 到 DLL 的 转换 以及 在 VB 中 调用 这 一类 DLL 的 个 问题 做 了 一些 探讨 。 文中 针对 Matlab ． 、 VC ． 、 VB ． 、 Matcom ． 或 相应 的 更 高 版本 的 软件 进行 了 讨论 。 M － 文件 到 DLL 的 转换 　 　 要 将 一个 m － 文件 编译成 DLL ， 需 进行 如下 操作 ： 启动 运行 Matcom 的 Mideva ， 点击 菜单 File ／ Compiletodll ， 选择 要 转换 的 m － 文件 （ 该 文件 应该 是 能够 作为 函数 被 其它 集成 环境 调用 的 m － 文件 ， 假设 文件名 为 yourfile ． m ） 。 值得注意 的 是 ， Mideva 对 M － 文件 有 一定 的 要求 ， 即该 文件 必须 是 个 函数 ， 如果 要 编译 没有 输入 也 没有 输出 的 脚本 文件 ， 可以 先 在 Matlab 中将 它 编辑 成无 输入 无 输出 的 函数 ， 再 按照 上述 操作 进行 转换 。 　 　 编译 之前 ， 还 可以 在 Mideva 集成 环境 的 菜单 Configuration 中 配置 编译 的 参数 为 Debug 模式 或 Release 模式 。 编译 完成 之后 ， 在 对应 的 Debug 或 Release 目录 下 ， 可以 看到 一些 编译 生成 的 文件 。 在 VB 集成 环境 中 需要 用到 的 文件 有个 ： yourfile ． dll （ DLL 文件 ） 和 yourfile ． bas （ 在 VB 中 声明 DLL 的 模块 文件 ） 。 为了 在 VB 中 能够 调用 这类 DLL ， 要求 将 yourfile ． bas 和 matlib ． bas 加入 到 你 的 工程 中 ， 并 将 yourfile ． dll 以及 matlib ． dll 拷贝到 工程 所在 的 目录 下 。 编译 后 ， 在 VB 中 的 函数 名为 yourfile ＿ in ＿ out ， 其中 ， in 和 out 分别 为 函数 的 输入 参数 和 输出 参数 的 个数 ， 例如 c ＝ conv （ a ， b ） ， 编译 转换 后 的 函数 名为 conv ＿ ＿ 。 数据 接口 　 　 VB 中要 使用 DLL ， 必须 在 你 的 工程 中 包含 DLL 的 声明 文件 （ 即 模块 文件 ） ， 同时 还要 将 DLL 拷贝到 工程 文件 所在 的 目录 中 。 事实上 ， yourfile ． dll 中 的 函数 并 不能 直接 与 集成 环境 进行 数据交换 ， 它 只能 通过 矩阵 句柄 进行 接口 。 这些 句柄 与 文件 句柄 类似 ， 它 是 用 一个 位 的 矩阵 整数 来 表示 的 ， 它们 可以 被 创建 ， 也 可以 被 删除 ， 通过 它 可以 对 矩阵 数据 进行 操作 。 这样 ， 集成 环境 与 DLL 之间 需要 个 中间层 ， MathTools 提供 了 一个 单独 的 C ＋ ＋ 库 文件 Matlib ． dll 以及 相应 的 模块 文件 Matlib ． bas 。 Matlib ． dll 相当于 VB 集成 环境 与 DLL 之间 的 代理 ， 在 这 一 DLL 中 包含 有 多个 矩阵 句柄 操作 函数 和 多个 从 Matlab 转换 而来 的 矩阵 函数 。 表列出 了 Matlib ． dll 提供 的 比较 常用 的 个 矩阵 句柄 函数 。 　 　 在 编程 的 时候 ， 必须 调用 mtInitM 来 初始化 库 文件 ， 即 请求 允许 使用 转换 的 DLL ， 并 调用 mtExitM 来 结束 这种 请求 。 另外 ， 还要 使用 其它 的 矩阵 句柄 函数 来 分配 、 访问 和 释放 矩阵 句柄 。 应用 举例 　 　 事实上 ， 最 简单 的 例子 是 直接 调用 matlib ． dll 中 提供 的 inv ＿ ＿ 来 计算 矩阵 的 逆 。 为了 让 读者 更好 地 领会 这一 转换 的 意义 和 操作过程 ， 这里 给出 另外 个 例程 ： 在 VB 中 打开 个 记录 有种 股票 的 、 多天 的 收盘价 和 成交量 的 Access 数据库 ， 并 将 指定 的 列 数据 传送 给 Matlab 的 函数 ， 由该 函数 完成 股票 数据 的 动态显示 。 表 常用 的 矩阵 句柄 函数 函数 名 功能 返回值 mtInitM 请求 允许 使用 库 无 mtExitM 结束 库 使用 权限 无 mtCreateDoubleMatrixrowsColsisc 分配 个 大小 为 rowscols 的 矩阵 句柄 新 的 矩阵 的 句柄 mtDestroyMatrixx 释放 由 上 个 函数 创建 的 矩阵 句柄 无 mtGetRxrowcoly 将 实数 矩阵 x 的 元素 row ， col 的 值 赋 给 y 无 mtSetRxrowcoly 将 y 的 值 赋 给 实数 矩阵 x 的 元素 row ， col 无 mtGetIxrowcoly 将 图象 矩阵 x 的 元素 row ， col 的 值 赋 给 y 无 mtSetIxrowcoly 将 y 的 值 赋 给 图像 矩阵 x 的 元素 row ， col 无 mtGetMx 取得 矩阵 x 的 行数 矩阵 x 的 行数 mtGetNx 取得 矩阵 x 的 列数 矩阵 x 的 列数 mtGetNumberOfDimensionsx 取得 矩阵 x 的 维数 矩阵 x 的 维数 mtIscharx 判断 x 是否 为个 字符串 矩阵 TrueFalsemtIsComplexx 判断 x 是否 为 复数 矩阵 TrueFalsemtSetStringx 将 x 设置 称个 字符串 矩阵 无 　 　 为了 打开 数据库 文件 并 显示 数据库 的 数据 ， 我们 定制 了 个 窗体 ： 主 窗体 ， 是 MDI 风格 的 ， 只有 个 打开 数据库 的 菜单项 和 个 CommonDialog 控件 ； 子 窗体 ， 用于 显示 数据库 的 表项 结构 ， 包含 有 ImageList 控件 和 TreeView 控件 各个 ， 其中 ， ImageList 用于 存放 TreeView 的 图标 ， TreeView 用于 显示 表项 ； 子 窗体 ， 用于 显示 选定 表项 的 数据 ， 包含 有 Data 控件 、 DbGrid 控件 和 CommandButton 控件 各个 。 在 通过 菜单项 选择 要 打开 的 数据库 后 ， 子 窗体 显示 数据库 的 表项 结构 ， 鼠标 双击 某一 表项 ， 子 窗体 显示 该 表项 中 的 数据 。 　 　 由于 篇幅 的 限制 ， 这里 不 对 VB 中 如何 打开 数据库 文件 作过 多 的 描述 。 下面 详细 介绍 VB 中 如何 调用 Matlab 函数 转换 过来 的 动态链接库 。 Matlab 函数 的 源程序 如下 （ DynDataPlot ． m ） ： functionDynPlotData （ Data ） T ＝ length （ Data ） ； TestPlot （ T ） ； ％ 初始化 动态显示 数据 的 窗口 MaxY ＝ max （ Data ） ； fork ＝ ： T 　 　 y ＝ Data （ ： K ） ； 　 　 x ＝ ： k ； 　 　 TestPlot （ T ， x ， y ， MaxY ） ； ％ 动态 绘制 数据 曲线 endfunctionTestPlot （ DataNum ， x ， Data ， MaxY ） switchnargincase ， ％ 只有 个 输入 参数 ， 初始化 动态显示 数据 的 窗口 　 　 fhnd ＝ findobj （ allchild （ ） ， ′ flat ′ ， ′ Tag ′ ， ′ TMWWaitbar ′ ） ； 　 　 if ～ isempty （ fhnd ） 　 　 close （ fhnd ） ； 　 　 endfhnd ＝ figure （ ′ Name ′ ， ′ ShowDbData ′ ， … 　 　 　 ′ Units ′ ， ′ points ′ ， ′ Resize ′ ， ′ off ′ ， … 　 　 　 ′ CreateFcn ′ ， ″ ， ′ NumberTitle ′ ， ′ off ′ ， … 　 　 　 ′ IntegerHandle ′ ， ′ off ′ ， ′ MenuBar ′ ， ′ none ′ ， 　 　 　 ′ Tag ′ ， ′ TMWWaitbar ′ ） ； 　 　 AxesHnd ＝ axes （ ′ Parent ′ ， fhnd ， ′ XLim ′ ， ［ DataNum ］ ， … 　 　 　 ′ Position ′ ， ［ ． ． ． ． ］ ， ′ FontSize ′ ， ［ ］ ， … 　 　 　 ′ Box ′ ， ′ on ′ ， ′ XGrid ′ ， ′ on ′ ， ′ YGrid ′ ， ′ on ′ ） ； 　 　 title （ ′ PlotDynamicCurve ′ ） ； 　 　 HndList ＝ ［ AxesHnd ］ ； 　 　 set （ fhnd ， ′ HandleVisibility ′ ， ′ callback ′ ， ′ UserData ′ ， HndList ） ； case ， ％ 个 输入 参数 时 ， 动态 绘制 数据 曲线 　 　 fhnd ＝ findobj （ allchild （ ） ， ′ flat ′ ， ′ Tag ′ ， ′ TMWWaitbar ′ ） ； 　 　 HndList ＝ get （ fhnd ， ′ UserData ′ ） ； 　 　 DataLen ＝ length （ Data ） ； 　 　 ifDataLen ＝ ＝ 　 　 　 set （ HndList （ ） ； ′ YLim ′ ， ［ ， MaxY ＊ ． ］ ） ； 　 　 　 line （ ′ Parent ′ ， HndList （ ） ， ′ XData ′ ， ［ ： ］ ， ′ YData ′ ， 　 　 　 　 　 ［ Data （ ） Data （ ） ］ ， ′ Color ′ ， ［ ］ ， ′ 　 　 　 　 　 　 EraseMode ′ ， ′ none ′ ） ； endifDataLen ＞ 　 　 set （ HndList （ ） ， ′ YLim ′ ， ［ ， MaxY ＊ ． ］ ） ； 　 　 axes （ HndList （ ） ） ； 　 　 line （ ′ Parent ′ ， HndList （ ） ， ′ XData ′ ， ［ DataLen － ： 　 　 　 　 　 DataLen ］ ， ′ YData ′ ， Data （ DataLen － DataLen ） ， 　 　 　 　 　 ′ Color ′ ， ［ ］ ， EraseMode ′ ， ′ none ′ ） ； 　 　 endend ％ casereturn 　 　 按照 前面 描述 的 步骤 ， 可以 将 这 一 函数 转换 为 dyndataplot ． dll ， 同时 得到 动态链接库 的 声明 模版 文件 dyndataplot ． bas 。 在 VB 中 添加 了 该 声明 文件 ， 将 动态链接库 拷贝到 VB 工程 文件 的 当前目录 下 ， 并 给子 窗体 的 CommandButton 添加 如下 代码 ： PrivateSubCommand ＿ Click （ ） Dimi ， n ， mAsLongDimstrMSGAsString 　 　 ′ 请求 允许 使用 Matlab 的 文件 CallmtInitM 　 　 Dimtmp ， tmpAsLong 　 　 　 ′ 创建 矩阵 句柄 　 　 　 tmp ＝ mtCreateDoubleMatrix （ ， n ， ） 　 　 　 tmp ＝ mtCreateDoubleMatrix （ ， ， ） 　 　 ′ 取得 数据库 表中列 数值 　 　 　 m ＝ DataGrid ． datDataCtl ． Recordset ． Fields ． count 　 　 　 DataGrid ． datDataCtl ． Recordset ． MoveFirst 　 　 　 n ＝ DataGrid ． datDataCtl ． Recordset ． RecordCount 　 　 　 Fori ＝ Ton － 　 　 　 　 ′ 将 指定 数据库 表项 中 的 第列 有效 数据 的 第 　 　 　 　 ′ i 个 记录 的 值 取出 　 　 　 　 temp ＝ DataGrid ． datDataCtl ． Recordset ． Fields （ ） 　 　 　 　 ′ 将 取得 的 值 附 给 矩阵 句柄 tmp 的 第 i 个 单元 　 　 　 　 CallmtSetR （ tmp ， ， i ， temp ） 　 　 　 　 DataGrid ． datDataCtl ． Recordset ． MoveNext 　 　 　 Next 　 　 　 ′ 调用 Matlab 的 函数 　 　 　 CallDynPlotData ＿ ＿ （ tmp ， tmp ） 　 　 　 ′ 释放 矩阵 句柄 　 　 　 CallmtDestroyMatrix （ tmp ） 　 　 　 CallmtDestroyMatrix （ tmp ） 　 　 ′ 终止 Matlab 函数 的 调用 权限 　 　 　 CallmtExitMEndSub 　 　 这样 ， 在 点击 “ 绘制 数据 曲线 ” 按钮 后 ， 就 调用 转换 后 的 Matlab 函数 将 数据表 项中 的 第 只 股票 的 数据 曲线 动态 地 绘制 出来 。 通过 这个 示例 可以 看出 ， 将 Matlab 的 函数 转换 为 VB 中 可以 调用 的 动态链接库 ， 操作 简单 、 调用 方便 。 并且 充分利用 了 VB 的 界面 开发 能力 和 Matlab 的 数据处理 和 绘图 功能 。 段晓君 （ 长沙 国防科技大学 七系 研究生 队 ） 收稿 日期 ： － －