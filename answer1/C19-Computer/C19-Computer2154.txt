计算机 应用 研究 APPLICATIONRESERCHOFCOMPUTERSVol 　 No 　 PPPP 协议 及其 在 INTERNET 远程 接入 技术 中 的 应用 曾勇军 摘要 PPP 协议 是 当前 广泛应用 在 INTERNET 中 的 链路层 协议 ， 其 研究 和 开发 具有 十分 重要 的 意义 。 分析 了 PPP 的 协议 结构 、 运行机制 ， 并 对 其 在 远程 接入 技术 中 的 应用 进行 了 描述 。 关键词 PPPLCPNCP 远程 接入服务器 RADIUS 　 　 近年来 ， Internet 在 我国 得到 了 迅猛地 发展 ， 上网 的 用户数 也 在 逐年 增加 。 当前 ， 用户 访问 Internet 主要 是 通过 PSTNISDN 拨号 来 完成 的 ， 在 这种 远程 接入 技术 中 ， PPPPointtoPointProtocol 协议 得到 了 广泛 的 应用 ， 成为 实现 远程 用户 访问 Internet 的 关键技术 。 本文 对 PPP 协议 进行 了 研究 ， 并 对 其 在 Internet 远程 接入 技术 中 的 应用 进行 了 描述 。 　 PPP 的 协议 结构 　 物理层 要求 　 　 PPP 设计 时 考虑 了 与 常用 的 硬件 兼容 ， 支持 任何 DTEDCE 接口 包括 EIARSC ， EIARS ， EIARS 与 CCITTV 。 运行 PPP 协议 只 需要 提供 全双工 的 电路 专用 的 或是 电路 交换 的 ， 以 承载 双向 的 数据 信息 。 PPP 协议 对 传输速率 没有 任何 限制 ， 故能 适用 于 多种 远程 接入 的 情形 。 　 协议 结构 　 　 PPP 由 以下 三个 组件 组成 ： 　 　 。 一种 在 串行 链路 上 封装数据 报 的 方法 。 　 　 。 一个 用于 建立 、 配置 和 测试 数据链 路 连接 的 链路 控制协议 LCPLinkControlProtocol 。 　 　 。 一个 用于 建立 、 配置 不同 网络层 协议 的 网络 控制协议 NCPNetworkControlProtocol 。 　 　 PPP 协议 结构 如图所示 。 图 　 PPP 协议 结构 　 　 封装 格式 　 　 PPP 使用 ISO 的 高级 数据链 路 控制 规程 HDLC 的 原理 、 术语 和 帧 结构 ， 允许 在 同步 及 异步 环境中运行 ， 并 提供 了 在 同一 链路 上 传输 不同 网络层 协议 如 IP 、 IPX 、 AppleTalk 等 数据 单元 的 机制 ， 因此 很 容易 连接 各种各样 的 主机 、 路由器 及 远程 接入 设备 。 　 　 标准 的 PPP 帧 格式 如图所示 。 图 　 PPP 帧 格式 　 　 标志 序列 为 组成 Xe ， 是 帧 的 定界符 ， 用以 识别 单个 的 PPP 帧 。 　 　 地址 域 为 Xff ， 指示 所有 的 站 均 可以 接收 该 帧 ， 使用 固定值 避免 了 分配 数据链 路 地址 的 问题 。 　 　 控制 域 为 X ， 这个 值 指示 了 一个 无 编号 的 帧 ， PPP 并 没有 使用 序号 和 确认 保证 传输 的 可靠性 。 　 　 协议 域 占个 字节 ， 其值 指示 封装 在 PPP 帧 中 的 信息 所 使用 的 协议 。 其 具体 值 可 参考 RFC 。 　 　 信息 域 包含 有个 或 更 多 的 字节 ， 为 网络层 的 协议 数据 单元 ， 缺省 的 最大 长度 为个 字节 。 　 　 填充 域 可以 填充 任意 数目 的 字节 ， 直到 信息 域 的 最大 接收 单元 。 信息 域 与 填充 域 的 区别 是 由 相应 的 协议 自己 来 完成 的 。 　 　 FCS 域 使用 比特 的 循环 冗余 校验 CRC 算法 计算 校验 和 。 帧 校验 的 计算 范围 如图所示 ， 不 包括 任何 起止 比特 ， 为了 完成 透明 传输 而 插入 的 字节 ， 也 不 包括 标志 序列 和 FCS 本身 。 　 　 PPP 使用 ControlEscape 字符 来 解决 控制字符 及 标志 字 段 出现 在 信息 域 的 情况 。 该 字符 定义 为 即 为 Xd ， 此处 比特 位置 的 编号 为 而 不是 常用 的 。 在 计算 校验 和 FCS 后 ， 发送 方 检测 标志 序列 之间 的 整个 帧 。 若 在 信息 域 中 出现 标志 序列 ， ControlEscape 字符 以及 其值 小于 X 的 字符 该 字符 在 LCP 的 选项 协商 中 指定 需要 隐藏 ， 则 用 两个 字符 来 代替 ， 前 一个 字符 是 ControlEscape 字符 ， 后 一个 为源 字符 的 第个 比特 变反 后 而 形成 的 。 如 XE 变成 两个 字符 XD ， XE 。 在 计算 帧 校验 序列 之前 ， 接收 方 同样 检测 标志 序列 之间 的 整个 帧 ， 若 发现 ControlEscape 字符 ， 则 将 该 字符 删除 ， 同时 将 下 一个 字符 的 第 比特 变反 。 　 　 LCP 协议 　 　 LCP 协议 用于 建立 链路层 的 连接 ， 这种 连接 建立 的 过程 是 通过 交换 分组 来 实现 的 ， LCP 定义 了 三类 分组 ： 　 　 。 链路 配置 分组 用于 建立 和 配置 PPP 链路 ， 确定 与 该 链路 相关 的 参数 。 这 组分 组 包括 configurereq 、 configureack 、 configurenak 、 configurerej 。 　 　 。 链路 终止 分组 用于 终止 PPP 链路 。 这 组分 组 包括 terminatereq 、 terminateack 。 　 　 。 链路 维护 分组 用于 管理 和 调试 PPP 链路 。 这 组分 组 包括 coderej 、 protocolrej 、 echoreq 、 echorep 和 discardreq 。 　 　 PPP 可以 协商 链路层 的 多个 选项 ， 如 最大 接收 单元 、 异步控制 字符 映射 、 认证 协议 、 质量 协议 、 魔号 、 协议 域 压缩 、 地址 和 控制 域 压缩 ， 用以 配置 数据链 路 连接 。 　 　 NCP 协议 　 　 PPP 使用 一 族 网络 控制协议 NCP 配置 不同 的 网络层 。 普遍 考虑 的 NCP 为 IPCPInternetProtocolControlProtocol ， 用于 配置 IP 层 ， 使用 与 LCP 相同 的 报文 结构 IPCP 仅 定义 了 LCP 的 前 七个 报文 及 协商 机制 完成 选项 协商 的 任务 。 　 　 IPCP 定义 了 三个 配置 选项 ， 其中 一个 已 过时 。 当前 的 协议 规范 主要 讨论 了 IP 压缩 协议 配置 选项 及 IP地址 配置 选项 ， 负责 协商 压缩 TCPIP 头部 的 方法 及 动态分配 IP地址 。 　 PPP 的 运行机制 　 PPP 协议 的 阶段 流图 　 　 在 建立 、 配置 和 测试 数据链 路 的 过程 中 ， PPP 经过 了 几个 不同 的 阶段 。 　 　 系统 初始化 时 处于 链路 DEAD 阶段 ， 链路 必须 开始 并且 终止 于 这个 阶段 。 此时 物理 连接 没有 建立 ， 不能 进行 数据通信 。 图 　 PPP 阶段 流程图 　 　 当 某个 外部 事件 如 检测 到 载波 或 管理员 配置 发生 ， 低层 向 PPP 发送 UP 信号 ， 指示 物理层 可以 使用 时 ， PPP 将 进入 ESTABLISH 阶段 。 在 此 阶段 将 协商 LCP 的 选项 信息 。 若 LCP 选项 协商 失败 ， 则 回到 链路 DEAD 阶段 。 若 链路 协商 成功 ， 则 链路 的 双方 都 进入 OPENED 状态 ， 下 一步 要 进行 的 是 身份 认证 。 　 　 认证 协议 在 LCP 选项 协商 阶段 确定 ， 在 完成 链路 建立 之后 使用 该 协议 对 用户 进行 身份 认证 。 若 认证 成功 ， 则 PPP 进入 网络层 协议 阶段 ； 否则 ， PPP 将 采取措施 终止 链路 。 认证 阶段 是 可选 的 。 　 　 一旦 PPP 完成 了 前面 的 工作 ， 每个 网络层 协议 必须 由 合适 的 网络 控制协议 NCP 来 配置 。 网络 控制协议 可以 在 任何 时候 被 打开 或 关闭 。 当 网络 控制协议 到达 OPENED 状态 时 ， PPP 将 承载 相应 的 网络层 协议 分组 。 当 网络 控制协议 不 处于 OPENED 状态 时 ， 收到 的 网络层 协议 分组 都 将 被 抛弃 。 　 　 在 正常 情况 下 ， 在 用户 通信 完毕 之后 ， 可 由 LCP 完成 链路 的 终止 工作 ， 链路 回到 DEAD 阶段 。 由 LCP 完成 链路 的 终止 工作 就 足够 了 ， 并不需要 使用 NCP 终止 分组 。 　 PPP 的 选项 协商 自动机 　 　 PPP 协议 定义 了 一个 有限 状态 自动机 ， LCP 、 NCP 的 选项 协商 均 按照 自动机 来 完成 。 图仅 列举 了 几个 主要 的 状态 ， 自动机 的 全部 状态 及 具体操作 可 参考 RFC 。 图 　 PPP 选项 协商 自动机 状态 事件 活动 Closed ： 链路 可 得到 ， 但 没有 产生 OPEN 事件 Closing ： 试图 终止 该 链路 。 已 发送 了 终止 请求 ， 但 没有 收到 终止 确认 ReqSent ： 试图 配置 链路 。 已 发送 了 配置 请求 ， 但 没有 收到 配置 确认 AckRcvd ： 发送 了 配置 请求 ， 并 收到 了 配置 确认 ， 但 没有 发送 配置 确认 AckSent ： 已 发送 了 配置 请求 和 配置 确认 ， 但 没有 收到 配置 确认 RCR ： 接收 到 对方 发送 过来 的 配置 请求 RCR ： 接收 到 正确 的 配置 请求 RCR ： 接收 到 不 正确 的 配置 请求 TO ： 超时 计时器 到期 ， 重传 计数器 大于 RCA ： 接收 到 配置 确认 RCN ： 接收 到 配置 否认 RTA ： 接收 到 终止 确认 CLOSE ： 链路管理 性 关闭 OPEN ： 链路管理 性 打开 scr ： 发送 配置 请求 sca ： 发送 配置 确认 scn ： 发送 配置 否认 str ： 发送 终止 请求 sta ： 发送 终止 确认 　 　 成功 的 链路 建立 过程 如下 。 　 　 当 物理 链路 被 唤醒 时 ， 自动机 将 进入 Closed 状态 。 本机 的 PPP 产生 OPEN 事件 ， 向 对 等 的 PPP 主机 发送 配置 请求 分组 ， 开始 了 PPP 选项 协商 的 工作 。 自动机 将 进入 ReqSent 状态 ， 等待 对 等 的 PPP 主机 发送 响应 。 此时 可能 产生 两种 情况 ： 第一种 情况 ， 若 配置 请求 的 发送 方 收到 配置 确认 ， 说明 本机 的 配置 要求 已 被 接受 ， 自动机 将 进入 AckRcvd 状态 ， 等待 对方 的 配置 请求 分组 。 若 收到 对方 的 配置 请求 分组 且 配置 选项 均 可 接受 ， 则 发送 配置 确认 并 进入 Opened 状态 ； 第二种 情况 ， 若 配置 请求 的 发送 方 收到 选项 正确 的 配置 请求 ， 则 发送 配置 确认 ， 自动机 将 进入 AckSent 状态 ， 等待 对方 发送 配置 确认 。 若 收到 配置 确认 分组 ， 自动机 将 进入 Opened 状态 。 此后 ， 可以 根据 阶段 图 采取 下 一步 措施 ， 完成 链路 建立 的 工作 。 　 PPP 在 INTERNET 远程 接入 技术 中 的 应用 远程 接入 模型 　 　 远程 接入 模型 如图所示 ， 用户 的 PC 经过 MODEM 与 PSTN 相连 ， 位于 PSTN 另一端 的 是 远程 接入服务器 。 远程 接入服务器 是 拨号 Internet 接入 网络体系结构 中 的 关键 组件 ， 负责 连接 异种 网络 ， 所以 要 完成 信息 之间 的 转换 、 完成 不同 网络 之间 速率 的 适配 以及 中继 IP 业务量 的 功能 。 图 　 远程 接入 模型 　 　 RADIUSRemoteAuthenticationDialInUserService 服务器 完成 对 拨号 用户 的 身份验证 、 授权 及 计费 的 功能 。 远程 接入服务器 与 RADIUS 服务器之间 采用 的 是 客户服务器 的 工作 模式 ， 远程 接入服务器 负责 传递 用户 的 信息 给 指定 的 RADIUS 服务器 ， 并 接收 RADIUS 服务器 的 响应 ， 成为 RADIUS 客户机 。 而 RADIUS 服务器 存放 所有 入帐 的 用户 数据库 ， 并 负责 分配 IP地址 ， 这 就 保证 了 用户 信息 改变 时 ， 只有 RADIUS 服务器 的 数据库 需要 改变 ， 便于 用户 的 集中管理 。 DNS 服务器 主要 完成 域名 地址 与 IP地址 之间 的 变换 ， 而 WWW 服务器 则 主要 提供 信息 查询 服务 。 　 　 用户端 及其 对 等 的 远程 接入服务器 端均 加载 PPP 协议 ， 用 PPP 协议 建立 数据 链路层 的 连接 。 用户 的 PC 从 RADIUS 服务器 的 地址 池中 动态 地 获得 一 IP地址 ， 成为 Internet 上 的 一台 临时 主机 ， 通过 接入服务器 可以 和 任何 其它 Internet 主机 通信 。 PPP 通信 过程 　 　 用户 拨入 远程 接入服务器 的 号码 ， 通过 交换 电路 网络 如 PSTN 建立 了 一条 物理 链路 之后 ， PPP 将 根据 其 状态 的 驱动 ， 开始 了 数据链 路 连接 建立 的 过程 。 　 　 PPP 首先 使用 LCP 协商 数据 链路层 选项 。 链路 双方 的 PPP 协议 均 使用 LCP 交换 配置 请求 分组 ， 该 分组 中 包含 有 每 一端 都 期望 的 配置 信息 及 链路 相关 信息 ， 如 最大 接收 单元 MRU 、 异步控制 字符 映射 等 选项 。 在 此 阶段 ， 双方 可以 协商 使用 某 一种 认证 协议 如 PAPPasswordAuthenticationProtocol 或 CHAPChallengeHandshakeAuthenticationProtocol 。 LCP 认为 所有 的 请求 均 能 满足 ， 则 发送 配置 确认 分组 。 当 用户 PC 与 接入服务器 的 LCP 均 发送 和 接收 到 配置 确认 分组 后 ， 则 认为 链路 已经 成功 地 建立 ， 于是 要求 用户 输入 用户名 及 口令 ， 进入 认证 阶段 。 用户 根据 提示信息 输入 用户名 和 口令 ， 将 这些 信息 传递 给 接入服务器 。 接入服务器 收到 该 请求 后 ， 再 将 该 信息 传送 给 RADIUS 进程 。 RADIUS 进程 组成 接入 请求 分组 ， 该 分组 中 包含 有 用户名 、 口令 、 用户 接入 的 端口号 等 信息 ， 然后 将 该 分组 传给 RADIUS 服务器 。 RADIUS 服务器 收到 该 分组 就 对 用户 的 身份 进行 验证 ， 若 用户 身份 合法 ， 则 传回 确认 信息 ， 其中 附带 有 分配 给 用户 的 IP地址 。 接入服务器 将 确认 的 信息 传给 用户 ， 通知 用户 身份 合法 。 用户 收到 该 分组 后 就 开始 协商 网络层 选项 。 此时 用户 与 接入服务器 的 NCP 协议 此处 主要 考虑 IPCP 协议 交换 网络层 配置 请求 分组 ， 在 PPP 层上 建立 、 配置 网络层 ， 该 分组 中 带有 IP地址 请求 信息 。 接入服务器 的 PPP 处理 模块 接收 到 该 信息 ， 将 从 认证 服务器 处 获得 的 IP地址 传给 用户 ， 完成 网络层 的 协商 动作 。 　 　 在 PPP 建立 数据 链路层 的 连接 并 配置 好 网络层 之后 ， 用户 与 接入服务器 之间 就 可以 开始 数据 传递 的 工作 。 在 整个 数据 传递 期间 ， 接入服务器 负责 信息 的 转发 ， 功能 上 与 路由器 相似 。 　 　 用户 通信 完毕 后要 进行 连接 释放 的 工作 以 终止 链路 。 链路 终止 可以 在 任何 时候 发生 ， 这种 终止 可能 来源于 用户 、 物理 事件 载波 丢失 、 确认 失败 、 超时 等 。 终止 过程 通过 交换 LCP 链路 终止 分组 来 关闭 数据 链路层 的 连接 ， 然后 要求 MODEM 断开 物理层 连接 。 至此 ， 整个 通信 过程 结束 。 　 　 PPP 的 通信 过程 如图所示 。 图 　 通信 过程 的 流程图 　 小结 　 　 Internet 是 按照 TCPIP 协议 族 来 组网 的 ， 而 整个 TCPIP 协议 栈中 并 没有 数据 链路层 的 概念 ， 只 提供 了 一个 物理 网络接口 与 各种 网络连接 。 在 点到点 的 实现 方式 中 ， PPP 所起 的 作用 与 OSI 的 数据 链路层 一致 ， 完成 链路 的 操作 、 维护 和 管理 功能 。 PPP 灵活 的 选项 配置 、 多 协议 的 封装 机制 、 良好 的 选项 协商 机制 以及 丰富 的 认证 协议 ， 使得 它 在 远程 接入 技术 中 得到 了 广泛 的 应用 。 目前 ， PPP 正 处于 不断 补充 和 完善 的 过程 中 ， 其 发展前景 仍 十分 光明 。 曾勇军 （ 国家 数字 交换 系统工程 技术 研究 中心 郑州 ） 参考文献 ， 周 明天 汪文勇 编著 TCPIP 网络 原理 与 技术 北京 ： 清华大学出版社 ， SimpsonWThePointtoPointProtocolPPPRFC ， McGregorGThePPPInternetProtocolControlProtocolIPCPRFC ， LloydBSimpsonWPPPAuthenticationProtocolRFC ｖ RigneyCRubensASimpsonWWillensSRemoteAuthenticationDialInUserServiceRADIUSRFC 收稿 日期 ： 年月日