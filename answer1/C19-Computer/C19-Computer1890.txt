微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 　 Vol 　 No 　 P 远程 通信 技术 在 计算机 监控 系统 中 的 应用 陈 祥光 　 薛锦诚 摘要 ： 在 生产 现场 的 计算机 监控 系统 中 ， 利用 调制解调器 和 电话线 构成 拨号网络 ， 采用 Ｖ ｉ ｓ ｕ ａ ｌ Ｂ ａ ｓ ｉ ｃ 语言 编程 ， 把 生产 现场 检测 数据 传送 到 厂部 信息管理 中心 ； 在 厂部 管理系统 中 ， 采用 Ｄ ｅ ｌ ｐ ｈ ｉ 语言 建立 数据库 ， 实时处理 和 保存 远程 数据 。 从而 解决 了 某些 计算机 控制系统 或 Ｄ Ｃ Ｓ 系统 与 远程 管理系统 数据 传送 的 技术难题 。 关键词 ： 远程 通信 技术 Ｔ Ｃ Ｐ ／ Ｉ Ｐ 协议 Ｆ Ｔ Ｐ 协议 Ｖ Ｂ 语言 Ｄ Ｅ Ｌ Ｐ Ｈ Ｉ 语言 远程 数据库 　 　 在 工业生产 过程 中 ， 通常 要求 计算机 控制系统 完成 数据 的 采集 、 远程 传输 、 处理 及 储存 等 工作 。 然而 ， 目前 有些 工业 控制机 系统 或 集散 型 计算机 控制系统 不 具备 远程 通信 的 功能 。 因此 ， 对于 远 在 几十公里 以外 的 生产 现场 （ 如 油田 采油 、 集输 过程 ） ， 难于 达到 领导 管理层 可视 现场 生产 状况 进行 决策 的 现代化 生产 水平 。 其 主要 原因 有 ： ① 从 生产 现场 铺设 专用 电缆 至 信息管理 中心 ， 造价 太高 ； ② 由于 远程 通信 涉及 到 上 、 下位 机 通信协议 的 设置 、 传输 线路 的 连接 及 故障 的 检测 、 实时 数据文件 的 产生 与 传送 及 保存 、 删除 等 ， 要求 计算机 监控 系统管理 软件 具有 高可靠性 和 坚固 性 ， 否则 在 数据传输 过程 中 主机 易出 故障 而 导致 整个 系统 崩溃 。 　 远程 通信 的 基本 内容 　 　 基于 上述 原因 ， 本文 利用 调制解调器 和 电话线 构成 拨号网络 ， 以 实现 远程 通信 功能 的 基本 硬件 条件 （ 如图所示 ） 。 然而 ， 在 远程 数据 传送 与 处理过程 中 ， 应该 考虑 到 以下 几个 方面 ： 图 　 上 、 下 微机 远程 通信 示意图 　 　 （ ） 下位 机 （ 生产 现场 的 计算机 ） 需 定时 产生 个 检测 、 控制系统 动态 参数 的 数据 文本文件 ， 并 经过 一段时间 （ 如 s ） 将 用 新 产生 的 数据文件 覆盖 旧 的 文件 ； 　 　 （ ） 远程 数据 传送 软件 应 根据 要求 定时 累加 和 保存 下位 机 产生 的 数据文件 ， 在 确定 传输 成功 后 ， 删除 旧 文件 ， 以 避免 数据 丢失 、 重叠 或 占用 大量 的 存储空间 ； 　 　 （ ） 上位 机 （ 厂部 信息中心 的 计算机 ） 与 下位 机都 安装 调制解调器 ， 通过 调制解调器 将 累加 的 数据文件 定时 地 从 下位 机上 载 至上 位机 。 上位 机是 管理层 局域网 的 个 服务器 ， 装有 WindowsNTServer 网络操作系统 ； 　 　 （ ） 文件传送 到 上位 机 时 ， 能 自动 累加 在 上次 传送 的 文件 之后 ， 以供 数据库 管理软件 读取 和 处理 ； 　 　 （ ） 在 文件传输 过程 中 ， 能 检测 传送 线路 连接 是否 正常 ， 并 将 检测 信息 显示 在 主 窗体 的 界面 上 。 如果 出现 问题 必须 能 马上 断开连接 ， 准备 累加 文件 和 等待 下 一次 拨号 连接 ； 　 　 （ ） 文件传输 软件 与 系统监控 软件 同时 在 Windows 下 运行 。 因此 ， 在 文件传输 过程 中 ， 不能 影响 系统监控 程序 的 正常 运行 ； 　 　 （ ） 上位 机 数据库 （ 远程 数据库 ） 应 能 自动 打开 传送 文件 ， 输入 并 保存 数据文件 ， 以供 工程师 和 管理人员 随时 查阅 ； （ ） 上位 机 管理系统 应能 对 远程 数据 进行 实时处理 并 维护 数据库 各种 功能 的 实现 。 　 　 根据 以上 对 文件传输 软件 的 要求 ， 本文 采用 VisualBasic 可视化 编程语言 进行 程序设计 ， 并 利用 VB 中 的 ActiveX 控件 ， 通过 拨号网络 与 远程 主机 实现 连接 ， 由 FTP 文件传输 协议 进行 文件 的 上载 。 对 上位 机 数据库 管理软件 ， 采用 可视化 编程语言 Delphi ． 编写 ， 实现 了 远程 数据 传送 及 数据库 建立 与 管理 技术 的 应用 。 　 文件传输 软件设计 方案 的 确定 ． 　 程序设计 的 基本 思想 　 　 利用 VB 下 的 InternetTransfer 控件 进行 文件传输 。 在 程序 中 ， 通过 拨号网络 服务 拨号 连接 到 上位 机 服务器 并 登录 网络 。 在 上位 机 的 WindowsNT 操作系统 中 安装 FTP 网络 服务器程序 来 接收 下位 机 的 FTP 服务 请求 ， 由 下位 机 控制 上载 整个 文件 ， 文件 的 传送 是 在 相关 的 FTP 协议 控制 下 实现 的 ， 安全性 、 准确性 比较 高 。 用 FTP 的 SEND 命令 ， 当 文件传送 到 服务器时 会 自动 累加 到 指定 文件 结尾处 。 因此 ， 程序设计 的 基本思路 是 ： ① 利用 VB 的 集成 开发 环境 与其 丰富 的 “ 可视化 ” 控件 完成 应用程序 中 Windows 风格 的 界面 ； ② 利用 Mscomm 控件 进行 拨号 连接 ； ③ 利用 InternetTransfer 控件 进行 文件传输 ； ④ 定时 传送 、 定时 累加 文件 的 功能 用 VB 的 定时器 Timer 控件 实现 。 ． 　 建立 FTP 文件传输 协议 的 连接 　 　 在 使用 FTP 协议 时 ， 首先 要 建立 起 控制 连接 。 这 就要 用到 服务器 的 公认 端口号 ， 客户 控制 进程 在 本地 申请 得到 个 随机 分配 的 本地 端口 ， 用此 端口号 就 可以 和 服务器 的 公认 端口号 建立 一个 相关 （ 一个 相关 包括 项 内容 ： 协议 、 本地 地址 、 本地 端口 、 远地 地址 、 远地 端口 ） 。 这样 就 建立 了 控制 连接 。 由于 建立 数据 连接 要 由 服务器 提出申请 ， 但是 在 控制 连接 的 条件 下 客户机 发出 数据 请求 的 命令 时 服务器 才 会 发出 这个 申请 。 服务器 收到 来自 客户机 控制 进程 的 数据 请求 命令 后 ， 首先 生成 个 传输 子程序 。 传输 子程序 再 去 申请 个 端口号 形成 自己 的 半 相关 ， 这个 端口号 一般 使用 保留 断 口号 。 此外 ， 因为 还 需要 客户机 的 半 相关 才能 形成 一个 相关 ， 而 客户机 的 半 相关 还是 服务器 传输 进程 要 申请 建立 数据 连接 的 对象 。 这个 半 相关 是从 客户 控制 进程 那里 得来 的 。 这是 由于 服务器 数据传输 子程序 已经 申请 了 个 新 端口 ， 客户机 传输 进程 就 不 需要 申请 新 的 端口 了 。 服务器 传输 进程 就 利用 由 控制 进程 转过 来 的 客户 地址 和 端口 建立 起 一个 相关 ， 从而 具备 了 向 客户机 申请 数据 连接 的 条件 。 因此 ， 客户机 的 “ 协议 、 地址 、 端口号 ” 这 一半 相关 ， 分别 和 服务器 的 控制 端口 、 传输 形成 的 二个 半 相关 成 了 二个 完全 不同 的 相关 ， 用以 建立 控制 连接 和 数据 连接 。 这个 过程 和 相关 的 形成 如图所示 。 图 　 FTP 二个 连接 及 二个 半 相关 　 远程 文件传输 程序 的 设计 ． 　 创建 应用程序 的 窗体 　 　 窗体 是 VB 应用程序 的 个 基本平台 ， 几乎 所有 的 控件 都 要 添加 在 窗体 上 ， 而 大多数 的 应用程序 也 是从 窗体 开始 的 。 本 程序 由个 窗体 组成 ： 主 窗体 （ mainform ） 、 属性 设置 窗体 （ frmproperties ） 和 传送 过程 窗体 （ frmcancel ） 。 在 创建 VB 的 新 工程 时 ， 系统 自动 在 工程 中 添加 个 窗体 Form 。 改变 Form 的 “ 名称 ” 属性 为 “ mainform ” ， 将 它 作为 程序 的 主 窗体 。 利用 窗体 编辑器 和 属性 编辑器 对 窗体 的 属性 进行 更改 以 确定 窗体 的 状态 与 行为 。 　 　 为 实现 应用程序 的 各种 功能 ， 要 在 窗体 上 添加 各种 控件 。 主 窗体 如图所示 。 图 　 主 窗体 界面 　 　 添加 的 主要 控件 有 ： SSTab 控件 ： 命令 按钮 控件 （ CommandButton ） 、 文本框 控件 （ TextBox ） 、 选择 钮 控件 （ OptionButton ） 、 状态 条 控件 （ StatusBar ） 、 定时器 控件 （ Timer ） 、 串行 通信 控件 （ Mscomm ） 、 网络 传输 控件 （ InternetTransfer ） 。 　 　 传输 过程 窗体 较 简单 ， 只有 个 文本 控件 来 显示 提示 ， 还有 个 用来 中断 本次 传输 过程 的 按钮 。 ． 　 程序 中 主要 控件 的 使用 ． ． 定时器 的 应用 　 　 每个 定时器 都 必须 依附 在 窗体 上 ， 但是 它 在 运行 时 是 不 可见 的 。 定时器 最 主要 的 二个 属性 是 Enabled 和 Interval 。 在 “ 远程 文件传输 程序 ” 中 ， 由于 要 完成 “ 自动 文件传输 ” 的 功能 ， 总共 用 了 个 定时器 。 它们 在 程序 中 的 作用 如下 ： 　 　 定时器 StandardTimer 被 设置 成个 标准 的 计时器 ， Interval 属性 设置 为 ms ， 即 标准 的 min 。 由于 定时器 的 时间 间隔 最多为 ms ， 而 程序 中 文件 的 累加 、 自动 拨号 、 自动 登录 传送 等 功能 均 在 分钟 级 以上 ， 所以 在 StandardTimer 的 Timer 事件 中 再 设置 个 分钟 计数器 — — 全局变量 Minutes 。 每次 StandardTimer 产生 Timer 事件 时 ， 处理 Minutes 自加 ， 并 根据 要求 启动 文件 的 累加 、 自动 拨号 、 自动 登录 传送 等 定时 开始 的 工作 。 ． ． 　 Mscomm 控件 　 　 Mscomm 控件 提供 了 一系列 标准 通信 命令 的 使用 界面 。 使用 它 可以 建立 与 串行 端口 的 连接 ， 通过 串行 端口 连接 到 其它 通信 设备 （ 例如 调制解调器 ） ， 发出 命令 ， 交换 数据 ， 并 监视 和 响应 串行 连接 中 发生 的 事件 和 错误 。 利用 Mscomm 控件 控制 调制解调器 拨号 连接 上位 机 进行 通信 。 　 　 正确 地 设置 属性 之后 ， 编写 OnComm 事件 的 处理 代码 是 至关重要 的 。 CommEvent 属性 返回 最近 发生 的 通信 事件 和 错误 的 代码 值 。 依据 不同 的 CommEvent 属性 值 进行 不同 的 处理 。 主要 的 处理 如下 ： 　 　 （ ） 当 发生 错误 时 ， 无论是 手动 还是 自动 传送 状态 ， 都 要 进行 以下 几步 操作 ： ① 显示 错误信息 ； ② 断开 Internet 控件 的 FTP 连接 （ Intel ． Close ） ； ③ 向 端口 输出 挂线 命令 “ ATH ” （ Mscomm ． OutPut ＝ “ ATH ” ） ； ④ 设 PortOpen 属性 为 False ， 关闭 端口 （ Mscomm ． PortOpen ＝ “ False ” ） ； ⑤ 等待 下 一次 的 拨号 。 　 　 （ ） 当 自动 拨号 成功 连接 时 （ 在 接收 的 字符 中 检测 到 连接 成功 的 回报 码 ） ， 启动 自动 传送 定时器 AutoSendTimer ， 准备 建立 网络 的 FTP 连接 。 ． ． 　 InternetTransfer 控件 　 　 InternetTransfer 控件 支持 超文本 传输 协议 （ HTTP ） 和 文件传输 协议 （ FTP ） ， 它们 是 Internet 网上 使用 最 广泛 的 二种 协议 。 使用 HTTP 协议 ， 可以 连接 全球 信息网 （ WorldWideWeb ） 服务器 ， 以 检索 HTML 文档 。 使用 FTP 协议 可以 在 FTP 服务器 上 登录 ， 以 下载 和 加载 文件 。 在 此 ， 利用 文件传输 协议 FTP 来 上载 文件 ， 并 完成 以下 几 方面 的 工作 ： ① 设置 控件 的 属性 ； ② 在 程序 中用 Execute 方法 来 执行 对 远程 服务器 的 请求 ； ③ 在 StateChanged 事件 中 ， 处理 连接 中 的 状态 和 错误 ， 当 返回值 为 时 ， 说明 文件 上载 成功 ， 在 自动 和 手动 传送 二种 不同 情况 下 ， 各自 进行 不同 的 处理 ， 也 存在 相同 的 任务 ， 如 删除 下位 机上 用于 传送 的 旧 文件 ， 准备 累加 新 的 数据文件 ； 关闭 FTP 文件 服务 的 连接 和 串行接口 。 ． 　 远程 文件传输 软件 的 主要 功能 　 　 （ ） 该软件 在 Windows 下 ， 与 系统监控 软件 同时 运行 ， 定时 自动 拨号 连接 和 自动 传送 文件 。 　 　 （ ） 可 进行 自动 和 手动 二种 方式 的 文件传输 。 在 数据文件 的 传送 过程 中 ， 从主 窗体 上 可 显示 状态 信息 ； 　 　 （ ） 单击 主 窗体 的 “ 端口 设置 ” 按钮 会弹 出 “ 属性 ” 窗体 ， 用户 可以 对 串行 端口 的 参数 进行 设置 ； 　 　 （ ） 可 按 用户 的 要求 定时 进行 数据文件 的 累加 和 传送 ； 　 　 （ ） 主 窗体 上 ， 用户 可以 对 如下 内容 进行 输入 设置 ， 即 ： ① 自动 和 手动 的 选择 ； ② 服务器 IP地址 ； ③ 被 传送 的 文件 路径 ； ④ 传送 时间 间隔 （ 用个 全局变量 来 保存 ） ； ⑤ 拨打 的 电话号码 。 　 　 （ ） 对 上述 用户 的 设置 （ 包括 对 串行 端口 的 设置 ） ， 每当 用户 重新 设置 时 ， 程序 都 用 注册表 操作 函数 SaveSetting 将 它们 保存 在 Windows 操作系统 的 注册表 中 。 在 下 一次 使用 应用程序 时 ， 主 窗体 载入 引发 的 Form ＿ load 事件 中 ， 用 注册表 操作 函数 GetSetting 将 存储 的 值 取回 ， 恢复 用户 上次 结束 应用程序 前 的 设置 值 。 　 Delphi 数据库 应用程序 的 设计 　 　 利用 Delphi 的 客户 ／ 服务器 功能 ， 可以 在 本地 数据库 上 或 远程 数据库 服务器 上 开发 客户 ／ 服务器 模式 的 应用程序 。 Delphi 的 一个 强有力 的 功能 是 可以 将 基于 本地 桌面 数据库系统 的 应用程序 很 容易 地 修改 成 客户 ／ 服务器 模式 的 应用 。 个 Delphi 数据库 应用程序 访问 的 是 本地 数据库 还是 远程 SQL 数据库 服务器 上 的 数据库 ， 这 对于 最终用户 是 完全 透明 的 ， 即 数据库 的 物理 位置 对 最终用户 是 透明 的 。 当 数据库 的 物理 位置 发生变化 时 ， 用户界面 不必 随之 变化 。 ． 　 远程 数据库 的 程序设计 　 　 程序 要求 建立 服务器端 数据库 ， 自动 输入 现场 上传 的 数据 ， 实现 数据 的 处理 、 保存 、 修改 及 查询 功能 。 程序 调用 Delphi ． 中 的 可视 组件 ， 并 使用 ObjectPascal 编写 程序代码 。 　 　 程序 分为 个 模块 ： 程序 主 窗体 、 数据 的 自动 插入 及 文件 删除 和 数据 查询 。 主 窗体 （ mainform ） 起到 枢纽 的 作用 ， 既 可以 观察 数据库 的 状态 ， 又 可以 调用 另个 模块 。 数据 的 自动 输入 及 文件 删除 模块 （ form ） 为 最 主要 的 模块 ， 它 实现 了 文本文件 的 自动 打开 和 输入 、 多组 数据 的 输入 、 文本文件 的 删除 和 数据库 的 编辑 与 储存 。 查询 模块 （ Form ） 提供 了 查询 功能 ， 在 编辑框 内 输入 指定 格式 的 日期 就 可以 显示 该 时间 所 存储 的 数据 。 程序 流程图 如图所示 。 图 　 远程 数据库 程序框图 ． 　 数据库 应用程序 主 窗体 　 　 程序 的 主 窗体 实现 数据库 的 显示 以及 调用 数据 输入 和 查询 模块 。 它 是 由个 TSpeedButton 、 TDatasource 、 TTable 和 TDBGrid 组成 ， 如图所示 。 图 　 数据库 应用程序 主 窗体 ． 　 读入 文本文件 中 的 数据 及 旧 文件 的 删除 　 　 为了 实现 对 文本文件 中 数据 的 读入 功能 ， 使用 Dialogs 标签 页 中 的 TOpendialog 组件 ， 并 设置 它 的 默认 目录 为 C ＼ bishe 。 同时 ， 在 窗体 中放上 个 TMemo 组件 和 几个 TSpeedButton 组件 ， 把 TMemo 的 属性 “ lines ” 设置 为空 。 　 　 （ ） 数据 的 插入 、 修改 及 删除 　 　 在 窗体 上放上 TDBNavigator 及个 TDBEdit 控件 ， 并 设置 TDBNavigator 和 TDBEidt 的 Datasource 属性 为 MainForm ． Datasourcel ， 设置 TDBEidt 的 DataField 属性 为 相应 的 字段名 。 其 功能 实现 如图所示 。 图 　 数据 读入 、 保存 及 文件 删除 示意图 　 　 （ ） 查询 功能 的 实现 　 　 由于 数据库 预设 的 主键 为 “ 时间 ” ， 所以 ， 通过 输入 对比 主键 （ 时间 ） 的 值 ， 联合 使用 Findkey 和 Gotonearest 方法 ， 可以 实现 查询 功能 。 程序运行 过程 如图所示 。 图 　 数据 查询 功能 示意图 　 　 （ ） 程序 的 扩充 修改 　 　 首先 ， 在 Delphi 的 ObjectInspector 中 打开 Bishe 工程 。 修改 所有 DatabaseName 、 TableName 属性 为空 ， 且 Active 属性 为 false 。 然后 ， 打开 DatabaseDesktop ， 打开 名为 Bishe 的 表格 。 使用 Restructure 修改 表格 ， 添加 字段名 、 数据类型 、 数据 长度 。 存储 后 退出 。 　 　 在 Form 和 Form 中 添加 相应 数目 的 TDBEidt ， 并 仿照 原来 的 属性 修改 ， 同时 ， 修改 所有 DatabaseName 的 属性 为 DefaultDD ， TableName 属性 为 Bishe ， 且 Active 属性 为 true 。 在 Form 的 原代码 中 添入 代码 ： DBEidti ． text ＝ Memol ． lines ［ ］ ； 　 结束语 　 　 在 工业生产 过程 中 ， 对于 生产 现场 与 管理层 之间 相距 较远 的 情况 ， 远程 数据 传送 技术 的 应用 具有 十分 重要 的 意义 。 本文 对 上 、 下位 机 进行 相应 参数 的 设定 并 配置 调制解调器 ， 利用 电话线 构成 计算机 远程 自动 拨号网络 。 采用 VB 语言 编制 传输 软件 ， 实现 了 远程 数据 传送 。 上位 机 采用 DELPHI ． 语言 编程 ， 数据库 采用 PARADOX 格式 ， 具有 可 修改 、 可 扩充 功能 。 该软件 实现 了 文本文件 中 的 多组 数据 自动 读入 、 数据 格式化 、 数据 自动 写入 数据库 的 功能 ， 并 可 对 数据库 中 的 数据 自动 查询 以及 对 旧 文本文件 进行 删除 。 由于 考虑 到 现场 的 实际 应用 情况 ， 该软件 具有 较 高 的 可靠性 和 坚固 性 。 本文 将 其 应用 在 油田 联合 站 计算机 监控 系统 中 ， 将 现场 生产 过程 的 检测 数据 及时 地 上报 管理层 ， 使 厂部 领导 迅速 掌握 生产 情况 并 进行 合理 的 决策 ， 为 实现 油田 生产 自动化 管理 做 了 必要 的 准备 。 　 　 该软件 可 适用 于 奔腾 以上 的 PC机 及 服务器 ， 操作系统 为 Windows ／ ／ NT 的 环境 陈 祥光 （ 北京理工大学 化工 与 材料 学院 ） 薛锦诚 （ 北京理工大学 化工 与 材料 学院 ） 参考文献 １ ， 魏 源源 ． Ｖ ｉ ｓ ｕ ａ ｌ Ｂ ａ ｓ ｉ ｃ ５ ． ０ 中文版 程序设计 教程 ． 北京 ： 电子 工业 出版社 ， １ ９ ９ ８ ２ ， Ｍ Ｉ Ｌ Ｌ Ｅ Ｒ Ｔ ． Ｄ Ｅ Ｌ Ｐ Ｈ Ｉ ３ ． ０ 开发 指南 ． 北京 ： 机械 工业 出版社 ， １ ９ ９ ８ ３ ， 新思维 创作室 ． Ｄ Ｅ Ｌ Ｐ Ｈ Ｉ ４ ． ０ 应用 编程 ． 北京 ： 人民邮电出版社 ， １ ９ ９ ８ 收稿 日期 ： １ ９ ９ ９ － １ ２ － １ ９