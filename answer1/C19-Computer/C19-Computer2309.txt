计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 第卷 第期 VolNo 基于 SSL 的 安全 WWW 系统 的 研究 与 实现 韦卫 　 王德杰 　 张英 　 王行 刚 摘 　 要 　 文中 提出 并 实现 了 一个 基于 安全套 接字 层 SSL 技术 的 安全 WWW 系统 该 系统 可为 WWW 客户机 和 服务器 的 应用层 通信 应用软件 提供数据 加密 、 信息 完整性 、 实体 鉴别 和 非 抵赖 等 安全 服务 利用 流 机制 和 层 服务者 技术 将 安全套 接字 层 嵌入 操作系统 内核 ， 从而 使 安全 服务 对 上层 的 所有 应用软件 透明 为 提高 浏览器 的 通信 效率 ， 文中 提出 了 适合 于 系统 内核 实现 的 面向 进程 的 握手 保密 会话 文中 实现 的 安全 WWW 系统 可 跨 Win （ NT ） 和 UNIX 平台 运行 ， 并 可 对 http 、 电子邮件 、 FTP 和 telnet 等 提供 安全 保护 关键词 　 安全套 接字 层 ， Internet 安全 ， 安全 WWW ， 操作系统 内核 ， 密钥 管理 ， 密码学 中图法 分类号 　 TPSTUDYANDIMPLEMENTATIONOFASECUREWORLDWIDEWEBSYSTEMBASEDONSECURESOCKETSLAYERWEIWeiWANGDeJieZHANGYingandWANGXingGangInstituteofComputingTechnologyChineseAcademyofSciencesBeijing 　 Abstract 　 InthepaperhereasecureWorldWideWebsystembasedonsecuresocketslayerisputforwardandimplementedwhichcanbeusedtoprovidesecureservicessuchasencryptionintegritypeerauthenticationandnonrepudiationSSLcanbeembeddedintothekernelofoperatingsystemsbymeansofstreammechanismandlayeredserviceprovidertechniqueThismaketheSSLtransparenttoallapplicationsInordertoreducethedelayofcommunicationanewsessionkeymethodorientedtothehostprocessisproposedThisSSLcanrunacrossWINandUNIXplatformsandsecurehttpemailftpandtelnetKeywords 　 securesocketslayerInternetsecuritysecureWorldWideWebOSkernelkeymanagementcryptography 　 引 　 　 言 　 　 随着 Internet 技术 的 发展 ， WorldWideWebWWW 系统 已 从 最初 的 提供 信息 查询 浏览 一类 的 静态 服务 发展 成可 提供 动态 交互 的 网络 计算 和 信息 服务 的 综合 系统 ， 在 此基础 上 可 实现 对 网络 电子商务 、 事务处理 、 工作 流 以及 协同工作 等 业务 的 支持 WWW 系统 是 以 CS 方式 工作 的 ， 目前 WWW 信息安全 的 解决方案 通常 以 防火墙 为主 ， 防火墙 的 信息 加密 、 鉴别 和 完整性 等 安全 机制 通常 在 安全 IP 层 ［ ］ 和 应用层 的 SOCKS ［ ］ 中 实现 ， 防火墙 适合 于 组建 Intranet ， 在 安全 方面 缺乏 对 诸如 网络 电子商务 等 业务 的 支持 从 WWW 上 的 各类 应用 在 安全 方面 的 不同 需要 考虑 ， 安全 WWW 可以 由 以下 安全 协议 或 方案 支持 ： 安全 超文本 传输 协议 secureHTTP 、 安全 超文本 标记 语言 SHTML 、 安全 Java 、 安全 Java 类库 、 安全套 接字 层 SSL 和 安全 传输层 ［ ］ STCPTLS 　 　 安全套 接字 层 协议 ［ ］ SSL 是 由 Netscape 提出 并 应用 于 Netscape 浏览器 中 随着 Web 浏览器 技术 的 发展 ， SSL 已 被 工业界 认可 ， 并 成为 IETF 的 RFC 草案 在 操作系统 中 SSL 位于 TCP 和 应用层 协议 （ HTTP ， SMTP ， FTP ） 之间 安全套 接字 层 SSL 能够 以 两种 形式 实现 ， 一是 将 SSL 嵌入 操作系统 内核 ， 安全 机制 对 所有 上层 应用软件 透明 二是 在 应用层 以 C语言 库 形式 实现 ， 应用软件 的 源码 的 通信 部分 需要 按照 安全套 接字 通信协议 格式 重新 编写 ， 然后 链接 SSL 套接 字库 重新 进行 编译 ， 生成 执行 代码 通常 情况 下 商用 应用软件 的 源码 是 难以 得到 的 ， 所以 ， 第种 实现 方式 对于 网络安全 研制 而言 较为 实用 同时 ， 可 为 基于 InternetWeb 浏览器 和 电子邮件 技术 的 电子商务 、 专用 事务处理 和 多媒体 等 应用 提供 透明 的 安全 服务 本文 着重 研究 第种 实现 方式 　 总体 安全 结构 　 　 基于 SSL 安全 WWW 系统 仍然 采用 客户服务器 模式 ， SSL 实现 必须 在 客户机 、 Web 服务器 或 Web 代理 proxy 服务器 上 的 操作系统 内核 中 操作系统 为 UNIX 类 和 基于 WinSock 的 Win 、 和 NT 基于 SSL 安全 WWW 系统 可 对 应用层 提供 并 具备 如下 的 安全 服务 和 密码学 特性 　 　 浏览器 和 Web 服务器 双向 身份 鉴别 即 利用 双方 的 公钥 证书 保护 或 生成 的 主 密钥 mastersecret 对 握手 连接 信息 进行 签名 验证 MD ， SHA 和 DSS 　 　 信息 加密 支持 流 密码 、 分组 密码 和 公钥 加密 体制 　 　 面向 连接 的 信息 完整性 由 报文 认证码 MACMD ， SHA 等 支持 　 　 双方 信息 交换 的 不可否认 服务 通过 对 握手 信息 和 报文 信息 的 数字签名 来 实现 　 　 数据源 鉴别 由 握手 期间 密钥 交换 建立 的 主 密钥 、 加解密 密钥 、 认证码 密钥 和 相应 的 密码 算法 支持 　 　 从 系统 实现 角度 ， 安全 WWW 系统 由 以下 部分 构成 　 　 握手 协议 模块 建立 本次 连接 的 会 话 密钥 premasterkey ， 为 密码 组件 生成 报文 加密 密钥 和 信息 完整性 鉴别 密钥 ， 实现 浏览器 和 Web 服务器 双向 身份 鉴别 　 　 密码 组件 对 发送 队列 和 接收 队列 的 数据 进行 加密 、 解密 和 信息 完整性 检验 　 　 密钥 管理 进程 完成 公钥 证书 申请 与 获取 ， 从 磁盘 或 IC卡 读取 基本 密钥 ， 并 将 这些 信息 传送 至 握手 协议 模块 　 系统 设计 及 关键技术 　 　 客户 的 浏览器 和 服务器 操作系统 的 应用 进程 建立 connect 和 accept 套 接字 连接 成功 以后 ， 安全套 接字 层 SSL 开始运行 SSL 首先 进行 安全 握手 连接 ， 即 SSLconnect 和 SSLaccept ， 以 确定 密码 算法 、 密钥 和 压缩 方式 等 参数 握手 成功 以后 ， SSLreadWSPRecv 对 由 套 接字 层 或 TCP 层 上流 的 数据 进行 解密 ， 然后 将 明文 向 上层 发送 ， SSLwriteWSPSend 对 应用层 或套 接字 层 进行 加密 ， 将 密文 向 下层 发送 密钥 交换 在 握手 期间 进行 系统 共有 种 报文 类型 ： 握手 报文 handshake 密码 格式 变换 报文 changecipherspec 系统 报警 报文 alert 和 应用 数据 报文 applicationdata 　 层 无关 设计 技术 　 　 层 无关 技术 ［ ］ 是 简化 网络通信 协议 的 复杂性 的 技术 ， 即 第 n 层 的 实现 与 修改 将 不 影响 第 n 层 和 n 层 的 实现 我们 采用 层 无关 技术 将 SSL 层 实现 在 操作系统 内核 中 的 socket 层 和 TCPUDP 层 之间 ， 从而 使 SSL 层 的 安全 机制 对系统 应用层 的 所有 网络 应用软件 提供 透明性 服务 ， 同时 ， SSL 具有 较 好 的 可移植性 ， 可 在 任意 的 具有 winsock 和 UNIXSYSV 以上 的 操作系统 中 运行 ， 与 硬件平台 无关 为 保证 可 互操作性 ， SSL 对 通信 报文 进行 了 如下 处理 ， 使得 ① 当 一个 无 SSL 的 系统 收到 SSL 报文 时 ， 能够 妥当 地 处理 ② 具有 安全套 接字 层 的 系统 能够 对 收到 的 非 SSL 保护 的 socket （ TCPUDP ） 报文 进行 妥善处理 　 　 图 给出 了 SSL 在 Win 平台 和 UNIX 平台 实现 的 体系结构 ， SSL 在 Win 中 作为 系统 的 一个 动态 连接 库 被 插入 操作系统 的 内核 ， 在 SSL 动态 连接 库中 由 WSPConnect 函数 发起 握手 ， WSPRecv 和 WSPSend 对 来自 下层 TCP 和 上层 winsock 的 数据 进行 解密 、 加密 和 完整性 检验图 　 安全 WWW 系统 结构图 　 　 在 UNIX 中 SSL 作为 一个 流 stream 设备 模被 push 到 系统 内核 SSL 模块 主要 由 sslmodopensslmodclosesslmodrputsslmodwputsslmodwsrv 和 sslmodrsrv 等 函数 组成 SSL 模块 以读 队列 中 读取 的 报文 类型 作为 事件驱动 ， 响应 客户机 的 握手 请求 ， 进行 解密 、 加密 和 完整性 检验 　 面向 进程 的 握手 和 保密 会话 　 　 握手 协议 在 密码学 意义 上 实现 了 客户 和 服务器之间 的 双向 鉴别 、 密钥 交换 和 保密 会话 其 安全性 建立 在 离散 对数 DH 协议 或 整数 分解 RSA 协议 的 难题 上 　 　 安全套 接字 层 的 握手 协议 是 为 客户 和 服务器 双方 进行 保密 通信 前 确定 安全 参数 、 密钥 、 算法 和 同步 的 协议 在 通信 方面 ， 握手 协议 需 进行 次 交互 图 从 密钥 交换 和 安全 意义 方面 描述 了 握手 协议 一个 完整 的 握手 过程 可 在 客户 和 服务器之间 建立 一个 对 等 的 保密 会话 session ， 一个 会话 可 支持 一个 或 多个 connections 在 套 接字 层 ， 一个 客户 套 接字 建立 在 一个 连接 connection 上图 　 握手 协议 　 　 当 一次 握手 产生 的 保密 会话 仅 支持 一个套 接字 时 ， 我们 称之为 面向 单 一套 接字 的 保密 会话 通常 情况 下 ， 建立 在 应用层 的 安全套 接字 层 采用 面向 单 一套 接字 的 保密 会话 由于 在 浏览器 环境 下 ， http 协议 是 一个 无 连接 、 无 状态 的 协议 ， 每次 连接 仅 处理 一个 请求 ， 且 服务器 和 客户机 均 不 保存 前次 连接 的 状态 ， 连接 的 建立 和 关闭 频繁 ， 多数 连接 仅 传送 少量 的 数据 ， 所以 ， 面向 单 一套 接字 的 保密 会话 在 WWW 浏览器 环境 下 ， 运行 的 速度 较慢 减少 握手 次数 可 提高 浏览器 的 速度 另一方面 ， 在 浏览器 利用 http 或 ftp 登录 到 服务器 成功 后 ， 系统 可能 利用 一个套 接字 传送 大量 的 数据 ， 此时 在 内核 中 无法 为 这种 套 接字 建立 握手 为此 ， 本文 提出 并 实现 了 一种 面向 主机 进程 的 安全 会话 ， 即当 一个 浏览器 进程 A 与 服务器 B 握手 产生 了 会 话 密钥 premasterkey 后 ， 该 密钥 可 被 A 进程 的 所有 与 服务器 B 的 连接 使用 使用 面向 进程 的 安全 会话 比 面向 连接 的 会 话 效率高 　 　 密钥 交换 在 握手 期间 进行 基于 DiffieHellman 密钥 交换 协议 是 最 简洁 的 方案 ， 客户 和 服务器 可以 不必 去 CA 机构 获取 对方 的 公钥 证书 ， 证书 可 在 密钥 交换 时 动态 产生 如果 基于 RSA 密钥 交换 协议 ， 则 客户 和 服务器 必须 获取 对方 的 公钥 证书 ， 当 服务器 发出 CertificateRequest 时 ， 客户机 必须 实时 生成 密钥 交换 公钥 证书 KeyExchange 报文 包含 了 密钥 交换 的 参数 ， 如 DH 的 P ， g 和 gx 　 　 握手 协议 的 ClientHello 报文 由 客户 在 WSPconnect 中 生成 并 发送至 服务器 ， 服务器 从 下流 读 队列 中 获取 ClientHello 后 ， 便 开始 握手 过程 ， 握手 结束 后 在 客户 和 服务器之间 建立 起 一个 保密 会话 session ， 此时 开始 http ［ ］ 客户 request 和 服务器 response 协议 本文 在 Pentium 客户机 和 SUNSPARC 服务器 环境 下 ， 使用 基于 位 安全 素数 P 的 DiffieHellman 密钥 交换 协议 ， 服务器 和 客户 实时 生成 公钥 参数 P ， g ， gx ， gy 和 gxy ， 握手 时间 为 秒钟 　 密钥 管理 协议 的 实现 　 　 密钥 管理 包括 密钥 交换 、 密钥 生成 和 密钥 分配 常用 密钥 交换 协议 有 基于 有限 群 的 离散 对数 难题 的 DiffieHellman 和 整数 分解 难题 的 RSA 密钥 交换 协议 ［ ］ ， 基于 椭圆 曲线 上 点 组成 的 加法 群倍点 难题 的 椭圆 曲线 密钥 分配 协议 ［ ， ］ 目前 密钥 分配 的 主要 方案 为 自动 分配 和 人工 分配 ， 由于 Internet 信息 的 实时性 、 信息量 的 突发性 和 信息 浏览 的 自由性 ， 传统 的 基于 手工 密钥 分配 的 密钥 交换 难以 满足 Internet 的 要求 所以 ， 必须 使 通信 实体 双方 可 利用 非 安全 信道 Internet 获取 对方 的 密钥 ， 安全 的 核心 要求 无关 第方 在 非 安全 信道 上 获取 密钥 交换 信息 而 计算 出 共享 密钥 是 一个 单向 陷门 问题 证书 机构 CA 是 目前 最 常用 的 密钥 自动 分配 方案 本文 主要 研究 SSL 在 无公钥 证书 的 情况 下 的 密钥 交换 和 生成 　 密钥 交换 　 　 在 无公钥 证书 的 情况 下 ， 由 Web 服务器 实时 生成 DH 或 RSA 的 短期 公钥 参数 ， 利用 密钥 交换 ServerKeyExchange 报文 传送 给 Web 浏览器 在 DH 密钥 方案 中 ， 当 服务器 在 收到 客户 的 ClientHello 报文 后 ， 由 服务器 生成 DH 私钥 x 和 公钥 参数 PggxmodP ， 并 将 公钥 参数 发送给 浏览器 客户 客户 生成 并 发送 公钥 gymod 　 P ， 双方 生成 premasterkeygxy 　 mod 　 P ， 见图 所示 当 使用 RSA 方案 时 （ 参见 图 ） ， 服务器 首先 生成 短期 RSA 公钥 参数 ， 浏览器 从 ServerKeyExchange 中 获取 服务器 的 公钥 参数 （ Na ） ， 其中 ： Np × pab ≡ 　 mod Φ N 浏览器 随机 产生 premasterkeybytes ， 用 服务器 的 公钥 a 保护 premasterkeyypremasterkeyamodN 并 发送给 服务器 ， 服务器 利用 私钥 b 获得 premasterkeyyabmodN 图 　 DH 密钥 交换 协议 图 　 RSA 密钥 交换 协议 　 　 上述 密钥 交换 安全 的 核心 在于 的 公钥 参数 P ， p 和 p 的 生成 ， 构造 并 使用 形如 Pq 的 安全 素数 是 保证 基于 离散 对数 难题 的 DH 方案 和 RSA 方案 安全 关键 ， 本文 安全 素数 生成 算法 基于 文献 ［ ］ 的 下述 定理 　 　 定理 设 整数 F 的 素 因子 分解 为 ， PRF ， R 为 整数 ， 如果 存在 整数 a ， 使得 aP ≡ mod 　 P ， gcdaPqiP （ i … s ） ， 则 P 的 每个 素 因子 是 形如 mF 的 素数 ， m 再者 ， 如果 F 为 大于 R 的 奇数 ， 或 ， 则 P 为 素数 　 　 定理 设 P ＝ q ， q 为 素数 （ 或 奇数 ） ， 如果 存在 整数 a ≥ ， 使得 　 　 aP ≡ mod 　 P ， gcdaPqP ， amodp ， aqmodp 成立 ， 则 P 为 DH 安全 素数 ， 且 a 为 Zp 上 的 本原 根 　 密钥 生成 　 　 密钥 由主 密钥 masterkey 、 预主 密钥 premasterkey 、 套 接字 报文 加密 密钥 writekey 和 报文 完整性 认证 密钥 MACkey 组成 ， 这些 密钥 都 是 在 握手 时 动态 生成 　 　 masterkeyMDpmkeySHA ′ A ′ premasterkeyClientHellorandom 　 　 　 　 　 　 　 ServerHellorandomMDpmkeySHA ′ BB ′ premasterkey 　 　 　 　 　 　 　 ClientHellorandomServerHellorandom 　 　 　 　 　 　 　 MDpmkeySHA ′ CCC ′ pmkeyClientHellorandomServerHellorandom 　 　 WriteKeyMACKey ＝ MDmasterkey … 　 　 为 防止 基于 代理 proxy 技术 的 中间 插入 攻击 ， 安全 WWW 系统 的 客户 和 服务器 还 必须 设立 一个 可 被 安全 存储 的 基本 密钥 basekey ， 由 基本 密钥 保护 握手 信息 或公钥 证书 　 结论 和 后续 工作 　 　 本文 实现 的 安全 WWW 系统 的 客户端 支持 基于 UNIX 和 WINNT 、 和 的 Netscape 浏览器 、 FTP 和 telnet ， 同时 支持 Microsoft 的 IE 浏览器 在 服务器端 支持 NT 以及 与 UNIX 系统 版本 以上 兼容 的 操作系统 用于 密钥 交换 或 证书 公钥 的 长度 最大 至位 ， 用于 套 接字 报文 加密 的 密钥 长度 在 ～ 位 下面 我们 给出 在 M 以太网 Pentium 客户机 Netscape 和 SUNSPARC 服务器 环境 下 安全 WWW 的 运行 结果 套 接字 数据 报文 的 加密 和 认证 时间 取决于 加密 和 认证 算法 ， 以及 算法 的 实现 方式 ， 如 RC ［ ］ 的 加密 速度 为 字节 秒 ， 对 浏览器 用户 影响 不大表 给出 对 WWW 浏览器 用户 影响 最大 的 握手 时间表 　 安全 WWW 握手 时间 　 DH 方案 P ≈ DH 方案 P ≈ RSA 方案 N ≈ 握手 时间 秒 秒 秒 当无公钥 证书 时 ， 实时 生成 公钥 证书 已 获取 公钥 证书 　 　 在 SSL 握手 前 获取 公钥 证书 ， 则 能 减少 浏览器 的 连接时间 本文 的 后续 工作 是 建立 能 在 Internet 上 分配 公钥 证书 的 证书 机构 CA ， 其中 包括 证书 目录 X 、 pem 、 证书 发现 协议 、 证书 登记 和 证书 分发 等 本 课题 得到 国家 “ 八 六三 ” 高技术 计划 主题 基金 资助 作者简介 ： 韦卫 ， 男 ， 年月生 ， 博士 研究生 ， 高级 工程师 ， 研究 方向 为 计算机 网络安全 、 密码学 、 人工智能 王德杰 ， 男 ， 年月生 ， 硕士 ， 副研究员 ， 研究 方向 为 计算机网络 张英 ， 女 ， 年生 ， 研究员 ， 研究 方向 为 计算机网络 王行 刚 ， 男 ， 年生 ， 研究员 ， 博士生 导师 ， 研究 方向 为 计算机网络 与 多媒体通信 作者 单位 ： 中国科学院计算技术研究所 　 北京 　 参考文献 　 　 韦卫 ， 王德杰 ， 王行 刚 Internet 网络层 安全 协议 理论 研究 与 实现 计算机 学报 ， ～ WeiWeiWangDejieWangXinggangTheoreticresearchesandimplementationofIPsecuringprotocolviaInternetnetworklayerChineseJournalofComputersinChinese ～ 　 　 LeechMGanisMLeeYetalSOCKSProtocolVersionRFC 　 　 韦卫 ， 王行 刚 TCP 安全 框架 的 研究 通信 学报 ， ～ WeiWeiWangXinggangResearchesonTCPsecurityframeJournalofChinaCommunicationinChinese ～ 　 　 FreierAKarltonPKocherPTheSSLProtocolVersion 〈 draftietftlssslversiontxt 〉 httpwwwietforg 　 　 FieldingRGettysJMogulJHypertextTransferProtocol — — HTTPRFC 　 　 韦卫 ， 王行 刚 安全 素数 生成 算法 及其 在 安全套 接字 层 SSL 密钥 交换 协议 中 的 实现 见 ： 第五届 计算机科学 与 技术 研究生 学术 论文集 北京 ： 中国科学院计算技术研究所 ， WeiWeiWangXinggangAnalgorithmofsafeprimegenerationanditsimplementationinkeyexchangeprotocolofsecuresocketslayerInThethSymponComputerScienceandTechnologyforGraduatedStudentinChineseBeijingInstituteofComputingTechnologyChineseAcademyofSciences 　 　 SchroeppelROrmanHFastkeyexchangewithellipticcurvesystemsInCRYPTOLectureNotesonComputerScienceNewYorkSpringer 　 　 RivestRLTheRCEncryptionAlgorithmCryptoBytesVolUSARSAlaboratoris 　 　 GollmannDCryptographicAPIsCryptographyPolicyandalgorithmsInLectureNotesinComputerScienceNewYorkSpringer 原稿 收到 日期 ： 修改稿 收到 日期 ：