计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 PIP 与 ATM 综合 的 新 技术 桵 PLS 李珂 　 朱康辛 　 顾尚杰 　 诸 鸿文 摘要 MPLSMultiprotocolLabelSwitching ： 多 协议 标记 交换 作为 一种 新 的 IP 与 ATM 综合 的 技术 正在 快速 发展 。 简要 回顾 了 MPLS 的 发展 过程 ， 介绍 了 MPLS 的 总体 框架 ， 最后 论述 了 MPLS 目前 急需解决 的 关键技术 。 关键词 局域网 仿真 IPOAMPOATag 交换 IP 交换 多 协议 标记 交换 VC 合并 路由 环 概述 　 　 近年来 ， Internet 上 的 主要 业务 由 传统 的 文件传送 FTP 、 电子邮件 Email 和 远程 登录 Telnet 等 转向 多媒体 应用 丰富 的 WWW 。 多媒体通信 的 迅猛发展 要求 网络 能 提供 具有 不同 QoS 等级 的 综合 业务 ， 由于 Internet 采用 面向 无 链接 的 IP 协议 ， 只能 提供 尽力而为 Besteffort 服务 ， 无法 提供 QoS 保证 。 因此 当 现有 Internet 规模 扩充 到 一定 限度 后 ， 将 在 许多 方面 面临 挑战 ： 带宽 、 路由 、 网络 扩展性 、 QoS 等 。 　 　 ATM 技术 的 出现 为 解决 Internet 困境 带来 了 契机 ， IETF 制定 了 经典 的 IPOAClassicIPoverATM ， ATM 论坛 制定 了 局域网 仿真 LANE 和 MPOAMultiprotocoloverATM ， 有 的 已经 得到 了 广泛 的 应用 。 但 这些 方案 均 不够 理想 。 在 早期 的 方案 中 ， 所 采用 的 是 叠加 式 Overlay 模型 。 这种 模型 将 ATM 与 IP 视作 叠加 的 层次 关系 ， ATM 与 IP 各自 拥有 自己 的 地址 结构 ， 需要 地址 解析 协议 进行 两类 地址 的 映射 ， 其 优点 是 减少 了 ATM 与 IP 的 相互 限制 ， 有利于 它们 独立 地 发展 ， 也 有利于 向 未来 的 BISDN 过渡 。 但 缺点 就是 IP 技术 和 ATM 技术 不能 很 有效 地 结合 起来 ， 无论是 分组 的 封装 效率 、 建链 的 时延 、 对 组播 的 支持 以及 对 QoS 的 支持 ， 都 不 理想 。 　 　 近几年 的 发展 已经 清楚 地 表明 ， IP 将 是 本世纪 网络 的 主宰 。 因此 ， 在 不 改变 IP 以及 现有 的 基于 IP 技术 的 应用 的 基础 上 ， 如何 使 ATM 技术 融入 IP ， 将 路由 和 交换 结合 起来 ， 解决 IP 无 连接 和 ATM 面向 连接 的 矛盾 ， 以 支持 规模 日益增长 的 Internet 和 多媒体业务 ， 成为 目前 研究 的 热点 。 众多 厂商 和 学者 提出 了 许多 新 方案 、 概念 和 名词 ， 如 IP 交换 、 CSR 、 Tag 交换 、 ARIS 、 MPLS 等 。 　 　 本文 将 简单 介绍 其它 的 IP 交换 技术 、 MPLS 技术 的 基本 框架 和 MPLS 急需解决 的 关键技术 。 IP 交换 技术 的 发展 情况 IP 交换 IPSwitching 　 　 Ipsilon 公司 提出 了 IP 交换 ， 丢弃 了 ATM 的 面向 连接 性质 ， 保留 IP 的 无 连接性 ， 将 ATM 的 硬件 直接 与 IP 综合 在 一起 。 IP 交换 控制器 通过 GSMP 对 交换 硬件 进行 访问 ， 用 IFMP 来 管理 IP 流 和 ATMVC 流 的 关系 。 通过 对流 的 分类 ， 长流 如 FTP 、 TELNET 、 HTTP 数据 及 多媒体 音频 、 视频 数据 等 给 以 标号 由 ATM 硬件 直接 交换 ， 短流 如 DNS 查询 、 SMTP 数据 和 SNMP 查询 等 由 IP 前传 ， 并 根据 RFC 对 分组 进行 封装 。 它 的 分类 和 加标 不 在 网络 的 入口 或 出口处 ， 而是 在 网内 的 任一 中间 节点 ， 因此 具有 局部 意义 ， 相当于 分段 优化 。 Tag 交换 TagSwitching 　 　 Tag 交换 由 CISCO 公司 提出 ， 基于 标记 Label 交流 Swapping 概念 。 交换 边缘 路由器 让 数据 单元 分组 或 信元 携带 长度 短 而 固定 Tag 标记 ， 依 此 告知 交换 节点 如何 处理 数据 。 Tag 封装 可以 有 多种 方法 ， 如 插 在 层头 和 网络层 头 之间 ， 或 作为 层头 或 网络层 头 的 一部分 ， 因此 可以 在 不同 的 物理 媒体 上 使用 ， 包括 ATM 链路 、 HSSI 以及 LAN 接口 等 。 由于 ATM 交换 也 基于 标记 交流 技术 ， 因此 Tag 交换 技术 可以 很 容易 地 应用 至 ATM 交换 。 Tag 分发 协议 TDP 通过 与 标准 的 网络层 路由 协议 相结合 ， 在 标记 交换 网络 的 各 设备 间 分发 Tag 标记 ， 因此 是 基于 路由 分配 Tag ， 而 不是 按 数据流 属性 。 Tag 交换机 根据 分组 携带 的 Tag 标记 以及 自己 所 维持 的 Tag 前传 信息 进行 分组 前传 。 对于 单播 ， 通过 在 邻近 双方 建立 TCP 连接 ， 然后 TDP 向 相 邻近 节点 分发 Tag 标记 ， 对于 Tag 堆栈 ， 由 BGP 的 Piggyback 来 进行 高层次 Tag 分发 。 对于 组播 ， 没有 普遍 通用 的 支持 ， 在 PIM 环境 中 ， 用 PIM 的 控制 消息 携带 Tag 绑定 信息 。 Tag 交换 也 支持 RSVP ， 通过 对 RSVP 进行 扩展 来 携带 有关 Tag 绑定 信息 。 对于 直接 路由 ExplicitRouting ， 则 通过 在 RSVP 中 加入 一个 新 的 源 路由 对象 SourceRouteObject 来 支持 。 　 　 除了 Ipsilon 和 Cisco 以外 ， 其它 许多 网络 厂商 也 提出 了 各自 的 方案 ， 如 东芝 的 CSRCellSwitchRouter 、 IBM 的 ARISAggregateRoutebasedIPSwitching 等 。 所有 这些 公司 的 技术 中均 使用 了 标记 概念 ， 但 不 系统 不 完整 。 年 ， 由 多家 公司 联合 向 IETF 提交 了 MPLS 多 协议 标记 交换 ： MultiprotocolLabelSwitching 框架 及 体系结构 两个 草案 文档 ， 在 Cisco 公司 的 Tag 交换 为 基础 上 综合 各家 之 长 。 IETF 随后 组成 了 MPLS 工作组 开始 进行 标准化 工作 。 MPLS 的 总体 框架 　 　 MPLS 中 引入 了 非常 多 的 新 概念 和 术语 ， 其中 比较 关键 的 有 ： ① Label 标记 ： 用于 表示 FEC 的 固定 长度 的 标识符 ， 仅 具有 局部 意义 ； ② LSR 标记 交换 路由器 ： 支持 第三层 前传 的 MPLS 节点 ； ③ FEC 等效 前传类 ： 以 相同 方式 如 ： 通过 同 一条 路径 ， 受到 LSR 相同 的 前 传 处理 进行 前传 的 一组 IP 分组 ； ④ LabelStack 标记 堆栈 ： 一组 有序 的 标记 ， 不同 位置 的 标记 代表 着 不同 的 层次 ； ⑤ LSP 标记 交换 路径 ： 一个 特定 的 FEC 在 同一 层次 上 经过 LSRs 所 形成 的 路径 ； ⑥ LDP 标记 分发 协议 ： 一个 LSR 通知 其它 LSRs 关于 标记 FEC 绑定 信息 的 一系列 过程 。 　 　 在 面向 无 连接 的 网络 中 ， 每个 路由器 通过 分析 分组 头来 独立 地 选择 下 一 跳 ， 而 分组 头 中 含有 比 需要 用来 判断 下 一 跳 多得多 的 信息 。 选择 下 一 跳 的 工作 可为 两 部分 ： 将 分组 分成 FECs 和 为 FEC 选择 下 一 跳 。 在 传统 IP 前 传中 ， 每个 路由器 对 同一个 FEC 的 每个 分组 都 要 进行 分类 和 选择 下 一 跳 ， 而 在 MPLS 中 ， 对于 一个 分组 ， 只是 在 它 进入 网络 时 进行 FEC 分类 ， 并 分配 一个 相应 的 标记 ， 网络 中 的 LSR 则 不再 需要 对 网络层 头 进行 分析 ， 直接 根据 标记 进行 处理 。 有些 传统 路由器 在 分析 分组 头时 ， 不但 决定 分组 的 下 一 跳 ， 而且 要 决定 分组 的 业务 类型 COS ： ClassofService ， 以 给予 不同 的 服务 规则 。 MPLS 可以 但 不是 必须 利用 标记 来 支持 COS ， 此时 ， 标记 用来 代表 FEC 和 COS 的 结合 。 MPLS 为 多 协议 标记 交换 的 缩写 ， 可以 支持 任何 网络层 协议 ， 但 实际上 ， MPLS 工作组 仅 考虑 IP 协议 。 　 　 来自 路由 协议 的 信息 用于 分配 和 分发 标记 ， 一般来说 ， 由 下游 节点 向 上游 节点 分发 标记 ， 连成 一串 的 标记 就 构成 了 LSP 。 在 单播 中 ， LDP 有 两种 方式 来 进行 标记 的 分发 ： 独立 方式 Independent 和 受控 方式 Ordered 。 在 独立 方式 中 ， 任何 节点 可以 在 任何 时候 为 每 一个 它 认识 的 流 进行 标记 分发 ； 受控 方式 中 ， 一个 流 的 标记 分发 从 这个 流 所属 的 出口 节点 开始 ， 这样 可以 保证 整个 网络 内 标记 与 流 的 映射 是 完全一致 的 。 　 　 标记 分配 由 下游 执行 ， 而 下游 节点 由 路由 决定 ， 也 有 两种 分配 方式 ： 下游 Downstream 分配 和 下游 按 需 Downstreamondemand 分配 。 前者 由 下游 分配 标记 ， 并 分发 到 邻近 的 LSRs ， 后者 则 由 上游 LSR 为 一个 流向 下游 LSR 提出 标记 分配 请求 ， 这 在 ATM 网络 中 很 有用 ， 因为 ATM 不能 进行 LSPs 的 合并 。 　 　 不论是 独立 还是 受控 方式 ， 可以 采用 自由 模式 LiberalMode 或 保守 模式 ConservativeMode 分发 标记 。 在 自由 模式 中 ， 向 所有 邻近 的 LSRs 分发 一个 FEC 的 标记 ， 而 不管 自己 是否是 这些 节点 在 此 FEC 上 的 下 一 跳 ， 这样 做 的 优点 是 当 路由 发生变化 时 ， 可以 立即 使用 预先 分发 好 的 标记 ， 但 这 将 消耗 更 多 的 标记 ； 保守 模式 只分 发给 下 一 跳 是 自己 的 那些 节点 ， 这样 可以 节省 标记 空间 。 　 　 MPLS 中 一个 关键 部分 就是 可以 将 同一个 标记 或 LSP 分配 到 多个 流 上 。 MPLS 支持 标记 的 不同 层次 的 颗粒化 Granularity 。 根据 对 共享 标记 和 最大 程度 获得 交换 的 好处 之间 的 折中 ， 可以 选择 不同 的 颗粒化 。 常用 的 颗粒化 有 ： 　 　 ● IP地址 前缀 IPPrefix ： 具有 相同 的 目的 网络地址 将 共用 同一个 LSP ， 与 自由 方式 配合 使用 ， 可以 使 标记 一次性 完成 分配 ； 　 　 ● 出口 路由器 EgressRouter ： 有 同一个 出口 路由器 的 所有 IP地址 共用 相同 的 LSP ， 扩展性 最好 ； 　 　 ● 应用 流 ApplicationFlow ： 扩展性 最差 ， 但 保证 了 端 到 端的 交换 。 　 　 典型 的 LSP 是 一棵 多 点到点 的 树 ， 多个 流在 某些 节点 上 汇聚 成 一个 流 ， 这 使得 MPLS 可以 用 On 数量级 的 标记 来 进行 流量 交换 ， 极大 地 增加 了 扩展性 ， 但 前提 是 LSRs 必须 支持 流 合并 ， 这 在 ATM 网络 中 存在 问题 。 　 　 MPLS 通用 头 Shim 可以 灵活 地 封装 到 不同 的 位置 ， 可以 在 第二层 头 或 第三层 头 中 ， 甚至 可以 在 第二层 与 第三层 头 之间 ， 而且 根据 不同 的 数据 链路层 将 有 不同 的 格式 ， 例如 在 点到点 网络 中 ， 就 封装 到 PPP 头 的 后面 ， 而 在 ATM 网络 中 ， 则 将 标记 映射 到 VPIVCI 中 。 Shim 的 格式 支持 标记 堆栈 ， 进入 网络 的 数据 可以 携带 多个 标记 ， 这些 标记 采用 先进先出 的 堆栈 方式 ， 这 使得 MPLS 支持 层次化 操作 ， 例如 在域 内 Intradomain 用 第一个 标记 ， 而 在 域间 Interdomain 用 第二个 标记 ， 而且 LSRs 对于 标记 的 处理 方式 与 标记 堆栈 完全 无关 ， 它 永远 是 对 最 上面 一个 标记 进行 操作 。 MPLS 的 关键技术 VC 合并 VCMerging 　 　 MPLS 通过 对 标记 不同 粗细 程度 的 分类 和 流 合并 两种 方法 将 网络 的 连接数 从 On 降到 On ， 从而 极大 地 增加 网络 的 可扩展性 。 当 MPLS 运行 在 基于 帧 的 媒质 上时 ， 流 合并 很 简单 ， 所要 做 的 仅仅 是 要求 节点 将 多个 上游 标记 对应 到 同一个 下游 标记 ， 这 也 称为 帧 合并 。 但是 在 ATM 上 就 会 产生 问题 。 在 ATM 中 ， MPLS 的 标记 对应 于 ATM 信元 中 的 VPIVCI 域 ， 因此 流 合并 意味着 VPIVCI 合并 。 但是 标准 的 ATM 交换机 不 支持 VC 合并 ， 如果 直接 将 不同 的 VC 合并 成 同一个 出口 VC ， 不同 分组 的 信元 就 会 交错 在 一起 ， 而且 接收 方 没有 办法 能 分辨 出来 。 一种 可行 的 方法 是 用 VP 而 不是 VC 来 进行 流 合并 ， 通过 对 每个 VP 分配 不同 的 VC 空间 来 解决 信元 交错 问题 ， 但 这样 将 极大 地 降低 VPIVCI 的 利用率 ， 而且 需要 机制 来 进行 VC 空间 的 分配 。 　 　 VC 合并 要求 ATM 交换机 对 不同 入口 VC 进来 的 分组 先 进行 串行化 ， 这 就 要求 ATM 交换机 中有 额外 的 缓存 ， 对此 MPLS 工作组 在 年 月 推出 的 草案 中 提出 了 一种 解决方案 ， 并 初步 研究 了 它 的 性能 。 路由 环 Loop 的 防止 与 检测 　 　 由于 LSP 的 建立 基于 路由 信息 ， 因此 LSP 有 可能 也 形成 环路 。 在 传统 的 IP 网络 中 ， IP 通过 TTL 域来 减轻 进入 路由 环 的 分组 对 整个 网络 的 影响 。 但是 ATM 和 FrameRelay 均 不 支持 TTL 。 因此 MPLS 工作组 提出 ： “ 必须 要 有 某种 机制 ， 防止 路由 环 产生 ， 或者 （ 并且 ） 保留 一些 网络资源 可以 用于 路由 环所 产生 的 消耗 。 ” 有 两种 方法 来 处理 路由 环 ： 检测 和 防 防止 。 对于 方式 允许 路由 环 存在 但 MPLS 将会 检测 到 它 并 进行 处理 删除 或弃 用 ； 对于 防止 方式 ， MPLS 将 提供 机制 来 杜绝 路由 环 的 生成 。 　 　 可以 通过 在 MPLS 消息 中 加入 路径 矢量 域 Pathvectorfield 来 检测 路由 环 。 路径 矢量 域 中 包含 了 前 传 某个 流 的 每个 节点 的 标识符 ， 当 某个 节点 收到 这个 域时 ， 就 检查 自己 的 标识符 是否 已经 在 路径 矢量 域 中 ， 如果 已经 有 了 ， 则 表明 产生 了 回路 ； 如果 没有 ， 则 将 自己 的 标识符 加 到 路径 矢量 域 中 并 前 传 MPLS 消息 。 　 　 ARIS 提出 了 一种 扩散 算法 Diffusion 来 防止 路由 环 ， 对于 某个 流 ， 当 某个 节点 的 下 一 跳 发生变化 时 ， 首先 用 Diffusion 算法 来 判断 是否 会 产生 路由 环 ， 在 执行 完毕 之前 ， 仍 沿用 旧 的 路径 来 发送数据 。 MPLS 工作组 也 在 考虑 其它 扩展性 更好 的 机制 。 在 年 月 提出 的 Internet 草案 中 提出 了 一种 简单 的 线程 机制 ThreadsMechanism 。 当 一个 节点 比如 入口 节点 想 建立 LSP 或 它 的 下 一 跳 发生 改变 时 ， 它 向 下游 节点 发送 一个 Thread 。 Thread 由 唯一 的 颜色 Color 、 跳数 Hopcount 和 TTL 三 部分 组成 ， 如果 节点 收到 了 由 它 先前 发出 的 Thread ， 则 说明 有 回路 产生 ， 如果 它 收到 出口 节点 发回 的 确认 消息 ， 则 说明 不会 形成 回路 。 MPLS 工作组 目前 仍 未 决定 究竟 选 哪种 机制 。 RSVP 与 MPLS 　 　 已有 人 提出 通过 直接 路由 将 RSVP 和 MPLS 结合 起来 ， 并 可以 用于 流量 工程 Trafficengineering 。 草案 规定 了 如何 对 RSVP 流 进行 标记 的 分配 和 绑定 ， 并 通过 RSVP 的 消息 PATH 和 RESV 消息 来 传送 相应 信息 ， 其中 需要 解决 的 问题 有 ： 当 ATM 不 支持 流 合并 时 ， 要 为 每个 发送 方 分配 一个 标记 ， 此时 如何 将 一组 标记 作为 整个 来 进行 资源 预留 ； 如何 在 ATM 中 进行 TTL 处理 ； 如何 在 共享 媒质 上 进行 标记 分区 等 。 　 　 当 RSVP 路径 因 某种原因 发生 故障 时 ， RSVP 将 采用 普通 的 Besteffort 路由 来前 传 ， 而 这 与 流量 工程 的 目的 相 矛盾 ， 因为 当 一部分 流量 采用 预定 的 路径 时 ， 另 一部分 流量 却 采用 动态 路由 。 而且 ， 当 一条 路径 的 一部分 采用 预定 的 路径 ， 而 其它 部分 采用 动态 逐跳 路由 时 ， 有 可能 出现 永久 路由 环 。 MPLS 在 共享 媒质 中 　 　 现已 提出 两种 方案 ， 一种 是 将 Shim 头 放在 MAC 头 和 网络层 头 之间 ， 当 数据 在 共享 媒质 中前 传时 ， 不 使用 Shim 头 ， 而仅 在 共享 媒质 的 边界 路由器 使用 。 另 一种 机制 是 通过 重新 定义 目的 MAC 地址 的 语义 ， 将 标记 编码 到 MAC 头中 ， 这样 就 不 需要 像 第一种 方案 那样 要 对 帧 进行 分段 ， 而且 网桥 可以 具有 路由 功能 ， 但 它 的 缺点 是 无法 和 现有 的 LAN 互通 。 结束语 　 　 除了 以上 提到 的 ， MPLS 工作组 在 一些 方面 上 还 没有 充分 涉及 到 ， 如 与 其它 许多 已 比较 成熟 的 IPoverATM 技术 之间 的 互操作性 。 总而言之 ， MPLS 还是 一项 非常 不 成熟 的 技术 ， 许多 方面 仍 在 进行 标准化 草案 。 到 目前为止 ， 仅 在 年 月 举行 的 IETF 工作 会议 上 通过 了 一个 相关 标准 。 对 许多 关键问题 仅 提出 粗略 的 解决方案 ， 既 未 完全 制定 好 细节 ， 也 没有 任何 性能 上 的 测试 和 验证 ， 有些 技术 则 还 处于 初步阶段 ， 如 ： 组播 、 路由 跟踪 Traceroute 、 OM 、 用于 政策 路由 的 直接 路由 以及 安全性 等 方面 。 李珂 （ 上海交通大学 电子 工程系 上海 ） 朱康辛 （ 上海交通大学 电子 工程系 上海 ） 顾尚杰 （ 上海交通大学 电子 工程系 上海 ） 诸 鸿文 （ 上海交通大学 电子 工程系 上海 ） 参考文献 ， ArunViswanathanetalEvolutionofMultiprotocolLabelSwitchingIEEEComputerCommunicationsMaypp ～ ， ERosenetalMultiprotocolLabelSwitchingArchitectureInternetDraftFeb ， RCallonetalAFrameworkforMultiprotocolLabelSwitchingInternetDraftNov ， IWidjajaetalPerformanceIssuesinVCMergeCapableMPLSSwitchingInternetDraftOct ， IWidjajaetalStudyofImplicationsofVCMerginginMultiprotocolLabelSwitchinghttpcmbelllabscomcmmswhoanwarpubhtml ， YOhbaetalMPLSLoopPreventionMechanismInternetDraftNov ， BDavieetalUseofLabelSwitchingwithRSVPInternetDraftMar 收稿 日期 ： 年月日