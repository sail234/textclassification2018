计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNo 多功能 IC卡 系统 设计 与 系统 安全性 何大 可 　 李晓航 　 饶 　 伟 　 　 摘 　 要 　 西南交大 校园卡 ′ 系统 、 清华大学 校园 IC卡 系统 是 国内 高校 有 代表性 的 校园 IC卡 系统 。 此类 多功能 IC卡 系统 的 设计 ， 特别 是 系统 的 安全 设计 ， 对 企事业 单位 的 （ 单 用途 ） IC卡 支付 系统 和 实现 “ 一卡通 ” 多功能 应用 系统 的 安全 设计 均 有 普遍 参考价值 。 　 　 关键词 　 IC卡 ， 多功能 校园卡 ， 系统安全 ， 密码 DESIGNANDSECURITYOFMULTIPURPOSEICCARDSYSTEMSHeDake 　 LiXiaohang 　 RaoWeiInstituteofComputerSecurityCommSecrecySouthwestJiaotongUniversitySichuanChengdu 　 　 Abstract 　 ThesystemsofcampusICcardofSouthwestJiaotongUniversityandTsinghuaUniversityaretworepresentativecampusICcardsystemsofhighschoolinChinaThedesignofthismultipurposeICcardsystemespeciallyitssecuritydesignmaybegivenareferencetothesecuritydesignofICcardpaymentsystemsinglepurposeandmultipurposeonecardgoingcurrentpracticalICcardsystemforallenterprisesandinstitutions 　 　 Keywords 　 ICcardMultipurposecampusICcardSystemsecurityCryptogram 　 引言 　 　 IC卡 IntergratedCircuitCard 即 集成电路 卡 ， 也 常 被 称为 智能卡 （ SmartCard 。 将 具有 存储 、 口令 检验 或 加密 和 其它 数据处理 能力 的 集成电路 芯片 镶嵌 于 塑料 基片 中 ， 便 成为 通常 见到 的 IC卡 。 按 IC卡 的 结构 ， 即 卡片 中所 嵌 的 集成电路 及 外围 电路 等 的 不同 ， 通常 可 分为 四大 类 ： 　 　 存储器 卡 ： 卡中 IC 大多数 为 标准 的 串行 EEPROM 。 　 　 逻辑 加密 卡 ： 卡中 IC 为 带 保密 逻辑 的 串行 EEPROM 。 　 　 CPU 卡 或 微处理器 卡 ： 在 前条 基础 上 增加 CPU ， 有 的 还 带 专用 的 协处理器 如模 乘法 处理器 。 　 　 非 接触式 IC卡 ： 卡面 无 金属 电 触点 ， 与 外界 的 能量 及 数据交换 通过 调制 电磁波 实现 。 　 　 由于 IC卡 容量 大 、 保密性 好 （ 存储器 卡 除外 ） ， 因而 与 磁卡 等 其它 卡片 相比 有 较大 优势 　 　 良好 的 读写 性能 。 IC卡 是 集成电路 卡 ， 它 无需 往复 机械 动作 即可 完成 多次 人 — 机 — 卡间 的 会 话 过程 ， 使卡 在 应用 时 更易 操作 。 　 　 良好 的 安全性 。 中高档 IC卡 采用 的 逻辑电路 设计 、 集成电路 制造 工艺 和 访问控制 与 密码 技术 ， 使 它 能 有效 阻止 对卡中 数据 的 非 受权 读取 和 篡改 。 　 　 大容量 的 数据 存储 能力 使 IC卡 本身 成为 有效 的 数据 载体 。 　 　 IC卡 的 这些 优势 ， 一方面 降低 了 系统对 网络 的 依赖 程度 并 提高 了 响应速度 ； 另一方面 又 为 发行商 、 应用 系统 管理者 和 持卡人 三 方面 的 利益 提供 了 有效 的 保护 。 所以 不但 “ 三 金 工程 ” 开始 选用 IC卡 其它 一些 IC卡 应用 系统 也 不断涌现 如 超出 食堂 卡 概念 的 校园 IC卡 系统 ， 以致于 “ 一卡通 ” 的 单位 内部 IC卡 应用 系统 。 　 　 为了 便于 讨论 ， 下面 我们 以 校园 IC卡 系统 为 例来 陈述 ， 但 其 设计 原则 和 结论 ， 对 企事业 单位 的 IC卡 支付 系统 的 安全 设计 和 实现 “ 一卡通 ” 应用 系统 的 安全 设计 都 有 普遍意义 。 　 各 校园 IC卡 系统 方案 比较 和 设计 　 校园 IC卡 系统 的 建设 　 　 可以 有 如下 几种 方案 或 途径 ： 　 　 利用 银行 系统 的 IC卡 实现 校内 的 消费 支付 。 　 　 此 方案 的 优点 有 ： 该 IC卡 的 支付 范围 大 ， 系统 建设 统一 、 规范 。 但此 方案 的 缺点 也 不少 。 主要 的 缺点 有 两条 ： 一是 使用 单位 难以 处理 网络系统 突发 故障 ； 二是 卡中 的 敏感数据 使用 单位 难以 有效 利用 ， 所以 很难 建设 包括 门禁 、 考勤 、 医疗 在内 的 “ 一卡通 ” 多功能 应用 系统 。 　 　 利用 逻辑 加密 卡 或 CPU 卡 实现 校内 的 “ 一卡通 ” 多功能 应用 系统 。 　 　 此 方案 的 优缺点 与 前 一 方案 正好 相反 。 比如 ， 它 可以 应付 网络系统 或 局部 供电系统 突发 故障 ， 保证 学生 上机 、 用餐 这 类 时间性 极强 的 活动 的 支付 正常 进行 ； 也 容易 设计 多功能 的 系统 ， 将 门禁 、 考勤 、 考试 、 学籍 、 医疗 、 消费 等 多功能 集于一身 。 　 　 利用 “ 磁条 — — IC 复合 卡 ” 实现 银行 信用卡 、 单位 多功能 卡 的 合一 。 　 　 注意 “ 磁条 — — IC 复合 卡 ” 是 国际标准 容许 的 卡型 。 此 方案 具有 上述 两种 方案 的 优点 ， 而 避免 了 它们 的 缺点 。 但 由于 持卡人 的 资金 需要 在 二 系统 之间 拨付 ， 涉及 银行 事务 ， 所以 对 使用 单位 的 设计者 和 承建 人 的 技术水平 有 极 高 的 要求 ， 也 需要 参与 的 银行 积极 配合 。 　 自主 的 校园 IC卡 应用 系统 设计 要点 　 　 “ 自主 的 校园 IC卡 应用 系统 ” 指上 节中 的 第二种 建设 方案 或 途径 。 以下 我们 总是 限定 在 这种 意义 下来 讨论 ， 并 简称 其为 “ IC卡 系统 ” ， 包括 单 用途 的 就餐卡 和 多功能 的 “ 一卡通 ” 系统 。 根据 我们 的 经验 ， 需要 注意 解决 如下 问题 。 　 　 系统 总体 设计者 的 遴选 　 应当 委托 有 经验 的 专家 与 使用 部门 负责人 一块 进行 ， 也 可移植 改造 兄弟 单位 已经 证明 是 成功 的 系统 。 在 没有 总体设计 的 情况 下 盲目 实施 系统 建设 ， 将会 带来 烦恼 和 隐患 。 　 　 明确 系统 运行 环境 　 最 重要 的 是 对 “ 实时 全 联网 ” 或 “ 可 离线 ” 环境 条件 的 认定 。 对于 单 用途 的 就餐卡 系统 ， 可以 设计 为 “ 实时 全 联网 ” 支付 系统 ； 但是 对于 多功能 的 “ 一卡通 ” 系统 ， 设计 为 “ 实时 全 联网 ” 系统 是 很 不 现实 的 ， 因为 目前 一般 单位 内部 的 网络系统 还 很 难 实现 全年 无故障 运行 。 　 　 明确 子系统 管理者 的 使用 要求 　 特别 是 涉及 安全 的 使用 要求 。 比如 ， 提款 和 高额 购物 支付 要求 持卡人 提供 口令 （ PASSWORD ） ； 而 对于 就餐 时间 十分 集中 的 大学 食堂 ， 这种 要求 通常 是 服务员 和 就餐者 双方 都 无法忍受 的 。 不同 子系统 的 不同 需求 ， 决定 了 系统 的 安全 设计 框架 和 安全 风险 控制策略 。 　 　 系统 防 攻击 的 安全 设计 　 主要 包括 发卡 子系统 的 安全 ， 收费 、 加费 与 结算 子系统 的 安全 、 IC卡 防 篡改 的 安全 。 　 　 系统 防 软硬件 故障 的 安全 设计 　 比如 ， 如何 应付 在 任一 时刻 发生 的 IC卡 物理 损坏 或 停电 ， 如何 保护 集中 的 与 分散 的 底帐 数据 （ 库 ） 。 　 　 实现 “ 交 钥匙 工程 ” 　 这是 此类 系统安全 设计 的 “ 最高 境界 ” ： 系统 要 能 防止 设计者 和 软件 编写者 的 攻击 。 　 校园 IC卡 应用 系统安全 设计 方法 　 　 假设 我们 决定 将 下列 诸多 管理 与 服务 功能 纳入 一个 统一 的 、 基于 IC卡 的 管理 与 服务 系统 ： 计算机 上机 管理 与 付费 图书 借阅 ， 校医院 挂号 及 付费 工资 发放 校内 银行业务 学校 生活 小 区内 的 消费 支付 科研经费 的 管理 ， 复印 支付 校 宾馆 （ 招待所 ） 客人 的 消费 结算 等等 。 　 系统 设计 目标 　 系统 总 目标 　 　 本 系统 总 目标 是 ： 一卡 覆盖 全校 主要 管理 和 消费 应用 ， 并 支持 持卡人 长期 使用 （ 从 本科 到 博士 毕业 留校 任教 ） 。 目前 考虑 的 应用 包括 ： 校内 银行 、 上机 管理 、 教务 学籍 管理 、 图书 借阅 、 校医院 医疗卡 （ 同时 具有 急救 信息卡 功能 ） 、 游泳馆 管理子系统 、 校内 小额 消费 购物 支付 、 科研经费 管理 、 校 宾馆 客人 的 消费 结算 等 。 　 系统 近期 目标 　 　 明确 系统 的 近期 目标 是 必要 的 。 根据 最 紧迫 的 需求 ， 一般 可 对系统 的 近期 目标 作 如下 设计 ： 　 　 上机 管理 ； 校 图书馆 图书 借阅 ； 校医院 就诊 与 付费 。 　 系统安全 设计 　 　 校园 IC卡 系统 或 企业 IC卡 系统 的 安全 设计 是 至关重要 而 又 常常 被 一般 设计者 忽视 的 问题 我们 在 设计 本 系统 之前 曾 分析 了 某些 校园 食堂 IC卡 系统 并 指出 了 其中 存在 的 不少 安全 方面 的 漏洞 和 隐患 。 根据 我们 对本 系统 需求 和 建设 环境 的 分析 确定 了 以下 的 设计 目标 和 技术 措施 。 　 系统安全 设计 目标 　 　 按 子系统 不同 需求 的 分级 安全 保护 如 校内 银行 应用 子系统 按 银行 信用卡 系统 要求 保护 ； 　 　 系统 的 小额 消费 在 联网 与 不 联网 情况 下均 能够 安全 进行 ， 并 能 实时 或 在 事后 实施 安全 的 结算 ； 　 　 最大 限度 地 减小 系统 经营者 和 系统 用户 的 风险 。 　 系统 的 主要 安全 技术 措施 　 　 多级 的 密钥 与 口令 管理 ； 　 　 按 不同 子系统 安全 需求 的 多种 密码保护 　 　 实现 支持 联网 与 不 联网 小额 支付 应用 的 用户 消费 余额 底帐 ； 　 　 利用 小额 消费 限额 控制 风险 的 运行 管理 ； 　 　 用户 卡 的 挂失 与 消费 余额 认定 “ 黑名单 ” 的 发布 与 “ 灰 名单 ” （ 指 可能 被 系统 的 攻击者 操作 过 的 卡片 名单 ） 的 跟踪 。 　 　 下图 描述 了 西南交大 校园卡 ′ 系统 的 总体 功能模块 设计 。 系统 总体 功能模块 图 　 校园 IC卡 应用 系统 的 建设 实施 　 系统 构成 ． ． 　 硬件 构成 　 　 校园 IC卡 存放数据 信息 ， 代码 和 储值 等 。 　 　 通讯 系统 实现 系统 的 信息 传送 可 采用 有线 、 无线 或 磁介质 等 方式 。 　 　 终端 系统 负责 完成 管理员 或 用户 与 系统 的 人机交互 ， 实现 读取 卡中 的 信息 以及 向 卡中 写入 信息 并 输出 相关 信息 和 控制 信号 。 　 　 读 ／ 写卡器 是 IC卡 与 系统 进行 数据交换 的 媒介 。 ． 　 软件 构成 　 　 软件平台 　 　 网络操作系统 　 如 采用 NOVELL 公司 的 NETWARE 。 　 　 汉字系统 　 如 采用 UCDOS 网络版 。 　 　 数据库系统 　 如 采用 VisualFoxPro 。 　 　 应用 系统软件 　 　 本 应用 系统软件 由 两 部分 组成 ： 　 　 a 读卡器 上层 软件系统 　 　 用 BORLANDC 开发 ， 分别 以 DOS 下 的 C 函数 和 Windows 下 的 动态 连接 库 的 形式 透明 的 向 用户 提供 低层 调用 接口 。 通过 对 所 采用 的 IC卡 芯片 的 操作 时序 和 单片机 的 指令 时序 进行 详细 研究 ， 找出 了 其中 的 “ 瓶颈 ” ， 从而 最大 限度 的 利用 IC卡 芯片 特性 和 单片机 的 指令系统 来 提高 读卡器 的 读 ／ 写 速度 ， 使 产品 性能 超过 了 市场 上 大多数 同类产品 。 　 　 b 网络管理 系统软件 　 　 它 由 以下 几个 功能模块 组成 ： 校园 IC卡 发放 系统 、 校园 IC卡 结算 管理系统 、 校园 IC卡 挂失 管理系统 （ 黑名单 库 ） 、 学生 上机 统计 管理系统 、 图书馆 借阅 管理系统 （ 开发 中 ， 照片 及 条码 已 准备就绪 ） 、 校医院 收费 系统 （ 血型 等 部分 健康 数据 已 准备 ） 、 学生 学籍 档案 管理系统 （ 待 开发 ） 、 教师 档案 管理系统 （ 未 开发 ） 、 教职工 工资 管理系统 （ 未 开发 ） 等 。 　 应用 系统 数据编码 原则 　 　 应用 系统 数据编码 是 信息系统 的 一项 重要 基础 工作 ， 也 是 校园 IC卡 系统 正常 运转 的 基本 保证 。 根据 该 系统 的 实际 需求 ， 并 结合 学校 现有 的 代码 规范 ， 我们 制定 出 一套 编码方案 。 本 方案 的 制定 遵循 了 以下 原则 ： 　 　 尽量 采用 国际 、 国家 颁布 的 标准 。 　 　 符合 现行 的 有关 规章 、 规则 ， 满足 应用 部门 需要 。 　 　 数据编码 要 具有 唯一性 ， 以及 可维护性 。 　 　 数据编码 要 能 适应 学校 特点 比如 学生 的 流动性 。 　 数据结构 与 编码方案 　 　 以 ATMEL 公司 的 ATSC 型 IC卡 为例 。 ATSC 型 IC卡 是 具有 KBIT 存储容量 的 保密 逻辑 卡 ， 它 有 四个 主要 应用 数据 区 。 根据 不同 的 应用 需求 ， 我们 为 各区 设计 了 相应 的 数据结构 。 其中 AZ 区为校 银行 应用 区 ， 该区 读写 均 需 口令 ， 故 安全性 最好 ； AZ 区为 上机 收费 及 小额 消费 区 ， 它 是 条件 读写 区 ； AZ 区 是 公开 档案 区 ， 在 通过 了 卡 的 主 口令 检查 认可 之后 是 无条件 可读 的 ； AZ 区 被 用做 经费 注入 的 备份 记录 区 。 　 IC卡 卡面 数据 设计 　 　 自年 入学 新生 开始 西南交大 校园 IC卡 采用 了 新 的 卡面 设计 。 新 IC卡 采用 单面 定制 （ 校园 风景 照 ） 与 单面 个人化 的 形式 ， 后者 的 数据 包括 卡号 、 持卡人 单位 、 姓名 、 血型 、 借书证 条码 （ 码 ） 和 持卡人 免冠 彩色 头像 （ 均 由 专用 打卡机 打印 在 IC卡 上 ） 。 这为 IC卡 在 图书馆 和 校医院 的 使用 奠定 了 坚实 的 基础 。 　 发行 区 数据结构 与 编码 　 　 发行 区 数据 为 字节 ， 具有 唯一 标识 多功能 校园卡 用户 的 功能 。 包括 卡片 分类 代码 和 持卡人 或 单位 、 项目 识别码 。 其中 持卡人 标识码 采用 身份证号 的 压缩 变形 。 　 公开 档案 区 数据结构 与 编码 　 　 以下 描述 了 公开 档案 区 AZ 的 数据结构 （ 自年 西南交大 校园 IC卡 发行 起即 采用 ， 由此 奠定 了 该 系统 的 多功能 特性 ） ： 　 　 RW 控制 字 、 发行 卡号 、 身份证 ID 对于 未成年 无 身份证 者 ， 参照 身份证 号码 编码 原则 编制 代用 身份 号 ， 同时 对 该卡 加以 特殊 标记 、 学 号 ／ 工作证 号 、 姓名 其间 出现 的 生僻 汉字 用 汉语拼音 标注 、 单位 采用 变 长子 字 段 设计 以 节约 存储 ， 加速 检索 、 单位 专业 代码 、 性别 、 民族 、 政治面貌 、 婚否 、 分类 码 、 入学 工作 、 借书证 号 图书馆 条码 、 照片 存储 地址 、 现 住址 、 家庭 所在地 、 乘车 区间 、 籍贯 、 学生 类型 、 血型 身高体重 、 危急 症 过敏症 、 医疗 证号 、 游泳 证号 及 体检 记录 、 日 消费 限额 、 AZ 用户 进入 口令 密文 形式 、 AZ 加密算法 与 参数 密文 形式 、 发卡 时间 、 更新 时间 、 发卡 或 更新 操作员 代码 、 本区 校验 算法 参数 密文 形式 、 本区 校验码 、 特殊 标记 对 未办理 身份证 者 加以 标记 并 特殊 处理 　 相关 读写 设备 的 选型 或 研制 　 　 根据 我们 的 经验 ， IC卡 读写 设备 的 质量 和 可靠性 是 系统 成败 的 关键因素 之一 。 西南交大 校园 IC卡 系统 就 曾 淘汰 了 一批 市售 的 IC卡 读写器 。 自 年底 起 ， 西南交大 校园 IC卡 系统 全部 改用 西南交大 计算机 安全 与 通信 保密 研究所 （ CSCSI ） 自行 研制 的 CSCSI 型 读 写卡器 。 该 系列 读 写卡器 能够 对 ATMEL 公司 的 同步 型 IC卡 ATSC 系列 和 ATxx 系列 存储器 卡 、 SIEMENS 公司 的 SLE 等 IC卡 进行 读写操作 。 　 　 在 PC机 上 对 CSCSI — 型 读卡器 进行 性能指标 测试 ， 试验 所用 的 PC机 配置 为 OOMHz ， ISA 总线 ， M 内存 。 测试 对象 是 ATSC 卡 从 字节 开始 的 个 字节 。 测试 按 PC 串口 通信 波特率 分为 两组 ， 一组 的 波特率 为 ， 另一组 的 波特率 为 。 每组 又 分为 两种 情况 ， 一种 “ 写 ” 是 指 将 这个 字节 的 内容 由全 FF 写成 全 ， 另 一种 “ 写 ” 是 将 这个 字节 的 内容 由全 FF 写成 F 。 实验所 得 数据 如表 所示 （ 单位 ： 毫秒 ） 。 　 　 高校 计算机 上机 管理 收费 IC卡 系统 的 一个 关键 技术指标 是 每 一 用户 卡 的 平均 处理 时间 。 有时 此项 指标 甚至 是 应用 系统 成败 的 关键 。 据 我们 所知 CSCSI — 型 读卡器 的 读写 速度 高于 若干 市售 的 同类产品 。 使用 CSCSI — 型 读卡器 上机 管理 收费 IC卡 系统 的 用户 卡 平均 处理 时间 可 做到 两秒 左右 。 表 　 CSCSI — 型 读卡器 读写 速度 Baud “ 写 ” 内容 读写 擦擦 写 擦写 读 FF → 　 FF → FFF → 　 FF → F 　 结束语 　 　 校园 IC卡 系统 是 第一 作者 多年 的 梦想 曾 反映 在 年 与 王育民 合著 的 《 保密 学 — 基础 与 应用 》 一书 的 封面设计 中 。 经过 三年 的 实践 ， 我校 完成 了 全国 首批 多功能 校园卡 之一 — — 西南交大 校园卡 ′ 系统 的 第一阶段 建设 ， 个别 子系统 还 通过 了 省教委 的 正式 鉴定 。 通过 实践 我们 认识 到 多功能 校园 IC卡 系统 是 一个 需要 长期 建设 、 经营 不断完善 其 功能 与 性能 的 应用 系统 。 本文 着重 介绍 该 IC卡 应用 系统 设计 与 实施 过程 中 的 一些 心得体会 ， 包括 系统 安全性 的 设计 与 技术 措施 ， 以供 有 兴趣 的 兄弟 院校 和 企事业 参考 。 作者简介 ： 何大 可 　 教授 。 主要 从事 计算机 与 移动 通信安全 、 商用 密码 和 并行计算 研究 。 李晓航 　 硕士 。 主要 从事 密码学 、 IC卡 应用 研究 、 计算机软件 开发 工作 。 饶伟 　 硕士 。 主要 从事 IC卡 及 计算机 软 、 硬件 开发 。 作者 单位 ： 西南 交通 大学 计算机 安全 与 通信 保密 研究所 　 四川 成都 （ 参考文献 ［ ］ 　 王育民 ， 何大 可 保密 学 — — 基础 与 应用 西安 ： 西安电子科技大学 出版社 ， ［ ］ 　 何大 可 等 多功能 校园卡 — — IC卡 应用 系统 实例 密码学 进展 — — CHINACRYPT ′ 北京 ： 科学出版社 ， 收稿 日期 修改稿