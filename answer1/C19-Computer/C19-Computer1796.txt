软件 学报 JOURNALOFSOFTWARE 年 　 第卷 　 第期 　 Vol 　 No 　 复合 三角 Bzier 曲面 求交 和 裁剪 的 实现 李际军 　 柯映 林程耀东 　 　 摘要 　 该文 利用 三角 Bzier 曲面 片 的 可 分割 性 解决 了 迭代 收敛 、 初始 交点 计算 等 问题 通过 近 曲面 点 、 边界点 跨越 等 过程 实现 了 由 一个 初始 交点 将 跨越 许多 曲面 片 的 整条 交线 跟踪 出来 的 设想 将 各 交点 作为 型 值点 插入 曲面 中 对 三角 网格 进行 三角 再 划分 以交线 为界 进行 三角 网格 和 型 值点 的 分离 最后 重新 生成 两张 复合 曲面 实现 了 裁剪 的 目的 测试 结果显示 此 方法 简单 、 可靠 能够 满足 曲面 造型 的 要求 　 　 关键词 　 复合 三角 Bzier 曲面 三角 Bzier 曲面 片 三角 网格 跟踪 　 　 中图法 分类号 　 TPProcedureofIntersectionandTrimmingforCompositeTriangularBzierSurfaceLIJijunKEYinglinCHENGYaodongDepartmentofMechanicalEngineeringZhejiangUniversityHangzhou 　 　 Abstract 　 UsingthesplittingpropertyoftringularBzierpatchtheproblemsofiteratingandinitialintersectionpointcalculatingcanbesolvedBytheproceduresofnearsurfacepointiteratingandborderpointstraversingthewholeintersectioncurvetraversingmanypatchescanbetracedfromoneinitialintersectionpointInsertingintersectionpointsasmeasurepointsintosurfaceretriangulatinggridssplittingtriangulargridsandmeasurepointsalongintersectioncurvetheoriginalsurfacecanbetrimmedintotwocompositetriangularBziersurfacesTheexperimentalresultsshowthatthismethodissimplerobustandapplicableforsurfacemodeling 　 　 Keywords 　 CompositetriangularBziersurfacetriangularBzierpatchtriangulargridmarching 　 　 随着 自由 曲面 在 几何 造型 、 CADCAM 等 领域 中 的 广泛应用 针对 自由 曲面 的 几何 处理 如 曲面 求交 、 曲面 裁剪 等 成为 计算 几何 中 的 热门 研究课题 并 作为 完成 复杂 产品 造型 及 产生 数控 加工 数据 的 基本 手段 和 衡量 曲面 造型 系统 设计 能力 的 主要 指标 而 倍受 重视 其中 作为 曲面 裁剪 、 曲面 过渡 等 基础 的 曲面 求交是 最 基本 和 最 重要 的 问题 之一 　 　 Farin ［ ］ 对 三角 Bzier 曲面 片 做 过 详细 的 研究 给出 了 构造 C ′ 连续 的 复合 三角 Bzier 曲面 的 条件 Choi ［ ］ 系统地 介绍 了 由 离散 型 值点 建立 G ′ 连续 的 复合 三角 Bzier 曲面 的 过程 柯映 林 ［ ］ 在 其 博士论文 中 提出 了 一种 准 C ′ 连续 的 复合 三角 B é zier 曲面插值 模型 这些 方法 都 成功 地 解决 了 离散 型值 点 的 三角 Bzier 曲面插值 问题 通过 上述 方法 建立 的 复合 Bzier 曲面 有 一个 共同 的 特点 每张 三角 Bzier 曲面 片有 一个 三角 域 相对 应 整张 曲面 却 没有 相对 应 的 参数 域 如何 对 没有 单一 相对 应 参数 域的复合 三角 Bzier 曲面 进行 求交是 我们 在 本文 中要 解决 的 问题 在 此 我们 吸收 矩形 域 曲面 求交 的 经验 充分利用 和 考虑 到 复合 三角 Bzier 曲面 的 特点 提出 了 一种 有效 的 解决 方法 由于 跟踪 法 ［ ］ 的 优点 就是 已知 一个 交点 通过 沿 跟踪 方向 前进 一个 步长 求下 一个 交点 从而 跟踪 出 整条 交线 那么 如何 求出 每条 交线 上 的 一个 初始 交点 就 成为 求交 的 关键 在 此 我们 利用 三角 Bzier 曲面 片 的 分割 原理 和 迭代 求精 的 方法 较 好地解决 了 这个 问题 通过 引进 求近 曲面 点 和 边界点 的 概念 成功 地 完成 了 交线 由 一个 曲面 片到 另 一个 曲面 片 的 跨越 和 继续 跟踪 的 过程 这种 方法 不仅 可以 解决 两张 复合 三角 Bzier 曲面 有 一条 交线 的 问题 也 能够 解决 交线 环 和 多个 交线 分支 的 情况 　 　 在 工程 中 许多 产品 的 外 表面 不能 或 不 便于 用 完整 的 曲面 来 表示 用多张 曲面 拼接 又 满足 不了 造型 上 的 要求 或 过于 困难 因此 往往 采用 曲面 裁剪 的 处理 方法 得到 所 需要 的 曲面 在 曲面 裁剪 过程 中先 将 整张 曲面 在 参数 域 ［ ］ ［ ］ 内 映射 然后 在 形成 的 曲面 裁剪 参数 域 上 重组 曲面 的 拓扑 关系 建立 裁剪 曲面 的 内环 和 外环 ［ ］ 其中 建立 曲面 参数 域 与 裁剪 参数 域间 的 映射 是 曲面 裁剪 算法 的 关键 这是 具有 单一 的 相对 应 参数 域 曲面 的 一般 裁剪 方法 但是 对于 无 对应 参数 域的复合 三角 Bzier 曲面 而言 无法 建立 这种 映射 关系 自然 也 就 无法 采用 这种 裁剪 方法 我们 针对 这一 特点 通过 将 交点 作为 型 值点 插入 到 曲面 的 型 值点 集中 由 交点 的 数据结构 找到 该 交点 所在 的 三角 网格 ［ ］ 将 该 三角 网格 重新 三角 化 并 以交线 为界 进行 型值 点 和 三角 网格 的 分离 重新 建立 拓扑 信息 形成 与 原 曲面 结构 相一致 的 曲面 较 好地解决 了 上面 提到 的 问题 复合 三角 Bzier 曲面 的 跟踪 求交 三角 Bzier 曲面 片 的 分割 原理 　 　 设 Pii 是 Δ TTT 内 的 个 点 Pi 关于 Δ TTT 的 面积 坐标 为 uiviwii 设想 Δ TTT 上 已有 一张 三角 Bzier 曲面 片 以图 所示 的 三次 三角 Bzier 曲面 片为例 但 我们 仅 对 Δ PPP 上 的 部分 有 兴趣 并 希望 它 表示 为 Δ PPP 上 的 三角 Bzier 曲面 片 如图所示 图 三角 Bzier 曲面 片图 三角 Bzier 曲面 片 分割 示例 　 　 设 P ∈ Δ TTT 且 P ∈ Δ PPPP 关于 Δ TTT 的 面积 坐标 为 uvw 关于 Δ PPP 的 面积 坐标 为 则 上式 即 为 以 “ 老 ” 用 “ 新 ” 表示 的 同 一点 的 坐标 变换 式 这样 我们 有 其中 新 的 控制顶点 ijkijkn 的 计算 式 为 ijkuEvEwEiuEvEwEjuEvEwEkf 近 曲面 点 的 计算 　 　 这里 介绍 计算 空间 一点 到 三角 Bzier 曲面 片 Ruv 的 最近 点 称为 近 曲面 点 的 方法 ［ ］ 设 空间 一点 为 G 为了 采用 迭代 方法 计算 曲面 片上 距 G 最近 的 点 Ruv 假定 已有 一个 初始 点 如图所示 图近 曲面 点 的 计算 为了 使 e 的 模 最小 将 其 Taylor 展开 令 我们 有 　 　 迭代 过程 如下 　 　 输入 空间 点 G 和 曲面 片 的 初始 点 　 　 计算 的 偏微分 RuRv 和 dG 　 　 由 上式 计算 　 　 若 为 极小量 返回 否则 转 通过 迭代 一般 ～ 次 即可 计算 出 精确 的 参数值 u 和 v 初始 交点 的 迭代 求精 ［ ］ 　 　 针对 我们 所 研究 的 复合 三角 Bzier 曲面 求交 问题 我们 需要 计算 出 每 两张 曲面 片 的 一个 交点 作为 初始 交点 原因 在 下面 分析 可 采用 这样 的 方法 进行 根据 每张 曲面 片 的 控制顶点 如图所示 建立 最大 最小 包围 盒 通过 包围 盒 判断 两张 曲面 片 是否 可能 相交 称 这 两张 曲面 片为 一个 曲面 对 若 相交 则 进行 迭代 计算 精确 的 初始 交点 若能 求出 一个 满意 的 交点 记录 它 并 停止 否则 对 每张 曲面 片 进行 分割 形成 新 的 曲面 对 把 对应 的 各子 曲面 片 的 平均 参数值 作为 近似 参数值 对应 曲面 上 的 两点 的 中点 作为 近似 交点 坐标 在 原 曲面 片上 进行 迭代 用 这种 方法 进行 计算 要么 判断 出 两张 曲面 片 不 相交 要么 能够 计算 出 一个 交点 要么 在 分割 达到 控制精度 时 仍 无法 求 出 交点 在 第种 情况 下 我们 记录 一个 最有 可能 的 曲面 对 作为 最终 的 近似 交点 这个 交点 不能 作为 跟踪 的 起始 点仅 可用 来供 其他 交点 判断 该 曲面 对 是否是 交线 的 继续 　 　 初始 交点 的 求 精 实际上 就是 将 该点 迭代 至 真正 的 交线 上 这里 所 介绍 的 方法 既 用于 初始 交点 的 求出 过程 也 用于 跟踪 过程 如图所示 设 两个 曲面 为 RuvSst 初始 近似 交点 为 MM 在 RS 上 的 两个 近 曲面 点为 PQPQ 处 的 切 平面 分别 为 FRFS 过 PQ 的 中点作 垂直于 FRFS 的 辅助 平面 这个 平面 交于 G 通过 G 计算 近 曲面 点 如果 两个 近 曲面 点 位于 给定 的 误差 精度 内则 认为 二者 是 一个点 即 交点 近 曲面 点 的 参数值 即 为 交点 的 参数值 否则 以 G 替代 M 重复 上面 的 过程 图 初始 交点 的 求 精 　 　 我们 的 目的 是 求出 一个 初始 交点 这个 交点 必须 满足 控制精度 并且 ≤ uvuv ≤ 这 是因为 我们 研究 的 是 有界 曲面 片 所求 的 交点 不可 超出 参数值 范围 采用 上面 的 方法 求 交点 有 可能 遇到 切 平面 彼此 平行 的 情况 更 多 的 是 求出 的 交点 参数值 小于 或 大于 这些 问题 的 出现 是 由于 初始 点 的 选取 不当 而 造成 的 利用 三角 Bzier 曲面 片 的 分割 就 可以 解决 这个 问题 边界点 的 计算 　 　 边界点 的 计算 有 如下 的 应用 首先 如果 跟踪 的 交点 位于 曲面 片 的 界外 利用 边界点 的 计算 将 该点 迭代 至 边界 上 即求 出 边界点 而 不是 通过 改变 跟踪 步长 的 方法 近似计算 边界点 其次 利用 边界点 和 前面 介绍 的 求取 近 曲面 点 的 方法 求 出 相邻 的 曲面 片 从而 顺序 跟踪 出 整条 交线 假设 交点 为 RuvSst 为了 计算 边界 上 的 点令 RuvSst 的 模 最小 并且 利用 Taylor 展开 我们 可以 得到 如下 的 方程 当 ‖ RuvSst ‖ ＜ ε ε 为 极小值 时 停止 迭代 应用 以上 式 可 分别 迭代 计算 出 位于 uvw 边界 上 的 点 跟踪 过程 　 　 我们 研究 的 是 复合 三角 Bzier 曲面 一般 地 每条 交线 将 穿越 许多 曲面 片 由于 引进 边界点 和 近 曲面 点 的 计算方法 所以 在 交线 的 每 一个 独立 分支 上 必须 有 一个 交点 作为 初始 点 否则 该 分支 在 后继 步骤 中将 被 遗漏 离散 点 的 特点 就是 杂乱无章 如果 适当 地 控制 三角 Bzier 曲面 片 的 分割 控制精度 则 基本上 可以 保证 至少 可以 求出 每条 交线 上 的 一个 交点 另外 也 可以 通过 补加 测点 来 加以改进 我们 的 这种 算法 可以 保证 某交 线段 上 只要 有 一个 初始 交点 就 可以 跟踪 出 整条 交线 所以 假设 每 两张 曲面 片 只 计算 一个 交点 是 可行 的 一般 地 将 交点 在 两张 曲面 片上 的 法 矢量 的 叉积 作为 跟踪 的 方向 ［ ］ 其中 c 为 跟踪 方向 矢量 FRFS 为 交点 处 的 曲面 片 的 法 矢量 至于 跟踪 步长 的 选择 已有 许多 文献 论述 过 ［ ］ 　 　 我们 将 所有 求出 的 每 两张 曲面 片间 的 交点 组成 一个 初始 交点 链表 开始 跟踪 　 　 从 初始 交点 链表 中 取出 一个 交点 　 　 标志 该 交点 status 即 表示 已经 跟踪 处理 过 　 　 按照 一个 方向 前进 一个 步长 用 交点 的 迭代 求精 方法 将 其 迭代 至交 线上 　 　 判断 是否 超出 边界 若 没有 超出 转 否则 继续 　 　 利用 边界点 的 计算方法 计算 边界点 并且 记录 第个 边界点 　 　 在 所有 的 交点 中 利用 边界点 和 求近 曲面 点 的 方法 计算 出 下 一个 相邻 的 曲面 对 及其 上 的 一个 交点 标志 相邻 的 交点 status 如果 非 第个 边界点 与 第个 边界点 重合 可 判断 形成 交线 环对 记录 的 交点 进行 处理 如 为了 裁剪 的 便利 将 第个 边界 交点 前 的 交点 删去 保证 无 重复 点若 到达 曲面 的 边界 则 反向 跟踪 否则 转 继续 　 　 直至 将 所有 的 交点 用尽 为止 记录 所有 的 交线 构造 基于 复合 三角 Bzier 曲面 的 裁剪 曲面 基于 交线 的 曲面 可 裁剪 的 条件 　 　 随着 汽车 、 造船 和 模具 等 工业 的 发展 为了 构造 复杂 的 自由 曲面 通常 需要 对 自由 曲面 进行 裁剪 以 提高 系统 的 造型 能力 但 并 不是 任意 相交 的 两张 曲面 均 可以 裁剪 我们 知道 任何 一张 曲面 都 是 由 一条 外 边界 环 和 几条 内 边界 环所 围成 的 交线 在 裁剪 后 将 作为 裁剪 曲面 的 外 边界 或 内 边界 而 存在 所以 关于 交线 的 曲面 可 裁剪 的 条件 可定义 如下 　 　 某交线 为 环时 　 　 某交线 的 两个 端点 落 在 复合 曲面 的 外 边界 上 　 　 某交线 的 两个 端点 落 在 复合 曲面 的 某 一条 内 边界 环上 　 　 某 两条 交线 的 两个 端点 分别 位于 外 边界 和 同一 内 边界 上 　 　 某 两条 交线 的 端点 分别 位于 两个 内 边界 上 　 　 多条 交线 的 端点 顺序 位于 外 边界 、 几个 内 边界 和 外 边界 上 　 　 针对 我们 研究 的 复合 三角 Bzier 曲面 而言 由于 曲面 的 外 边界 是 逆时针 方向 定义 的 而 内 边界 是 顺时针 方向 定义 的 这样 无论 对于 何种 边界 当交线 的 端点 位于 某 三角 Bzier 曲面 片 的 边上 时该 边 的 右 相邻 三角 Bzier 曲面 片为 空 如果 交线 的 端点 刚好 是 某 三角 Bzier 曲面 片 的 角点 可 通过 查阅 与 该 角点 相关 的 边 中 是否 有 一条 边 的 右 相邻 三角 Bzier 曲面 片为 空来 确定 是否 为 复合 曲面 的 边界 这种 方法 很快 就 可以 辨别 出交 线段 的 可 裁剪 性 由于 边界 情况 不 一 我们 采用 人工 交互 的 方式 选取 可 裁剪 的 交 线段 来 进行 曲面 的 裁剪 处理 交点 的 插入 和 三角 网格 的 局域 三角 化 　 　 当 某条 或 几条 交 线段 符合 裁剪 条件 时 需要 将 交点 作为 型 值点 插入 到 型 值点 集中 由于 是 在 三维空间 中 进行 的 且 交点 是 顺序排列 的 这 为 三角 网格 的 局域 三角 化作 好 了 准备 　 　 对 每 一个 交点 判断 是否 为 三角 Bzier 曲面 片上 的 角点 若 是 则 找到 该角点 否则 将 该 交点 作为 一个 新 的 型 值点 加入 到 曲面 的 型 值点 集中 　 　 根据 交点 所在 的 三角 Bzier 曲面 片 由 曲面 的 拓扑 信息 找到 该 交点 所在 的 三角 网格 在 该 网格 中 记录 该 交点 　 　 对 有型 值点 插入 的 三角 网格 为了 维护 原有 三角 Bzier 曲面 片 的 拓扑 关系 采用 如下 的 三角 化 原则 　 　 由 三角 网格 的 角点 和 交点 中 的 边界点 构成 边界 链表 其他 交点 构成 内部 点 链表 　 　 利用 文献 ［ ］ 中 介绍 的 三角 划分 方法 进行 三角 化 　 　 当 插入 的 点 在 一条 边上 穿进 穿 出时 如图 a 所示 三角 化 　 　 当 插入 的 点 穿越 两条 边时 如图 b 所示 三角 化 　 　 当穿 进穿 出边 的 次数 多于 时如图 c 所示 三角 化图 三角 化 情况 　 　 在 三角 化 的 同时 以交线 为界 标示出 新 生成 的 三角 网格 如 Vii 为 新 加入 的 点 在 三角 化时 将 ViVi 左侧 的 三角 网格 标示 为 mnSide 将 ViVi 右侧 的 三角 网格 标示 为 mnSide 而 不 参与 三角 化 的 三角 网格 初始化 为 mnSide 我们 总 的 要求 是 三角 化后 的 三角 网格 不得 有 覆盖 的 现象 在 程序实现 的 过程 中 还有 其他 情况 各种 三角 化 的 方法 在 此 均 可以 应用 裁剪 曲面 的 生成 　 　 三角 化 完成 后 我们 就 可以 将 所有 的 三角 网格 以交 线段 为界 进行 分离 　 　 TrimSeperate 三角 网格 　 　 　 　 ifmnSideor 　 　 　 　 　 if 相关 三角 网格 mnSide 　 　 　 　 　 　 相关 三角 网格 mnSideor 　 　 　 　 　 　 TrimSeperate 相关 三角 网格 　 　 　 　 　 　 这里 所 讲 的 相关 三角 网格 是 指 与 条边 相邻 的 三角 网格 该 递归函数 是从 三角 网格 集中 最后 一个 元素 开始 的 这样 就 可以 将 所有 的 三角 网格 分为 两组 mnSide 的 一组 和 mnSide 的 一组 然后 将 原 复合 曲面 的 型 值点 进行 分离 加入 到 相应 的 每 一组 三角 网格 中 并 重新 编号 　 　 for 原 复合 三角 Bzier 曲面 的 每 一个 型 值点 　 　 　 　 for 每 一组 三角 网格 中 的 每 一个 三角 网格 　 　 　 　 if 三角 网格 的 角点型 值点 　 　 　 　 　 　 将 该 型 值点 加入 到 新 的 曲面 型 值点 集中 　 　 　 　 　 　 修正 该 三角 网格 的 角点 编号 　 　 　 　 　 　 最后 对 两组 三角 网格 重建 拓扑 关系 构造 各自 的 复合 三角 Bzier 曲面 其中 在 按照 文献 ［ ］ 方法 构造 复合 三角 Bzier 曲面 时 各型 值点 的 法 矢量 由原 曲面 继承 得到 而 不再 进行 估算 从而 保证 了 裁剪 曲面 的 良好 形态 至此 一张 复合 三角 Bzier 曲面 被 裁剪 为 两张 复合 三角 Bzier 曲面 示例 及 讨论 　 　 图是 针对 复杂 的 、 插值 于 由 工程 实际 测量 的 散乱 点 得到 的 复合 三角 Bzier 曲面 通过 采用 上述 方法 进行 求交 、 裁剪 的 例子 图 a 是 某 汽车 立柱 被 另 一张 类似 曲面 所 裁开 图 b 是 电风扇 叶片 被 一 圆柱 所裁 的 结果 图 c 是 鞋楦 的 裁剪 曲面 图 d 是 某 通气管 的 裁剪 曲面 虽然 任意 两张 曲面 片间 有 一条 交线 的 假设 有 可能 导致 交 线段 的 丢失 但 我们 的 跟踪 方法 可以 保证 只要 知道 某交 线段 上 的 一个 交点 不管 该 交点 位于 哪个 曲面 对 上 就 可以 将 整条 交线 完整 地 计算出来 尽管 三角 化在 边界 上 有 一定 的 误差 但 只要 精度 控制 合理 在 工程 上 完全 能 满足要求 abcd 图 曲面 剪裁 的 例子 基金项目 ： 本文 研究 得到 国家教育部 博士点 专项基金 和 曹光彪 科学基金 资助 作者简介 ： 李际军 年生 博士生 主要 研究 领域 为 CADCAM 计算机 图形学 反求 工程 曲面 造型 　 　 　 　 　 柯映 林年生 博士后 教授 ， 博士生 导师 主要 研究 领域 为 产品 快速 设计 与 制造 CADCAM 工程 数据 可视化 快速 原型 技术 及其 在 医学 中 的 应用 　 　 　 　 　 程耀东 年生 教授 博士生 导师 主要 研究 领域 为 CIMSCADCAM 先进 制造 技术 机械振动 及 结构 动力学 信号处理 作者 单位 ： 浙江大学 机械 工程学系 　 杭州 　 本文 通讯联系 人 李际军 ， 杭州 浙江大学 机械 工程学系 参考文献 　 FarinGCurvesandSurfacesforComputerAidedGeometricDesignrdSanDiegoAcademicPress 　 ChoiBKSurfaceModelingforCADCAMNewYorkElsevierSciencePublishers 　 柯映 林 离散 数据 的 几何 造型 技术 及其 应用 研究 ［ 博士学位 论文 ］ 南京航空航天大学 KeYinglinGeometricmodelingforthreedimensionalscattereddataanditsapplicationstudies ［ PhDThesis ］ NanjingUniversityofAeronauticsandAstronautics 　 BarnhillREKerseySNAmarchingmethodforparametricsurfacesurfaceintersectionComputerAidedGeometricDesign ～ 　 StoyanovTzEMarchingalongsurfacesurfaceintersectioncurveswithanadaptivesteplengthComputerAidedGeometricDesign ～ 　 ShengXHirschBETriangulationoftrimmedsurfacesinparametricspaceComputerAidedDesign ～ 　 PieglLesATillerWayneGeometrybasedtriangulationoftrimmedNURBSsurfacesComputerAidedDesign ～ 　 MullenheimGConvergenceofasurfacesurfaceintersectionalgorithmComputerAidedGeometricDesign ～ 　 MullenheimGOndeterminingstartpointsforasurfacesurfaceintersectionalgorithmComputerAidedGeometricDesign ～ 　 宁涛 马 德昌 王 亚平 等 平面 向量场 与 曲率 分析 在 曲面 求交中 的 应用 计算机 学报 ～ NingTaoMaDechangWangYapingetalApplicationofplanevectorfieldandcurvatureanalysisinsurfaceintersectionChineseJournalofComputers ～ 本文 收到 原稿 收到 修改稿