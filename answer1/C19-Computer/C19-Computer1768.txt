软件 学报 JOURNALOFSOFTWARE 年 第期 第卷 VolNo 自动 寻找 使 多重 串行 循环 并行 化 的 幺 模 变换 俞一峻 臧斌 宇施 武朱 传琪 摘要 　 对于 已知 n 维 距离 向量 矩阵 的 多重 串行 循环 过去 的 并行 化 编译 研究 还 缺乏 寻找 使 循环 外层 并行 化 的 幺 模 矩阵 的 可行 算法 文章 介绍 了 多重 串行 循环 并行 化 的 幺 模 变换 方法 不仅 从 理论 上 证明 满足 外层 并行 化 要求 的 合法 幺 模 矩阵 是 存在 的 而且 通过 构造性 证明 给出 一个 计算 外层 并行 化幺模 变换 矩阵 的 可行 算法 并 探讨 了 扩大 其 适用范围 于 非 完全 嵌套 和 非常 数 相关 距离 循环 的 有效途径 关键词 　 相关性 分析 自动 并行 化 变换 循环 幺 模 变换 中图法 分类号 　 TPAutomaticallyComputingUnimodularTransformingMatrixtoParallelizeNestedSequentialLoopsYUYijunZANGBinyuSHIWuZHUChuanqiInstituteofParallelProcessingFudanUniversityShanghaiAbstract 　 LackinganeffectiveandfeasiblealgorithmtocomputethevalidunimodularmatrixforparallelizingoftheouterloopspreviousparallelizingresearchescannotautomaticallyrevealtheparallelisminsuchsequentialnestedloopsashavendimensiondistancematrixInthispapertheauthorsdiscussageneralouterloopparallelizingmethodbyvalidunimodulartransformationsprovetheexistenceofsuchavalidunimodulartransformationandsuggestseveralpracticalcomputingalgorithmsthroughtheconstructiveproofsThisdiscoveredunimodulartransformationcanhavethemaximalnumberofparallelizableouterloopstransformedThustheapplicationscopeofthealgorithmscanbeenlargedtononperfectornonconstantdependencedistanceloopsKeywords 　 Dependencetestautomaticparallelizingtransformationunimodulartransformation 　 　 并行 化 编译 是 串行 程序 并行 化 的 有效 工具 它 结合 相关性 分析 发现 串行 程序 中有 并行性 的 程序段 并 施以 合法 的 并行 化 变换 从而 能 使 此 程序段 并行执行 ［ ］ 因此 有效 的 相关性 分析 ［ ］ 和 自动 并行 化 变换 方法 ［ ］ 是 并行 化 编译 成功 的 关键 串行 程序 的 循环 具有 很大 的 并行性 因此 循环 并行 化 变换 自然 成为 并行 化 变换 研究 的 重点 　 　 幺 模 unimodular 变换 是 一类 范围 很广 的 循环 变换 它 等价 于 对 循环 迭代 空间 乘以 一个 行列式 为 ± 的 整数 方块 矩阵 （ 幺 模 矩阵 ） 的 非 奇异 线性变换 人们 通常 为了 发掘 程序 中 的 并行性 而 研究 的 一些 基本 循环 变换 斜错 skewing 、 交换 interchanging 、 反序 reversal 等 都 是 它 的 特例 幺 模 变换 具有 保持 整数 循环 迭代 空间 体积 和 维数 不变 的 性质 不仅如此 步长 为 的 规范 循环 在 幺 模 变换 后 仍 是 规范 循环 变换 后 程序 书写 格式 仍 较为 规整 由于 这些 适合 循环 变换 的 良好 性质 幺 模 变换 又 成为 循环 并行 化 变换 研究 的 重点 ［ ～ ］ 　 　 但 并 不是 任意 幺 模 变换 都 能 在 保证 变换 正确性 的 同时 而 使 循环 并行 化 因此 使用 幺 模 变换 进行 循环 自动 并行 化 的 困难 在于 如何 对 给定 多重 串行 循环 自动 找出 使 循环 并行 化 的 恰当 的 幺 模 变换 矩阵 现有 的 大多数 自动 并行 化 编译器 没有 实现 一般 的 自动 并行 化幺模 变换 就是 因为 无法 对 多重 循环 自动 计算 能 使 之 并行 化 的 幺 模 变换 矩阵 ［ ］ 而 利用 交互 并行程序 设计 环境 ［ ］ 提供 的 循环 迭代 空间 相关 图 可视化 工具 ［ ］ 对 循环 程序 的 分析 经验 表明 即使 由人来 寻找 恰好 能 对 循环 并行 化 的 幺 模 变换 矩阵 也 是 很 困难 的 本文 研究 的 算法 目标 就是 对 给定 多重 串行 循环 自动 找出 使 循环 并行 化 的 恰当 的 幺 模 变换 矩阵 　 　 对 简单 的 二重 循环 UBanerjee 用 算法 说明 了 如何 根据 源 循环 中 的 跨 循环 常数 相关 距离 寻找 合法 的 外层 或 内层 并行 化幺模 变换 ［ ］ 他 的 对 二重 循环 的 内层 并行 化 方法 可以 扩充 至 多重 循环 内层 并行 化 但 他 的 对 二重 循环 的 外层 并行 化 方法 无法 直接 处理 多重 循环 外层 并行 化 的 情况 本文 提出 了 一种 确定 使 多重 串行 循环 外层 并行 化 的 幺 模 变换 矩阵 的 算法 解决 了 相关 距离 已知 时 多重 嵌套循环 并行 化 的 问题 　 　 另外 当 多重 循环 的 常数 距离 矩阵 满 秩时 DHollander 的 迭代 划分 和 求 代表 迭代 点 的 方法 能够 增加 一个 额外 的 外层 并行 循环 压缩 内层 串行 循环 的 相关 迭代 链 进一步 发掘 外层 并行 化 循环 迭代 ［ ］ Xue 提出 了 对 非 完全 嵌套循环 变换 为 多个 完全 嵌套循环 迭代 空间 分别 进行 幺 模 变换 的 方法 ［ ］ 本文 的 外层 循环 幺 模 并行 化 方法 可以 同 这 两种 方法 结合 在 一起 　 　 本文 第节 介绍 这个 一般 的 幺 模 矩阵 并行 化 变换 方法 并 证明 合法 的 幺 模 变换 矩阵 对 所有 已知 常数 相关 距离 的 多重 循环 都 是 存在 的 这个 证明 过程 完全 是 构造 的 因而 不难 得出 计算 合法 幺 模 矩阵 的 算法 最后 以 一个 完整 的 多重 循环 实例 说明 并行 化幺模 变换 算法 寻找 循环 并行 化幺模 矩阵 　 　 随着 迭代 空间 的 变换 循环 的 跨 循环 相关 距离 向量 也 一起 变换 因而 有些 循环 变换 可 使 目标 循环 并行 化对 相关 距离 向量 已知 的 循环 寻找 合法 的 并行 化 变换 一般 有 两种 方法 侧重于 使 内层 循环 并行 的 wavefront 方法 和 侧重于 使 最 外层 循环 并行 的 partition 方法 Banerjee 的 方法 ［ ］ 对 循环 外层 并行 化 的 幺 模 矩阵 计算方法 仅仅 适用 于 二重 循环 对 n ＞ 重 循环 并 不 适用 DHollander 的 方法 ［ ］ 直接 用于 n 重 循环 会 产生 超过 n 层 的 循环 且 不能 发掘 所有 的 外层 并行性 本文 探讨 的 n 重 循环 幺 模 并行 化 算法 是 一个 发掘 最多 可 并行 外层 循环 的 幺 模 变换 使得 nrankD 个 外层 循环 一定 能够 并行 化 而且 rankD 个 内层 循环 也 能 并行 化 下面 重点 论证 在 n 维 迭代 空间 中 只要 所有 m 个 相关 距离 向量 都 是 常数 　 　 如果 给定 n × m 的 相关 距离 矩阵 D 的 秩 rankD ＜ n 就 可以 找到 一个 合法 的 行 变换 幺 模 矩阵 U 使得 UD ［ ｜ D ′ T ］ TD ′ 是 rankD × m 的 合法 相关 距离 矩阵 且 为 行满 秩 　 　 如果 D ′ 为行 满 秩 矩阵 可以 找出 一个 幺 模 变换 U ′ 使得 除了 最外重 循环 外 所有 内层 循环 可 并行 化 　 　 如果 D 为 满 秩 可逆 矩阵 行列式 ｜ D ｜ ＞ 就 可以 结合 DHollander 的 迭代 划分 和 求 代表 迭代 点 的 方法 通过 增加 一个 外层 并行 循环 使 内层 串行 循环 的 相关 迭代 链是 紧凑 的 ［ ］ 所以 在 用 我们 的 方法 进行 内层 并行 化 之前 如果 rankD ′ m 且 ｜ D ′ ｜ ＞ 可以 利用 DHollander 的 方法 发掘出 可能 的 并行 化 循环 共 ｜ D ′ ｜ 个 并行 循环 迭代 然后 再 对 其余 内层 循环 并行 化 结果 将 得到 nrankD 个 并行 外层 循环 、 一个 串行 循环 和 rankD 个 并行 的 内层 循环 使 外层 循环 并行 化 　 　 循环 并行 化 变换 必须 保证 在 原来 迭代 空间 中 存在 跨 循环 相关 的 两个 循环 迭代 保持 串行 迭代 执行 顺序 亦 即 要求 距离 向量 的 合法性 　 　 定义 合法 的 距离 向量 n 维 相关 距离 向量 d 为 合法 valid 的 如果 它 是 按 字典 序 大于 向量 的 整数 向量 ∠ nd 相关 距离 矩阵 D 是 合法 的 如果 组成 它 的 每个 距离 向量 ddm 都 是 合法 的 　 　 引理 一定 合法 的 变换 矩阵 充要条件 对 n × n 阶幺模 矩阵 U 如果 对 任意 合法 的 n × m 阶 距离 向量 矩阵 DD ′ UD 也 是 合法 的 距离 向量 矩阵 当且 仅 当 U 是 下 三角 矩阵 并且 对角线 上 的 所有 元素 都 等于 　 　 证明 因为 D 是 合法 距离 向量 矩阵 d ≥ d ≥ dm ≥ 又 因为 U 是 下 三角 幺 模 矩阵 并且 对角线 上 的 所有 元素 都 等于 对 任意 d ′ iUdid ′ idi ≥ 若 d ′ i ＞ 则 d ′ i 为 合法 距离 向量 若 d ′ i 则 di 考查 d ′ iudididi 若 d ′ i ＞ 则 d ′ i 为 合法 距离 向量 若 d ′ i 则 di 考查 d ′ iudiudididi ≥ 依此类推 若 d ′ id ′ id ′ ki 则 dididkid ′ k 综上所述 除非 d ′ id ′ id ′ ni 否则 必有 一个 k 使 d ′ ki ＞ 所以 d ′ i 合法 　 　 对 j ＞ 若 uj ＜ 取 d ［ dj ］ T 则 d ′ uj ＜ d 合法 但 d ′ 不 合法 若 uj ＞ 取 d ［ ddj ｜ u ｜ ／ uj ］ T 则 d ′ u ｜ u ｜ ／ ujujuj ＜ d 合法 但 d ′ 不 合法 故 uun 对 j ＞ k 若 ujukj 但 ukj ＜ 取 d ［ dk ］ T 则 d ′ ukj ＜ d 合法 但 d ′ 不 合法 若 ukj ＞ 取 d ［ dk ｜ ukk ｜ ／ ukj ］ T 则 d ′ ukk ｜ ukk ｜ ／ ujukjukj ＜ d 合法 但 d ′ 不 合法 故 ukkukn 所以 U 一定 是 下 三角 阵 因为 U 是 满 秩下 三角 阵 所以 ukk ≠ 若 ukk ＜ 取 d ［ dk ］ T 则 d ′ ［ d ′ kukk ＜ ］ Td 合法 但 d ′ 不 合法 故 U 对角线 元素 大于 因为 U 是 幺 模 矩阵 所以 其下 三角 阵 对角线 的 乘积 等于 行列式 ± 所以 这些 对角线 元素 都 等于 　 　 由 引理 可知 在 种 基本 幺 模 变换 中 反序 阵 对角线 元素 不全 大于 交换 阵 不是 下 三角 阵 所以 它们 不能 保证 对 所有 合法 相关 距离 向量 变换 结果 仍然 合法 而 只有 下 三角 行斜 错 变换 才能 保证 变换 的 合法性 那么 对 某个 相关 距离 矩阵 DrankD ＜ n 是否 有 可能 找到 合法 的 幺 模 变换 矩阵 U 使得 UD ［ ｜ D ′ T ］ TD ′ 是 rankD × m 的 合法 距离 向量 矩阵 且 为 满 秩 下面 的 定理 给出 了 肯定 的 回答 定理 合法 的 消元幺模 矩阵 存在 性 在 n 维 迭代 空间 中 只要 所有 m 个 相关 距离 向量 都 是 常数 给定 n × m 的 距离 向量 矩阵 D 的 秩 srankD ＜ n 一定 存在 一个 合法 的 行 变换 幺 模 矩阵 U 使得 UD ［ ｜ D ′ T ］ TD ′ 是 rankD × m 的 合法 距离 向量 矩阵 且 为 行满 秩 　 　 构造性 证明 算法 首先 将 n 维 相关 距离 向量 按列 横排 的 D ［ ddm ］ 表示 为 行向量 的 按列 纵排 D ［ een ］ T 其中 每个 ei 都 是 m 维 行向量 这是 以下 计算 的 关键 寻找 U 使 UD 为 ［ ensen ］ T 的 步骤 如下 　 　 初始化 srankDtzEEeEeenTUU 　 　 t 记录 已经 处理 的 线性 无关 e 向量 个数 z 记录 已 变换 为 向量 的 个数 T 记录 中间 幺 模 变换 个数 　 　 IFznsGOTO 　 　 ForEeezEezeztEeztenD 为 合法 的 相关 距离 矩阵 　 　 　 IFrankEezttTHEN 　 　 　 　 EEeztEEezt 　 　 　 　 tt 　 　 　 　 GOTO 　 　 　 ELSE 　 　 　 　 ezt 与 ezezt 线性相关 存在 非零 整数 aatat 而且 at ＞ gcdaatataezateztatezt 　 　 这些 系数 可以 通过 以下 方法 计算 设 Dsub 为 D 的 t 阶满 秩子 矩阵 从 E 的 t 个 m 维 行向量 中 选取 无关 的 t 个列 Dinc 为 ezt 对应 于 这些 列 的 t 维子 行向量 令 at ｜ detDsub ｜ ＞ 则 ［ aat ］ atDincDsub 由此 得到 的 所有 整 系数 再 分别 除以 其 最大公约数 从而 保证 gcdaatat 　 　 WHILEat ≠ DO 辗转 相 除法 　 　 　 FORitbi ［ aiat ］ aiaimodat 　 　 ENDFORat ＞ ai ≥ 对 所有 it 　 　 TT 　 　 　 　 eztbezbteztezt 　 　 由 引理 若 D 是 合法 的 则 是 合法 的 　 　 　 　 TT 　 　 其中 i 为令 ati ＞ 的 最小 非负 整数 atiat 　 　 若 D 是 合法 的 则 是 合法 的 　 　 因为 若 D 是 合法 的 若 交换 eztiezt 不 合法 则 必须 存在 j 使 djdztijdztij ＞ 且 dztj ＜ 但是 由式 、 、 可知 dztjaztidztijazt ＞ 矛盾 　 　 为了 使式 不变 修正 系数 aaatiatiatiatatati 　 　 由式 ～ 可知 式 对 新 的 aatat 和 eztezezt 仍 成立 因为 gcdaatat 故此 循环 一定 会 终止 　 　 　 ENDWHILE 　 　 消元 　 　 　 由 引理 若 D 是 合法 的 则 是 合法 的 　 　 置换 向量 　 　 　 因为 ezt 若 D 是 合法 的 则 是 合法 的 所以 也 是 合法 的 EEEEeztzz 　 　 　 ENDIF 　 　 ENDFOR 　 　 UUTUTU 即为 所求 幺 模 矩阵 UTUTU ∈ UU 　 　 推论 若 距离 向量 个数 少于 迭代 空间 维数 m ＜ n 必有 幺 模 变换 使 最外 至少 nm 层 循环 并行 化 　 　 由于 上述 算法 中 U 的 计算 只 涉及 行 变换 所以 有 下列 推论 　 　 推论 若 U 是 根据 定理 对 给定 距离 向量 ddm 计算 出 的 合法 幺 模 变换 矩阵 则 只要 在 原 迭代 空间 中 合法 的 距离 向量 d 属于 以 djdjs 为基 向量 张成 的 s 维子 空间 在 变换 后 新 迭代 空间 中 Ud 仍旧 是 合法 的 且 也 能 最外 ns 层 并行 化 Ud 前 ns 个 分量 为 　 　 证明 因为 距离 向量 d 仍落 在 原基 向量 djdjs 张成 的 s 维 整数 子 空间 中 所以 存在 一系列 非全 零 实数 可以 证明 为 有理数 aas 使 dadjasdjsUdUadjasdjsaUdjasUdjs 因为 所有 djdjs 的 前 ns 个 分量 为 所以 Ud 前 ns 个 分量 为 　 　 定 理由 算法 计算 得到 的 幺 模 变换 是 外层 并行 最多 的 幺 模 变换 即 不能 再有 其他 幺 模 变换 产生 更 多 可 并行 化 的 外层 循环 　 　 证明 若有 多于 nrankD 的 行 可 变换 为 则 rankUD ＜ rankD 而幺模 变换 不 改变 矩阵 秩 矛盾 使 内层 循环 并行 化 　 　 定理 在 n 维 迭代 空间 中 只要 所有 m 个 相关 距离 向量 都 是 常数 给定 n × m 的 距离 向量 矩阵 D 的 秩 srankDn 一定 存在 一个 合法 的 行 变换 幺 模 矩阵 U 使得 UD 是 n × m 的 合法 距离 向量 矩阵 且 所有 距离 向量 的 第个 元素 大于 UD 的 首行 元素 大于 　 　 证明 算法 若 存在 一系列 非负 整数 uun 则 UT 即为 所求 令 kdjdnjdnj ＞ kn 　 　 由 算法 我们 对 D 作幺模 U 变换 得到 UD ［ T ｜ D ′ T ］ TD ′ 为 srankD 阶行 满 秩阵 现在 根据 算法 对 D ′ 得到 的 Us 作则 UUD 完成 进一步 对 内层 循环 并行 化 的 任务 计算 循环 迭代 空间 边界 　 　 n 重 循环 迭代 空间 I 为 iin ∈ Zn ｜ L ≤ i ≤ ULi ≤ i ≤ UiLniin ≤ in ≤ Uniin 变换 后 的 迭代 空间 J 为 jjn ∈ Zn ｜ LL ≤ j ≤ UULLj ≤ j ≤ UUjLLnjjn ≤ jn ≤ UUnjjn 由于 绝大多数 循环 使用 线性 边界 表达式 所以 可以 将 I 空间 边界条件 表示 为 Ai ≤ b 的 形式 其中 A 是 一个 n × n 的 整 系数 矩阵 b 是 一个 n × 的 整 系数 向量 kn 因为 iUj 所以 在 J 空间 中 边界条件 变为 AUj ≤ b 现在 只要 用 整数 FourierMotzkin 投影 消元 算法 ［ ］ 就 可以 计算 出 LLk 和 UUk 的 线性 表达式 如果 在 原 循环 边界条件 常数 项 b 中 出现 循环 不变 符号 变量 则 通过 符号 表达式 运算 仍 可 应用 FM 算法 求 出新 循环 的 边界条件 多重 循环 迭代 空间 幺 模 变换 应用 实例 　 　 分析 下列 串行 循环 相关 距离 矩阵 根据 算法 求得 幺 模 矩阵 可 使 循环 外层 并行 化 因为 得到 的 D ′ 满 秩 可逆 ｜ D ′ ｜ 所以 不 需要 再 根据 DHollander 方法 进一步 分析 partition 使用 算法 得到 幺 模 矩阵 使 循环 内层 并行 化 从而 完成 了 幺 模 矩阵 的 计算 根据 FM 算法 求得 循环 边界 表达式 这样 就 完成 了 幺 模 变换 所有 算法 都 是 自动 的 所以 不难 在 自动 并行 化 变换 工具 中 实现 　 　 DOi 　 　 　 DOii 　 　 　 　 DOiii 　 　 　 　 　 aiii 　 　 　 　 　 aiiiaiii 　 　 　 　 ENDDO 　 　 　 ENDDO 　 　 ENDDO 　 　 DOALLj 　 　 　 DOjmax ［ j ］ ［ j ］ 　 　 　 　 　 　 min ［ j ］ ［ j ］ ［ j ］ 　 　 　 　 DOALLjmaxjj ［ jj ］ 　 　 　 　 　 　 　 　 　 min ［ j ］ ［ jj ］ 　 　 　 　 　 ij 　 　 　 　 　 ijjj 　 　 　 　 　 ijjj 　 　 　 　 　 aiii 　 　 　 　 　 aiiiaiii 　 　 　 　 ENDDOALL 　 　 　 ENDDO 　 　 ENDDOALL 结论 　 　 对 相关 距离 向量 为 已知 常数 的 n 维 循环 本文 提出 了 外层 和 内层 并行 化 的 幺 模 并行 化 变换 方法 证明 了 满足 外层 并行 化 要求 的 合法 幺 模 矩阵 是 存在 的 并且 给出 了 计算 使 最 多层 数 外层 循环 并行 化 的 合法 幺 模 矩阵 的 算法 这种 一般 算法 可以 扩充 于 非 完全 嵌套循环 和 非常 数 相关 距离 循环 的 幺 模 变换 本文 提出 的 算法 都 可 在 自动 并行 化 编译 中 实现 　 本文 研究 得到 国家自然科学基金 、 国家 高科技 项目 基金 、 国家 攀登 计划 基金 和 国家教委 博士点 基金 资助 　 实际上 是 nrankD 层 循环 ， 如果 rankD ， 则 不 存在 需要 进一步 并行 化 的 串行 循环 。 本文 通讯联系 人 俞一峻 上海复旦大学 并行处理 研究所 作者简介 　 俞一峻 年生 博士 主要 研究 领域 为 并行处理 高性能 计算 　 　 　 　 　 臧斌 宇年生 副教授 主要 研究 领域 为 并行 化 编译 　 　 　 　 　 施武年生 助教 主要 研究 领域 为 并行处理 　 　 　 　 　 朱传琪 年生 教授 博士生 导师 主要 研究 领域 为 并行处理 作者 单位 ： 复旦大学 并行处理 研究所 　 上海 参考文献 　 WolfeMOptimizingsupercompilersforsupercomputers ［ PhDThesis ］ UniversityofIllinoisUIUCDCSR 　 BanerjeeUDependenceAnalysisforSupercomputingNorwellMAKluwerAcademicPublishersGroup 　 朱传琪 臧斌宇 陈彤 程序 自动 并行 化 系统软件 学报 ～ ZhuChuanqiZangBinyuChenTongTheautomaticparallelizingcompilerAFTJournalofSoftware ～ 　 BanerjeeUUnimodulartransformationsofdouble 　 loopsInAdvancesinLanguagesandCompilersforParallelProcessingCambridgeMAMITPress ～ 　 DHollanderEHPartitioningandlabelingofloopsbyunimodulartransformationsIEEETransactionsonParallelDistributedSystems ～ 　 XueJinlingUnimodulartransformationsofnonperfectlynestedloopsInternationalJournalofParallelComputing ～ 　 YuYijunWangQiZhuChuanqiThedesignofaparallelprogrammingenvironmentforFPTInDHollanderEHetaledsProceedingsoftheTopicinKnowledgeandInformationTechnologyCommunicationCongnition ～ 　 WangQiYuYijunDHollanderEHVisualizingtheiterationspaceinPEFPTInHertzbergerBSlootPedsProceedingsoftheHighPerformanceComputingandNetworkInternationalConferenceandExhibitionSpringerVerlagKG ～ 　 WilliamsHPFourierMotzkineliminationtointegerprogrammingproblemsJournalofCombinatorialTheoryA ～ 本文 收到 原稿 收到 修改稿