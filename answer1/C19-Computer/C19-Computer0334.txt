计算机 应用 ComputerApplications 年 第卷 　 第期 Vol 　 No 企业 网 计费 系统 的 设计 与 实现 张 　 庄 　 　 摘 　 要 　 本文 提出 一种 投资 少 、 效果 好 的 网络结构 和 计费 方法 ， 并且 已经 运行 。 　 　 关键词 　 网络结构 ， 网络连接 　 引言 　 　 随着 Internet 的 普及 ， 越来越 多 的 单位 或 企业 纷纷 将 自己 的 企业 网 与 Internet 网 连接 ， 这样 就 给 企业 网络管理 带来 了 许多 问题 ： 安全 问题 ， 配置管理 ， 计费 管理 等 。 而 对于 企业 来讲 ， 计费 管理 是 尤为重要 的 ， 因为 ， 目前 单位 或 企业 要 想 进入 Internet 都 是 向 电信局 租用 X 或 DDN 专线 入网 其 有效 带宽 从 K 不 等 ， 并且 带宽 越 宽 租用费 越贵 ， 还有 如果 让 人们 无 限制 地 访问 Internet 必 造成 以下 问题 ： 　 　 企业 网 出口 拥挤 ， 数据 传送速度 变慢 ； 　 　 使 急需 访问 Internet 用户 得不到 保障 ； 　 　 费用 大量 增加 。 　 　 解决 以上 问题 最 有效 的 措施 是 采用 计费 机制 约束 入网 用户 ， 谁 能 上网 谁 不能 上网 ， 对 每位 上网 用户 详细 纪录 他们 的 使用 情况 ， 因此 用户 只有 需要 时才 上 Internet ， 这样 才能 达到 企业 网 与 Internet 网 连接 的 真正 目的 。 　 系统 设计 原理 　 　 Internet 目前 采用 TCPIP 协议 进行 网络通信 ， 在 Internet 网中 的 每 一台 计算机 都 必须 拥有 唯一 的 一个 只 属于 自己 的 IP 作为 主机 地址 ， 这样 所有 Internet 网上 的 计算机 都 可以 通过 这个 IP地址 找到 这台 主机 与其 通讯 交换 信息 。 因此 ， 计费 软件 只要 对 每 一个 这样 的 IP地址 的 通讯 数据 进行 统计 ， 就 可以 得到 上网 用户 使用 的 准确 纪录 。 　 　 一个 单位 或 企业 的 网络 要 想 与 Internet 连接 ， 可以 采用 两种 连接 方式 ， 第一种 方式 ， 根据 自己 企业 网中 计算机 数向 ISP 商 申请 IP ， 然后 给 每 一台 计算机 都 配置 相应 的 IP ， 这样 这个 企业 网中 的 计算机 都 可以 上 Internet ， 这种 企业 网络结构 如图所示 。 图 　 　 在 图 网络结构 中要 想 实现 对 每 一台 计算机 进行 计费 可以 有 两种 方法 ， 第一种 将 装有 计费 软件 的 计算机 接到 主干线 ， 该 计费 软件 主要 特点 必须 定时 到 Router 中取 各个 IP 包 数据 ， 然后 把 各 IP 包 数据 贮 放到 本机 中 。 结构 如图所示 ： 图 　 　 第二种 将 装有 计费 软件 的 计算机 接在 Router 与 主干线 之间 ， 结构 如图所示 ： 图 　 　 在 这个 结构图 中 所有 计算机 首先 必须 通过 这台 计费 计算机 后 才能 上 Internet ， 所以 计费 软件 不是 到 Router 中取 IP 包 数据 而是 自动 纪录 下 各个 通过 它 的 IP 包 数据 。 它们 的 区别 在于 第一种 的 Router 必须 要 有 IPAccounting 功能 ， 否则 计费 软件 不能 工作 。 第二种 的 Router 就 可以 不要 IPAccounting 功能 ， 计费 软件 也 可以 工作 。 　 　 第二种 连接 方式 ， 向 ISP 商 申请 个 IP 采用 代理服务 的 方法 ， 企业 网 的 所有 计算机 都 用 自己 定义 的 内部 IP地址 ， 当 内部网 的 计算机 想 上 Internet 时 ， 必须 通过 代理服务 方式 把 内部 IP 转成 正规 的 IP 然后 进入 Inernet ， 如图 ： 图 　 　 在 以上 两种 方式 （ 图 、 图 ） 中 ， 第一种 计费 是 对 每台 计算机 的 IP 进行 统计 然后 打印 出 各台 计算机 使用 的 情况 ， 对 使用者 来讲 所有 Internet 功能 都 能 实现 ， 没有 限制 。 但 对 企业 ， 首先 它 要 对 这么 多 的 IP 交 IP 租用费 ， 还有 因无 限制 使用 ， 故 数据量 很大 ， 费用 也 大 ， 不能 区分 出 哪个 用户 使用 的 情况 。 第二种 方式 的 计费 是 在 代理服务 的 作用 下 对 每个 允许 进入 Internet 网 的 用户 进行 统计 然后 打印 出 这些 使用者 的 使用 情况 ， 该 方式 可以 限制 企业 上网 的 人数 ， 限制 上网 的 功能 ， 例如 ， 只 允许 用户 HTTP 、 FTP ， 而 不能 Oline 交谈 ， Oline 游戏 。 因此 ， 对 企业 来讲 ， 代理 计费 方式 经济实用 ， 管理 和 使用 都 方便 。 　 计费 系统 的 实现 　 实现 的 环境 　 　 图是 一个 典型 的 代理 计费 网络结构 在 该 图 中 装有 计费 软件 代理服务器 这台 计算机 配置 二个 M 的 网卡 ， 一块 要 与 Router 连接 ， 网卡 置 为 正规 的 IP地址 ， 另 一块 配 企业 自己 定义 的 内部 IP地址 跟 企业 网 的 主干线 连接 。 这样 这台 服务器 就象 “ 桥 ” 一样 使 内部网 可以 跟 外部 Internet 网 接通 ， 所有 内部 计算机 与 Internet 交换 的 数据 都 记录 在 这台 服务器 的 硬盘 中 了 。 　 系统软件 的 构成 和 功能 　 　 在 代理服务器 这台 计算机 中 需要 安装 如下 软件 ： 　 　 WindowNTServer 版 操作系统 （ 附加 Pack 包 ） 。 　 　 为了 便于 对 上网 用户 的 管理 ， 我们 利用 NT 设置 一个 用户组 ， 属于 这个 组 的 成员 都 允许 它们 上 Internet ， 企业 网 的 系统管理员 只要 对 该组 的 成员 进行 增加 、 删除 、 更改 。 因此 ， 管理 十分 方便 。 　 　 ProxyServer 代理 软件 。 　 　 代理服务 Proxy 把 属于 允许 进入 Internet 组中 的 成员 “ 送 ” 到 Internet ， 同时 纪录 这个 成员 上网 的 数据量 等 其它 信息 。 Proxy 还 可以 限制 用户 上网 的 功能 ， 例如 ， 企业 只 允许 它们 的 员工 游览 Internet （ 即 HTTP ） 不能 Oline 聊天 （ 或 游戏 ） ， 那末 它 可以 通过 Proxy 的 设置 定义 用户 只能 HTTP ， 这样 帮助 企业 减少 许多 无用 数据 ， 节约 了 开支 。 　 　 SQLServer 数据库 服务 软件 。 　 　 SQLServer 数据库 服务 软件 为 Proxy 创建 一个 数据库 这个 数据库 贮放 Proxy 纪录下来 的 所有 上网 用户 的 信息 计费 软件 就 是从 该库 中 读取数据 进行 统计 。 例如 ， 在 可 这个 数据库 中 建立 一个 用户 表 （ Proxyuser ） ， 该表是 由 用户名 ， 用户 上网 日期 ， 用户 上网 时间 ， 用户 上网 数据 ， 目标 IP地址 等 构成 ， 当 某个 用户 上网 ， Proxy 就 实时 地 把 相关 的 数据 写 到 这个 表中 。 　 　 计费 软件 （ VB 开发 ） 。 　 　 程序设计 语言 VisualBasic 是 一种 功能 非常 完善 的 嵌入式 智能工具 ， 它 能 使 你 的 编程 工作 取得 事半功倍 的 效果 ， 特别 是 VB 的 数据 访问 可以 使 用户 的 程序 十分 轻松 方便 地 读取 SQLServer 数据库 中 的 数据 。 针对 这种 计费 的 网络结构 ， 我们 用 VB 开发 的 计费 软件 可以 以 多种 方式 统计 出 用户 上网 的 数据量 和 费用 。 例如 ， 单个 用户 的 表 和 总表 姓名 ： 日期 ： 计算机 名 ： 开始 时间 ： 结束 时间 ： 上机时间 ： 数据 流量 ： 单价 ： 总费用 ： 日期 ： xxxxxxxx 到 xxxxxxxx 　 计算机 名 数据量 金额 （ 元 ） 计算机 xxxxxxxxxx … 　 　 计算机 nxxxxxxxxxx 总 　 计 xxxxxxxxxxxxxx 　 　 除了 上面 安装 的 软件 外 ， 这台 计算机 还要 在 安装 MicrosoftInternetInformationserver 和 TCPIP 。 　 　 本文 介绍 了 一种 与 路由器 无关 的 基于 代理服务 的 计费 思想 ， 并 已 在 一些 单位 正式 运行 ， 取得 了 很 好 效果 。 这种 计费 方法 投资 少 ， 很 适合 在 中 、 小企业 的 使用 。 作者简介 张 　 庄 　 高级 工程师 。 主要 从事 网络 设计 和 管理 、 计算机 应用 开发 。 作者 单位 张 　 庄 　 福建省 经济 信息中心 　 福建 福州 （ ） 收稿 日期