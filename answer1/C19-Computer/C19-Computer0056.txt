计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 视频 与 音频 实时 多点 传输 的 研究 与 实现 区海翔 汤庸 李显济 黄鹤 远 摘要 在 开发 桌面 视频会议 系统 （ GdDCS ） 的 过程 中 ， 利用 WindowsSocket 规范 实现 了 视频 、 音频 在 网络 上 的 实时 多点 播送 。 首先 描述 了 GdDCS 系统 多点 播送 的 模型 ， 然后 讨论 视频 、 音频 实时 多点 传输 的 实现 。 关键词 多媒休 视频会议 系统 计算机 支持 的 协同工作 实时 广播 TheResearchandImplementationofAudioandVideRealtimeMulticastOuHaixiangTangYongLiXianjiWangHeyuanDepartmentofComputerScienceandEngineering ， GuangdongUniversityofTechnologyGuangzhouAbstract ： WeimplementedanaudioandvideorealtimemulticastonnetworkusingWindowsSocketprogrammingduringthedevelopingofDesktopVideoConferencingSystemforMultiparticipants （ GdDCS ） ThisarticledescribesthemulticastmodelofGdDCSandvideorealtimemulticastKeywords ： MultimediaVideoconferencingsystemComputersupportedcooperativeworkRealtimeMulticast 　 　 把 多媒体 引入 网络 ， 极大 地 拓展 了 多媒体技术 的 应用 范围 ， 例如 在 计算机 支持 的 环境 下 进行 协同工作 更为 直观 和 高效 。 所谓 CSCW 即 计算机 支持 的 协同工作 ComputerSupportedCooperativeWork 的 目的 就是 让 群体 在 计算机 支持 下 协同工作 ， 共同完成 某一 任务 ， 共同 讨论 某一 课题 或 共同 决策 等 。 视频会议 系统 是 CSCW 研究 的 重要 范例 和 内容 ， 视频会议 系统 要求 在 与会 群体 中 提供 实时 的 视频 、 音频 多点 交互 ， 提供 群体 协商 与 决策 的 平台 ， 因而 视频 、 音频 信息 在 网络 上 实时 多点 传输 是 视频会议 系统工程 的 基础 。 视频 、 音频 是 多媒体 的 重要 内容 ， 但 在 远程 通信 特别 是 在 Internet 上 实现 视频 、 音频 实时 多点 交互 却 还 存在 诸多 问题 ， 例如 数据 的 压缩 与 解压缩 ， TCPIP 协议 网络 的 广播 或 多点 播送 机制 ， 视频 、 音频 媒体 内 同步 与 媒体 间 同步 ， 视频 、 音频 服务质量 QoS 等 。 合理 解决 这些 问题 已 成为 实现 视频 、 音频 多点 传输 的 关键 。 我们 在 开发 桌面 会议 系统 GdDCS 的 过程 中 ， 研究 了 TCPIP 协议 网络 上 多点 播送 的 机制 ， 并 利用 WindowsSocket 规范 ， 实现 了 视频 、 音频 的 多点 传输 。 　 TCPIP 协议 网络 的 多点 播送 模型 　 　 所谓 TCPIP 协议 网络 ， 指 通信协议 采用 TCPIP 协议 的 网络 。 TCPIP 协议 是 在 Internet 上 通用 的 协议 ， 而 大部分 局域网 和 部门级 的 Internet 也 都 采用 TCPIP 协议 作为 通信协议 。 因此 研究 TCPIP 协议 网络 的 多点 播送 机制 具有 普遍意义 和 实用价值 。 在 TCPIP 协议 网络 上 实现 多点通信 可以 有 两种 方式 ： 　 　 利用网络 的 广播 功能 　 所谓 广播 ， 指源 发方 只 需要 发送 一份 数据 拷贝 ， 网络 上 所有 站点 都 可以 接收 此 数据 拷贝 。 广播 是 局域网 的 天然 特性 ， 但 在 Internet 上 却 很 难 实现 。 目前 ， TCPIP 协议 对 广播 的 支持 还 不 很 充分 ， 但 对 虚 电路 通信 的 支持 已经 很 成熟 ， 因此 ， 我们 考虑 从 应用层 上 建立 多点 播送 的 模型 。 　 　 建立 发送 方到 多个 接收 方 的 多条 虚 电路 进行 多点 播送 　 这种 方案 的 缺点 是 数据 冗 佘大 ， 浪费 网络带宽 ， 数据通信 效率 低等 ， 但 这种 方案 数据传输 可靠 ， 保密性 好 。 目前 大多数 多点 播送 使用 这种 方法 进行 模拟 。 　 　 在 GdDCS 系统 中 ， 考虑 到 现有 协议 、 路由 软件 的 支持 程度 和 数据传输 的 可靠性 ， 采用 了 建立 多条 虚 电路 模拟 多点 播送 的 方法 实现 多点通信 。 但 由于 GdDCS 的 体系结构 是 服务器 模型 ， 因此 作 了 以下 改 ， 使 通信 更为 简单 ， 控制 更为 严密 。 　 　 中央 服务器 作为 中央 集线器 或 反射器 ， 多点 转发 客户 数据 。 客户 与 客户 之间 不 建立 虚 电路 ， 客户 间通信 通过 服务器 转发 。 在 中央 服务器 上 形成 并 维护 与 多个 客户 通信 的 虚 电路 。 　 建立 多点通信 网络连接 　 　 在 实现 中 把 视频会议 系统软件 分为 两个 部分 ； 运行 于 服务器端 的 VideoServer 及 运行 于 客户端 的 VideoClient 。 在 通信协议 上 采用 TCPIP 协议 。 由于 CPIP 协议 是 适合 于 在 当前 Internet 上 使用 的 协议 ， 因此 就 为 系统 能够 在 Internet 上 使用 奠定 了 良好 的 基础 。 在 编程 实现 上 使用 WindowsSocket 规范 实现 网络通信 。 WindowsSocket 规范 定义 并 记录 了 如何 使用 API 与 Internet 协议 族 连接 ， 尤其 要 指出 的 是 ， 所有 的 WindowsSocket 实现 都 支持 流套 接口 和 数据 报套 接口 ， 也 就是 可以 建立 面向 连接 的 虚 电路 传输 和 面向 无 连接 的 数据 报 传输 。 考虑 到 现有 协议 对 广播 的 支持 程度 及 在 Internet 上 进行 可靠 的 数据传输 ， 我们 采用 了 面向 连接 的 虚 电路 传输 方案 。 在 中央 服务器 上 形成 多组 Socket 套 构成 列表 ， 每 一个 Socket 套 与 客户端 对应 的 Socket 套 构成 了 条虚 电路 。 在 实现 上 采用 客户 请求 、 服务器 应答 的 两次 握手 协议 建立 一对 双向 传输 的 Socket 套 。 　 　 数据传输 方案 采用 数据类型 划分 的 方法 。 视频会议 系统 中 在 网络 上 交互 的 数据 大体 可以 分为 以下 类 。 　 　 用户 信息 　 包括 ： ① 客户 在 建立 连接 后 向 中央 服务器发送 本地 音频视频 采集 格式 等 ； ② 服务器 将 用户 列表 发送到 与会 各站 　 　 控制 命令 　 包括 ： ① 客户 向 服务器 请求 服务 ； ② 服务器 对 客户 的 应答 及 广播 会议 状态 等 。 　 　 音频 数据库 　 与会 各 站点 采集 的 音频 数据 。 　 　 视频 数据库 　 与会 各 站点 采集 的 视频 帧 。 　 　 采用 这种 数据类型 划分 的 方法 ， 某 一类 数据 只 在 一组 Socket 套 中 交互 ， 这 就 可以 简化 数据格式 ， 简化 网络 数据传输 打包 、 解包 的 过程 ， 而且 不同 类型 的 数据 可以 并行传输 。 　 　 在 客户 站点 建立 个 Socket ： ① ClientSocket 传输 用户 信息 ， ② VideoSocket 传输 视频 数据 ， ③ AudioSocket 传输 音频 数据 ， ④ CommandSocket 传输 控制 命令 及 状态 信息 。 　 　 客户 进程 在 建立 上述 个 Socket 后 ， 通过 ClientSocket 套 发送 客户 站点 的 用户 信息 ， 而 其余 个 上 的 个 Socket 构成 一对 双向通信 的 套 接字 连接 。 中央 服务器 监听 一个 Socket 连接 请求 是 通过 监听 一个 特定 的 端口号 来 实现 的 ， 要 监听 个 Socket 连接 的 请求 就 必须 对个 端口 同时 进行 监听 。 端口号 可以 由 程序 设置 ， 通常 要 大于 。 　 　 中央 服务器 进程 初启后 立刻 建立 个 监听 线程 ， 分别 监听 来自 不同 端口号 的 Socket 连接 请求 。 一旦 后台 监听 线程 在 特定 的 端口号 检测 到 连接 请求 ， 它 就 接收 请求 Accept ， 建立 Socket 套 连接 。 各个 监听 线程 并行 工作 ， 这是 多线程 MultiThread 的 概念 。 　 　 在 实际 会议 中 ， 至少 有 两个 站点 ， 也 可以 有 多个 站点 参加 会议 ， 中央 服务器 的 监听 线程 不是 简单 地 形成 个 Socket 就 结束 了 ， 还 必须 把 这些 新建 的 Socket 存入 个 Socket 列表 中 ， 以便 在 将来 实现 多点 播送 ， 这个 服务器端 的 Socket 列表 分别 是 ： 　 　 ClientSocketMAXUSERNUM 用户 信息 Socket 套组 ； 　 　 VideoSocketMAXUSERNUM 视频 数据 Socket 套组 ； 　 　 AudioSocketMAXUSERNUM 音频 数据 Socket 套组 ； 　 　 CommandSocketMAXUSERNUM 控制 命令 及 状态 信息 Socket 套组 。 　 　 其中 ， ClientSocket 列表 在 建立 网络通信 连接 时 用于 多点 播送 中央 服务器 上 形成 的 用户 列表 ， 而 其余 个 Socket 列表 以后 用于 接收 及 转发 视频 、 音频 数据 和 实现 会议 控制 功能 。 　 语音 实时 多点 播送 　 　 语音 交互 是 视频会议 系统 的 重要 组成部分 ， 语音 交互 的 质量 好坏 直接 决定 视频会议 的 效果 ， 音频 模块 要 保证 语音 远地 回放 的 质量 ， 延迟 小 ， 实时性 等 。 　 　 为了 使 系统 适合 在 Internet 上 使用 ， 音频 的 采集 ， 传输 与 回放 通过 音频 发送 缓冲 池 、 音频 接收 缓冲 池 进行 ， 如 图示 所示 。 图 音频 的 采集 、 传输 的 回放 过程 　 　 发送 方 采集 的 音频 数据 经压缩 后 存入 音频 发送 缓冲 池 ， 发送 缓冲 池满 后 就 向 网络 发送 。 接收 方 通过 接收 缓冲 池 接收 音频 数据 ， 接收 缓冲 池满 则 取出 数据 经 解压缩 后 送到 放音 设备 播放 。 由于 客户 与 客户 之间 没有 建立 直接 通信 的 逻辑 信道 ， 因此 ， 服务器 要 具备 音频 转发 的 功能 。 在 服务器端 ， 接收 缓冲 池 接收数据 后 ， 除了 在 本地 回放 ， 还 将 音频 数据包 在 服务器 与 客户 的 多条 逻辑 信道 源 发方 除外 上 多点 播送 ， 从而 实现 音频 的 多点 交互 。 　 　 音频 发送 缓冲 池 、 音频 接收 缓冲 池 的 包数 分别 为 N 、 MN 、 M 的 值 可变 ， 大体上 有种 策略 设定 N 、 M 的 值 ： 　 　 NM 。 适合 于 局域网 上 应用 ， 局域网 带宽 大 ， 传输 延迟 小 ， NM 可以 获 最好 的 实时性 ， 控制 也 最 简单 。 　 　 N 、 M 值设 为 某 一域 值 ， NM 或 N ≠ M 。 在 Internet 上 传输 必须 考虑 媒体 内 同步 与 媒体 间 同步 ， 缓冲 池 的 包数 可以 在 达到 域值 时 才 发送 或 播放 ， 同时 对 音频 数据包 加上 时间 戳 或 同步 标记 。 　 　 N 、 M 值 动态变化 ， 这 是 最 复杂 的 缓冲 池 控制策略 ， 不过 在 Internet 上 也 可以 获得 较为理想 的 实时性 与 同步性 的 折中 。 　 　 我们 基于 低级 音频 服务 编写 实时 声音 的 采集 、 回放 以及 实现 声音 在 网络 上 实时 的 多点 传播 ， 这种 方法 的 突出 优点 是 实时性 ， 其次 ， 该 方法 并 不是 对 音频文件 操作 ， 而是 利用 流 的 机制 ， 能 直接 对 实时 音频 流 信息 进行 控制 编辑 。 因而 ， 这种 方法 对 要求 实时 音频 的 应用 如 电视会议 系统 的 开发 特别 适用 。 　 视频 实时 多点 播送 　 　 视频 模块 应当 作为 会议 系统 的 一个 可选 的 组件 ， 强化 多用户 之间 的 协同工作 ， 实现 CSCW 的 WYSIWIS 的 目标 。 所谓 可 选 ， 指 用户 可以 根据 协同 的 需要 、 设备 状况 或 网络通信 的 现状 选择 是否 进行 视频 交互 或 调整 视频 交互 的 质量 。 　 　 与 音频 采集 、 传输 和 回放 类似 ， 视频 采集 、 传输 与 回放 也 是 通过 视频 发送 缓冲 池 与 一组 视频 接收 缓冲 池 进行 的 ， 如图所示 。 图 视频 多点 播送 　 　 由于 视频 模块 与 音频 模块 在 工作 机理 上 的 差异 ， 视频 模块 主要 在 以下 两个 方面 有所不同 ： 　 　 音频 流在 时间 上 是 互斥 关系 ， 即 每 一 时刻 都 只有 一个 站点 的 音频 流 得以 传输 ， 因此 一个 站点 只有 一个 音频 发送 缓冲 池 与 一个 音频 接收 缓冲 池 ； 视频流 在 时间 上 是 并发 关系 ， 即 某个 时刻 可以 有 多个 站点 的 视频流 在 传输 ， 因此 一个 站点 上 有 一个 视频 发送 缓冲 池 和 多个 视频 接收 缓冲 池 ， 多个 视频 接收 缓冲 池 并行 工作 。 在 用户界面 表现 为 同时 在 多个 视频 播放 窗口 上 回放 多个 站点 的 视频 图象 。 　 　 视频 数据 分为 两个 部分 ： 帧 与 帧 格式 。 帧 位元 数据 必须 在 正确 的 帧 格式 下 才能 正确 回放 ， 因此 视频 缓冲 池 也 分为 两 部分 ： 帧 缓冲 池 与 帧 格式 池 ， 两者 成 对 采集 、 传输 与 回放 。 小结 　 　 在 开发 桌面 多点 视频会议 系统 GdDCS 的 过程 中 ， 我们 设计 并 实现 了 一个 多点 播送 模型 。 它 利用 客户服务器 模型 的 特性 ， 在 客户 与 服务器 间 建立 多条 虚 电路 连接 ， 通过 服务器 的 转发 反射 实现 多点通信 。 这种 方法 具有 适于 TCPIP 协议 网络 Internet 及 大多数 Intranet 、 局域网 、 保密性 好 、 控制 严密 的 优点 ， 但 在 增加 网络 负载 ， 利用 网络带宽 上 效果 不好 。 下 一步 拟用 UDP 协议 实现 通信 ， 以 提高 传输 效率 。 本 课题 得到 广东省 自然科学 基金 、 广东省 重点 攻关项目 和 广东省 重点学科 项目 的 资助 作者简介 ： 区海翔 男 ， 岁 ， 研究生 ， 主要 从事 多媒体 与 CSCW 研究 作者 单位 ： 广东 工业 大学 计算机系 广州 参考文献 钟玉琢 多媒体计算机 技术 北京 ： 清华大学出版社 ， FluckigerF 网络 多媒体 开发 与 应用 北京 ： 机械 工业 出版社 ， 收稿 日期 ：