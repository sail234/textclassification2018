软件 学报 JOURNALOFSOFTWARE 　 Vol 　 No 　 P 树木 的 整体性 运动 及树 内部 风场 的 研究 冯金辉 　 严涛 　 陈彦云 　 吴恩华 摘要 　 树木 的 结构 和 物理性质 的 复杂性 使得 人们 很难 对 其 进行 动态 模拟 该文 提出 一个 深度 优先 的 数值积分 遍历 算法 把 树 作为 一个 整体 考虑 求得 整棵树 协调一致 的 位移 较 好 地 表现 了 树 的 整体 动感 此 算法 作为 一个 整体性 算法 也 可 推广 用于 其他 树种 的 模拟 另外 文章 还 分析 了 枝条 对风 的 遮挡 关系 包括 过 遮挡 、 孔洞 、 狭长 缝隙 及 透射 基于 Zbuffer 算法 思想 对 这些 遮挡 关系 进行 了 处理 取得 了 令人满意 的 效果 关键词 　 基于 物理 的 计算机 动画 树 模拟 风场 深度 优先 数值积分 中图法 分类号 　 TPResearchonWholeTreesMovementandTreesInnerWindFieldFENGJinhui 　 YANTao 　 CHENYanyun 　 WUEnhuaLaboratoryofComputerScienceInstituteofSoftwareTheChineseAcademyofSciencesBeijing 　 WUEnhuaFacultyofScienceandTechnologyUniversityofMacao 　 MacaoAbstract 　 TheauthorssimulatedthemovementofwillowsendbranchblownbywindClearlythisisnotnaturalandrealAtreemovesasawholeNowanalgorithmnameddepthfirstnumericalintegraltreetraversalalgorithmisgivenThealgorithmcangeneratetheharmonicandconsistentmovementofatreethusanimatesthedynamicposeoftreeverywellItcanalsobeusedtoanimateotherkindsoftreesMoreovertheauthorsanalyzedtheobstructioneffectofbranchesandleavesreactingonwindwhichincludingnoobstructionholeapertureandpenetrationBasedontheprincipleofZbuffertheseeffectsareprocessedandtheresultsaresatisfiedKeywords 　 Physicallybasedcomputeranimationtreesimulationwindfielddepthfirstnumericalintegral 　 　 计算机 动画 根据 其所 依据 的 理论 和 所 采用 的 技术 可 分为 关键帧 动画 、 变形体 动画 、 过程 动画 和 基于 物理 的 动画 计算机 动画 是 用 计算机 来 产生 动画 序列 的 要 产生 真实感 较强 的 动画 基于 必要 的 物理 原理 是 不可避免 的 因为 这些 物体 运动 的 规律 被 其 所 对应 的 物理 原理 所 反映 只有 采用 这些 原理 才 有 可能 产生 逼真 的 动画 因此 基于 物理 的 计算机 动画 技术 成 了 目前 研究 的 热点 　 　 Terzopoulos 等 人 ［ ］ 基于 简化 的 弹性 理论 构造 了 固体 变形 摸型 Barzel 和 Bar ［ ］ 利用 反 动力学 （ inversedynamics ） 原理 获得 约束力 这种 力使 物体 沿着 指定 的 约束 路线 运动 CarignanYang 和 NadiaThalmann ［ ］ 把 二维 的 多边形 面片 缝 在 一起 形成 衣服 并 穿 在 玛丽莲梦 露 身上 首次 模拟 了 服装 的 运动 徐迎庆 等 人 ［ ］ 研究 了 波浪 万华 根等 人 ［ ］ 研究 了 喷泉 李江 等 人 ［ ］ 模拟 了 相对论 效应 詹永照 等 人 ［ ］ 也 就 表情 问题 进行 了 研究 　 　 Wejchert 和 Haumann ［ ］ 模拟 了 树叶 在 风中 的 飘舞 他们 通过 种 简单 流体 单元 均匀 流 （ uniform ） 、 汇 （ sink ） 、 源 （ source ） 以及 涡 （ vortex ） 来 设计 和 控制 风 的 流动 风对 树叶 在 法向 施加压力 在 切 向 施加 粘性力 树叶 的 运动 由 经典 牛顿 理论 得到 MikioShinya 等 人 ［ ］ 构造 了 一个 随机 风场 stochastic 基于 模态 分析 modalanalysis 方法 模拟 了 树 在 风中 的 摇晃 应当 指出 上述 风场 的 构造 以及 树叶 和 树 的 运动 模拟 是 两个 独立 的 过程 均 没有 考虑 到 风 与 树 的 相互作用 这 与 实际 情况 是 不 相符 的 事实上 树 与 风 之间 是 相互作用 、 相互影响 的 对于 中等 以下 风力 树 中间 及 后部 的 风力 将 由于 树 的 遮挡 而 明显 减弱 本文 将 给出 一个 算法 来 处理 这一 现象 当然 对于 极端 情形 这种 效应 也 可以 忽略 如 Hiromi ［ ］ 在 电影 “ 龙卷风 twister ” 中 利用 湍流 原理 （ turbulence ） 构造 了 龙卷风 场 风力 是 如此 之大 以至于 把 树 连根拔起 天昏地暗 飞沙走石 树 对 风 的 影响 当然 可以 忽略 　 　 文献 ［ ］ 对 柳树 的 末端 枝条 进行 了 动态 模拟 而 整棵树 是 作为 一个 整体 在 运动 的 因此 有 必要 对 算法 进行 改进 现对 其中 的 算法 作一 简要 叙述 随后 给出 新 算法 深度 优先 的 数值积分 遍历 算法 　 单根 树枝 的 运动 方程 　 　 为 方便 实施 数值积分 ， 我们 把 树枝 分为 一系列 小段 可 认为 每段 内 是 直 的 具有 同样 的 物理性质 （ 弹性系数 、 密度 、 半径 等 ） 如图所示 Fig 　 Abranchsegment 图 　 一段 树枝 示意图 　 　 一段 树枝 的 轮廓 由 一组 位置 函数 和 正交 坐标系 来 定义 ｛ rseis ｝ 它们 给出 了 该段 树枝 的 位置 和 方向 其中 ss ［ L ］ L 是 该 段长度 单位向量 es 定义 弧长 切线 方向 单位向量 es 和 es 定义 横截面 方向 假定 树枝 不可 伸长 则 弯曲 和 扭转 变形 就 由 向量 eses 和 es 的 变化 来 度量 可以 把 变形 后 的 局部 标架 ｛ ej ｝ 表示 为 ｛ eee ｝ T ［ R ］ ｛ eee ｝ T 其中 R 是 用 欧拉角 表示 的 转动 矩阵 经 必要 的 演算 平衡 方程 变为 个 欧拉角 关于 弧长 的 二阶 常微分 方程组 ： 同时 任 一点 在 局部 坐标 下 的 位移 xyz 满足 ： 　 　 式 （ ） 和 式 （ ） 分别 是 二阶 和 一阶常 微分方程 可 直接 进行 数值积分 这样 就 求得 了 当前 段 的 变形 同时 也 得到 了 该段 的 尾部 参数 把 所得 参数 作为 下 一段 的 初始 参数 即可 继续 进行 积分 直到 整条 树枝 得到 解决 （ 式 中 各 符号 的 含义 参见 文献 ［ ］ ） 　 深度 优先 的 数值积分 遍历 算法 　 　 上述 平衡 方程 是 关于 一根 树枝 的 但 实际 情形 是 将 整棵树 作为 一个 整体 在 运动 因此 必须 改进 该 算法 ， 以 求得 整棵树 的 运动 我们 看到 ， 在 求解 末端 枝条 时 是 把 其 分为 一系列 小 段 分别 进行 求解 把 前段 末端 参数 作为 下 一段 起始 参数 再 进行 数值积分 这样 ， 在 两段 参数 的 传递 过程 中 如果 恰好 此处 有 一 分支 就 把 该 分支 的 起始 参数 同时 考虑 进来 只要 在 该 节点 满足 平衡条件 不同 分支 之间 的 运动 应当 是 协调 的 并且 是 一致 的 可由树 的 造型 来 保证 分支 落 在 节点 上 具体情况 如下 如图所示 Fig 　 Parametertransferringbetweenbranches 图 　 分支 间 的 参数传递 　 　 对 某 一 树枝 T 假定 其 在 第 i 段 与 第 i 段 连接处 有 一 分支 C ， 则 T 的 第 i 段 起始 参数 为 ， 末端 参数 为 ， 第 i 段 起始 参数 为 T 分支 C 的 起始 参数 为 （ 其中 虚线 箭头 表示 力 P 实线 箭头 表示 力矩 M ） 这样 要 使 分支 点 处于 平衡 状态 需 满足 ： 　 　 很 容易 得到 第 i 段 的 起始 参数 为 　 　 这样 第 i 段 获得 起始 参数 后 即可 继续 进行 数值积分 直至 树枝 的 末端 于是 得到 整条 树枝 的 运动 对于 分支 的 起始 参数 积分 完 i 段 后 暂停 积分 保存 参数 转而 去 积分 其 分支 获得 结果 后 把 参数 传给 第 i 段 继续 积分 由于 树木 是 天然 的 树形 结构 于是 一个 深度 优先 的 数值积分 遍历 即可 求得 整棵树 的 运动 这 就是 深度 优先 的 数值积分 遍历 算法 具体实施 时 从 树 的 主干 开始 进行 深度 优先 遍历 遇到 可动 枝条 即 对 该 枝条 及其 所有 分支 实施 深度 优先 的 数值积分 如此 继续 直至 所有 枝条 都 获得 数值积分 遍历 为止 参数 选择 　 　 工程 上 对于 树木 这种 材料 研究 的 很少 尤其 是 对 树 的 小枝 更是 无人 研究 我们 在 对 整棵树 进行 动态 模拟 时其 物理 参数 （ 杨氏模量 、 密度 、 半径 ） 将 无从 查询 只能 从 试验 中 进行 测试 因为 我们 追求 的 是 视觉效果 没 必要 达到 物理 上 的 真实 这样 ， 我们 就 可先 对 参数 进行 假定 得到 结果 后视 效果 如何 进行 必要 的 调整 最终 得到 所 要求 的 结果 经过 反复 试验 我们 所 使用 的 参数 可见 表 TableWillowsphysicalparameters 表 　 柳树 的 物理 参数 　 Yongsmodule ① Densityrelativevalue ② Radiusrelativevalue ③ Endbranch ④ eOnelevelupperbranch ⑤ eOnelevelmoreupperbranch ⑥ eOnelevelmoreupperbranche ① 杨氏模量 ② 密度 （ 相对值 ） ③ 半径 （ 相对值 ） ④ 末端 枝条 ⑤ 上 一级 枝条 ⑥ 再 上 一级 枝条 树枝 叶间 的 遮挡 关系 　 　 我们 知道 一棵 枝叶 茂密 的 树 对 风有 很 强 的 遮挡 作用 这种 遮挡 作用 对树 的 内部 、 后部 都 是 很 明显 的 我们 经常 可以 观察 到 ， 树 的 迎风 枝条 摆动 幅度 很大 ， 而 背风 枝条 摆动 幅度 很小 甚至 静止不动 因此 ， 对树 进行 动态 模拟 不能 忽略 这一 现象 根据 观察 分析 我们 可以 把 它 抽象 归结为 如下 几类 ： 无遮挡 ； 绕 圆柱体 流动 ； 孔洞 ； 狭长 缝隙 ； 透射 　 无遮挡 　 　 风在 流动 过程 中 没有 遇到 任何 遮挡 或 可 忽略 风力 无 衰减 文献 ［ ～ ］ 都 采用 这种 模型 　 绕 圆柱体 流动 　 　 假设 均匀 风势 函数 为 Q 从 左 至 右 流经 一 半径 为 a 的 圆柱 那么 在 圆柱 后面 风力 将 减弱 对应 一点 zxiy 为 复数 的 势函数 为 FigWindflowsaroundcylinder 图 　 风 绕过 圆柱体 　 　 对应 于 x 轴 y 轴 方向 的 速度 为 V ｛ uv ｝ gradf 经过 简单 计算 可 得 ， 在 距 圆心 ～ 倍 半径 以外 的 区域 ， 风力 将 恢复 到 ％ 以上 可以 认为 风力 得到 恢复 　 孔洞 　 　 当 风流 经 树枝 和 树叶 组成 的 孔洞 时 如图所示 孔洞 后 的 流场 可以 认为 是 一个 源流 场风 呈 放射状 往后 流走 流动 的 复势 为 Fig 　 Hole 图 　 孔洞 任 一点 的 径向速度 同时 ， 周向 分量 为 　 狭长 缝隙 　 　 有时 在 树枝 和 树叶 中间 会 有 一条 狭长的 缝隙 存在 风 穿过 其后 将 形成 一个 线源 场图 是 一个 长为 a 的 线源 场其流 函数 为 φ QRRFig 　 Narrowaperture 图 　 狭长 缝隙 其中 速度 　 透射 　 　 树 无论如何 茂盛 树枝 与 树叶 也 不 可能 把风 完全 遮挡住 作为 对 上述 种 情形 的 补充 和 修正 如果 一个 区域 被 枝叶 完全 遮挡 认为 也 会 有 部分 风力 穿透 而 过 能量 穿透 的 比例 取为 ％ 　 　 采用 如下 策略 来 求解 上述 遮挡 关系 ： 沿 风向 从前 向 后 把 树 所 覆盖 的 空间 分成 一定 数目 的 有 一定 厚度 的 薄片 高为 树高 宽 为 树 的 最大 宽度 把 每 一 薄片 划分 成 矩形网格 采用 OpenGL 的 自动 消隐 功能 及 Zbuffer 算法 思想 采用 单一 颜色 进行 平行投影 令 平行投影 的 远近 z 值 与 薄片 前 后面 与 眼 的 距离 对应 ， 即可 确保 落入 屏幕 缓存 的 是 薄片 所 覆盖 的 树枝 读出 缓存 后 分析 被 填充 的 程度 即可 确定 网格 被 覆盖 的 程度 分析 相邻 网格 的 覆盖 情形 即可 确定 上述 几种 遮挡 关系 如图所示 图中 abc 分别 在 其后 形成 点源 、 绕 圆柱 及线 流场 最终 的 流场 可 根据 势流 叠加 原理 而 获得 Fig 　 Obstructionrelationshipamongnets 图 　 相邻 网格 的 遮挡 关系 结 　 论 　 　 我们 在 文献 ［ ］ 的 基础 上 继续 深入 地 对 树 在 风中 的 摇曳 这一 现象 进行 了 计算机 模拟 提出 了 一个 深度 优先 的 数值积分 遍历 算法 使树 在 风 的 吹动 下 作为 一个 整体 在 运动 符合 物理 上 的 连续性 和 一致性 效果 是 逼真 的 作为 一个 整体性 的 算法 也 可 推广 至 其他 树种 比如 杨树 同时 还 深入 树 的 内部 分析 了 枝条 对风 的 遮挡 作用 获得 了 枝条 间 的 遮挡 关系 从而 使得 我们 对树 的 模拟 更加 逼真 、 自然 （ 如图所示 ） Fig 　 Somekeyframesinanimation 图 　 动画 序列 中 的 一些 关键帧 本文 研究 得到 国家自然科学基金 No 资助 冯金辉 年生 博士 主要 研究 领域 为 计算机 动画 虚拟 内窥镜 严涛 年生 博士生 主要 研究 领域 为 自然 景物 的 计算机 模拟 陈彦云 年生 博士生 主要 研究 领域 为 真实感图形 绘制 技术 吴恩华 年生 博士 研究员 博士生 导师 主要 研究 领域 为 计算机 图形学 CAD 冯金辉国 科学院 软件 研究所 计算机科学 开放 研究 实验室 　 北京 　 严涛国 科学院 软件 研究所 计算机科学 开放 研究 实验室 　 北京 　 陈彦云国 科学院 软件 研究所 计算机科学 开放 研究 实验室 　 北京 　 吴恩 华国 科学院 软件 研究所 计算机科学 开放 研究 实验室 　 北京 　 吴恩华 澳门大学 科学技术 学院 　 澳门 参考文献 ， MetaxasDTerzopoulosDDynamicdeformationofsolidprimitiveswithconstraintsComputerGraphicsSIGGRAPH ～ ， TerzopoulosDPlattJBarrAElasticallydeformablemodelsComputerGraphicsSIGGRAPH ～ ， BarzelRonenBarrAHAmodelingsystembasedondynamicconstrainsComputerGraphicsSIGGRAPH ～ ， CarignanMYangYingMagnenatThalmannNetalDressinganimatedsyntheticactorswithcomplexdeformableclothesComputerGraphicsSIGGRAPH ～ ， XuYingqingSuChengLiHuaetalPhysicallybasedsimulationofwatercurrentandwavesChineseJournalofComputerssupplement ～ 徐迎庆 苏成 李华 等 基于 物理 模型 的 流水 及 波浪 模拟 计算机 学报 增刊 ～ ， WanHuagenJinXiaogangPengQunshengPhysicallybasedrealtimefountainsimulationChineseJournalofComputers ～ 万华 根金小刚 彭 群生 基于 物理 模型 的 实时 喷泉 水流 运动 模拟 计算机 学报 ～ ， LiJiangPengQunshengAnewraytracingmethodbasedonthespecialtheoryofrelativityChineseJournalofComputers ～ 李江 彭 群生 基于 狭义 相对论 的 新 光线 跟踪 算法 计算机 学报 ～ ， ZhanYongzhaoSongShunlinSheJiangfengetalResearchandimplementonthemethodofmodelingoffacialexpressionanimationJournalofSoftware ～ 詹永照 宋顺林 佘江峰 等 脸部 表情 动画 建模 方法 的 研究 与 实现 软件 学报 ～ ， WejchertJHaumannDAnimationaerodynamicsComputerGraphicsSIGGRAPH ～ ， MikioShinyaAlainfournirestochasticmotionmotionundertheinfluenceofwindEUROGRAPHICS ～ ， HiromiOnoPracticalexperienceinthephysicalanimationanddestructionoftreesInThalmannDvandePanneMEdsComputerAnimationandSimulationNewYorkSpringerVerlag ～ ， FengJinhuiChenYanyunYanTaoetalGoingwithwindphysicallybasedanimationoftreesChineseJournalofComputers ～ 冯金辉 陈彦云 严涛 等 树 在 风中 的 摇曳 — — 基于 动力学 的 计算机 动画 计算机 学报 ～ 收稿 日期 ： 修稿 日期 ：