计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 第卷 第期 VolNo 一个 主动式 路由器 操作系统 ： AOSR 马洪军 　 张尧学 　 陈 　 桦 　 赵艳标 摘 　 要 　 主动式 网络 activenetwork 是 为 解决 当前 网络 基础设施 适应性 及 灵活性 差 、 服务 更新 困难 提出 的 一种 全新 的 网络 概念 它 是 一种 可编程 的 计算机网络 用户 可以 通过 在 网络 节点 运行 自己 的 定制 程序 ， 来 实现 对 “ 流 ” 经它 的 用户 数据 的 “ 特别 ” 处理 文中 提出 并 设计 了 一个 新 的 路由器 操作系统 ， 即 主动式 路由器 操作系统 AOSR 它 以 最大 限度 地 满足用户 服务质量 和 提高 系统资源 利用率 为 目标 ， 能 在 高速 、 安全 地 转发 数据包 的 同时 ， 为 用户 提供 一个 定制 程序 加载 、 数据 信息 定制 处理 的 主动式 网络 节点 运算 平台 关键词 　 路由器 ， 操作系统 ， 服务质量 中图法 分类号 　 TP ； TPANACTIVEOPERATINGSYSTEMFORROUTERMAHongJunZHANGYaoXueCHENHuaandZHAOYanBiaoDepartmentofComputerScienceTechnologyTsinghuauniversityBeijingAbstract 　 ActivenetworkisanovelnetworkconceptionwhichcansolvetheinadaptabilityandinflexibilityofnetworkinfrastructureinnovatingnetworkserviceseasyandspeedilyActivenetworkisaprogrammablenetworkwhichuserscaninjectcustomizedprogramsintoactivenodesandrunittoperformcustomizedcomputationontheusersmessagespassingthroughthemThepaperhereintroducesanewoperatingsystemanActiveOperatingSystemforRouterAOSRwhichcansatisfytheQualityofServiceQoSrequiredbyapplicationsasmuchaspossibleandimproveresourceutilizationofnetworknodeItprovidesanenvironmentforactivenodesforloadingandrunningtheuserscustomizedprogramswhileforwardingthedatapacketssafelyandrapidlyKeywords 　 routeroperatingsystemQualityofService 　 引言 　 　 路由器 操作系统 是 当前 网络 互连 的 关键设备 路由器 的 核心 软件 它 主要 负责 路由器 资源 的 管理 与 分配 、 数据包 的 寻址 及 转发 、 数据传输 的 安全 与 保密 、 以及 不同 物理 网络 PSDN 、 DDN 、 ISDN 、 以太网 等间 的 无缝 连接 　 　 路由器 操作系统 大致 可以 分为 两类 ， 一类 是 Cisco ， Bay ， Com 等 网络 公司 为 自己 的 路由器 产品 推出 的 专用 路由器 操作系统 ， 如 Cisco 公司 的 因特网 操作系统 IOSinternetoperatingsystem ； 另一类 是 以 DOS ， UNIX ， Windows 等 通用 操作系统 或 pSOS 等 嵌入式 实时操作系统 为 平台 ， 在 其 上 增加 了 相应 的 数据包 路由 、 安全 、 转发 等 功能模块 而 实现 的 通用 路由器 操作系统 ， 如 UNIXgatedgated 是 美国 Corenelluniversity 在 UNIX 基础 上 开发 的 寻径 程序 前者 对应 于 专用 的 总线结构 和 硬件 技术 ， 并且 它们 的 各个 组成部分 按照 路由器 的 工作 特点 进行 了 整体 优化 ， 因而 具有 很 高 数据 转发 速度 和 效率 后者 则 由于 受原 操作系统 的 制约 ， 数据 的 转发 速度 和 效率 相对 较 低 但 在 网络 功能 方面 ， 二者 并 无 多少 本质 的 不同 　 　 近年来 ， 随着 因特网 规模 的 不断扩大 ， 传统 的 以 传输 、 转发 数据 为主 的 路由器 操作系统 越来越 无法 满足用户 不断 发展 的 集成 服务 需求 ［ ］ 如何 解决 这 类 问题 是 因特网 和 传统 路由器 所 面临 的 严重 问题 之一 　 　 本文 结合 清华大学 和 桑达 公司 联合开发 成功 的 SED 路由器 ［ ］ 操作系统 ， 提出 并 设计 了 一种 主动式 路由器 操作系统 AOSRactiveoperatingsystemforrouter 该 系统 除了 具有 传统 的 路由器 操作系统 的 功能 之外 ， 还 能 根据 应用 的 服务质量 ［ ］ 延迟 、 抖动 、 失真 率 、 速率 、 优先级 、 服务类型 等 要求 ， 从 有关 端系统 或 服务器 中 下载 并 执行 相应 定制 程序 以 实现 对 数据 的 按 需 处理 ， 从而 更好 地 满足 应用 需求 ， 提高 网络系统 的 满意度 ［ ］ 　 主动式 网络 与 主动式 路由器 　 　 主动式 网络 activenetwork 是 以 应用 为 中心 ， 根据 应用 需要 而 调配 网络 软 、 硬件资源 的 计算 模式 当前 被 广泛应用 的 因特网 ， 除了 存在 着 地址 空间 不足 和 缺乏 有效 管理 方式 等 问题 外 ， 还 存在 着 在 现有 共享 网络结构 中 无法 根据 应用 需要 增加 新 的 技术 和 标准 如 多点 广播 、 RSVP 等 、 无法 容纳 新 的 服务 、 多 协议 层 冗余 处理 而 导致 的 性能 降低 等 问题 主动式 网络 就是 为 解决 这些 问题 而 提出 的 ［ ］ 主动式 路由器 是 构成 主动式 网络 的 关键设备 它 可 和 传统 路由器 一起 工作 ， 并 能 根据 用户 或 应用 的 要求 ， 动态 和 加载 程序 来 实现 对 数据流 的 相应 处理 图是 主动式 网络 数据 流程 示例 图 　 主动式 网络 数据 流程 示意图 　 　 主动式 路由器 有 两种 程序 加载 模式 ： 即 可编程 模式 programmingswitchapproach 和 包 封装 模式 capsuleapproach 在 可编程 模式 下 ， 程序 的 加载 一般 由 管理员 控制 ， 它 和 数据 的 处理 是 分开 的 ， 并且 数据包 格式 可以 和 现在 的 兼容 而 在 包 封装 模式 下 ， 数据包 的 格式 需作 相应 改变 ， 其内 同时 封装 着 程序 和 数据 当 它们 “ 流 ” 过 主动式 路由器 时 ， 包内 程序 被 加载 、 执行 　 主动式 路由器 操作系统 AOSR 　 　 AOSR 是 为 SED 系列 路由器 设计 的 新一代 主动式 路由器 操作系统 ， 其 硬件平台 是 Pentium 处理器 芯片 它 除了 支持 传统 路由器 的 高速数据 转发 外 ， 还 具有 安全 管理 、 服务质量 QoS 控制 、 程序 动态 加载 可编程 等 主动式 功能 另外 ， 为了 适应 协议 栈 、 物理 网络 的 多样性 ， 它 还 支持 开放式 网络接口 ， 以 保证 路由器 系统 的 开放性 为 完成 以上 功能 ， AOSR 包括 了 微内核 、 命令 接口界面 、 协议 软件 、 开放 网络接口 、 安全 管理 、 QoS 控制 、 可编程 支持 、 文件 管理 等 模块 ， 如图所示 图 　 主动式 路由器 操作系统 结构 　 　 路由器 操作系统 的 内存 管理 、 进程 线程 调度 以及 时钟 管理 等 方面 与 传统 的 多任务 操作系统 有 许多 相似之处 ， AOSR 在 这 几 部分 的 设计 与 实现 方面 主要 借鉴 了 LINUX 和 UNIX 系统 的 内核 实现 技术 　 　 下面 将 重点 介绍 AOSR 系统 主要 模块 的 基本功能 和 原理 ， 有关 实现 的 具体 细节 则 在 另 文中 论述 　 微内核 　 　 微内核 提供 系统 基本 的 资源管理 及 调度 服务 　 　 路由器 的 资源 主要 包括 CPU 、 内存 、 缓冲区 、 网卡 、 网络 输入输出 端口 等 物理 资源 和 进程 、 线程 、 队列 、 时钟 等 逻辑 资源 下面 分别 介绍 CPU 、 缓冲区 以及 网络 输入输出 端口 的 管理 与 分配机制 　 CPU 管理 与 调度 　 　 在 本 系统 中 ， CPU 的 运算 能力 用 CPU 处理 时间 来 衡量 ， 并 采用 两级 方法 进行 分配 和 调度 　 　 第一级 是 任务 进程 级 这 一级 将 CPU 处理 时间 除去 系统 固有 开销 在 各 协议 栈间 TCPIP 栈 、 SPXIPX 栈 进行 分配 、 调度 分配比例 可以 由 系统管理员 进行 策略 调整 ， 高度 采用 了 抢先 式 时间 片 轮询 方式 　 　 第二级 是 包 调度 级 这 一级 是 在 任务 级 基础 上 实现 的 它 将 分配 给 各 协议 栈 的 时间 片 在 各 数据流 间 进行 分配 、 调度 这种 分配 是 在 QoS 协商 时 完成 的 ， 其 高度 采用 了 加权 公平 队列 weightedfairqueuing 等 技术 ［ ］ 　 数据包 缓冲区 　 　 为了 提高 路由器 的 性能 ， 加快 数据包 的 转发 ， 路由器 中 大量 采用 数据 缓冲 技术 AOSR 在 LINUX 系统 的 段 页 式 内存 管理 基础 上 ， 创建 了 一个 动态 自 适应 数据包 缓冲区 ， 以 存储 和 转发 数据包 及 缓存 装有 可执行程序 的 数据包 　 　 缓冲区 采用 链栈 方式 管理系统 在 初始化 时为 每 一 类型 的 网络接口 创建 一个 数据包 缓冲区 链栈 缓冲区 的 大小 由 网络接口 的 最大 传输 单元 MTV 决定 ， 缓冲区 的 数量 由 系统 的 可用内存 空间 和 该类 缓冲区 的 使用 情况 共同 决定 　 　 属于 同一个 数据流 缓冲区 边 接到 一个 具有 一个 优先级 的 队列 ， 即该 数据流 的 接收 队列 AOSR 通过 对 接收 队列 长度 的 控制 以 实现 对 数据流 的 策略 控制 　 网络 输入输出 端口 管理 　 　 AOSR 采用 端口 开关 表来 管理 输入输出 端口 一个 网卡 包含 一个 或 几个 输入输出 端口 开关 表 的 每一项 对应 一个 输入输出 端口 的 控制结构 该 结构 记录 着 相应 端口 名称 、 状态 、 操作 函数 如 ： 初始化 函数 、 打开 函数 、 关闭 函数 、 收发 函数 、 状态 统计 函数 等 、 协议 栈 地址 、 输出 队列 等 当 对 一个 端口 进行 操作 时 ， 就 从 端口 开关 表中 查找 到 该 端口 的 控制结构 并 从中 调用 相应 的 操作 函数 　 命令 接口界面 　 　 命令 接口界面 提供 了 一个 与 CiscoIOS 命令 兼容 的 命令集 ， 用以 对 路由器 进行 监控 、 管理 和 配置 　 协议 栈 软件 　 　 AOSR 提供 了 多 协议 栈 支持 机制 任一 协议 栈 可 通过 和 开放 网络接口 的 链接 而 成为 系统 的 一部分 当前 AOSR 支持 TCPIP ， SPXIPX 两个 协议 栈 实现 的 相关 协议 有 ： IPIPXICMPPPPLCPPAPARPRIPOSPFTCPUDPSNMPTELNETRADIUS 等 在内 的 个 RFC 协议 　 开放 网络接口 　 　 开放 网络接口 分为 两个 部分 ， 即 和 各种 物理 网络 驱动程序 链接 的 界面 以及 和 高层 协议 栈 链接 的 界面 其 链接 原理 参与 了 Netware 网络 操作 的 ODI 开放 工 数据链 路 接口技术 ［ ］ 该 接口 不但 提供 了 针对 各种 通用 数据 链路层 协议 如 、 HDLC 等 开发 的 检测 、 识别 和 链接 接口 调用 ， 以 链接 各种 不同 的 物理 网卡 ， 还 提供 了 识别 和 链接 不同 协议 栈 的 各种 服务 ， 以 方便 协议 栈 的 安装 这样 ， 它 既 可 链接 各种 通用 网卡 ， 接收 并 转发 驱动程序 传递 来 的 数据包 到 相应 协议 栈 ， 又 可为 高层 协议 提供 服务 ， 将 它们 的 报文 识别 后交 相应 驱动程序 发送 　 驱动程序 　 　 驱动程序 是 路由 操作系统 中 最为 复杂 的 组成部分 之一 AOSR 理论 上 支持 各种 和 PCI 总线 兼容 的 网卡 驱动程序 目前 ， AOSR 主要 支持 IEEE 以太网 驱动程序 、 IEEE 令牌环 网 驱动程序 、 PPP 点到点 协议 同步 协议 及其 网卡 驱动程序 等 驱动程序 负责 接收 和 发送 报文 并 完成 相应 的 出错 处理 　 QoS 控制 　 　 QoS 控制 模块 负责 接收 、 转发 和 处理 有关 服务质量 控制 的 各种 数据 及 程序包 ， 包括 QoS 协商 、 资源 预约 与 分配 以及 QoS 监视 等 　 QoS 协调 及 资源 预约 　 　 QoS 控制 模块 接收 并 分析 来自 端系统 或 其他 路由器 系统 的 QoS 参数 包 这些 包中 带有 用户 要求 的 QoS 参数 延迟 、 抖动 、 丢失 率 、 平均 速率 、 峰值 速率 等 、 网络资源 变化 情况 或 相应 的 处理程序 等 　 　 如果 是 QoS 参数 ， 则 将 它 映射 为 对 系统资源 CPU 、 内存空间 、 缓冲区 、 带宽 的 需求 并 向 系统 微内核 进行 预约 如果 当前 资源 能 满足 QoS 需求 ， 则 准许 连接 建立 ； 否则 ， 连接 失败 然后 ， 向 用户 提示 当前 的 资源 状况 ， 以便 用户 重新 协商 请求 资源 有关 QoS 协商 的 详细 讨论 ， 请 参考文献 ［ ］ 　 　 如果 是 待 执行 程序包 ， 则 将 该 程序 存放 入 程序包 缓冲区 ， 并 对 它们 进行 组装 、 连接 和 重 定位 后 ， 交 调度 程序 高度 执行 　 QoS 监视 　 　 QoS 监控 部分 是 一个 后台 线程 它 有 两个 作用 ： 　 　 动态 监视 每个 应用 所 拥有 的 资源 是否 发生 了 变化 如 资源 丢失 、 失效 等 如果 发现 其 资源 低于 保证 用户 要求 的 QoS 的 最低 限度 时 ， 则 向 原 请求者 报告 资源 变化 情况 ， 并 由 原 请求者 自行决定 是 中止 当前 行为 ， 还是 对 QoS 进行 再 协商 ； 　 　 动态 监视 应用 的 变化 ， 如 应用 的 中止 、 应用 传送数据 的 速率 提高 或 降低 等 如果 一个 应用 中止 或 其 数据 速率 变化 超限 ， 则 启动 QoS 协商 程序 ， 以 重新 调整 和 分配资源 　 安全 管理 　 　 AOSR 提供 了 防火墙 、 存取 管理 等 安全控制 机制 　 防火墙 　 　 AOSR 实现 的 是 网络 级 IP 层 防火墙 它 能 根据 数据包 的 源地址 、 目的 地址 、 源 端口 、 目的 端口 及 协议 类型 等 信息 对 通过 的 数据包 进行 检查和 过滤 ， 从而 禁止 对 指定 主机 、 服务器 的 访问 或 防止 指定 用户 信息 的 外出 　 访问控制 　 　 AOSR 提供 了 登录 认证 、 程序 加载 认证 等 安全控制 机制 ， 以 防止 用户 对系统 重要 信息 、 资源 等 进行 非法 访问 、 占用 、 修改 甚至 破坏 　 　 登录 认证 包括 本地 认证 和 安全 服务器 的 远程 认证 两种 　 　 本地 认证 将 用户 输入 的 帐号 和 口令 与 本地 路由器 中 的 数据库 中 的 值作 比较 如果 一致 ， 则 认证 通过 ， 并 授权 用户 的 操作 范围 如果 不 一致 ， 则 拒绝 登录 　 　 远程 认证 将 用户 输入 的 帐号 和 口令 经 路由器 转发给 安全 认证 服务器 ， 由 认证 服务器进行 确认 ， 并 给出 授权 的 操作 范围 AOSR 的 远程 认证 实现 了 用户 拨入 服务 远程 认证 协议 RADIUS 　 　 程序 加载 认证 是 程序 加载 时 ， 对 加载 程序 的 用户 和 应用 进行 的 双重 确认 一般说来 ， 加载 程序 不但 要 占用 系统资源 ， 而且 可能 会 引起 系统 崩溃 因此 ， 路由器 必须 对 进行 程序 加载 的 用户 和 应用 进行 严格 的 限制 和 认证 目前 ， AOSR 的 程序 加载 仅限于 网络管理员 和 QoS 协商 过程 中 　 可编程 交换 机制 　 　 如 前面 所述 ， 主动式 路由器 有 两种 程序 加载 模式 鉴于 第一种 模式 能 在 保持 和 现在 的 数据包 格式 同时 ， 提高 网络 的 智能 ， 满足用户 对 数据 特殊 处理 要求 ， AOSR 实现 了 对 第一种 模式 的 支持 主要 支持 内容 包括 ： 　 　 对 编程 的 支持 AOSR 提供 数据包 操作 等 原语 ， 以供 编写程序 时 调用 要 加载 的 程序 应 编译成 可 动态 连接 、 可重 定位 的 目标 代码 　 　 对 程序 加载 的 支持 AOSR 具有 资源 预约 、 程序 加载 认证 、 动态 连入 和 删除 定制 程序 函数 模块 等 功能 　 结束语 　 　 路由器 操作系统 是 一种 为 网络 间 数据 包转发 而 设计 的 专用 操作系统 早期 的 路由器 操作系统 只 要求 具有 高 的 数据 转发 速率 和 路由 管理 功能 随着 网络 复杂性 以及 分布式 多媒体 应用 的 急剧 增加 ， 高 安全性 、 可扩展性 、 服务质量 QoS 保证 等 新 的 要求 出现 了 ， 这 就 激发 了 能 综合 考虑 和 调配 网络系统 资源 的 主动式 路由器 概念 的 出现 SED 系列 路由器 的 操作系统 AOSR 就是 一个 具有 主动 功能 的 路由器 操作系统 它 已 安装 于 SEDA 路由器 中 投入 市场 由于 主动式 网络 是 一个 全新 的 概念 ， AOSR 的 “ 主动 ” 功能 也 还 比较 弱 ， 我们 正在 加强 主动式 网络 的 互操作性 以及 资源 的 安全控制 和 管理 等 方面 的 研究 注 ： 本 课题 得到 “ 八 六三 ” 高技术 计划 、 国家教委 跨世纪 人才 基金 、 日本 富士通 研究所 基金 资助 作者简介 ： 马洪军 ， 男 ， 年月生 ， 博士 研究生 ， 研究 方向 为 路由器 操作系统 张尧学 ， 男 ， 年月生 ， 博士生 导师 ， 研究 方向 为 网络 互连 、 操作系统 、 服务质量 控制 等 陈桦 ， 男 ， 年月生 ， 博士 研究生 ， 研究 方向 为 服务质量 控制 赵艳标 ， 男 ， 年月生 ， 硕士 ， 助教 ， 研究 方向 为 网络 互连 等 作者 单位 ： 清华大学 计算机科学 与 技术 系 　 北京 　 参考文献 　 　 SteinmetzRNahrstedtKMultimediaComputingCommunicationsApplicationsBeijingTsinghuaUniversityPress 　 　 张尧学 ， 赵艳标 ， 盖峰 SED 路由器 高技术 通讯 ， ～ 　 　 　 ZhangYaoxueZhaoYanbiaoGaiFengSEDrouterHighTechnologyLettersinChinese ～ 　 　 陈桦 ， 张尧学 ， 马洪军 多媒体 服务质量 QoS 协商 控制系统 清华大学 学报 ， s ～ 　 　 　 ChenHuaZhangYaoxueMaHongjunMultimediaqualityofserviceQoSnegotiationmanagersystemJournalofTsinghuaUniversityinChineses ～ 　 　 ShenkerSFundamentaldesignissuesforthefutureinternetIEEEJournalonSelectedAreasinCommunications ～ 　 　 TennenhouseDSmithJSincoskieWetalAsurveyofactivenetworkresearchIEEECommunicationsMagazine ～ 　 　 ClarkDShenkerSZhangLSupportingrealtimeapplicationsinanintegratedservicespacketnetworkArchitectureandmechanismInProcSIGCOMM ′ ， ～ 原稿 收到 日期 ： ； 修改稿 收到 日期 ：