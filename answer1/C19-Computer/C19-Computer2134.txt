计算机 工程 COMPUTERENGINEERING 年 第卷 第期 volNo 在 WindowsNT 环境 下 实现 实时 可靠 的 数据通信 李志荣 　 　 随着 计算机网络 的 不断 发展 ， 以 TCPIP 为 底层 协议 的 基于 局域网 的 应用 系统 得到 了 用户 认可 。 这些 系统 不仅 实现 了 资源共享 ， 分布 处理 ， 而 最 关键 的 是 实现 了 实时 、 可靠 的 数据通信 ， 这 一点 对 数据交换 实时性 要求 高 的 系统 尤为重要 。 TCPIP 和 WindowsSockets 　 　 TCPIP 实际上 是 一个 协议 组 ， 是 一个 面向 连接 的 可靠 协议 ， 并 具有 重 排序 、 流量 控制 和 多路复用 等 功能 。 由于 TCPIP 是 可靠 的 协议 ， 对 传输 中 报文 丢失 和 错误 报文 都 自动 处理 ， 这样 在 数据通信 中 数据 可靠性 得到 了 保证 。 　 　 Sockets 最初 是 由 UCBerkeley 为 UNIX 操作系统 开发 的 网络 通信接口 ， 随着 Sockets 在 UNIX 中 成功 的 应用 以及 Windows 操作系统 的 广泛 普及 ， 人们 把 Sockets 移植 到 Windows 中 。 　 　 WindowsSocketsAPI 是 一套 开放 的 支持 多种 协议 的 Windows 的 网络 编程 接口 ， 它 包括 一个 标准 的 BerkeleySockets 功能 调用 的 集合 ， 以及 为 Windows 所作 的 重要 补充 。 在 TCPIP 网络 环境 下 的 应用程序 是 通过 网络系统 编程 界面 Sockets 实现 的 ， 而 Sockets 又 利用 下层 的 网络通信 协议 实现 实际 的 通信 工作 ， 它们 之间 的 关系 如图所示 。 图 WindowsSockets 关系 图 基于 Winsock 的 MFC 编程 　 　 目前 ， Winsock 有 Winsock 和 Winsock 两个 版本 。 它们 分别 适用 于位 和 位 的 Windows 操作系统 。 Winsock 只 支持 TCPIP 协议 ， 而 Winsock 可以 支持 多种 网络协议 ， 提供 能 处理 网络 上 大量 数据 的 独立 于 协议 的 接口 ， 如实 时 的 多媒体通信 ， 并且 容易 地 访问 多个 传输 协议 。 　 　 Windows 和 WindowsNT 中 都 已 包含 Winsock ， 以下内容 均 以 Winsock 为例 。 　 　 MFC 提供 两 种类 来 处理 WindowsSockets 网络通信 ， MFC 也 提供 两种 WindowsSockets 编程 模式 ： 字节 流 和 数据 报 。 两种 MFCWinsock 类 如下 ： 　 　 CAsyncSocket 　 　 该类 封装 了 WindowsSockets ， 并且 作为 网络通信 连接 的 一端 。 这个 类 提供 了 有关 WinsockAPI 的 面向对象 的 软件包 。 既 可以 直接 利用 Winsock ， 又 可以 利用 回调 函数 通知 网络 事件 的 发生 。 　 　 CSocket 　 　 这个 类 是从 CAsyncSocket 类中 派生 出来 的 ， 从 CAsyncSocke 中 继承 了 许多 成员 函数 ， 提供 了 更 高层 的 WinsockAPI 接口 。 Csocket 类 的 一个 特性 是 提供 了 自动 的 阻塞 blocking 处理 功能 。 两个 类 在 MFC 类 层次结构 中 的 位置 如图所示 。 图 MFC 类 层次结构 　 　 利用 Socket 类 编写 基于 面向 连接 的 应用程序 一般 采用 ClientServer 模型 。 服务 方 建立 一个 监听 的 Socket ， 侦听 客户 方 的 连接 请求 ， 然后 客户 方 建立 一个 请求 连接 的 Socket ， 这时 服务 方 接受 到 请求 ， 就 立刻 建立 一个 新 的 对应 此 客户 的 Socket ， 这样 数据链 路 就 建立 起来 了 ， 然后 服务 方 和 客户 方 就 可以 进行 数据交换 。 服务 方 和 客户 方 之间 建立 字节 流 的 通信 操作 时序 如下 ： 服务 方 客户 方 构造 一个 Socket 类 构造 一个 Socket 类 ClistenSocketSockSrvr ； CClientSocketSockClient ； 建立 SOCKET 套 接字 建立 SOCKET 套 接字 SockSrvrCreatenProt ； SockClientCreate ； 开始 监听 连接 请求 SockSrvrListen ； 请求 连接 SockClientConnectSrvrIp ， nPort ； 构造 一个 新 的 Socket 类 CClientSocketSocketClient ； 接受 连接 SockSrvrAcceptSocketClient ； 开始 通信 开始 通信 SockSrvrSendBuffer ， length ； SockClientReceiveBuffer ， length ； 或 或 SockSrvrReceiveBuffer ， length ； SockClientSendBuffer ， length ； 　 　 上述 CListenSocket 和 CClientSocket 是从 Csocket 类中 派生 出来 的 ， 下面 将 具体 介绍 。 这些 派生类 屏蔽 了 网络 底层 的 细节 ， 程序员 在 编程 时 只 需 在 子类 中 重写 OnAccept 、 OnReceive 和 OnClose 等 虚 函数 。 服务 方 通信 模块 　 　 服务 方有 两个 CSocket 的 子类 ： CListenSocket 和 CClientSocket 。 前者 用于 监听 网络连接 的 请求 CSocket 类 ， 后者 是 建立 对应 不同 客户 的 套 接字 ， 与 客户 方 进行 数据通信 的 CSocket 类 。 当 客户 方 的 连接 请求 来时 ， 服务 方 就 可以 建立 对应 此 客户 的 CClientSocket 类 ， 然后 用 此类 的 成员 函数 SendBuffer ， length 进行 数据通信 。 其中 Buffer 是 指向 发送数据 缓冲区 的 指针 ， length 是 发送数据 的 长度 ， 函数 返回值 是 实际 发送数据 的 字节数 。 　 　 CListenSocket 定义 如下 ： 　 　 classCListenSocketpublicCSocket 　 　 　 　 属性 　 　 publicCShengViewmpView 　 　 　 　 视类 的 指针 　 　 操作 　 　 public 　 　 CListenSocketCShengViewpView 构造函数 　 　 virtual ～ CListeningSocket 析构 函数 　 　 virtualvoidOnAcceptintnErrorCode 虚 函数 　 　 　 　 在 虚 函数 OnAcceptintnErrorCode 中 加入 用户 自己 的 处理 代码 如下 ： 　 　 voidCListenSocketOnAcceptintnErrorCode 　 　 　 　 接受 请求 消息 的 处理 代码 　 　 CSocketOnAcceptnErrorCode 　 　 mpViewProcessPendingAccept 调用 视类 的 成员 函数 进一步 处理 FDACCEPT 消息 　 　 　 　 CClientSocket 的 定义 如下 ： 　 　 classCClientSocketpublicCSocket 　 　 　 　 属性 　 　 public 　 　 CShengViewmpView 　 　 　 　 　 　 　 视类 指针 　 　 操作 　 　 public 　 　 CClntsockCShengViewmpView ； 构造函数 　 　 virtual ～ CClntsock 　 　 　 　 　 析构 函数 　 　 virtualvoidOnReceiveintnErrorCode ； 虚 函数 　 　 virtualvoidOnCloseintnErrorCode 虚 函数 　 　 　 　 在 虚 函数 OnReceiveintnErrorCode 中 加入 用户 自己 的 处理 代码 如下 ： 　 　 voidCCSocketOnReceiveintnErrorCode 　 　 　 　 数据 接受 消息 的 处理 代码 　 　 CSocketOnReceivenErrorCode 　 　 mpViewProcessPendingReadthis 调用 视类 的 成员 函数 进一步 处理 FDREAD 消息 　 　 在 虚 函数 OnCloseintnErrorCode 中 加入 用户 自己 的 处理 代码 如下 ： 　 　 voidCClntsockOnCloseintnErrorCode 　 　 　 　 关闭 连接 消息 的 处理 代码 　 　 CSocketOnClosenErrorCode 　 　 mpViewCloseSocketthis 调用 视类 的 成员 函数 进一步 处理 FDCLOSE 消息 　 　 客户 方 通信 模块 　 　 客户 方 包含 一个 CClientSocket 类 。 这个 类 和 服务 方 的 CClientSocket 类 是 一样 的 。 客户 方比 服务 方 缺少 了 监听 的 CSocket 类 。 当 数据链 路 建立 好时 ， 客户 方 就 可以 和 服务 方 进行 数据交换 ， 接受 数据 时 可以 用 此类 的 成员 函数 ReceiveBuffer ， length 来 接受 。 其中 Buffer 是 指向 接收数据 缓冲区 的 指针 ， length 是 接收数据 缓冲区 的 长度 ， 函数 返回值 是 实际 接收数据 的 字节数 。 应用 实例 　 　 按照 上述 方法 ， 开发 了 基于 局域网 在 WindowsNT 环境 下 的 微机联锁 软件测试 系统 。 该 系统 包括 主控 机 、 仿真机 和 数据库机 ， 并 提供 了 与 被 测 对象连接 的 网络接口 ， 建立 了 条 数据链 路 进行 不同 主机 的 数据交换 ， 在 数据通信 中 保证 了 测试 所 要求 的 实时性 、 可靠性 。 系统 的 网络结构 如图所示 。 图 测试 系统 的 网络结构 结束语 　 　 在 WindowsNT 环境 下 ， 通过 VC 利用 MFC 实现 基于 TCPIP 的 网络 编程技术 ， 其 数据通信 实时 、 可靠 ， 网络接口 的 扩展性 强 。 相信 随着 InternetIntranet 迅速 发展 ， Winsock 技术 将 在 要求 数据通信 实时性 和 可靠性 高 的 大型 系统 中 得到 了 广泛 的 应用 。 作者 单位 上海 铁道 大学 计算机系 上海 参考文献 NortonP ， McGregorR 著 ， 孙凤英 ， 魏军 ， 徐京 译 MFC 开发 WindowsNT 应用程序 北京 ： 清华大学出版社 ， GregoryK 著 ， 康博 创作室 译 VisualC 开发 使用手册 北京 ： 机械 工业 出版社 ， ThompsonRD 著 ， 前导 工作室 译 MFC 开发人员 参考手册 北京 ： 机械 工业 出版社 ， VisualChelpdocumentMicrosoftCorp ，