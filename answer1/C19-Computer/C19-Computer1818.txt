微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 　 No 　 No 　 P 硬盘 写 保护 方案 伍红兵 　 沈鑫 剡 摘要 ： 各种 硬盘分区 写 保护 方案 以及 各种 方案 的 优缺点 。 关键词 ： 硬盘 写 保护 TSR 程序 写 保护 　 　 在 大专院校 的 公共 机房 以及 政府 、 公司 、 企业 的 重要 部门 的 计算机管理 中 ， 往往 采用 硬盘分区 写 保护 的 方法 来 保护 系统 及 数据 。 在 各种 方案 中 ， 有 的 基于 软件 ， 有 的 基于 硬件 ， 有 的 则 采用 软硬 结合 的 方法 。 本文 旨在 介绍 各种 方案 及其 利弊 ， 以 供参考 。 基于 中断 驻留 程序 的 写 保护 方案 　 　 这种 方案 实现 起来 较 简单 ， 全部内容 就是 个 TSR 程序 ， 加 在 自动 批处理 文件 中 ， 开机 即 被 执行 ， 接管 INT 并 驻留 内存 。 当 程序 访问 硬盘 时 ， 写 保护 程序 先 判断 操作 是 读 还是 写 ， 若 是 写 则 还要 判断 是否 写 合法 分区 ， 若 不是 则 中断 返回 或 给出 提示信息 。 程序流程 见图 所示 。 图 接管 后 的 ITN 　 　 实际 使用 时 ， 一般 把 计算机硬盘 分为 个 以上 的 分区 ， 系统 以及 重要 的 数据 安装 在 C 分区 上 ， 用户 数据 保留 在 扩展 分区 上 ， 写 保护 软件 只 对 C 分区 写 保护 。 这种 方法 对 Windowsx 也 有效 （ 但 最好 把 虚拟内存 设置 在 扩展 分区 上 ） 。 因为 操作系统 往往 设置 有 较大 的 磁盘 缓冲区 ， 用户 可以 对 写 保护 的 分区 进行 正常 的 读写操作 ， 比如 删除 或 拷贝 文件 ， 甚至 是 格式化 和 分区 ， 表面 上 操作 很 正常 ， 但 重新 开机 ， 写 保护 分区 又 复原 了 。 　 　 在 机房 管理 中 ， 为 尽量减少 写 保护 软件 对系统 及 使用者 的 影响 ， 也 可以 把 操作系统 和 应用软件 安装 在 未 写 保护 的 分区 上 ， 比如 D盘 ， 再 备份 到 C 分区 上 ， 然后 对 C盘 写 保护 。 这样 一旦 D盘 的 系统 被 损坏 ， 可以 从 C盘 快速 恢复 。 这种 方案 简单易行 ， 除了 可以 防止 人为 操作失误 外 ， 也 可以 防止 一般 病毒 的 破坏 。 缺点 是 不够 隐蔽 。 有些 病毒程序 专门 对付 这种 保护 软件 ， 通过 设置 单步 中断 等 方法 跟踪 到 原来 的 INT 入口 ， 通过 长 调用 绕过 写 保护 程序 。 因此 ， 对 病毒 的 防范 不是 很 理想 。 修改 硬盘 BOOT 区 的 写 保护 软件 　 　 硬盘 BOOT 区 包含 BOOT 区 程序 和 硬盘分区 表 。 BOOT 区 程序 搜索 可 启动 操作系统 分区 的 标志 H ， 搜索 成功 则 读取 引导 分 区内 的 操作系统 的 引导 扇区 ， 并 把 控制权 交给 引导 扇区 程序 。 　 　 为 实现 硬盘 写 保护 ， 改写 BOOT 的 程序 ， 使 之 完成 以下 工作 ： 　 　 ． 修改 INT 入口 ， 使 之 指向 写 保护 驻留 程序 ； 　 　 ． 驻留 写 保护 程序 ； 　 　 ． 执行 正常 的 BOOT 程序 功能 。 　 　 这里 有 几个 关键问题 要 注意 ： 　 　 ． 因为 BOOT 区 程序 先于 DOS 启动 ， 不能 用 MS － DOS 提供 的 INTAH ＝ H 及 INTAH ＝ 来 取得 和 设置 中断 服务程序 ， 因此 ， 必须 直接 修改 中断向量 表 。 　 　 ． 要 使 中断 服务程序 安全 运行 ， 就 必须 使 中断 服务程序 常驻 内存 ， 以免 被 其它 程序 覆盖 。 但 写 保护 程序 先于 DOS 启动 ， 无法 利用 INTAH ＝ H 来 驻留 程序 。 因此 必须 另辟蹊径 。 方法 是 将 BIOS 数据 区 ： H 记载 内存大小 的 数据 减少 KB ， 使 DOS 以为 常规 内存 的 底端 由 KB （ 或 小于 KB 的 其它 值 ， 取决于 写 保护 程序 大小 ） 开始 ， 而 把 硬盘 写 保护 程序 搬至 K 至 K 之间 即可 。 情形 如图所示 。 图写 保护 程序 加载 情况 　 　 ． 完成 以上 代码 往往 大于 B ， 因此 一般 把 程序 分布 在 磁道 的 多个 扇区 中 ， 并 由 BOOT 区 的 程序 启动 时 装配 。 　 　 ． 保护 程序运行 时 ， 以前 的 分区表 信息 和 BOOT 区 程序 仍然 需要 ， 应 把 它们 放在 磁道 的 某个 扇区 中 。 新 的 INT 服务程序 把 访问 磁道 BOOT 区 的 操作 都 定向 到 以前 的 BOOT 区 内容 的 备份 扇区 中 ， 使 操作系统 及 用户 感觉 不到 BOOT 区 信息 有 什么 异常 （ 但 Windowsx 知道 ） 。 　 　 新 的 写 保护 程序 先于 操作系统 加载 ， 因此 这种 方案 较前 一种 更为 隐蔽 。 同时 ， BOOT 区 已 不再 是 以前 的 正常 信息 ， 即 使用 软盘 启动 ， 也 因 无法 看到 分区表 信息 而 无法 看到 硬盘 ， 提高 了 安全性 。 这种 方案 的 缺点 是 仍 无法 挡住 有 针对性 的 病毒 的 攻击 ， 对 一些 恶意 攻击者 来说 ， 也 较 容易 攻破 。 固化 的 写 保护 程序 　 　 这种 方案 是 对 前个 方案 的 进一步 改进 。 改 方案 是 把 写 保护 程序 烧 在 EPROM 中 ， 并 以 接口卡 的 形式 安装 在 扩展槽 内 ， 成为 扩展 的 BIOS ， 因此 ， 除 具有 前者 的 所有 优点 以外 ， 安全性 更高 ， 用 软盘 启动 ， 也 无法 写受 保护 的 硬盘分区 。 缺点 是 仍然 无法 挡住 有 针对性 的 病毒 及 人为 的 攻击 。 直接 修改 主板 上 的 BIOS 　 　 这种 方案 是 把 BIOS 代码 从 EPROM 中 读出来 ， 找到 其中 关于 磁盘 读写 的 代码 ， 直接 修改 INT 的 处理程序 ， 使 其 具有 硬盘分区 写 保护 的 功能 。 因为 不同 的 机型 的 BIOS 代码 差别 较大 ， 不同 的 机型 要 进行 相应 的 修改 ， 因此 这种 方案 有 相当 的 难度 ， 而且 兼容性 很难 保证 ， 但 效果 较 好 ， 某些 跟踪 INT 原始 入口 的 病毒 也 无法 攻破 。 　 　 这种 方案 并 不是 攻不破 的 ， 有些 病毒程序 有 自己 的 INT ， 具有 直接 写 端口 的 能力 ， 它 能 直接 读写 与 硬盘 有关 的 F ～ F 端口 ， 对于 这种 病毒 ， 任何 基于 软件 的 写 保护 程序 都 形同虚设 。 因此 ， 必须 寻找 基于 硬件 的 硬盘 写 保护 方案 。 基于 硬件 写 保护 的 硬盘 写 保护卡 　 　 这种 方案 实实在在 地 给 硬盘 加上 了 写 保护 。 其 思路 是 ， 不论 高层 如何 访问 硬盘 ， 最终 都 归结为 对 端口 F ～ F 的 读写 。 可以 通过 硬件 过滤 对 这些 端口 的 读写 ， 当 发现 有 写 磁盘 命令 ， 并且 是 写 受 保护 的 分区 时 ， 拦截 该 信号 ， 并 给 硬盘 控制器 个 伪造 的 命令 ， 比如 寻 道 命令 。 这样 ， 无论 什么样 的 病毒 或 人为 的 破坏 ， 都 无法 攻破 。 对于 需外 接 多功能 卡 的 主板 （ 如 以下 的 机型 ） ， 从 总线 扩展槽 上能 获得 所有 对 硬盘 的 读写操作 信号 ， 可以 设计 如图所示 的 硬卡 插 在 扩展槽 中 ， 实现 硬盘分区 写 保护 。 其 原理 见图 。 图 第一种 基于 硬件 的 硬盘 写 保护 方案 　 　 对于 以上 的 计算机 ， 多功能 卡制作 在 主板 上 ， 硬盘 读写 信号 不再 出现 在 总线 扩展槽 中 。 可以 对 前种 方案 稍加 改进 ， 并 从 IDE 接口 电缆 上 获得 硬盘 读写 信号 。 其 原理 见图 。 图 第二种 基于 硬件 的 硬盘 写 保护 方案 Y 进一步 的 设想 　 　 从 以上 各种 方案 来看 ， 基于 软件 的 硬盘 写 保护 方案 成本低 ， 但 安全性 较差 ； 基于 硬件 的 硬盘 写 保护 方案 ， 成本 高 ， 但 安全性 很强 。 从 技术 的 角度 来看 ， 仍然 有 基于 软件 的 方案 可以 达到 类似 于 硬件 的 写 保护 效果 。 笔者 初步 的 想法 如下 ： 　 　 以上 的 CPU 都 支持 保护模式 。 保护模式 中 可以 设置 IO 空间 保护 。 方法 是 在 EFLAGS 寄存器 中 设置 IOPL 字段 ， 同时 在 TSS 中 设置 相应 的 I ／ O 许可 位 图 。 从而 控制 对 硬盘 所有 端口 的 访问 。 也 可以 控制 访问 CMOS 端口 H 、 H ， 防止 人为 地 破坏 CMOS 信息 ， 迫使 用户 只能 从 C盘 启动 。 在 方案 的 基础 上 ， 让 写 保护 软件 首先 启动 并 进入 保护模式 ， 设置 相应 的 系统 表 ， 然后 加载 操作系统 ， 从而 实现 硬盘 写 保护 。 著名 的 调试 软件 SOFT － ICE 就 利用 了 类似 的 方案 来 截获 对 端口 的 访问 。 当然 ， 这一 方案 的 编程 难度 较大 。 伍红兵 （ 南京 工程兵 工程学院 计算机 教研室 ） 沈鑫 剡 （ 南京 工程兵 工程学院 计算机 教研室 ） 收稿 日期 ： － －