微型机 与 应用 MICROCOMPUTERITSAPPLICATIONSVolNoPSybase 多表 复杂 关联 数据 的 传输 王双成 　 鲁明羽 　 陆玉昌 摘要 ： 讨论 了 多表 复杂 关联 数据 的 传输 问题 ， 给出 了 避免 传输 错误 的 有效 方法 。 关键词 ： 数据完整性 数据传输 多表 关联 主码 外码 本文 以 “ 九五 ” 国家 重点 科技 攻关项目 “ 网络化 国家 重点 实验室 管理信息系统 ” 为 背景 ， 阐述 了 多表 复杂 关联 数据 的 传输 问题 。 在 该 系统 中 ， 各 客户端 站点 需向 中央 服务器 传输 多种 具有 复杂 关联 的 数据表 。 由于 受 Sybase 数据库 数据完整性 的 制约 ， 如果 传输 次序 不 正确 ， 容易 造成 某些 表 的 整表 数据 或 一些 表 的 部分 记录 的 丢失 。 下面 从 数据传输 环境 、 数据组织 、 数据表 排序 、 数据传输 、 出错 处理 个 部分 阐述 多表 复杂 关联 数据 的 传输 处理过程 。 数据传输 环境 　 　 国家教委 服务器端 的 网络操作系统 采用 WindowsNT 中文版 ， 而 下属 各 国家 重点 实验室 作为 客户端 ， 其 操作系统 平台 为 Windows ／ 。 　 　 数据库 管理系统 采用 的 是 Sybase 。 这是 一个 开放 的 对象 关系 型 数据库 管理系统 ， 可 为 用户 提供 个 高性能 、 开放 的 、 分布式 的 、 端到 端的 体系结构 ， 能 满足 网络 中 关键 任务 的 专业化 应用 开发 需求 。 　 　 选择 PowerBuilder （ PB ） 提供 的 数据 管道 作为 传输 工具 ， PowerBuider 是 SybasePowersoft 系列 工具 的 个 重要 组成部分 ， 具有 简化 的 组件 技术 、 增强 的 Web 支持 、 完全 的 开放 技术 和 极 高 的 开放 效率 等 显著特点 ， 适合 于 开发 基于 组件 的 分布式应用 。 数据组织 　 　 如果 源 数据库 和 目的 数据库 是 同构 的 ， 则 可以 直接 建立 数据 管道 ， 处理 起来 比较简单 。 但 在 此 系统 中 ， 国家教委 的 数据表 存放 的 是 所有 国家 重点 实验室 的 数据 ， 因此 源 数据库 和 目的 数据库 对应 的 数据表 具有 不同 的 结构 。 　 　 源 数据组织 　 　 为 使源 数据库 表中 的 记录 传输 到 目的 数据库 对应 表后 具有 唯一 的 标识 ， 采用 了 下面 的 处理 方法 ： 从 基本 情况表 中 抽取 实验室 代码 和 分室 代码 并 存入 个 辅助 表中 这个 表只 存放 个 记录 ； 将 这 一 辅助 表 分别 和 每 一 数据表 连接 ， 产生 对应 的 视图 作为 源 数据 数据包 。 每个 表中要 有 传输 日期 字 段 ， 其 数据 靠 程序 从 界面 读入 ， 以便 既 可以 传输 新 数据 添加 ， 又 可以 传输 历史数据 更新 ， 并 可以 随时 进行 数据传输 。 　 　 目的 数据组织 　 　 系统 采用 PB 数据 管道 的 更新 ／ 添加 方式 进行 数据传输 。 这种 方式 是 按 目的 数据库 对应 表 的 主码 进行 检索 ， 如果 没有 一致 的 主码 就 进行 添加 ， 若有 一致 的 主码 则 进行 更新 。 这样 就 要求 在 目的 数据库 的 每 一个 数据表 中 必须 把 实验室 代码 和 分室 代码 加入 主码 中 ， 即 每 一个 数据表 要 含有 实验室 代码 和 分室 代码 个 字 段 并且 是 表主码 的 组成部分 。 数据表 排序 　 　 数据库 管理系统 所 进行 的 数据完整性 检验 ， 主要 有 单表 的 数据 一致性 检验 和 多表 之间 的 关联 一致性 检验 。 这里 涉及 的 表与表 之间 的 关联 一致性 检验 就是 对 有 关联 的 表 进行 主码 外码 对应性 检查 。 大家 知道 ， 个表 只能 设置 个主码 ， 且 主码值 必须 唯一 ， 即表中 的 记录 由主码 值 唯一 确定 ； 外码 是 在 建立 关联 的 过程 中 由 非主码 的 字 段 定义 的 ， 其值 或者 设置 成 空值 ， 或者 等于 对应 主码值 ， 此即 数据 的 参照 完整性 。 个表 的 主码 可以 不 与 任何 表 关联 ， 也 可以 和 多个 表 的 对应 外码 相联 ， 而个表 的 个 外码 必须 且 只能 和 个表 的 主码 相联 。 没有 主码 的 数据表 可以 任意 地 传输 。 　 　 数据表 可 分成 大 类 ， 一类 是 由 有 主码 而 无 外码 的 数据表 组成 ， 其中 包括 主码 与 其它 表 的 外码 没有 关联 及主码 与 其它 表 的 外码 有 关联 二种 情况 ； 另一类 是 由 既有 主码 又 有 外码 的 数据表 组成 ， 其中 也 包括 主码 与 其它 表 的 外码 没有 关联 及主码 与 其它 表 的 外码 有 关联 二种 情况 。 　 　 经过 对 传输 过程 中 出现 的 某些 表 部分 记录 丢失 情况 进行 仔细分析 后 发现 ： 个表 的 外码 值 允许 为空 是 造成 数据 丢失 的 原因 之一 ， 且 在 实际上 并非 必须 为空 。 因此 应将表 外码 设置 成 不 允许 为空 。 　 　 数据 丢失 的 另 一个 主要 原因 是 表 传输 顺序 错误 。 为了 解决 这一 问题 ， 提出 了 在 传输 前 对 数据表 按 关联 关系 进行 排序 的 解决 方法 。 排序 过程 ： 　 　 第一步 ， 先 任意 地 排序 第一类 表 ， 即 把 第一类 表排 在 整体 表 序列 前部 ； 　 　 第二步 ， 逐个 排序 第二类 表 ， 任意 地取 个 第二类 数据表 如其 外码 与 其它 数据表 的 主码 相关联 ， 用 PB 展示 出 如图所示 选定 数据表 的 向下 关联 全图 ， 自 底向上 排 ： 先 考察 表 ， 如果 该表 没有 排过序 则 按序 排上 该表 ， 如果 该表 已排 过序 就 跳 过 该表 ； 接下来 考察 表 ， 与 处理表 的 方法 相同 。 同 层次 的 表 顺序 不 限 ， 如表和表 的 顺序 任意 。 不同 层次 的 数据表 要 严格 按照 自下而上 的 原则 ， 直至 把 最 上面 的 根 表表 排完 为止 ， 再 选择 第二个 第二类 表 ， 用 同样 的 方法 排序 ， 直到 排完 所有 的 第二类 数据表 ， 这样 就 把 所有 的 数据表 排 了 序 。 图 　 数据表 的 向下 关联 全图 　 　 具体 实现 时 ， 采用 的 方法 是 根据 数据表 向下 关联 全图 ， 利用 拓朴 排序 算法 编程 ， 自动 产生 表 传输 顺序 ， 也 允许 用户 人工 制订 次序 。 这里 的 拓朴 排序 算法 简要 描述 如下 ： 　 　 （ ） 根据 数据表 向下 关联 全图 ， 建立 其 邻接 表 存储 结构 ， 且 在 其 邻接 表 的 头 结点 中 增加 个 存放 顶点 入度 的 数据 域 。 邻接 表中 每个 顶点 对应 图中 的 个 数据表 结点 ， 有个 数据 域 存放 表名 ； 　 　 　 （ ） 建立 入度 为 零 的 顶点 链栈 S ； 　 　 （ ） 如 S 非空 ， 转 （ ） ， 否则 转 （ ） ； 　 　 （ ） 将 S 的 栈顶 V 对应 的 表名 T 输出 到 队列 Q ； 　 　 （ ） 将 所有 其 外码 与 T 的 主码 相联 的 数据表 的 对应 顶点 入度 减 ， 且 减后 如其 入度 为 零则 压入 S ， 转 （ ） ； 　 　 （ ） 逐个 输出 队列 Q 中 的 诸表名 即 为 所求 的 数据表 传输 顺序 。 数据传输 　 　 在 PB 中 处理 数据传输 问题 主要 有种 常用 的 方式 ： 一种 是 通过 用户 编程 来 实现 。 把源 数据表 中 需要 传输 的 记录 读 到 数组 ， 再 传输 到 目的 数据库 中 ， 数组 起着 缓存 的 作用 。 这种 方式 适用 于 要求 对源 数据 进行 复杂 处理 且 传输 的 数据量 比较 小 的 数据传输 问题 ， 非常灵活 ， 几乎 可以 满足 各种 需求 ， 只要 通过 编程 即可 实现 ， 但 编程 工作量 比较 大 ， 而且 程序调试 困难 ； 另 一种 是 通过 PB 提供 的 数据 管道 来 实现 。 首先 要 组织 好源 数据 ， 之后 建立 数据 管道 ， 最后 用 程序 调用 数据 管道 。 这种 方式 实现 简单 、 可靠 ， 而且 容易 调试 ， 适用 于 大量 的 、 不 需要 复杂 处理 的 数据传输 ， 但 不如 利用 程序 传输 灵活 。 此 二种 方法 各有利弊 ， 需 根据 实际 情况 做出 选择 。 出错 处理 　 　 在 传输 调试 过程 中 可能 出现 的 错误 主要 有 ： 　 　 （ ） 一些 数据表 没有 传输 过去 （ 原因 是 表 传输 顺序 错误 ） ； 　 　 （ ） 某些 表 的 部分 记录 没有 传输 过去 （ 由于 数据完整性 错误 或 外码 错误 ） ； 　 　 （ ） 程序 调用 错误 ； 　 　 （ ） 管道 错误 ； 　 　 （ ） 源 数据表 和 目的 数据表 的 结构 不 匹配 等 。 　 　 解决 的 办法 ： 　 　 （ ） 确保 源 数据表 具有 正确 的 排序 ； 　 　 （ ） 确保 外码 的 设置 是 不 允许 取 空值 的 ； 　 　 （ ） 确保 调用 管道 的 程序 没有 问题 （ 程序 比较简单 ， 容易 保证 ） ； 　 　 （ ） 对 每 一个 管道 应 单独 手工 调试 ， 确保 没有 问题 之后 再 由 程序 进行 调用 ； 　 　 （ ） 如果 源 数据表 和 目的 数据表 的 结构 不 一致 ， 那么 最好 是 把 源 数据组织 成 与 目的 数据表 的 结构 一致 的 逻辑 表 （ 视图 ） 作为 管道 中 的 源 数据表 。 　 　 本文 介绍 了 Sybase 数据库 多表 复杂 关联 下 的 数据传输 处理 方法 和 防止 数据 丢失 措施 ， 简要 描述 了 数据 关联 约束 传输 的 数据表 拓朴 解决方案 ， 并 已 在 实际 工作 中 进行 了 测试 和校验 。 这些 方法 和 措施 不仅 适用 于本 课题 ， 而且 对 类似 项目 也 有 一定 的 借鉴 作用 。 王双成 （ 北京 清华大学 计算机科学 与 技术 系 ） 鲁明羽 （ 北京 清华大学 计算机科学 与 技术 系 ） 陆玉昌 （ 北京 清华大学 计算机科学 与 技术 系 ） 参考文献 ， WordenDSybaseDeveloper ＇ sGuideSamsPublishing ， ， HatfieldB 著 ， 史森译 PowerBuilder 应用 程序开发 指南 北京 ： 清华大学出版社 ， 收稿 日期 ： － －