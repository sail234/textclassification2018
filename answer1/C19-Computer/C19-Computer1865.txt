微型机 与 应用 MICROCOMPUTERITSAPPLICATIONSVolNoP 分布式 容错 时间 同步化 系统 的 误差 分析 欧阳 珣 　 李榕 　 方维 坚 　 　 摘 　 要 ： 分布式 容错 时间 同步化 系统 是 为了 解决 分布式 环境 中 的 各种 计算机 同步 问题 的 一种 工具 。 但是 由于 在 时间 同步 上 存在 着 很多 误差 大大 地 影响 了 时间 同步化 的 精度 。 本文 较为 详细 地 分析 了 误差 产生 的 主要 原因 并且 根据 实验 提出 了 解决 误差 问题 的 建议 和 方法 。 　 　 关键词 ： 分布式 容错 时间 同步化 系统误差 分析 分布式 容错 时间 同步 策略 简介 　 　 目前 有 许多 的 应用领域 需要 依靠 电脑 的 高可靠性 和 高效率 来 精确 掌握 关键性 的 工作 与 任务 例如 航管 系统 、 医疗 监视系统 以及 核能 发电 系统 等等 。 这 类 系统 无法 容许 任何 的 错误 产生 。 以往 传统 的 设计 与 要求 已 不 适合 在 如此 严格 的 环境 下 运作 因此 如何 精确 地 掌握 错误模式 与 影响 程度 是 一个 相当 重要 的 问题 。 　 　 随着 计算机网络 技术 的 发展 与 主从 结构 （ clientserver ） 观念 的 提倡 比 中央集权 式 （ centralizedprocessing ） 更 有 弹性 、 成本 更 低 的 分布式 处理 结构 （ distributedprocessing ） 已 为 现今 众多 系统 所 采用 。 “ 分布式系统 容错 ” （ faulttoleranceindistributedsystems ） 就是 探讨 容错 技术 在 分布式系统 中 的 应用 。 随着 网络 技术 的 发展 单机 单工 系统 日益减少 取而代之 的 是 多 机多工 的 分布式 电脑系统 。 分布式系统 中 主要 的 元件 如 处理器 、 通信 网络 、 计时器 、 资料 储存 装置 及 软件 等 这些 都 是 单一 独立 的 元件 并且 这些 典型 的 元件 通常 不会 考虑 容错 。 但 事实上 在 分布式系统 中 这些 元件 都 是 以 相互合作 的 方式 在 运作 不 可能 脱离 其它 元件 而 独立 因而 这些 元件 的 容错 能力 决定 了 分布式系统 容错 能力 是 分布式系统 容错 主要 的 研究 范畴 。 而 “ 时间 同步化 ” 正是 分布式系统 容错 中 相当 重要 的 课题 。 　 　 在 目前 的 分布式系统 的 时间 同步 上 存在 着 技术 上 的 困难 与 限制 无法 达成 真正 的 时间 同步化 。 因为 在 分布式 环境 中 每个 节点 都 有 自己 的 计时器 而 每个 计时器 的 进行 速率 不 可能 全部 一致 很难 达成 所有 系统 节点 时间 上 的 绝对 同步 分布式系统 中 的 时间 同步化 往往 要 参考 其它 节点 的 时间 来 进行 修正 而 要 取得 参考 时间 的 资料 必须 要 通过 通信 网络 的 传递 。 实际 通信 网络 的 信息 传递 一定 会 有 时间 上 的 延迟 （ propagationdelay ） 参考 时间 在 分布式 环境 中 传输 的 正确性 也 会 严重 影响 系统 时间 同步 。 分布式 容错 的 时间 同步化 策略 与 算法 相当 多 基本上 可 分为 以下 三大 类型 。 主仆 式 及 时间 服务器 的 时间 同步化 策略 　 　 主仆 式 及 时间 服务器 时间 同步化 策略 在 分布 系统 中是 最 直接 、 最 简单 也 是 最 广泛 被 应用 于 分布式系统 中 达到 时间 同步化 的 方法 。 其 策略 就是 在 系统 中 建立 个 或 若干个 具有 高 可信度 与 有效 度 的 时间 服务器 而 系统 中 其它 的 节点 则 透过 通信 网络 与 服务器 直接 地 撷取 正确 的 时间 来 修正 各自 的 时间 进而 达到 整个 系统 中 各 节点 时间 上 的 同步 。 　 　 主仆 式 时间 同步化 策略 最 主要 的 应用 是 NTP （ NetworkTimeProtocol ） 及其 相关 的 SNTP （ SimpleNTP ） 的 制定 且 成为 当今 国际 网络 中 许多 时间 同步化 机制 的 标准 。 另外 运用 时间 服务器 式 的 时间 同步化 策略 的 关键 NovellNetware 网管 系统 也 是 采用 的 主仆 式 结构 。 Netware 将 其 系统 区分 为 内部 时间 同步化 （ internaltimesynchronization ） 与 外部 时间 同步化 （ externaltimesynchronization ） 主要 是 建立 几种 不同 类型 的 时间 服务器 依 其 不同 的 功能 而 分层 管理 如图所示 。 主仆 式 与 时间 服务器 式 时间 同步化 策略 的 优点 是 其 原理 和 设备 都 很 简单 但 缺点 是 容错 能力 低 、 集中式 管理 易受 瓶颈 效应 （ bottleneckeffect ） 影响 等 。 图 Netware 时间 服务器 拜占庭 协议 式 时间 同步化 策略 　 　 拜占庭 协议 （ ByzantineAgreementConsensus ） 在 分布式系统 容错 领域 中是 另 一种 基本 且 重要 的 容错 技术 它 的 算法 就是 其中 一 节点 充当 发送者 由 它 发送 一 特定 信息 给 所有 结点 非 错误 节点 接收 到 此 信息 一经 处理 后会 将 它 再 正确 地 广播 给 其它 剩余 节点 每个 节点 透过 彼此 信息 的 交换 通过 多数决定 （ majority ） 方式 可以 知道 哪些 节点 发生 错误 之后 各 节点 再 轮流 当 发送者 不断 传递 回 交换 信息 直至 所有 错误 被 找到 为止 如图所示 。 图 拜占庭 协议 示意图 　 　 拜占庭 协议 具有 如下 特性 （ ） 它 适用 于 侦测 所有 分布式系统 中 的 任何 错误 （ arbitraryfault ） 包括 信息 遗失 或 节点 错误 等等 （ ） 它 要 执行 m 次 递归 程序 以 决定 m 个 错误 （ ） 它 的 容错 能力 可以 达 总 节点 数 三分之一 的 错误 个数 每个 节点 对外 连接数 需 大于 错误 个 数倍 。 　 　 拜占庭 协议 也 被 用于 时间 同步化 的 策略 上 其 优点 （ ） 容错 能力 强 （ ） 适用 于 任何 形态 的 系统 错误 。 缺点 （ ） 它 需要 相当 多 的 信息 交换量 来 达到 这会 加重 整个 网络 负载 （ ） 它 适用 于 特定 信息 的 交换 对于 时间 同步化 中需 交换 非 特定 的 参考 时间 信息 存在 应用 上 的 限制 。 收敛 函数 式 时间 同步化 策略 　 　 收敛 函数 式 时间 同步化 策略 是 分布式 容错 时间 同步 算法 研究 中 第种 被 广泛 使用 的 一种 策略 。 其 目的 是 搜集 系统 中 各个 节点 的 参考 时间 通过 个 有效 的 收敛 函数 从 所 收集 的 参考 时间 里 决定 同步化 时间 再 根据 其 结果 来 调整 各自 的 时间 。 基本 步骤 如下 　 　 从 其它 的 节点 收集 参考 时间 值 　 　 考虑 影响 因素 进而 估算 其 时间 估计值 　 　 运用 一 收敛 函数 计算 这些 时间 估计值 并 获得 一 正确 时间 值 　 　 根据 正确 时间 值来 修正 各自 的 时间 。 分布式 容错 时间 同步化 系统 的 误差 分析 　 　 我们 课题 小组 设计 了 个 简单网络 时间 协议 。 根据 设计 此 协议 要求 达到 的 精度 是 s 所 设计 的 系统 包括 台 服务器 和 个 客户端 客户端 向 服务器发送 时间 同步 的 请求 服务器 在 收到 了 请求 后 将 时间 信息 发送给 客户端 从而 达到 时间 的 同步化 。 但是 在 实际 的 工作 环境 中 由于 各个方面 的 原因 服务端 和 客户端 不 可能 达到 完全 同步 这 是因为 在 时间 传输 过程 中 存在 着 各种 误差 。 根据 分布式 容错 时间 同步化 系统 的 精度 公式 　 　 式 中 n 为 节点 总数 k 为 出错 的 节点 数 。 　 　 在 系统 中 产生 误差 的 因素 为 Δ max 和 θ max 其中 Δ max 为 时间 信息 延时 最大值 θ max 为 时间 估计值 中 间隔 最大值 也 就是 最大 时钟 误差 。 在 整个 系统启动 或 新 的 客户端 加入 时 可能 会 因为 θ max 值 大大 地 影响 精确度 但是 经过 次 时间 同步化 的 周期 后 就 可 收敛 至 一定 的 数值 。 根据 我们 的 实践经验 在 同个 局域网络 上以 分钟 时间 为 同步化 周期 则 θ max 值 介于 ms 因此 θ max 的 影响 会 趋于 固定 变动性 不 大 。 　 　 另个 影响 时间 同步化 精确度 的 因素 就是 网络 传输 延迟 Δ max 。 对 所有 的 时间 同步化 策略 而言 传输 延迟 都 是 非常 重要 的 被 考虑 因素 。 我们 认为 分布式系统 容错 的 时间 同步化 主要 分为 二大类 即 决定论 时间 同步化 和 几率 论 时间 同步化 。 它们 二者之间 最 主要 的 差别 就是 网络 传输 的 时间延迟 Δ 另外 经由 实验 得知 网络 传输 时间延迟 越小所 得到 的 时间 同步化 结果 精确度 就 越 高 。 因此 网络 传输 的 时间延迟 在 整个 时间 同步化 的 研究 中 具有 举足轻重 的 作用 是 不可 忽略 的 。 　 　 根据 系统 的 实验 误差 产生 最 主要 的 原因 还是 因为 网络 传输 时间延迟 太 大 影响 了 整个 同步化 结果 的 精确度 。 针对 造成 网络 传输 时间延迟 过大 的 原因 经过 研究 和 实验 得出 影响 网络 传输 延迟 产生 的 原因 和 解决办法 。 　 　 TCPIP 网络通信 协定 对 网络 传输 延迟 有 影响 。 我们 的 SNTP 系统 是 采用 TCPIP 通信协议 来 作为 网络通信 的 基础 虽然 可以 保证 时间 信息 不 遗失 的 重送 （ retransmission ） 机制 但 增加 了 网络 传输 的 时间延迟 造成 Δ max 过大 影响 时间 同步化 结果 的 精度 。 　 　 根据 ISO 所 制定 的 ISO 网络 参考模型 七层 结构 SNTP 系统 属于 应用层 （ applicationlayer ） 间 的 网络通信 而 TCPIP 是 属于 传输层 （ transportlayer ） 的 网络通信 协定 我们 认为 造成 网络 传输 时间延迟 过大 的 最 主要 原因 在于 TCPIP 通信 协定 的 通信 协定 延迟 （ Protocoldelay ） 造成 Δ max 估计值 过大 如同 在 传输速度 很慢 的 通信 网络 上 进行 时间 同步化 一样 互相 传递 交换 的 时间 信息 延迟 自然 变 大 间接 影响 时间 同步化 的 精度 。 　 　 通信 协定 延迟 的 大小 显示 当时 该 机器 的 网络 传输 状态 影响 的 因素 非常 多 包括 网络 负载 （ networktrafficload ） 与 该 机器 处理程序 的 忙碌 状态 等 。 　 　 针对 上述 个 影响 网络 传输 产生 延迟 的 原因 经过 研究 提出 了 下列 解决办法 　 　 （ ） 消除 通信 协定 延迟 的 影响 因素 即将 整个 时间 同步化 拉至 传输层 上 进行 缩小 信息 传输 的 时间延迟 以 接近 真实 的 网络 时间延迟 达到 改善 时间 同步化 的 精确度 如图所示 。 图 降低 通信 协定 延迟 示意图 　 　 然而 消除 通信 协定 延迟 的 影响 并非 那么 容易 TCPIP 属于 可靠性 传输 通信 协定 它 的 传输 时间 是 无法 预测 的 同样 它 的 通信 协定 延迟 也 是 无法 预测 的 此 时刻 的 通信 协定 延迟 无法 代表 或 推测 下 一 时刻 的 通信 协定 延迟 因此 很难 直接 测试 。 但 可以 在 进行 时间 同步化 大量 交换 采集 时间 信息 时 服务器端 与 客户端 各自 送个 信息 给 本地 主机 （ LocalHost ） 至 传输层 被 传 回来 如此 可以 测量 当时 服务器端 与 客户端 的 通信 协定 延迟 总和 。 　 　 （ ） 针对 其它 的 影响 因素 虽然 可 通过 对 当时 的 通信 协定 延迟 进行 测量 但 无法 代表 在 交换 信息 时 所有 信息 的 通信 协定 延迟 为此 我们 用 最小 参考值 来 代替 以期 尽量 接近 当时 的 通信 协定 延迟 。 由于 我们 的 SNTP 系统 主要 是 针对 局域网络 应用 根据 之前 进行 程序 测量 的 结果 最终 可 得 局域网络 的 真正 传输 时间延迟 小于 ms 。 假设 真正 网络 传输 时间延迟 最大值 为 a 第 i 个 客户端 的 通信 协定 延迟 为 Qci 服务器端 通信 协定 延迟 为 Qs 因为 α （ QsQci ） 也 可取 min （ QsQci ） 二者 之中 取较 小者 当作 通信 协定 延迟 的 最小 参考值 即选 min （ Qdmin （ QsQci ） ） 作为 消除 通信 协定 延迟 的 参考值 。 　 　 由于 各 方面 的 原因 我们 对于 所 提出 的 将 时间 同步化 从 应用层 拉至 传输层 上 进行 的 方法 没有 得到 实验 的 证实 但是 通过 上面 分析 可以 预知 与 原来 的 信息 传递 方式 相比 此 方法 可以 大大 地 改善 系统 的 延迟 现象 。 欧阳 珣 （ 武汉 华中理工大学 计算机 学院 ） 李榕 （ 武汉 华中理工大学 计算机 学院 ） 方维 坚 （ 武汉 华中理工大学 计算机 学院 ） 参考文献 ， MillsDLAlgorithmsforsynchronizingnetworkclocksDARPANetworkWorkingGroupReportRFCMACOMLinkabit ， MillsDLNetworkTimeProtocolversionspecificationandimplementationDARPANetworkWorkingGroupReportRFCUniversityofDelaware ， DavidLMillsSimpleNetworkTimeProtocolSNTPnetworkworkinggroupreportRFC ， DigitalTimeServiceFunctionalSpecificationVersionTDigitalEquipmentCorporationHalpernJYSimonsBStrongRetalFaultTolerantClockSynchronizationProcThirdAnnualACMSynposiumonPrinciplesofDistributedcomputing 周 明天 汪文勇 TCPIP 网络 原理 与 技术 北京 清华大学出版社 收稿 日期 ：