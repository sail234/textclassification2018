微型机 与 应用 MICROCOMPUTERITSAPPLICATIONSVolNoP 位 Windows 应用程序 的 实例 检测 技术 高升 　 邱湘茹 　 唐世伟 　 贾 文举 　 　 摘 　 要 ： 对位 Windows 中 的 实例 检测 技术 进行 了 研究 并 对 各种 检测 技术 进行 了 对比 。 　 　 关键词 ： 应用程序 实例 实例 检测 API 函数 　 　 多任务 操作系统 Windows 允许 用户 同时 运行 多个 程序 甚至 对个 应用程序 也 可以 创建 它 在 内存 中 的 多个 副本 将 每个 应用程序 的 个 内存 副本 称为 实例 。 在 一些 实际 系统 中 经常 要 对 实例 进行 控制 例如 控制 只 启动 应用程序 的 个 实例 时 在 进程 中要 检测 是否 已有 个 实例 启动 。 在位 Windows 应用程序 中 通过 检测 操作系统 传送 给 WinMain 函数 的 第个 参数 hPrevInstance 来 检测 其它 实例 的 存在 。 WinMain 函数 在 建立 窗口 函数 和 进入 消息 循环 之前 检测 hPrevInstance 的 值 若 此参数 的 值 为 真则 说明 应用程序 的 实例 已经 存在 。 然而 在位 Windows 中 hPrevInstance 的 值 永远 为 假 它 不能 再 作为 判断 应用程序 实例 是否 存在 的 标志 。 本文 以 Delphi 为 工具 对位 Windows 中 应用程序 实例 的 各种 检测 技术 进行 了 论述 。 窗口 查找 法 　 　 如果 应用程序 已经 有个 实例 在 运行 那么 通过 调用 FindWindow 这个 API 函数 可以 检测 到 该 实例 的 窗口 句柄 。 FindWindow 有个 参数 窗口 类 名称 和 窗口 标题 前 个 参数 就是 用 API 函数 RegisterWindow 注册 窗口 时 使用 的 WNDCLASS 窗口 类 的 名称 在 Delphi 中该 参数 就是 应用程序 主 窗口 的 类 名称 。 经过 分析 用 WindowsSDK 编制 的 程序 发现 第个 实例 负责 向 Windows 注册 窗口 类 其它 实例 在 创建 窗口 之前 总是 要 检测 窗口 类 是否 已经 注册 若 没有 注册 则 说明 本次 启动 是 应用程序 的 第个 实例 。 因此 可以 在 Delphi 的 DPR 文件 中 对 程序 启动 做 如下 控制 　 　 TestDPR 　 　 varhWndThandle 　 　 begin 　 　 　 　 　 检测 并 获取 主 窗口 句柄 　 　 　 　 　 HWndFindWindow （ 　 　 　 　 　 ′ TMyMainForm ′ 　 主 窗口 类 名称 　 　 　 　 　 ′ TestAppInstance ′ 标题 （ 可为 空 ） 　 　 　 　 　 ） 　 　 　 　 ifhWndthenbegin 　 　 　 ApplicationCreateForm （ 　 　 　 　 　 　 TmyMainForm 　 　 　 　 　 　 MyMainForm 　 　 　 　 ） 　 　 　 ApplicationRun 　 　 　 end 　 　 end 　 　 这个 方法 在 非 DelphiIDE 环境 中 可以 正常 检测 到 前个 实例 （ 若 存在 ） 并 保证 只有 应用程序 的 个 实例 运行 。 然而 在 Delphi 的 IDE 环境 中该 程序 永远 不能 启动 因为 在 工程 文件 打开 的 情况 下 内存 中 始终 存在 个 应用 程序设计 时刻 的 主 窗口 。 枚举 窗口 法 　 　 窗口 查找 法 无法 区分 应用程序 的 前 窗口 实例 与 IDE 环境 中 的 设计 时 的 窗口 实例 WindowsAPI 函数 EnumWindows 对 这个 方法 进行 了 改进 。 窗口 枚举 函数 EnumWindows 需要 个 参数 第个 参数 指向 个 实际 将要 查找 的 目标 窗口 与 当前 所有 正在 运行 的 窗口 进行 匹配 操作 的 回调 函数 MatchProc 的 内存地址 第个 参数 则 用于 返回 找到 的 目标 窗口 的 句柄 。 操作系统 顺序 地 将 当前 正在 运行 的 每个 窗口 传递 给 回调 函数 MatchProc 直到 接收 到 的 返回值 为 真 这个 函数 将 接收 到 的 窗口 与 目标 窗口 进行 比较 若 成功 匹配 则 返回 假以 通知 操作系统 继续 传递 下个 窗口 否则 返回 真以 通知 操作系统 停止 传递 。 　 　 TestDPR 　 　 varhWndThandle 　 　 begin 　 　 　 　 　 hWnd 　 　 　 　 　 EnumWindProc （ 　 　 　 　 　 　 　 MatchProc 　 　 　 　 　 　 　 LONGINT （ hWnd ） 　 　 　 　 　 ） 　 　 　 　 　 ifhWndthenbegin 　 　 　 　 　 ApplicationCreateForm （ 　 　 　 　 　 TMyMainForm 　 　 　 　 　 MyMainForm 　 　 　 　 ） 　 　 　 　 ApplicationRun 　 　 End 　 　 进行 匹配 的 回调 函数 　 　 functionMatchProc （ 　 　 　 　 　 　 hWndFromOSTHandle 　 　 　 　 　 　 hMatchedWndHWND ） 　 　 　 　 　 　 bool 　 　 　 　 　 　 stdcall 　 　 varstrstrstring 　 　 begin 　 　 　 　 ResultTrue 　 　 　 　 获得 窗口 类 名称 　 　 　 　 GetClassName （ 　 　 　 　 　 　 hWndFromOS 　 　 　 　 　 　 PChar （ str ） 　 　 　 　 　 　 　 　 　 ） 　 　 　 strPChar （ str ） 　 　 　 ifstr ′ TmyMainForm ′ thenbegin 　 　 　 　 　 　 若 窗口 类 名称 匹配 则 继续 比较 可执行文件 名 　 　 　 　 　 　 GetModuleFileName （ 　 　 　 　 　 　 　 hInstance 　 　 　 　 　 　 　 PChar （ str ） 　 　 　 　 　 　 　 　 　 　 ） 　 　 　 strPChar （ str ） 　 　 　 GetModuleFileName （ 　 　 　 　 　 GetWindowLong （ 　 　 　 　 　 　 　 HWndFromOS 　 　 　 　 　 　 　 GWLHINSTANCE 　 　 　 　 　 ） 　 　 　 　 　 PChar （ str ） 　 　 　 　 　 　 　 　 ） 　 　 　 strPChar （ str ） 　 　 　 ifstrstrthenbegin 　 　 　 　 　 hMatchedWndhWndFromOS 　 　 　 　 　 ResultFalse 　 　 　 　 end 　 　 　 end 　 　 end 　 　 上述 匹配 过程 除了 像 窗口 查找 法 那样 进行 窗口 类 名称 比较 外 还 比较 应用程序 可执行文件 的 名称 因而 克服 了 窗口 查找 法 的 不足 。 即使 在 设计 时刻 的 DelphiIDE 环境 内 也 可以 正常 工作 。 互斥 信号量 方法 　 　 在位 的 Windows 操作系统 中 Microsoft 引入 了 互斥 信号量 技术 该 技术 主要 应用 于 进程 间 共享资源 及 进程同步 因此 互斥 信号量 可以 用于 表示 个 实例 已经 存在 。 当 应用程序 启动 时 首先 调用 API 函数 CreateMutex 以 某 一 名称 （ 本文 中为 FirstInstance ） 创建 个 互斥 信号量 然后 发出 WaitForSingleObjectAPI 调用 如果 互斥 信号量 没有 被 其它 进程 占用 则 WaitForSingleObject 立即 返回 反之 如果 互斥 信号量 已 被 其它 进程 占用 WaintForSingleObject 会 等待 直至 互斥 信号量 被 释放 。 　 　 TestDPR 　 　 varhMutexTHandle 　 　 begin 　 　 　 　 hMutexCreateMutex （ 　 　 　 　 　 　 　 　 　 nil 　 　 　 　 　 　 　 　 　 False 　 　 　 　 　 　 　 　 ′ FirstInstance ′ 　 　 　 　 ） 　 　 　 　 ifWaitForSingleObject （ hMutex ） 　 　 　 　 　 waittimeoutthenbegin 　 　 　 　 　 　 　 　 　 ApplicationCreateForm （ 　 　 　 　 　 　 　 　 　 　 ′ TMyMainForm ′ 　 　 　 　 　 　 　 　 　 　 MyMainForm ） 　 　 　 　 　 　 　 　 　 ApplicationRun 　 　 　 　 end 　 　 end 　 　 本文 给出 的 若干种 实例 检测 方法 虽然 是 以 Delphi 给出 的 但 对 其它 平台 开发 的 位 Windows 程序 也 可 借鉴 。 高升 （ 大庆 石油学院 计算机科学 系 ） 邱湘茹 （ 大庆 石油学院 计算机科学 系 ） 唐世伟 （ 大庆 石油学院 计算机科学 系 ） 贾 文举 （ 大庆 石油学院 计算机科学 系 ） 收稿 日期 ：