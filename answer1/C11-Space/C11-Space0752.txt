航空 制造 技术 AERONAUTICALMANUFACTURINGTECHNOLOGY 年 第期 No 面向对象 的 NC 程序 仿真 系统 开 陈蔚芳 　 胡晓华 　 楼佩煌 　 薛建彬 ［ 摘要 ］ 　 在 介绍 NC 程序 仿真 系统 功能 的 基础 上 ， 着重 分析 了 系统 设计 与 开发 过程 中所采 的 面向对象 技术 、 刀具 半径 补偿 、 三维 仿真 等 关键技术 。 关键词 ： 仿真 　 面向对象 　 数控 加工 DevelopmentofSimulationSystemofObjectOrientedNCProgram ［ ABSTRACT ］ 　 OnthebasisofintroductionofNCprogramsimulationsystemfunctionthekeytechnologiessuchasobjectorientedtechnologytoolradiuscompensationandDsimulationinsystemdesignanddevelopmentareemphaticallyanalyzedKeywordsSimulation 　 Objectoriented 　 NCmachining 　 　 随着 数控机床 的 广泛应用 ， 对 NC 加工 程序编制 人员 的 需求 也 相应 增加 ， 如何 快速 学会 编制 NC 程序 将 变得 越来越 重要 。 另外 ， 在 练习 编程 时 ， 会 经常出现 这样 或 那样 的 错误 ， 但 由于 花费 太 大 ， 不 可能 把 程序 直接 拿到 数控机床 上去 实际操作 以 发现 问题 。 如果 能 对 NC 程序 进行 仿真 ， 在 计算机屏幕 上 模拟 实际 加工 以 检查程序 中 的 错误 ， 并 加以 修正 ， 可以 节省 大量 费用 和 时间 。 基于 上述 两点 ， 我们 开发 了 一个 基于 Windows 的 数控 加工 程序编制 自 学习 及 程序 仿真 软件 简称 NCSimu ， 通过 系统 可以 自学 程序编制 的 技巧 ， 也 可 对 编制 的 各种 NC 程序 进行 二维 和 三维 仿真 ， 以 检查和 修改 程序 ， 直至 正确 为止 。 　 开发 平台 　 　 操作系统 　 由于 NCSimu 主要 是 在 PC机 上 运行 ， 我们 选用 Windows 或 与 之 兼容 的 WindowsNT 作为 NCSimu 软件开发 和 运行 的 操作系统 。 　 　 开发工具 　 目前 流行 的 开发工具 很多 ， 如 BorlandCDelphiVisualBasicVisualC 　 等 。 NCSimu 系统 选用 的 是 Microsoft 公司 的 通用软件 开发 平台 VisualC 。 　 功能分析 　 　 NCSimu 系统 可以 在 单机 上 使用 ， 也 可装 在 服务器 上 ， 使用者 通过 网上 下载 或者 远程 登录 到 该软件 所在 的 服务器 后 ， 只要 用 鼠标 双击 NCSimu 的 图标 即可 运行 该软件 。 该软件 的 主要 功能 有 ： 　 　 NC 程序 的 编制 。 　 　 通过 单击 系统 提供 的 准备 及 辅助 功能 等 工具条 上 的 程序段 或 指令 按钮 ， 可 在 一个 视窗 编辑 窗中 完成 数控 加工 程序段 的 输入 ， 以 简化 和 加速 程序编制 过程 。 　 　 例如 ， 如果 在 编辑 窗 某处 输入 “ G 　 X 　 Y 　 Z ” 程序段 ， 那么 只要 先 点 一下 工具条 上 的 G 按钮 ， 则 会 在 指定 的 位置 出现 “ G 　 X 　 Y 　 Z ” ， 把 参数 ， 和 插入 到 相应 位置 即可 。 另外 ， 如果 不 知道 程序 如何 编制 或 不 清楚 程序段 和 代码 指令 的 含义 ， 可 随时 按 F 键 获得 帮助 。 　 　 熟练 的 程序员 也 可以 不 利用 系统 提供 的 各类 工具条 而 直接 利用 键盘 人工 输入 。 系统对 输入 的 程序段 逐条 检查 ， 如 有 错误 ， 则 停留 在 错误 处 ， 并 指出 是 何种 错误 ， 提示 用户 修改 。 在 另 两个 视窗 中则 显示 相应 程序段 的 轮廓 轨迹 ， 让 用户 更 直观 地 看到 所 编程序 段 是否 正确 。 　 　 NC 刀具 定义 与 选择 。 　 　 在 数控 程序 中 会 出现 刀具 号 如 T ， T ， 与 刀具 号 对应 的 刀具 在 实际 加工 之前 要 进行 预调 ， 以便 测出 直径 、 长度 等 参数 进行 补偿 。 在 仿真 系统 中 ， 与 刀具 号 对应 的 刀具 类型 及 参数 要 加以 定义 或 选择 ， 以 实现 补偿 。 系统 提供 了 多种 刀具 类型 ， 并 附有 刀具 图 ， 可 供选择 及 进行 参数 长度 、 直径 等 定义 。 　 　 工件 坐标系 在 机床 坐标系 中 的 位置 确定 。 　 　 一般 情况 下 ， 数控机床 有 一个 固定 的 机床 坐标系 及 机床 原点 ， 它 在 机床 出厂 之前 就 已经 规定 好 了 。 而 用于 编程 的 工件 坐标系 则 需程 编员 自己 定义 ， 这 两个 坐标系 的 位置 关系 在 数控 加工 以前 必须 加以 设定 ， 以 控制 数控机床 的 准确 运动 。 仿真 系统 中 提供 的 零点 偏置 设定 功能 可以 更 逼真 地 模拟 加工 轨迹 。 　 　 毛坯 定义 。 　 　 在 NC 程序 模拟 仿真 之前 ， 利用 系统 提供 的 毛坯 定义 功能 ， 定义 毛坯 尺寸 ， 使 仿真 过程 在 毛坯 上 进行 ， 更 贴近 实际 加工过程 。 　 　 刀具 中心 轨迹 计算 。 　 　 程编员 可以 按 轮廓 或 中心 轨迹 编程 ， 如果 按 中心 轨迹 编程 ， 则 不 需 进行 刀具 补偿 轨迹 计算 。 如果 按 轮廓 编程 ， 则 需 进行 刀具 补偿 ， 计算 出 刀具 的 中心 轨迹 ， 然后 再 进行 仿真 。 　 　 刀具 加工 轨迹 的 二维 仿真 。 　 　 毛坯 、 刀具 等 定义 完毕 ， 在 两个 视窗 中 对 被 加工 零件 从 两个 视图 方向 进行 二维 仿真 ， 以 检查 NC 程序 。 　 　 刀具 加工 轨迹 三维 模拟 。 　 　 系统 还 提供 了 NC 程序 的 三维 仿真 功能 ， 可 单步 或 连续 仿真 数控 加工 的 过程 。 此外 ， 该 模块 提供 了 移动 、 旋转 、 缩放 等 编辑 手段 ， 使程 编员 在 仿真 以前 可 把 毛坯 、 刀具 调整 到 最佳 位置 ， 以 达到 较 好 的 视觉效果 。 　 系统 采用 的 关键技术 　 面向对象 技术 及类 的 设计 　 　 面向对象 的 方法 是 年代 软件 核心技术 之一 ， 它 提供 了 一种 全新 的 开发软件 的 思维 方法 ， 用 “ 对象 消息 ” 的 程序设计 模式 取代 了 “ 数据结构 算法 ” 的 程序设计 模式 ， 从而 使 软件开发 的 周期 变短 ， 使用 周期 变 长 ， 开发 费用 降低 。 　 　 面向对象 的 软件 ， 以 对象 为 中心 设计 ， 与 面向 过程 的 传统 软件 相 比较 ， 面向对象 软件 本身 的 内部结构 已 发生 质 的 转变 ， 由此 带来 了 良好 的 可 构造性 、 可扩充性 和 可 重用 性 。 　 　 面向对象 设计 具有 以下 特点 ： 　 　 封装 性 　 把 一个 数据结构 和 操作 数据 的 函数 行为 和 方法 组合 在 一起 ， 封装 性是 借助 一种 新 的 结构 和 数据类型 机制 — — “ 类 ” 来 实现 的 。 　 　 继承性 　 建立 一个 新 的 派生类 ， 从 一个 或 多个 先前 定义 的 类 中 继承 函数 和 数据 ， 而且 可以 重新 定义 或 加进 新 的 数据 和 行为 ， 这样 就 建立 了 类 的 层次 。 　 　 多态性 　 指 这样 一种 能力 ： 一个 继承 体系 里 的 子 对象 在 需要 时 ， 能够 重新 定 义父 成员 函数 的 函数 。 　 　 为此 ， 我们 选用 面向对象 的 程序设计 方法 ， 采用 信息隐蔽 的 原则 ， 尽量 把 NC 仿真 系统 中 涉及 到 的 类 进行 完善 的 封装 ， 以 提高 NCSimu 软件 的 稳定性 和 可维护性 。 　 　 仿真 系统 中 建立 的 类 主要 有 ： 　 　 毛坯 类 ； 　 　 刀具 类 ； 　 　 坐标系 类 ； 　 　 子程序 类 ； 　 　 新建 子程序 类 ； 　 　 三维 仿真 类 。 　 　 下面 是 三维 仿真 类 的 定义 。 　 　 classCDSimuNCpublicCDialogpublic 　 　 BOOLDrawCountCDCdc 　 　 BOOLDrawOneStepCDCdc 　 　 voidmyEllipseCDPointcendoublediaintisUPCRgn 　 　 BOOLDrawDArcCDCdcCStrokepstroke 　 　 BOOLDrawDLineCDCdcCStrokepstroke 　 　 BOOLDrawUpArcCDCdcCStrokepstroke 　 　 BOOLDrawUpLineCDCdcCStrokepstroke 　 　 CDSimuNCCWndpParentNULLstandardconstructorpublic 　 　 CNcsimuDocpDoc 　 　 CNcsimuViewpView 　 　 CWinApppApp 　 　 CRectview 　 　 CRgnruprdown 　 　 CPointuface ［ ］ dface ［ ］ 　 　 structSViewPointmvp 　 　 CDPointcptmpOrg 　 　 POSITIONpos 　 　 voidAttachDocViewCNcsimuDocCNcsimuView 　 　 CDPointtransferlongxlongyCDPointep 三维 坐标 向 二维 坐标 转换 　 　 BOOLOnCoorChangelongid 坐标 变换 　 　 BOOLDrawBlankPartCDCdc ； 绘制 毛坯 　 　 BOOLDrawToolPathCDCdc ； 绘制 刀具 路径 　 　 BOOLDrawToolCDCdc ； 绘制 刀具 　 　 BOOLDrawCoorCDCdc ； 绘制 坐标系 enumIDDIDDDSIMULATE 　 　 CBitmapButtonmxcw 　 　 　 　 … … 　 　 CBitmapButtonmmovednprotected 　 　 virtualvoidDoDataExchangeCDataExchangepDXprotected 　 　 afxmsgvoidOnPaint 　 　 virtualBOOLOnInitDialog 　 　 afxmsgvoidOnMovedn 图形 下移 　 　 afxmsgvoidOnMovelt 图形 左移 　 　 afxmsgvoidOnMovert 右移 　 　 afxmsgvoidOnMoveup 上移 　 　 afxmsgvoidOnXccw 绕 X 轴 顺转 　 　 afxmsgvoidOnXcw 绕 X 轴 逆转 　 　 afxmsgvoidOnYccw 绕 Y 轴 顺转 　 　 afxmsgvoidOnYcw 绕 Y 轴 逆转 　 　 afxmsgvoidOnZccw 绕 Z 轴 顺转 　 　 afxmsgvoidOnZcw 绕 Z 轴 逆转 　 　 afxmsgvoidOnZoomin 缩小 　 　 afxmsgvoidOnZoomout 放大 　 　 afxmsgvoidOnStepBack 后退 一步 　 　 afxmsgvoidOnExitSimuD 退出 三维 仿真 　 　 afxmsgvoidOnPlayAll 连续 仿真 　 　 afxmsgvoidOnGoHome 仿真 取消 　 　 afxmsgvoidOnStepForward 单步 仿真 　 　 DECLAREEVENTSINKMAP 　 　 DECLAREMESSAGEMAP 　 刀具 半径 补偿 　 　 前面 已经 提到 ， 程编员 在 编制 NC 程序 时 ， 如果 按 轮廓 编程 ， 则 在 仿真 前要 进行 刀具 中心 轨迹 的 计算 ， 以 实现 刀具 半径 的 自动 补偿 。 刀具 补偿 过程 分为 刀补 建立 、 刀补 进行 、 刀补 撤销 个 步骤 ， 其中 最 重要 的 一步 是 刀 补 进行 ， 此时 刀具 中心 轨迹 始终 偏离 轮廓 轨迹 一个 刀具 半径 补偿 值 。 由于 在 刀 补 进行 过程 中 前后 两段 编程 轨迹 转接 方式 不同 直线 与 直线 相接 、 圆弧 与 直线 相接 、 直线 与 圆弧 相接 、 圆弧 与 圆弧 相接 ， 中心 轨迹 的 计算 稍 有 不同 。 下面 以 直线 与 直线 相接 为例 说明 我们 在 系统 开发 中 所 采用 的 计算方法 ， 该 方法 计算 简单 ， 计算速度 较 快 。 图为 直线 与 直线 转接 的 计算 过程 ， 图为 刀具 半径 补偿 计算 框图 及 示意图 。 　 　 已知 P ， P ， P 点 的 坐标 分别 为 xyxyxy 则 α arctanyyxx 图 　 直线 与 直线 转接 的 补偿 计算 过程 Fig 　 Compensationcalculationprocedureoflinetoline 图 　 刀具 半径 补偿 计算 框图 Fig 　 Flowchartforcalculatingtoolradiuscompensation 　 　 P ′ 点 相对 P 点 的 坐标 增量 为 x ′ xxcos α yysin α y ′ xxsin α yycos α α arctany ′ x ′ 　 　 如果 α ， 且 左偏 G ， 则 附加 圆弧 段 起点 P ′ 坐标 为 x ′ xRsin α y ′ yRcos α R 为 刀具 半径 补偿 值 。 附加 圆弧 段 终点 P ″ 坐标 为 x ″ Rcos α π cos α Rsin α π sin α xy ″ Rcos α π sin α Rsin α π cos α y 附加 圆弧 段 圆心 坐标 为 P 点 的 坐标 。 　 　 如果 α ， 且 左偏 G ， 则 直线 转接 为 缩短 求交 情况 ， 见图 示意图 ， 交点 坐标 为 x ′ Plxcos α Plysin α xy ′ Plxsin α Plycos α y 式 中 ， PlxPly 为 一 临时 点 的 xy 坐标 ， 当 α － 时 ， Plx ； 当 α π － 时 ， Plx ； 其他 ， PlxRtan π α PlyR 。 　 三维 仿真 　 　 NC 程序 的 三维 仿真 可 更 逼真 地 观察 加工过程 ， 以 检查程序 中 隐含 的 错误 。 它 的 实现 方法 不止 一种 ， 下面 介绍 我们 在 三维 仿真 中 所 采用 的 方法 ， 其 实现 步骤 如下 参见 图 ， 以 直线 加工 仿真 为例 ， 圆弧 加工 仿真 与 之 类似 ） 。 图 　 三维 仿真 原理 示意图 Fig 　 Dsimulationprinciplescheme 　 　 ） 创建 毛坯 上 表面 区域 A ； 创建 毛坯 下 表面 区域 B 。 　 　 以 P 为 圆心 创建 上 表面 上 椭圆 区域 C ∈ A ； 以 P ′ 为 圆心 创建 下 表面 上 椭圆 区域 D ∈ B 椭圆 是 刀具 截面 在 毛坯 上 的 投影 。 　 　 创建 正方形 区域 E 、 F ， E 、 F 为 上 、 下 表面 上 需 填充 颜色 的 区域 ， 两 区域 是 不断 变化 的 ， 初始值 为角点 坐标 ， 和 ， 的 正方形 区域 ； 　 　 区域 拷贝 ECFD ； 　 　 区域 C ， D 删除 。 　 　 计算 L ， L 中 较大 者 ， 其中 L ， L 为 P ， P 点 在 xy 轴上 的 间距 。 LPxPx ； LPyPy ； 如果 LL 则 LL 如果 LL 则 LL 。 　 　 循环 坐标 计算 、 椭圆 区域 创建 、 区域 合并 、 区域 删除 过程 。 　 　 PtxPxjPxPxL ； 　 　 PtyPyjPyPyL ； 　 　 PtzPzjPzPzLj 为 到 L 的 正整数 ， 每次 递增 ； 　 　 区域 创建 ： 分别 创建 以 Pt 和 Pt ′ 为 圆心 的 椭圆 区域 C 和 DC ∈ A ， D ∈ B ； 　 　 区域 合并 ： EC ∪ E ， FD ∪ F 　 　 区域 删除 ： 删除 C 和 D 。 　 　 选择 区域 A ， 填充 A 上 的 区域 E ； 或 选择 区域 B ， 填充 B 上 的 区域 F 。 若 E ∩ F 非空 ， 则 以 另 一 颜色 填充 E ∩ F 相交 区域 。 返回 ， 直至 循环 到 P 点 。 　 　 该 系统 操作 简单 、 方便 ， 可 广泛 用于 学生 教学 、 培训 等 。 目前 已 在 香港理工大学 工业 中心 用于 学生 培训 ， 取得 了 良好 的 效果 。 作者 单位 ： 南京航空航天大学 责编 宇迪