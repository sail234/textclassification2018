计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 面向对象 的 信息安全 引擎 工具包 朱森存 　 荆 继武 　 王家 业 摘要 ： 综合 介绍 了 国际 上 目前 的 密码学 API （ 工具包 ） 发展 的 现状 ， 分析 了 它们 的 优缺点 。 并 利用 面向对象 技术 实现 了 一个 接口 简单 、 符合 密码学 概念 的 信息安全 引擎 工具包 。 关键词 ： CSADE ； 密码学 API ； 面向对象 ObjectorientedCryptographyEngineToolkitZhuSenucnJingJiwuWangJiayeStateKeyLaboratoryofInformationSecurityofUSTCBeijing 【 Abstract 】 ThisarticleintroducesthedevelopmentofcryptographyAPIthenanalysestheircharacteristicsBesidesweuseobjectorientedtechnologytoimplementacryptograhpytoolkitwhichhasmuchsimplerinterfacesandisconsistentwiththeconceptionofcryptography 【 Keywords 】 CSAFECrptograpyAPIToolkitObjectoriented 　 　 密码学 API 是 一种 密码学 应用 程序接口 ， 使用 这种 接口 ， 普通 程序员 就 能够 开发 出 安全 的 应用程序 或 产品 ， 而 无需 太 多 密码学 、 数学 或 数论 方面 的 背景 知识 。 随着 密码学 理论 与 技术 的 日益 成熟 及 近年来 Internet 的 飞速发展 ， 人们 对 安全 的 需求 也 越来越 大 因此 ， 提供 一种 使用 和 理解 都 非常简单 的 安全 引擎 工具包 或 接口 成为 大势所趋 。 目前 国际 上 已经 制定 出 了 一些 相关 的 行业标准 并 开发 出 了 部分 产品 。 国际 互连 网络工程 任务 组织 IETF 制定 了 通用 的 安全 服务 应用 程序接口 GSSAPI ， 这是 有关 安全 产品 应用 开发 接口 的 第一个 国际标准 。 该 标准 现已 成为 高层 应用 系统 在 互连 网络 中 申请 和 提供 不同 的 安全 服务 的 比较 成熟 的 统一 标准接口 。 另外 ， 国外 的 一些 实力雄厚 的 大 公司 和 研究 机构 也 纷纷 推出 了 与 密码学 相关 的 安全 引擎 或 编程 接口 。 其中 最为 著名 的 有 美国 惠普公司 提出 的 ICFInternationalCryptographyFramework ， 美国微软公司 推出 的 CAPI 以及 美国 RSA 公司 推出 的 BSAFE 。 ICF 是 一个 旨在 满足 全球 应用 密码学 安全 服务 的 解决方案 ， 而 CAPI 和 BSAFE 则 是 安全 服务 的 应用 编程 接口 产品 。 另外 ， 美国 IBM 公司 ， Intel 公司 ， 德国 的 GMD ， 都 推出 了 与 密码学 相关 的 安全 产品 。 　 目前 安全 API 局限性 　 　 上述 的 各种 安全 API 或 工具包 ， 由于 其 开发 的 目标 不 一致 ， 各有 各 的 侧重 ， 因此 各自 有 自己 的 优点 和 局限 。 像 IEFT 的 GSSAPI 其 优点 是 提供 了 一套 安全 且 通用 的 接口 ， 但是 ， 由于 GSSAPI 只 提供 端到 端的 会话 ， 因此 在 建立 安全 会话 之前 ， 必须 知道 通信 对方 。 这 就 限制 了 GSSAPI 在 许多 方面 的 应用 。 比如 在 新闻组 中 参与 讨论 ， 由于 无须 指定 通信 对方 ， 如此 将 无法 获得 GSSAPI 的 安全 服务 。 　 　 在 分析 各种 API 时 ， 发现 了 它们 共同 的 不足之处 ， 那 就是 ， API 调用 起来 很 复杂 ， 表现 在 ： 　 　 接口 参数 多 。 　 　 接口 参数 数据类型 复杂 ， 大量 使用 C语言 中 的 结构 体 ， 而且 结构 体中 还 嵌套 着 结构 。 　 　 观察 GSSAPI 的 初始化 函数 见 RFC ： 　 　 OMuintgssinitseccontextOMuintminorstatus 　 　 　 　 　 　 　 gsscredidt 　 　 claimantcredhandle 　 　 　 　 　 　 　 … … … … … … … 　 　 　 　 　 　 　 OMuint 　 　 　 　 timerec 　 　 　 　 　 　 　 　 　 其 参数 个数 为个 ， 每个 参数 数据类型 都 是 一个 复杂 的 结构 体 。 这种 接口 ， 只能 让 用户 望 而 怯步 。 　 　 操作过程 繁杂 。 一些 过程 ， 如 加密 ， 在 密码 理论 上 只 需 一步 就 能 实现 ， 而 实际上 则 还 需 很多 辅助 步骤 。 以 BSAFE 的 一次 RC 加密 为例 ， 其 过程 是 ： 创造 算法 对象 一个 复杂 的 结构 体 → 设置 算法 对象 → 初始化 工作 ， 包括 创造 密钥 对象 ， 设置 密钥 对象 另 一个 复杂 的 ITEM 的 结构 体 → 更新 工作 进行 中间 数据 块 的 加密 → 结束 工作 ， 进行 最后 一块 数据 的 填充 和 加密 → 破坏 所 分配 的 内存空间 从 编程 角度 来说 ， 其中 每 一步 都 是 合理 的 ， 但是 对 普通用户 来说 ， 要 想 很快 且 清楚 地 理解 和 使用 却是 非常 困难 的 。 　 　 上面 所举 的 加密 例子 ， 其实 只是 最 简单 的 密码学 操作 ， 对于 那些 复杂 的 操作 ， 如 数字签名 ， 证书 生成 等 ， 其 过程 更是 繁杂 无比 。 大家 知道 ， 对称 算法 的 操作 模式 主要 有种 ， 分别 是 ： ECB ， CBC ， CFB ， OFB 。 这样 ， 每当 用户 使用 DES 算法 时 ， 必须 选择 一种 模式 ， 如果 他们 选择 了 CBC 模式 ， 则 还 必须 设置 初始化 矢量 IV ， 指定 数据 块 填充 方式 ， 而且 通信 对方 也 必须 知道 这些 设置 ， 否则 就 无法 正确 地 解开 明文 数据 来 。 另外 ， 由于 现在 的 密码学 算法 非常 的 多 ， 每个 使用 的 方法 都 不 一样 ， 因此 大大增加 了 实现 的 复杂度 。 　 我们 的 解决方案 － CSAFE 　 　 那么 ， 怎样才能 较 好地解决 上述 的 困难 ， 又 能 全面 地 提供 密码学 服务 ？ 　 　 我们 的 设计 思想 和 方法 是 整个 系统 采用 面向对象 的 设计 方法 。 而 BSAFE ， CryptoAPIGSSAPI 等 ， 都 是 采用 过程 描述 式 的 结构化程序 设计 方法 ， 相对而言 ， 面向对象 的 设计 方法 增加 了 软件 的 可 重用 性 和 可扩充性 ， 从而 改善 并 提高 了 应用 开发人员 的 生产 效率 ， 同时 能够 有效 地 控制软件 的 复杂度 ， 减少 软件维护 的 工作量 。 CSAFE 绝大部分 采用 C语言 来 进行 代码 设计 。 C 是 C 的 超集 ， 不仅 保留 了 C语言 简洁 和 高效 的 优点 ， 还 充分利用 C语言 的 封装 和 继承 特性 ， 使得 API 的 接口 尽可能 地 简化 ， 从而 克服 了 那 繁杂 的 操作过程 和 令人生畏 的 接口 参数 。 　 　 因此 ， CSAFE 相对 于 其它 密码学 API 来说 ， 具有 如下 特点 ： 　 　 首先 ， CSAFE 整体 结构 模型 简单 。 　 　 在 图 中 ， CSAFE 的 最底层 是 大 整数 算法 引擎 ， 快速 算法 引擎 和 硬件 接口 。 最上层 是 用户 接口 ， 它 提供 大 整数 算法 引擎 、 编程 和 编码 三 方面 的 功能 接口 ， 一般 用户 无需 了解 底下 的 几层 ， 除非 需要 自定义 算法 ， 这时 需要 对 快速 算法 引擎 提供 的 接口 有所 了解 。 模型 中 的 编程 接口 提供 密码学 操作 ， 如 加密 和 解密 等 功能 ， 编码 接口 根据 国际标准 来 编码 和 解码 数据 。 图 CSAFE 结构 模型 　 　 其次 ， 提供 的 安全 引擎 工具包 接口 和 操作过程 都 非常简单 ， 程序接口 和 功能 符合 密码学 概念 。 利用 C语言 的 封装 特性 ， 把 密钥 等 数据 封装 起来 ， 这样 既 有利于 保护 敏感数据 ， 又 大大减少 了 接口 参数 。 采用 的 参数 的 数据类型 都 是 最 基本 的 ， 如 整型 、 字符串 等 ， 且 每个 参数 的 意义 符合 密码学 概念 。 如 在 加密 时 ， 其 方法 参数 为 ： 明文 字符串 ， 明文 长度 整型 ， 密文 字符串 。 函数 返回 密文 的 长度 ， 这 与 密码学 上 的 加密 过程 是 完全一致 的 。 考虑 到 不同 用户 的 水平 和 要求 ， 提供 了 默认 的 典型 算法 和 操作 模式 ， 当然 熟练 的 用户 可以 在 提供 的 算法 库中 自由 地 选择 自己 所 需 的 算法 。 　 　 另外 ， CSAFE 中 算法 是 可 替换 的 。 采用 C 的 纯虚 函数 ， 在 基类 中 留下 算法 接口 。 由此 派 生出 几种 典型 的 算法 ， 用户 可以 自由选择 使用 。 但 如果 用户 需要 使用 自己 编制 的 密码学 算法 ， 那么 所 需 的 工作 只是 从 算法 接口 中 派 生出 自己 的 算法 ， 就 能 完全 使用 基类 所 提供 的 丰富 的 方法 和 数据 ， 这是 普通 的 程序员 就 能 胜任 的 ， 而 新 算法 和 原有 算法 的 调用 方法 是 完全 一样 的 。 　 　 CSAFE 还 提供 一定 的 数学 工具 。 利用 了 C语言 的 可 重载 特性 ， 重载 了 一些 基本 的 数学 运算 。 如 重载 了 大 整数 计算 ， 用户 就 可以 用 普通 的 运算 符号 ， 如 加减乘除 、 乘方 等 ， 进行 大 整数 运算 。 　 　 CSAFE 还有 其它 一些 长处 。 所有 的 类 都 从 一个 提供 错误代码 和 原因 的 类 中 派生 出来 ， 这样 当 程序运行 结果 与 理论 上 不 一致 时 ， 就 可 很 方便 地查 到 原因 。 这 在 很大 程度 上 增强 了 代码 的 可维护性 ， 有助于 模块化 设计 的 实现 。 　 　 下面 通过 一个 利用 RSA 算法 来 加解密 的 例子 ， 具体 说明 如何 实现 上述 思想 的 。 在 这个 例子 中 ， 假定 了 通信 双方 Alice 和 Bob 他们 要 通过 RSA 算法 来 传输数据 假定 事先 不 知道 对方 的 密钥 。 　 　 其 具体 通信 过程 如下 ： 　 　 Alice 产生 RSA 私钥 对象 a 　 　 　 　 　 　 DCSRSAPRIVATEa 　 　 　 Bob 产生 RSA 公钥 对象 b 　 　 　 　 　 　 DCSRSAPUBLICb 　 　 Alice 产生 bit 的 RSA 公私 钥对 　 　 aGenerateRSAKey 　 　 Alice 把 自己 的 公钥 信息 编码 后 输出 　 　 iaOutputPublicKeypk 式 中 pk 为 编码 后 的 公钥 信息 根据 PKCS 标准 i 为 pk 的 长度 。 　 　 Bob 在 得到 Alice 的 编码 的 公钥 信息 后 　 　 　 通过 Restore 操作 得到 Alice 的 公钥 　 　 　 bRestorePublicKeypki 　 　 Bob 用 Alice 的 公钥 加密 一段 明文 数据 得到 的 密文 数据 输出 。 　 　 clenbDoEncryptWithPublicKeypoutpinplen 　 　 式 中 pin 为 明文 数据 ， plen 为 明文 数据 长度 ， cout 为 密文 数据 ， clen 为 密文 长度 　 　 Alice 用 自己 的 私钥 解开 Bob 传来 的 密文 ， 得到 明文 数据 　 　 plenaDoDecryptWithPrivateKeypoutcinclen 　 　 式 中 pout 为 明文 数据 ， plen 为 明文 数据 长度 ， cin 为 密文 数据 ， clen 为 密文 长度 　 　 一次 通信 结束 　 　 　 注 ： 例中 所有 的 函数 接口 参数 数据类型 为 字符串 型 或 整型 　 总结 和 努力 方向 　 　 采用 面向对象 的 设计 方法 ， CSAFE 成功 地 解决 了 前文 指出 的 目前 密码学 API 的 局限性 。 SAFE 提供 的 基本功能 有 ： 随机数 产生 ； 素数 校验 加解密 MAC 生成 和校验 ； 数字签名 ； 大 整数 运算 等 。 另外 ， CSAFE 还 提供 了 许多 综合 功能 ， 包括 ： 秘密 共享 方案 ， 密钥 管理 ， 证书 管理 等 。 　 　 由于 CSAFE 提供 众多 的 功能 ， 因此 它 可以 广泛应用 于 电子货币 及 电子商务 ； 基于 TCPIP 协议 的 网络安全 通信 ； 安全 的 电子邮件 ； 证书 授权 服务器 CA ； 防火墙 ； 虚拟 安全 网络 ； 语音 与 图形 图象 加密 ； 数据库 加密 ， 以及 其它 安全 领域 。 　 　 当然 ， 作为 一种 工程 上 的 应用 工具 ， 它 不 可能 是 完美无缺 的 。 一方面 ， 它 需要 不断 地 扩充 功能 ， 提供 更 多 的 算法 。 另外 ， 它 应该 可以 适应 更 多 的 应用 平台 ， 虽然 目前 它 已 可 运行 于 WinNTScoUnix 平台 。 将 在 以后 的 工作 中 逐步 地 完善 它 。 基金项目 ： 中科院 重大 课题 （ 已 通过 部级 鉴定 ） 作者简介 ： 朱森存 （ ～ ） ， 男 ， 研究生 ， 主攻 密码学 应用 作者 单位 ： 中国科技大学 信息安全 国家 重点 实验室 ， 北京 参考文献 SchneierBAppliedCryptographyJohnWileySonsInc 美国 RSA 公司 产品 BSAFE 用户手册 RFCIETFITUPKCS 系列 等 收稿 日期 ：