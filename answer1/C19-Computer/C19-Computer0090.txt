计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 音乐 喷泉 系统 的 可视化 设计 及 实时 仿真 陈一民 ， 刘云超 ， 陈琳 ， 李元 摘要 ： 介绍 音乐 喷泉 系统 的 结构 及 设计 思路 ， 针对 传统 的 音乐 喷泉 系统 的 缺点 和 实际 存在 的 问题 ， 提出 了 分级 控制 的 思想 和 实现 方法 ， 详细 论述 了 音乐 喷泉 的 控制 码 （ 造型 码 ） 的 可视化 编程 以及 音乐 喷泉 徒刑 的 实时 仿真 ， 并用 当前 流行 的 编程 工具 VB 加以 实现 。 系统 集 声音 动画 于 一体 ， 充分 展现 了 多媒体技术 和 音乐 喷泉 的 魅力 。 关键词 ： 音乐 喷泉 ； 造型 码 ； 分级 控制 ； 实时 仿真 TheVisualDesignandRealtimeEmulationofMusicSpringSystemChenYiminLiuYunchaoChenLinLiYuanSchoolofComputerEngineeringScienceShanghaiUniversityShanghai 【 Abstract 】 InthispapertheconstructionsofmusicspringsystemareintroducedandthedesigningthoughtofmusicspringsystemisalsointroducedThetheoryofgradecontrolandthewayofbringingitaboutareintroducedinaccordancewiththeshortcomingsofthetraditionalmusicspringsystemstogetherwiththeproblemsinactualsituationsthevisualprogrammingofcontrolcodeofthemusicspringandrealtimeemulationofitsmodelisexplainedindetailsAndVBthepopularprogrammingtoolisusedtobringthemaboutInthissystemsoundandanimationisusedtopresentthemultimediatechnologyandthecharmofmusicspring 【 Keywords 】 MusicspringControlcodegradecontrolRealtimeemulation 　 　 纵观 目前 的 音乐 喷泉 系统 ， 由于 只 采用 单片机 作为 核心部件 进行 控制 ， 因此 都 存在 音乐 节奏 和 喷泉 动作 同步 困难 ， 控制 效果 不佳 。 另外 由于 采用 软件 和 一定 硬件 电路 配合 将 存放 的 乐曲 代码 有 节奏 地 进行 演奏 来 控制 音乐 喷泉 ， 因而 存在 音乐 喷泉 的 控制 码 造型 码 编程 困难 ， 并且 控制 码 一经 编辑 形成 ， 没有 一个 好 的 人机界面 预以 观察 其 效果 ， 无法 对 喷泉 现场 进行 实时 仿真 。 针对 上述 这些 情况 ， 用 个人 计算机 和 Windows 应用程序 的 高级 开发工具 VB ， 采用 二级 控制 方案设计 并 研制开发 了 音乐 喷泉 系统 ， 以 解决 音乐 喷泉 控制 码 编程 的 可视化 及 喷泉 造型 的 实时 仿真 问题 。 音乐 喷泉 系统 的 结构 　 　 系统 由 上下 两级 微机 组成 ， 通过 RS 进行 上下 两级 微机 的 通讯 。 上 微机 负责 对 音乐 的 控制 码 编辑 及 喷泉 造型 的 实时 仿真 ； 下 微机 接受 上 微机 送到 的 代码 ， 通过 变频 调速器 控制 喷泉 系统 的 水泵 ， 使 喷泉 水柱 高低 随 音乐 的 节奏 而 变化 。 　 　 音乐 喷泉 系统 的 结构 如图所示 。 图 音乐 喷泉 系统 　 　 为 解决 水泵 滞后 问题 ， 在 每 一首 歌曲 之前 应 加上 一个 提前量 ， 以 保证 乐曲 节拍 与 喷泉 水柱 的 同步 。 为了 解决 节拍 的 同步 问题 ， 在 音乐 结束 时 ， 记下 造型 码 当前 的 编号 ， 将 滞后 的 几拍 造型 码 删除 。 由于 采用 了 个人 计算机 ， 可以 通过 创立 的 人机界面 解决 水泵 滞后 问题 和 节拍 同步 问题 。 　 　 为了 使 编辑 造型 码 可视化 ， 利用 VB 提供 的 控件 较为 客观 地 描述 了 现实 中 的 喷泉 ， 如图所示 。 这样 可 对 乐曲 的 控制 码 编辑 效果 进行 观察 ， 实现 喷泉 现场 的 实时 仿真 。 图 喷泉 效果 介面 　 　 图中 十号 泵 到 零号 泵 喷头 的 名称 分别 为 半球 、 旋转 、 树冰 、 外环 、 内环 、 主喷 、 花柱 、 斜 喷 、 花篮 、 双环 、 雪松 ， 分别 与 喷泉 池中 的 实物 一一对应 。 　 　 喷泉 效果 界面 使得 在 编程 控制 码 的 同时 实时 观察 喷泉 的 造型 ， 以 确保 良好 的 同步 性能 和 音乐 喷泉 的 节奏感 及 动感 。 音乐 喷泉 系统 的 设计 思想 及 特点 　 　 通过 上 微机 用户 可 方便 地 按 音乐 节拍 进行 控制 码 编辑 。 在 播放 音乐 CD 的 同时 ， 上 微机 通过 串行 通信 口 把 控制 码 发送给 控制 喷泉 水泵 的 单片机 下 微机 ， 使 喷泉 的 造型 和 喷泉 的 水柱 高低 随 音乐 一起 变化 。 上 微机 系统 主要 完成 下列 功能 ： 　 　 节拍 时间 的 确定 以 ms 为 单位 对 整个 乐曲 节拍 数 进行 统计 ， 计算 节拍 时间 ， 对 乐曲 总 时间 进行 一致性 检验 。 　 　 人工 编辑 造型 界面 屏幕 上 设计 有 人工 编辑 界面 ， CD 播放器 及 喷泉 效果图 。 人工 编辑 界面 以 行列 形式 表单 顺序 表示 各个 节拍 ， 每行 表示 一个 节拍 ， 编辑者 随 乐曲 逐格 填入 相应 的 乐曲 控制 码 ， 在 进行 控制 码 编辑 时 ， 允许 编辑者 播放 停播 乐曲 以利于 构思 。 若 播放 乐曲 则 喷泉 随 音乐 的 进展 进行 造型 ， 相应 的 音节 会 变化 ， 编程 者 仅 需向 相应 的 位置 填入 控制 码 即可 。 控制 码中 包括 泵 号 ， 喷泉 水柱 高度 ， 高度 变化 的 间隔时间 ， 以及 控制 彩灯 的 代码 。 泵 的 数据格式 为 NXY ， N ： 泵 号 ， X ： 水柱 高度 － F ， － 档 高度 ， Y ： 高度 变化 的 间隔时间 ； 彩灯 的 数据格式 为 AMN ， A ： 灯号 ， M 是 二路 环灯 ， 是 一般 彩灯 。 对于 一般 彩灯 用 开关 控制 ， 表示 亮 ， 表示 关 ， 占位 用 十六进制 数 表示 ， 二路 环灯分 两组 － － ， 占位 用 Ⅰ 、 Ⅱ 、 Ⅲ 、 Ⅳ 分别 表示 I － IV 个 灯亮 ； N ： 移位 时间 ， ms × N 值 。 把 一首 乐曲 各个 节拍 的 控制 全部 编完 ， 就算 完成 一首 乐曲 的 编辑 工作 ， 可 在 以后 提供 给 使用者 进行 单 乐曲 循环 播放 。 如此 逐曲 编辑 直至 整个 C D盘 上 全部 乐曲 编完 ， 这些 内容 存入 磁盘 中 ， 与 原来 的 C D盘 配套 成为 专门 的 音乐 喷泉 盘片 。 　 　 预览 把 编辑 完成 的 配套 盘片 在 PC机 中 播放 但 不 送 出 控制 信号 至 单片机 的 过程 称 预览 。 通过 在 PC机 屏幕 上 编制 一个二维 图象 来 实时 仿真 喷泉 实现 预览 ， 以 检验 控制 码 编辑 的 合理性 ， 并 对 需要 处作 适当 修改 也 可 反复 修改 ， 最后 形成 音乐 喷泉 控制软件 ， 与 C D盘 配套 使用 。 　 　 回放 把 上述 配套 盘 插入 PC机 ， 在 中文 Windows 环境 下 进入 本 软件 工作 界面 ， 此时 屏幕显示 编辑 界面 ， CD 播放器 ， 喷泉 动画 和 相应 按钮 。 当 操作者 按 启动 键后 ， PC机 启动 CD 播放 乐曲 ， 并 按 节拍 通过 串行口 发出 相应 的 控制 码 送给 下 微机 ， 以 控制 喷泉 和 灯光 ， 同时 ， 在 显示屏 上 显示 音乐 喷泉 的 效果 。 系统 中 主要 模快 的 编程 原理 喷泉 色彩 封面 　 　 如何 创建 多种 色彩 的 文本 ， 并 能够 移动 和 改变 它们 的 尺寸 呢 ？ 通过 建立 的 APIFont 类 ， 并 与 计时器 结合 在 一起 就 可以 实现 独具特色 的 文本 效果 。 类 的 SetColor 函数 将 调用 API 的 SetTextColor 函数 来 改变 设备描述 表 的 字体 颜色 ， 使用 计时器 就 可以 实现 多种 色彩 文本 效果 ， 创建 出 一种 动画 效果 。 通过 使用 图片 框 控件 的 TextWidth 和 TextHeight 属性 ， 能够 对 文本 在 图片 上 的 移动 进行 准确 的 计算 。 　 　 另外 ， 使用 图形 创建 热点 技术 ， 即 利用 Image 控件 作为 工具 ， 为 图形 增加 矩形 热点 区 ， 具体 就是 将 springbmp 图形 装入 名为 DispPict 的 Picture 控件 中 ， 然后 在 Spring 图画 上 画个 Image 控件 。 每个 矩形 覆盖 相应 的 区域 ， 使用 点击 事件 执行 各自 的 代码 ， 产生 不同 的 效果 ， 显示 音乐 喷泉 。 CD 播放器 　 　 通过 MCI 控件 ， 可以 非常 方便 地 在 程序 中 访问 各种 媒体 设备 。 在 设计 时 ， 将 MultimediaMCI 控件 加 到 窗体 FrmMusicSpring 上 ， 其 按钮 被 分别 定义 为 Play 、 Pause 、 Back 、 Stop 和 Eject 。 在 允许 用户 从 MultimediaMCI 控件 选取 按钮 之前 ， 程序 先 将 MCI 设备 打开 ， 并 在 MultimediaMCI 控件 上 启用 适当 的 按钮 。 在 VisualBasic 中 ， 应 将 MCIOpen 命令 放到 FormLoad 事件 中 执行 MCICommandOpen 。 　 　 如果 想 使用 MultimediaMCI 控件 中 的 按钮 ， 要 将 Visible 和 Enabled 属性 设置 为 True 。 如果 不想 使用 控件 中 的 按钮 ， 而 只是 想用 MultimediaMCI 控件 的 多媒体 功能 ， 可 将 Visible 和 Enabled 属性 设置 为 False 。 无论 有无 用户 交互 ， 应用程序 均 可 控制 MCI 设备 。 MultimediaMCI 控件 的 事件 按钮 定义 是 可编程 的 。 通过 开发 按钮 事件 代码 ， 可以 增加 甚至 完全 重新 定义 按钮 的 功能 。 　 　 根据 实际 要求 设计 的 CD 播放器 较为 复杂 ， 同 常规 CD 播放器 有所不同 ， 需要 进行 说明 的 是 ， 在 MCI 控件 上击 播放按钮 播放 所 选 音轨 ， 可用 暂停 和 停止 按钮 。 如果 需要 重听 一段 音轨 按 字母键 S 就 确定 了 音轨 的 开始 时间 ， 按 字母键 X 确定 了 音轨 的 结束 时间 ， 这时 重 放 按钮 自动 使能 ， 单击 重 放 然后 击 播放 ， 该段 音轨 开始 重播 。 但 仅仅 按 字母键 X 时 ， 有 两种 情况 ： 　 　 若 是 初次 按 字母键 X 而 没有 按过 字母键 S ， 则 重听 该段 音轨 的 开始 时间 为 ： ， 结束 时间 为 按 字母键 X 时 的 时间 。 　 　 若 已经 按过 字母键 S 和 字母键 X ， 在 这种 情况 仅仅 按 字母键 X ， 则 重听 该段 音轨 的 开始 时间 为 上次 所 按 字母键 S ， 结束 时间 为 所 按 字母键 X 时 的 时间 。 听过 重播 后 再 按 字母键 X 还有 连续 重播 的 功能 。 造型 码 编辑 界面 　 　 创建 MSFlexGrid 数据 显示 造型 码 的 步骤 如下 ： 　 　 屏幕 状态 变化 和 所 接受 字母 　 　 按 字母键 R 使 编辑 界面 放大 至 整个 屏幕 ， 可 在 全屏幕 状态 下 编辑 造型 码 ， 按 字母键 Q 使 编辑 界面 缩小 至 原来 的 状态 可 使用 编辑 键 或 鼠标 点击 移动 焦点 到 相应 单元格 。 　 　 编辑 界面 接受 的 字符 为 数字 字母 小写 英文字母 af 大写 英文字母 AF 和 字母 等 为 合法 字符 其它 字符 不予 接受 ， 以 确定 造型 编码 的 简洁 与 正确 。 　 　 创建 控件 和 设置 属性 　 　 在 FrmMusicSpring 窗体 上 添加 一个 MsFlexGrid 控件 并 在 其 内部 添加 一个 TextBox 控件 ， 由此 创建 父子关系 。 其 属性 设置 见表 。 　 　 编辑 造型 码 模块 程序 功能 　 　 具体 分为 添加 行 列表 头 ， 使 它 在 外观 上 与 工作 表 相象 。 添加 单元 内部 编辑 功能 目的 是 移动 和 选择 一组 单元 。 向 文本框 编辑框 添加 更新 数据 的 功能 ， 将 数据 从 文本框 复制到 MsFlexGrid 的 功能 。 表 属性 设置 表 对象 属性 设置 值 MSFlexGridcolsrowsfillstylerepeatfocusrectheavyTexiBoxNametxtEditborderstylenonevisiblefalse 通信 模块 　 　 在 这个 模块 中 ， 采用 了 Mscomm 控件 ， 首先 让 用户 选 好 通信 端口 ， 然后 将值 赋 给 Mscomm 的 CommPort 属性 ， 并 将 settings 属性 设置 为 ， N ， ， ， 即 波特率 ， 无 奇偶校验 ， 位 数据位 ， 位 停止 位 。 OutBufferSize 输出 缓冲区 大小 属性 设 为 ， SThreshold 设为 ， 即 输出 缓冲区 中有 个字符 时 ， 就 发送 出去 。 握手 协议 采用 XonXoff 协议 ， 所以 Handshaking 属性 设为 ComXonXoff 。 　 　 程序运行 中 ， 用户 点击 启动 按钮 时 ， 则 在 一 拍 开始 的 时候 ， 把 编辑 表单 中 的 相对 应 的 一行 造型 码 ， 先 将 ASCII 码 转换成 十六进制 ， 然后 每 两个 合为 一个 ASCII 码以 缩短 总 代码 的 长度 ， 提高 传输 效率 ， 在 此基础 上 再 在 前面 加上 同步 字符 ， 总共 是 个字符 一起 读进 传输 缓冲区 ， 然后 发送 出去 。 造型 码及 仿真 画面 　 　 系统 中有 个 喷泉 泵 ， 其中 、 、 号泵 每个 泵 控制 一个 喷头 ， 其它 的 泵 每泵 控制 两个 喷头 ， 如图所示 。 此外 还有 组灯 ， 其中 号 和 号 是 二路 环灯 ， 即 每组 灯 可以 循环 亮 、 灭 。 号 是 一般 彩灯 。 二路 环灯 的 造型 码为 XY ， X 表示 每组 灯开 的 个数 ， Y 表示 循环 的 间隔时间 ， 以 毫秒 为 单位 。 号 灯用 一个 字节 控制 ， 字节 的 每 一位 表示 一个 灯 ， 为开 ， 为关 。 　 　 仿真 画面 上 喷泉 用 一组 Image 控件 数组 表示 ， 灯用 一组 Shape 控件 来 表示 ， 这样 可以 用 循环 语句 来 进行 控制 。 程序运行 时 ， 先 把 一 拍 的 造型 码 发送给 下 微机 ， 接下来 按 上面 的 思想 对 每 拍 的 造型 码 进行 分析 ， 同时 把 表示 喷泉 的 Image 控件 用 它 的 Move 方法 进行 相应 的 调整 ， 并 通过 把 Shape 控件 的 Fillcolor 属性 置 为 它 的 Bordercolor 和 灰色 来 表示 灯 的 亮 、 灭 。 在 一 拍 时间 到 了 之后 ， 接下来 继续 下面 的 节拍 。 　 　 因 计算 出 节拍 的 时间 与 实际 节拍 的 时间 有些 误差 ， 则 节拍 时间 相加 后 可能 与 实际 音乐 播放 时间 不符 ， 如 提前 于 实际 时间 ， 则 最后 一拍 适当 延长 。 如拖后 ， 则 最后 一拍 的 控制 时间 缩短 此 时间差 ， 每 拍 的 时间 长度 存于 一个 数组 中 ， 用户 计算 好 节拍 的 时间 后 ， 填入 从 哪 拍 起 至 哪 拍止 ， 将 所有 节拍 时间 相加 ， 与 实际 播放 时间 比较 ， 再 对 最后 一拍 的 时间 长度 进行 调整 。 编辑 模块 　 　 该 模块 有个 功能 ， 分别 是 插入 一行 、 删除 一行 、 复制 、 粘贴 。 插入 、 删除 功能 利用 了 线性表 的 插入 、 删除 算法 。 但 插入 一行 、 删除 一行 同 常规 有所区别 ， 这里 的 插入 一行 是 插入 后原 造型 码表 单 的 最后 一行 自动 失效 ， 目的 就是 保证 造型 码 节拍 的 一致 ； 删除 一行 是 删除 后 造型 码表 单 的 最后 一行 的 每个 单元格 自动 置 两个 空格 。 复制 、 粘贴 功能 主要 利用 了 MSFlexGrid 控件 的 Clip 属性 和 Clipboard 对象 的 SetText 方法 和 GetText 方法 实现 。 结论 　 　 本 系统 采用 两级 控制 方式 ， 解决 音乐 喷泉 的 水泵 滞后 及 节拍 的 同步 问题 。 软件系统 采用 面向对象 的 程序设计 方法 ， 使用 了 可视化 的 编程 工具 VB ， 因 VB 的 可视性 和 面向 事件 及 对象 等 特征 使 Windows 应用程序 的 开发 变得 简便 ， 高效 ， 它 大大提高 了 基于 Windows 的 实时 仿真 软件 的 开发 效率 ， 解决 了 音乐 喷泉 控制 码 编程 的 可视化 及 喷泉 造型 的 实时 仿真 问题 ， 缩短 了 开发周期 ， 其 高质量 的 人机界面 倍受 用户 的 赞誉 ， 友好 的 操作 环境 使 用户 易于 使用 ， 目前 该 系统 已 通过 厂商 的 验收 并 正式 交付使用 。 作者 单位 ： 上海大学 计算机 工程 与 科学 学院 ， 上海 参考文献 孙兵 单片机 在 音乐 喷泉 控制 中 的 应用 黑龙江 自动化 技术 与 应用 ， 徐子振石 冰心 使用 VB 设计 Windows 环境 下 的 异步 通信 程序 微电脑 世界 ， 焦纯 Windowsx 下 VB 两种 通信 方式 微电脑 世界 ， ApplemanDVisualBasicProgrammersGuideToTheWindowsAPI 北京 ： 电子 工业 出版社 ， CornellGGrawMTheVisualBasicforWindowsHandbookHillPublication