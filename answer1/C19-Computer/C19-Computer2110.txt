计算机 工程 COMPUTERENGINEERING 年 第卷 第期 volNo 具有 真实感 的 虚拟 装备 生成 方法 刘鹏远 　 张锡恩 　 杨军 　 　 使用 三维 建模 工具 建立 三维 模型 ， 然后 将 其 输出 至 开发 环境 ， 是 实现 导弹 武器 系统 虚拟 装备 的 一个 重要环节 。 目前 ， 有 帮助 用户 直接 从 DSMAX 输出 成 Playstation 、 SegaSaturn 、 DirectDraw 格式 的 外挂 模块 。 许多 前期 制作 的 实时 三维 应用 编程 接口 提供 DS 或者 DXF 格式 的 专用 转换器 ， 但是 这些 工具 对 三维 模型 细节 操作 的 功能 相对 较差 ， 而且 通用性 不是 很 好 。 在 系统 中 ， 开发 了 一个 比较 灵活 并且 通用性 较 好 的 转换 工具 ， 利用 这个 工具 实现 了 从 三维 建模 工具 到 开发 环境 的 平滑 、 不 失真 转换 。 系统 使用 的 三维 建模 工具 是 DSMAX ， 它 的 输出 形式 是 DXF 格式文件 ； 而 在 WindowsNT 环境 下 使用 的 三维 图形 工具 则 是 OpenGL ， 系统 工作 流程图 如图所示 。 图 系统 工作 流程图 　 　 DXF 文件 是 AutoDesk 公司 推出 的 一种 主要 用于 AutoCAD 系统 的 图形 交换 文件格式 ， 具有 容易 阅读 、 易于 程序处理 、 命令 直接 输入输出 等 优点 ， 因此 在 各类 图形系统 中 得到 了 广泛 的 应用 ， 已 成为 事实上 的 工业 标准 。 OpenGL 是 近几年 发展 起来 的 性能 卓越 的 三维 图形 标准 ， 它 是 在 SGI 等 多家 世界闻名 的 计算机 公司 的 倡导 下 ， 以 SGI 的 GL 三维 图形库 为 基础 制定 的 一个 通用 共享 开放式 图形 标准 。 它 独立 于 窗口 系统 和 操作系统 ， 以 它 为 基础 开发 的 应用程序 可以 十分 方便 地 在 各种 平台 间 移植 。 DXF 文件 分析 及 读取 　 　 一个 DXF 文件 包含 有 Header 标题 节 、 Tables 表节 、 Blocks 块节 、 Entitles 实体 节 、 Endoffile 文件 结束 标志 等 组成部分 ， 其中 实体 节 存储 着 三维 实体 的 几何 要素 及 拓扑 结构 ， 是 主要 分析 的 对象 。 以 在 DSMAX 中 建立 导弹 发射 车为例 ， 它 包含 数十个 实体 ， 如 Line 、 Circle 、 Loft 、 Box 等 ， 具体分析 DXF 文件 是 怎样 实现 几何 要素 和 拓扑 结构 的 存储 的 。 DXF 文件 中 几何 要素 的 描述 　 　 在 实体 节中 ， 可以 包含 各种 基本 绘图 实体 的 描述 ， 如 Line 、 Circle 、 Triangle 、 Arc 、 Point 、 Trace 、 Solid 、 Text 、 Vertex 等 。 导弹 发射 车 包含 许多 实体 ， 每 一个 实体 都 由 若干个 三角形 构成 ， 而 对 三角形 的 描述 则 是 通过 对 顶点 的 描述 来 实现 的 ， 以下 一段 代码 取自 对 导弹 发射 车 车轮 Truckwheel 实体 的 描述 ， 具体 形式 为 ： … VERTEX 标记 该 几何 要素 为 顶点 类型 TRUCKWHEEL 该 要素 属于 TRUCKWHEELX 轴 坐标 Y 轴 坐标 Z 轴 坐标 几何 要素 描述 标志 … DXF 文件 中 拓扑 结构 的 描述 　 　 只有 了解 几何 要素 的 拓扑 结构 ， 才能 将 一个个 的 几何 要素 组织 起来 ， 成为 三维 实体 。 在 DXF 文件 中 用 三角形 近似 组成 三维 实体 ， 这 是因为 除 三角形 外 的 多边形 和 顶点 可能 不共面 ， 有时 不是 简单 多边形 ， 使 OpenGL 不能 正常 工作 。 仍以 Truckwheel 实体 为例 ， 其 拓扑 结构 的 描述 如下 ： … VERTEX 描述 的 是 顶点 的 拓扑 结构 TRUCKWHEEL 这些 顶点 属于 TRUCKWHEEL 拓拟 结构 描述 志 按 逆时针 方向 ， 指定 三角形 的 三个 顶点 ， 序号 代表 在 几何 要素 描述 中 顶点 出现 的 顺序 … 图形 数据库 　 　 为了 便于 图形 数据 的 维护 管理 ， 提高 对 图形 数据处理 的 速度 ， 实现 图形 由 场景 → 实体 → 几何 要素 的 存储体系 ， 系统 开发 了 一个 针对 DXF 文件 的 基于 关系数据库 的 图形 数据库 管理系统 ， 实现 对 几何 要素 和 拓扑 结构 的 分类 存储 ， 并 装配 多媒体信息 。 　 　 开发 图形 数据库 是 系统 的 一个 特色 ， 它 具有 几项 优点 ： 数据 模式 完整 ； 数据 维护 容易 ， 便于 实现 对 图形 数据 的 增加 、 删除 、 查询 操作 ； 多用户 并发 控制 ， 安全性 、 完整性 控制 均 能 得到 保证 ； 数据 层次 清晰 ， 易于 实现 对 数据 的 细节 操作 ， 数据 定位 的 层次 可以 到 点级 。 　 　 在 进行 图形库 设计 时 ， 构建 了 一个 包括 场景 表 Scene 、 实体 表 Solid 、 几何 要素 表 Source 、 拓扑 结构 表 Destination 、 纹理 表 Texture 、 媒体 信息 表 Multimedia 、 索引 表 Index 的 数据库 ， 实现 对 图形 数据 的 存储 及 在 WindowsNT 下 媒体 及 纹理 的 装配 。 如图 。 图 图形库 结构图 利用 OpenGL 再现 三维 模型 法 　 　 线 矢量 的 计算方法 ： 对于 由 空间 三角形 构成 的 导弹 武器 系统 虚拟 设备 ， 要 将 它 显示 为 具有 真实感 的 图形 需要 进行 一系列 可视化 处理过程 。 其中 包括 建立 光照 模型 、 进行 表面 法 向量 计算 、 纹理 映射 等 ， 在 这里 只 介绍 表面 法 向量 的 计算方法 。 图 计算 法线 向量 的 示意图 　 　 三维 虚拟 设备 是 由 空间 多边形 构成 的 。 当 采用 OpenGL 提供 的 光照 模型 照亮 它 时 ， 只要 知道 网格 体 表面 某 一点 的 法 向量 ， 就 可算出 该点 的 明暗 程度 。 OpenGL 是 采用 冯氏 阴影 法 Phongshading 计算 明暗 程度 的 ， 但是 顶点 法 向量 的 计算 却 不是 自动 完成 的 ， 必须 由 程序员 自己 定义 。 为了 保证 生成 具有 真实感 的 图形 ， 需要 根据 三角 面所处 的 位置 ， 决定 其法 向量 的 计算方法 。 根据 构成 几何体 的 三角 面所处 位置 的 不同 ， 分 两种 情况 进行 考虑 ： 　 　 对于 变化 比较 剧烈 区域 的 三角 面 直接 计算 三角 面 法线 矢量 ， 并 将 其 作为 各 顶点 的 法 向量 。 由于 图形 数据库 的 引入 ， 致使 数据 的 层次结构 更 清晰 ， 为 查询 变化 比较 剧烈 区域 的 顶点 提供 了 方便 。 查询 顺序 如图 。 图 查询 顺序 　 　 法 向量 计算方法 ： vvv 为 三角 面 的 个 顶点 ， 其叉积 vv × vv 为 各 顶点 的 法 向量 。 如图 中 的 R 点要 分别 处理 交界面 上 的 法线 。 　 　 对于 构成 光滑 曲面 的 三角 面 ， 若 采用 以上 方法 计算 法 向量 ， 由于 每个 平面 上 所有 点 的 法 向量 相同 ， 而 不同 平面 块 之间 存在 不 连续 的 法 向量 跳跃 ， 当 网格 体中 相邻 的 两个 平面 多边形 的 法 向量 变化很大 ， 就 会 产生 明显 的 拼接 痕迹 ， 显示 图形 的 真实感 会 降低 。 为了 生成 具有 光滑 变化 且 有 明暗 程度 的 真实感图形 ， 这里 对 计算 法 向量 的 算法 进行 改进 。 　 　 如图所示 ， 为了 计算 P 点 的 法 向量 ， 首先 用 上述 的 方法 计算 相邻 各 三角 面 的 法线 矢量 n ， n ， n ， n ， n ， n ， 然后 为 避免 在 相邻 平面 上 某个 法线 值过 大 ， 将求 出 的 nnnn 做 归一化 处理 ， 即为 P 点 的 法线 。 　 　 使用 以上 方法 ， 实现 了 具有 真实感 的 导弹 武器 系统 虚拟 装备 的 生成 ， 这种 方法 对于 建立 大型 智能 维修 训练 和 仿真 系统 的 可视化 环境 将会 有 一定 的 参考 作用 。 作者 单位 ： 军械 工程学院 导弹 工程系 ， 石家庄 参考文献 HearnDBakerMP 计算机 图形学 北京 ： 电子 工业 出版社 PrenticeHall 出版 公司 白燕斌 史惠康 OpenGL 三维 图形库 编程 指南 北京 ： 机械 工业 出版社