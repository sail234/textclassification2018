微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 　 Vol 　 No 　 P 基于 VisualBasic 的 瞬态 图像 采集 系统软件 设计 于 复生 　 艾兴 　 刘素萍 摘要 ： 对 VisualBasic 在 动态 散斑 瞬态 图像 采集 系统软件 编程 方面 的 应用 进行 了 探讨 ， 并 对 其 数据处理 、 I ／ O 操作 、 DLL 动态链接库 的 编制 与 调用 、 测控 系统 动画 模拟 显示 等 进行 了 研究 。 关键词 ： VisualBasic 　 瞬态 图像 采集 　 数据处理 　 　 随着 现代 测量 系统 数据处理 量 的 增大 ， 其 主控 机 也 越来越 多地 采用 高档 计算机 。 Windows 系统 的 普遍 使用 ， 迫使 新 的 测量 系统 采用 Windows 编程 。 面向 MicrosoftWindows 系统 的 语言 程序 为 用户 设计 优美 的 图像 界面 提供 了 方便 ， 为 测控 系统 建立 高度 友好 的 用户界面 奠定 了 基础 ， 其中 VisualC ＋ ＋ VC 和 VisualBasicVB 都 是 Windows 编程 的 强有力 的 工具 。 VC 功能强大 ， 既 能 直接 访问 CPU 的 各个 寄存器 ， 又 能 访问 内存 的 相关 单元 ， 尤其 注重 于 编程技术 细节 的 应用 和 代码 的 优化 ， 但 一般 人 难以 在 短时间 内 掌握 ； 而 VB 则 摆脱 了 所有 的 低层 信息处理 ， 它 只 自动 地 处理 消息 ， 其它 的 处理 作为 事件 过程 由 编程 者 自行处理 。 其 模块化 编程 优势 明显 ， 因而 开发者 可以 快捷 地 创建 功能强大 的 应用程序 ， 摆脱 了 传统 的 开发 程序 所 带来 的 惊人 的 工作量 。 然而 在 测量 、 控制系统 中 ， 由于 VB 不能 直接 访问 计算机 的 寄存器 和 内容 单元 ， 给 测控 系统 的 软件开发 带来 了 一定 的 困难 。 本文 就 所 研制 的 动态 散斑 图像 采集 系统 的 VB 编程 ， 对 VB 如何 用于 测控 系统 的 软件设计 作 了 探讨 。 系统 的 构成 　 　 本 图像 采集 系统 的 主要 构成 如图所示 。 其 主要 部分 有 作为 动态 散斑 光源 的 脉冲 激光器 、 CCD 镜头 、 插入 计算机 主板 的 P 图像 采集卡 和 图像 显示器 及 相应 的 测量 工件 。 由于 P 卡 没有 外 触发 接口 ， 基于 其 可编程 的 C语言 函数 ， 本 系统 采用 了 DLL 动态链接库 的 方式 ， 对系统 从 键盘 入口 进行 了 改制 ， 从而 完成 了 准确 的 时间 控制 ， 达到 激光 光 脉冲 的 出发 与 CCD 的 图像 采集 时间 上 的 一致 。 图 系统 构成 图 系统 的 数据处理 　 　 相对 于 其它 语言 来说 ， VB 的 数据结构 相对 简单 。 对于 一般 的 测控 系统 ， 其 浮点数 运算 较 多 ， 而 计算机 处理 整型 数 的 速度 要 远高于 处理 浮点数 的 速度 ， 因而 为了 不 影响 测控 数据 的 处理速度 ， 最好 在 系统 中 把 采集 到 的 数据 转化 为 整型 数 进行 处理 ， 其 结果 再 转换 为 浮点数 存储 、 显示 及 打印 。 　 　 用 VB 编制 图像 采集 与 处理 的 系统 ， 由于 图像 数据 的 存储 采用 二进制 方式 ， 不可避免 地要 使用 Byte 数据类型 。 在 转换 期间 用 Byte 变量 存储 二进制 数据 ， 当 String 变量 在 ANSI 和 Unicode 格式 间 进行 转换 时 ， 变量 中 的 二进制 数据 会 遭到 破坏 ， 在 下列 的 任何 一种 情况 下 ， VB 都 会 自动 在 ANSI 和 Unicode 之间 进行 转换 ： 读 文件 时 ； 写 文件 时 ； 调用 DLL 时 ； 调用 对象 的 方法 和 属性 时 。 也就是说 在 上述 几种 情况 下 数据 都 有 可能 遭到 破坏 。 所以 ， 对于 图像 采集 中 的 数据处理 而言 ， 为了 避免 出错 ， 数据处理 应 在 DLL 中 完成 ， 而 VB 仅 用来 在 界面 中 显示 数据 结果 。 I ／ O 操作 　 　 测控 系统 有 较 多 的 输入输出 操作 。 VisualBasic 虽然 有 较 强 的 用户界面 设计 能力 ， 但 没有 提供 直接 的 I ／ O 操作 功能 ， 当 用户 使用 诸如 AD 板 、 图像 采集卡 等 即插即用 的 功能 板时 ， 给 VB 编程 带来 了 一定 的 困难 。 这 就 需要 用户 利用 其 丰富 的 用户 控件 VBX 、 动态链接库 DLL 、 动态 数据交换 DDE 及 对象 的 链接 与 嵌入 技术 OLE 来 对 其 功能 进行 扩展 。 从 原则上 说 ， 这些 技术 都 可以 实现 I ／ O 操作 ， 但 又 各 有 其 应用 上 的 侧重点 。 使用 通信 控件 　 　 VB 的 通信 控件 MSCOMMVBX 提供 了 一系列 标准 通信 命令 的 使用 界面 ， 可以 用来 建立 与 串行口 的 连接 ， 通过 串行口 连接 到 其它 设备 ， 发出 命令 ， 交换 数据 ， 以及 监视 和 响应 串行口 连接 中 发生 的 事件 和 错误 。 但 它 只能 用于 与 串行口 连接 的 器件 。 使用 动态 数据交换 DDE 　 　 动态 数据交换 是 一种 进程 间 的 数据交换 形式 。 应用程序 可 通过 DDE 进行 一次性 的 数据传输 ， 也 可 进行 现场 数据 的 交换 。 这种 方式 总是 在 个 客户 应用程序 和 个 服务 应用程序 之间 进行 ， 它们 之间 通过 建立 会话 的 方式 ， 基于 信息 传递数据 。 其 最大 优点 就是 当 DDE 会话 建立 起来 以后 ， 它 一般 可 在 没有 用户 参与 的 情况 下 ， 按照 事先 定好 的 规则 ， 自动 地 进行 数据 的 交换 ， 它 比较 适合 于 二 程序 间 实时 的 数据交换 。 采用 OLE 技术 　 　 OLE 是 继 DDE 之后 发展 起来 的 一种 崭新 的 数据交换 技术 。 OLE 提供 的 信息 传递 的 基本 单位 是 对象 — — 包括 数据 及 操纵 数据 的 方法 的 完整 对象 。 OLE 功能强大 ， 支持 可视化 编程 、 应用程序 间 拖放 操作 及 OLE 自动化 和 对象 的 结构化 存储 等 多项 功能 的 实现 。 但 它 主要 是 面向 文档 的 交换 技术 。 对于 实时 测控 的 数据处理 ， 这种 技术 并 不 合适 。 　 　 在 我们 所 研制 的 图像 采集 系统 中 ， P 图像 采集卡 是 中科院 科技 嘉 公司 早期 的 图像 采集 系统 的 主要 板卡 。 主要 应用 于 DOS 环境 ， 有个 CCD 视频信号 入口 和 个 图像 监视器 信息 出口 ， 无 直接 的 外 触发 功能 。 它 的 所有 功能 既 可以 作为 单独 的 函数 在 TurboC 下 调用 ， 又 可以 用 其 集成 环境 PCANVEEXE 。 为了 应用 该 图像 采集卡 的 图像 采集 和 处理函数 上 的 方便 ， 我们 采用 了 DLL 方式 ， 由 VB 来 调用 TC 的 图像 采集 及 处理 模块 。 DLL 的 建立 与 调用 DLL 的 建立 　 　 动态链接库 DLL 类似 于 运行 函数库 ， 程序运行 期间 被 链接 进来 ， 是 组成 Windows 系统 的 重要 元素 之一 。 DLL 程序 一般 采用 C 或 C ＋ ＋ 语言 ForWindows 版本 进行 编程 。 它 主要 由 模块 定义 文件 DEF 、 动态 链接 函数 头文件 H 、 动态链接库 文件 C 三 部分 组成 。 　 　 下面 用 我们 编制 的 图像 采集 程序 来 示例 动态链接库 的 各 部分 结构 。 模块 定义 文件 　 　 LibraryPictureCollection 　 　 Description ″ 图像 采集 动态 模块 定义 文件 ″ 　 　 ExeTypeWindows 　 　 Stub ″ PictCollEXE ″ 　 　 CodePreloadMoveableDiscardable 　 　 DataPreloadMoveableSingle 　 　 Heapsize 　 　 ExportsWeb 　 　 　 　 　 　 　 ＠ RESIDENTINAME 　 　 　 　 PICTURE ＿ COLLECT 　 　 ＠ 　 　 　 　 READ ＿ PORT ＿ VALUE 　 　 ＠ 　 　 　 　 WRITE ＿ PORT ＿ VALUE 　 ＠ 　 　 　 　 CLR ＿ PORT ＿ BIT 　 　 　 ＠ 　 　 　 　 SET ＿ PORT ＿ BIT 　 　 　 ＠ 　 　 　 　 INITCARD 　 　 　 　 　 　 ＠ 　 　 　 　 SAVE ＿ PICTURE 　 　 　 　 ＠ 　 　 　 　 EXTERL ＿ SINGLE 　 　 　 ＠ 　 　 这里 应该 定义 所有 的 输入输出 函数 ， 并且 所有 的 函数 都 必须 在 EXPORTS 硬件 中 进行 说明 ， 每 一个 函数 的 后面 是 其 唯一 的 序列号 ， 即 出现 在 ＠ 符号 后面 的 数字 。 动态 链接 函数 头文件 　 　 这部分 主要 是 定义 DLL 的 库函数 ， 如下 所示 ： 　 　 intFARPASCALPICTURE ＿ COLLECTint ， int ； 　 　 intFARPASCALREAD ＿ PORT ＿ VALUEint ； 　 　 intFARPASCALWRITE ＿ PORT ＿ VALUEint ， un － 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 signedchar ； 　 　 intFARPASCALCLR ＿ PORT ＿ BITint ， int ， int ； 　 　 intFARPASCALSET ＿ PORT ＿ BITint ， int ， int ； 　 　 voidFARPASCALINITCARDint ； 　 　 intFARPASCALSAVE ＿ PICTUREunsignedchar ； 　 　 intFARPASCALEXTERL ＿ SIGNLEunsignedchar ； 动态 链接 函数 文件 　 　 这部分 是 DLL 库函数 的 核心 部分 ， 每 一个 函数 的 编程 大体上 与 在 DOS 下 编程 一样 。 　 　 ＃ include ″ windowsh ″ 　 　 ＃ include ″ dosh ″ 　 　 ＃ include ″ pdrvh ″ ／ P 图像 采集卡 的 驱动 函数库 ／ 　 　 ＃ include ″ stdioh ″ 　 　 ＃ include ″ malloch ″ 　 　 ＃ include ″ biosh ″ 　 　 intFARPASCALLibmainHANDLEhinstance ， WORDwDataseg ， WORDwHeapsize ， LPSTRlpszCmdline 　 　 　 … … 　 　 return ； 　 　 　 intFARPASCALWEPintnParameter 　 　 　 … … 　 　 return ； 　 　 　 intFARPASCALset ＿ baseintb 　 　 　 　 　 　 　 　 　 ／ 设置 图像 采集卡 的 基 地址 ／ intFARPASCALPICTURE ＿ COLLECTintEX － 　 　 　 　 　 　 　 　 　 TERL ＿ SIGNAL ， intSAVE ＿ PICTURE 　 　 unsignedcharcolor ； 　 　 inti ； 　 　 SysInit ； 　 　 GrabImagegreenBank ； 　 　 printf ″ ＼ nPressanykeytoaccepttheEXTERL 　 　 　 　 SIGNALtofreezeimage ＼ n ″ ； 　 　 　 　 ＿ bios ＿ keybrd ＿ KEYBRD ＿ READ ； 　 　 ifEXTERL ＿ SIGNAL ＝ NULLFreezeImage ； 　 　 … … ／ 图像处理 的 其它 程序 ／ 　 　 　 注意 ， 上面 的 LinMain 和 WEP 函数 是 DLL 所 必需 的 函数 ， 不能 省略 。 　 　 当 动态链接库 设计 好后 ， 就 可以 在 VisualBasic 中 调用 DLL 的 相应 子程序 ， 达到 对 相应 接口 电路 的 检测 、 控制 的 目的 。 DLL 的 调用 　 　 VisualBasic 通过 Declare 声明 来 访问 DLL 。 其 编译器 根据 声明 确定 参数 ， 检查 数据类型 ， VB 在 运行 期间 也 根据 声明 处理 参数 ， 进行 压栈 、 出栈 的 管理工作 。 只要 程序 在 Form 部分 或 共用 模块 中 声明 了 DLL 过程 ， 用户 就 可以 像 使用 VB 关键字 或 用户 定义 的 VB 过程 一样 ， 方便 地 使用 DLL 中 的 函数 。 　 　 声明 存储 在 DLL 中 的 过程 子程序 的 格式 如下 ： 　 　 DeclareSubUserFuncLib ″ DLLNameDLL ″ Alias 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ″ DLLFunc ″ Parameters 　 　 如果 是 函数 ， 其 格式 则 为 ： 　 　 DeclareFunctionUserFuncDATAtypesuffixLib ″ DLLNameDLL ″ AliasDLLFunc ″ ParametersAsdatatype 　 　 参数传递 方式 为 ： 　 　 在 缺省 状态 下 ， 传递函数 或 过程 的 参数 采用 地址 传送 方式 ， 即 “ byreference ” ， 实参 在 DLL 的 函数 或 过程 中 能够 被 修改 ， 并且 返回 修改 后 的 值 。 　 　 如果 参数 是 通过 数值 方式 来 传送 的 ， 则 应 传给 DLL 函数 或 过程 的 只是 个 参数值 的 副本 ， DLL 函数 或 过程 对 该 参数 的 操作 不会 影响 其 原始 数值 ， 如果 调用 DLL 函数 过程 中 ， 希望 通过 数值 方式 传递 参数 ， 则 需用 “ ByVal ” 关键字 指出 参数 是 按值 来 传递 的 。 　 　 例如 ： SubDataCollectionByValtimeAsInteger 　 　 　 　 　 　 　 　 　 这里 放 语句 　 　 　 　 　 　 　 　 EndSub 动画 的 显示 　 　 为了 使 系统 的 界面 丰富 生动 ， 可视性 强 ， 使 系统 的 数据 具有 图像 立即 显示 功能 ， 系统 的 运行 中应 采用 动画 显示 。 实现 动画 显示 的 方法 有 很多 ， 针对 不同 的 部分 而 选择 合适 的 方法 。 　 　 对于 在 程序 中 固定不动 的 图像 ， 为了 减少 在 系统 运行 时 占用 的 时间 ， 可以 采用 其它 的 面向 Windows 的 作图 工具 ， 如 PowerPoint ， Photoshop ， PaintBrush 等 做好 图后 ， 作为 VB 的 Picture 控件 嵌入 系统 界面 。 　 　 对 虽 是 动态 ， 但 其 状态 转换 很慢 的 图像 ， 如 指示灯 、 仪表 头等 ， 可以 对 其 每 一种 状态 着 不同 的 颜色 后 分别 以 不同 状态 部件 的 裁剪 文件 形式 存盘 ， 形成 各种 部件 的 多 状态 裁剪 文件 。 然后 在 系统 中 创建 个 窗体 ， 并 在 窗体 中 使用 图像 控件 内部 图像 不变 与 图片 控件 内部 图像 可变 来 构造 动画 显示 。 系统 运行 时 ， 程序 将 根据 数据 的 变化 而 动态 地 改变 显示 的 内容 。 当 部件 的 状态 变化 时 ， 只 需 将 部件 的 变化 状态 控件 的 图像 内容 赋值 给 其 标准 控件 ， 而 这 在 VB 中 只 需要 条 语句 即可 实现 。 　 　 对于 某些 部件 的 复杂 变化 或是 数据 曲线 的 显示 ， 一方面 可以 利用 VB 提供 的 复杂 的 图像处理 控件 如 Gauge 控件 等 来 实现 ； 另一方面 可以 利用 动态链接库 DLL 调用 Windows 的 API 中 的 图像处理 函数 进行 编程 实现 。 　 　 VisualBasic 已 成为 Windows 系统 开发 的 主要 语言 ， VB 以其 良好 的 图形 用户 接口 、 面向对象 的 程序设计 以及 结构化 的 事件驱动 编程 模式 ， 使 编程 效率 大大提高 ， 应用 功能 增强 。 采用 VB 开发 测控 系统 的 应用软件 ， 只要 能够 处理 好 实时处理 部分 ， 就 能 在 短时间 内 开发 出 交互 界面 友好 、 功能 易 扩展 、 面向对象 的 测控 系统 。 本文 利用 VB 编程 ， 应用 图像 采集卡 ， 采用 DLL 动态链接库 技术 ， 完成 了 基于 Windows 的 图像 采集 系统 。 该 编程 方法 同样 可以 很 好 地 应用 于 其它 的 实时 测控 系统 中 。 于 复生 （ 济南 山东 工业 大学 机械 工程学院 ） 艾兴 （ 济南 山东 工业 大学 机械 工程学院 ） 刘素萍 （ 济南 山东 工业 大学 机械 工程学院 ） 参考文献 ， 王占杰 ． 多 进程 的 数据交换 ． 工控 电子 ， ； （ ） ： ， 史慧康 ． VisualBasic ． 实用 编程技术 ． 北京 ： 中国 水利水电 出版社 ， 收稿 日期 ： － －