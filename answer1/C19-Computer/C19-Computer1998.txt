微型机 与 应用 WEIXINGJIYUYINGYONG 年 月 第卷 第期 volNoSPI 串行总线 在 单片机 应用 系统 中 的 实现 卜玉明 　 　 摘 　 要 ： MCS 系列 、 MCS 系列 、 ATMEL 系列 等 单片机 应用 很广 ， 但 它们 均 没有 SPI 串行总线 接口 ， 限制 了 在 这些 系统 中 使用 具有 SPI 总线 接口 器件 的 应用 。 本文 将 介绍 SPI 串行总线 的 性能 ， 并 以 串行 EPROM 为例 ， 给出 了 在 单片机 上 利用 IO 线 实现 SPI 串行总线 的 方法 和 软件设计 。 　 　 关键词 ： 单片机 　 SPI 串行总线 　 总线 接口 　 SPI 总线 　 　 SPISerialPeripheralInterface — — 串行 外设 接口 总线 系统 是 一种 同步 串行 外设 接口 ， 允许 MCU 与 各种 外围设备 以 串行 方式 进行 通信 、 交换 信息 。 外围设备 包括 简单 的 TTL 移位 寄存器 用作 并行 输入 或 输出 口至 复杂 的 LCD 显示 驱动器 或 AD 转换器 等 。 SPI 系统 可 直接 与 各个 厂家 生产 的 多种 标准 外围 器件 直接 接口 ， 它 使用 条线 ： 串行 时钟 线 SCK 、 主机 输入 从机 输出 数据线 MISO 、 主机 输出 从机 输入 数据线 MOSI 和 低电平 有效 的 从机 选择 线 SS 。 由于 SPI 系统总线 只 需 ～ 位 数据线 和 控制线 即可 扩展 具有 SPI 的 各种 IO 器件 ， 而 并行 总线 扩展 方法 需根 数据线 、 ～ 位 地址 线 、 ～ 位 控制线 ， 因而 SPI 总线 的 使用 可以 简化 电路设计 、 省掉 了 很多 常规 电路 中 的 接口 器件 、 提高 设计 的 可靠性 。 在 等 不 具有 SPI 接口 的 单片机 组成 的 智能化 仪表 和 测控 系统 中 ， 对于 速度 要求 不高 、 掉电 后 保存 少量 系统 参数 和 低功耗 的 场合 ， 使用 SPI 总线 ， 无疑 会 增加 应用 系统 接口 器件 的 种类 ， 增强 应用 系统 的 性能 。 　 SPI 总线 的 组成 　 　 SPI 总线 可 在 软件 的 控制 下 构成 各种 简单 的 或 复杂 的 系统 ， 如 ： 个主 MCU 和 几个 从 MCU ； 几个 从 MCU 相互连接 构成 多 主机 系统 分布式系统 ； 个主 MCU 和 个 或 几个 从 IO 设备 。 在 大多数 应用 场合 中 ， 使用 个 MCU 作为 主机 ， 它 控制数据 向个 或 多个 从 外围 器件 的 传送 。 从 器件 只能 在 主机 发 命令 时 才能 接收 或 向 主机 传送数据 。 其 数据 的 传输 格式 是 高位 MSB 在 前 ， 低位 LSB 在 后 。 SPI 典型 结构 如图 。 图 SPI 总线 的 组成 　 　 在 把 SPI 与 几种 不同 的 串行 IO 芯片 相连 时 ， 必须 用 每片 的 允许 控制 端 ， 可用 MCU 的 IO 端口 输出 线来 实现 。 此时 应 特别 注意 这些 串行 IO 芯片 的 输入输出 特性 。 　 　 输入 芯片 的 串行 数据 输出 是否 有 三态 控制 端 。 平时 未 选中 芯片 的 输出 端应 处于 高 阻态 。 若 没有 三态 控制 端 ， 应 外加 三态 门 。 否则 MCU 的 MISO 端 只能 连接 个 输入 芯片 。 　 　 输出 芯片 的 串行 数据 输入 是否 有 允许 控制 端 。 即 应该 只有 在 这片 芯片 允许 时 ， SCK 脉冲 才 把 串行 数据 移入 该 芯片 ； 芯片 禁止 时 ， SCK 对 芯片 无 影响 。 若 没有 允许 控制 端 ， 应 在 外部 用 门电路 对 SCK 进行 控制 后 ， 再加 到 芯片 的 时钟 输入 端 ， 或者 SPI 只 连接 个 芯片 ， 不能 再 连接 其它 输入 或 输出 芯片 。 　 SPI 总线 在 单片机 中 的 实现 方法 　 　 对于 没有 单片机 的 SPI 接口 的 MCU 来说 ， 可 使用 软件 来 模拟 SPI 的 操作 ， 包括 串行 时钟 、 数据 输入 和 输出 。 对于 不同 的 串行接口 外围 芯片 ， 它们 的 时钟 时序 是 不同 的 。 对于 在 SCK 的 上升 沿 输入 接收数据 和 在 下降 沿 输出 发送数据 的 器件 ， 一般 应取 图中 的 串行 时钟 输出 P 的 初始状态 为 ， 在 允许 接口 芯片 后 ， 置 P 为 。 因此 ， MCU 输出 位 SCK 时钟 ， 同时 ， 使 接口 芯片 串行 左移 ， 从而 输出 位 数据 至 的 P 模拟 MCU 的 MISO 线 ， 再置 P 为 ， 使 从 P 输出 位 数据 先 为 高位 至 串行接口 芯片 。 到 此 模拟 位 数据 输入输出 完成 。 以后 再置 P 为 ， 模拟 下位 的 输入输出 … … ， 依 此 循环 次 ， 可 完成 次 通过 SPI 传输 B 的 操作 。 对于 在 SCK 的 下降 沿 输入 数据 和 上升 沿 输出 数据 的 器件 ， 则 应取 串行 时钟 输出 的 初始状态 为 ， 在 接口 芯片 允许 时 ， 先置 P 为 ， 此时 ， 外围 接口 芯片 输出 位 数据 MCU 接收 位 数据 ， 再置 时钟 为 ， 外围 接口 芯片 接收 位 数据 MCU 发送 位 数据 ， 可 完成 位 数据 的 传送 。 　 　 图为 MCU 与 MCMEPROM 的 硬件 连接 图 ， 有关 MCM 的 详细情况 可 参考文献 〔 〕 。 图中 ， P 模拟 MCU 的 数据 输出 端 MOSI ， P 模拟 SPI 的 SCK 输出 端 ， P 模拟 SPI 的 从机 选择 端 ， P 模拟 SPI 的 数据 输入 端 MISO 。 下面 介绍 用 汇编语言 模拟 SPI 串行 输入 、 串行 输出 和 串行 输入输出 个子 程序 。 这些 子程序 也 适用 于 在 串行 时钟 的 上升 沿 输入 和 下降 沿 输出 的 各种 串行 外围 接口 芯片 ， 如位 或位 AD 芯片 、 LS 系列 输出 芯片 等 。 对于 下降 沿 输入 、 上升 沿 输出 的 各种 串行 外围 接口 芯片 ， 只要 改变 P 的 输出 顺序 ， 即 输出 再 输入 ， 再 输出 … … ， 则 这些 子程序 也 同样 适用 。 图 SPI 总线 接口 原理图 MCU 串行 输入 子程序 SPIIN 　 　 从 MCM 的 SPISO 线上 接收 B 数据 并 放入 寄存器 R 中 。 　 　 SPIIN ： SETB 　 P 　 　 　 　 ； 使 P 时钟 输出 为 。 　 　 CLRP ； 选择 从机 。 　 　 MOVR ， H ； 置 循环 次数 。 　 　 SPIN ： CLRP ； 使 P 时钟 输出 为 。 　 　 NOP ； 延时 。 　 　 NOP ； 　 　 MOVC ， P ； 从机 输出 SPISO 送 进位 C 。 　 　 RLCA ； 左移 至 累加器 ACC 。 　 　 SETBP ； 使 P 时钟 输出 为 。 　 　 DJNZR ， SPIN ； 判 是否 循环 次 B 数据 。 　 　 MOVR ， A ； B 数据 送 R 。 　 　 RETI ； 返回 。 　 　 MCU 串行 输出 子程序 SPIOUT 　 　 将 中 R 寄存器 的 内容 传送 到 MCM 的 SPISI 线上 。 　 　 SPIOUN ： SETB 　 P 　 　 　 ； 使 P 时钟 输出 为 。 　 　 CLRP ； 选择 从机 。 　 　 MOVR ， H ； 置 循环 次数 。 　 　 MOVA ， R ； B 数据 送 累加器 ACC 。 　 　 SPIOT ： CLR 　 P 　 　 　 ； 使 P 时钟 输出 为 。 　 　 NOP ； 延时 。 　 　 NOP ； 　 　 RLC 　 A ； 左移 至 累加器 ACC 最高 位至 C 。 　 　 MOV 　 P ， C ； 进位 C 送 从机 输入 SPISI 线上 。 　 　 SETB 　 P ； 使 P 时钟 输出 为 。 　 　 DJNZ 　 R ， SPIOT ； 判 是否 循环 次 B 数据 。 　 　 RETI ； 返回 。 　 　 MCU 串行 输入输出 子程序 SPIIO 　 　 将 中 R 寄存器 的 内容 传送 到 MCM 的 SPISI 中 ， 同时 从 MCM 的 SPISO 接收 B 数据 。 　 　 SPIIO ： SETB 　 P 　 　 　 ； 使 P 时钟 输出 为 。 　 　 CLRP ； 选择 从机 。 　 　 MOVR ， H ； 置 循环 次数 。 　 　 MOVA ， R ； B 数据 送 累加器 ACC 。 　 　 SPIO ： CLRP ； 使 P 时钟 输出 为 。 　 　 NOP ； 延时 。 　 　 NOP ； 　 　 MOVC ， P ； 从机 输出 SPISO 送 进位 C 。 　 　 RLCA ； 左移 至 累加器 ACC 最高 位至 C 。 　 　 MOVP ， C ； 进位 C 送 从机 输入 。 　 　 SETBP ； 使 P 时钟 输出 为 。 　 　 DJNZR ， SPIO ； 判 是否 循环 次 B 数据 。 　 　 RETI ； 返回 。 　 　 本文 给出 了 用 单片机 汇编语言 模拟 SPI 总线 的 输入 、 输出 ， 输入输出 传送 B 的 子程序 。 读者 也 可 根据 SPI 总线 的 操作 时序 在 MCS 系列 、 ATMEL 系列 等 单片机 上 实现 SPI 总线 的 接口 。 作者 单位 ： 安徽 铜陵 有色金属 设计 研究院 自动化 研究所 参考文献 　 　 涂时亮 MCHC 单片机 原理 、 应用 及 技术 手册 上海 ： 复旦大学 出版社 ， 　 　 涂时亮 ， 张有德 ， 陈章 龙 单片微 机软件 设计 技术 北京 ： 科学技术 文献 出版社 ， 收稿 日期 ：