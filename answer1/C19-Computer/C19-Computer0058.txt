计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNoTS 串行 通信 的 实践 探讨 沈红卫 摘要 串行 通信 是 一种 应用 非常 广泛 的 通信 方式 ， 在 计算机系统 中有 极其重要 的 作用 。 但 要 实现 可靠 的 串行 通信 ， 又 有 相当 的 困难 。 针对 目前 串行 通信 中 存在 的 一些 模棱两可 的 理论 ， 从 实践 的 角度 作 了 一些 有益 的 探讨 。 关键词 串行 通信 实践 RSThePracticalResearchonRSCommunicationshenHongweiElectromechanicDeptofShaoxinLiberalArtsandScienceInstituteShaoxinAbstract ： Asonekindofcommunicationmodeusedincomputersystems ， RScommunicationisveryimportantButitisquitedifficulttobringaboutreliableRScommunicationThispaperdisucussestheproblemofhowtoachieveRScommunicationbasedonpracticalresearchwhichisdirectedagainstsometheoryonRScommunicationKeywords ： Serialcommunication ； Practce ； Rs 　 　 串行 通信 作为 计算机 的 一种 标准 通信接口 ， 用于 计算机 与 计算机 或 智能 设备 之间 的 信息 交换 ， 具有 非常 广泛 的 实际 应用 价值 。 　 　 但是 在 实际 的 应用 开发 中 ， 我们 发现 有关 串行 通信 的 有些 问题 ， 值得 引起 进一步 的 探讨 ， 并 从 实践 的 角度 加以 明确 。 　 　 下面 结合 实践 认识 ， 从 几个 方面 对 串行 通信 谈谈 自己 的 一些 看法 。 　 目前 有关 串行 通信 的 几个 理论 误区 　 　 有关 串行 通信 的 资料 ， 可以 说 非常 多 。 但 在 以下 几个 问题 上 ， 普遍存在 模糊不清 的 现象 。 　 串行 通信 的 距离 问题 　 　 绝大多数 资料 对 RSC 串行 通信 标准 的 通信 距离 ， 都 认为 在 无 调制解调器 的 情况 下 ， 最大 有效 距离 为 米 。 然后 ， 在 实际 应用 中 ， 我们 发现 最大 距离 可以 远远 超过 此值 。 例如 ， 我们 以 波特率 进行 PC机 间 的 点对点 串行 通信 ， 采用 芯 普通 非 屏蔽 网络 电缆 ， 在 通信 距离 增加 到 米 时 ， 仍能 可靠 通信 ， 而 无误 码 现象 。 实际上 ， 按照 DEC 公司 的 实验 ， 采用 屏蔽 电缆 或非 屏蔽 电缆 时 ， 波特率 的 通信 距离 分别 可达米 及 米 。 其它 波特率 时 也 有 类似 现象 。 　 串行 通信 的 波特率 问题 　 　 对于 标准 的 波特率 ， 在 PC机 上 的 波特率 参数 已经 为 标准 参数 ， 只要 直接 使用 而 不会 出现 问题 。 而 对于 其它 智能 设备 的 波特率 参数 ， 例如 采用 以 Intel 微处理器 为 内核 的 系统 ， 波特率 参数 的 确定 就 必须 认真对待 ， 特别 是 电源 管理 寄存器 PCON 中 的 SMOD 位 的 设置 。 以 MHz 晶振 系统 为例 ， 要求 的 波特率 ， 由 定时器 T 工作 于 方式 自动 重 装载 方式 产生 ， 则 当 SMOD 取时 ， 波特率 参数 整 定为 ： X ≈ ＝ FH 　 　 而 当 SMOD 取时 ， 波特率 参数 整 定为 ： X ≈ ＝ FH 　 　 而 实际 的 波特率 及 相对误差 分别 为 ： SMOD ＝ 时 ， 及 ％ ； SMOD ＝ 时 ， 及 ％ 。 　 　 由此可见 ， 当 SMOD 选时 ， 波特率 相对误差 超出 了 一般 认为 的 正常 串行 通信 允许 误差 ％ 的 要求 ， 因而 不能 进行 正常 通信 了 。 　 串行 通信 的 握手 方式 问题 　 　 在 串行 通信 中 ， 可以 采用 硬 握手 与 软 握手 两种 方式 ， 目前 较常 采用 的 是 软 握手 的 线制 方式 ， 即 采用 交叉 技术 的 TXD 、 RXD 、 信号 地条线 进行 通信 。 　 　 但是 ， 在 软 握手 方式 中 ， 对于 采用 BIOS 调用 的 串行 通信 程序设计 ， 必须 对 BIOS 对 串行 通信 的 奇特 的 握手 要求 引起 高度重视 。 BIOS 对 握手 信号 的 要求 是 ： 　 　 · 调用 初始化 函数 时 不 需要 任何 握手 信号 ； 　 　 · 调用 接收 函数 时 要求 DTR 打开 且 RTS 关闭 ； 　 　 · 调用 发送 函数 时则 要求 DTR 和 RTS 打开 ， 并 等待 其它 设备 来 设置 DSR 和 CTS ； 如未 收到 ， 则 在 超时 后 返回 ， 不 执行 发送 动作 。 　 　 因此 ， 在 采用 BIOS 调用 时 ， 务必 使 串行口 工作 于 自 握手 方式 ， 即将 DSR 与 DTR 短接 ， RTS 与 CTS 短接 ； 否则 ， 不能 进行 正常 串行 通信 。 　 串行 通信 的 实现 　 在 DOS 环境 下 的 串行 通信 实现 　 　 DOS 环境 可以 自由 驾驭 硬件 ， 因此 最 适合 于 测控 系统 。 在 DOS 环境 下 ， 采用 汇编语言 直接 对 串行 端口 操作 的 程序 ， 一般 比较 容易 实现 。 然后 ， 在 采用 TC 的 BIOS 函数调用 时 ， 往往 由于 上面 所述 原因 ， 而 难以实现 。 　 　 下面 的 串行 查询 发送 程序 采用 TC 编写 并 调试 通过 。 　 　 includestdioh 　 　 includebiosh 　 　 includedosh 　 　 mainintargccharargv 　 　 FILEfp 　 　 charchljhlencount 通信 失败 时 允许 重试 一次 　 　 unsignedcharch 　 　 unsignedintijk 　 　 intstatus 　 　 ifargc 　 　 　 　 printfnUsagesendfileextn 　 　 exit 　 　 　 　 下面 的 条 语句 将 串口 初始化 为 波特率 位 数据 无 校验 停止 位 　 　 outportbxfbx 　 　 outportbxfx 　 　 outportbxfx 　 　 outportbxfbx 　 　 上述 条 语句 可用 BIOSCOMXABIOS 初始化 函数 代替 　 　 chxaa 开始 串行 通信 命令 软 握手 字节 　 　 dochinportbxfd 　 　 whilechxx 查询 发送 寄存器 为 空否 　 　 outportbxfch 为 空则 发送 　 　 注意 上述 发送 语句 如果 要 改用 BIOSCOMch 函数 进行 发送 则 务必 要 使 串口 工作 于 自 握手 方式 否则 无法 通信 接收 亦然 　 　 dochinportbxfd 　 　 whilechxx 等待 从机 应答 　 　 chinportbxf 　 　 ifchxaa 应答 正确 否 ll 　 　 应答 正确 则 将 指定 文件 中 的 字节 发送 出去 　 　 iffpfopenargvrbNULL 　 　 　 　 printfcannotopenthisfilen 　 　 exit 　 　 　 freadchfp 　 　 whilelen 　 　 　 　 dochinportbxfd 　 　 whilechxx 　 　 outportbxfch 　 　 ljhch 求 累加 和校验 用 　 　 len 　 　 freadchfp 　 　 　 fclosefp 　 　 dochinportbxfd 　 　 whilechxx 　 　 chinportbxf 接收 从机 发来 的 累加 和 S 　 　 ifchljh 　 　 正确 则 回送 正确 标志 字节 X 　 　 forjjj 　 　 foriii 延时 以 等待 从机 　 　 接发 切换 　 　 chx 　 　 dochinportbxfd 　 　 whilechxx 　 　 outportbxfch 　 　 forjjj 　 　 foriii 　 　 printfn 　 　 printfOK 　 　 exit 　 　 else 不 正确 则 回送 错误 标志 字节 XFF 　 　 　 　 forjjj 　 　 foriii 　 　 chxff 　 　 dochinportbxfd 　 　 whilechxx 　 　 outportbxfch 　 　 forjjj 　 　 foriii 　 　 ljh 　 　 count 　 　 ifcountgoto 　 ll 再试一次 　 　 elseprintfnFailureincommunicationn 　 　 　 　 在 Windows 环境 下 的 串行 通信 实现 　 　 Windows 下 的 串行 通信 实现 一般 有种 方式 ： 　 　 利用 Windows 的 API 接口函数 ； 　 　 对于 RAD 开发 系统 如 VB 等 ， 可 利用 ActiveX 控件 ； 　 　 利用 DLL 动态链接库 直接 操作 串行 端口 。 　 　 种 方式 各有特点 ， 我们 采用 第三种 方式 实现 了 Windows 环境 下 可靠 的 串行 通信 ， 这种 方式 的 特点 是 应用 灵活 ， 简便 。 　 　 下面 是 基于 Delphi 的 用于 串行 通信 的 DLL 程序 ： 　 　 libraryMycomdll 　 　 uses 　 　 SysUtils 　 　 Classes 　 　 Const 　 　 COMf 定义 串口 字符 常量 　 　 COMF 　 　 Var 　 　 COMWordDLL 中 全局变量 　 　 ProcedureOutbConstPortWordConstDbyteBytepascal 　 　 Begin 　 　 Asm 　 　 MOV 　 DXPort 　 　 MOV 　 ALDbyte 　 　 OUT 　 DXAL 　 　 End 　 EndFunctionInbConstPortWordBytepascal 　 Begin 　 　 Asm 　 　 MOV 　 DXPort 　 　 IN 　 ALDX 　 　 MOV 　 ResultAL 　 　 End 　 End 　 　 串行口 初始化 COMCOM 可选 波特率 可 选 　 　 ProcedureCommInitCONSTPortByte ； CONSTBaud ： String ； Stdcall ； 　 　 Var 　 　 BAUDL ， BAUDHByte ； 　 　 Begin 　 　 ifPortthen 　 　 COMCOM 　 　 else 　 　 COMCOM 　 　 ifBAUDthen 　 　 Begin 　 　 BAUDL 　 　 BAUDH 　 　 End 　 　 else 　 　 Begin 　 　 BAUDL 　 　 BAUDH 　 　 End 　 　 OutbCOM 设置 波特率 因子 　 　 OutbCOMBAUDL 　 　 OutbCOMBAUDH 　 　 OutbCOM ； 位 数据 ， 停止 位 ， 无 校验 　 　 End 　 　 发送 一 字节 　 　 ProcedureSendByteConstDbyteByteStdcall 　 　 Var 　 　 StatusByte 　 　 Begin 　 　 Repeat 　 　 StatusInbCOM 　 　 untilStatusand 　 　 OutbCOMDbyte 　 　 End 　 　 接收 一 字节 　 　 FunctionReceiveByteByteStdcall 　 　 Var 　 　 StatusResByte 　 　 Begin 　 　 Repeat 　 　 StatusInbCOM 　 　 UntilStatusand 　 　 resInbCOM 　 　 ReceiveByteRes 　 　 End 　 　 以下 用 EXPORTS 引出 输出 过程 或 函数 　 　 ExportsCommInit 　 　 ExportsSendByte 　 　 ExportsReceiveByte 　 　 begin 　 　 end 　 多机 通信 的 实现 　 　 多机 通信 一般 采用 主从 方式 ， 一方 为主 ， 其它 为 从 ， 然后 再 按照 统一 的 通信协议 进行 有序 通信 。 基于 这种 情况 ， 图 给出 了 一种 针对 目前 有关 资料 类似 线路 经 简化 改进 的 实用 接口 方法 ： 图 　 改进 的 实用 接口 　 　 注意 ， 每个 从机 的 发送 脚 TXD 必须 通过 开关 二极管 再 挂 接到 主机 的 接收 线上 ， 否则 ， 会 引起 信号 冲突 ， 影响 正常 通信 ， 并 可能 导致 串口 损坏 。 　 串行 通信 程序 的 简单 调试 　 　 串行 通信 程序 的 调试 相对来说 ， 是 比较 麻烦 的 。 一般 可以 采用 以下 步骤 ： 　 　 检查 连线 正确 否 。 在 三线 制 方式 中 ， 要 注意 交叉 问题 ； 如 采用 BIOS 调用 接发 数据 ， 则 要 进一步 注意 握手 信号 的 正确 连接 。 　 　 简单 地用 逻辑 笔 检查 发接 信号 的 有无 注意 逻辑 笔 只能 检查 TTL 信号 ， 因此 ， 检查点 一般 为经 MAX 等 接口 芯片 转换 后 的 TXD 、 RXD ； 　 　 在 确认 有接 发信号 的 前提 下 ， 如果 接发 数据 不 正常 ， 则 重点 应 检查 通信协议 一致 否 。 例如 ， 波特率 的 设置 ， 奇偶校验 否 ， 停止 位数 ， 通信 的 应答 等 。 　 　 在 只有 单机 的 情况 下 的 串口 程序调试 ， 可 采用 将 串口 的 TXD 与 RXD 直接 相连 的 办法 ， 简单 方便 。 　 结束语 　 　 以上 管见 ， 仅 是 本人 在 多年 的 串行 通信 实践 中 的 一些 体会 。 希望 能 起点 抛砖引玉 的 作用 ， 使 同行 们 在 有关 串行 通信 的 应用 研究 中 ， 不至于 人云亦云 ， 从而 少 走 一点 弯路 。 作者简介 ： 沈红卫 男 ， 岁 ， 讲师 ， 主要 从事 计算机控制 及 应用 方面 的 教学 与 科研工作 作者 单位 ： 绍兴 文理学院 机电 系 绍兴 参考文献 　 徐 新华 DELPHI 编程 指南 上编 北京 ： 宇航 出版社 ， 　 陈汝全 、 刘运国 、 雷 国君 单片机 实用技术 北京 ： 电子 出版社 ， 收稿 日期 ：