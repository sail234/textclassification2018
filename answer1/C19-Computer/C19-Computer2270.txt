计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 P ， LonWorks 网络 与 LAN 、 Internet 互连 的 解决方案 杨斌 　 杨国 才 　 罗木平 摘要 介绍 了 基于 LonWorks 现场 总线 技术 的 控制系统 与 LAN 、 Internet 互连 的 一种 解决方案 ， 提出 了 LonTalkIP 路由器 的 技术 方案 。 关键词 LonWorks 局域网 Internet 路由器 协议 　 　 LonWorks 是 一种 具有 强劲 实力 的 现场 总线 技术 ， LonWorks 控制 网络 在 开放性 、 互操作性 等 方面 所 具有 的 优良 性能 已 使 它 广泛应用 于 楼宇 自动化 、 家庭 自动化 、 保安 系统 、 办公设备 、 交通运输 、 工业 过程 控制 等 行业 。 实现 LonWorks 网络 与 LAN 、 Internet 的 集成 将 为 企业 综合 自动化 与 信息化 创造 有利 的 条件 。 　 　 ． 建立 综合 实时 信息库 ， 为 企业 优化 控制 、 生产 调度 、 计划 决策 提供 依据 。 　 　 ． 建立 分布式 数据库 管理 功能 ， 保证数据 一致性 、 完整性 和 可 互操作性 。 　 　 ． 有关 人员 可 在 任何 地方 通过 Internet 浏览 了解 企业 的 生产 情况 。 　 　 ． 能够 实现 对 控制 网络 工作 状态 的 远程 监控 ， 优化 调度 ， 也 能 实现 控制 网络 的 远程 诊断 与 维护 等 。 　 　 ． 可 进行 控制 网络 的 远程 软件维护 与 下载 新 版本 软件 。 LonWorks 网络 与 LAN 、 Internet 互连 的 系统结构 　 　 我们 可以 把 一个 企业 综合 的 控制系统 分解 为 两个 子系统 ： 第一个 是 基于 LonWorks 技术 的 实时控制 InputOutput ， IO 子系统 ， 包括 智能 传感器 ， 传动装置 和 微控制器 ； 第二 是 基于 局域网 、 Internet 技术 的 信息 传输 InformationTransfer ， IT 子系统 。 图 便是 这样 一个 系统 。 图 　 　 IT 子系统 基于 局域网 技术 Ethernet ， IEEExx 和 TCPIP ， 而 IO 子系统 使用 LonTalk 协议 、 LonWorks 技术 及 支持 LonMark 互操作性 标准 。 IT 子系统 和 IO 子系统 之间 的 通讯 有 两种 方法 ： 一种 方法 是 可以 发展 一种 IT 和 IO 之间 的 路由器 。 这种 方法 要求 IT 上 的 设备 具有 多 协议 栈 ； 另 一种 方法 是 可以 发展 一种 IT 的 协议 与 IO 的 协议 之间 的 网关 。 本文 主要 是 讨论一下 前 一种 方法 ， 即 发展 EthernetTCPIP 网络 和 LonWorks 网络 之间 的 路由器 后文均 称为 LonTalkIP 路由器 。 设计方案 总体设计 　 　 以 校园 为例 ， 在 校园内 管理 所有 建筑 中 的 建筑 控制系统 就 可以 使用 这种 LonTalkIP 路由器 。 校园内 有 上百 的 建筑 ， 这些 建筑 通常 由 使用 TCPIP 和 EthernetIEEExxMAC 技术 的 主干 局域网 互联 — 这 便是 IT 局域网 。 　 　 而 LonWorks 网络 是 在 每座 独立 的 建筑 中 使用 ， 用于 控制器 、 传感器 、 传动装置 等 设备 之间 的 通讯 。 这些 建筑 控制 设备 的 监控 常 通过 一些 集中 监视 站点 来 进行 。 同样 的 ， 如电 、 蒸汽 、 热水 、 冷水 等 功用 也 常 通过 一个 中心 站点 来 提供 。 那么 要 想 优化 能源管理 ， 就 需要 集中处理 来自 校园内 各个 建筑 的 各种 信息 ， 因而 把 LonWorks 网络 通过 LonTalkIP 路由器 与 局域网 相连 也 就 成为 了 必需 。 　 　 因此 ， 对 该 路由器 的 需要 细表 如下 ： 　 　 LonTalkIP 路由器 通过 局域网 在 某 一域 内 的 两个 或 两个 以上 的 LonWorks 网络 间 传递 LonTalk 协议 报文 。 路由 选择 基于 LonWorks 的 域 和 子网 。 如图 。 图 　 　 支持 的 拓扑 结构 如图 。 图 　 　 局域网 可以 连接 多个 LonWorks ， 但 LonWorks 不 用来 连接 局域网 。 局域网 可以 包含 若干 局域网 子网 或 广域网 。 每个 LonWorks 网络 在 某 一域 中 包含 一个 或 多个 子网 。 　 　 某一域 内 路由器 最多能 支持 个子 网 ， 且 它们 各自 独立 。 　 　 该 路由器 允许 局域网 上 的 工作站 和 LonWorks 上 的 设备 相互 通讯 。 因而 工作站 可以 从 或 到 LonWorks 的 设备 上去 读写 网络 变量 。 同样 ， 工作站 也 可 接收 网络 变量 更新 及其 它 从 LonWorks 设备 传来 的 信息 。 　 　 LonTalkIP 路由器 是 网络层 延迟 ， 因而 它 能 为 高层 服务 ， 如 LNS 、 LonWorksWindowsAPI 或 BACnet 的 报 文选 路 。 　 　 另外 ， 该 路由器 支持 网络层 分段 。 LonTalk 协议 允许 报文 最长 为 字节 。 该 路由器 可 被 用于 为 NFS ， SNMP 能 使用 更长 报文 等 的 报文 选择 路由 。 故该 路由器 在 TCPIP 网络 上 出现 更长 的 报文 时 需要 分段 和 重组 。 　 　 寻址 的 基本 要求 ： 　 　 ． LonWorks 上 的 设备 控制器 应有 一个 LonTalk 地址 ， 为 ： 域 子网 结点 　 　 ． 局域网 上 的 设备 应有 一个 局域网 地址 和 一个 LonTalk 地址 。 　 　 该 路由器 要 通过 标准 IP 路由器 和 局域网 交换机 来 通信 。 路由器 的 通信 要 经过 防火墙 。 　 　 该 路由器 支持 以下 物理层 ： 　 　 — Ethernet ： BaseTTwistedPair ， BaseThinEthernet ， BaseTX 可选 。 　 　 — LonWorks ： FTTA ， LPT ， PXF ， TPXF 。 　 　 配置 ： 　 　 目的 是 使 路由器 能 自我 配置 ， 作为 服务 的 一种 替代 DNS 类型 可 用于 标识 出 哪个 路由器 选路 到 哪个 网络 ， 而 并 不 需 在 每个 路由器 上 配置 其它 路由器 和 目的 子网 的 局域网 地址 IP地址 。 配置 数据 应 存储 在 不易 变 的 存储器 中 。 还 应为 自 配置 路由器 提供 自动 删除 旧 配置 数据 基于 一定 时间 间隔 。 路由器 配置 　 　 ． 选路 ： 当 收到 一个 LonTalk 网络层 协议 数据 单元 NetworkLayerProtocolDataUnit ， NPDU ， 不管 是 来自 LonWorks 网络 或是 局域网 ， 路由器 都 要 转发 报文 到 目的 网络 。 转发 决策 将 基于 目的 地址 域 和 子网 。 路由器 用 路由表 来 决定 传送 报文 到 哪个 终端设备 局域网 或 LonWorks 上 或 局域网 上 的 路由器 。 典型 的 路由表 为 如下 格式 表 。 表 目的 域 和 子网 目的 端口 转发 的 设备 地址 　 　 　 　 　 　 　 　 目的 端口 可以 是 局域网 端口 或 LonWorks 端口 。 应 注意 ， 路由器 不能 在 它 接收 报文 的 端口 上 传送 这个 报文 。 要 转发 的 设备 的 地址 可以 是 一个 单目 传送 地址 ， 多点 广播 地址 或 广播 地址 。 　 　 ． 配置 ： 路由器 使用 路由表 转发 消息 。 而 要 建立 路由表 ， 路由器 就 需要 知道 LonWorks 上 的 子网 和 局域网 上 的 路由器 的 IP地址 。 这些 内容 都 能 人工 配置 或 路由器 动态 地 学习 。 一个 完全 人工 配置 方法 中 ， 每一 路由器 都 要 使 之 知道 它 所在 的 LonWorks 子网 ， 其它 路由器 的 IP地址 及其 相关 的 LonWorks 子网 。 对 一个 大 系统 来说 ， 这 需要 相当 大 的 工作量 ， 而且 还易 出错 ， 也 不 值得 。 　 　 另 一个 方法 就是 让 路由器 “ 自 学习 ” ， 就 像 使用 LonWorks 技术 的 自 学习 路由器 一样 。 一个 集中式 的 选路 方法 被 用来 寻找 局域网 上 的 路由器 。 有 一个 集中式 路由器 ， 并 配置 使 每个 路由器 都 能 知道 该 集中式 路由器 的 IP地址 。 每个 路由器 通告 集中式 路由器 它 所在 的 LonWorks 子网 ， 集中式 路由器 则 在 每个 路由器 上 建立 路由表 。 自 学习 方法 可以 被 用于 确定 LonWorks 子网 。 如果 路由器 的 传输 协议 支持 多点 广播 地址 ， 且 系统 中任 两 设备 间 仅 有 单一 路径 ， 则 该 方法 是 可行 的 。 如果 以上 假设 无效 ， 则 不得不 考虑 类似 InternetRIPRoutingInformationProtocol 或 OSPFOpenShortestPathFirst 等 别的 分步 路由 协议 。 协议 配置 　 　 异型 系统 的 通信 可以 由 网关 协议 转换器 或 由 使用 隧道 技术 的 一个 中继 来 完成 。 一个 第层 协议 转换器 从 协议 A 的 网络层 翻译 到 协议 B 的 网络层 ， 如图所示 注意 第层 以上 的 协议 在 两个 栈中 都 是 相同 的 。 图 　 　 另 一种 选择 是 使用 隧道 技术 的 路由器 。 隧道 用来 把 协议 A 的 数据 报 作为 另外 的 高层 通讯 协议 的 分组 从 一个 设备 传输 到 另 一个 上面 。 举 个例 ， 使用 隧道 的 LonTalkIP 路由器 就 用 TCP 传送 LonTalkNPDU 。 隧道 技术 广泛 用于 Internet 网络 。 图是 一个 采用 隧道 技术 使用 第层 中继 的 图表 。 以上 方案 中 ， 使用 隧道 协议 TunnelP 在 高层 协议 上 隧道 传送 NPDU 。 用 以下 术语 描述 隧道 ： 传送 协议 是 用于 传送 有效载荷 分组 的 高层 协议 。 有效载荷 分组 是 由 隧道 传送 的 数据 报 。 隧道 协议 是 一种 简单 协议 ， 用来 通过 隧道 传送 有效载荷 分组 。 图所 显示 的 路由 功能 决定 了 有效载荷 分组 传到 哪个 终端设备 或 路由器 。 图 　 　 LonTalkIP 路由器 是 使用 隧道 技术 的 第层 中继 。 选择 隧道 而 非 协议 转换 的 原因 如下 ： 　 　 a 隧道 更 有效 ， bIT 局域网 上 的 设备 是 多 协议 栈 的 设备 ， 主机 应用程序 使用 LonTalk 协议 ， 能 处理 LonTalkNPDU ， 且 c 对 报文 传送 的 确认 在 IT 局域网 上 的 终端设备 产生 ， 跟 在 LonWorks 网络 上 一样 。 　 　 前面 已经 提到 有效载荷 分组 将 是 LonTalkNPDU 。 如果 LonTalk 协议 同 在 局域网 上 的 工作站 中 一样 是 在 路由器 的 软件 中 实现 的 ， 这是 可行 的 。 如果 使用 硬件 解决 方法 来 实现 LonTalk 协议 用 LonTalk 路由器 或 Neurons 芯片 ， 就 不 可能 了 。 在 这种 情况 下 有效载荷 分组 将 是 LonTalk 链路层 协议 数据 单元 LinkLayerProtocolDataUnits ， LPDUs 。 　 　 那么 用 什么 作 传送 协议 呢 ？ 以下 是 几种 候选 ： 　 　 ． IPInternetProtocol ： Internet 协议 组 的 网络层 协议 　 　 ． TCPTransmissionControlProtocol ： Internet 协议 组 的 传输层 协议 　 　 ． UDPUserDatagramProtocol ： Internet 协议 组 的 非 连接 传输层 　 　 ． IP 多点 广播 　 　 这些 协议 的 优缺点 ： 　 　 IP ： IP 协议 是 最 有效 的 传输 协议 。 缺点 是 它 不能 有效 地 支持 多点 广播 。 IP 支持 本地 广播 ， 直接 广播 在 特定 网络 上 和 多点 广播 地址 。 而 在 Internet 上 使用 多点 广播 地址 需要 IP 多点 广播 协议 以下 指 IP 多点 广播 。 而且 ， 许多 软件包 不 支持 与 IP 接口 的 API 。 　 　 TCP ： 优点 是 提供 可靠 的 传递 。 它 使用 广泛 且 插口 API 在 很多 平台 上 应用 。 基于 报文 的 TCPIP 也 能 通过 防火墙 传递 。 TCP 的 不足 是 它 集中地 计算 带宽 且 不 支持 多点 广播 报文 发送 。 　 　 UDP ： UDP 是 一种 有效 的 协议 。 它 应用 广泛 且 Socket 接口 能 很 好 地 支持 它 。 UDP 不能 有效 地 支持 多点 广播 信息 发送 与 IP 同样 的 问题 。 UDP 报文 通过 防火墙 传输 也 有 问题 。 　 　 IP 多点 广播 ： IP 多点 广播 是 有助于 在 Internet 上 使用 多点 广播 寻址 的 一系列 协议 。 在 主机 上 ， 映射 IP 多点 广播 地址 到 MAC 层 地址 必须 在 MAC 层 使用 多点 广播 寻址 。 IP 多点 广播 标准 定义 了 一个 映射 方案 。 为 IP 路由器 传输 多点 广播 报文 而已 加强 了 Internet 路由 协议 。 IGMPInternetGroupManagementProtocol 被 主机 和 路由器 用来 建立 和 管理 多点 广播 组 的 成员 。 路由 协议 ， 远程 导引 多点 广播 路由 协议 DistanceVectorMulticastRoutingProtocol 被 路由器 用来 在 Internet 上 传输 多点 广播 报文 。 这些 协议 已 用于 在 局域网 上 的 音频 和 视频 广播 ， 但 对 实时 数据通讯 使用 尚不广 。 　 　 需要 进一步 分析 以 确定 上述 协议 中 哪种 协议 能 作为 传送 协议 。 　 　 一个 隧道 协议 提供 以下 性能 ： 　 　 ． 标识 有效载荷 分组 　 　 ． 加密 和 身份验证 可 选 　 　 ． 使用 顺序号 可靠 传送 可 选 　 　 ． 流控制 可 选 　 　 对 该 路由器 来说 ， 有些 可选性 能 并非 必需 的 ， 如 身份验证 ， 因为 LonTalk 协议 有 身份验证 能力 。 　 　 有 一些 隧道 协议 是 可用 的 ， 但 缺乏 被 广泛 接受 的 标准 。 其中 有 ： a 点对点 隧道 协议 。 它 基于 RFClGenericRoutingEncapsulation 。 bASHRAESPCBACnet 委员会 也 在 开发 一种 在 IP 上 传送 BACnet 报文 的 协议 。 传送 协议 为 UDP 而 有效载荷 分组 为 BACnetNPDU ， 它 需要 更进一步 的 研究 。 路由器 管理 　 　 尽管 在 IP 世界 中有 一系列 被 广泛 接受 的 关于 路由器 间 如何 对话 ， 如何 在 它们 之间 发送 路由器 配置 信息 的 标准 ， 但是 却 没有 牢固 的 有关 应用 程序接口 和 管理 路由器 的 标准 。 用户 接口 和 管理 路由器 的 一些 方法 包括 ： 　 　 — 串行 终端 接口 　 　 — Telenet 　 　 — SNMP 和 RMON 　 　 — HTML 　 　 — JMAPI 　 　 随着 这些 年 一些 标准 MIB 类型 的 介绍 ， SNMP 现在 已 被 广泛 承认 。 而 HTML 和 JMAPI 看来 被 更 广泛 接受 的 步伐 要远 快于 其它 几种 。 两点 注意 如下 ： 　 　 — LonTalkIP 路由器 需要 在 IP 域 中 操作 ， 但 它 不是 IP 路由器 。 因而 它 不 需 与 IP 路由器 支持 同样 类型 的 路由器 配置 协议 。 　 　 — 路由器 管理 的 方法 不会 成为 影响 路由器 互操作性 的 问题 。 不同 的 路由器 被 允许 支持 不同 类型 的 管理 接口 ， 只要 它们 能以 某种 标准化 方式 通讯 和 配置 。 　 　 很 明显 ， 市场 的 压力 将 促使 路由器 生产厂家 提供 的 管理 支持 要 让 它们 的 路由器 能 由 较 流行 的 网络 管理应用程序 来 管理 。 工作站 通过 路由器 访问 LonWorks 　 　 局域网 上 的 工作站 有 一个 IP地址 和 一个 LonTalk 地址 。 为 促进 自 学习 功能 ， 工作站 的 LonTalk 地址 的 域 子网 应 不同于 LonWorks 网络 上 的 任何 设备 的 域 子网 。 工作站 是 如何 与 路由器 通信 的 ？ 工作站 是 如何 发现 局域网 上 的 路由器 的 ？ 　 　 一个 简单 的 方法 是 给 局域网 上 的 每个 工作站 配 一个 路由器 。 在 这个 方案 中 ， 与 路由器 相联 的 LonWorks 网络 上 只有 一个 设备 。 该 方法 缺点 是 一个 域 中 工作站 的 数目 必须 少于 LonWorks 网络 上 子网 的 数目 。 　 　 另 一个 方法 是 工作站 与 一个 指定 工作站 服务器 路由器 通信 ， 该 路由器 依次 与 局域网 上 别的 路由器 通信 。 工作站 服务器 路由器 使 带域 和 子网 的 “ 伪 LonWorks 网络 ” 由 工作站 的 域 和 子网 来 决定 。 　 　 前面 已经 提到 ， 工作站 应 具有 多 协议 栈 并 执行 LonTalk 协议 。 LonTalk 协议 和 隧道 一起 应 在 软件 中 实现 。 因而 工作站 使用 局域网 网络 接口卡 NIC 及 TCPIP 和 LonTalk 协议 组 。 总结 　 　 本文 讨论 了 LonTalkIP 路由器 的 一些 相关 内容 。 由此 我们 可以 看出 采用 LonTalkIP 路由器 将 LonWorks 网络 与 局域网 、 Internet 相连 是 一种 可行 的 解决方案 ， 而且 也 有 很 广 的 前景 。 LonMark 互操作性 协会 也 正在 进行 这种 路由器 互操作性 标准 的 研究 工作 。 杨斌 西南农业大学 计算机系 重庆 杨国 才 西南农业大学 计算机系 重庆 罗木平 西南农业大学 计算机系 重庆 参考文献 ， 杨育 红 LON 网络 控制技术 及 应用 西安 西安电子科技大学 出版社 ， 郑 文波 控制 网络 与 信息网络 的 几种 集成 技术 测控 技术 ， DavidGawLonWorksovertheInternetTechnicalIssuesandApplicationshttpwwwcoactivecom ， HarshaDabholkarDavidGawLANAccesstoLonWorksNetworksEthernetTCPIPtoLonTalkRoutershttpwwwcoactivecom 收稿 日期 ：