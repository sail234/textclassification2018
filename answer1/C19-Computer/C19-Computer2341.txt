计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 　 Vol 　 No 　 P 曙光 上 矩阵 乘积 算法 的 性能 分析 谢幸 　 顾乃杰 　 陈国良 摘 　 要 ： 矩阵 乘积 算法 在 科学计算 中 应用 十分 广泛 文中 给出 了 典型 矩阵 乘积 算法 在 曙光 上 的 性能 比较 和 分析 ， 并 针对 SUMMA 算法 研究 了 分块 尺寸 对 其 通信 性能 的 影响 ， 指出 分块 尺寸 是 影响 其 通信 性能 的 一个 重要 因素 原 算法 并 没有 给出 其 分块 尺寸 的 具体 选取 方法 ， 文中 通过 理论 和 实验 的 分析 提出 了 一个 选取 最优 分块 尺寸 的 标准 实验 结果显示 SUMMA 算法 按 文中 的 标准 选取 最优 分块 尺寸 后 性能 得到 大幅度提高 ， 可 达 机器 峰值 的 　 　 关键词 ： 曙光 ， 矩阵 乘积 ， 通信 ， 性能 分析 分类号 ： TPPERFORMANCEANALYSISOFMATRIXMULTIPLICATIONALGORITHMSONDAWNINGXIEXingDepartmentofComputerScienceandTechnologyUniversityofScienceandTechnologyofChinaHefeiGUNaiJieDepartmentofComputerScienceandTechnologyUniversityofScienceandTechnologyofChinaHefeiCHENGuoLiangDepartmentofComputerScienceandTechnologyUniversityofScienceandTechnologyofChinaHefeiAbstract ： MatrixmultiplicationiswidelyusedinscientificcomputingTheperformanceoftypicalmatrixmultiplicationalgorithmsonDawningarecomparedandanalyzedinthispaperTheanalysisshowsthatmatrixblocksizeisanimportantfactorintheperformanceoftheSUMMAalgorithmbuthowtochoosethebestblocksizeisnotconsideredintheoriginalalgorithmAcriterionisproposedhereforchoosingthebestblocksizeintheSUMMAalgorithmaftertheoreticandexperimentalanalysisHigherperformanceisachievedbyimprovingtheSUMMAalgorithmusingthiscriterionExperimentalresultsshowthatitcanreachofthepeakperformanceKeywords ： Dawningmatrixmultiplicationcommunicationperformanceanalysis ▲ 　 引言 　 　 在 科学 与 工程 计算 的 许多 问题 中 ， 矩阵 乘积 是 最 基本 的 算法 之一 在 分布 存储 并行机 上 的 经典 矩阵 乘积 算法 主要 有 年 Cannon ［ ］ 提出 的 二维 mesh 上 的 矩阵 乘积 算法 和 年 Fox ［ ］ 等 提出 的 “ 广播 乘积 滚动 ” 算法 年 Choi 等 ［ ］ 提出 的 PUMMA 算法 将 Fox 算法 推广 到 二维 块 卷帘 数据分布 上 ， 同年 ， HussLederman 等 ［ ］ 又 将 Fox 算法 推广 到 虚 二维 环绕 数据分布 年 vandeGeijn 和 Watts ［ ］ 提出 了 一个 简单 而 高效 的 矩阵 乘积 算法 ， 称为 SUMMA 算法 　 　 曙光 并行机 是 国家 智能 计算机 研究 开发 中心 研制 的 一种 基于 分布 存储 结构 和 消息 传送 机制 的 大规模 并行 计算机系统 ［ ］ 本文 讨论 了 典型 矩阵 乘积 算法 Fox 算法 和 SUMMA 算法 在 类似 于 曙光 这样 的 大规模 并行机 上 的 实现 ， 并 比较 和 分析 了 它们 的 性能 　 　 SUMMA 算法 将 矩阵 相乘 分解 为 一系列 块 修正 ， 减少 了 内存 的 使用量 ， 可以 求解 更 大规模 的 问题 在 SUMMA 算法 中 ， 最优 的 分块 尺寸 被 认为 对于 具体 机器 是 一个 常数 ， 并 采用 手工 的 方法 选择 但 我们 的 分析 发现 最优 的 分块 尺寸 不仅 和 机器 通信 性能 相关 ， 而且 还 与 处理器 的 数目 和 拓扑 结构 有关 在 曙光 上 的 实验 结果 证实 了 我们 的 分析 我们 提出 了 一个 选取 最优 分块 尺寸 的 标准 ， 并 按 这个 标准 对 SUMMA 算法 中 的 分块 尺寸 进行 了 调整 ， 使 其 性能 得到 了 大幅度提高 　 计算环境 　 　 曙光 是 一个 基于 消息传递 机制 的 松散 耦合 的 大规模 并行 计算机系统 如图所示 ， 它 包括 个 基于 IntelsiXR 的 计算 结点 （ 主频 MHz ， 字长 位 ） ， 个 服务 结点 和 IO 结点 计算 结点 每个 结点 内存 为 MB 曙光 的 峰值 计算速度 是 GFlops 单精度 ， GFlops 双 精度 这些 结点 通过 一个 × 的 二维 mesh 连接 ， 在 每个 mesh 网格 上 有 一个 wormhole 路由器 在 wormhole 路由 下 ， 消息 穿过 途中 的 路由器 ， 而 不 进入 途中 的 结点 机 这样 ， 消息传递 并 不 中断 所 经 结点 的 运行 ， 对 大多数 应用 来说 ， 结点 之间 可 看作 是 全 连接 的 从 一个 结点 向 另 一个 结点 发送 m 个 字节 的 消息 ， 所 需 时间 均 为 tsmtw ， 其中 ts 是 通信 启动 开销 ， tw 是 通信 带宽 ， 这里 假设 网络 无 拥挤 出现 曙光 上 的 测试 结果显示 ， ts 的 值 为 μ s ， tw 的 值 为 μ sbyte 图 　 曙光 的 体系结构 　 　 曙光 上 提供 了 一个 串行 优化 数学 库 Kmath ， 它 包含 基本 线性代数 子程序 BLAS 和 FFT 等 常用 科学计算 子程序 我们 在 单 结点 上 的 串行 计算 尽量 调用 Kmath 库 完成 ， 以 充分利用 系统 的 资源 　 算法 描述 和 分析 　 　 这里 我们 考虑 的 问题 是 计算 矩阵 乘积 CA × B ， 其中 A ， B 和 C 分别 是 m × k ， k × n 和 m × n 阶 矩阵 处理器 数为 p ， 映射 为 r × c 二维 mesh ， 这里 pr × c ， mycol 和 myrow 分别 为 各 处理器 所在 的 行号 和 列 号 ， ≤ myrow ≤ r ， ≤ mycol ≤ c 在 不 引起 混淆 的 前提 下 ， 我们 也 用 AB 和 C 来 表示 各 处理器 上 的 子 矩阵 块 ， 用 A ′ ， B ′ 表示 通信 时 使用 的 辅助 空间 　 Fox 算法 ［ ］ 　 　 这里 假设 mkn 且 rc ， Fox 算法 将 A ， B 和 C 均 划分 为 × 块 相同 大小 的 方阵 ， 对应 放在 × 的 二维 mesh 上 算法 过程 可以 分为 “ 广播 、 乘积 、 滚动 ” 部分 ， 如 算法 所示 　 　 算法 二维 mesh 上 的 Fox 算法 　 　 C 　 　 foritodo 　 　 　 　 　 curcoll （ myrowi ） mod 　 　 　 　 　 ifmycolcurcol 向 本行 广播 A ， 存于 A ′ 　 　 　 　 　 CCA ′ × B 　 　 　 　 　 ifi ≠ B 在 本列 内向 上 循环 移动 一行 　 　 endfor 　 　 Fox 算法 的 计算 量 为 Θ np 算法 中 矩阵 A 广播 了 次 ， B 移动 了 次 ， 它们 的 大小 均 为 np ， 所以 算法 的 通信 开销 为 ， 也 就是 由于 每个 处理器 上 需要 存放 A ， B 和 C 三个 子 矩阵 ， 再 加上 接收 消息 所 需 空间 ， 总共 需要 的 空间 至少 为 Θ np 　 SUMMA 算法 ［ ］ 　 　 SUMMA 算法 和 Fox 算法 一样 ， 将 A ， B 和 C 划分 为 相同 大小 的 矩阵 ， 对应 放在 r × c 二维 mesh 上 但 SUMMA 算法 将 矩阵 乘法 分解 为 一系列 的 秩 nb 修正 ， 即 各 处理器 中 的 A 和 B 分别 被 分解 为 nb 大小 的 列块 和 行块 进行 相乘 ， nb ≤ minkrkc ， 前面 所说 的 分块 尺寸 就是指 nb 的 大小 算法 中 ， 广播 实现 为 逻辑 处理器 行环 或列 环上 的 流水线 传送 ， 达到 了 计算 与 通信 的 重叠 具体 描述 如 算法 所示 　 　 算法 二维 mesh 上 的 SUMMA 算法 　 　 C 　 　 foritokstepnb 　 do 　 　 　 　 　 curcoli × cn 　 　 　 　 　 currowi × rm 　 　 　 　 　 ifmycolcurrol 向 本行 广播 A 从 imodkc 列 开始 的 nb 列 ， 存于 A ′ 　 　 　 　 　 ifmyrowcurrow 向 本列 广播 B 从 imodkr 行 开始 的 nb 行 ， 存于 B ′ 　 　 　 　 　 CCA ′ × B ′ 　 　 endfor 　 　 SUMMA 算法 的 计算 量 为 Θ np 算法 中 通信 部分 采用 了 流水线 广播 的 技术 ， 其 通信 开销 应为 knbctsm × nbtwrknbrtsn × nbtwc ， 当 mkn 且 rc 时 通信 开销 为 nnbptsn × nbtw 由于 每个 处理器 上 需要 存放 A ， B 和 C 三个 子 矩阵 ， 再 加上 接收 消息 所 需 空间 ， 总共 需要 的 空间 为 Θ npnb × n 　 　 SUMMA 算法 的 计算 复杂度 和 Fox 算法 相当 ， 而 所 需 的 辅助 空间 小于 Fox 算法 ， 在 处理器 数目 相同 时 ， SUMMA 算法 可以 求解 更 大规模 的 问题 另外 又 由于 SUMMA 算法 采用 了 流水线 广播 的 技术 ， 其 通信 开销 中不含 logP 因子 ， 故 SUMMA 算法 具有 更好 的 可 扩放性 ， 对于 大规模 并行机 ， SUMMA 算法 要 优于 Fox 算法 　 nb 对 SUMMA 算法 通信 性能 的 影响 　 　 在 SUMMA 算法 中 ， 最优 分块 尺寸 nb 被 认为 对于 具体 机器 是 一个 常数 ， 并 使用 手工 的 方法 选取 我们 在 这 一节 研究 了 nb 对 SUMMA 算法 通信 性能 的 影响 ， 并 从 理论 上 寻找 选择 最优 nb 的 方法 　 理论 分析 　 　 为了 简化 讨论 ， 我们 假设 mkn ， 即 ABC 均 为 方阵 ， 这时 SUMMA 算法 的 通信 开销 为 n × tsnbn × nbtwcrrcntwrccrts ， 　 　 当 分块 尺寸 nb 增加 时 ， 式子 第项 减少 ， 第项 增加 ， 而 其它 项 的 值 不变 这里 第项 的 减少 代表 了 启动 开销 随着 启动 次数 减少 的 降低 ， 而 第项 的 增加 代表 了 计算 与 通信 重叠 的 减少 　 　 通过 计算 可以 得出 当时 ， 通信 开销 随着 nb 增加 而 减小 ， 而 当时 达到 最小值 ， 这里 r 和 c 须 满足 crrc 　 　 下面 我们 令 ， 则 ω 的 大小 完全 取决于 机器 的 通信 性能 ， 对于 具体 机器 是 一个 常数 ， 我们 称其为 机器 通信 因子 ， 因为 ω 是 机器 通信 性能 的 一个 度量 ， 当 ω 相对 较 小时 ， 则 机器 的 启动 开销 相对 较 小 ， 而 通信 带宽 相对 较大 ， 也 就是 通信 性能 相对 较 好 反之 ， 当 机器 通信 性能 相对 较差 时 ， 则 ω 的 值 也 相对 较大 　 　 我们 又 令 则 ψ 的 值 取决于 二维 处理器 网格 的 大小 和 形状 ， 故 我们 称其为 机器 结构因子 当 rc 时 ， 也 就是 在 正方形 网格 的 情形 下 ， ， 其中 p ≥ 随着 处理器 数目 的 增加 ， ψ 的 值 增加 并 逐步 趋近 于 　 　 我们 将 最优 分块 尺寸 记作 nbmax ， 从 上面 的 分析 可以 得出 nbmax ω ψ 　 　 我们 将 其 作为 最优 分块 尺寸 选取 的 主要 标准 　 　 我们 可以 发现 ， nbmax 的 大小 不仅 取决于 机器 通信 因子 ω ， 还 取决于 机器 结构因子 ψ ， 其中 机器 通信 因子 对 给定 机器 是 一个 常数 ， 而 机器 结构因子 则 随着 所用 处理器 网格 的 大小 和 形状 而 不同 所以 只有 同时 给定 机器 和 具体 网格 大小 结构 ， nbmax 的 值 才能 是 一个 定值 　 　 nbmax 的 大小 正比 于 ω ， 当 机器 通信 性能 好时 ， nbmax 相对 较 小 ， 而 当 机器 通信 性能 差时 ， nbmax 相对 较大 ， 这样 算法 所 需 的 辅助 空间 也 会 相应 增加 nbmax 的 大小 和 ψ 成反比 关系 ， 当 处理器 数目 增加 时 ， nbmax 减小 并 趋近 于 一个 常数 　 　 对于 曙光 ， 我们 可以 计算 出其 机器 通信 因子 ， 当 处理器 数目 增加 时 ， ψ 趋近 于 在 正方形 网格 的 情形 下 ， 最优 分块 尺寸 nbmax 与 处理器 数 的 关系 如图所示 从图 中 可以 看出 ， nbmax 并非 是 一个 常数 ， 而是 从个 处理器 时 的 逐渐 减小 ， 并 趋近 于 ， 减小 幅度 达到 了 图 　 曙光 上 在 rc 时 最优 分块 尺寸 与 处理器 数 的 关系 　 　 对于 m ， n ， k 不 等 的 情形 ， 可以 通过 类似 的 分析 得出 最优 分块 尺寸 选取 的 标准 ， 此时 ， 最优 分块 尺寸 的 大小 不仅 决定 于 机器 通信 因子 和 机器 结构因子 ， 还 与 m ， n ， k 相互之间 的 比例 有关 　 　 在 以上 分析 之外 ， nbmax 的 选取 还要 受到 其他 因素 如 存储器 大小 的 限制 在 实际 算法 中 ， nbmax 的 选取 必须 结合 以上 各种因素 综合 考虑 　 实验 分析 　 　 我们 分别 在 曙光 的 个 处理器 和 个 处理器 上 测量 了 阶 方阵 乘法 的 通信 时间 和 计算 时间 ， 实验 环境 已 在 第节 中作 了 介绍 ， 结果 如图所示 其中 mnk ， rcTcomm 是 通信 时间 ， Tcomp 是 计算 时间 这里 的 矩阵 元素 均 为 双 精度 浮点 类型图 　 nb 对 SUMMA 算法 性能 的 影响 　 　 随着 nb 的 增加 ， 通信 开销 下降 幅度 很大 ， 而且 下降 速度 随着 nb 增加 而 减慢 ， 在 达到 一定 值后 才 达到 较 稳定 的 最低点 ， 而 计算 开销 基本 保持稳定 根据 前 一节 的 理论 分析 可以 计算 出 对应 于 p 和 p 的 最优 分块 尺寸 nbmax 应为 和 ， 这 和 实验 数据 是 基本 吻合 的 　 性能 测试 　 　 从图 可以 看出 ， 虽然 nb 在 大于 一定 值 在 曙光 上 为 左右 以后 ， 计算 性能 就 基本 可以 达到 一个 稳定 的 值 ， 但是 通信 性能 却 远 未 达到 最优 由于 通信 开销 占 了 算法 总开销 相当 大 的 比重 ， 所以 我们 应该 在 存储 允许 的 前提 下 按 前面 提出 的 标准 调整 nb ， 以 使 算法 性能 达到 最优 　 　 我们 分别 在 个 处理器 和 个 处理器 上 对 Fox 算法 、 SUMMA 算法 取 nb 和 调整 了 nb 的 SUMMA 算法 记作 SUMMA ′ 作 了 性能 比较 ， 实验 结果 如图所示 图 显示 在 同样 的 条件 下 ， SUMMA 算法 可以 比 Fox 算法 更 大规模 的 问题 ， 改进 后 的 SUMMA 算法 性能 明显增加 ， 在 个 处理器 时 与 Fox 算法 接近 ， 而 在 个 处理器 时 超过 了 Fox 算法 图 　 FoxSUMMA 和 改进 后 的 SUMMA 算法 的 比较 　 　 使用 改进 后 的 SUMMA 算法 在 全部 个 处理器 上 计算 阶 方阵 乘积 时 ， 速度 可以 达到 Mflops ， 将 曙光 的 试算 结果 ［ ］ 提高 了 ， 是 曙光 双 精度 类型 数据 运算 峰值 的 ， 这里 取 r ， c 　 结语 　 　 SUMMA 算法 在 通信 开销 上 优于 Fox 算法 ， 可 扩放性 好 ， 适合 于 大规模 分布式 并行机 本文 通过 分析 nb 对 SUMMA 算法 通信 性能 的 影响 ， 指出 分块 尺寸 是 SUMMA 算法 性能 中 不可 忽视 的 一个 重要 因素 分析 指出 ， 最优 的 分块 尺寸 与 机器 的 通信 性能 和 拓扑 结构 有关 ， 对于 给定 的 机器 ， 最优 的 分块 尺寸 并 不是 一个 定值 ， 而是 随着 所用 处理器 的 数目 和 拓扑 结构 而 变化 通过 调整 nb 值 改进 后 的 SUMMA 算法 性能 有 了 大幅度提高 ， 可 达到 机器 峰值 的 一半 以上 　 　 在 大规模 分布式 并行机 上 ， 通信 开销 占 执行 时间 相当 大 的 比重 ， 分析 算法 时 不仅 要 考虑 分块 尺寸 对 计算 开销 的 影响 ， 还要 考虑 其 对 通信 开销 带来 的 影响 本文 对 SUMMA 算法 中 最优 分块 尺寸 的 分析 和 研究 方法 对 其它 类似 算法 的 性能 分析 ， 尤其 是 通信 性能 的 分析 和 可 扩放性 的 分析 具有 一定 的 参考 意义 ■ 作者简介 ： 谢幸 ， 男 ， 年月生 ， 博士 研究生 ， 主要 研究 方向 为 并行 分布 计算 　 　 　 　 　 顾乃杰 ， 男 ， 年月生 ， 副教授 ， 主要 研究 方向 为 并行 与 分布 计算 　 　 　 　 　 陈国良 ， 男 ， 年月生 ， 教授 ， 博士生 导师 ， 主要 研究 方向 为 并行计算 作者 单位 ： 谢幸 （ 中国 科学技术 大学 计算机 科学技术 系 　 合肥 　 ） 　 　 　 　 　 顾乃杰 （ 中国 科学技术 大学 计算机 科学技术 系 　 合肥 　 ） 　 　 　 　 　 陈国良 （ 中国 科学技术 大学 计算机 科学技术 系 　 合肥 　 ） 参考文献 ： ［ ］ CannonLEAcellularcomputertoimplementtheKalmanfilteralgorithm ［ PhDDissertation ］ MontanaStateUniversity ［ ］ FoxGCOttoSWHeyAJGMatrixalgorithmsonahypercubeIMatrixmultiplicationParallelComputing ～ ［ ］ ChoiJDongarraJJWalkerDWPUMMAParalleluniversalmatrixmultiplicationalgorithmsondistributedmemoryconcurrentcomputersConcurrencyPracticeandExperience ～ ［ ］ HussLedermanSJacobsonEMTsaoAetalMatrixmultiplicationontheInteltouchstonedeltaConcurrencyPracticeandExperience ～ ［ ］ vandeGeijnRWattsJSUMMAScalableuniversalmatrixmultiplicationalgorithmTheUniversityofTexasatAustinTechRepUTEXASCSCSTR ［ ］ 曙光 大规模 并行 计算机系统 鉴定会 材料 国家 智能 计算机 研究 开发 中心 　 　 　 CertifyingMaterialofDawningMassivelyParallelProcessingSysteminChineseNationalResearchCenterforIntelligentComputingSystems ［ ］ 孙家 昶 ， 张林波 ， 迟学斌 等 网络 并行计算 与 分布式 编程 环境 北京 科学出版社 　 　 　 SunJiachang ， ZhangLinbo ， ChiXuebinetalNetworkParallelComputingandDistributedProgrammingEnvironmentinChineseBeijingSciencePress ， ［ ］ GuNaijieChenXiaoqingChenGuoliangetalPerformanceofmatrixmultiplicationonAPInProcofIntlWorkshoponComputationalScienceandEngineering ～ ［ ］ 吴建平 ， 迟学斌 分布式系统 上 并行 矩阵 乘法 中国科学院 软件 所 并行 软件 研究 开发 中心 年 年报 ， ～ 　 　 　 WuJianpingChiXuebinParallelmatrixmultiplicationondistributedsystemsAnnualReportofResearchandDevelopmentCenterforParallelSoftwareinChinese ～ 收稿 日期 ： 修稿 日期 ：