计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 第卷 第期 VolNo 一种 基于 结点 的 分布式 合作 缓存 管理 算法 DCC 郑晓薇 　 郑纬民 沈美明 摘 　 要 　 工作站 机群系统 需要 有 一个 高性能 的 并行 文件系统 以 适应 高速 输入 、 输出 数据处理 的 要求 ， 而 提高 并行 文件系统 性能 的 关键 是 合作 缓存 技术 文中 提出 了 一种 基于 结点 的 分布式 合作 缓存 管理 算法 DCC 该 算法 综合 了 基于 全局 管理器 和 基于 局部 信息 两种 算法 的 优点 给出 了 一种 位于 结点 机上 的 主块 信息 站 的 方法 通过 对主块 信息 站 的 信息 进行 维护 来 达到 对 全局 信息 的 跟踪 算法 采用 积极 的 局部 信息 维护 策略 ， 提高 了 主块 位置 判断 的 准确性 与 GMS 算法 、 Hints 算法 相比 ， DCC 算法 的 开销 较小且 具有 较 好 的 可扩展性 关键词 　 机群系统 分布式 合作 缓存 主块 信息 站 中图法 分类号 　 TPADISTRIBUTEDCOOPERATIVECACHINGALGORITHMFORWORKSTATIONCLUSTERFILESYSTEMZHENGXiaoWeiZHENGWeiMinandSHENMeiMingDepartmentofComputerScienceLiaoningNormalUniversityDalianDepartmentofComputerScienceEngineeringTsinghuaUniversityBeijingAbstract 　 WiththedevelopmentofworkstationclustersystemsahighperformancefilesystemonsuchsystemsisneededAimpotenttechnologytofurtherimprovetheperformanceofclusterfilesystemiscooperationofcacheAdistributedcooperativecachingalgorithmDCCisbroughtforwardinthispaperThisalgorithmcombinestheadvantagesoftheglobalmanagerbasedalgorithmsandthelocalmessagebasedalgorithmsItgivesaconceptofmastercopymessagestationThisapproachusesactivesafeguarddecisionoflocalmessagesThejudgmentofmastercopypositionismoreaccurateConsequentlythecostofthealgorithmisthelowestamongtheavailablealgorithmsanditalsoexhibitsagoodscalabilityKeywords 　 clustersystemdistributedcooperativecachemastercopystation 　 引言 　 　 NFSAFS ［ ］ 等 传统 网络 文件系统 的 文件 管理 是 由 中央 服务器 负责 的 ， 这种 方法 的 可扩展性 较差 ， 随着 系统 规模 的 增加 中央 服务器 会 成为 系统 的 瓶颈 造成 网络 拥塞 较 好 的 改进 方法 是 分布式 合作 缓存 技术 ， 该 技术 采用 分布式 算法 进行 全局 管理 并 将 文件系统 的 管理 分配 到 多个 结点 上 完成 ， 各 结点 上 的 缓存 相互协作 ， 所有 结点 上 的 缓存 可以 看成 一个 大 的 全局 缓存 由于 应用程序 访问 过 的 文件 块 保存 在 结点 机 的 内存 缓冲区 中 再次 访问 该块 就 可以 经 合作 缓存 获得 而 不必 读写 磁盘 从而 提高 了 系统 速度 　 　 在 设计 合作 缓存 管理 算法 时应 避免 降低 局部 性能 ， 如果 本地 应用程序 需要 本 结点 机 的 所有 内存 时 ， 该 结点 不 应 缓存 任何 远程 结点 的 数据 块 ， 应 将 其 替换 到 其它 结点 上去 设计 算法 的 另 一 重点 是 全局 数据 块 的 快速 查找 ， 已有 的 方法 为 精确 信息 法 ， 一般 使用 全局 管理器 来 维护 各 结点 缓存 中 精确 的 块 信息 ， 采用 这种 方式 的 有 GMS 算法 ［ ］ 、 XFS ［ ］ 中 的 NChance 算法 ； 另一类 为 模糊 信息 法 ， 它 不 要求 维护 精确 的 全局 信息 而是 通过 查找 每个 结点 上 设置 的 一个 块 信息 目录 进行 模糊 查找 ， 例如 Hints 算法 等 ［ ］ 　 　 在 NChance 算法 中 全局 管理器 以 分布 方式 由 多个 管理器 负责 维护 块 在 缓存 中 的 位置 和 块 一致性 ， 因此 在 每次 块 查找 时 都 可 直接 找到 块 在 缓存 中 的 准确 位置 ， 但 算法 的 开销 很大 ， 而且 每次 本地 块 缺失 时 ， 均 要 通过 管理器 才能 找到 块 的 位置 ， 并 需要 等待 管理器 回答 　 　 GMS 算法 也 是 采用 分布式 的 全局 管理器 来 收集 全局 信息 各 结点 利用 全局 信息 来 确定 数据 块 的 位置 ， 然而 GMS 需要 一个 集中 的 管理器 来 负责 收集 信息 、 进行 处理 和 发送 ， 因而 可扩展性 不好 　 　 Hints 算法 利用 非 精确 的 全局 信息 Hints 进行 合作 缓存 管理 这样 就 避免 了 NChance 算法 和 GMS 算法 用于 维护 精确 的 全局 信息 的 开销 Hints 算法 在 每个 结点 上 维护 一个 Hints 表 记录 了 全局 其它 结点 中 的 最 老块 的 时间 信息 以及 主块 位置 信息 但 Hints 算法 中 所 采用 的 主块 位置 链 存在 链头 不 固定 的 问题 因此 会 出现 虽然 主块 在 缓存 中 ， 但 在 结点 中 却 找 不到 的 情况 ， 并且 主块 会 因 不断 的 前 送 而 造成 主块 位置 链 过长 、 请求 需要 多次 前送 才能 找到 主块 的 情况 Hints 算法 还 存在 某 活跃 结点 无法 及时 获知 另 一 活跃 结点 变为 空闲 的 情况 ， 这是 由于 各 结点 间 无前 送 关系 时 ， Hints 算法 不会 维护 这些 结点 间 的 信息 造成 的 　 　 本文 提出 的 DCC 算法 distributedcooperativecachingalgorithm 综合 了 基于 全局 管理器 和 基于 局部 信息 两类 算法 的 优点 利用 各 结点 的 局部 信息 减少 对 管理器 的 依赖 又 利用 全局 信息 以 减少 局部 决策 错误 DCC 算法 给出 了 主块 信息 站 MCSmastercopystation 的 概念 ， 各 结点 的 MCS 保存 有本 地主 块 信息 ， 对 该站 的 访问 可 随时 获知 要 访问 的 文件 块 的 主块 的 情况 ， 大多数 的 块 可 直接 定位 ， 缩短 了 访问 时间 ； 当 一个 文件 块 成为 主块 后 ， 通过 对 MCS 的 维护 ， 只要 主块 在 缓存 中 ， 其它 结点 即可 访问 到 此主块 而 不必 读取 磁盘 在 机群系统 中 各 结点 间 需要 频繁 的 通信 来 访问 对方 的 磁盘 和 缓存 ， DCC 算法 利用 这些 通信 来 捎带 发送 本地 信息 以及 全局 状态 信息 ， 可以 使 较 精确 的 全局 信息 较 快 地 传播 ， 因而 算法 的 开销 较 小 并且 具有 较 好 的 可扩展性 DCC 算法 的 合作 缓存 结构 　 　 基于 机群系统 的 DCC 算法 的 合作 缓存 模型 将 所有 磁盘 中 的 数据 块 统一 编址 对 每个 数据 块 赋予 一个 块 号 　 　 设 系统 中有 n 个 结点 令 第 i 个 结点 缓存 中 的 数据 块 集为 Mi ， 磁盘 中 的 数据 块 集为 Di ， 则 所有 缓存 中 的 数据 块 的 集合 是 所有 磁盘 中 数据 块 集合 的 子集 ， 即 对于 第 i 个 结点 将 Mi 称为 本地 缓存 ， Di 称为 本地 磁盘 而 Mj （ j ≠ i ） 称为 远地 缓存 Dj 称为 远地 磁盘 每个 结点 中 的 数据结构 如图所示 ， 图中 缩写 说明 如下 图 　 DCC 算法 的 合作 缓存数据 结构 　 　 缓存 管理器 CMcachemanager 由于 取消 了 全局 管理器 因此 所有 的 合作 缓存 管理工作 由 分布 在 各 结点 上 的 缓存 管理器 共同 协调 完成 　 　 磁盘 块 位置 表 DCLdiskcopylist 将 所有 的 文件 块 所 对应 的 磁盘 块 号 以及 相应 结点 机号 保存 在 DCL 中 ， 查询 DCL 即可 得知 某 文件 块 在 哪个 结点 机中 ， 每个 结点 的 数据结构 均 保存 相同 的 DCL ， 一经 确定 不再 改变 　 　 主块 及 主块 信息 站 MCSmastercopystation 为 保证 各 结点 的 本地 信息 能 获得 相对 稳定 的 全局 信息 ， 我们 引入 “ 主块 ” mastercopy 的 概念 将 第一次 读入 缓存 的 文件 块 磁盘 拷贝 定义 为主 块 ， 称为 本 地主 块 ， 将 本 地主 块 前 送到 其它 结点 上时 称为 全局 主块 ， 对主块 的 再次 访问 均 是 通过 复制 主块 获得 的 MCS 中 记载 了 本地 磁盘 块 是否 已成 为主 块 以及 主块 的 位置 信息 ， 主块 的 位置 只有 在 被 前 送 时 才 改变 ， 表中 的 信息 不 包含 该主块 的 副本 的 信息 　 　 全局 向量 时间表 GVTglobalvectortime 任 指定 一个 结点 存放 GVT ， 保存 n 个 结点 上 的 向量 时钟 VT ［ ］ ， VT ［ ］ ， … ， VT ［ n ］ 每当 结点 机上 进行 合作 缓存 操作 事件 时 修改 其 局部 向量 时钟 VT ［ i ］ maxVT ［ ］ ， VT ［ ］ ， … ， VT ［ n ］ ） ＋ 同时 给 事件 打上 本 结点 当前 的 向量 时钟 值 作为 该 缓存 块 的 时 戳 ， 并且 可以 比较 任意 两个 缓存 块 的 新旧 程度 及 做出 决策 ， 而 传统 的 向量 时钟 ［ ］ 只能 比较 两个 具有 因果关系 的 事件 的 先后 次序 而 不能 比较 任意 两个 事件 的 先后 次序 　 DCC 算法 的 块 查找 及 替换 策略 　 　 DCC 算法 的 主要 内容 是 块 查找 与 块 替换算法 ， 通过 对 DCL 及 MCS 的 查找 及 维护 策略 实现 对主块 位置 的 判断 以及 对主块 的 访问 DCC 算法 对 合作 缓存 的 管理决策 描述 如下 　 　 设 dns 为 全局 第 s 步时 结点 n 上 访问 的 数据 块 号 并 代表 对 缓存 的 访问 ， Mns 为 结点 n 上 的 数据 块 集 将 第 s 步 结点 n 上 本地 块 缺失 时 的 决策 Ens 用 一个 四元组 arv ω 表示 其中 a ∈ localremote 表示 远地 访问 的 块 是否 缓存 在 本地 r ∈ movecopy 表示 远地 访问 的 块 是 迁移 还是 复制到 本地 v 为 本地 的 被 替换 块 　 　 若 aremote 或 本地 缓存 未满 ， 则 定义 v 表示 无须 选择 被 替换 块 alocal 且 本地 缓存 已满 ， 则 定义 vdd ∈ Mnsd 为 被 替换 块 ； ω em 为 一个二元 组 表示 v 被 迁移 到 结点 m 并且 替换 m 上 的 块 e 其中 e ∈ Mms ； 如果 aremote 或 v 被 舍弃 不 迁移 则 定义 ω 　 　 在 操作 时 每个 结点 均 先 检查 本地 的 主块 信息 站 ， 若 本地 MCS 中有 要 访问 的 数据 块 链头 则 可 直接 访问 否则 进行 决策 结点 对 某 文件 块 的 查找 及 替换 分为 几种 情况 　 　 主块 不 在 缓存 中 Enslocalcopy 　 　 例 ： 本地 结点 号 n 文件 块 号 dns 远地 磁盘 Dj 号 块 在 号 结点 上 　 　 过程 ： 查 本地 DCL 再查 MCS 无主块 消息 调用 向量 时钟 程序 计算 本地 向量 时钟 ； 在 MCS 中 加入 ， 表示 块 的 主块 在 结点 缓存 中 ； 从 磁盘 D 中 读出 块 并 打 上 时 戳 然后 复制到 缓存 M 在 通信 时 顺带 将 MCS 的 变化 传给 MCS 　 　 主块 已 在 缓存 中 Enslocalcopyv ω 　 　 例 ： ndns ω e 　 　 过程 ： 查 本地 的 DCL 并 访问 MCS 查询 到 主块 在 号 结点 缓存 中 调用 向量 时钟 程序 ， 计算 出 本地 向量 时钟 ； 将 号 结点 中 的 v 块 迁移 到 号 结点 ， 替换 号 上 的 块 e ； 将块 复制到 缓存 M 并 更改 时 戳 ， 同时 顺带 将 MCS 信息 传递 给 MCS ， 号 结点 中 为主 块 的 副本 　 　 主块 要 被 替换 并 前 送 Ensremotemovev ω 　 　 例 ： nvdns ω 　 　 过程 ： 查询 DCL 并 访问 MCS 将块 主块 的 位置 改为 ， 同时 将 MCS 和 MCS 一并 修改 ； 调用 向量 时钟 程序 计算 出 本地 时钟 ； 将 主块 更改 时 戳 后 移动 到 号 结点 作为 全局 主块 ； 舍弃 号 结点 缓存 中 的 主块 　 　 前送 后 的 主块 再次 被 访问 Enslocalcopyv 　 　 例 ： ndns 　 　 过程 ： 访问 MCS 知主块 在 号 结点 在 MCS 中 更 改为 表示 块 的 主块 已换 到 号 结点 上 并 成为 本 地主 块 执行 向量 时钟 程序 时 戳 更改 后 将 主块 从 号 复制到 号 结点 并 舍弃 本地 替换 块 v 　 　 块 替换算法 与 前 送 结点 的 选择 　 　 具体 算法 如下 ： 　 　 ① 根据 向量 时钟 值 在 本地 保存 的 LRU 链上 选择 最老 的 非主块 舍弃 ； 　 　 ② 若 LRU 链上 只有 主块 ， 选出 最老 的 主块 ， 访问 结点 上 的 全局 向量 时间表 VCT ， 计算 最 空闲 的 结点 作为 前送 结点 ； 　 　 ③ 若该 结点 为 本地 结点 ， 将 最 老主块 舍弃 ； 若 为 其它 结点 ， 则 将 最 老主块 前 送 若 本地 缓存 中 最 老块 比前 送块 时间 要 新 ， 将 前 送块 继续 前送 ， 前送 n 次 仍 找 不到 接收 结点 则 将 前 送块 丢弃 　 DCC 算法 的 模拟 测试 结果 及 分析 　 　 我们 通过 实验 模拟系统 ［ ］ 对 DCC 算法 进行 了 测试 及 分析 并 将 DCC 算法 和 Hints 算法 测试 的 结果 进行 了 比较 测试数据 如下 　 　 系统 为个 结点 机 ， 采用 MbitsATM 网 连接 的 工作站 机群系统 ， 信息 站数 ， 各 结点 缓存 块 数块 ， 各 结点 磁盘 块 数块 ， 块 大小 KB ， 块 访问 次数 次 ， 本地 访问 时间 ms 远地 访问 时间 ms 磁盘 访问 时间 ms 网络 延迟 ms 　 　 共用 组 测试数据 　 　 A 组 文件 访问 集中度 θ 在 磁盘 块 上 有 的 访问 比例 访问 重叠 度 ρ 表示 两个 结点 访问 相同 的 数据 集 各 结点 均 访问 第 号 结点 中 的 数据 共块 ； 　 　 B 组 文件 访问 集中度 θ 访问 重叠 度 ρ 集中 访问 集 按 轮转 方式 分布 在 各 结点 磁盘 中共 块 ； 　 　 C 组 θ ρ 两 结点 对 访问 集 的 随机 访问 频率 集中 访问 集共块 ； 　 　 D 组 θ ρ 各 结点 集中 访问 集 相同 ， 访问 集 按 轮转 方式 分布 在 各 结点 的 磁盘 上 ， 共块 　 　 局部 信息 准确性 测试 　 　 在 DCC 算法 和 Hints 算法 中均 将 维护 局部 的 信息 用于 本地 决策 　 　 例如 在 块 查找 时 维护 本地 信息 站 MCS 的 准确性 利用 本地 信息 判断 本地 缺失 块 在 其它 结点 缓存 的 次数 占 查找 本地 缺失 块 所有 次数 之 比如 表 所示 表 　 DCC 法 与 Hints 法主块 位置 表 准确性 比较 　 A 组 测试数据 B 组 测试数据 C 组 测试数据 D 组 测试数据 DCCHints 　 　 从表中 可以 看出 DCC 算法 在 组 测试数据 下均 明显 优于 Hints 算法 ， 这是 由于 DCC 算法 采用 了 积极 的 局部 信息 维护 策略 每次 结点 间 交换 信息 时均 顺带 交换 双方 状态 信息 以及 其它 结点 的 有关 信息 因而 使 各个 结点 的 信息 都 比较 准确 而 在 Hints 算法 中 只是 在 前 送块 时 双方 才 交换 信息 　 　 访问 集中度 对 算法 性能 的 影响 　 　 对 A 组 测试数据 将 其 访问 集中度 分别 定为 、 ／ 、 ／ 和 ／ ， 观察 两种 算法 的 平均 块 访问 时间 如图所示 可以 看出 随着 集中度 变小 两 算法 性能 都 在 降低 而且 算法 性能 的 差距 逐步 缩小 但是 由于 DCC 算法 能 较 好 地 利用 文件 访问 数据 的 集中度 因此 性能 较 好 图 　 不同 访问 集中度 对 算法 性能 的 影响 　 　 系统 中 结点 数对 性能 的 影响 　 　 图 表示 出 了 系统 中 结点 数据 分别 为 、 、 时 两 算法 的 平均 块 访问 时间 随着 结点 数 的 增加 Hints 算法 的 性能 基本 不变 而 DCC 算法 的 性能 则 随着 结点 数 的 增加 而 增加 因此 具有 较 好 的 可扩展性 图 　 系统 中 结点 数对 算法 性能 的 影响 A 组 数据 　 　 从 测试 结果 可以 看出 分布式 合作 缓存 管理 算法 DCC 随着 结点 数 增加 合作 缓存 变 大 因此 可以 在 缓存 中 保存 更 多 的 文件 块 从而 提高 了 系统 的 性能 　 结论 　 　 DCC 算法 利用 各 结点 上 的 主块 信息 站 MCS 保存 的 较 精确 的 本地 信息 及 全局 信息 进行 合作 缓存 的 管理决策 ， 有效 地 提高 了 数据 块 访问 的 准确性 ， 缩短 了 访问 时间 在 算法 的 数据结构 中 使用 了 磁盘 位置 表 DCL 来 保存 文件 块 号 和 与 之 相应 的 结点 机号 ， 使 各 结点 对 文件 块 的 查找 先 在 本地 进行 ， 然后 再 查询 MCS 上 的 信息 ， 这样 就 可以 进一步 缩短 寻找 主块 的 时间 ， 从而 大大减少 了 算法 的 开销 当 结点 增加 时 ， 只 需 将 DCL 稍加 修改 即可 ， MCS 不受 影响 ， 因此 算法 的 可扩展性 也 较 好 作者简介 ： 郑晓薇 ， 女 ， 年月生 ， 副教授 ， 主要 研究 方向 为 计算机系统 结构 、 并行 文件系统 郑纬民 ， 男 ， 博士生 导师 ， 主要 研究 领域 为 计算机系统 结构 、 分布式系统 及 并行处理 沈美明 ， 女 ， 博士生 导师 ， 主要 研究 领域 为 计算机系统 结构 、 分布式系统 及 并行处理 作者 单位 ： 郑晓薇 　 辽宁 师范大学 计算机系 　 大连 　 郑纬民 沈美明 　 清华大学 计算机科学 与 技术 系 　 北京 　 参考文献 　 HowardJKazarMMeneesSetalScaleandperformanceinadistributedfilesystemACMTransComputerSystems ～ 　 FeeleyMJMorganWEPighinFHetalImplementingglobalmemorymanagementinaworkstationclusterInProceedingsoftheACMFifteenthSymposiumonOperatingSystemsPrinciplesUSA ～ AmdersonTEDahlinMDNeefeJetalServerlessnetworkfilesystemInProceedingsoftheACMFifteenthSymposiumonOperatingSystemsPrinciplesUSA ～ PrasenjitSarkarJohnhHartmanEfficientCooperativecachingusinghintsInProceedingsofSecondSymposiumonOperativeSystemdesignandImplementationUSA ～ FidgeCJLogicaltimeindistributedcomputingsystemsComputer ～ 何君 ， 田范江 ， 王鼎兴 一种 机群 网络 文件系统 的 合作 高速缓存 技术 计算机 学报 ， ， ： ～ HeJunTianFanjiangWangDingxingCooperativecachinginthenetworkfilesystemonworkstationclusterChineseJournalofComputersinChinese ～ 原稿 收到 日期 ： ； 修改稿 收到 日期 ：