计算机 工程 ComputerEngineering 年 　 第卷 　 第期 　 Vol 　 No 　 ME 芯片 的 设计 原则 杨超峰 　 胡铭 曾 　 张毅 摘 　 要 　 运动 估计 MotionEstimationME 是 运动 图象 编码 的 一个 重要 步骤 。 设计 了 一个 ME 芯片 的 设计 原则 以及 框架结构 。 实际上 ， 该 设计 原则 可以 用来 指导 其它 嵌入式 芯片 的 设计 。 关键词 　 运动 估计 运动 图象 编码 ME 芯片 DesigningPhilosophyoftheMEchipYangChaofengHuMingzengZhangYi （ DepartmentofComputerScienceandEngineering ， HarbinInstituteofTechnologyHarbin ） （ DepartmentofEngineeringHarbinUniversityofScienceandTechnologyHarbinAbstractMotionestimationMEisakeyphaseinthemovingpicturecodingWehavedesignedaMEchipInthispaperthedesigningphilosophyofthischip ， includinghowtodetermineitsfunctionsandbehaviorofperpheral ， ispresentedthenitsstructureisdiscussedbrieflyInfactthedesigningphilosophypresentedherecanbeusedtoguidedesignofotherembeddedchipsKeywordsMotionestimationMovingpicturecodingMEchips 　 　 随着 计算机技术 及 通信 技术 的 发展 ， 一个 很 自然 的 想法 是 利用 它们 来 创造 一个 数字化 世界 。 实现 这个 目标 的 关键在于 声音 和 图象 的 实时 传输 ， 但是 数字化 后 的 声音 和 图象 数据量 很大 ， 需要 对 它们 进行 压缩 。 　 　 运动 估计 是 运动 图象 编码 的 一个 重要环节 ， 因为 它 占 整个 过程 的 绝大部分 计算 量 。 全 搜索 块 匹配 算法 FSBMA 是 最 重要 的 运动 估计 算法 ， 因为 它 得到 的 匹配 结果 最佳 ， 并且 易于 VLSI 实现 。 我们 设计 了 一个 支持 FSBMA 的 ME 芯片 。 　 ME 芯片 的 设计 原则 　 　 芯片 的 设计 原则 可以 从 芯片 的 功能 和 芯片 的 行为 两个 方面 来 描述 。 　 芯片 的 功能 　 　 此时 要 考虑 的 是 ： 基于 一定 的 性能 价格比 ， 确定 芯片 应 具有 的 功能 。 与 性能 价格比 紧密 相关 的 有 个 参数 ： 芯片 的 计算能力 、 复杂度 及 灵活性 。 计算能力 决定 芯片 的 性能 。 复杂度 和 灵活性 决定 芯片 的 价格 ， 因为 降低 复杂度 可以 降低 芯片 的 设计 成本 和 生产成本 ， 而 灵活性 大 使得 芯片 的 应用 面广 ， 需求量 大 ， 从而 分摊 给 每个 芯片 的 设计 成本 降低 。 　 　 · 芯片 的 性能 及 复杂度 　 关于 运动 图象 压缩 的 一个 重要 标准 是 MPEG 标准 ， 它 设定 低 、 中 、 高档 指标 ， 中档 指标 的 计算 量 为 GOPS ， 高档 指标 为 GOPS 。 对于 这么 高 的 计算 需求 ， 小规模 的 通用 计算机 不能 满足 ， 由于 FSBMA 非常 规整 ， SYSTOLIC 阵列 是 很 好 的 计算机 制 。 经 计算 ， 若 设计 出 一个 实现 高档 指标 的 运算 阵列 ， 要求 外存 的 带宽 很 高 ， 因而 整个 系统 的 实现 代价 很大 ， 其 应用 面 不会 很大 ， 至少 不会 如 PC机 卡 似的 普及 ， 而 实现 它 的 芯片 复杂度 将 比 中档 指标 翻倍 ， 极度 提高 了 成本 。 实现 中档 指标 ， 芯片 的 复杂度 大约 为 万 晶体管 左右 ， μ m 的 半导体 工艺 就 能 实现 。 况且 若 采用 前后 向 预测 技术 ， 可 减小 搜索 区 ， 用 较 低 性能 的 芯片 也 能 支持 高档 指标 。 因而 芯片 的 计算能力 制定 在 支持 MPEG 的 中档 指标 。 　 　 MPEG 标准 制定 了 帧 、 场 、 三种 匹配 模式 ， 通过 获得 所有 这些 模式 的 运动 向量 来 确定 最优 的 一个 ， 这 进一步提高 了 计算 量 ， 因而 ME 芯片 只 选择地 实现 其中 的 若干 模式 。 　 　 由 FSBMA 可以 设计 出 多个 处理器 阵列 。 最终 选定 的 阵列 只有 一个 数据 输入 端口 ， 这 极度 简化 了 局部 存储器 与 阵列 的 接口 ， 降低 了 芯片 的 复杂度 。 虽然 其 运算 阵列 的 利用率 很 低 ， 但是 仍能 满足 计算能力 的 要求 。 　 　 · 芯片 的 灵活性 　 虽然 关于 运动 图象 编码 有 多个 标准 ， 它们 的 区别 主要 在于 图象 的 大小 、 参考 块 的 大小 ， 帧 速率 及 搜索 区 的 大小 等 。 这些 参数 决定 芯片 的 结构 局部 存储器 及 运算 阵列 。 但是 ， 它们 的 ME 部分 均 采用 同一 算法 ， 设计 出 的 运算 阵列 大同小异 ， 区别 只 在于 阵列 的 规模 上 。 如果 设计 出 一个 足够 大 的 阵列 ， 再 增加 一些 额外 的 重构 机制 ， 就 能 支持 不同 的 标准 ， 提高 芯片 的 应用 面 。 MPEG 标准 中 参考 块 的 大小 与 搜索 区 的 大小 这 两个 参数 在 所有 标准 中是 最大 的 ， 按照 它们 将 设计 出 最 大规模 的 阵列 。 　 芯片 的 行为 　 　 ME 芯片 只 完成 运动 图象 编码 的 一个 步骤 ， 只是 整个 编码 系统 的 一个 组成部分 。 芯片 的 行为 就是 ME 芯片 的 接口 部分 ， 因为 从 系统 中 其它 部分 的 角度 来看 ， 芯片 是 一个 黑匣子 ， 它 的 行为 完全 体现 于 其 接口 部分 。 一个 好 的 接口 应该 易于 使 芯片 与 系统 其它 部分 互连 ， 我们 归纳 出 好 接口 应 具有 的 特征 ： 自身 与 系统 其它 部分 的 耦合度 小 。 　 　 ME 芯片 与 外界 的 交互 主要 表现 在 与 系统 其它 部件 共享 外存 及 同步 两个 方面 。 　 　 外存 接口 　 关于 外 存有 以下 特点 ： 存储器 件 种类 繁多 ， 发展 迅速 ， 因而 其 性能 的 跨度 很大 ， 从 ns 到 几十 ns ； 运动 图象 编码 过程 中 涉及 的 数据量 很大 ， 要求 存储器 的 带宽 很 高 ， 以 保证 其 不会 成为 系统 的 瓶颈 ； 外存 是 系统 的 关键 共享资源 ， 各 主动 部件 指 各类 具有 自我 控制能力 的 部件 ， 如 处理器 、 控制器 等 的 工作 均 要 以 其 为 依托 。 因为 不同 应用领域 的 数据量 不同 ， 要求 的 外存 带宽 不同 ， 所以 ， 适用 于 不同 应用领域 的 编码 系统 的 差别 主要 体现 于 外存 部分 ， 包括 外存 所 采用 的 器件 及其 结构 ， 从而 它 是 整个 系统 的 代价 和 设计 复杂度 所在 。 基于 此 ， 我们 设计 ME 芯片 时 竭力 提高 外存 接口 灵活性 ， 易于 系统 的 外存 设计 ， 以 减小 外存 引起 的 系统 代价 及 设计 复杂性 ， 包括 ： 外存 访问 时序 可编程 ， 以 适应 不同 存储器 件 ； 支持 多体 的 外存 结构 ， 可以 连续 编址 ， 或 交叉 编址 以 利用 流水 访问 技术 、 高 存储器 带宽 ； 片内 设置 局部 存储器 ， 提高 数据 的 重用 来 减少 外存 访问 ； 以块 方式 访问 外存 ， 减少 外存 争用 的 仲裁 次数 。 　 　 同步 策略 　 　 ME 芯片 与 系统 中 的 其它 主动 部件 交互 仅 需 起动 前 的 一次 编程 。 此时 ， ME 芯片 被 告知 系统 的 存储器 的 体数 及 编址 方式 ， 存储器 件 的 速度 ， 图象 序列 存储 位置 ， 运算 结果 存储 位置 ， 运算 阵列 的 重构 信息 。 ME 芯片 以后 就 按照 该 设置 持续 执行 ， 不再 与 其它 主动 部件 交互 ， 以后 所 需 的 同步操作 如 ME 芯片 判断 图象 序列 的 各 帧 是否 存在 ， 其它 部件 判断 各帧 的 运算 结果 是否 存在 等 均 通过 共享 变量 完成 ， 而 外存 争用 通过 仲裁 部件 完成 。 　 　 综上所述 ， 设计 时 ME 芯片 对 本身 将 处于 的 环境 包括 主动 部件 配置 情况 及 存储器 系统结构 不 作 任何 假设 ， 便于 按照 不同 应用领域 的 特点 设计 出 高效 的 编码 系统 。 另外 ， ME 芯片 与 其它 主动 部件 仅 交互 一次 ， 并且 尽量减少 外存 的 访问 ， 从而 减少 其它 主动 部件 的 阻塞 次数 。 若能 对 整个 系统 的 各 主动 部件 恰当 地 调度 ， 通过 共享 变量 的 同步 策略 几乎 不 需要 它们 作 任何 等待 操作 ， 使得 系统 的 整体 性能 很 高 。 另外 ， 灵活 的 接口 进一步提高 了 芯片 的 灵活性 。 　 ME 芯片 的 结构 　 　 ME 芯片 由 运算 阵列 、 局部 存储器 、 控制器 及 接口 部分 组成 如图 。 图 　 ME 芯片 的 结构 框图 　 　 运算 阵列 　 运算 阵列 的 主体 采用 文献 的 结构 ， 作 了 改进 。 它 的 特征 为 ： 的 方形 SYSTOLIC 阵列 ， 单 数据 端口 ， 阵列 的 效率 为 ； 支持 帧 和 场 两种 模式 ， 并且 对于 一个 参考 块 的 帧 模式 的 运动 向量 及其 两个 场 的 场 模式 运动 向量 能够 同时 给出 ， 即 阵列 能 一次 输出 个 运动 向量 ； 工作频率 MHz 可 支持 MPEG 标准 的 中档 指标 ； 重构 支持 搜索 区 的 最大 偏移量 可以 为 、 、 ； 采用 双向 预测 技术 ， 可 缩小 搜索 区 ， 如使 最大 偏移量 为 ， 比为 时 阵列 的 速度 能 提高 近倍 ， 可以 支持 MEPG 标准 的 高档 指标 。 　 　 局部 存储器 　 分为 个 独立 部分 ： 搜索 区 存储器 、 参考 块 存储器 和 结果 存储器 。 虽然 采用 一定 的 策略 可以 合三为 一 ， 但是 这样 控制 复杂化 。 另外 ， 个体 的 带宽 高 ， 能 很 好 地 与 阵列 的 速度 匹配 。 　 　 控制器 　 控制器 的 设计 采用 分散控制 的 思想 ， 分为 部分 ： 主 控制器 、 局存 控制器 和 阵列 控制器 。 局存器 控制器 和 阵列 控制器 采用 硬连 逻辑 实现 ， 以 保证 运算 阵列 高速 地 从 搜索 区 存储器 读取数据 ， 并 将 结果 存入 结果 存储器 。 主 控制器 是 一个 简单 的 标量 处理器 ， 采用 微 程序控制 方式 ， 实现 对外 存 的 访问 、 芯片 各 部分 的 调度 及 整个 工作 流程 的 控制 ， 以 保证 芯片 有 足够 的 灵活性 ， 控制 简洁 。 其 特点 是 访存 指令 功能 很强 ， 一次 外存 访问 能 读写 一个 宏块 ， 辅之以 一些 简单 的 标量 运算 指令 。 　 　 接口 　 外存 接口 内有 一个 外存 访问 逻辑 ， 完成 主 控制器 发出 的 宏块 读写 命令 。 通过 多体 流水 及 高速 存储器 件 ， 可得 极 高带宽 ， 如 存储器 件 为 ns ， 每 体位 ， 则 体 流水 ， 带宽 为 Mbs 。 下面 是 与其 相关 的 信号线 ： 　 　 访问 允许 ： 外存 访问 竞争 胜出 　 　 选体 信号 ： 外存 体 选择 ， 支持 ～ 个体 　 　 访存 控制 信号 ： 行 、 列 地址 有效 及 读写 信号 　 　 地址 线 ： 行 地址 　 　 数据 地址 线 ： 数据线 ， 低根 多路复用 为 地址 线 　 　 控制 逻辑 接口 　 一个 串行口 ， 用来 传输 配置 参数 ， 一根 复位 线 完成 对 工作 ME 芯片 的 复位 。 　 结论 　 　 文中 详细 地 论述 了 我们 设计 支持 FSBMA 的 ME 芯片 时所 采用 的 的 设计 原则 ， 利用 该 原则 得出 一些 设计 策略 ， 使得 设计 出 的 芯片 性能 价格比 高 ， 然后 简要 描述 了 芯片 的 总体 结构 。 实际上 ， 本文 提出 的 设计 原则 也 可用 来 指导 其它 嵌入式 芯片 的 设计 。 目前 已 完成 了 该 芯片 的 逻辑设计 ， 并 通过 了 模拟 ， 下 一步 准备 用 FPGA 在 板级 实现 该 芯片 ， 作 仿真 ， 为 投片 作 准备 。 作者简介 ： 杨超峰 　 男 ， 岁 ， 博士生 ， 研究 方向 是 高性能 计算 等 作者 单位 ： 杨超峰 　 胡铭 曾 　 哈尔滨工业大学 计算机科学 与 工程系 　 哈尔滨 　 ， 张毅 　 哈尔滨理工大学 电气工程 系 　 哈尔滨 　 参考文献 　 　 KomarekT ， PirschPArrayArchitecturesforBlockMatchingAlgorithmsIEEETransonCircuitsandSystems ， ， ： 　 　 PanSB ， ChaeSS ， ParkRHVLSIArchitecturesforBlockingMatchingAlgorithmUsingSystolicArraysIEEETransCircuitsSyst ， ， ： 　 　 HsiehCH ， LinTPVLSIArchitectureforBlockmatchingMotionEstimationAlgorithmIEEETransCircuitsSystVideoTechnol ， ， ： 收稿 日期