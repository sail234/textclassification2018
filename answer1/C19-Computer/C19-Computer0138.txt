计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNo 用 AutoCAD 获取 仿真 系统 的 三维 模型 张予 川 　 曾理湛 　 王少梅 　 　 摘 　 要 　 本文 通过 阐述 VisualC 读取 AutoCAD 图形系统 三维 图形文件 DXF 的 原理 和 方法 ， 说明 了 利用 AutoCAD 实体 造型 功能 拓展 C语言 的 三维 建模 能力 ， 是 一种 在 计算机 仿真 系统 中 值得 推广应用 且 简便易行 的 方法 。 　 　 关键词 　 AutoCAD 图形库 ， 计算机 图形学 ， 机械 CAD ， VisualC 　 　 引言 　 　 建立 三维 实体模型 ， 用 合适 的 数据结构 储存 组成 装配 的 各 部件 的 几何 、 拓扑 信息 ， 是 实现 实时 动画 及 计算机 仿真 的 基础 。 要 生成 高 逼真度 的 图像 首先 要 生成 高质量 的 三维 实体模型 。 目前 在 众多 的 计算机 仿真 系统 中 ， 普遍 采用 OpenGL 建立 系统 的 三维 真实感图形 。 但是 OpenGL 只能 通过 其 基本 图元来 绘制 几何 模型 ， 不 具备 实体 造型 能力 。 OpenGL 中 提供 了 十几个 生成 三维 实体模型 的 辅助 库函数 这些 函数 均 以 aux 作为 函数 名 的 前缀 。 球体 、 立方体 、 圆柱 等 简单 的 模型 可以 利用 这些 辅助 函数 来 实现 如 函数 auxSolidSphereGLdoubler ， 绘制 一 半径 为 r 的 实心球 体 。 但是 用 这些 函数 建立 复杂 的 三维 实体模型 非常 困难 。 　 　 由于 简单 地用 图元来 绘制 各 部件 或者 重新 开发 一个 几何 造型 系统 不 现实 ， 所以 只有 考虑 采用 现有 的 造型 软件 建立 几何 模型 ， 例如 ， 用户 可以 通过 其它 建模 工具 DMAX 、 AutoCAD 等 来 辅助 建立 三维 实体模型 数据库 。 然后 通过 数据交换 标准 由 仿真 系统 获得 造型 软件 生成 的 实体模型 的 数据 ， 用 适当 的 数据结构 来 储存 这些 几何 、 拓扑 信息 ， 以 建立 仿真 系统 的 实体模型 。 造型 软件 中 ， AutoCAD 的 应用 广泛 、 造型 功能 强 、 二次开发 以 实现 参数 化 的 能力 而且 它 的 图形 交换文件 DXF 为 大多数 CAD 软件 所 接受 ， 同时 ， AutoCAD 的 DXF 文件 中 对于 三维 实体 的 描述 是 采用 三角形 面片 逼近 的 方法 而 在 OpenGL 函数库 中 提供 了 这种 绘制 三角形 面片 的 方法 从而 为 三维 实体 的 绘制 提供 了 简便 的 途径 。 所以 ， 我们 在 最近 研制 的 起重机 部件 装配 仿真 系统 中用 AutoCAD 作为 造型 软件 。 　 实体模型 的 描述 　 　 仿真 系统 三维 实体模型 的 建立 ， 首先 由 现有 的 造型 软件 AutoCAD 建立 几何 模型 ， 然后 通过 它 的 数据 交换文件 DXF 文件 ， 仿真 系统 获得 AutoCAD 生成 的 实体模型 的 数据 ， 建立 系统 自身 的 实体模型 。 　 　 一个 完整 的 DXF 文件 由 四个 段 和 文件 结尾 组成 ， 它们 的 顺序 是 ： 　 　 （ ） 标题 段 。 该段 记录 了 AutoCAD 所有 标题 变量 的 当前 值 ， 这些 标题 变量 记录 了 AutoCAD 的 当前工作 环境 。 　 　 （ ） 表段 。 该段 包含 了 七种 表 ， 按 顺序 是 ： 视窗 表 、 线型 表 、 图层 表 、 字样 表 、 用户 坐标 表 、 尺寸 标注 式样 表 和 应用程序 标识 表 ， 这些 表 记录 了 当前 图形 编辑 的 支撑 环境 。 　 　 （ ） 块 段 。 该段 记录 了 每 一个 块 的 定义 ， 记录 了 这些 块 的 名字 、 类型 、 基点 及 组成 该块 的 所有 成员 。 　 　 （ ） 实体 段 。 该段 定义 了 每个 实体 的 种类 ， 所在 图层 名 、 颜色 、 线型 、 厚度 、 实体 描述 字及 有关 几何 数据 。 　 　 （ ） 文件 结尾 。 只有 “ 　 ” 和 “ EOF ” 两行 。 　 　 具体内容 由 若干组 构成 ， 每个 组占 两行 ， 第一 行为 组 代码 ， 第二 行为 跟随 值 ， 组 代码 相当于 数据 名称 的 代码 ， 跟随 值 是 数据 的 具体 值 。 DXF 实体 分类 和 IGES 类似 ， 几何 实体 包括 如点 、 直线 、 圆弧 、 多义 线 、 三维 平面 、 轨迹 等 ； 描述 实体 包括 如 尺寸 标注 、 属性 定义 、 正文 、 块 属性 等 ； 结构 实体 包括 如型 、 块 、 子 实体 等 。 　 　 AutoCAD 将 形体 表面 作 三角形 剖分 ， 即 所有 的 表面 （ 包括 平面 、 曲面 ） 都 用 三角形 面片 来 近似 表示 。 　 　 三维 形体 的 几何 、 拓扑 信息 都 记录 在 实体 （ ENTITIES ） 段 中 ， 其 由 多个 POLYLINE 实体 描述 组成 ， 每个 POLYLINE 实体 对应 AutoCAD 中 的 体素 和 由 扫描 产生 的 基本 形体 。 　 　 POLYLINE 实体 描述 中 的 信息 包括 ： 形体 的 所有 顶点 坐标 ； 组成 三角形 面片 的 顶点 号 ， 顶点 按 符合 右手 法则 的 顺序排列 。 　 　 AME 是 一个 真 三维 的 实体 造型 系统 ， 系统 的 输入 主要 采用 CSG 及 扫描 两种 方式 。 实体 在 计算机 内 同时 采用 CSG 及 Brep 两种 表示 模式 ， 先 将 用户 的 输入 用 CSG 树 的 结构 加以 记录 ， 然后 随着 造型 进程 转换 为 Brep 表示 。 从 开始 ， AutoCAD 首次 使用 了 ACIS （ AmericaCommitteeforInteroperableStandard ） 技术 ， 将 实体 造型 系统集成 到 AutoCAD 的 核心 模块 上 ， 实体 造型 已成 了 其 基本功能 。 ACIS 技术 允许 对 实体 做 更 完整 更 精确 的 描述 ， 在 建立 复杂 实体 时 ， 仍 需 对 基本 体素 做 布尔 操作 ， 但 计算机 内 不再 使用 CSG 树 ， 而是 利用 ACIS 机制 生成 实体 的 Brep 表示 。 　 系统 所 要求 的 模型 数据结构 　 　 系统 中 部件 之间 干涉 检验 的 求交 算法 是 部件 间 的 边 面求 交 ， 随后 还要 进行 交点 和 三角形 的 包含 性 检验 ， 以及 判断 部件是否 相交 ， 其中 包括 使用 包围 体 的 加速 措施 。 算法 要求 点 的 几何 信息 ， 面 方程 的 获得 要求 面和点 的 拓扑 关系 F → V ， 边 方程 的 获得 需要 边 和 邻面 的 拓扑 关系 E → F ， 还 需要 边 和 端点 的 拓扑 关系 E → V ， 部件 及 体素 要求 有 包围 体 的 数据 。 　 　 真实感图形 的 生成 算法 要求 正确 地 计算 各 顶点 的 法 向量 ， 以 反应 物体 真实 表面 ， 所以 要 有法 向量 数据 。 真实感 显示 还 要求 部件 的 材质 信息 。 动画 的 实现 要求 部件 的 装配 方向 信息 。 布局调整 要求 部件 的 变换 矩阵 数据 。 在 参考 翼边 结构 的 基础 上 ， 针对 本 仿真 系统对 各种 信息 、 数据 的 要求 ， 结合 DXF 文件 的 特点 ， 特 作 如下 处理 ： 　 　 整个 系统 的 图形 由 组成 装配 的 各个 部件 （ 包括 减速器 、 电机 、 万向节 等 ） 的 图形 组成 ， 通常 一个 部件 在 同 一次 造型 中 完成 ， 因此 可 将 一个 部件 形体 作为 一个 DXF 文件 输出 ， 每个 部件 对应 一个 DXF 文件 ， DXF 文件 中 包括 组成 部件 形体 的 所有 体素 ， 以及 其 边界 数据 。 但是 ， DXF 文件 考虑 的 仅仅 是 几何 、 拓扑 信息 ， 而 没有 材质 这样 的 物理 信息 ， 一个 部件 往往 由 不同 材质 的 零部件 组成 ， 因此 在 真实感图形 显示 时 必须 有 材质 信息 。 为了 增加 材质 信息 ， 将 同一 材质 的 体素 作为 同一 DXF 文件 输出 ， 这样 多 个体 素集 组成 一个 部件 形体 。 因此 建立 链表 结构 TXT 记录 装配 部件 的 信息 ， 链表 结构 DXF 记录 一 部件 中同 材质 的 体素集 的 信息 ， 链表 结构 POLYLINE 记录 体素 的 信息 。 　 　 由于 AutoCAD 记录 体素 的 几何 、 拓扑 信息 使用 的 是 Brep 表示法 ， 因此 针对 体素 ， 我们 的 仿真 系统 采用 类似 翼边 结构 的 数据结构 ， 建立 了 顶点 、 边 、 面 链表 结构 ， 其中 由于 边 链表 的 生成 算法 是 通过 遍历 面 链表 ， 对应 三角形 面中 的 任意 两个 顶点 都 生成 一条 边 ， 因此 会 产生 一条 边 记录 两次 ， 为了 方便 删除 链表 结点 ， 边 采用 双链 表 结构 。 点 的 几何 信息 包括 点 的 坐标 ， 以及 点 的 法 向量 ； 面 的 几何 信息 包括 面 的 属性 ， 面 的 法 向量 以及 其 方程 系数 。 建立 了 点 、 边 、 面间 的 三种 拓扑 关系 ， 即 E → V ， E → F ， F → V 。 数据结构 图 所示 。 图 　 仿真 系统 实体模型 的 数据结构 　 　 根据 仿真 系统 的 要求 ， 用 C语言 描述 的 图形 链表 数据结构 如下 ： typedefstructvertex 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 doublecoordinate ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 坐标 （ x ， y ， z ） doublevector ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 法 向量 structvertexnext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 链表 中 下 一个 节点 VERTEX ； typedefstructedge 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 structedgeahead ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 中 上 一个 节点 structvertexvertex ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 链表 中边 的 两个 端点 structfaceface ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 的 两个 邻面 structedgenext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 中 下 一个 节点 EDGE ； typedefstructface 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 intattributte ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 曲面 标记 structvertexvertex ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 顶点 链表 中面 的 三个 顶点 doublevector ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 三角形 面片 的 平面 方程 系数 structfacenext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 链表 中 下 一个 节点 FACE ； typedefstructpolyline 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 structvertexhvertex ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 顶点 链表 的 头 节点 structedgehedge ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 边 链表 的 头 节点 structfacehface ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体 素面 链表 的 头 节点 floatboxvertex ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 包围 长方体 的 个 确定 参数 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 中 最大 和 最小 的 XYZ 坐标值 structpolylinebox ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 指向 包围 长方体 的 指针 structpolylinenext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 链表 中 的 下 一个 节点 POLYLINE ； typedefstructdxf 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 同 材质 体素集 intmaterial ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 材质 structpolylinehpolyline ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素集 的 体素 链表 的 头 节点 structdxfnext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素集 链表 的 下 一个 节点 DXF ； typedefstructheadedge 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 的 头 节点 structedgehedge ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 的 头 节点 structheadedgenext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 的 头 节点 链表 的 下 一个 节点 HEADEDGE ； typedefstructheadface 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 链表 的 头 节点 structfacehface ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 链表 的 头 节点 structheadfacenext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 链表 的 头 节点 链表 的 下 一个 节点 HEADFACE ； typedefstructtxt 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 形体 charname ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 形体 名 intdir ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 装配 方向 doublematrix ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 形体 变换 阵 structdxfhdxf ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素集 链表 的 头 节点 structheadfacehhface ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 面 链表 的 头 节点 链表 的 头 节点 structheadedgehhedge ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 边 链表 的 头 节点 链表 的 头 节点 floatboxvertex ［ ］ ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 形体 包围 长方体 的 个 确定 参数 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 体素 中 最大 和 最小 的 XYZ 坐标值 structpolylinebox ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 指向 包围 长方体 的 指针 structtxtnext ； 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 形体 链表 的 下 一个 节点 TXT ； 　 　 系统 具体 实现 中 ， 通过 链表 数据结构 读入 数据文件 ， 建立 组成 仿真 的 各 形体 的 实体模型 主要 步骤 包括 ： 　 　 由 读入 装配 文件 建立 各 形体 （ TXT ） 的 链表 ， 以及 形体 的 体素集 （ DXF ） 链表 ； 　 　 由 DXF 文件 提供 的 各体素 边界 顶点 坐标 和面 的 顶点 号 ， 建立 各体素 （ POLYLINE ） 链表 以及 它 的 顶点 （ VERTEX ） 链表 和面 （ FACE ） 链表 ； 　 　 再 由 遍历 面 链表 建立 边 （ EDGE ） 链表 ； 　 　 根据 形体 各体素 的 边 、 面 链表 ， 建立 形体 的 边 （ HEADEDGE ） 链 、 面 （ HEADFACE ） 链 。 　 结束语 　 　 总结 以上 论述 ， 将 本 图形 仿真 系统 三维 几何 模型 的 实现 过程 简单 归纳 就是 ： 根据 设计 结果 ， 利用 AutoCAD 建立 各 部件 的 三维 模型 ， 输出 DXF 文件 。 模型 的 建立 可 采用 交互式 ， 也 可 采用 参数 化 的 方法 ， 标准件 可 建立 图形库 。 由 仿真 系统 直接 调用 DXF 文件 ， 计算 各 部件 在 仿真 系统 中 的 插入 位置 ， 并 确定 仿真 装配 顺序 及 路径 ， 建立 装配 文件 。 在 实体模型 基础 上 ， 在 OpenGL 环境 中 建立 几何 模型 ， 实现 真实感图形 、 装配 动画 、 位置 调整 以及 其他 一些 观察 功能 （ 如 旋转 动画 、 各个 视图 、 放缩 等等 。 我们 所 介绍 的 这种 方法 ， 相信 会 对 其它 类似 系统 的 图形 建模 提供 借鉴 。 作者简介 ： 张予 川 　 博士 ， 副教授 。 主要 研究 方向 ： 机械 CAD 及 计算机 仿真技术 。 曾理湛 　 硕士 研究生 。 主要 研究 方向 ： 机械 CAD 及 计算机 图形学 。 王少梅 　 教授 ， 博士生 导师 。 主要 研究 方向 ： 起重机 CAD 及 计算机 仿真技术 。 作者 单位 ： 武汉 交通 科技 大学 港机 CADCAE 中心 　 湖北 武汉 （ 参考文献 ［ ］ 　 陈华斌 ， 等 利用 OpenGL 开发 视景 仿真 软件系统 北京 ： 微电脑 世界 ， ； （ ） ： － ［ ］ 　 王福军 AutoCADRR 应用 C 程序设计 － 机械 CAD 编程 方法 与 实例 北京 ： 电子 工业 出版社 ［ ］ 　 孔小斌 ， 章 　 萍 开发 基于 OpenGL 的 三维 图形 应用 北京 ： 计算机 世界 ， ； ［ ］ 　 徐建波 VisualC 中 三维 图形 与 动画 功能 库 OpenGL 的 使用 电脑 ， ； （ ） ： － 收稿 日期