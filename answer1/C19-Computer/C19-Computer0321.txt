计算机 应用 ComputerApplications 年 第卷 第期 VolNo 交换式 以太网 数据 采集 和 分析 软件 刘 　 莉 　 叶高英 　 　 摘 　 要 　 交换式 以太网 数据 采集 系统 以 交换式 、 高速 、 宽带 以太网 为 基础 CAMAC 系统 直接 与 网络接口 ， 避免 了 为 单个 计算机系统 重写 CAMAC 驱动程序 ， 保证 了 网络 上 CAMAC 系统 和 主机 之间 较 高 的 数据 传输率 。 利用 其中 的 数据 采集 和 分析 软件 ， 用户 不必 写 任何 代码 就 可以 建立 一个 完整 的 数据 采集 通道 ， 获取 并 处理 数据 。 　 　 关键词 　 DASCAMAC 交换式 以太网 　 　 目前 ， 在 聚变 领域 用于 实验 的 数据 采集 系统 DAS 几乎 都 是 分布式系统 。 这些 系统 ［ ］ 主要 由 计算机 和 瞬态 记录器 （ 通常 为 CAMAC 系统 ） 组成 ， CAMAC 系统 按 层次 原则 设计 并 分别 与 各 计算机 接口 连接 ， 各 计算机 连接 组成 局域网络 。 这样 的 系统结构 使 从 CAMAC 系统 传输数据 到 一台 计算机 成为 DAS 的 瓶颈 ； 驱动 CAMAC 系统 的 软件 依赖于 特定 的 计算机系统 。 由于 需要 为 新 的 计算机系统 重写 CAMAC 驱动程序 ， 系统升级 非常 困难 ； 分布式 分量 越 多 ， 合并 实验 数据 到 一个 统一 的 数据 记录 文件 就 越 困难 。 　 　 交换式 以太网 数据 采集 系统 （ TDAS ） ［ ］ 即 是 为 克服 这些 困难 而 研制 的 。 它 采用 以太网 CAMAC 控制器 ECCMK Ⅲ 作为 CAMAC 系统 与 网络 之间 的 接口 设备 ， 选用 网络 交换机 LinkSwitch 作为 以太网 连接 设备 ， 其 系统结构 如图所示 。 　 　 图 　 交换式 以太网 数据 采集 系统 　 　 这样 的 系统结构 较之 以往 的 分布式 数据 采集 系统 有 了 质 的 提高 ： 建立 了 高速 交换式 以太网 ， 保证 了 网络 上 CAMAC 系统 和 主机 之间 较 高 的 数据 传输率 ； CAMAC 机箱 直接 连 到 网络 上 ， 避免 了 麻烦 的 专用 CAMAC 计算机 接口 及 驱动 问题 ， 永久 地 消除 了 CAMAC 系统对 特定 的 计算机系统 的 依赖性 。 　 　 TDAS 的 数据 采集 和 分析 软件 以 模块 数据系统 MDS ［ ］ 为 基础 ， 结合 交换式 以太网 数据 采集 系统 的 新 特点 进行 了 某些 部分 的 重新 设计 和 修改 ， 主要 集中 在 标准 CAMAC 模块 的 驱动程序 、 关于 CAMAC 模块 操作 的 命令 等 。 该 软件系统 运行 在 VAXVMS 操作系统 中 ， 由 数据 采集 、 驱动 软件 、 绘图 、 数据管理 等 模块 组成 ， 很多 应用环境 作为 DCL （ DigitalCommandLanguage ） 命令 执行 ， 很象 VMS 操作系统 的 一部分 ， 非常容易 使用 ， 用户 不必 写 任何 代码 ， 就 可以 建立 一个 包括 数据 采集 、 分析 、 显示 的 完整 诊断 数据 采集 通道 。 下面 介绍 其中 主要 的 子系统 。 　 　 TDAS 数采 和 分析 软件系统 结构 　 　 TDAS 数采 和 分析 软件系统 结构 如图所示 。 其中 ， ESONEDOE 是 以太网 CAMAC 控制器 ECCMK Ⅲ 提供 的 CAMAC 子程序 ， 用于 访问 ECC 模块 ， 执行 管理 CAMAC 模块 的 操作 ； ， 而 CAMAC 模块 驱动程序 即 是 调用 ESONEDOE 子程序 对 CAMAC 模块 包括 CAMAC 硬件 模块 和 非 CAMAC 软件 模块 进行 初始化 、 存储 等 操作 ； CSV 环境 用于 模块 采集 频率 、 通道 名称 等 信息 的 设置 ， 供 初始化 、 存储模块 所用 ； scanner 负责 在 共享 程序 中 寻找 相应 的 模块 支持 子程序 ， 并 执行 相应 的 初始化 或 存储 动作 ； 所有 数据 的 存储 借用 MDS 提供 的 数据库 ； 利用 IDL 和 PCL 访问 、 分析 和 显示 MDS 数据库 中 的 数据 。 图 　 TDAS 的 数据 采集 和 分析 软件系统 结构 ． 　 模块 驱动 软件 　 　 TDAS 的 数据 采集 和 分析 软件系统 中 包括 CAMAC 硬件 模块 和 软件 模块 ， 驱动 它们 的 程序 都 由 三个 子程序 组成 ： “ 设置 ” 子程序 提供 显示 用户 交互 输入 采集 频率 、 通道 名称 等 信息 的 格式 ， 由 TDMS 格式 包 支持 ； “ 初始化 ” 子程序 ， 负责 解释 “ 设置 ” 子程序 中 记录 的 信息 ， 并 执行 合适 的 初始化 模块 的 功能 ； “ 存储 ” 子程序 ， 数字化 结束 后 从 模块 存储 中 取回 数据 。 　 　 CAMAC 模块 的 驱动 子程序 与 传统 的 分布式 数据 采集 系统 有 很大 不同 ， 在 TDAS 结构 中 ， CAMAC 机箱 通过 以太网 CAMAC 控制器 直接 与 网络 相连 ， 使得 驱动 CAMAC 模块 的 程序 与 计算机系统 无关 。 　 　 以 LCAMAC 模块 为例 ， 典型 的 驱动 子程序 结构 如图所示 。 用 FORTRAN 语言 编写 的 L 初始化 、 存储 、 设置 子程序 的 代码 加 起来 不足 条 语句 ， 相比 于 CAMAC 机箱 与 计算机系统 直接 相连 ， 驱动 CAMAC 模块 的 程序代码 要 短 得 多 。 况且 ， 无论 该 数据 采集 和 分析 软件系统 移植 到 什么样 的 计算机系统 ， 驱动 CAMAC 模块 的 程序代码 都 不必 重写 。 　 　 图 　 L 模块 驱动程序 ． 　 数据 采集 　 　 模块 逻辑 名 　 在 TDAS 的 数据 采集 和 分析 软件系统 中 ， 所有 模块 是 由 VMS 的 逻辑 名 表示 的 。 VMS 所 提供 的 逻辑 名 服务 把 一个 名字 与 CAMAC 模块 的 站 号 、 机箱 号 联系 起来 。 采用 这种 方法 可以 在 系统 中 分配 模块 到 任何 位置 ， 而 在 数据 采集 和 分析 软件系统 中 不必 修改 任何 模块 。 通过 一个 解码程序 翻译 模块 逻辑 名 得到 模块 位置 。 　 　 CSV 环境 　 所有 模块 的 信息 设置 都 在 CSV 应用环境 中 建立 。 在 CSV 环境 中 可以 建立 一个 新 的 扫描 表 ， 也 可以 对 已 存在 的 扫描 表 进行 增加 、 删除 、 修改 、 浏览 模块 的 操作 。 　 　 CSVSCAN 环境 　 当 发出 一个 CSVSCAN 命令 时 ， 扫描器 就 开始 工作 。 从 一个 初始化 过程 开始 ， 读 scan 表中 的 每个 记录 ， 以 用户 为表中 的 每个 入口 定义 的 “ init ” 时 序号 为 顺序 。 对表中 每个 记录 ， 调用 该 记录 中 模块 对应 的 “ init ” 子程序 ， 并 传递 设置 信息 到 “ init ” 子程序 。 当 初始化 过程 完成 后 ， 执行 存储 过程 ， 调用 “ store ” 子程序 。 重复 上述 过程 完成 多通道 大规模 采集 任务 。 ． 　 数据 存储 　 　 所有 采集 到 的 数据 都 存储 在 MDS 提供 的 数据库 中 ， 该 数据库 包括 数据库 定义 文件 、 放电 序号 确认 文件 和 数据文件 集合 。 数据库 定义 文件 中 含有 MDS 查找 或 产生 数据文件 的 导航 信息 。 一个 数据库 中 的 数据 由 三条 信息 确认 ： 放电 序号 、 数据项 名称 和 位于 数据库 哪 一级 。 　 　 在 本 系统 中 我们 定义 了 一个 名为 HLM 的 数据库 ， 所 采集 的 数据 都 存入 该 数据库 中 。 ． 　 数据分析 和 显示 　 　 TDAS 的 数据 采集 和 分析 软件系统 提供 一个 界面 给 两个 绘图 软件 ， IDL （ InteractiveDataLanguage ） 和 GP 。 MDS 提供 的 接口 软件 使 IDL 可 直接 进入 MDS 数据库 交互 地 操作 和 显示 数据 ， 在 大多数 情况 下 不必 写 数据分析 子程序 。 GP 是 一个 图形库 ， 可以 为 大量 的 绘图 设备 提供 有效 的 图形 输出 。 PCL （ PlotCommandLanguage ） 环境 即 是 使用 GP 为 图解 数据库 中 的 数据 提供 的 一个 简单 的 显示 工具 。 可用 的 绘图 设备 包括 VT 、 VT 、 VT 、 VT 、 TK 终端 等 。 ． 　 用户 可 调用 子程序 　 　 MDS 提供 一套 完整 的 可 调用 子程序 ， 允许 用户 通过 它们 访问 存储 在 MDS 数据库 中 的 任何 数据 。 所有 这些 子程序 遵从 VMS 子程序 调用 标准 ， 只要 坚持 该 标准 ， 用户 可用 任何 编程语言 书写 分析程序 。 　 意义 　 　 交换式 以太网 数据 采集 系统 成功 地 解决 了 大型 数据 采集 系统 中 CAMAC 与 计算机 耦合 连接 的 瓶颈 问题 ， 为 今后 采集器 与 计算机系统 之间 的 平衡 发展 铺平 了 道路 ， 给 未来 的 DAS 技术 创造 了 广阔 的 发展 空间 。 其 数据 采集 和 分析 软件系统 有 以下 特点 ： 用户 可以 通过 产生 包括 他 自己 的 模块 支持 子程序 的 更 多 的 共享 程序 增加 新 模块 到 该 数据 采集 和 分析 软件系统 中 ； 提供 一套 包括 数据 采集 、 分析 和 显示 的 完整 工具 ， 最大 限度 地 减少 了 用户 所要 做 的 工作 ； 许多 应用环境 作为 DCL 命令 执行 ， 很 象是 VMS 操作系统 的 一部分 ， 对于 已经 熟悉 VMS 操作系统 的 用户 来说 ， 可以 大大缩短 学习 周期 。 　 　 刘 　 莉 　 硕士 研究生 。 　 　 作者 单位 ： 刘 　 莉 　 叶高英 （ 核工业 西南 物理 研究院 　 四川 ． 成都 ） 参考文献 ［ ］ 　 MKortenBBecksRKleinTEXTORDiagnosticDataAcquisitionandProcessinginaDistributedSystemEnvironmentIEEETransNuclSciNS ［ ］ 　 LPaciosJGuaspJVegaAfullyprogrammabledataacquisitonsystemfortheTJ Ⅰ andTJIUdevicesRevSciInstr ［ ］ 　 NRSauthoffetalConceptualdesignofthephysicssupportportionoftheCITinstrumentationandcontrolsystemRevSciInstr ［ ］ 　 JAMurphyTRGibneyPLTdataacquisitonandanalysissystemRevSciInstr ［ ］ 　 PDVillersetalTheDataAcquisitionandmanagementsystemfortheTdeVTOKAMAKProcInternConfonFusionTech ［ ］ 　 GaoyingYeetalAPrototypeSwitchedEthernetDataAcquisitionSystemTobepublishedinFusionEngineeringandDesign ［ ］ 　 TwFredianJAStillermanMDSMIThighspeeddataacquisitionandanalysissoftwaresystemRevSciInstr 收稿 日期 修改稿