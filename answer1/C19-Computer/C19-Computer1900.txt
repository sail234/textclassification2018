微型机 与 应用 WEIXINGJIYUYINGYONG 　 Vol 　 No 　 P 用 PC机 直接 开发 单片机 系统 马正红 　 岳兴良 　 董小虎 　 郝宝钟 摘要 ： 一种 不 依赖于 仿真器 、 通过 PC机 串行口 直接 调试 目标 系统 的 单片机 自 开发方法 。 关键词 ： 直接 调试 自 编程 自举 可重 定位 PC机 　 　 贵刊 年 第期 登载 的 一篇 “ 用 PC机 直接 调试 单片机 系统 的 实现 ” 的 文章 很 有 新意 ， 拓宽 了 单片机 开发 的 思路 ， 但 仍 存在 少许 不足之处 ， 其 不足之处 有 ： 　 　 （ ） 要求 目标 系统 既要 有 外部 ROM 又 要 有 外部 RAM ， 不 适合 仅 有 外部 ROM 或仅 有 外部 RAM 的 系统 ； 　 　 （ ） 要求 使用 地址 浮动 技术 进行 目标 机 程序设计 ， 若 不 小心 ， 则 易 出错 ； 　 　 （ ） 不 适合 ROM 大 、 RAM 小 的 目标 系统 ， 因为 在 这种 情况 下 ， 系统 RAM 装不下 被 调试 的 代码 ； 　 　 （ ） 系统 不 具有 自 编程 功能 ， 仍 依赖 专用 开发 装置 ， 限制 了 其 应用 范围 。 　 　 本文 介绍 一种 新 的 方法 可 克服 以上 不足 ， 特别 是 无须 编程器 ， 目标 系统 自己 将 调试 成功 后 的 代码 固化 到 EPROM 中 ， 真正 摆脱 了 对 专用 开发 设备 的 依赖 ， 更加 具有 实用价值 。 设计 思路 　 　 本 方法 不 采用 EPROM 存放 监控 程序 ， 而是 将 监控 程序 放在 CPU 内 ， 即 采用 内含 ROM 的 、 、 C 、 C 等作 调试 用 CPU 。 这样 在 调试 期间 ， 系统 就 摆脱 了 对外部 ROM 的 依赖性 ， 目标 机 的 ROM 在 调试 期间 就 可以 用 相应 的 RAM 来 替代 ， 也 就 允许 目标 系统 是 一个 仅 有 外部 RAM 或仅 有 外部 ROM 的 系统 。 　 　 的 特点 是 ： 当 EA 脚接 高电平 时 ， 若 指令 指针 IP 未 超过 内含 ROM 容量 ， 指令 将 从片 内 取得 ； 当 EA 脚接 低电平 或 IP 值 已 超过 内含 ROM 容量 时 ， 指令 将 从 外部 ROM 中 取得 。 　 　 假若 开机 时 ， 使 系统 工作 于 EA 为 高电平 的 状态 ， 并 将 内含 的 监控 程序 搬移 至 外部 RAM 的 高端 ， 然后 转 高端 的 监控 程序执行 ， 待 其 已 转入 高端 监控 程序 后 ， 再 将 EA 脚置 低电平 ， 则 此时 的 系统 与 系统 没有 什么 差别 。 由于 监控 程序 在 高端 地址 ， 故 被 调试 的 程序 可 从 H 开始 放置 ， 但 这 要求 目标 系统 采用 合并 代码 、 数据 空间 模式 。 　 　 另外 ， 当 工作 在 内部 取指 状态 时 ， 其 P 、 P 口 是 标准 的 并行 端口 ， 因而 可 利用 这 二个 端口 向 与 之 相连 的 EPROM 发出 固化 时序 ， 并 通过 对 硬件 电路 作 少量 的 修改 ， 以 实现目标 系统 的 自我 固化 。 硬件 和 软件 ． 制作 开发 专用 CPU 　 　 选 一块 质量 较 好 的 C ， 将 设计 好 的 监控 程序 固化 在 内部 （ 此后 开发 类似 系统 不再 依赖 固化 设备 ） ， 并 将 CPU 的 EA 脚 扳起来 。 找个 小巧 的 单刀 双掷 开关 ， 开关 的 中间 脚用 短 导线 焊接 至 CPU 的 EA 脚 ， 开关 的 另二脚 分别 用 短 导线 焊接 至 CPU 的 电源 脚及 接地 脚 ， 用 环氧树脂 将 开关 及 导线 浇铸 在 CPU 的 背部 ， 使 之 成为 坚固 的 一体 ， 制备 好 的 CPU 就是 一个 功能强大 的 开发工具 。 ． 目标 系统 的 线路 设计 　 　 目标 系统 应 采用 合并 代码 、 数据 空间 模式 。 设计 时 ， 将 EPROM 当作 相同 容量 的 RAM 看待 ， 即 把 整个 系统 的 存储器 都 设计 成 既 可 存取数据 又 可 存取 指令 的 形式 。 因 程序 固化 时 ， EPROM 的 VPP 脚应接 固化 电压 ， 而 正常 工作 时 VPP 与 电源 相连 ， 设计 时 ， 可 在 VPP 与 VCC 间加 一 跳线 开关 JP 。 考虑 到 在 正常 工作 时 ， 锁 存器 的 G 脚 （ 或 CLK ） 应由 CPU 的 ALE 控制 ， 而 在 对 EPROM 编程 时 ， G 脚 就 不能 由 ALE 控制 ， 因为 ALE 上 电平 的 每个 指令 周期 都 在 跳变 ， 因而 无法 将 锁 得 的 编程 地址 长时间 保持 不变 。 设计 时 ， 可 将 G 与 AL E通 过 跳线 开关 JP 连接起来 ， G 与 P ． （ 或 其它 端口 ） 通过 跳线 开关 JP 连接起来 ， 如图所示 。 图 硬件 电路 的 存储 线路 示例 　 　 以上 做法 的 目的 是 ： 在 调试 期间 ， 开发者 可 在 ROM 座 上 插入 相同 容量 的 RAM ， 将 JP 短接 ， JP 断开 ， 就 可 将 代码 装载 到 它 自身 的 地址 空间 被 调试 ； 在 固化 阶段 将 JP 、 JP 断开 ， JP 短接 ， RAM 换成 EPROM ， 在 JP 的 靠 VPP 一侧 的 桩 上 加上 固化 电压 ， 让 CPU 中 的 监控 程序 模拟 EPROM 的 固化 时序 即可 实现 对 目标 系统 的 自 编程 。 当 目标 系统 研制成功 后 ， 将 JP 断开 ， JP 、 JP 短接 即可 投入 实际 运行 。 　 　 对 目标 系统 的 串行 通信 口 的 处理 与 本刊 年 第期 介绍 的 方法 相似 ， 但 可 把 电平 转换 电路 做 在 通信 电缆 上 ， 转换 电路 需要 的 ＋ V 电压 ， 可 从 接 插口 取得 ， 即 通信 接 插口 应多 加针 ， 并 使 之 与 ＋ V 电源 相连 。 这样 ， 目标 系统 就 不必 增加 多余 电路 。 ． 监控 程序 　 　 单片机 监控 程序 如图所示 ， 包括 自 举 程序 及 监控 程序 主体 。 监控 程序 主体 中 的 调试 控制 部分 可 烧录 在 CPU 片内 ， 也 可 在 调试 时 动态 地 从 微机 中 装入 ， 动态 装载 有利于 监控 程序 的 随时 改进 与 升级 。 监控 程序 中 的 EPROM 固化 程序 必须 在 CPU 片内取 指 执行 ， 以 保证 P 、 P 口 输出 数据 的 稳定性 。 因 线路 及 整个 系统 存储 结构 的 变更 ， 固化 程序 不宜 使用 外部 RAM ， 而应 使用 内部 RAM 用作 数据 缓冲区 ， 但 内部 RAM 容量 较 小 ， 容不下 所有 应 被 固化 的 代码 ， 故应 分段 固化 ， 即 ： PC 将 欲 固化 的 代码 分成 包 ， 每次 向 单片机 传送 个 固化 数据包 。 包 结构 为 ： 固化 起址 、 代码 长度 、 代码 数据 块 。 图 单片机 部分 监控 程序 流程图 开发 过程 　 　 （ ） 设计 制作 目标 系统 的 软硬件 。 　 　 （ ） 将 制备 好 的 专用 CPU 插入 CPU 座 ， 将 CPU 背部 开关 扳至 电源 端 ， 在 ROM 座 上 插入 相同 容量 RAM ， JP 短接 ， JP 断开 。 　 　 （ ） 开机 复位 ， 此时 CPU 片内 程序 开始 进行 系统 自 举 ， 待 自举 完成 后 （ 时间 一般 很 短 ） ， 将 CPU 背部 开关 扳至 接地 端 ， 这样 ， 当 CPU 执行 低 地址 指令 时 ， 执行 的 将 是 目标 系统 的 程序 而 不是 监控 程序 。 　 　 （ ） 利用 微机 与 单片机 通信 实现目标 机 代码 装载 及 调试 ， 在 调试 过程 中若 出现 死机 ， 重新 复位 时 按 步骤 进行 。 　 　 （ ） 代码 调试 成功 后 ， 将 系统 断电 ， 在 ROM 座 上 插 上 EPROM ， 将 JP 、 JP 断开 ， JP 短接 ， 找 一 电源 ， 将 其调 至 EPROM 所 需 的 编程 电压 ， 关掉 该 电源 ， 将 正极 接至 JP 的 靠 VPP 一端 的 桩 上 ， 负极 接 系统地 。 　 　 （ ） 将 CPU 背部 开关 扳至 电源 侧 ， 开机 复位 ， 与 步骤 不同 ， 此时 不要 将 CPU 背部 开关 扳至 接地 侧 ， 因为 固化 程序 要 执行 CPU 片内 代码 。 　 　 （ ） 打开 固化 电源 ， 从 微机 向 系统 发 固化 命令 。 此时 ， 系统 将 从 微机 中逐段 取得 代码 并 将 其 固化 在 EPROM 中 。 　 　 （ ） 将 系统 断电 ， 拔出 开发 专用 CPU ， 插入 普通 CPU ， 将 JP 、 JP 短接 ， JP 断开 ， 目标 机即 研制成功 。 　 　 用本 方法 开发 应用 系统 ， 允许 目标 系统 只有 外部 RAM 或 只有 外部 ROM ， 调试 期间 代码 的 执行 环境 与 开发 成功 后 的 实际 运行 环境 是 一样 的 ， 由于 代码 在 其 自身 的 空间 存放 ， 因而 不会 出现 因 RAM 装不下 代码 而 无法 调试 的 情况 。 同时 ， 由于 系统 具有 自我 固化 的 能力 ， 使 其 真正 摆脱 了 对 专用 开发工具 的 依赖 ， 不但 能 被 专业 开发者 使用 ， 也 为 业余 开发者 提供 了 一个 方便 途径 。 马正红 （ 总装备部 四川 绵阳 中专 校 第一 教研室 ） 岳兴良 （ 总装备部 四川 绵阳 中专 校 第一 教研室 ） 董小虎 （ 总装备部 四川 绵阳 中专 校 第一 教研室 ） 郝宝钟 （ 总装备部 四川 绵阳 中专 校 第一 教研室 ） 参考文献 ［ ］ 王爱民 ， 潘建寿 ， 康雪艳 ， 李晓群 ． 用 PC机 直接 调试 单片机 系统 的 实现 ． 微型机 与 应用 ， ； 收稿 日期 ： － －