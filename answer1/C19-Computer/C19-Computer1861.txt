微型机 与 应用 MICROCOMPUTERITSAPPLICATIONSVolNoP 图文 电视 中 大容量 数字 存储器 的 设计 邓庆林 　 高平 　 李晓飞 　 　 摘 　 要 ： 图文 电视 的 基本概念 、 图文 电视 中 接收端 的 大容量 数字 存储器 设计 的 基本 思想 和 个 FPGA 功能模块 的 具体 实现 。 关键词 ： 图文 电视 字符 显示 DRAM 存储器 　 　 图文 电视 是 将 各类 图形 和 文字 信息 以 数字信号 形式 叠加 在 广播电视 信号 场 消隐 期 （ 场逆程 ） 的 若干 行上 是 与 正常 的 广播电视 信号 一起 播出 的 一种 新型 的 数据 广播系统 。 使 图文 电视 进入 信息产业 具有 投资 小 、 成本低 、 便于 功能 扩展 、 传输速度 快 等 特点 。 图文 电视 及 数据 广播 可以 为 各行各业 如 行政 管理 、 金融 、 商务 、 交通 、 个人 购物 提供 有效 服务 。 　 　 图文 电视 系统 的 基本 结构 由 发送 端 、 接收端 及 传送 通道 部分 组成 。 发送 端 由 图文 电视节目 制作 和 播出 系统 组成 。 节目 制作 设备 是 由 节目 制作 计算机 构成 的 。 其 功能 是 将 来自 四面八方 的 信息 或 信息源 数据库 的 信息 进行 编辑 制作 成 符合中国 图文 电视 （ CCST ） 规范 的 图文 电视 页 并 能 进行 修改 、 更新 、 删除 和 页 文件 整理 。 播出 系统 由 装有 播出 卡 的 播出 计算机 和 数据 桥 组成 。 播出 计算机 可 与 节目 制作 计算机 共用 其 功能 是 将 编辑 好 的 图文 电视 页 按序 变成 图文 电视 数据 行 。 数据 桥则 将 数据 行 叠加 到场 消隐 期中 指定 的 行上 与 电视信号 一起 送到 发射机 发送 出去 。 数据 桥 也 可 将 图文 电视 数据 行从个 频道 的 电视信号 中 取出 插入 到 其它 频道 的 电视信号 上 。 接收端 为 装有 图文 电视 解码器 的 电视 接收机 或 由 电视 接收机 和 外装型 图文 电视 解码器 组成 的 接收 终端 。 用户 通过 电视 遥控器 上 的 TVTT （ 电视 图文 电视 ） 键 可以 选看 广播电视 或 图文 电视 。 若选 图文 电视 再 按 INDEX 键则 可 在 屏幕 上 得到 循环 播出 的 节目单 与其 相应 的 页 号 。 按所要 选页 的 页 号 后 图文 电视 解码器 则 将 该页 的 数据 取出 进行 视频 处理 最后 显示 在 电视屏幕 上 。 另外 图文 电视 解码器 还 可 将 所 接收 的 页 通过 并口 打印 出来 。 由于 图文 电视信号 是 搭载 在 电视信号 上 传输 的 其 传输 通道 就是 广播电视 通道 它 可以 是 无线电视 广播网 、 CATV 网 、 卫星 电视网 等 。 　 　 本 课题 是 图文 电视 的 个子 项目 即 设计图 文 电视 中 的 大容量 数字 存储器 。 本文 将 详细 介绍 接收端 的 大容量 数字 存储器 的 基本 设计 思想 其中 包括 单片机 控制系统 和 FPGA 功能模块 的 具体 实现 。 系统 框图 如图所示 。 图 系统 框图 系统 框图 　 　 该 系统 分为 几个 部分 首先 是 串行 通信 然后 是 对 大 缓存 的 写入 最后 是 根据 缓存 的 内容 在 显示器 上 显示 出来 并 能 按 红外 遥控器 的 红外信号 给出 正确 的 操作 。 其中 单片机 负责 将 微机 串口 送出 的 图文 信息 写入 图中 的 DRAM 数字 存储器 。 DRAM 控制 模块 完成 DRAM 的 读写 和 刷新 。 字符 显示 模块 较为 复杂 完成 DRAM 信息 在 电视 接收机 上 的 显示 。 它 包括 基本 计数 电路 、 点 计数 电路 、 水平 垂直 地址 计数 电路 、 光栅 地址 计数 电路 、 并串 转换 电路 计数 电路 等 。 个 模块 都 采用 ALTERA 公司 的 FPGA 器件 设计 而成 。 这里 使用 EPMJC 系列 的 芯片 。 　 　 下面 将 介绍 RAM 控制 模块 和 字符 显示 模块 的 具体 实现 。 DRAM 控制电路 设计 　 　 本 设计 使用 的 存储芯片 为 韩国 LGS 公司 的 GMCCJ 它 是 一种 μ sCMOS 高速 动态 RAM 其 编制 为 （ 即 MB ） 个位 字 并 采用 CMOS 硅 门阵列 技术 组装 。 该 芯片 仅 需根 地址 线行 地址 和 列 地址 的 输入 是 多路复用 的 三态 数据 输出 个 周期 刷新 刷新周期 为 ms 。 该 内存条 上 共有 片 GMCCJ 构成 位 宽 分成 个 位区 由 CAS ～ CAS 和 RAS 、 RAS 组合 选择 此个 区 。 具体 组合 为 RAS 与 CAS 、 RAS 与 CAS 、 RAS 与 CAS 、 RAS 与 CAS 。 注意 由于 本 设计 的 DRAM 容量 为 MB 所以 用 不到 RAS 和 RAS 且 该 内存条 也 无 奇偶校验 位 。 该 DRAM 存储器 既 作为 输入 数据 的 缓存 （ 存储 的 是 电视 显示屏 数据 ） 又 作为 视频 显示 的 VRAM 。 　 　 DRAM 控制电路 如图所示 。 该 模块 电路 包括 DRAM 的 行列 地址 生成 和 刷新 电路 。 关键在于 行列 地址 生成 电路 要 使 输入 数据 在 DRAM 中 顺序存储 因此 要 连续 产生 MB 的 地址 信号 。 在 DRAM 刷新 电路 周期 内 不 允许 对 DRAM 进行 读写 。 图 DRAM 控制电路 框图 DRAM 行列 地址 生成 电路 　 　 将 单片机 输出 的 WR 和 RD 相 “ 与 ” 后 作为 DRAM 行选 通信 号 RAS 此时 SEL 信号 为 所以 多路 选择器 × MUX （ ） 选择 通过 的 是 低位 地址 （ A ～ A ） 即 行 地址 由 RAS 信号 的 下降 沿锁 存入 DRAM 。 SEL 信号 由 RAS 延迟 个 CLK 时钟 周期 （ CLK 为 系统 时钟 MHz ） 得到 使得 行 地址 被 锁 存后 经过 个 系统 时钟 周期 SEL 变为 × MUX （ ） 选择 通过 高位 地址 即列 地址 再 将 SEL 信号 延迟 个 系统 时钟 周期 产生 列 地址 选 通信 号 CAS 目的 是 确保 列 地址 稳定 后 才 由 CAS 下降 沿锁 存入 DRAM 。 　 　 上面 产生 的 位 地址 用于 寻址 MB 地址 空间 。 实际 使用 的 内存条 其实 由个 同样 MB 存储空间 组成 即个 位区 。 如前所述 通过 CAS ～ CAS 和 RAS 、 RAS 的 不同 组合 选择 不同 的 位区 可 通过 最高 位 地址 （ A 、 A ） 译码 CAS ～ CAS 和 RAS 、 RAS 但须 RAS 、 CAS 等 信号 配合 。 DRAM 刷新 电路 　 　 DRAM 的 刷新 方式 分为 集中 刷新 、 分散 刷新 和 透明 刷新 。 在 本 设计 中 采用 第种 刷新 方式 即当 刷新 时 CAS 保持 位高 由 RAS 的 下降 沿 DRAM 中 CMOS 硅 门阵列 的 一 整行 共个 单元 同时 进行 刷新 共 刷新 行只 需 给出 相应 行 地址 并 在 确保 行 地址 稳定 后令 RAS 产生 下降 沿 即可 。 　 　 × MUX （ ） 是 用于 选择 刷新 地址 的 在 刷新周期 内 不 允许 对 DRAM 进行 读写 。 因此 REF 表示 执行 刷新 操作 选择 刷新 行 地址 计数器 地址 REF ［ ］ 通过 REF 表示 正常 读写操作 选择 行列 地址 通过 。 字符 显示 控制电路 　 　 字符 显示 控制电路 如图所示 。 在 电视 接收机 上 显示字符 只要 对 扫描 电子束 简单 地 进行 “ 开 ” 或 “ 关 ” 就 可以 用 点阵 在 屏幕 上 组成 字符 （ 这里 不 考虑 彩色 信号 ） 。 通常 把 有效 的 显示 屏幕 划分 成 许多 方块 每个 方块 被 称为 字符 窗口 要 显示 的 字符 就 位于 字符 窗口 中 。 在 本 设计 中 使用 电视 扫描 帧 中 的 一场 列 × 行 。 同时 所 要 显示 的 字符 的 代码 是 存放 在 DRAM 中 此时 DRAM 充当 VRAM 。 为了 保证 MB 内存条 直接 用作 VRAM 服务器端 发送 过来 的 信息 均 是 按 所 规定 的 电视 显示 格式 处理 的 、 以屏 为 单位 的 数据 这样 将 许多 工作 交由 服务器软件 完成 之后 便 大大 节约 了 接收端 的 硬件资源 。 在 VRAM 中 存放 的 是 汉字 字符 点阵 信息 在 字符 发生器 中 的 地址码 它 只是 记住 显示 屏幕 的 某个 字符 窗口 中要 显示 哪个 字符 而 字符 的 形状 （ 即 字型 ） 则 由 字符 发生器 产生 。 本 设计 中 字符 发生器 （ ROM ） 是 自己 烧录 的 烧入 的 是 取自 UCDOS 的 × 点阵 汉字 字库 GB 总 容量 约 为 KB 字符 窗口 大小 定为 × （ 象素 ） 这样 就 可以 保证 相邻 行列 间 的 字符 有 一定 间隔 。 图 字符 显示 控制电路 框图 　 　 ROM 的 高位 地址 是 来源于 VRAM 中 的 地址 代码 。 即 地址码 作为 字符 发生器 中 这个 字形 点阵 字节 的 高位 地址 用来 指向 这个 字形 点阵 的 首 字节 （ 相当于 基 地址 ） 而 ROM 的 低位 地址 则 来自 称为 光栅 地址 计数器 （ 或排 地址 计数器 ） 的 输出 它 具体 指向 这个 字形 点阵 中 的 某个 字节 （ 相当于 偏移量 ） 。 　 　 为了 在 电视机 上 显示 必须 按照 电视信号 规范 设计 电路 。 PAL 制 电视信号 水平 扫描 周期 为 μ s 分 奇偶 场 每 帧 场共行 。 基本 计数 电路 包含 个 计数器 分别 完成 行 μ s 计数 和 帧 行 计数 。 在 后面 的 具体 设计 中 就 以 这个 计数器 作为 框架 为 以后 各 模块 提供 时钟 。 利用 其计 数值 作为 约束条件 使用 ALTERA 提供 的 几种 编辑器 即 可以 设计所 需要 的 各种 信号 。 　 　 水平 地址 和 垂直 地址 计数器 是 用来 跟踪 电子束 扫描 在 水平 方向 和 垂直 方向 的 窗口 位置 而 光栅 地址 计数器 则 用来 跟踪 电子束 在 窗口 的 哪一条 光栅 线上 。 把 水平 地址 和 垂直 地址 计数器 的 输出 用作 访问 VRAM 的 地址 可以 读取 与 电子束 所在 窗口 相对 应 的 VRAM 单元 中 的 字符 地址码 。 把 该 地址码 用作 访问 ROM 字符 发生器 的 高位 地址 即可 读取 该 字符 代码 的 字形 。 因为 光栅 地址 计数器 是 用来 跟踪 电子束 在 窗口 的 光栅 线 位置 所以 用 光栅 地址 计数器 的 输出 作为 访问 ROM 字符 发生器 的 低位 地址 可以 读取 与 所在 光栅 线 相对 应 的 字形 字节 。 　 　 对应 于 屏幕 上 的 每个 字符 窗口 当 扫描 电子束 即将 进入 时 水平 地址 计数器 和 垂直 地址 计数 电路 输出 地址 到 VRAM 中 取出 与 这个 字符 窗口 相对 应 的 存储单元 中 的 字符 代码 将 其 作为 字符 发生器 的 高位 地址 送往 ROM 按照 光栅 地址 计数器 给出 的 光栅 线数 （ 作为 ROM 的 低位 地址 ） 把 字形 点阵 中 与 字符 窗口 内 的 光栅 线 相对 应 的 排点 从 ROM 中 取出 加载 到 移位 寄存器 中 。 移位 寄存器 在 点 时钟 的 控制 下 移位 把 由 ROM 送来 的 排点 进行 并串 转换 在 字符 窗口 相应 的 光栅 线 位置 上 加以 显示 。 由 水平 地址 计数器 跟踪 的 行 所有 个字符 依次 从 VRAM 中 取出 时 只能 显示 行 所有 个字符 的 排 此后 水平 地址 计数器 仍 继续 计数 留出 规定 宽度 的 消隐 区域 并 在 此 区域 中 产生 水平 同步 信号 。 待 电子束 扫描 到 下条 光栅 线 的 开始 位置 时 水平 地址 计数器 又 重复 计数 再 依次 从 VRAM 中 读取 这行 的 所有 个字符 把 这 所有 个字符 的 下 排点 显示 出来 。 这样 对 × 的 字形 点阵 从 VRAM 中 重复 取出 个字符 的 过程 要 一直 进行 次 才 能够 把 这行 字形 的 排点 全部 显示 出来 。 此后 光栅 地址 计数器 仍 继续 计数 但 不再 显示 要 留出 条 光栅 线 的 行间距 再 向 垂直 地址 计数器 进位 显示 下行 字符 。 同样 垂直 地址 计数器 在 垂直 方向 对 显示字符 的 行数 和 消隐 区 所 占 的 行数 进行 控制 并 在 规定 的 位置 上 产生 垂直 同步 信号 。 垂直 地址 计数 每 循环 计数 次幅 画面 就 扫描 完 了 。 显示 的 定时 控制电路 就是 这样 以 固定 的 速率 对 显示 屏幕 不断 地 进行 扫描 从而 对 屏幕 进行 刷新 。 由于 电视机 屏幕 上 的 荧光 材料 在 被 电子 轰击 之后 发光 的 时间 很 短 所以 只有 连续不断 地 进行 屏幕 刷新 才能 保持稳定 而 不 消失 的 图像 。 　 　 本 设计 定义 字符 窗口 宽个 象素 点频 为 系统 时钟 CLK 的 。 × H 以 计数 范围 ～ H 设计 的 点 计数 电路 实现 VRAM 中取 所 需要 显示 的 汉字 在 字符 发生器 （ ROM ） 中 的 地址码 再 由 该 地址码 去 ROM 中取 其 点阵 信息 并锁存 最后 将 点阵 信息 置位 给 移位 寄存器 。 其中 LATCHADD 和 LATCHADD 信号 分别 用于 锁存 （ 上升 沿 有效 ） 地址码 的 低位 和 高位 。 在 LATCHADD 上升 沿后 汉字 在 字符 发生器 中 的 基 地址 就 准备就绪 了 。 此时 字符 发生器 选 通信 号 CEROM 为 低电平 使 字符 发生器 输出 相应 的 点阵 信息 （ 由基 地址 和 光栅 地址 计数器 给出 的 地址 偏移量 决定 ） 。 因为 使用 × 汉字 点阵 汉字 的 线 需要 B 而 字符 发生器 数据 输出 线 只有 根 所以 必须 分 次 读出 。 ROMADDSEL 作为 字符 发生器 地址 的 最低 位 它 首先 为 低电平 选择 低位 点阵 信息 用 第个 CEROM 低电平 输出 并用 LATCHDOT 锁存 然后 ROMADDSEL 信号 变为 高电平 选择 高位 点阵 信息 用 第个 CEROM 低电平 输出 并用 LATCHDOT 锁存 。 这样 B 点阵 信息 便 全部 准备 好 了 接着 由 SL 信号 将 它们 置入 移位 寄存器 。 这 以后 ADDCK 信号 再次出现 上升 沿 开始 对下 个字符 窗口 进行 操作 。 　 　 并串 转换 电路 由 片锁 存器 构成 用于 在 LATCHDOT 和 LATCHDOT 信号 控制 下锁存 字符 发生器 送来 的 汉字 点阵 信息 。 每次 锁 存位 、 B 对应 字符 显示 窗口 中 某线 的 个 点 。 锁存 后 的 数据 置入 移位 寄存器 并 在 点 时钟 （ 系统 时钟 CLK 四分 频 得到 ） 控制 下 串行 输出 。 设计 规定 汉字 点阵 信息 为 “ ” 代表 前景 规定 其 色彩 为 RGB 为 “ ” 代表 背景 规定 其 色彩 为 RGB 。 　 　 在 本 设计 中 作者 根据 各 模块 的 特点 综合 使用 了 这 几种 设计 方法 基本 计数 电路 是 用 图形 和 文本 （ AHDL 语言 ） 设计 方法 设计 的 。 点 计数 电路 采用 文本 （ AHDL 语言 ） 设计 方法 。 其它 模块 则 用 图形 设计 方法 设计 。 功能 演示 　 　 编写 好 单片机 程序 先 在 MB 内存条 中以 AH 开始 的 （ H ） 个 内存 单元 （ 指位 宽 ） 中 写入 汉字 “ 串 ” 在 字符 发生器 中 的 地址 代码 （ 基 地址 ） “ EE ” H 紧接着 在 从 BH 开始 的 和 内存 单元 写入 汉字 “ 鼻 ” 的 地址 代码 “ CC ” H （ 由于 单片机 只有 位 宽 所以 必须 分别 对 低位 区 和 高位 区 进行 操作 ） 。 然后 给 FPGA 送去 屏首 地址 AH 在 将 对 DRAM 的 控制权 交给 FPGA 后 （ CLRP 表示 将 DRAM 控制权 交给 FPGASETBP 表示 将 控制权 交给 单片机 ） 此时 屏幕 显示屏 “ 串 ” 字 查询 等待 遥控器 信号 。 当有 信号 时 （ 单片机 P 脚为 高电平 ） 控制权 重 交回 单片机 置 屏首 地址 为 B 再 将 控制权 交给 FPGA 在 屏幕 上 显示屏 “ 鼻 ” 延迟 一段时间 后 会 自动 跳回 显示 “ 串 ” 再次 查询 等待 遥控器 信号 。 　 　 本 设计 能够 在 电视 接收机 上 显示 发送 端 传来 的 文字 信息 。 需 进一步 研究 和 改进 的 地方 是 增加 彩色 信号 以便 效果 更加 逼真 。 邓庆林 （ 南京 邮电学院 信息工程 系 ） 高平 （ 南京 邮电学院 信息工程 系 ） 李晓飞 （ 南京 邮电学院 信息工程 系 ） 收稿 日期 ：