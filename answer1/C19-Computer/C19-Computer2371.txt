计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 第卷 第期 VolNo 路由 芯片 中 的 微 流水 设计 章 永兴 摘 　 要 　 微 流水 技术 是 异步 电路 中 实现 流水线 设计 的 有效 方法 ， 而 路由 芯片 是 高速通信 网络 中 的 重要 硬件 部件 文中 首先 介绍 了 微 流水 设计 的 基本 结构 和 控制 ， 然后 介绍 了 采用 蛀洞 机制 的 路由 芯片 的 工作 机理 ， 并 给出 了 利用微 流水 实现 ASIC 路由 芯片 的 具体 应用 ， 该 芯片 达到 了 简单 、 高效 、 可靠 的 设计 目标 ， 文中 的 最后 还 给出 了 在 较 复杂 的 电路系统 中 实现 微 流水 所 需要 进一步 研究 的 问题 关键词 　 异步 电路 微 流水 ， 路由 芯片 ， 蛀洞 机制 ， Verilog 硬件 描述语言 中图法 分类号 　 TPTHEDESIGNOFMICROPIPELINESINROUTERCHIPZHANGYongXingNationalResearchCenterforIntelligentComputingSystemInstituteofComputingTechnologyChineseAcademyofSciencesBeijingAbstract 　 MicropipelineisanefficientwayforpipelinedesigninanasynchronouscircuitandrouterchipisthekeytechnologyinhighspeedcommunicationnetworksInthepaperherethebasicstructureandcontrolofmicropipelineareintroducedandthentheapplicationinASICrouterchipwithmicropipelineisgivenTherouterchipachievesthegoalofsimplicityefficiencyandreliabilityFinallysomeissuestoberesearchedfurtherinmoreacomplexcircuitsystemarepointedoutKeywords 　 asynchronouscircuitmicropipelinesrouterchipwormholeroutingVerilogHDL 　 引言 　 　 异步 电路设计 一直 是 人们 热衷 研究 的 一个 领域 ， 异步 电路设计 不 需要 全局 统一 的 时钟 驱动 而是 采用 某种 握手 协议 来 保证 操作 的 正确性 与 同步 电路设计 相比 采用 异步 设计 具有 硬件 系统 容易 组织 构造 、 降低功耗 、 稳定性 好 和 电路 升级 方便 等 好处 目前 ， 异步 电路设计 已有 很多 理论 和 方法 ， 包括 Huffman 电路 、 burstmode 、 微 流水 、 INet 和 STG 图 等 ［ ］ 其中 微 流水 设计 是 基于 事件驱动 的 可 伸缩 的 流水线 设计 方法 ， 是 由 IvanSutherland 首先 提出 的 ， 它 是 在 异步 电路 中 进行 流水线 设计 的 有效 方法 ［ ］ 在 MPP 大规模 并行处理 机和 机群系统 中 ， 高速通信 网络 是 关键技术 之一 ， 而 路由 芯片 是 高速通信 网络 的 重要 硬件 部件 在 文中 的 路由 芯片 设计 中 ， 采用 了 微 流水 技术 ， 达到 了 简单 、 高效 、 可靠 的 设计 目标 　 微 流水 设计 的 结构 及 控制 　 　 微 流水 在结构上 由 数据通路 和 控制电路 两 部分 组成 如果 数据通路 不 进行 任何 数据处理 也 就是 一个 简单 的 FIFO 结构 如图所示 ， REG 是 流水线 的 数据 存储单元 ， 以级 为例 ， 它们 构成 了 微 流水 的 数据通路 ； MullerC 器件 和 延时 单元 构成 了 微 流水 的 控制电路 部分 ， MullerC 器件 用 与 门 并且 在 其中 标 上 字母 C 来 表示 ， 其 功能 是 当 两个 输入 端的 逻辑值 相同 时 ， 输出 端 保持 不变 ； 当 两个 输入 端的 逻辑值 相反 时 ， 将 左边 的 输入 信号 值 输出 作为 数据 存储单元 的 REG 有 两个 输入 的 事件 控制 端 ， C （ capture 和 Ppass 两个 输出 的 事件 控制 端 ， Cdcapturedone 和 Pdpassdone ［ ］ 图 　 微 流水 的 基本 结构 示意图 数据 传送 操作过程 如下 前 两级 为例 　 　 RinA ， 有 请求 但 还 没有 应答 发 captureREG ； 　 　 REG 锁存 数据 发 Cd ； 　 　 Ain 向上 一级 发 应答 且 R 往下 一级 发 请求 ； 　 　 RA ， 发 captureREG 同时 发 passREG ； 　 　 REG 锁存 数据 Cd ， 这时 REG 传送数据 完成 发 Pd ； 　 　 A 表示 可 接收 下 一个 数据 ， 如果 Rin 则 C 仍 保持 为 如果 Rin 则 C 　 微 流水 设计 的 应用 　 　 在 本文 的 ASIC 路由 芯片 设计 中 ， 采用 了 蛀洞 机制 wormholerouting 即当 含有 寻径 信息 的 头 节片 进入 路由器 后 ， 路由器 根据 寻径 信息 决定 输出 通道 如果 选择 的 通道 空闲 ， 头 节片 就 沿该 通道 穿 出 通道 ， 该 通道 就 由 消息 包所 占用 ， 随后 的 节片 沿此 通道 向前 传输 ， 直到 遇到 尾 节片 再 释放 通道 ； 如果 选择 的 通道 忙 ， 头 节片 就 地 阻塞 在 该 路由器 的 节片 缓冲区 ， 后续 的 节片 依次 停留 在 相应 路由器 的 缓冲区 内 ［ ］ 　 　 路由 芯片 的 结构 由 X 层 和 Y 层 构成 ， 这 两层 的 设计 完全相同 ， 每 一层 又 有 个 输入 通道 和 个 输出 通道 ， 从 输入 到 输出 通道 上 都 有级 Buffer 缓冲 在 前级 Buffer 之间 主要 是 完成 对头 节片 进行 判零 、 地址 修改 、 路由 选择 和 剥 零 等 操作 第到 第级 Buffer 之间 是 进行 数据 选通 操作 见图 我们 根据 路由 芯片 结构 上 的 特点 ， 并 加上 流量 控制 ， 将 图 中 的 MullerC 器件 及 有关 的 控制 部分 设计 成 一个 ACE 异步控制 单元 ， 每 一级 Buffer 都 有 一个 相应 的 ACE 异步控制 单元 进行 异步 传输 时序 的 控制 图 　 路由 芯片 中 输入输出 通道 结构 示意图 　 数据 传送 协议 　 　 只要 上 一级 有 请求 ， 本级 立即 给 应答 ； 　 　 先 应答 上 一级 的 请求 ， 再 给 下 一级 发 请求 ； 　 　 下 一级 应答 不 结束 ， 本级 不能 再发 请求 ， 即 被 阻塞 ； 　 　 当 阻塞 解除 后 ， 本级 自动 向下 一级 发 请求 　 ACE 单元 的 逻辑 及时 序 　 　 ACE 单元 信号 之间 的 逻辑关系 表达式 如下 ： 　 　 AoutRinAout × ～ Rout × Ain 　 　 Rout ～ AinRout × Aout 　 　 CLK ＝ Rin 　 ACE 单元 控制数据 传递 的 基本操作 过程 　 　 如图所示 ， 信号 均 为 高电平 有效 图 　 典型 的 ACE 信号 时序 　 　 ① RinACE 收到 上 一级 的 请求 ； 　 　 ② Aout ， 向上 一级 发 应答 ； 　 　 ③ 若 Ain ＝ ， 则 Rout ， 向下 一级 发 请求 ； 若 Ain ， 则 Rout 保持 ； 　 　 ④ Rin ， 输入 请求 结束 ； 　 　 ⑤ 若 Ain ＝ ， 即 ACE 还 没有 收到 应答 ， 则 Aout 仍 保持 ； 若 Ain ＝ ， 即 ACE 收到 了 应答 ， 则 Aout ， 对 上 一级 的 应答 结束 ， 准备 接收 下 一次 请求 ， 转 步骤 ① 　 　 ⑥ Rout ， 向下 一级 输出 请求 结束 ， 可以 准备 发 下 一次 请求 ， 当 收到 请求 并发 应答 后 ， 转 步骤 ③ 　 ACE 单元 中 的 异步 状态 流程图 　 　 由 Rin ， Ain ， Rout 和 Aout 个 信号 的 不同 取值 构成 ACE 的 一个 异步 状态 ， 状态 流程图 如图所示 图 　 异步 状态 流程图 　 芯片 的 实现 　 　 文中 的 路由 芯片 是 采用 半 定制 门阵列 gatearray 来 实现 的 ， 并 采用 Verilog 硬件 描述语言 进行 行为 级 和 门级 的 描述 ， 设计 流程 见图 芯片 的 测试 结果表明 路由 芯片 的 功能 和 性能 都 达到 了 设计 上 要求 ， 单通道 的 传输 带宽 达到 MBs （ 数据 宽度 是 位 ） 图 　 ASIC 路由 芯片 设计 流程 　 结论 　 　 在 路由 芯片 的 设计 过程 中 ， 感到 微 流水 技术 可较 容易 地 将 同步 电路 中 的 流水线结构 挪用 到 异步 电路设计 中 只 需 将 各级 Buffer 锁存 的 时钟 部分 换成 微 流水 的 控制电路 另外 ， 通过 对 请求 应答 的 流量 控制协议 来 克服 Boundeddelay 中 的 additiveskew 问题 从 芯片 的 仿真 和 测试 结果 来看 ， 对 异步 流水 的 控制 也 是 可靠 有效 的 ， 由于 在 数据通路 上要 进行 某种 操作 因此 仍要 在 请求 线上 加上 延时 器件 且 要 考虑 Worstcase 的 影响 在 今后 的 路由 芯片 设计 中 ， 如何 在 较 复杂 的 电路系统 中 实现 微 流水 还 需要 进一步 的 研究 如 带有 反馈 信号 的 流水线 请求 信号 双沿 的 利用 ［ ］ 和 wavepiplining 的 实现 另外 在 规模 较大 时 还要 考虑 微 流水 控制电路 的 开销 问题 注 ： 本 课题 得到 国家 “ 八 六三 ” 高技术 计划 基金 项目编号 ZD 资助 作者简介 ： 章 永兴 ， 男 ， 年月生 ， 工程师 ， 硕士 研究生 ， 主要 研究 方向 为 高性能 计算机 体系 机构 ， ASIC 芯片 设计 作者 单位 ： 中国科学院计算技术研究所 国家 智能 中心 　 北京 　 参考文献 　 HauckSAsynchronousdesignmethodologiesAnoverviewProceedingsoftheIEEE ， ～ 　 SutherlandIEMicropipelinesCommunACM ， ～ 　 曾荣 董向 军祝 明发 蛀洞 路由 机制 及其 芯片 设计 计算机 学报 ， ～ 　 　 ZengRongDongXiangjunZhuMingfaWormholeroutinganditschipdesignChineseJournalofComputers ～ 　 PountainDComputingwithoutclockBYTE ～ 原稿 收到 日期 ： ； 修改稿 收到 日期 ：