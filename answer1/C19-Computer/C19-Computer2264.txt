计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 P 构建 自己 的 网上 视频 服务 秦明 　 李齐 摘要 以 RealNetworks 的 网上 视频 服务 为例 ， 分析 讨论 了 网上 视频 服务 的 工作 和 实现 原理 ， 并 在 此基础 上 提出 了 建立 网上 视频 服务 的 实现 方案 。 关键词 网上 视频 服务 视频点播 实时 广播 RealServer 引言 　 　 随着 InternetIntranet 的 飞速发展 ， 为了 满足 网上 娱乐 和 远程 多媒体 教育 的 需要 ， 开设 网上 视频 服务 势在必行 。 各大 软件厂商 纷纷 为 网上 视频 服务 提供 了 自己 的 服务器 产品 和 开发 平台 ， 如 Real 的 RealNetworks ， Microsoft 的 NetShow ， Apple 的 QuickTime 等 。 下面 我们 将 以 Real 的 RealNetworks 为例 ， 介绍 网上 视频 服务 的 原理 和 构建 自己 的 视频 服务 的 方法 。 RealNetworks 原理 工作 流程 　 　 RealNetworks 提供 的 一系列 Real 工具 使 制作 和 发布 视频 服务 成为 可能 。 Real 系统 以流 形式 传输 的 多媒体 数据 包括 音频 、 视频 、 动画 、 图片 和 文字 ， 而且 具有 很 好 的 视频点播 和 实时 广播 的 效果 。 其 系统 工作 流程 如图所示 。 图 　 　 ① 用户 在 Web 浏览器 中 点击 指向 含有 Real 多媒体 数据 地址 的 超链接 ， 请求 被 发送到 Web 服务器 。 　 　 ② Web 服务器 把 一个 地址 文件 发送 回 客户端 的 Web 浏览器 。 地址 文件 的 扩展名 一般 是 RPM ， RAM 。 地址 文件 里 的 内容 就是 实际 Real 数据 的 URL ， 可以 只有 一个 数据文件 的 URL ， 或者 是 多个 数据文件 URL 的 列表 。 RealNetworksG 推出 以后 ， 采用 了 一种 称为 SMILSynchronizedMultimediaIntegrationLanguage 的 地址 文件 ， 它 可以 对 播放列表 进行 控制 。 　 　 ③ Web 浏览器 下载 地址 文件 并 识别 后 ， 把 它 交给 RealPlayer 。 　 　 ④ RealPlayer 启动 后 ， 根据 地址 文件 的 内容 直接 和 RealServer 建立 一个 双向 的 TCPIP 控制 连接 。 从 RealPlayer 到 RealServer 的 控制 主要 是 数据流 的 请求 、 播放 、 停止 ， 从 RealServer 到 RealPlayer 的 控制 主要 是 发送数据 类型 、 标题 、 大小 等 信息 和 要求 用户 验证 的 信息 。 　 　 ⑤ RealServer 收到 请求 后 ， 与 客户端 的 RealPlayer 建立 一个 单向 的 UDP 数据 连接 ， 实际 的 多媒体 数据 就 以流 的 形式 被 发送到 RealPlayer ， RealPlayer 开始 播放 。 数据类型 　 　 根据 数据类型 ， Real 多媒体 数据 可以 分为 静态数据 和 实时 数据 。 　 　 静态数据 是 指 在 RealServer 上 实际 存在 的 多媒体 数据文件 ， 以 RM 为 扩展名 。 RM 文件 可以 用 RealProducer 工具 ， 通过 对 AVI 文件 或 MOV 文件 转换 而 得 。 同时 ， RealProducer 还 可 生成 相应 的 RAMRPM 文件 和 HTML 文件 ， 这 两个 文件 可以 编辑 或 另外 生成 后 放在 Web 服务器 上 。 这样 Web 用户 就 可以 访问 RealServer 上 的 静态数据 了 。 Real 静态数据 的 制作 ， 以及 组织 和 管理 都 比较 方便 ， 已经 可以 实现 网上 在线 音频 点播 和 视频点播 等 功能 。 　 　 实时 数据 则 能 实现 现场 广播 的 功能 。 实时 数据 在 RealServer 上 没有 实际 的 文件 存在 ， 而是 直接 从 数据源 获取 ， 并 通过 计算机 的 视频 转换 卡 送到 RealServer ， RealServer 对 实时 数据 进行 编码 以后 再 发送 出去 。 实现 实时 数据 的 现场 广播 无疑 要 增加 硬件 上 的 开销 。 数据源 可以 是 电视台 、 电台 、 录像机 或 摄像机 等 任何 能够 发送 视频 或 音频 信号 的 工具 。 除此以外 ， 还要 有 视频 转换 卡 。 因为 要 编码 再 输出 ， 对 服务器 的 性能 也 要求 较 高 。 当然 实时 数据 也 能够 保存 下来 ， 可 供 以后 播放 。 RealServerG 附带 的 GSLTA 工具 可以 模拟 网上 实时 广播 的 效果 ， 它 把 RealServer 上 的 静态数据 文件 以 实时 的 形式 发送 出去 ， 各 客户端 的 RealPlayer 则 就 可以 同步 播放 了 。 数据传输 机制 　 　 对于 Real 网络系统 而言 ， 不间断 的 数据流 传输 至少 要 占用 Kbps 的 带宽 ， 这样 RealPlayer 才能 获得 稳定 流畅 的 图象 和 声音 。 由于 每个 用户 都 要 占用 Kbps 的 带宽 ， 当 连接 到 RealServer 的 用户 增加 ， 有限 的 带宽 就 不够 用 ， 数据传输 就 不 流畅 ， 客户端 会 出现 等待 ， 或者 根本 就 连不上 服务器 。 一种 解决 的 办法 是 限制 用户 最 多 连接数 和 最大 使用 带宽 。 RealServer 在 提供 这种 限制 的 同时 ， 还 采取 了 另外 两种 技术 ： 分流 传输 和 多点 传输 。 　 　 分流 传输 就是 把 原来 一个 RealServer 提供 的 服务 量 由 多个 相关联 的 RealServer 来 承担 图 。 对 用户 来说 ， 根据 地理位置 的 不同 ， 连接 到 最近 的 RealServer 能 获得最佳 的 数据传输 效果 。 Real 系统 中 的 分流 传输 又 分为 推和拉 两种 形式 。 所谓 “ 推 ” 就是 在 主 RealServer 和 从 RealServer 之间 先 建立 好 连接 ， 数据 从主 RealServer 发送到 从 RealServer ， 用户 只要 连接 到 从 RealServer 就 可以 播放 了 ； “ 拉 ” 则 在 主 RealServer 和 从 RealServer 之间 没有 预先 建立 好 连接 ， 而且 客户端 的 链接 必须 提供 主 RealServer 和 从 RealServer 的 地址 ， 用户 连接 到 从 RealServer 以后 才 开始 和 主 RealServer 建立 连接 ， 这样 用户 在 第一次 播放 的 时候 必然 有个 等待时间 ， 至少 为 秒 。 图 　 　 多点 传输 是 把 实时 数据流 一次 传送 给 多个 用户 ， 而 不是 对 每个 用户 都 传送 同样 的 数据流 图 。 点对点 传输 RealServer 和 各 RealPlayer 都 要 建立 一个 控制 连接 和 一个 数据 连接 ， 开销 大 ； 多点 传输 RealServer 和 各 RealPlayer 之间 仍 要 建立 一个 控制 连接 ， 而 数据 连接 则 为 各 RealPlayer 所 共享 ， 开销 要 小得多 。 需要 注意 的 是 多点 传输 不仅仅 是 在 RealServer 上 设置 ， 同时 客户端 和 网络 硬件 也 要 支持 多点 传输 。 图 SureStream 　 　 另外 值得一提的是 在 RealNetworks 推出 的 名为 SureStream 的 文件 ， 它 是 基于 每个 用户 连接 到 RealServer 的 带宽 不同 的 考虑 。 RealNetworks 编码 压缩工具 可以 按 不同 的 码率 对 音频 或 视频信号 进行 编码 ， 然后 保存 在 同一个 文件 中 ， 即 SureStream 文件 。 当 用户 连接 到 RealServer 时 ， 提供 它 的 带宽 范围 。 RealServer 根据 不同 的 带宽 和 码率 的 对应 关系 找到 SureStream 文件 相应 部分 ， 并 把 这部分 数据 传送 给 用户 ， 这样 用户 就 始终 能 得到 最 理想 的 播放 质量 。 构建 自己 的 网上 视频 服务 　 　 笔者 在 校园网 的 范围 内 已经 架设 了 自己 的 视频点播 和 实时 广播 的 系统 ， 其 结构 如图 。 服务器端 是 在 WindowsNT 平台 上 安装 IIS 和 RealServerG ， 开设 Web 服务 、 FTP 服务 和 Real 的 视频 服务 。 同时 ， 在 另外 一台 计算机上安装 视频 捕捉 卡 和 RealProducerGPlus 软件 用于 制作 视频 数据 。 客户端 使用 IE 浏览 网页 和 RealPlayerGPlus 观看 多媒体 节目 。 视频 数据 由 电视台 、 录像机 或 摄像机 提供 ， 用户 可以 通过 主页 进入 视频 服务 系统 ， 也 可以 直接 连接 到 RealServer 服务器 。 教师 在 上课 或 进行 专题讲座 的 时候 ， 通过 摄像机 和 RealProducer 软件 把 视频 数据 送到 RealServer 进行 实时 现场 广播 ， 这样 连接 到 RealServer 的 学生 就 可以 不 在 教室 里 ， 却 能 和 坐在 教室 里 的 学生 一样 看到 和 听到 上课 或 讲座 的 内容 。 当然 也 可以 在 实时 广播 的 同时 把 视频 数据 录制 下来 ， 在 以后 合适 的 时候 再 重播 ， 或者 通过 FTP 服务 让 学生 下载 后 再 观看 ， 这样 又 可以 节约 有限 的 网络带宽 。 除了 用于 教育 学习 ， 我们 的 系统 还 建立 了 学生 社区 ， 让 学生 进行 点播 ， 在 网上 定时 播放 各种 娱乐节目 。 从 实际 使用 情况 来看 ， 系统 在 校园网 范围 内 可以 有 良好 的 播放 效果 。 我们 的 网上 视频 服务 也 受到 了 广大 学生 的 欢迎 和 教师 的 大力支持 。 图 秦明 上海师范大学 计算机科学 系 上海 李齐 上海师范大学 计算机科学 系 上海 参考文献 ， Internetwwwrealcom ， 施威 铭 研究室 WindowsNT 架站 实务 收稿 日期 ：