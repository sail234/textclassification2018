微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 年 第卷 第期 VolNo 在 VC 环境 下 开发 数据库 接口 应用 马松梅 　 刘静霞 　 朱秋萍 　 　 摘 　 要 ： 在 VC 环境 下 基于 MFC 类库 开发 数据库 接口 应用程序 的 方法 。 　 　 关键词 ： 数据库 接口 　 MFC 类库 　 开放 数据库 互连 ODBC 　 　 ODBC 是 MicrosoftWindowsOpenServicesArchitectureWOSA 的 数据库 部分 ， 它 提供 API 以使 应用程序 独立 于源 数据库 管理系统 DBMS 。 通过 ODBC 驱动程序 ， 允许 终端用户 在 个 应用程序 中 访问 不同 数据库 中 的 数据 。 MFC 数据库 类 的 目标 ， 就是 要 为 程序员 提供 用于 访问 ODBC 数据源 的 高级 C 和 MicrosoftWindowsAPI ， 它 是 基于 ODBC 的 ， 以 保证 最大 的 内部 可操作性 。 通常 情况 下 不 需要 直接 调用 ODBCAPI 。 　 　 图 说明 了 应用程序 、 数据库 类 、 ODBC 和 DBMS 之间 的 关系 。 图 　 数据库 应用程序 层次 关系 　 MFC 数据库 类 简介 　 CDatabase 类 数据库 类 　 　 该类 主要 完成 与 数据源 的 联接 。 当个 CDatabase 对象 与 个 数据源 联接 上 以后 ， 可 构造 记录集 。 当 数据源 的 联接 使用 完后 ， 要 关闭 CDatabase 对象 ， 将 其 撤销 或 把 它 用于 个 新 的 联接 。 　 CRecordset 类 记录集 类 　 　 在 应用程序 创建 记录集 类 的 个 对象 时 ， 要 指定 与 它 相关联 的 数据源 、 要用 的 表 和 该表 的 列 。 VC 应用程序 框架 会 自动 编写 CRecordset 类 的 GetDefaultSQL 成员 函数 返回 该表 的 名称 。 应用程序 通过 记录集 类 的 个 对象 以 RFX 记录 字 段 交换 方式 在 其字段 数据 成员 与 数据源 表 的 对应 列 之间 传送数据 。 　 CRecordView 类 记录 视类 　 　 该类 对象 直接 与 个 记录集 对象 相关联 。 采用 动态 数据交换 DDE 方式 把 记录集 当前 记录 中字 段 的 值 送到 格式 控制 中 ， 并 把 更新 过 的 信息 送 回到 记录 集中 。 该类 提供 个 基于 对话 资源 模板 的 数据库 格式 ， 其 控制 被 映射 成 相关 记录集 对象 的 字 段 数据 成员 。 　 在 VC 中 实现 应用程序 和 数据库 的 接口 　 　 下面 通过 个 具体 例子 介绍 MFC 数据库 类及 用 数据库 类 开发 数据库 接口 应用 的 方法 。 假设 计算机 中 已 装有 位 的 ODBCDriverManager 动态链接库 和 位 的 ODBC 驱动程序 ， 且 在 PowerBuilder 中 开发 了 个 藏书 信息 数据库 ， 名为 “ bookcasepbl ” ， 作为 应用 接口 数据库 。 具体 开发 过程 为 ： 　 　 在 AppWizard 中 ， 建立 基于 单 文档 的 项目 项目 名为 dbtestmdp 。 在 关于 数据库 支持 选项 中 选择 第项 或 第项 ， 二者 的 主要 区别 是 第个 选项 除 打开 个 数据库 外 ， 还 将 打开 个 磁盘 文件 。 磁盘 文件 可 用于 保存 “ 风格 表 ” 之类 信息 ， 使 用户 可以 配置 、 保存 和 快速 恢复 数据库 的 多个 替换 视 。 随后 点击 下面 的 “ DataSource ” 按钮 ， 进入 个 数据库 选择 对话框 。 选择 基于 “ ODBC ” 的 数据源 该例 中 选择 bookcase 数据源 ， 选择 记录 类型 为 “ snapshot ” 型 ， 点击 “ OK ” 按钮 。 接下来 进入 选择 数据库 表单 对话框 ， 在 该 对话框 中 列出 了 所选 数据库 的 所有 表单 ， 选择 欲 联接 的 表 ， 点击 “ OK ” 返回 。 该 步骤 创建 了 应用程序 与 数据库 联接 的 相关 类 、 文件 及 资源 。 　 　 创建 应用 程序界面 。 进入 资源 模板 ， 读者 会 看到 AppWizard 自动 创建 了 个 ID 号 为 IDDDBTESTFORM 的 对话 模板 资源 。 该 资源 是 用于 应用 与 用户 的 交互 界面 。 本例 中将 该 对话框 设计 成有 个 编辑框 用于 显示 记录 的 值 ， ID 号 分别 为 IDCEDIT ， IDCEDIT ， … … IDCEDIT 。 在 编辑框 的 前面 对应 静态 文本 ， 分别 为 “ 书名 ” ， “ 作者 ” ， “ 出版社 ” ， “ 价格 ” ， “ 内容简介 ” 。 　 　 把 记录集 的 字 段 与 表格 的 列 联接 起来 。 点击 “ View ” 菜单 ， 进入 ClassWizard 对话框 ， 在 此 把 选中 表 的 所有 列 和 记录集 联接 起来 ， 也 可 从 记录 集中 去除 一些 不 想要 的 列 对应 的 数据 成员 ， 还 可 更新 记录集 的 列以 反映 变化 后 的 数据源 表 的 新列 。 这些 功能 都 可 在 ClassWizard 中 选择 CDbtestSet 类 的 MemberVariables 表 实现 ， 方法 非常简单 ， 此处 不再 赘述 。 　 　 完成 上述 操作 后 ， 打开 dbtestSeth 文件 ， 将 发现 已 自动 声明 了 如下 变量 ： 　 　 classCDbtestSetpublicCRecordsetpublic 　 　 　 … 　 　 AFXFIELDCDbtestSetCRecordset 　 　 CStringmbooktitle 　 　 CStringmbookauthor 　 　 CStringmbookpublisher 　 　 CStringmbookprice 　 　 CStringmbookabstract 　 　 AFXFIELD 　 　 　 … 　 　 同时 在 CDbtestSetcpp 文件 中 的 DoFieldExchangeCFieldExchangepFX 函数 中将 选中 表 的 列 和 记录集 字 段 数据 成员 联接 起来 。 程序代码 如下 ： 　 　 voidCDbtestSetDoFieldExchangeCFieldExchangepFX 　 　 AFXFIELDMAPCDbtestSet 　 　 pFXSetFieldTypeCFieldExchangeoutputColumn 　 　 RFXTextpFXT “ ［ booktitle ］ mbooktitle 　 　 RFXTextpFXT “ ［ bookauthor ］ mbookauthor 　 　 RFXTextpFXT “ ［ bookpublisher ］ mbookpublisher 　 　 RFXTextpFXT “ ［ bookprice ］ mbookprice 　 　 RFXTextpFXT “ ［ bookabstract ］ mbookabstract 　 　 AFXFIELDMAP 　 　 把 格式 的 控制 映射 成 记录集 的 字 段 。 基于 CRecordView 类 的 数据库 格式 要 用 动态 数据交换 DDE 在 格式 的 控制 与 格式 的 相关 记录集 对象 的 字 段 数据 成员 之间 交换 数据 。 所以 ， 开发者 要 做 的 工作 是 把 格式 的 控制 映射 到 记录 集中 ， 步骤 如下 ： 　 　 选择 ClassWizard 的 MemberVariables 表 ； 　 　 在 ClassName 框中 ， 选择 记录 视类 的 名字 ； 　 　 在 ControlIDs 框中 ， 选择 个 控制 ID 本例 中为 IDCEDIT ， … ， IDCEDIT ； 　 　 选择 AddVariable 按钮 命名 个 与 该 控制 相关 的 变量 ； 　 　 在 AddMemberVariable 对话框 中 ， 通过 选择 MemberVariableName 下拉 列表框 中 的 个 记录集 数据 成员 ， 选择 个 变量名 ； 　 　 选择 “ OK ” 按钮 关闭 AddMemberVariable 对话框 ； 　 　 对 记录 视中 想要 映射 成 记录集 字 段 数据 成员 的 每个 控制 ， 重复 ～ 步 ； 　 　 选择 “ OK ” 按钮 关闭 ClassWizard 。 　 　 另外 ， 如果 VisualC 对话框 编辑器 是 打开 的 ， 对 上述 实现 步骤 则 有 下述 捷径 ： 　 　 选择 格式 中 的 个 控制 ， 按下 CTRL 并 双击鼠标 ， 打开 ClassWizard 的 AddMemberVariable 对话框 ， 从中 可 把 记录集 的 个 字 段 数据 成员 与 该 控制 联接 起来 。 　 　 完成 上述 步骤 ， 打开 dbtestViewh 文件 ， 看到 记录 视类 中 增加 了 个 成员 变量 mpSet 该 变量 定义 为个 指向 记录集 类 的 指针 。 　 　 打开 dbtestViewcpp 文件 ， 看到 程序 生成 代码 如下 ： 　 　 voidCDbtestViewDoDataExchangeCDataExchangepDX 　 　 CRecordViewDoDataExchangepDX 　 　 AFXDATAMAPCDbtestView 　 　 DDXFieldTextpDXIDCEDITmpSetmbookabstractmpSet 　 　 DDXFieldTextpDXIDCEDITmpSetmbooktitlempSet 　 　 DDXFieldTextpDXIDCEDITmpSetmbookauthormpSet 　 　 DDXFieldTextpDXIDCEDITmpSetmbookpublishermpSet 　 　 DDXFieldTextpDXIDCEDITmpSetmbookpricempSet 　 　 AFXDATAMAP 　 　 编译 连接 。 　 　 此时 已经 开发 了 个 简单 数据库 接口 应用程序 ， 读者 可 通过 执行 此 程序 在 界面 上 看到 与 应用 相关联 的 数据库 中表 的 内容 。 　 　 如果 开发者 要 实现 “ 排序 记录 ” 、 “ 过滤 记录 ” 等 增强 功能 ， 方法 如下 ： 　 　 对 记录集 指定 排列 顺序 。 在 构造 对象 之后 ， 调用 其 Open 成员 函数 之前 ， 建立 记录集 的 排列 次序 。 通常 在 CDbtestSet 的 构造函数 中 实现 。 本例 中 ， 程序代码 如下 ： CDbtestSetCDbtestSetCDatabasepdbCRecordsetpdb 　 　 … mstrSort “ bookpriceDESCbookauthorASC 　 　 其中 ， 参数 “ DESC ” 指明 按 降序 排列 ， “ ASC ” 指明 按 升序 排列 。 在 排序 中若 指定 个 或 更 多 的 排序 准则 ， 则 先 按 第条 准则 排序 ， 若值 相同 ， 再 按 第条 准则 排序 ， 依次 类推 。 　 　 对 记录集 指定 过滤 准则 。 在 构造 对象 之后 ， 调用 其 Open 成员 函数 之前 建立 记录集 的 过滤 准则 。 本例 中 在 CDbtestSet 的 构造函数 中 实现 ， 程序代码 如下 ： CDbtestSetCDbtestSetCDatabasepdbCRecordsetpdb 　 　 … 　 mstrFilter “ bookprice 　 　 设置 完后 ， 应用程序 只 显示 书价 为元 的 书目 。 　 　 至此 ， 已 初步 完成 简单 的 数据库 接口 应用 开发 。 为 帮助 读者 更好 地 掌握 MFC 数据库 关系 及 程序开发 思路 ， 将 开发 过程 中 记录集 类 对象 、 记录 视类 对象 的 关系 做个 总结 ， 结果 如图 。 图 　 记录集 类 与 记录 视类 的 对象 关系 　 　 通过 上面 的 讲述 及 框图 ， 较为 详细 地 介绍 了 在 VC 环境 下 开发 数据库 接口 应用程序 的 思路 及 过程 。 希望 读者 能 在 此基础 上 开发 个 更加 完善 的 数据库 接口 应用程序 。 作者 单位 ： 武汉大学 电信 学院 参考文献 　 　 赵人任 ， 郑峰 译 MicrosoftVisualCforWin 大全 一 — — 用户 指南 北京 ： 清华大学出版社 ， 　 　 王敏 ， 韦诚 VisualC 程序员 参考手册 北京 ： 北京大学出版社 ， 收稿 日期 ：