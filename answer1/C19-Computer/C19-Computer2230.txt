计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERSVolNoPPowerBuilderSybase 系统 开发 中 的 数据库 转移 陈 新安 　 张继棠 摘 　 要 ： 针对 在 大型 MIS 系统 中 经常 遇到 将 一种 数据库 的 原始数据 转移 到 服务器 数据库 进行 的 处理 问题 ， 将 本地 磁盘 上 的 Foxbase 数据库 数据 转移 到 Sybase 数据库 服务器 为例 ， 提出 了 几种 有效 的 方法 ， 并 对 各种 方法 的 优缺点 作 了 一一 的 说明 和 比较 。 关键词 ： 客户机 服务器 ODBCPipeline 系统 表 　 　 在 大型 的 MIS 系统 中 大多 是 采用 客户机 服务器 CS 的 网络体系结构 ， 在 该 系统 中 数据 集中 存储 在 服务器 的 数据库 中 。 开发新 的 MIS 系统 的 时候 ， 数据 的 采集 和 录入 是 一个 重要 的 部分 。 以 电信 计费 系统 为例 主要 有 以下 几个 方面 ： 原始数据 的 分拣 处理 ， 处理 的 对象 主要 是 磁盘 、 磁带 ， 或者 光盘 的 二进制 数据 。 以往 系统 中 的 档案 数据 和 参数 数据 的 转移 处理 ， 以 减少 用户 的 输入量 和 因为 人工 输入 所 带来 的 错误 ， 处理 的 对象 主要 是 Foxbase 、 Access 等 数据库 文件 。 信息 台 或者 其它 部门 送来 的 以 Foxbase 、 Access 等 文件 存储 的 费用 文件 ， 如 信息 台 送来 的 费用 数据 等 。 　 　 本文 中将 结合 PowerBuilderSybase 系统 开发 的 实例 ， 重点 介绍 ， 两种 情况 的 处理过程 即 完成 本地 数据库 文件 向 服务器 数据库 中 的 转移 中 所 采取 的 几种 方式 ， 以及 各种 方式 的 具体 设计 方法 ， 说明 了 每种 方法 的 普遍性 和 针对性 ， 并 对 其 优缺点 作 了 比较 。 　 利用 importfile 函数 实现 转移 　 　 PowerBuilder 是 一种 进行 CS 系统 开发 的 优秀 的 前端 工具 ， 本身 提供 了 大量 的 功能 和 函数 ， 其中 DataWindow 数据 窗口 是 其 重要 的 组成部分 ， 具有 强大 的 功能 ， 其中 importfile 函数 能够 完成 数据 的 转移 。 　 　 实现 的 过程 是 在 服务器 上 创建 一个 同 磁盘 上 的 数据库 结构 相同 的 表 ， 创建 一个 数据 窗口 对象 dwfox ， 取 数据源 建立 数据 窗口 ， 利用 数据 窗口 对象 本身 的 importfile 函数 将 数据 转移 到 数据 窗口 中 ， 利用 update 函数 将 数据 保存 到 服务器 上 所建 的 表中 ： dwfoximportfiecipanfilenamedwfoxUpdate 　 　 其中 cipanfilename 为 磁盘 上 的 文件 及其 路径 名称 。 该 处理 简单 ， 但是 缺乏 灵活性 ， 对 在 服务器 数据库 中 建立 的 表 的 结构 有 比较 高 的 要求 ， 保证 严格 的 一致性 ， 但 可以 作 相应 的 处理 将 有效 的 数据处理 后 转移 到 自己 建 的 表中 。 　 利用 ODBC 连接 实现 转移 　 　 ODBC 是 一种 标准 的 应用 程序接口 API ， 最早 由 MicrosoftWindows 系统 实现 ， 它 允许 一个 应用程序 同时 连接 多个 数据源 ， 它 使用 标准 的 SQL 语句 作为 其 数据 查询 语句 。 在 处理过程 中先 通过 ODBC 画板 静态 地 建立 一个 ODBC 连接 磁盘 上 的 Foxbase 数据库 ， 编程 中 创建 一个 本地 的 事务 对象连接 本地 的 数据库 ， 通过 处理 后 ， 将 有效 的 数据 送到 服务器 上 事先 设计 的 一个 与 Foxbase 数据库 相 类似 的 表中 ， 保存 有效 的 数据 就 可以 了 。 在 实际 处理 的 过程 中 ， 各个 地方 的 磁盘 文件名 是 不同 的 ， 这样 所 连接 的 数据库 文件名 和 目录 都 是 变化 的 ， 那么 在 设计 的 时候 就 不 能够 实现 将 ODBC 的 接口 固定 设计 出来 ， 在 处理 的 时候 一般 有 两种 方式 ， 前端 作 一定 的 处理 ， 即 按照 系统 要求 的 目录 和 文件名称 进行 拷贝 ， 为了 使 应用程序 有 更好 的 适应性 ， 我们 没有 采取 这种 方式 ， 而是 另外 一种 方式 ， 采取 动态 建立 ODBC 连接 的 方式 。 　 　 在 PowerBuilder 的 ODBC 连接 中 需要 几个 重要 的 参数 ， 在 利用 ODBC 事先 建立 一个 连接 FoxBASE 数据库 后 如 Foxbase ， 查看 pbini 文件 时 将 有 如下 的 记录 ： ［ PROFILEFoxtran ］ DBMSODBCDbParmConnectstringDSNFoxBASEPromptAutoCommit 　 　 同样 打开 注册器 在 HKEYCURRENTUSERSoftwareODBCODBCINI 下 将 会 发现 已经 注册 的 FoxBASE 主键 ， 这些 给 我们 动态 地 建立 ODBC 连接 提供 了 重要 的 资料 。 　 　 在 具体 的 设置 中 利用 PowerBuilder 提供 的 函数 注册 一个 ODBC 的 连接 ， 然后 创建 一个 事务 对象连接 本地 磁盘 的 数据库 ， 作 相应 的 处理 后 将 所 需要 的 数据 送到 服务器 上 ， 具体 的 操作 如下 ： RegistrySetHKEYCURRENTUSERSoftwareODBCODBCINI 　 FoxBASEDefaultDirregstringfilepath 　 　 　 　 　 　 　 　 　 　 　 　 　 设置 FoxBASE 主键 TransactionFoxtranFoxtrancreateTransaction 下面 是 初始化 FoxtranDBMSODBCFoxtranDBParmConnectstringDSNFoxBASEconnectusingFoxtran ； 　 　 其中 FoxBASE 是 注册 的 ODBC 的 名称 ， Foxtran 是 事务 对象 管理 中 创建 的 用以 连接 Foxbase 数据库 的 新 事务 ， 然后 对 事务 对象 进行 初始化 ， filepath 是 磁盘 数据库 所在 的 路径 名称 可 根据 用户 输入 的 文件 路径 和 文件名 分析 后 取得 。 利用 动态创建 ODBC 连接 同样 可以 同时 连接 其它 的 本地 数据库 如 Access 或者 SybaseSQLanywhere 等 ， 具有 一定 的 灵活性 。 　 利用 数据 管道 实现 转移 　 　 PowerBuilder 的 数据 管道 对象 是 在 开发利用 DataPipeline 画板 来 完成 和 运行 动态 的 生成 当中 传输数据 和 数据结构 的 一种 有效 的 方案 。 这些 数据库 可以 是 相同 的 DBMS 或 不同 的 DBMS ， 数据传输 可以 是 插入 一张 完整 的 数据表 或者 表 的 一部分 及其 数据 ， 也 可以 是 更新 已有 表 的 数据 。 转换 时 几个 重要 的 选项 是 ： 源 数据库 ， 目标 数据库 ， 移动 数据 出来 的 源表 ， 数据 将 移到 的 目的 表 ， 所 要 完成 的 管道 操作 等 。 下面 以 在 运行 中 使用 为 例来 加以 说明 其 处理 的 过程 。 　 　 建立 管道 对象 Pipecopyconvert ， 然后 建立 一个 管道 类型 的 标准 类 用户 对象 upipeline 和 一个 数据 窗口 dwpipeerrors 。 在 运行 的 过程 中 创建 用户 对象 实例 ， 对 它 的 属性 进行 赋值 ： iupipelinecreateupipelineiupipelineDataObjectpipecopyconvert 　 　 创建 连接 源 数据库 和 目标 数据库 的 事务 对象 ， 初始化 连接 事务 对象 同 上 。 TransactionTransourseTrandestTransoursecreateTransactionTrandestcreateTransaction 初始化 　 　 运行 数据 管道 及 后续 处理 。 　 　 利用 start 函数 完成 后 ， 捕捉到 错误 后 进行 相应 的 处理 ， 利用 cancel 终止 数据 管道 的 执行 。 iupipelinestarttransoursetrandestdwpipeerrors 错误处理 iupipelinecancel 　 　 利用 数据 管道 能够 比较 快速 的 、 直接 的 将 本地 数据库 包括 表 的 整个 结构 或者 部分 以及 数据 转移 到 服务器 的 数据库 并 保存 在 一个 表中 ， 在 转移 用户 的 原始 档案资料 的 时候 多 采取 这种 方法 。 　 分析 本地 库 系统 实现 转移 　 　 在 进行 数据 转换 的 过程 中 ， 由于 各种 数据 的 表 的 结构 都 是 不 一样 的 ， 以 电信 计费 的 信息费 为例 ， 不同 的 地区 信息 台 使用 的 软件 不同 ， 数据字 段 几乎 都 是 不 一样 的 ， 实际 的 处理 中 也 不是 每 一个 字段 的 数据 都 有 意义 ， 或者 都 需要 转换 到 服务器 的 数据库 中 ， 用户 往往 要求 根据 自己 的 需要 来 选择 字 段 、 计算 方式 以及 每列 的 约束条件 如 有些 项目 有 最大值 的 限制 等 ， 利用 以上 的 方法 来 处理 就 有些 困难 。 在 实际 的 处理 中 ， 我们 考虑 分析 本地 数据库 的 系统 表 ， 来 得到 本地 数据库 的 结构 ， 将 数据库 中 的 各个 字 段 呈现 在 用户 的 面前 。 用户 作出 选择 后 ， 加入 一定 的 条件 ， 再 进行 处理 ， 将 利用 动态 SQL 语句 生成 一个 满足条件 的 表 。 这样 就 要求 用户 能够 通过 系统 来 了解 磁盘 数据库 的 内容 ， 分析 本地 库 的 系统 表后 将 得到 较为 满意 的 结果 。 　 　 在 利用 ODBC 连接 到 本地 库后 ， 发现 并 分析 了 几个 系统 表 Systemtable ， 其中 有 一个 表是 Pbcatcol 中 记录 着 用户 数据库 的 结构 ， 其中 的 一部分 如表 所示 如果 表为 ADDRESSIDNameAddressPhone 。 表 pbctnampbctidpbcownrpbccnamADDRESS 　 PublicIDADDRESS 　 PublicNameADDRESS 　 PublicAddressADDRESS 　 PublicPhone 　 　 其中 ： pbctnam 记录 的 是 用户 数据库 的 表名 Tablename 在 Foxbase 中 一个 表 就是 一个 数据库 ， pbccnam 记录 的 是 用户 数据库 的 列名 Columnname 。 　 　 根据 用户 输入 的 文件名称 ， 取消 后缀 即可 得到 数据库 的 表名 ， 定义 一个 光标 即可 取得 用户 数据库 的 列名 ， 将 数据库 展示 在 用户 的 面前 ， 用户 根据 需要 选择 后 再作 处理 。 DECLAREMyCursorCURSORFORSELECTpbcatcolpbccnamFROMpbcatcol 　 　 利用 分析 系统 表来 得到 用户 数据库 的 结构 是 一个 比较 有效 的 方法 ， 它 能够 对 未知 的 数据库 结构 有 一个 清晰 的 认识 ， 而 不 需要 事先 知道 它 的 结构 。 但是 它 仍然 有 一个 问题 ， 就是 通过 分析 系统 表 不能 得到 用户 数据库 的 列 的 数据类型 ， 在 转换 到 服务器 的 数据库 的 时候 要 借助 用户 的 输入 才 能够 确定 ， 即 提供 用户 必须 选择 的 项目 来 确定 某 一个 字段 的 数据类型 。 能够 比较 好 地 完成 数据 的 转换 ， 具有 相当 大 的 灵活性 ， 程序 并 不要 关心 用户 数据库 的 类型 ， 可以 广泛 地 使用 于 各种类型 的 数据库 Foxbase ， Access 等 。 　 分析 服务器 系统 实现 转移 　 　 要 确定 一个 数据库 的 结构 ， 只要 确定 用户 数据库 的 字段名 和 数据类型 就 可以 了 。 利用 分析 本地 库 系统 表 的 方式 可以 得到 数据库 的 字段名 ， 但是 用户 数据库 的 字 段 的 数据类型 仍然 无法 获得 。 通过 分析 Sybase 服务器 数据库 的 系统 表 可以 得到 服务器 数据库 中 的 表 的 字段名 和 数据类型 。 在 设计 的 时候 考虑 采取 两种 方法 相结合 的 办法 ， 先 利用 数据 管道 Pipeline 将 用户 本地 的 数据库 完整 地 转换 到 服务器 的 数据库 中 的 一个 表 ， 然后 通过 分析 服务器 上 的 系统 表 ： Pbcatcol ， Syscolumns ， Systypes 。 其中 Pbcatcol 表中同 前面 一样 记录 着 用户 表 的 表名 和 字段名 等 ， Syscolumns 中 记录 着 数据库 中 所有 表 的 字段名 Name 、 字段 的 数据类型 Type 、 字段 的 长度 Length 和 精确度 Prec ， Scale 等 。 将 三个 表 关联 后 可 从中 取得 从 磁盘 上 转换 到 服务器 上 的 表 的 完整 的 结构 可以 通过 定义 光标 或者 直接 利用 数据 窗口 的 方式 完成 具体 的 设计 。 SELECTsyscolumnsnamesystypesnameFROMpbcatcolsyscolumnssystypeslengthWHEREsyscolumnstypesystypestype 　 　 andpbcatcolpbccnamsyscolumnsname 　 　 andpbcatcolpbctnamAddress ； 　 分析 数据库 文件 实现 转移 　 　 利用 数据 管道 和 分析 服务器 系统 表相 结合 的 方法 能够 比较 完整 的 解决 数据 的 转换 问题 ， 但 仍然 要 将 本地 的 数据库 完整 的 转换 到 服务器 上 ， 增加 了 服务器 的 负担 ， 占据 了 一定 的 存储空间 。 设计 中 我们 试用 了 另 一种 方法 ， 通过 分析 本地 数据库 本身 的 结构 ， 希望 有所 收获 。 利用 VisualC 以 二进制 的 方式 将 数据库 文件 打开 此种 方法 只 对 Foxbase 文件 进行 了 分析 发现 如图所示 的 结构 ， 文件 存储 的 方式 是 表头 和 数据 两个 部分 ， 表头 以 十六进制 的 D 结尾 。 其 表头 的 规律 是 ： 第一个 个 字节 是 文件 头 ； 从 第二个 个 字节 后 是 第一个 字段名 和 数据类型 ； 第三个 字节 开始 又 是 第二个 字段名 和 数据类型 。 以此类推 ， 直到 D 结束 ， 其 结构 如表 所示 。 不足 的 部分 添 十六进制 的 ， 其中 数据类型 是 简写 ： CChar ， DDate ， LLogical ， NNumeric ， MMemo ， GGenera 。 表 　 字段名 （ ～ ） 数据类型 （ ～ ） 个 字节 （ 最 多 ） 一个 字节 　 　 于是 用 PowerBuilder 提供 的 文件 处理函数 FileOpen ， FileSeek ， FileRead ， FileClose 等 ， 可以 分析 Foxbase 数据库 文件 ， 得到 本地 数据库 的 字 段 和 数据类型 。 对 各种 字段 的 长度 可以 让 用户 来 设定 ， 或者 系统 按照 最大 和 系统 的 要求 来 设定 。 在 服务器 的 数据库 上来 产生 相应 的 表 ， 利用 动态 的 数据 窗口 Datawindow 可以 显示 本地 库 的 数据 和 处理 的 结果 。 　 结束语 　 　 对于 完成 数据 的 转移 有 很 多种 的 方法 。 在 实际 的 处理过程 中 ， 要 根据 用户 的 需求 和 系统 的 设计 等 各个方面 来 考虑 。 其 目的 是 要 设计 过程 简单 ， 而且 要 满足用户 的 需要 ， 要求 有 较 高 的 适应性 和 灵活性 ， 以 减少 后期 的 维护 工作 。 本文 上述 的 种 方法 均 在 系统 的 设计 过程 中 得以 实现 ， 取得 了 较 好 的 效果 。 陈 新安 重庆 邮电学院 科研所 重庆 张继棠 重庆 邮电学院 科研所 重庆 参考文献 杨孝如 等 编 Sybase 数据库系统 管理 指南 北京 中国 水利 出版社 美 GallagherSHerbertS 著 曹康译 Powerbuilder 程序设计 大全 北京 机械 工业 出版社 PowerbuilderHandbookSybase 公司 收稿 日期 ： 年月日