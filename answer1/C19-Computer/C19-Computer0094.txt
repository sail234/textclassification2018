计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNoHFC 网络 计费 管理 的 分析 与 研究 罗静 ， 汪敏 摘要 ： 对 HFC 网 的 Internet 服务 计费 机制 进行 了 分析 和 设计 ， 讲座 了 针对 HFC 网 的 用户 入 特点 ， 分析 了 计费 系统 中 的 一些 关键问题 和 难点 ， 从而 提出 解决 方法 。 关键词 ： 计费 ； 简单 网络管理 ； 传输控制协议 网间 协议 ； 光纤 同轴电缆 混合 AnalysisandResearchonAccountingManagemetninHFCLuoJinWangMingDepartmentofCommunicationEngineeringShanghaiUnivShanghai 【 Abstract 】 ThisarticleanalyizesthemethodsofaccoutingforInternetservicediscussesthecharactersofHFCaccessnetworkproposessomeimportantquestionsanddifficultiesandthengivesthesolutionstothem 【 Keywords 】 AccountingSNMPTCPIPHFC 　 　 网络 计费 系统 可分 两 大部分 ： 数据 采集 和 对 采集 的 数据 进行 分析 处理 。 由于 用户 使用 网络 的 方式 不同 ， 其 数据 的 采集 方法 也 不 相同 ， 而 用户 本身 又 可分 两类 ： 个人用户 和 集团 用户 如 学校 等 ， 对 他们 的 计费 方式 都 有所区别 。 个人用户 一般 通过 电话 拨号上网 ， 而 集团 用户 则 通过 x 、 DDN 、 以太网 等 有 IP 连接 的 方式 上网 。 电话拨号 又 可分 两种 ： 仿真 终端 方式 和 PPPSLIP 方式 。 为了 简化 系统 的 设计 和 实现 ， 对 计费 系统 提出 以下 原则 ： 个人用户 拨号 方式 按 使用 时间 计费 ； 集团 用户 专线 方式 按 使用 的 数据 流量 计费 。 　 　 对于 个人用户 的 计费 将 基于 主机 系统 ； 对 集团 用户 将 采用 基于 IP地址 的 流量 统计 来 计费数据 一般 取自 路由器 。 计费 系统 研究 　 　 HFC 是 一种 光纤 同轴电缆 混合 用户 接入网 解决方案 主干 线路 为 光纤 靠近 用户 这段 为 同轴电缆 用户 通过 CableModem 连入 HFCCableModem 有 RJ 插口 ， 用户 只 需 插入 一块 网卡 就 可以 上网 了 。 不论 从 传输速度 还是 从 网络 稳定性 方面 HFC 都 是 一个 比较 理想 的 传输 网络 ， 而且 我们 国家 有线电视 的 普及率 也 比较 高 ， 可以 利用 现有 的 基础设施 ， 所以 HFC 对于 建设 国家 信息 高速公路 是 非常 有利 的 。 HFC 的 网络管理 是 决定 网络 能否 正常 运转 的 前提 ， 而 网络 计费 功能 又 是 网络管理 中 一个 非常 重要 的 方面 ， 它 与 每个 用户 的 切身利益 密切相关 。 　 　 经过 分析 和 研究 整个 计费 系统 分为 两 部分 ： 用户 上网 时间 计费 系统 和 IP 流量 计费 系统 。 计费 管理 方案 如下 ： 图 HFC 拓补 结构 以上 针对 单个 用户 申请 DHCP 分配 IP地址 的 联网 形式 ， 主要 根据 用户 上网 时间 来 计费 ， 对 匿名 用户 可以 不 收取 费用 。 　 　 以上 针对 申请 固定 IP地址 的 联网 形式 ， 用户 不 需要 Internet 帐号 ， 主要 根据 IP 流量 进行 计费 。 具体 实现 方案 如下 ： 　 　 用户 上网 时间 计费 系统 　 　 一般 用户 连入 Internet 采用 Modem 拨号上网 ， 通过 拨号 程序 进行 网络连接 ， 登录 上网 ， 拨号 完成 的 是 网络 上 物理 连通 ， 帐号 验证 完成 的 是 网络 上 逻辑 连通 。 而 HFC 网中 用户 计算机 通过 网线 连入 HFC 网中 ， 相当于 专线 连接 ， 网络 在 物理 上 是 一直 连通 的 。 虽然 HFC 网 不 存在 用户 抢占 RAS 拨号 端口 的 问题 ， 但是 HFC 是 树型 拓扑 结构 ， 网内 的 MAC 规约 采用 上 、 下行 信道 的 非对称 结构 ， 并 将 上行 信道 划分 成 多个 竞争 信道 和 预约 信道 。 所以 也 存在 用户 抢占 上行 信道 传输 信息 的 问题 ， 这样 用户 占用 信道 类似 于 拨号 占用 通信 端口 ， 对 用户 连接时间 记录 是 非常 有 意义 的 ， 这 也 是 HFC 不同于 一般 专线 连接 局域网 所在 。 在 这种 情况 下 ， 如果 对 用户 上网 时间 进行 记录 可以 效仿 拨号上网 的 通信 机制 ， 开发 一个 客户机 服务器 模式 的 通信 软件包 ， 它 由 ServerProgramme 和 ClientProgramme 两 部分 组成 ， ClientProgramme 提供 给 用户 一个 登录 界面 ， ServerProgramme 相当于 一个 RAS 软件 ， 负责 帐号 的 验证 和 用户 上网 信息 包括 上网 时间 的 记录 。 这种 方法 的 关键在于 如何 把 该软件 与 用户 申请 Internet 服务 紧密结合 ， 要求 用户 进行 Internet 服务 之前 必需 运行 该软件 进行 帐号 验证 工作 。 考虑 到 Router 有 基于 IP地址 的 包 过滤 功能 ， 例如 Cisco 路由器 中 ， 通过 accesslistlistpermitdenyprotocolsourcesourcemaskdestinationdestinationmaskoperatoroperandestablished 命令 可以 配置 哪些 IP 包 可以 被 路由器 转发 到 HFC 网外 。 所以 可以 通过 ServerProgramme 执行 该 命令 来 控制 路由器 ， Server 验证 为 合法 的 Internet 帐号 把 响应 的 IP地址 记录 到 路由器 中 ， 并 开始 记 时 ； 当 用户 退出 时 ， 再 由 Server 把 该 IP地址 从 路由器 中 删掉 ， 同时 把 现在 的 时间 与 上网 时间 相减 得到 用户 上网 时间 ， 这样 用户 必须 先 启动 ClientPrograme 才能 与 外界 进行 通信 ， 否则 路由器 不予 转发 ， 用户 只能 得到 HFC 网内 服务 。 　 　 IP 流量 计费 系统 　 　 由 HFC 网 的 拓扑 结构 可以 看出 HFC 网 通过 Internet 路由器 连入 Internet ， 当 用户 与 HFC 网外 站点 进行 通信 时 ， 每 一个 数据包 必须 经过 该 路由器 ， 根据 记录 到 的 HFC 网络 中 每个 IP地址 的 进出 流量 ， 以及 在 不同 时间段 ， 对 不同 费用 网络 的 使用 情况 等 进行 统计 ， 从而 给出 记账 依据 。 由于 在 基于 TCPIP 的 互连 网络 中 ， 所有 应用 的 数据 都 是 在 IP 数据包 上 进行 的 ， 因此 ， IP 的 数据 流量 反应 了 用户 对 网络 的 实际 使用 情况 。 基于 流量 的 记账 对于 租用 专线 或 信道 ， 它 反应 了 每个 IP地址 使用 公用 线路 的 比例 ， 对于 按 连接时间 计费 的 线路 ， 也 具有 一定 的 参考 作用 ， 因为 一般 连接时间 越长 ， 传送 的 数据量 也 越 多 。 　 　 流量 数据 的 收集 是 通过 SNMP 完成 的 。 SNMP 是 一套 标准 的 网络管理 协议 ， 在 SNMP 环境 下 ， 网络管理 是 由 网络管理 工作站 NMS 和 一些 被 管理 的 网络设备 如 主机 ， 中断 服务器 ， 路由器 等 构成 的 。 网络设备 上 的 SNMP 代理 监测 和 控制 网络设备 ， 如 它 收集 各种 网络管理 信息 ， 包括 端口 流量 ， 从 一个 源 IP地址 到 目的 IP地址 的 流量 等 。 为了 让 路由器 记录 该类 信息 ， 必须 在 想要 计费 的 那个 路由器 的 端口 的 配置 里 加入 一行 ： IPAccounting 。 NMS 和 SNMP 代理 之间 则 通过 SNMP 协议 交换 管理 信息 ， 执行 管理 功能 。 管理 信息 的 交换 是 通过 SNMP 协议 数据 单元 PDU 完成 的 ， 在 SNMP 协议 中 ， 有种 基本 的 PDU ， 它们 是 ： GetrequestPDU ， GetnextrequestPDU ， GetresponsePDU ， SetrequestPDU ， TrapPDU 。 数据 收集 的 具体 过程 是 在 网管 工作站 上 启动 一个 数据 收集 进程 ， 它 根据 配置文件 确定 收集 数据 的 行为 。 配置文件 中有 被 收集 数据 路由器 的 名字 ， IP地址 ， Community 名字 ， 收集 间隔 ， 数据 存放 地址 等 可 修改 的 配置 信息 。 数据 收集 进程 根据 这些 配置 信息 ， 读取 相应 路由器 的 信息 并 保存 。 被 收集 数据 的 类型 与 各个 网络 厂商 的 MIB 定义 有关 ， 如 在 Cisco 公司 的 路由器 中 ， 对 MIB 对象 标志符 LIPCKAccountingTable 进行 记录 ， 就 可以 获得 经过 边界 路由器 的 每个 IP 连接 的 源地址 和 目标 地址 所 传送 的 IP 包数 和 IP 字节数 ， 它 反映 了 区域 网 内 每个 IP地址 到 网外 的 流量 。 　 　 记账 管理 在 已 收集 的 IP 数据 流量 的 基础 上 进行 ， 它 要 把 每个 IP地址 的 进出 流量 按照 一定 的 策略 进行 统计 。 在 统计 时 ， 要 考虑 以下 两个 与 记账 有关 的 因素 ： 　 　 对于 目的 地址 不同 的 IP 流量 ， 由于 经过 的 线路 不同 ， 费用 也 就 不 一样 。 因此 ， 可以 建立 一张 目的 地址 范围 与 费率 常 对应 的 流量 费率 表 。 　 　 IP 流量 发生 的 时间 分为 高峰期 ， 低谷 期等 不同 的 时间段 。 对 不同 时间段 内 的 流量 采取 不同 的 收费 率 ， 这样 可 调节 网络流量 ， 尽量减少 拥塞 并 利用 空闲 线路 时间 。 因此 还 需要 一张 时间段 费率 表 ， 含有 时间段 与 费率 的 对应 关系 。 　 　 另外 ， 对于 单位 或 子网 的 计费 ， 要 通过 对 每个 IP地址 汇总 完成 。 所以 还 需要 IP地址 范围 与 单位名称 的 对应 关系 。 这 两张 表 的 费率 常数 应该 由 相应 的 网络管理 机构 决定 。 在 统计 时 ， 采用 对 原始 收集 数据 顺序 一次 扫描 ， 目的 地址 范围 逐个 匹配 的 方法 。 对于 发送 的 数据 ， 如果 目的 地址 与 某项 中 的 地址 范围 匹配 ， 则 取 该项 的 费率 常数 ， 否则 继续 向下 比较 。 对于 本地 接收 的 数据 ， 当 目的 地址 与 本地 地址 范围 一致 时 ， 则 要 用 源地址 作 匹配 。 由于 表中 的 值 都 可以 随时 根据 需要 修改 ， 因此 ， 统计 是 非常灵活 的 。 整个 系统 实现 的 过程 如图所示 ： 图 IP 流量 计费 系统 实现 过程 　 　 该 计费 系统 只是 处理 一个 边界 路由器 时 的 情况 。 当 存在 多个 出口 时 ， 统计 的 原理 仍然 相同 ， 但 需要 从 多个 路由器 上 收集 数据 ， 统计 也 要 根据 多个 数据 流量 文件 汇总 完成 。 　 　 但是 ， 网络 收费 最终 要 对 用户 进行 ， IP地址 并不一定 代表 用户 信息 ， 那么 如何 确定 用户 呢 ？ 我们 作 如下 讨论 ： 　 　 用户 申请 一个 合法 的 固定 IP地址 ， 用户 通过 该 IP地址 访问 Internet ， 计费 系统 根据 该 IP地址 流量 信息 计费 。 　 　 对于 集团 用户 上网 ， 由 DHCP 分配 IP地址 ， 并 由 计费 系统 根据 单位 整体 计费 ， 再 由 各 单位 向 用户 收取 费用 ， 用户 访问 不 受限制 。 结论 　 　 当今 的 网络 管理系统 产品 ， 比如 SUN 公司 的 SUNNetManager ， IBM 公司 的 Netview 等 都 需要 较 好 的 一台 工作站 来 支持 ， 网管 产品 本身 又 比较 昂贵 ， 而且 都 没有 提供 现成 的 网络 计费 功能 。 使用 JAVA 网络 编程 实现 灵活性 比较 高 ， 易于 开发 出 跨平台 的 系统 ， 既 可以 运行 在 UNIX 工作站 上 ， 又 可以 运行 在 NT PC机 上 ， 对 硬件 要求 较 低 。 软件设计 平台 采用 具有 Windows 特征 的 开发 软件包 ， 通过 调用 WinSNMP 和 WinMIB 库函数 实现 数据 采集 ， 符合国际 COM 组件 开发 标准 ， 也 避免 了 计费 系统 在 不同 平台 上 的 重复 开发 和 移值 。 作者 单位 ： 上海大学 通信 工程系 ， 上海 参考文献 InternetsStructureandIdenticalofManagementInformationforTCPIPBaseRFCASimpleNetworkManagementProtocalRFC 周 明天 ， 汪勇编 TCPIP 原理 与 技术 北京 ： 清华大学出版社 石 冰心 中国 教育 和 科研 计算机网 的 研究 与 发展 武汉 ： 华中理工大学 出版社