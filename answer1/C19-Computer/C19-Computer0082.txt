计算机 应用 ComputerApplications 年 第卷 　 第期 Vol 　 NoDelphi 中 的 多线程 编程技术 王 　 红 　 赵国 红 　 　 前言 　 　 Windows 是 基于 线程 的 多任务 操作系统 ， 它 支持 两种 形式 的 多任务 机制 ， 一种 是 基于 进程 的 ， 这 也 是 Windows 从 一 开始 就 支持 的 多任务 类型 。 进程 是 指 正在 执行 着 的 程序 。 在 基于 进程 的 多任务 环境 下 ， 多个 程序 可以 并发 地 执行 。 第二种 多任务 类型 是 基于 线程 的 。 线程 是 进程 的 一个 执行 流 ， 多个 线程 可以 并发 地 执行 于 同一个 进程 中 。 Delphi 充分利用 了 Windows 的 多线程 机制 而 提供 了 对 线程 编程 的 支持 ， 这 也 是 Delphi 与 Delphi 的 重大 区别 之一 。 利用 这种 机制 能 编写出 很 高效 的 程序 。 　 　 既然 多个 线程 可以 并发 地 执行 于 同一 进程 中 ， 那么 协调 线程 间 的 执行 顺序 ， 以 避免 对 临界 资源 的 使用 而 引起 冲突 就 十分 重要 。 　 Delphi 中线 程 对象 　 　 在 Windows 操作系统 下 ， 编写 基于 线程 的 程序 可以 利用 应用程序 接口函数 （ API ） ， 也 可以 使用 Delphi 中线 程 对象 （ TThread 对象 ） 。 线程 对象 可 使 编写 多线程 程序 更 简单 、 高效 、 易读 。 线程 对象 （ TThread 提供 了 许多 特性 和 方法 （ 成员 函数 ） ， 只要 根据 需要 对 这些 函数 和 方法 重写 ， 就 可以 在 程序 中 实现 多线程 机制 。 下面 对 TThread 对象 的 方法 和 特性 进行 详述 。 　 线程 对象 的 特性 　 　 FreeonTeiminate 特性 ： 布尔 型 ， 只 可 在 运行 时 使用 。 当 线程 结束 时 ， 该 特性 决定 是 由 VCL （ 可视 构件 ） 自动 清除 线程 对象 还是 由 你 自己 负责 清除 。 当为 True 时 ， 自动 清除 。 默认值 为 False 。 　 　 Thandle 特性 ： 线程 句柄 ， API 中 大多数 线程 函数 需要 使用 该 句柄 。 　 　 Priority 线程 的 优先级 特性 ， 只能 在 运行 时 使用 ， 后 文中 有 详述 。 　 　 RetuinValue 特性 ： 整数 类型 ， 受 保护 特性 　 　 （ Protected ） ， 该 特性 指示 线程 的 执行 成功 与否 。 　 　 Suspended 特性 ： 布尔 型 ， 用于 决定 线程 是否 挂 起 ， 当值 为 True 时 ， 挂 起 线程 。 　 　 Teuminated 特性 ： 布尔 型 ， 且 是 受 保护 的 Protected ， 只读 。 该 特性 决定 线程 是否 停止 执行 ， 如该 特性 值为 True 时 ， 线程 执行 结束 。 　 　 ThreadID 特性 ： 线程 标识符 ， 有 的 API 线程 函数 使用 该 标识 。 　 线程 对象 的 方法 　 　 线程 对象 的 方法 有 很多 ， 介绍 常用 的 几种 方法 如下 ： 　 　 DoTeiminate 方法 　 该 过程 只能 由 线程 对象 内部 方法 调用 ， 用于 与 主 VCL 线程 的 同步 ， 并 产生 Onteiminate 的 事件 ， 一般说来 ， 当 线程 终止 时 ， 线程 会 自动 调用 该 方法 ， 不 需要 写 代码 。 　 　 Execute 过程 　 该 方法 开始 一个 线程 的 执行 ， 你 必须 在线 程类 中 ， 重写 该 过程 ， Execute 方法 返回 时 ， 终止 线程 的 执行 、 释放 线程 所 占 资源 ， 并 调用 Onteinate 事件 过程 。 Execute 方法 必须 周期性地 检测 Teiminate 特性 ， 该 特性 一旦 为 True ， Execute 必须 立即 返回 。 　 　 Resume 过程 　 该 方法 恢复 一个 被 挂 起 的 线程 的 执行 。 　 　 Suspend 过程 　 该 方法 挂 起 一个 线程 的 执行 ， 它 和 Rosume 方法 是 配对 的 。 　 　 Synchronize 过程 　 在 Delphi 的 多线程 编程 中 ， 各种 VCL 构件 都 是 临界 资源 ， 只能 由 主线 程 使用 ， 其它 的 线程 要 使用 这些 VCL 构件 ， 必须 使用 Synchronize 方法 ， 避免 多线程 与 VCL 构件 的 冲突 ， 该 过程 带 一个 TThreadMethod 类型 的 参数 。 　 　 Teiminate 过程 　 该 方法 设置 Teiminated 特性 为 True ， 并 终止 你 的 线程 的 执行 。 　 　 WaitFor 函数 　 该 方法 等待 线程 执行 的 终止 ， 然后 返回 ReturnValue 特性 的 值 ， 因此 ， 在 调用 该 函数 后 ， 必须 确保 线程 的 退出 。 另外 ， 如果 线程 使用 了 Synchronize 方法 ， 则 不要 在 主线 程中 调用 WaitFor ， 因为 这样一来 易 引起 死锁 ， 或 导致 Ethread 例外 的 发生 。 　 　 Onterminate 过程 　 该 过程 是 Onterminate 事件 的 驱动程序 。 Onterminate 事件 发生 在线 程 的 Execute 方法 已经 返回 ， TThread 结束 线程 之前 ， 该 事件驱动 只 可 在 主线 程 使用 ， 可以 调用 各种 VCL 方法 和 特性 。 　 创建 Delphi 中 的 线程 对象 　 　 Delphi 环境 中 ， 线程 对象 是 始视 对象 Tobject 的 直接 派生类 ， 它 和 其它 的 Delphi 构件 和 对象 不同 ， 不能 在 程序 中 直接 使用 ， 而 必须 从 TThread 对象 中 产生 一个 派生类 ， 并 对 其中 的 某些 成员 函数 进行 重写 以 覆盖 （ Override ） TThread 对象 中 的 方法 ， 完成 自己 的 功能 。 在 Delphi 中 可以 直接 书写 代码 创造 自己 的 线程 类 ， 也 可能 和 Delphi 的 线程 生成器 来 创建 原始 的 公用 代码 ， 而后 再 在 此基础 上 修改 。 　 线程 的 启动 、 终止 和 优先级 　 　 线程 的 启动 和 终止 是 线程 生命周期 中 的 起点 和 末点 ， 在线 程 的 生命周期 内 还有 它 的 各种 状态 ， 例如 挂 起 和 恢复 。 　 线程 的 启动 　 　 这 分为 两种 情况 ， 其一 ， 线程 一旦 被 创建 ， 它 就 开始 执行 。 其二 ， 线程 被 创建 后 ， 处于 挂 起 状态 ， 而 不 被 立即 执行 ， 要 想 执行 ， 必须 调用 线程 的 Resume 方法 。 至于 为什么 会 挂 起 ， 与 它 的 构造函数 有关 。 　 线程 的 终止 　 　 线程 的 终止 分为 以下 几种 情况 ： 一为 自然 终止 ， 即 线程 执行 完后动 结束 线程 ； 其二 为 强制 终止 ， 即 在线 程 正在 执行 时 ， 我们 强制 调用 线程 的 Terminate 过程 ； 其三 为 在 执行 线程 中 发生 了 Ethread 例外 从而 引起 线程 的 终止 。 在线 程 的 Execute 方法 返回 之后 ， 但 在线 程 结束 之前 ， 它 调用 线程 的 Onteiminate 过程 。 　 线程 的 挂 起 和 恢复 　 　 在线 程 的 执行 当中 ， 我们 可以 通过 调用 Suspend 方法 或 设置 Suspended 特性 为 True 而 暂停 线程 的 执行 ， 节约 的 CPU 时间 以加 其它 线程 的 执行 ， 当 我们 调用 线程 的 Resume 方法 时 ， 它 又 恢复 线程 的 执行 。 　 线程 的 优先级 　 　 每 一个 线程 都 与 一个 优先级 相连 ， 线程 的 优先级 用于 确定 线程 对 CPU 时间 的 划分 ， 线程 的 优先级 用 线程 的 Priority 特性 来 设置 。 　 　 在 Delphi 中 ThreadPriority 枚举 类型定义 了 优先级 所有 可能 的 值 。 　 　 tpIdle ： 这是 线程 的 最 低优先级 ， 只有 当 系统 闲置 时 ， 该 优先级 的 线程 才 被 执行 。 　 　 tpLowest ： 该 优先级 比 正常 优先级 （ tpNormal ） 低个 点 。 　 　 tpNormal ： 正常 优先级 。 　 　 tpHigher ： 该 优先级 比 正常 优先级 高 一个点 。 　 　 tpHighest ： 该 优先级 比 正常 优先级 高个 点 。 　 　 tpTimeCritical ： 线程 的 最高 优先级 。 　 结语 　 　 用 delphi 实现 多线程 编程 是 简洁 和 方便 的 ， 它 把 开发 的 重点 放在 了 如何 重载 线程 类 的 Execute 函数 上 ， 避免 了 和 操作系统 的 过 多 的 交互 ， 在 较 高 一级 的 层次 上 实现 了 多线程 编程 。 作者 单位 ： 王 　 红 　 潍坊 高等 专科学校 计算机系 　 山东 ． 潍坊 　 　 　 　 　 赵国 红 　 山东省 水利厅 南办 　 山东 ． 济南 　 　 收稿 日期