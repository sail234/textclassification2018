微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 年 第卷 第期 VolNoCKC 单片机 PTS 功能 在 数据 采集 中 的 应用 吕 治安 　 　 摘 　 要 ： 结合 开发 一种 电力 仪表 中 的 应用 ， 介绍 了 在 数据 采集 中 利用 CKC 单片机 的 PTS 功能 的 具体方法 。 　 　 关键词 ： CKC 单片机 　 数据 采集 　 PTS 功能 　 　 在 计算机 应用 系统 中 ， 通常 是 通过 定时 中断 的 方式 来 实现 定时 采样 的 ， 但 采用 普通 的 中断 工作 方式 时 ， CPU 要 执行 保护 断点 转入 中断 服务 、 保护 现场 、 恢复 现场 、 返回 等 一系列 操作 ， CPU 开销 较大 ， 在 CPU 任务 较重 和 采样 数据 较 多 的 情况 下 显得 更为 突出 。 为此 ， INTEL 公司 在 CKC 单片机 中 提供 了 一种 外部 事件 服务器 PeripheralTransactionServer 简称 PTS 功能 。 PTS 是 通过 其 内部 提供 的 微 代码 ， 而 不是 用 中断 服务程序 来 实现 对外 设 的 管理 的 ， 故 具有 速度 快 、 CPU 开销 小 等 特点 。 下面 结合 我们 在 开发 一种 电力 仪表 中 的 应用 对 其作 一 介绍 。 　 PTS 功能 　 　 PTS 是 一种 利用 其 内部 的 微 代码执行 的 操作 ， CPU 进入 PTS 周期 后 ， 其 操作 像 DMA 一样 插入 到 正常 的 指令流 中 ， 不 需要 额外 的 软件 开销 。 CKC 的 个 中断 源 都 可以 映射 到 PTS 。 　 　 与 中断 类似 ， PTS 也 有 个 PTS 向量 表 ， 共个 字 位于 H ～ CH 。 它 的 排列 顺序 和 C 中 的 种 外设 中断 一一对应 ， 且 优先级 也 相同 。 若 某 一 外设 的 PTS 功能 被 打开 ， 在 该 外设 产生 中断 后 ， CPU 便 不会 进入 中断 服务程序 （ 不论 该 中断 是否 打开 ） 而 直接 进入 PTS 工作 周期 。 在 PTS 结束 时 ， 也 可 产生 个 END － OF － PTS 中断 ， 如果 需要 ， 可 进入 该 外设 的 中断 服务程序 。 与 中断向量 不同 的 是 ， 每个 PTS 向量 不是 指向 段程序 ， 而是 指向 个 PTS 控制 块 （ PTSCB ） ， 每个 控制 块 包含 B ， 它们 必须 驻留 于 内部 RAM 中 ， 其首 地址 必须 能 被 除尽 。 CKC 提供 了 种 PTS 模式 ， 即次 传送模式 、 块 传送模式 、 AD 模式 、 HSI 模式 和 HSO 模式 。 其 PTSCB 的 格式 如图 。 在 控制 块 中 PTSCON 用于 控制 PTS 的 工作 方式 ， 不同 的 模式 其 PTSCON 稍 有 不同 。 单元 根据 其 模式 的 不同 ， 分别 为 其源 、 目的 地址 、 中间 结果 暂存 单元 指针 等 。 在 进入 PTS 之前 ， PTSCB 必须 初始化 。 　 　 为 控制 PTS 的 工作 ， CKC 内部 设有 个位 的 寄存器 PTSSELPTSSRV ， 其 作用 分别 和 中断 屏蔽 寄存器 中断 挂号 寄存器 相仿 ， 二者 格式 也 完全相同 ， 如图 。 要 打开 某一 外设 的 PTS 功能 ， 只 需 将 PTSSEL 中 相应 位置 为 “ ” 即可 。 综上所述 ， 当 把 某 外设 的 PTS 功能 打开 ， 并 设置 好 其 PTSCB 后 ， 该 外设 产生 中断 申请 后 ， 便 不会 进入 其 相应 的 中断 服务程序 ， 而 进入 PTS 周期 。 CPU 内微 代码 按 PTSCB 中 设置 的 工作 模式 及 要求 的 次数 执行 操作 ， PTS 操作 完成 后 ， 便 将 PTSSRV 中 相应 位置 “ ” ， PTSSEL 中 相应 位清 “ ” ， 引发 EDN － OF － PTS 中断 。 该 中断 即 映射 到 这 一 外设 的 中断 。 进入 END － OF － PTS 中断 后 ， PTSSRV 中 相应 位 被 自动 清 “ ” ， 但 PTSSEL 中 的 位 却 不能 被 自动 置 “ ” ， 故 也 禁止 了 该 外设 再次 进入 PTS 服务 。 要 想 再次 进入 PTS ， 必须 在 适当 的 地方 ， 比如 在 END － OF － PTS 中 ， 通过 软件 将 PTSSEL 中该 位 再次 置 为 “ ” 。 　 　 　 　 　 　 　 　 　 　 　 　 　 PTS 的 AD 模式 及其 工作 原理 　 　 在 我们 研制 的 仪表 中 ， 要求 每周 波次 ， 每次 进行 个 数据 的 AD 采样 。 这里 采用 了 每 周期 执行 次 PTS 服务 ， 每 进入 次 PTS 周期 ， CPU 自动 进行 次 AD 采样 。 　 　 系列片 的 AD 转换 有 一 命令 寄存器 ， 用来 选择 AD 通道 和 AD 启动 方式 。 AD 启动 方式 有 立即 启动 和 HSO 时间 到 启动 种 。 　 　 所谓 立即 启动 是 在 将 命令字 写入 命令 寄存器 后 AD 就 立即 开始 工作 ， 而 HSO 时间 到 是 在 写入 命令字 后 在 HSO 预定 时间 到 时 才 开始 启动 AD 转换 。 这里 每个 采样 点 的 第次 采样 命令 是 在 后台程序 写入 命令 寄存器 的 ， 并用 HSO 时间 到 启动 的 方式 启动 AD 转换 。 第次 AD 转换 结束 后 便 引发 AD 结束 中断 ， 进入 PTS 周期 ， 转换 结果 的 读取 和 此后 的 次 转换 由 PTS 以 立即 启动 AD 的 方式 完成 。 PTS 服务 周期 完成 后 引发 END － OF － PTS 中断 ， 在 该 中断 里 进行 后续 处理 ， 如 收集 采样 数据 、 再次 设置 PTSSEL 和 PTSCB 等 。 这里 PTSSEL 的 设置 只须 在 适当 的 地方 将 PTSSEL 置 为 “ ” 即可 。 PTSCB 中 PTSCON 的 格式 如见 图 。 　 　 PTSCB 中 的 UPDT 用来 控制 SD 的 修改 与否 ， 若 UPDT ＝ ， 则 每次 AD 转换 结束 后 ， SD 会 经过 修正 后 指向 表格 中下 一 位置 ； 若 UPDT ＝ ， 则 SD 不会 修改 而 仍然 指向 原来 位置 。 而 M 、 M 、 M 等位 用来 控制 PTS 模式 。 因此 ， 这里 可设 PTSCON ＝ AH 。 　 　 PTSCB 中 的 SD 是 个 指针 ， 它 指向 个 表格 ， 该表 可 位于 内部 RAM ， 也 可 位于 外部 RAM ， 用来 存放 启动 AD 的 命令 和 AD 转换 后 的 结果 。 PTSCB 中 的 REG 也 是 个 指针 ， 它 指向 个 固定 的 存储单元 ， 该 单元 用来 暂存 AD 的 命令字 ， 在 PTS 执行 过程 中 ， CPU 先 把 表格 中 的 AD 命令 暂存 于 此 ， 然后 再 将 命令 从 这个 单元 写入 AD 的 命令 寄存器 中 。 　 　 硬件 纵横 单片机 开发 专题 在 本 仪表 里 ， 我们 在 每个 采样 点里 分别 对 AD 的 ～ 通道 进行 共次 采样 ， 由于 第次 AD 采样 的 启动 必须 在 其它 程序 里 进行 ， 故 表格 中 的 第个 命令 是 AD 通道 的 启动 命令 。 这里 设定 PTSCB 位于 内部 RAM 中 的 H 处 ， 表格 位于 外部 RAM 中 的 H 处 ， 共 占 B ， 如图 。 　 软件设计 　 　 如前所述 ， CKC 单片机 在 每周 波 进行 次 采样 ， 每 半个 周波 采样 次 ， 即 进入 次 PTS 方式 ， 各 采样 点 的 时刻 分布 如图 。 因此 与此有关 的 软件设计 有 以下 点 ： 　 　 ． 在 交流电 的 过 零点 处 产生 一 中断 ， 这里 是 利用 HSI 跳变 中断 ， 在 这个 中断 里 设定 HSO 的 个 定时 事件 ， 同时 初始化 第次 PTS 服务 所 需 的 PTSCB ， 并设 PTSSEL ＝ H 。 当 事件 发生 时 启动 AD 转换 ， 第次 AD 转换 结束 后 引发 AD 结束 中断 ， 进入 PTS 服务 。 　 　 ． 在 END － OF － PTS 中断 里 读取 次 AD 转换 的 结果 ， 并 重置 PTSCB 和 PTSSEL ， 为 下次 进入 PTS 做好 准备 。 待 下次 HSO 事件 发生 后 启动 AD 转换 ， 从而 再次 进入 PTS 服务 。 　 　 综上所述 ， CKC 单片机 的 PTS 功能 为 实现 高速 多次 采样 提供 了 一种 有力 的 手段 ， 运用 PTS 服务 可 有效 地 减少 CPU 的 额外 开销 、 提高 了 CPU 的 利用率 、 为 CPU 进行 更为 复杂 的 运算 提供 了 有力 的 支持 。 作者 单位 ； 湖北省 襄樊市 东街 号 参考文献 　 　 孙涵芳 INTEL 位 单片机 北京 ： 北京航空航天大学 出版社 ， 收稿 日期 ：