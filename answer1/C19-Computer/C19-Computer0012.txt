计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNo 混合 编程 与 Fortran 计算 程序 可视化 张志华 　 王林江 　 吕庆风 　 　 摘 　 要 　 本文 探索 了 用 VCFortranOpenGL 进行 混合 编程 的 方法 。 该 方法 充分发挥 了 三种 语言 各自 的 优点 ， 既 能 设计 出 画面 丰富多彩 ， 方便 人机对话 的 界面 ， 又 能 最大 限度 利用 已有 的 用 Fortran 语言 编写 的 程序 资源 ， 并 实现 计算结果 的 可视化 。 用 作者 已有 的 用 Fortran 语言 编写 的 源程序 进行 了 尝试 ， 结果 良好 。 　 　 关键词 　 VCFortranOpenGL ， 混合 编程 ， 可视化 PROGRAMMINGONMECHANICSCALCULATIONWITHMIXEDLANGUAGESZhangZhihua 　 WangLinjiang 　 L ü QingfengNanjingUniversityofAeronauticsandAstronauticsJiangsuNanjing 　 　 Abstract 　 UsingVCtodesigncolorfulfriendlyinterfaceusingFortrantocalculateusingOpenGLtodrawthispaperdwellsonprogrammingwithmixedlanguagestothefulladvantageofeveryoneItisvaluableformanyprocedurescompiledinFortranbeforetobeVisualizedforbetteruseTheattemptwithexistedsoftwarecompiledbyauthorsresultsinsuccess 　 　 Keywords 　 VCFortranOpenGL ， ProgrammingwithmixedlanguagesVisualization 　 引言 　 　 现有 的 机械设计 ， 力学 计算 ， 工程 分析 软件 ， 大多 都 是 用 Fortran 语言 编写 的 。 近年来 微软公司 推出 的 PowerStation 软件 ， 推出 新 的 Fortran 语言 ， 以及 与 VC 一样 的 工作 平台 Developerstudio ， 现在 通过 混合 编程 Fortran 程序 可以 溶合 在 VC 程序 中 。 这种 混合 编程 的 概念 具有 普遍意义 ， 即 可以 提供 一种 通用 而且 简便 方法 ， 来 改造 已有 的 Fortran 程序 ， 使 其 拥有 一个 全新 的 Windows 界面 ， 便于 用户 使用 。 　 混合 编程 的 思路 　 　 大多数 Fortran 程序 是 按照 这样 一条 方式 工作 的 ： 首先 是 通过 屏幕 或 原始数据 文件 输入 数据 ， 进行 运算 ， 运算 结束 后 ， 把 计算结果 保存 有 数据文件 中 。 在 这 一 过程 中 原始数据 的 准备 是 十分 繁琐 和 容易 出错 ， 计算结果 的 阅读 也 是 十分 费神 的 。 现在 可以 方便 地 应用 VC 的 对话框 获得 参数 ， 利用 文档 类来 保存 计算结果 或 进行 磁盘操作 ， 利用 视窗 类 显示 结果 ， 利用 OpenGL 库函数 绘制 云图 、 立体图 或 曲面 。 至于 计算 和 保存 中间 结果 则 仍 由 Fortran 完成 。 　 VC 与 Fortran 混合 编程 的 规则 　 　 由于 同属 微软 家族 ， 且 使用 同一 平台 ， 这 两种 语言 之间 的 沟通 是 非常 方便 的 。 一般 在 文档 类 CPP 文件 的 前面 加上 　 　 externC 　 　 　 　 void — 　 stdcall 函数 名 数据类型 　 　 然后 在 需要 计算 处 加上 函数 名 传送 的 变量 ， 传送 的 数组 ， 这里 需要 指出 的 是 ， 此种 混合 编程 要求 数据 是 以 引用 形式 传递 的 ， 另外 传递 数组 前 ， 必须 为 其 开辟 专用 内存 ， 并 在 数据 存盘 后 及时 清除 。 同时 ， 将 原 Fortran 程序 进行 改造 ， 将 其 主程序 变成 Subroutine 或 Function ， 并 加上 与 VC 中 的 传递函数 的 传递 变量 同样 多 的 哑元 ， 关于 数据类型 的 转换 ， 一般 是 float 对 real ， double 对 realint 对 integer 。 最后 的 关键 两步 是 ： 通过 Insert 菜单 中 的 FilesintoProject 命令 将 Fortran 程序 嵌入 VC 的 框架 中 ， 通过 Build 菜单 中 的 settings 命令 在 Link 选项 中 加上 Libfmtlib 在 defaultlibry 中 注明 Libfcmtlib 并 将 CC 选项 中 加上 Multithreaded 将 Fortran 选项 中 加上 Multithreaded 和 Fulloptimization 。 　 文档 生成 与 派生 　 　 文档 类 通过 CtypedPtrArray 类 模版 生成 CobArray 派生类 对象 保存 最终 结果 ［ ］ ［ ］ 传统 的 Fortran 程序 对 成员 变量 封装 性差 ， 另外 保存 或 打开 数据文件 也 有些 繁琐 ， 而 利用 类 的 概念 利用 Serialize 函数 可以 轻易 解决 这个 问题 ， 而且 利用 从 CobArray 类中 继承 下来 的 AddGetAtGetSize 函数 很 方便 地 实现 数据 的 添加 和 查找 。 　 视窗 类 绘制 数据 曲线 　 　 视窗 类 首先 通过 样条 函数 对 数据 进行 处理 ， 然后 确定 映射 方式 ， 通过 逻辑 坐标 与 设备 坐标 的 转换 ， 确定 坐标 原点 ， 调用 画笔 ， 连接 曲线 。 　 利用 OpenGL 对 结果 进行 后置 处理 　 　 OpenGL 是 SGISUNHPDECMicrosoft 公司 推出 的 三维 图形 开发 标准 ， 由于 十分 方便 实用 ， OpenGL 已 成为 三维 图形 的 通用 标准 。 OpenGL 可以 在 工作 平台 Developstadio 上 调试 ， 另外 也 可以 嵌入 VC 框架 中 的 视窗 类里 ， 纹理 映射 ， 特殊 光 和 特殊效果 处理 ， 三维动画 是 OpenGL 的 优势 ， 利用 此 技术 可以 立体 再现 结果 ， 可以 从 各个 角度观察 模型 ， 通过 色彩 的 变化 ， 反映 出 应力场 的 分布 。 需要 指出 的 是 要 通过 Build 菜单 中 的 settings 命令 在 Link 选项 中 加上 opengllibglulibglauxlib 。 　 　 将 OpenGL 嵌入 视窗 类中 ， 关键 是 编写 bSetupPixelFormat 代码 将 一个 象素 格式 描述符 结构 和 当前 设备 上下文 关联 起来 　 BOOLCCubeViewbSetupPixelFormatstaticPIXELFORMATDESCRIPTORpfdsizeofPIXELFORMATDESCRIPTOR 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 sizeofthispfd 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 versionnumberPFD — DRAW — TO — WINDOW 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 supportwindowPFD — SUPPORT — OPENGL 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 supportOpenGLPFD — DOUBLEBUFFER 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 doublebufferedPFD — TYPE — RGBA 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 RGBAtype 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 bitcolordepth 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 colorbitsignored 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 noalphabuffer 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 shiftbitignored 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 noaccumulationbuffer 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 accumbitsignored 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 bitzbuffer 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 nostencilbuffer 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 noauxiliarybufferPFD — MAIN — PLANE 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 mainlayer 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 reserved 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 layermasksignored 　 PowerStation 软件 新 功能 　 　 PowerStation 软件 已 被 广泛应用 ， 但 由于 缺少 必要 的 使用指南 ， 造成 了 其 许多 功能 没有 被 充分利用 ， 现 针对 混合 编程 介绍 其中 的 关键 功能 。 　 强大 的 Debug 调试 功能 　 　 在 Developerstudio 工作 平台 中 ， 调试程序 检查 错误 异常 方便 ， 选择 Infoviewer 工具条 中 的 FPSbooksonline 点击 ProjectWokspace 窗口 的 Infoview 工具 按 扭 ， 则 该 窗口 显示 书中 的 许多 专题讨论 ， 双击 BuilderError 专题 ， 将 显示 CompileerrorLinkerToolserrorRuntimeerrorMatherror 等 分 专题 ， 详细 介绍 了 各种 错误 的 原因 。 如果 编译 连接 通过 ， 但 结果 不 正确 ， 则 可以 选择 Build 菜单 中 Debug 命令 ， 选择 runtocursor ， 执行 到 可能 发生 数据 传递 错误 处 ， 则 出现 Debug 调试 窗口 ， 在 此 状态 下 ， 各个 变量 ， 数组 的 当前 值 都 可 在 屏幕 上 显示 ， 在 选择 单步 执行命令 ， 通过观察 变量 的 变化 可以 判断 数据 是否 正确 传递 。 这种 功能 对于 混合 编程 尤其 重要 ， 因为 数据 传递 对于 混合 编程 起着 决定 作用 。 　 利用 PowerStation 提供 的 数学 库 ， 精减 源程序 　 　 PowerStation 提供 了 各 动态 连接 库 ， 覆盖 了 工程 数学 的 各个方面 ， 这样一来 ， 如果 涉及 到 数学 运算 ， 我们 完全 不必 写 与此有关 的 源代码 ， 也 不用 拷贝 与此有关 的 源代码 ， 因为 它们 是 以 动态 连接 库 形式 存在 ， 只 需写 CALL 所要 库函数 名 即可 ， 如何 得到 所 要 库函数 名 ？ 选择 Infoviewer 工具条 中 的 FPSbooksonline 点击 ProjectWokspace 窗口 的 Infoview 工具 按 扭 ， 则 该 窗口 显示 书中 的 许多 专题讨论 ， 双击 IMSLlibrariesReference 专题 将 显示 如下 三 各库 ， IMSLMathLibrary 通用 数学 库 包含 微分 积分 矩阵 运算 等 ， IMSLstatLibrary 数理统计 库 ， IMSLMathLibrarySpecialFunction 特殊 函数库 。 打开 所 需库 便 可 查寻 库函数 ， 双击 库函数 ， 便 出现 库函数 的 详细 使用 说明 ， 最后 一定 勿忘 在 程序 开头 加上 USEMSIMSL 表明 调用 数学 库 。 　 Fortran 语言 的 优越性 　 　 在 年代 ， 尽管 Fortran 语言 相当 普及 ， 但 许多 功能 更 强大 的 语言 象是 C 、 C 、 Ada 越来越 被 人们 采用 。 一个 ANSI 委员会 努力 推出 Fortran 标准 的 更新版 ， 年 ， 新 标准 的 技术 工作 宣告 完成 ， 此 标准 被 称为 Fortran 。 Fortran 与 Fortran 相比 主要 增加 了 如下 功能 数组 运算 、 模块化 设计 、 结构 类型 数据 与 类 、 指针 、 模块接口 ， 显而易见 这些 功能 将 大大 弥补 Fortran 语言 的 不足 ； 但是 由于 Fortran 语言 已 深入人心 ， 同时 这些 功能 使用 起来 与 C语言 的 同类 功能 相比 有些 不是 得心应手 。 但是 在 某些 特定场合 ， 适当 利用 Fortran 的 特点 ， 也 会 产生 较 好 的 效果 。 如 可以 将 主程序 与 各个 子 例程 subroutine 分为 不同 的 文件 ， 使 各 例程 成为 子 模块 ， 把 各个 子 模块 的 某些 变量 改造 成类 的 成员 变量 ， 这样一来 既 实现 了 模块化 设计 ， 条理清晰 ， 又 实现 了 变量 的 封装 ， 方便 其他人 使用 该 模块 ， 同时 也 对 其 进行 保护 。 　 混合 编程 实例 　 　 通过 作者 用 Fortran 语言 编写 的 用 特解 边界 元 求解 含 孔洞 ， 裂纹 的 各向异性 板 的 应力场 或 应力 强度 因子 的 程序 ， 利用 VCOpenGL 混合 编程技术 ， 生成 一个 界面 友好 ， 结果 形象 直观 的 Windows 程序 。 程序 主 界面 如图所示 ， 获取 参数 对话框 如图所示 。 图 　 程序 主 界面 图 　 获取 参数 的 对话框 　 　 绘制 云图 的 基本思路 是 在 板 上 划分 多个 小 网格 ， 将 网格 的 节点 共 （ 相邻 网格 有 公共 节点 ） 个 的 坐标 通过 Fortran 边界 元 程序 算 出 应力 值 σ x σ y τ xy ， 然后 求 出 最大 应力 ， 最小 应力 ， VonMises 相当 应力 ， 对 各种 应力 分别 在 最大值 于 最小值 中 划分 个 小 区间 ， 每个 区间 赋予 不同 的 色彩 ， 这样一来 每个 点 通过 应力 的 大小 就 有 了 色彩 坐标 ， 当 用 多个 带有 色彩 的 小 四边形 来 构造 板时 ， 云图 就 被 绘制 出来 。 最小 主应力 云图 如图所示 ， VonMises 相当 应力 云图 如图所示 。 图 　 最小 主应力 云图 图 　 VonMises 相当 应力 云图 　 结语 　 　 本文 探索 了 一种 改造 传统 Fortran 语言 编写 的 程序 的 通用 方法 ， 实践证明 此 方法 是 切实可行 的 。 该 通用 方法 的 提出 得益于 作者 对于 这 三种 语言 都 具有 一定 的 了解 ， 同时 由于 PowerStation ， VC ， OpenGL 工作 平台 的 统一 ， 使得 原本 复杂 的 问题 大大简化 。 该 方法 可以 使 这个 相对 陈旧 的 计算机 语言 焕发 生机 ， 但 最 主要 的 是 我们 可以 利用 以前 的 资源 ， 节约 大量 的 编程 时间 。 作者简介 ： 张志华 　 博士 研究生 。 研究 方向 ： 压电 陶瓷 机电 耦合 、 计算机 应用软件 。 　 王林江 　 副研究员 。 　 研究 方向 ： 计算 力学 。 　 吕庆风 　 研究员 。 研究 方向 ： 飞机 总体设计 。 作者 单位 ： 南京航空航天大学 　 江苏 南京 ） 参考文献 ［ ］ 　 陈启秀 ， 黄彻 为 计算机 常用 语言 混合 编程 南京 ： 南京大学 出版社 ： ［ ］ 　 RedwineCooperUpgradingtoFortranSpringerVerlagNewYorkInc ， ： ［ ］ 　 何 新贵 ， 徐祖渊 Fortran 中国 铁道 出版社 ： ［ ］ 　 MichaelJYoungVisulC 从 入门 到 精通 北京 ： 电子 工业 出版社 ： ［ ］ 　 ScottStanfieldRalphArvesenVisulC 开发人员 指南 北京 ： 机械 工业 出版社 ： ［ ］ 　 DavidJKruglinskiVisulC 技术 内幕 北京 ： 清华大学出版社 ： 收稿 日期 修改稿