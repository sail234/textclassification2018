计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNo 一个 DCS 组态 软件 的 设计 与 实现 徐晓东 　 杨振坤 　 　 摘 　 要 　 VisualBasic 和 VisualC 是 强大 的 可视化 编程 工具 ， 本文 结合 它们 各自 的 优点 介绍 如何 设计 和 实现 分布式 控制系统 的 工程师 站 和 操作员 站 软件 。 　 　 关键词 　 VisualBasic ， VisualC ， 分布式 控制系统 ， 组态 ， 软件 　 引言 　 　 分布式 控制系统 （ 集散 控制系统 ） 以 其 强大 的 控制 功能 、 可靠 的 安全 性能 和 良好 的 可移植性 而 在 国内外 工控 领域 获得 广泛应用 。 本文 结合 作者 与 化工部 化工机械 研究院 测控 所 合作 完成 的 LH 分布式 控制系统 ， 对于 其中 的 工程师 站 和 操作员 站 软件设计 作一 介绍 。 　 　 软件 采用 VisualBasic 和 VisualC 混合 编程 ， 充分运用 VB 强大 、 高效 的 界面 生成 能力 、 Access 数据库 功能 和 VC 易于 对 内存 、 硬件 操作 的 特点 。 同时 由于 VB 、 VC 都 是 微软 的 产品 ， 它们 相互之间 的 联接 也 很 容易 。 　 　 软件 运行 于 WIN 环境 下 ， 程序设计 采用 面向对象 的 结构化编程 思想 ， 将 系统软件 划分 为 既 有机 联系 而 又 相互 独立 的 几 部分 。 它们 彼此之间 或 直接 调用 ， 或 通过 动态链接库 连接 。 　 系统 软件体系结构 　 　 系统 软件体系结构 是 针对 系统 硬件 来 划分 的 。 LH 分布式 控制系统 硬件 分为 工程师 站 、 操作员 站 和 现场 控制站 。 相应 的 系统软件 是 ： 工程师 站 软件 、 操作员 站 软件 和 现场 控制站 软件 。 其中 工程师 站 、 操作员 站 位于 PC机 上 ， 而 现场 控制站 是 以型 单片机 为 处理器 的 智能 板 。 现场 控制站 软件 用 单片机 汇编语言 编写 ， 不是 本文 讨论 范围 。 　 　 　 　 PC 系统软件 包括 必要 的 初始化 采集 程序 、 用于 工程师 站 的 组态 程序 以及 操作员 站上 的 运行 程序 。 它们 都 是 独立 的 可执行文件 ， 相互间 通过 WIN 的 共享内存 通信 。 这样 软件 的 开发 可由多 人 协同 并行 完成 ， 同时 也 增强 了 软件系统 的 可靠性 并 利于 软件维护 和 升级 。 初始化 过程 要 设置 、 启用 PC机 的 相关 硬件 设备 （ 包括 扩展 的 智能 插卡 ） ， 初始化 完成 后 就 能 定时 接收 现场 控制站 采集 数据 。 系统 组态 需要 针对 不同 的 应用领域 先 离线 进行 ， 投入 运行 后 也 能 根据 现场 控制 情况 在线 组态 。 它 是 系统工程 师级 的 ， 有 操作 权限 制约 ， 必须 输入 合法 密码 才能 修改 。 运行 部分 提供 良好 的 人机交互 界面 ， 通过 它 就 能 实现 对 整个 现场 的 实时 监控 。 对于 具体 的 工程 ， PC 系统软件 执行 的 顺序 如图 。 图 　 系统 PC 软件设计 　 初始化 采集 程序 的 设计 　 　 初始化 采集 程序 是 工程项目 投入 运行 后 PC 系统软件 中 最先 被 执行 的 。 本 系统 采用 CANControlAreaNetwork 总线 。 操作员 站 由 PC机 插入 一块 ISA 总线 智能 光电 隔离 CAN 控制卡 组成 。 CAN 智能卡 和 计算机 之间 采用 DMA 通信 方式 。 所以 初始化 采集 程序 先 要 完成 对 CAN 卡 的 驱动 ， 使用 VC 提供 的 端口 输入输出 函数 outp 、 inp 即可 发送 对 CAN 卡 的 “ 握手 ” 信息 。 为了 实现 DMA 传输 ， 要 启动 选定 的 DMA 通道 。 这 在 WIN 下 并 不是 轻易 的 事情 ， 因为 WIN 几乎 接管 了 PC 的 全部 硬件 设备 ， 如果 仍象 DOS 下 那样 操作 DMA 势必 引起 死机 。 需要 借助 DDK 、 VToolsD 等 开发工具 编写 虚拟 设备 驱动程序 vxd ， 在 VC 应用程序 中 通过 CreateFile （ ） 打开 它 ， 利用 vxd 回传 地址 读取 DMA 通道 的 数据 。 　 　 初始化 软件 完成 的 另 一 工作 是 创建 共享内存 。 用 VC 的 WIN 函数 CreateFileMapping 、 MapViewOfFile 分别 创建 共享内存 和 获取 读写 共享内存 的 指针 。 在 DLL 中 相应 地用 OpenFileMapping 打开 前面 的 共享内存 映射 文件 句柄 ， 同样 通过 MapViewOfFile 获取 读写 共享内存 的 指针 。 这样 就 能 在 两个 应用程序 之间 建立 数据通道 。 共享内存 是 本 系统 的 关键环节 。 只有 利用 共享内存 才能 实现 VC 程序 和 VB 程序 之间 的 数据 传递 。 共享内存 还 能 提供 应用 程序接口 ， 这是 灵活 组态 的 关键 。 在 共享内存 中 预留 了 变量 数组 以供 组态 时用 ， 这些 变量 可以 看作 是 不同 应用程序 间 的 “ 全局变量 ” ， 用户 能够 在 VC 下 利用 预留 变量 编写 自己 的 处理程序 ， 然后 编译 连接成 满足 特定 需要 的 EXE 文件 。 　 组态 程序 的 设计 　 　 组态 程序 主要 分为 系统 组态 、 数据库 组态 、 回路 组态 、 流程图 组态 、 报表 组态 。 　 系统 组态 的 设计 　 　 系统 组态 是 针对 整个 控制系统 的 硬件 结构 进行 组态 ， 它 是 整个 工程项目 组态 的 第一步 。 本 系统 采用 工业 现场 总线 CAN ， 各 现场 控制站 和 操作员 站 的 基本 配置 信息 即 通过 系统 组态 来 设定 。 选择 投入 运行 的 现场 控制站 的 类型 、 个数 及 各自 的 站 号 ， 确定 操作员 站 站 号 ， 还 可以 设定 安全 保护 ， 对 操作员 的 操作 权限 和 操作 范围 进行 限定 。 最后 将 配置 信息 以 VB 中 的 mdb 数据库 文件 保存 并 下装 。 　 数据库 组态 的 设计 　 　 数据库 是 分布式 控制系统 的 信息 来源 。 一个 工程项目 中 所有 需要 监测 和 控制 的 点 都 在 数据库 组态 中 完成 。 根据 点 数据类型 的 不同 ， 数据库 组态 分为 模拟量 输入 ， 模拟量 输出 ， 开关 量 输入 ， 开关 量 输出 ， 计算 量 。 其中 计算 量 即 初始化 采集 程序 中 提供 的 应用 程序接口 变量 ， 从 本质 上 讲 也 是 模拟量 。 用户 使用 它 组织 自己 的 显示信息 ， 但 并 不 参与 输入输出 。 　 　 计算 量 的 组态 只要 定义 变量 名称 和 指定 在 预留 数组 中 的 位置 。 各 I O型 变量 的 组态 项目 有 基本 的 共同点 ， 如 名称 、 报警 、 存盘 和 IO 地址 ， 除此之外 还要 针对 变量 类型 和 监控 的 需要 来 设计 组态 项目 ， 以较 复杂 的 模拟量 输入 组态 为例 ： 　 　 索引 信息 ： 记录 号 ， 工位 号 。 　 　 显示 存储 信息 ： 点 名称 ， 工程 单位 ， 量程 转换 系数 ， 记录 类型 。 　 　 报警 信息 ： 信号 上 下限 ， 量程 上 下限 （ 信号 上 下限 对应 的 物理量 ） ， 报警 级别 ， 报警 上 下限 ， 报警 上 上 、 下 下限 。 　 　 IO 信息 ： 站 号 ， 板 号 ， 通道 号 。 　 　 仪表 类型 ： 指 测温 型 （ 如 热电偶 、 热敏电阻 ） ， 测 流量 型 （ 如 各种 流量计 ） ， 测 压力 型 等 检测 元件 的 不同 型号 。 因为 对 不同 类型 的 传感器 其 测量 数据 的 处理 方法 有别 。 　 回路 组态 的 功能 与 实现 　 　 在 完成 数据库 组态 后 就 可以 进行 回路 组态 ， 回路 组态 是 分布式 控制系统 组态 的 关键步骤 ， 主要 用于 连续 过程 控制 、 报警 检测 与 处理 、 确定 输入输出 回路 等 。 回路 组态 数据库 的 每一项 记录 包含 一条 完整 回路 的 必备 信息 。 利用 这些 信息 就 能 实现 对系统 的 控制 。 回路 组态 根据 其 输入输出 的 不同 分为 模入 模出 回路 ， 模入 开出 回路 ， 开 入 开出 回路 。 回路 组态 的 合理 与否 直接 影响 控制 质量 的 好坏 。 回路 组态 项目 有 ： 　 　 显示信息 ： 回路 名称 。 　 　 回路 类型 ： 由 回路 的 输入输出 变量 类型 而定 ， 在读 回路 组态 数据库 时 根据 它 来 选取 后面 组态 项目 中 需要 的 数据 。 　 　 IO 信息 ： 输入 点 、 ， 输出 点 。 它们 必须 是 数据库 组态 中 存在 的 变量 类型 。 　 　 报警 信息 ： 同 输入 点 的 报警 。 　 　 控制 信息 ： 开关 特性 （ 即 输出 是 正 作用 还是 反作用 ） ， 控制 规律 （ PID 、 串级 、 前馈 、 比例 等 ） ， 幅值 控制 （ 针对 开关 量 输出 ） ， 控制 极性 ， 控制 周期 ， 设定值 ， P 、 I 、 D 参数 ， 温度 补偿 通道 （ 用于 温度控制 ） ， 压力 补偿 通道 （ 用于 压力 控制 ） 。 　 　 回路 的 工作 状态 与 回路 控制 密切相关 ， 为了 跟踪 回路 的 工作 状态 ： 手动 或 自动 ， 在 回路 组态 中 还有 回路 状态 一项 ， 离线 组态 时应 全部 填入 手动 ， 第一次 运行 时 手动 调整 至 满足要求 为止 。 同时 对于 具体 的 回路 未必 是 所有 组态 项 都 有 意义 ， 某些 项要 按规定 填写 而 实际上 不用 。 　 　 对于 用户 来说 回路 组态 所 要 完成 的 工作 实质 上 是 按 约定 的 格式 和 要求 填写表格 ， 因此 VB 提供 的 DBGrid 控件 （ 表格 数据库 ） 很 适合 编写 此类 程序 。 它 的 Method 方法 和 Event 事件驱动 功能 使得 对 数据库 的 各种 操作 编程 简洁 高效 ， 尤其 是 能够 对 关联 的 数据库 文件 （ mdb ） 自动 读取 显示 和 编辑 后 自动 保存 。 　 流程图 组态 的 编制 　 　 DCS 组态 软件 具有 丰富 强大 的 工艺流程 图 组态 功能 ， 这部分 工作 主要 在 VB 中 实现 。 VisualBasic 具备 完善 的 图形 函数 和 方便 实用 的 图形 控件 如 Line 、 Shape 、 Graph 、 Image 。 利用 这些 便 能 提供 给 用户 基本 的 流程图 编辑 功能 ， 如 直线 、 圆 、 矩形 、 多边形 ， 同时 可以 选择 线 粗细 、 颜色 ， 对于 圆 、 矩形 的 填充 也 能 方便 地 实现 。 对于 较 复杂 的 图形 生成 ， 软件 则 提供 了 预先 设计 好 的 常用 现场 图形 控件 如 反应罐 、 阀门 、 管道 、 马达 等 。 这些 控件 是 在 Autocad 中 构造 出来 ， 对 它们 编程 的 难点 在于 实现 鼠标 拖动 时 的 自由 缩放 。 因此 要 了解 Autocad 的 文件 存储 格式 ， 在 VB 中用 读 二进制 文件 的 方法 获取 构成 图形 的 必备 信息 参数 ， 当 进行 缩放 操作 时 只 需 改变 相应 的 参数 。 而 对于 不 很 复杂 的 图形 控件 可以 直接 存为 Bmp 或 Jpg 图形 格式 ， 然后 利用 VB 提供 的 Image 控件 ， 将 其 Stretch 属性 设置 为 True 即能 实现 缩放 操作 。 　 　 流程图 组态 的 另 一项 工作 是 将 画面 和 相关 值 联系 起来 ， 此时 界面 会弹 出 在 数据库 组态 中 的 记录 列表 ， 选择 所 需 项目 后 就 实现 了 画面 和 选中 值 的 动态 连接 。 如果 是 开关 量 则 画面 会 根据 实测值 呈 两态性 ， 而 与 模拟量 对应 的 画面 可以 是 直接 数值 显示 或 棒状 图 等 连续 变化 显示 。 　 报表 组态 的 实现 　 　 报表 大致 分为 周期性 报表 和 触发 性 列表 两种 。 周期性 报表 一般 用来 打印 生产 过程 的 操作 记录 和 统计 （ 求和 等 ） ， 它 取代 了 操作工 的 抄表 工作 。 这 类 报表 一般 采用 定时 驱动 ， 通常 是 时报 、 班报 、 日报 、 月 报 等 。 而 触发 性 列表 则 用来 记录 在 特定 事件 发生 前后 的 某些 点 的 值 ， 往往 用来 进行 事故 或 故障 分析 。 　 　 在 VB 下 实现 报表 功能 有 三种 方法 ： 　 　 利用 VB 的 DDE 或 OLE （ 对象 链接 与 嵌入 ） 功能 ， 直接 将 EXCEL 作为 报表 输出 环境 。 　 　 利用 VB 自身 提供 的 CrystalReport 控件 ， 先 在 ReportDesigner 中 根据 需要 生成 rpt 文件 ， 再 将 CrystalReport 的 ReportFileName 属性 设 为 需要 的 rpt 文件 ， 就 能够 控制 报表 的 生成 和 打印 。 　 　 以上 两种 方法 的 优点 是 编程 容易 ， 但是 在 功能 实现 上 却 受到 制约 。 因此 想 完全 控制 报表 的 生成 和 打印 最好 使用 VB 的 打印机 控件 Printer 。 Printer 控件 将 外部设备 打印机 虚拟 为 VB 的 一个 “ 软设备 ” ， 使得 对 打印机 的 编程 直接 方便 。 在 报表 组态 过程 中 只 需 提供 画线 和 文本编辑 功能 ， 即 确定 报表 输出 格式 和 输出 的 项目 以及 打印 报表 的 时间 。 对 用户 的 组态 作以 记录 ， 然后 利用 Printer 控件 的 Method ： LinePrintEndDoc 等 打印输出 。 　 运行 程序 的 设计 　 　 运行 程序 分为 实时 报警 、 工艺 图 、 调整 图 、 报警 记录 、 打印 报表 等 。 这部分 也 是 用 VB 编写 的 。 　 　 运行 软件 启动 时先 一次性 从 组态 数据库 （ 数据库 组态 和 回路 组态 ） 中 读入 所 需 信息 ， 即 实时 数据库 。 由于 涉及 数据结构 的 变化 ， 对 实时 数据库 的 操作 应视 不同 情况 而定 。 在 需要 大量 而 频繁 访问 时 （ 如 DMA 传输 的 数据 ） 用 直接 读 内存 的 方法 ， 而 对于 只有 少量 访问 的 地方 （ 如 报表 程序 的 周期性 采样 ） 可 编写 函数 间接 读取 。 从 现场 控制站 传来 的 数据 经 VC 应用程序 送入 共享内存 区 ， VB 虽然 难以 直接 对 内存 进行 操作 ， 但 有 调用 动态链接库 的 功能 ， 通过 调用 DLL 和 VC 的 初始化 采集 程序 通信 ， 以 完成 操作员 站 的 监测 和 控制 功能 。 　 　 运行 界面 的 最 上方 有 一 红色 窗口 是 报警 区 ， 为了 不 被 别的 窗口 所 覆盖 ， 在 VB 中 调用 WIN 的 API 函数 SetWindowPos 将 报警 窗口 永远 置于 屏幕 的 上端 。 系统 每秒钟 读取 测量 的 数据 后 对 其 做 上 下限 判断 ， 如 有 越界 则 显示 相应 的 报警 信息 。 报警 窗口 始终 显示 最新 的 报警 ， 以前 的 报警 信息 要 在 报警 记录 中 查看 。 　 　 工艺 图 显示 分为 静态 图 和 动态图 。 静态 图 根据 在 流程图 编辑 中 的 记录 一次 绘制 完成 。 动态图 分为 三种 情况 ： 图像 移动 ， 图像 切换 ， 图像 移动 切换 。 图像 的 载体 一般 是 VB 中 的 Image 控件 和 Picture 控件 。 图像 移动 可以 通过 改变 控件 的 位置 属性 或 利用 控件 的 Move 方法 ， 图像 切换 需要 动态 改变 控件 的 Picture 属性 ， 而 图像 移动 切换 则 须 以上 两种 方法 并用 。 当然 对于 简单 的 动态显示 如 线段 的 平移 、 方块图 的 刷新 等 无须 用 图像 控件 ， 编写 相应 的 函数 即可 实现 。 　 　 调整 图是 运行 时 的 主要 监控 界面 。 一幅 调整 图 集中 了 一条 控制 回路 的 全部 监控 信息 。 它 不但 显示 现场 控制站 传来 的 测量 数据 ， 而且 能 根据 测量 值 和 设定值 的 比较 确定 控制 质量 的 好坏 ， 从而 在线 修改 PID 参数 、 设定值 、 甚至 改 回路 状态 为 手动 以 直接 控制 输出 值 的 大小 。 调整 图下方 有 两幅 图像 ： 趋势 图 和 棒状 图 。 趋势 图 记录 最近 五分钟 的 测量 值 、 设定值 和 输出 值 ， 并 以 趋势 曲线 的 形式 显示 ， 从中 可 对 控制 质量 的 好坏 一目了然 。 棒状 图则 是 以 棒状 条 的 形式 动态显示 测量 值 ， 其 左右 各有 一 不同 颜色 的 三角形 标尺 ， 分别 代表 输出 值 和 设定值 。 在 不同 的 回路 状态 （ 自动 和 手动 ） 下 ， 通过 上下 箭头键 可 调节 其值 。 调整 图 界面 如图所示 。 图 　 说明 　 　 分布式 控制系统 的 工程师 站 组态 软件 和 操作员 站 运行 软件 是 整个 控制系统 的 重要 组成部分 ， 它 需要 完成 的 任务 很多 。 因此 ， DCS 应用软件 的 设计 和 实现 也 是 很 复杂 的 系统工程 。 我们 只是 完成 了 其中 基本 的 工作 ， 还有 其它 的 工作 有待于 进一步 补充 ， 使 之 不断完善 。 作者简介 ： 徐晓东 　 硕士 研究生 。 专业 方向 ： 计算机控制 。 作者 单位 ： 西安交通大学 电气 学院 　 陕西 西安 （ 参考文献 ［ ］ 　 王常力 廖道 文集 散型 控制系统 的 设计 与 应用 北京 ： 清华大学出版社 ［ ］ 　 王常力 罗 　 安 集散 型 控制系统 选型 与 应用 北京 ： 清华大学出版社 ［ ］ 　 CharlesPetzold 著 Windows 程序设计 北京 ： 清华大学出版社 收稿 日期