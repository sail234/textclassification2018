软件 学报 JOURNALOFSOFTWARE 年 第卷 第期 VolNo 基于 Myrinet 的 用户 空间 精简 协议 董 春雷 　 郑纬民摘 　 要 　 通信 子系统 是 影响 工作站 机群系统 整体 性能 的 主要 因素 文章 在 分析 和 比较 了 种 常用 的 网络 性能 之后 ， 指出 上层 协议 的 处理 是 影响 工作站 机群系统 性能 的 主要 瓶颈 在 由 Mbps 的 Myrinet 连接 的 台 SunSPARC 工作站 组成 的 机群系统 上 实现 了 一个 用户 层 的 高性能 的 精简 通信协议 — — RCPreducedcommunicationprotocol 通过 精简 协议 的 冗余 功能 、 减少 数据 拷贝 次数 和 直接 操作 硬件 缓冲区 等 方法 达到 低 延迟 、 高效率 RCP 的 回路 延迟时间 比 TCPIP 小得多 （ μ svs μ s ） 可用 带宽 也 高得 多 （ MbpsvsMbps ） 协议 的 带宽 利用率 达到 并 为 上层 应用程序 和 PVM 提供 了 一个 简单 、 容易 的 接口 关键词 　 工作站 机群 精简 通信协议 并行处理 PVM 中图法 分类号 　 TPAReducedUserlevelCommunicationProtocolforMyrinetDONGChunleiZHENGWeiminDepartmentofComputerScienceandTechnologyTsinghuaUniversityBeijingAbstract 　 CommunicationsubsystemisamajorfactorthataffectstheoverallperformanceofaworkstationclustersystemInthispapertheauthorsanalyzedandcomparedtheperformanceofthreepopularnetworksandpointedoutthatthehighlevelprotocolprocessingisthebottleneckofcommunicationinworkstationclustersystemAuserlevelhighperformanceprotocolcalledRCPreducedcommunicationprotocolhadbeenbuiltonaclusterofSunSPARCworkstationsconnectedwithMbpsMyrinetLowoverheadandhighefficiencyoftheprotocolareachievedbysimplifyingtheprotocolsredundantfunctionsreducingthetimesofdatacopyingandoperatingdirectlyonhardwarebufferTheroundtriplatencyofRCPismuchlowerthanTCPIP μ svs μ stheapplicationavailablebandwidthismuchimprovedMbpsvsMbpsandthebandwidthusageofMyrinetonRCPreachestoAverysimpleinterfacetoapplicationorPVMisprovidedaswellKeywords 　 WorkstationclusterreducedcommunicationprotocolparallelprocessingPVM 　 　 通信 系统 是 并行 工作站 机群系统 的 重要 组成部分 它 实现 系统 的 消息传递 功能 其 性能 的 好坏 是 影响 并行计算 加速 比 和 效率 的 主要 因素 之一 ［ ］ 实现 一种 快速 的 消息 通信 机制 是 提高 工作站 机群系统 性能 的 有效 方法 ［ ］ 　 　 通信 系统 的 现状 　 　 　 　 ① 高速 网络 发展 迅速 　 　 由于 包括 并行计算 在内 的 多种 应用 对 高速 网络 的 需求 推动 了 网络 技术 的 飞速发展 目前 出现 了 多种 新型 的 高速 网络 如 FastEthernetATMMyrinet 这些 新型 网络 的 速度 是 传统 Ethernet 的 倍 或 更 高 由于 高速 网络 的 运用 使得 影响 通信 系统 性能 的 瓶颈 已 从 过去 的 网络 硬件 转移 到 网络通信 软件 上 也就是说 对 高速 网络系统 而言 网络 链路 的 传输 延迟 已经 很小 而 严重 影响 通信 系统 性能 提高 的 却是 通信协议 的 处理 开销 通信协议 的 处理 开销 过大 阻碍 了 高速 网 性能 的 大幅度提高 Myrinet 的 物理 链路 带宽 为 Mbps 而 在 TCPIP 协议 层测 得 的 带宽 只有 Mbps 可见 上层 通信协议 的 开销 使 高速 网络 的 高性能 得不到 充分 的 发挥 　 　 　 　 ② 峰值 带宽 增长幅度 大 但 往返 延迟 改进 小 所谓 高速 网络 性能 的 提高 往往 是 指其 峰值 带宽 与 传统 Ethernet 相比 高速 网 的 峰值 带宽 有 了 很大 程度 的 提高 从 Mbps 增长 到 MbpsMbps 甚至 Gbps 网络 的 带宽 反映 的 是 大 数据包 的 传输 能力 衡量 并行 系统 的 通信 性能 的 另 一个 重要 参数 是 往返 延迟 它 决定 了 系统 的 计算 粒度 直接 影响 系统 的 并行 效率 这些 高速 网络 的 峰值 带宽 增加 了 应用程序 的 可见 带宽 也 会 有 较大 的 提高 但 在 实际 系统 的 测试 中 发现 往返 延迟 的 改善 不大表 是 我们 对 MbpsEthernet 和 Mbps 　 　 表 Ethernet 与 Myrinet 网络 延迟时间 网络 类型 TCP 往返 延迟 （ μ s ） UDP 往返 延迟 （ μ s ） EthernetMyrinet 　 　 Myrinet 一个 字节 数据包 往返 延迟时间 的 测试 结果 （ 在 Sparc 工作站 上 ） 　 　 从表中 看出 Myrinet 的 通信 延迟 反而 比 普通 Ethernet 还 大 可见 高速 网络 在 传输 小 数据包 时 的 性能 并 不 理想 而 小 数据包 下 网络系统 性能 的 好坏 对 并行计算 有 很大 影响 因为 用户 设计 的 并行算法 经常 需要 进行 小 数据量 的 数据交换 而且 并行计算 环境 如 PVM 在 运行 时 也 需 发送 很多 数据量 很小 的 控制 消息 进行 系统 运行 情况 的 监护 对 其他 方面 的 应用 而言 小 数据包 的 传输 延迟 也 起到 举足轻重 的 作用 例如 UCBerkeley 通过 对 NFS 数据包 的 跟踪 发现 的 数据包 的 大小 不 超过 字节 数据包 的 平均 大小 是 字节 ［ ］ 因此 减小 高速 网络 小 数据包 传输 的 延迟时间 是 提高 网络系统 性能 的 重要 方法 之一 　 　 　 ③ 通信协议 基本 不变 　 　 新型 网络 技术 的 涌现 并 没有 对 传统 的 通信协议 进行 较大 的 改进 即使 像 ATM 这种 完全 不同于 Ethernet 的 高速 网络 也 是 想方设法 地 使用 TCPIP ［ ］ 协议 其中 一个 重要 的 原因 在于 产品 的 兼容 及 推广 因为 TCPIP 协议 几乎 占据 了 网络通信 的 各个领域 但 对 并行 机群系统 来说 兼容性 不是 它 的 主要 考虑 因素 因此 ， 可以 对 传统 的 通信协议 机制 、 软件 实现 作 较大 的 修改 克服 传统 协议 的 弊病 使 高速 网络 的 优越性 得以 充分 展现 　 　 影响 通信 系统 性能 的 因素 前面 的 分析 说明 限制 高速 网络 性能 的 瓶颈 是 软件 上 的 问题 下面 从 软件 的 角度 分析 影响 通信 系统 性能 的 主要 因素 软件 引起 的 通信 开销 主要 由 协议 处理 和 操作系统 处理 两 方面 的 开销 造成 操作系统 提供 了 网络协议 的 实现 环境 也 决定 了 网络协议 的 某些 实现 方法 网络协议 本身 的 处理 方式 也 都 是 影响 通信 延迟 的 因素 下面 对 这 两种 因素 进行 较为 详细 的 分析 　 　 　 ① 传统 的 TCPIP 协议 各层次 重复 实现 的 功能 很多 TCPIP 协议 是 面向 低 速率 、 高 差错 和 大 数据包 传输 而 设计 的 是 一个 多层次 的 软件结构 协议 层次 多 使得 对 数据 的 操作 和 拷贝 次数 增多 引起 延迟时间 的 增加 另外 在 多层 协议 的 实现 中 各层 还 重复 实现 了 很多 相同 的 功能 比如 a 从 链路层 到 传输层 都 要 进行 差错控制 b 从 链路层 到 应用层 都 要 进行 连接 建立 和 释放 c 从 网络层 到 应用层 都 要 进行 协议 的 处理机 调度 d 从 链路层 到 应用层 都 要 进行 流量 控制 e 从 网络层 到 应用层 都 要 进行 组装 和 定序 的 缓冲 这些 冗余 的 功能 虽然 可以 确保 数据 的 无差错 传送 但 随着 链路 传输 出错率 从降 至 这种 冗余 处理 反而 限制 了 数据 及时 提交 给 应用 程序处理 可见 多层次 的 协议 结构 是 造成 通信 瓶颈 的 主要 原因 之一 合并 某些 层次 删除 冗余 的 处理 设计 一种 轻型 通信协议 是 提高 通信 性能 的 重要 方法 　 　 　 ② 协议 复杂 的 缓冲 管理 增加 了 网络 延迟 网络协议 处理 包括 很多 功能 如 流量 控制 、 差错控制 、 出错 重 发 机制 、 拥塞 控制 等 而 这些 功能 的 实现 都 与 缓冲 管理 密切相关 　 　 缓冲 管理 的 作用 是 完成 数据 的 分组 和 组装 缓冲区 可 看成 一种 网络资源 这种 资源 是 有限 的 对 它 的 管理 很 重要 不过 通常 的 缓冲 管理机制 都 比较复杂 例如 BerkeleyUNIX 采用 一种 叫做 mbufs 的 结构 对 协议 的 数据包 进行 缓冲 管理 但 mbufs 的 算法 很 复杂 开销 很大 在 DECstation 上 对 单字节 TCP 消息 缓冲 管理 mbufs 需要 μ s 而 对 字节 数据包 需要 μ s ［ ］ 可见 缓冲 管理 带来 的 网络 延迟 也 很大 如何 简化 协议 复杂 的 缓冲 管理 也 是 我们 研究 的 主要 内容 　 　 　 ③ 操作系统 额外 开销 不可 忽视 操作系统 提供 的 系统 调用 和 原语 是 网络协议 实现 的 底层 软件 支持 在 网络协议 实现 中 涉及 到 上下文 切换 、 调入 调出 页面 、 启动 IO 设备 、 中断 响应 等 操作系统 处理 有时 这些 开销 可能 比 协议 本身 的 处理 开销 还 大 比如 在 Sun 系统 上 TCPIP 对 一个 数据包 的 协议 处理 时间 为 μ s 而 操作系统 的 额外 开销 却 高达 μ s 这 就 造成 了 通信 性能 对 操作系统 一定 程度 上 的 依赖 目前 一种 广泛 采用 的 思想 是 不 修改 UNIX 操作系统 而 在 用户 空间 实现 一个 用户 态 的 协议 层 并 使 此 协议 层 能够 旁路 操作系统 的 影响 直接 对 网络 硬件 设备 进行 操作 这样 就 可 减小 这部分 的 开销 最大 限度 地 提高 通信 系统 的 性能 　 　 为了 减小 通信协议 处理 开销 我们 实现 了 一个 基于 Myrinet 的 通信协议 RCP （ reducedcommunicationprotocol ） 其 基本 思想 是 抛弃 传统 的 TCPIP 协议 尽量 以 底层 通信接口 为 基础 简化 协议 的 层次 和 不必要 的 环节 达到 减少 拷贝 次数 、 简化 缓冲 管理 和 降低 协议 处理 开销 的 目的 精简 通信协议 RCP 的 结构 　 　 精简 通信协议 RCP 是 一个 建立 在 Myrinet 的 API 层上 的 用户 空间 协议 它 为 应用程序 提供 有序 、 可靠 的 双向 传输 一端 用户 空间 的 数据 通过 一条 虚拟 通道 直接 拷贝到 远程 的 用户 空间 中 不 需要 系统 的 多次 缓冲 与 干预 RCP 的 结构 如图所示 图 　 一般 协议 与 精简 通信协议 RCP 的 结构 　 　 RCP 的 设计 目标 是 要 减小 网络 的 回路 延迟 尽量 提高 链路层 的 带宽 利用率 它 建立 在 Myrinet 的 API 层上 以 充分利用 Myrinet 的 硬件 性能 为 应用程序 提供 对 网络 硬件 的 直接 控制 　 　 RCP 设计 的 另 一个 目标 是 要 实现 一个 简单 、 容易 的 用户 编程 接口 目前 ， 工作站 机群系统 上 的 并行程序 开发 环境 是 PVMRCP 直接 通过 PVM 的 函数 接口 来 实现 这样 应用程序 只要 作 很少 的 改动 就 可 在 精简 协议 上 执行 PVM 并行程序 RCP 协议 和 PVM 结合 起来 不仅 简化 了 用户 接口 而且 减少 了 PVM 的 一次 数据 拷贝 节省 了 PVM 的 内部 缓冲 内存 的 要求 为 大 数据量 应用程序 提供 更大 的 内存 从而 降低 了 访盘 次数 提高 了 效率 RCP 的 实现 　 　 RCP 的 基本 思想 是 在 两个 用户 进程 之间 提供 一个 顺序 、 可靠 的 虚拟 通道 它 是 一个 平衡 协议 发送 方 和 接收 方 完全 对 等 无论是 首先 执行 发送 例程 还是 首先 执行 接收 例程 都 会 在 某 一点 同步 并 交换 数据 它 类似 于 PVM 中 的 阻塞 式 发送 接收 RCP 中包 的 流程 　 　 RCP 的 通信 流程 如图所示 图 　 RCP 的 通信 流程 　 　 Myrinet 层 允许 的 最大 包长 是 Bytes 但是 RCP 的 传输数据 长度 只受 可 分配内存 空间 的 限制 数据 的 打包 与 拆包 直接 在 用户 提供 的 原 缓冲 空间 中 进行 这样 既 降低 了 系统 缓冲 需求 又 减少 了 数据 拷贝 次数 顺序 性 、 可靠性 　 　 为了 取得 较 高 的 效率 同时 基于 测试 的 结果 RCP 中 只 对 包长 和 包头 信息 进行 检查 而 不 对 数据 部分 计算 校验 和 因为 Myrinet 接口卡 具有 检错 能力 并 能 保证 首先 发送 的 包先 到达 目的地 数据 的 顺序 性由 一个 基于 连接 的 全局 计数 来 维护 它 对于 发送 和 接收 是 完全 对称 的 其 可靠性 是 由 一个 简单 的 滑动 窗口 协议 和 选择 重传 机制 来 保证 窗口 大小 可以 根据 硬件 缓冲区 的 大小 和 网络 负荷 的 轻重 而 改变 RCP 的 滑动 窗口 协议 如图 a 所示 由 发送 双方 约定 收发 双方 首先 同步 确定 窗口 大小 然后 发送 方 发送 一个 窗口 的 数据 接收 方 进行 确认 后 再 进行 下 一个 窗口 的 传送 如果 有 出错 包则 在 应答 中 指明 出错 包 的 个数 及 序号 下 一个 窗口 立即 重 发出 错包 这样 ， 窗口 的 尺寸 越来越 小 总能 完成 传输 如图 b 所示 图 　 简单 的 滑动 窗口 协议 连接 建立 及 管理 　 　 RCP 是 一个 对 等 的 协议 它 的 连接 管理 采用 静态 方式 每一 通道 的 两端 进程 都 要 维护 这一 连接 因而 这种 联接 并 不 真正 要 与 对方 交换 连接 信息 只是 在 本地 作一 记录 为 以后 的 发送 及 接收 提供 必要 的 信息 开始 与 结束 　 　 在 实际 的 应用程序 中 可能 不 知道 进程 之间 的 准确 时序 关系 即 不 知道 是 首先 执行 到 接收 原语 还是 首先 执行 到 发送 原语 对 这 两种 情况 ， RCP 都 可以 工作 当先 执行 到 接收 原语 时 接收 方向 发送 方发 一 同步 信息 READY 包 等待 接收数据 ； 发送 方 根据 该 信息 确定 窗口 大小 并 发送数据 如果 先 执行 到 发送 原语 则 分为 两种 情况 ： 一种 是 发送 大量 数据 （ 数据 长度 ＞ 个 包长 ） 发送 方向 接收 方发 一 同步 信息 然后 进入 发送 阶段 ； 另 一种 是 发送 小量 数据 （ 数据 长度 ＜ 个 包长 ） 同步 信息 和 数据 一起 发出 接收 方 一起 确认 这样 可以 减小 小 数据包 的 传输 延迟 不管 是 哪种 情况 如果 没 在 某 指定 时间 内 收到 应答 则 发送 方 认为 发送 失败 重新 发送 如图所示 图 　 RCP 与 PVM 及 应用程序 的 关系 RCP 与 并行 开发 环境 的 接口 　 　 为了 尽量减少 应用程序 的 修改 我们 对 并行程序 开发 环境 PVM ［ ］ 的 部分 通信 例程 进行 了 重写 直接 在 原 PVM 的 pvmpsend 和 pvmprecv 中 增加 一条 新 的 数据通道 如图所示 从而 简化 了 应用程序 的 接口 PVM 应用程序 不 需要 显式 调用 RCP 的 发送 接收 函数 只是 在 每个 通信 进程 的 开始 调用 一下 RCP 协议 初始化 例程 并 打开 通信 通道 RCP 中 维护 一张 从 PVM 任务 标识 到 通信 通道 的 转换 表及 通道 的 连接 信息 图 　 RCP 与 PVM 及 应用程序 的 关系 　 　 另外 RCP 还 为了 和 pvmprecv 对应 提供 了 一个 不 经过 PVM 缓冲 的 多播 函数 pvmpmcast 它 直接 利用 RCP 将 用户 数据 广播 到 指定 任务 RCP 的 性能 分析 　 　 卡耐基 梅隆 大学 的 JoseCBrustoloni ［ ］ 在 Mbps 的 Ethernet 上 改进 了 TCPIP 协议 的 实现 使 往返 延迟 减小 到 μ sUtah 大学 的 MarkSwanson ［ ］ 提出 了 一种 基于 发送 方 的 协议 改善 了 往返 延迟 和 同步 RCP 在 清华大学 计算机科学 与 技术 系 的 并行 工作站 机群系统 （ 台 SunSparcstationMbpsMyrinet 上 进行 了 测试 RCP 的 回路 延迟 为 μ s 是 原 TCPIP 协议 的 应用程序 可见 带宽 达 Mbps 是 TCPIP 带宽 的 倍 如图所示 图 　 Myrinet 上 TCP 和 RCP 的 带宽 对比 结论 　 　 本文 对 工作站 机群系统 的 通信 网络 性能 进行 了 测试 和 分析 基于 其 结果 在 Myrinet 的 API 层 设计 并 实现 了 一个 建立 在 用户 空间 的 精简 通信协议 RCP 减少 了 数据 拷贝 次数 和 缓冲 需求 充分利用 硬件 功能 具有 低 回路 延迟 、 高带宽 利用率 和 方便 的 编程 接口 等 优点 使用 RCP 通信 的 PVM 应用程序 可以 明显提高 性能 　 　 本文 研究 得到 国家 高科技 项目 基金 资助 作者 董 春雷 年生 博士 主要 研究 领域 为 并行处理 机群系统 新型 网络协议 郑纬民年生 教授 ， 博士生 导师 主要 研究 领域 为 并行处理 　 　 本文 通讯联系 人董 春雷 ， 北京 清华大学 计算机科学 与 技术 系 作者 单位 ： 清华大学 计算机科学 与 技术 系 　 北京 　 　 　 　 　 　 Emailzwmdcstsinghuaeducn 参考文献 ［ ］ DavidCulleretalLogPtowardarealisticmodelofparallelcomputationInProceedingsofthePrinciplesandPracticeofParallelProcessinghttp ∥ nowcsberkelegedupaperlogpps ～ ［ ］ ThekkathANguyenTDMoyEetalImplementingnetworkprotocolsatuserlevelInProceedingsofSIGCOMMSept ～ ［ ］ FeldermanDeSchonACohenDetalATOMICahighspeedlocalcommunicationarchitectureJournalofHighSpeedNetworks ～ ［ ］ DongChunleiZhengWeiminWangDingxingetalAscalableparallelworkstationclustersystemInProceedingsofAPDCLosAlamitosIEEEComputerSocietyPress ～ ［ ］ ThekkathCLevyHLimitstolowlatencycommunicationsonhighspeednetworksACMTransactionsonComputerSystemsMay ～ ［ ］ PostelBTransmissionControlProtocolRFCSept ［ ］ BeguelinDongarraJGeistAetalPVMexperiencescurrentstatusandfuturedirectionInProceedingsoftheSupercomputingLosAlamitosIEEEComputerSocietyPress ～ ［ ］ JoseCBrustoloniBrianNBershadSimpleprotocolprocessingforhighbandwidthlowlatencynetworkingTechnicalReportCMUCS ［ ］ MarkSwansonLeighStollerLowlatencyworkstationclustercommunicationsusingsenderbasedprotocolsTechnicalReportUTAHCS （ 收稿 ）