微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 　 No 　 No 　 PWindows 下用 单台 微机 通过 RS － 控制 多台 变频器 周捷 程春玲 摘要 ： MicroMaster 变频器 的 RS － 通信协议 ， 利用 VC ． 中 的 ActiveX 控件 MSCOMM 通信 控件 实现 了 Windows 下单 台 微机 与 多台 变频器 的 串行 通信 控制 ， 并 能 实时 检测 各 变频器 的 运行 状态 。 关键词 ： 工控 PC机 ActiveX 控件 RS － 通信协议 变频器 控制 　 　 工业 场合 中 ， 经常 要 用 变频器 去 控制 交流 电机 的 转速 、 转向 。 在 某些 场合 ， 需要 用台 工控 PC机 灵活 地 控制 多台 变频器 ， 以 达到 控制 各 交流 电机 的 目的 。 针对 这一 需要 ， 一些 公司 如 德国西门子 、 日本 东芝 、 三菱 等 公司 推出 了 带有 RS － 通信接口 的 变频器 ， 使 用户 能 方便 灵活 地 选择 变频器 的 强大 功能 来 设计 各自 的 工业 控制系统 。 　 　 在 Windows 下 开发 工控 软件 ， 可 利用 Windows 的 丰富 资源 ， 方便 地 生成 各种 菜单 及 美观大方 的 图形界面 ， 软件产品 质量 高且 开发 周期短 。 VisualC ＋ ＋ ． 是 Microsoft 公司 最新 推出 功能 最强 的 Windows 开发软件 ， 由于 只能 在 Win 下 运行 开发 位 的 应用程序 ， 而 在 Windows 环境 下 ， 系统 完全 接管 了 各种 硬件资源 ， 不 允许 用户 直接 控制 串行口 的 中断 管理 ， 因此 如何 在 Windows 环境 下 开发 微机 的 底层 资源 ， 已 成为 当今 工业 控制软件 的 一大 热点 及 难点 。 　 　 本文 利用 VC 的 ActiveX 控件 — — MicrosoftCommunication 控件 ， 方便 地 实现 了 Win 环境 下 与 多个 西门子 MicroMaster 变频器 的 串行 通信接口 ， 成功 地 实现 了 用 单台 工控 PC机 对 多台 交流 异步电机 的 灵活 控制 。 系统 的 总体设计 　 　 图为 系统 的 总体设计 方框图 ， 这里 只 重点 突出 工控 PC机 与 变频器 RS － 的 接口 部分 。 RS － 的 驱动器 可带 个 接收器 ， 在 波特率 为 Kbs 时 ， 通信 距离 可 达到 m ； 通信 距离 为 m 时 ， 波特率 可达 Mbs 。 在 工业 现场 ， RS － 是 应用 较 多 的 一种 通信 方式 。 图中 工控 PC机 通过 通信接口 卡 与 多个 变频器 相连接 ， 最多 可 达到 台 。 每个 变频器 被 赋予 各自 的 地址码 用以 识别 身份 ， 这样 上位 机便 能 通过 通信线 对 挂 在 上面 的 所有 变频器 进行 控制 操作 。 图 系统 的 总体 方框图 变频器 的 串口 通信协议 　 　 对于 西门子 的 MicroMaster 变频器 ， 其 通信 方式 为 RS － ， 波特率 最高 可 达到 bs ； 位 起始 位 ； 位 数据位 ； 位偶 校验 ； 位 停止 位 。 变频器 接收 控制 的 通信协议 如下 ： STXLGEADRPKEINDVALSTWHSWBCC 　 　 STX ： 起始 字符 ， 为 H 。 　 　 LGE ： 发送 字节数 ， 对于 MicroMaster ， 为 CH 个 字节 。 　 　 ADR ： 变频器 的 地址码 ， 取值 范围 为 ～ Bit ： ～ 位 ， 第位 为 时 为 广播 发送 。 　 　 PKE ： 为 一位 的 字 ， 用来 控制 变频器 的 运行 参数设置 ， 各 Bit 的 含义 如下 ： 控制 位 变频器 的 参数值 　 　 对于 MicroMaster ， 控制 位为 时 ， 读 变频器 的 参数 ； 控制 位为 时 ， 写 参数 到 变频器 的 RAM 和 EEPROM 。 第位 未用 ， 置 为 。 变频器 的 参数值 详见 说明书 。 　 　 IND ： 为位 的 字 ， 未 用 ， 置 为 。 　 　 VAL ： 为位 的 变频器 参数 ， 与 PKE 一起 将 运行 参数 写入 到 变频器 中 。 　 　 STW ： 为位 的 字 用来 控制 变频器 的 运行 动作 ， 各位 的 具体 含义 详见 说明书 。 　 　 HSW ： 为位 的 字 用来 控制 变频器 的 输出 频率 ， 满频 的 值 为 H 对应 ％ 的 输出 频率 ， 最大值 为 ， 即 ％ 的 输出 频率 。 当 取值 为 ～ 时 ， 表示 反向 的 输出 频率 从 ％ ～ ％ 变化 ， 电机 反转 。 　 　 BCC ： 校验 字符 ， 为 前面 所有 字节 的 异或 和 。 　 　 若 变频器 ＃ 地址码 为 H 以满频 的 ％ 输出 频率 ， 则 以上 各 参数 的 值 设置 如下 ： 　 　 同时 ， 变频器 也 向上 位机 回送 状态 数据 ， 其 通信协议 如下 ： STXLGEADRPKEINDVALZSWHIWBCC 　 与 上位 机向 变频器 发送 的 控制 字 相比 ， 变频器 回送 的 状态字 只是 以 ZSW 代替 了 STW ， HIW 代替 了 HSW ， 其余 的 字 的 含义 是 一样 的 。 ZSW 是 位 的 状态字 来 指示 变频器 的 当前 运行 状态 ， 各位 的 具体 含义 见 说明书 ； HIW 也 是 位 的 字 代表 变频器 的 输出 频率 ， 其 定义 与 HSW 是 一样 的 。 　 　 因此 ， 对于 变频器 能 通过 面板 按键 设置 的 功能 ， 通过 以上 的 通信协议 也 一样 能 实现 。 并且 通过 RS － 通信线 最多能 同时 控制台 变频器 ， 同时 各 变频器 的 运行 状态 也 能 实时 地回 送给 上位 机 ， 这 就 大大 方便 了 用户 ， 增加 了 控制系统 的 灵活性 。 VisualC ＋ ＋ ． 下 对 变频器 进行 串行 通信 控制 ActiveX 控件 MicrosoftCommControl 　 　 在 Windows 环境 下 ， 操作系统 完全 接管 了 各种 硬件资源 ， 不 允许 用户 直接 控制 串行口 的 中断 管理 。 以往 程序员 只能 通过 数目 众多 的 API 函数 来 控制 串口 。 　 　 VC 下 提供 了 个 ActiveX 控件 MicrosoftCommunicationControl ． ， 简称 MSComm 控件 。 用户 可以 在 自己 的 应用程序 中 嵌入 MSComm 控件 ， 利用 它 可以 方便 地 进行 计算机 串口 的 通信 管理 。 VC ． 中 的 ActiveX 控件 MSComm 与 VC ． 中 的 OL E通 信 控件 相比 ， 增加 了 一些 新 的 功能 ， 其中 最为 有用 的 个 改进 是 将 Input 从 缓冲区 读取 接收数据 的 数据类型 从 CString 改成 Variant ， 同时 新增 个 属性 InputMode ， 使 程序 能 方便 地 选择 从 缓冲区 读取数据 的 格式 ： 字符串 格式 或 进制 格式 。 　 　 在 VC ． 开发 环境 中 ， 选择 MicrosoftCommunicationControl ． 控件 插入 程序 ， 则 系统 自动 为 所 插入 的 控件 定义 个 CMSComm 类 ， 与其 相关 的 文件 保存 在 mscomm ． h 和 mscomm ． cpp 文件 中 。 确认 以上 菜单 选择 后 ， 则 MSComm 控件 已 嵌入 到 项目 文件 中 。 　 　 MSComm 控件 有 许多 属性 ， 其中 一些 重要 的 属性 如下 ： 　 　 CommPort ： 设置 串 口号 ， 类型 ： short ； 　 　 Settings ： 设置 串口 通信 参数 ， 类型 ： CString ； 　 　 PortOpen ： 设置 或 返回 通信 口 的 状态 ， 类型 ： BOOL ； 　 　 InputMode ： 设置 从 缓冲区 读取数据 的 格式 ， 类型 ： long ； 　 　 Input ： 从 接收缓冲区 读取数据 ， 类型 ： VARIANT ； 　 　 Output ： 向 发送缓冲区 写入 数据 ， 类型 ： VARIANT ； 　 　 InBufferSize ： 接收缓冲区 的 大小 ， 类型 ： short ； 　 　 InBufferCount ： 接收缓冲区 的 字节数 ， 类型 ： short ； 　 　 OutBufferSize ： 发送缓冲区 的 大小 ， 类型 ： short ； 　 　 OutBufferCount ： 发送缓冲区 中 的 字节数 ， 类型 ： short ； 　 　 InputLen ： 设置 或 返回 Input 每次 读出 的 字节数 ， 类型 ： short ； 　 　 CommEvent ： 串口 事件 ， 类型 ： short 。 　 　 其中 串 口号 CommPort 设置 为 、 等 表示 COMM 、 COMM 。 参数设置 Settings 的 格式 为 “ B ， P ， D ， S ” ， B 表示 波特率 ， P 表示 奇偶校验 N 无 校验 ， E 偶 校验 ， O 奇 校验 ， D 表示 字节 有效位数 ， S 表示 停止 位数 。 串口 状态 PortOpen 为 BOOL 变量 ， TRUE 表示 打开 串口 ， FALSE 表示 关闭 串口 。 InputMode 使 程序 能 方便 地 选择 从 缓冲区 读取数据 的 格式 ， 设置 为 时 字符串 格式 ， 设置 为 时 表示 进制 格式 。 InputLen 设置 或 返回 的 是 用 Input 从 缓冲区 读 字符串 时 每次 读出 的 字符 个数 ， 这个 性质 对于 读出 数据 块 中定 长 数据 串 非常 有用 。 　 　 另外 ， MSComm 控件 提供 了 种 方法 来 处理 串口 通信 ， 上面 属性 的 InBufferCount 和 OutBufferCount 用于 串口 的 查询 方式 。 对于 较 复杂 的 通信 任务 ， 可 通过 SetCommEvent 函数 设置 串口 要 响应 的 事件 ， 当 相应 事件 或 串口 错误 事件 发生 时 ， 系统 会 激活 OnComm 事件 ， 在 OnComm 中 添加 用户 的 处理 代码 ， 则 可 实现 类似 DOS 中断 的 串口 处理程序 。 变频器 串口 通信 控制 检测 软件 的 编制 　 　 在 项目 文件 嵌入 MSComm 控件 的 头文件 mscomm ． h 及 实现 文件 mscomm ． cpp 之后 ， 为了 用该 控件 控制 个 串口 进行 通信 操作 ， 还 必须 在 应用程序 中 插入 该 控件 。 为此 ， 我们 为 程序 的 某个 对话框 插入 MSComm 控件 ， 控件 ID 为 IDC ＿ MSCOMM ， 并 利用 ClassWizard 为 其 添加 变量 CCMSCommm ＿ Coml ， 则 程序 中 对 串口 的 各种 操作 都 可 通过 变量 m ＿ Coml 来 实现 。 　 　 MicroMaster 变频器 回送 的 状态 信息 帧 为 B 。 为此 ， 程序编制 上 采用 事件驱动 的 通信 方式 ， 串口 每 接收 个字符 便 激活 个 OnComm 事件 ， 在 OnComm 消息 处理函数 中 加入 相应 的 处理 代码 ， 用来 读取 状态字 ZSW 和 HIW 各位 的 状态参数 ， 并 作出 相应 的 处理 ， 如 显示 、 报警 等 。 下面 简要 给出 用 事件驱动 方式 读出 变频器 回送 状态字 的 程序 源代码 。 设 RS － 卡 的 口 地址 为 工控 PC机 的 串口 的 地址 ， 波特率 为 bs 。 　 　 串口 初始化 程序 如下 ： 　 　 m ＿ Coml ． SetCommPort ； 　 设置 串口 　 　 ifm ＿ Coml ． GetPortOpen 　 　 　 　 m ＿ Coml ． SetPortOpenTRUE ； 　 打开 串口 　 　 m ＿ Coml ． SetSettings ″ ， e ， ， ″ ； 　 串口 参数设置 　 　 m ＿ Coml ． SetInputMode ； 　 设置 Binary 缓冲 输入 方式 　 　 m ＿ Coml ． SetRThreshold ； 　 每 接收 个字符 时 激发 OnComm 事件 　 　 工控 PC机 控制 变频器 的 参数 通过 类 ColeVariant 的 构造函数 来 实现 ， ColeVariant 可以 接受 各种类型 的 数据 如 字符串 、 整数 、 浮点数 等 并 自动 将 其 转换 为 符合 VARIANT 要求 的 数据 。 程序代码 如下 ： 　 　 m ＿ Coml ． SetOutputColeVariant ″ x ″ ； 　 发送 起始 字符 H 　 　 m ＿ Coml ． SetOutputColeVariant ″ xC ″ ； 发送数据 长度 字符 CH 　 　 … … 　 　 　 　 　 　 发送 其它 的 控制参数 　 　 对于 变频器 回送 的 状态 信息 则 利用 Windows 的 消息 处理函数 OnComm 进行 处理 。 利用 ClassWizard 为 MSComm 控件 IDC ＿ MSCOMM 添加 消息 处理函数 OnOnCommMscomm ， 在 OnOnCommMscomm 中 加入 处理 代码 如下 最后 个 语句 为 添加 的 程序代码 ， 其余 代码 由 ClassWizard 自动 生成 ： 　 　 voidCGpsdataDlg ： ： OnOnCommMscomm 　 　 　 　 TODO ： Addyourcontrolnotificationhandler 　 codehere 　 　 m ＿ Coml ． SetInputLen ； 　 读取 串口 缓冲区 全部 数据 　 　 VARIANTParameter ＝ m ＿ Coml ． GetInput ； 　 数据 赋给 VARIANT 变量 　 　 … … 　 　 　 具体 程序处理 代码 　 　 在 消息 处理函数 OnOnCommMscomm 中 ， 将 变频器 回送 的 个 状态字 每 一次 全部 读到 VARIANT 变量 Parameter 中 ， 然后 程序 再 从 VARIANT 类型 的 数组 变量 Parameter 中 分别 读取 各 状态 字节 ， 在 屏幕 上 显示 、 判断 并 报警 。 　 　 本文 利用 VC ． 下 的 ActiveX 控件 和 MicroMaster 变频器 RS － 的 串行 通信 功能 ， 实现 了 在 Windows 环境 下用 单台 工控 PC机 控制 多台 变频器 的 任务 ， 并 能 实时 检测 各 变频器 的 运行 状态 。 整个 控制系统 灵活 方便 ， 具有 很大 的 实用性 。 周捷 （ 南京 东南大学 仪器 科学 与 工程系 ） 程春玲 （ 南京 邮电学院 信息 所 ） 参考文献 ， 木 林森 ． VisualC ＋ ＋ ． 使用 与 开发 ． 北京 ： 清华大学出版社 ， 收稿 日期 ： － －