软件 学报 JournalofSoftwareVolNoP 一个 虚拟 Internet 服务器 的 设计 与 实现 章文嵩 　 吴 婷婷 　 金士尧 　 吴 泉源 摘 　 要 　 针对 已有 的 解决 Internet 服务器 性能 瓶颈 和 可靠性 问题 的 方法 所 存在 的 不足 提出 基于 IP 层 负载平衡 调度 的 解决 方法 将 一组 服务器 构成 一个 可 伸缩 的 、 高 可用 的 虚拟 Internet 服务器 通过 在 服务 机群 中 透明 地 加入 和 删除 结点 以 实现 系统 的 伸缩性 通过 检测 结点 或 服务 进程 故障 和 正确 地 重置 系统 达到 高可用性 详细 讨论 了 虚拟 Internet 服务器 的 体系结构 、 设计 方法 和 实现 技术 并 给出 了 相应 的 性能 测试 结果 关键词 　 Internet 服务器 负载平衡 高可用性 网络地址 转换 中图法 分类号 　 TPDesignandImplementationofaVirtualInternetServerZHANGWensong 　 WUTingting 　 JINShiyao 　 WUQuanyuanSchoolofComputer 　 NationalUniversityofDefenseTechnology 　 Changsha 　 Abstract 　 TheshortcomingsoftheexistingsolutionstotheperformancebottleneckandreliabilityproblemofInternetserversareanalyzedandasolutionbasedonIPlevelloadbalancingisgiveninthispaperinwhichascalableandhighlyavailablevirtualInternetservercanbebuiltonaclusterofserversScalabilityisachievedbytransparentlyaddingorremovinganodeintheclusterHighavailabilitycanbeprovidedbydetectingthenodeordaemonfailuresandreconfiguringthesystemappropriatelyThearchitecturedesignandimplementationofthevirtualInternetserverarediscussedindetailBriefperformancetestingresultsarealsoprovidedKeywords 　 Internetserverloadbalancehighavailabilitynetworkaddresstranslation 　 　 当今 计算机技术 已 进入 以 网络 为 中心 的 计算 时期 大量 的 应用 都 围绕 着 网络 进行 对 服务器 的 性能 和 可靠性 提出 了 越来越 高 的 要求 例如 随着 Internet 的 飞速发展 和 用户 的 剧烈 增长 比较 热门 的 Web 站点 会 因为 被 访问 次数 急剧 增长 而 不能 及时处理 用户 的 请求 导致用户 长时间 地 等待 大大降低 了 服务质量 这时 Web 服务器 的 性能 往往 成为 整个 系统 中 的 瓶颈 当 在 Web 服务器 上 大量 使用 CGI 和 数据库 等 CPU 密集型 应用 的 情况 下 服务器 性能 瓶颈 问题 更加 突出 另外 随着 电子商务 等 关键性 应用 在 网上 的 运行 任何 例外 的 服务 中断 都 将 造成 不可估量 的 损失 因此 服务器 的 可靠性 也 越来越 重要 　 　 为了 有效 地 解决 Internet 服务器 的 性能 瓶颈 和 可靠性 问题 我们 给出 了 基于 IP 层 负载平衡 调度 的 解决 方法 将 一组 服务器 构成 一个 可 伸缩 的 、 高 可用 的 虚拟 Internet 服务器 通过 使用 网络地址 转换 使得 服务器 组 的 复杂 结构 对 用户 是 透明 的 系统 的 伸缩性 通过 在 服务 机群 中 透明 地 加入 和 删除 一个 节点 来 达到 通过 检测 节点 或 服务 进程 故障 和 正确 地 重置 系统 达到 高可用性 相关 的 解决 方法 　 　 解决 服务器 性能 瓶颈 问题 的 现有 方法 主要 分为 以下 类 　 　 单 服务器 解决 方法 当 服务器 性能 会 成为 瓶颈 时 最 简单 的 方法 是 将 其 升级 为 更 高档 的 服务器 但 该 方法 有 以下 不足 ： ① 升级 过程 繁琐 机器 切换 会 使 服务 暂时 中断 并 造成 原有 计算资源 的 浪费 ； ② 越往 高端 的 服务器 发展 所 花费 的 代价 越大 ； ③ 一旦 该 服务器 或 应用软件 失效 会 导致 整个 服务 的 中断 　 　 基于 RRDNS 的 多 服务器 解决 方法 NCSANationalCenterofSupercomputingApplications 的 可 伸缩 的 WEB 服务器 系统 就是 最早 基于 轮转 域名 系统 RRDNSroundrobindomainnamesystem 的 原型 系统 ［ ～ ］ 其 基本 思想 是 ： 通过 RRDNS 服务器 把 域名 轮流 解析 到 这组 Web 服务器 的 不同 IP地址 将 负载 分到 各台 服务器 上 从而 提高 整个 系统 的 性能 然而 该 方法 存在 以下 一些 问题 ① 域名服务 系统 是 按 层次结构 组织 的 各级 域名 服务器 都 会 缓冲 已 解析 的 名字 到 IP地址 的 映射 它会 妨碍 RoundRobin 方法 在 客户端 生效 会 导致 不同 WEB 服务器 间 严重 的 负载 不 平衡 另外 域名 到 IP地址 映射 的 TTLtimetolive 值较 难 设定 太大则 负载 不 平衡 更 严重 太小 则 频繁 的 域名解析 使 RRDNS 成为 系统 中 一个 新 的 瓶颈 ② 由于 用户 访问 请求 的 突发性 和 访问 方式 不同 即使 TTL 值为 各 服务器 间 的 负载 仍 存在 较 严重 的 负载 不 平衡 问题 ③ 系统 的 可靠性 和 可维护性 差 一台 服务器 失效 或 管理员 对 其 进行 维护 均会 导致 域名 已 被 解析 到 该 服务器 上 的 用户 出现 服务 中止 　 　 基于 应用层 负载平衡 调度 的 多 服务器 解决 方法 EDDIE ［ ］ ReverseProxy ［ ］ 和 pWEB ［ ］ 都 使用 基于 应用层 调度 的 方法 来 建立 一个 可 伸缩 的 WEB 服务器 它们 都 将 到达 的 HTTP 请求 转发 到 不同 的 Web 服务器 取得 结果 后 再 返回 给 用户 该 方法 也 存在 一些 问题 首先 系统 处理 开销 特别 大 致使 系统 的 伸缩性 有限 从 请求 到达 至 处理 结束 调度 器 需要 进行 次 从 核心 与 用户 空间 的 切换 以及 从 用户 到 调度 器 和 调度 器到 真实 服务器 的 两次 TCP 连接 还 需要 对 请求 进行 分析 和 重写 一般 地当 服务器 组 数目 增加 时 调度 器会 很快 成为 新 的 瓶颈 文献 ［ ］ 在 Linux 版本 上 应用 快速 报文 插入 技术 使得 进行 负载平衡 调度 的 用户 进程 访问 网络设备 接近 核心 空间 的 速度 降低 了 上下文 切换 的 处理 开销 但 并 不 彻底 其次 基于 应用层 的 负载平衡 调度 器 与 应用 协议 密切相关 对于 HTTPProxy 和 SMTP 等 应用 协议 需要 写 不同 的 调度 器 虚拟 Internet 服务器 的 体系结构 　 　 虚拟 Internet 服务器 采用 基于 IP 层 负载平衡 调度 技术 在 操作系统 核心 空间 中将 IP 层上 的 TCP 连接 负载 均衡 地 转移 到 不同 的 服务器 上且 调度 器 自动 屏蔽掉 服务器 的 故障 从而 将 一组 服务器 构成 一个 高性能 的 、 高 可用 的 虚拟 Internet 服务器 虚拟 Internet 服务器 的 体系结构 如图所示 整个 服务器 组 的 复杂 结构 对 用户 是 透明 的 用户 看到 的 是 单个 服务器 且 无需 修改 客户端 和 服务器端 的 程序 为此 在 设计 时 需要 考虑 系统 的 透明性 、 负载 均衡性 、 容错性 和 易管理性 Fig 　 ArchitectureofavirtualInternetserver 图 　 虚拟 Internet 服务器 的 体系结构 　 透明性 和 网络地址 转换 　 　 透明性 是 通过 网络地址 转换 实现 的 当 用户 通过 VirtualIPAddress （ 即 调度 器 的 外部 地址 ） 访问 服务器时 请求 报文 到达 调度 器 调度 器以 负载 均衡 方法 从 一组 真实 服务器 选出 一个 将 报文 的 目标 地址 VirtualIPAddress 改写 成 选定 服务器 的 地址 报文 的 目标 端口 改写 成 选定 服务器 的 相应 端口 最后 将 报文 发送给 选定 的 服务器 同时 调度 器 在 Hash 表中 记录 这个 连接 当 这个 连接 的 下 一个 报文 到达 时 从 Hash 表中 可以 得到 原 选定 服务器 的 地址 和 端口 进行 同样 的 改写 操作 并 将 报文 传给 原 选定 的 服务器 真实 服务器 的 回应 报文 经过 调度 器时 将 报文 的 源地址 和源 端口 改为 VirtualIPAddress 和 相应 的 端口 再 把 报文 发给 用户 当 连接 终止 或 超时 时 调度 器 将 这个 连接 从 Hash 表中 删除 这样 用户 所 看到 的 只是 在 VirtualIPAddress 上 提供 的 服务 而 虚拟 服务器 的 结构 对 用户 是 透明 的 对 改写 后 的 报文 应用 增量 调整 Checksum 的 算法 调整 TCPChecksum 的 值 ［ ］ 避免 了 扫描 整个 报文 来 计算 Checksum 的 开销 　 负载平衡 　 　 负载平衡 调度 是 以 TCP 连接 为 粒度 的 根据 HTTP 协议 ［ ］ 从 WEB 服务器 上 获取 每个 对象 都 需要 建立 一个 TCP 连接 同一 用户 的 不同 请求 会 被 调度 到 不同 的 服务器 上 所以 这种 细粒度 的 调度 完全避免 了 因 用户 访问 的 突发性 引起 的 负载 不 平衡 问题 在 调度 算法 上 我们 采用 轮转 调度 roundrobinscheduling 算法 和 基于 权值 的 轮转 调度 weightedroundrobinscheduling 算法 轮转 调度 算法 是 假设 所有 服务器 处理 性能 均 相同 依次 将 请求 调度 到 不同 的 服务器 算法 简单 但 不适 用于 服务器 组中 处理 性能 不一 的 情况 为此 使用 基于 权值 的 轮转 调度 算法 用 相应 的 权值 表示 服务器 的 处理 性能 将 请求 数目 按权值 的 比例 分配 到 各 服务器 调度 器 需要 记录 各个 服务器 已 建立 TCP 连接 的 数目 当 某台 服务器 被 调度 时其 连接数 加 ； 当 连接 中止 或 超时 的 时候 其 连接数 减 假设 每台 服务器 的 权值 为 WiinTCP 连接 数目 为 Tiin 依次 选 TiWi 最小 的 服务器 为 调度 对象 算法 实现 也 比较 容易 并且 与 服务器 无关 　 故障 检测 　 　 我们 采用 两种 方法 来 检测 故障 一种 方法 是 资源 监测器 每隔 t 毫秒 对 每个 服务器 发 ARP （ addressresolveprotocol ） 请求 若有 服务器 过超 r 毫秒 仍 没有响应 则 说明 该 服务器 已 发生 故障 资源 监测器 通知 调度 器 将 该 服务器 的 所有 服务 进程 调度 从 调度 列表 中 删除 另 一种 方法 是 资源 监测器 定时 地向 每个 服务 进程 发 请求 若 不能 返回 结果 则 说明 该 服务 进程 发生 故障 资源 监测器 通知 调度 器 将 该 服务 进程 调度 从 调度 列表 中 删除 资源 监测器 能 通过 电子邮件 或 传呼机 向 管理员 报告 故障 一旦 监测 到 服务 进程 恢复 工作 通知 调度 器 将 其 加入 调度 列表 进行 调度 　 服务器 管理 　 　 服务器 可 运行 任何 支持 TCPIP 的 操作系统 可 采用 任何 Internet 服务器软件 也 无需 对 客户程序 作 任何 修改 可 适用 于 所有 Internet 站点 通过 系统 提供 的 管理程序 管理员 可 发 命令 随时 将 一台 机器 加入 服务 或切 出 服务 系统 实现 　 　 我们 在 Linux 操作系统 源代码 上 加入 和 改写 了 多行 C语言 代码 在 IP 层 截取 和 改写 IP 报文 实现 了 可 伸缩 的 虚拟 Internet 服务器 并 提供 了 一个 ippfvsadm 程序 进行 虚拟 服务器 的 管理系统 的 源程序 和 使用 说明 已 在 网上 发布 至今 已经 被 访问 了 多次 就 我们 所知 该 系统 已 在 美 、 英 、 德 、 澳等国 的 十几个 站点 上 正式 使用 　 　 系统 的 主要 功能模块 如图所示 其中 PFVSModule 是 虚拟 服务器 的 主控 模块 用于 截取 和 改写 IP 报文 PFVStable 表 存放 虚拟 服务器 的 规则 HashofConnections 表是 用于 记录 当前 连接 的 Hash 表 ippfvsadm 管理程序 通过 setsockopt 函数 将 虚拟 服务器 的 规则 写入 PFVStable 表中 通过 proc 文件系统 把 PFVStable 表中 的 规则 读出 Fig 　 Mailmodulesofthesystem 图 　 系统 的 主要 模块 性能 测试 　 　 我们 对 单台 Web 服务器 和 多台 Web 服务器 构成 的 虚拟 Web 服务器 的 最大 吞吐 率 和 延时 进行 了 测试 对比 测试软件 是 美国 ZDLABS 的 WebBench 服务器 都 是 Pentium 、 M 内存 和 MIntelEtherExpress 网卡 的 PC 运行 Linux 操作系统 Web 服务器 是 Apache 客户机 是 一般 的 PC 共有 台 运行 WindowsNT 操作系统 它们 通过 M 自 适应 的 ComSwitch 交换机 相连 在 WebBench 测试 时有 一个 主控 进程 和 多个 模拟 访问 的 客户 进程 主控 进程 生成 工作 负载 和 参数 发给 客户 进程 各个 客户 进程 连续 地 访问 服务器 并 记录 测试数据 等 测试 完毕 后 向 主控 进程 汇报 最后 由 主控 进程 进行 统计 测试 结果 见表 Table 　 BrieftestingresultsofWebserves 表 　 Web 服务器 性能 测试 结果 　 RequestspersecondGETss ① ThroughputBytess ② Processingdelay ③ msSingleWebServer ④ VirtualWebServer ⑤ setVirtualWebServerset ① 每秒 处理 请求 数 ② 吞吐 率 ③ 处理 延时 ④ 单台 Web 服务器 ⑤ 虚拟 Web 服务器 　 　 另外 若用 tcpdump 程序 测试 得 在 现有 配置 下 调度 器重 写 一个 报文 的 平均 延时 为 μ s 设 一个 报文 的 平均 长度 为个 字节 （ 非 本地 IP 连接 的 最大 段长度 ） 则 重写 报文 的 最大 吞吐 率为 MBytess 假设 Web 服务器 的 平均 吞吐 率为 KBytess 当 服务器 的 数目 升到 台时 才 达到 虚拟 服务器 的 最大 吞吐 率 可见 它 具有 良好 的 伸缩性 结束语 　 　 本文 对 解决 Internet 服务器 瓶颈 问题 的 已有 方法 进行 分析 比较 指出 了 它们 存在 的 不足 ； 并 给出 了 基于 IP 层 调度 的 多 服务器 解决 方法 通过 网络地址 转换 、 负载平衡 调度 、 故障 检测 技术 将 一组 提供 并行 服务 的 服务器 构成 一个 高性能 、 高 可用 的 虚拟 Internet 服务器 该 方法 具有 良好 的 伸缩性 也 无需 对 客户机 和 服务器 作 任何 修改 可 适用 于 任何 Internet 站点 章文嵩 （ 国防科学技术大学 计算机 学院 　 长沙 　 ） 吴 婷婷 （ 国防科学技术大学 计算机 学院 　 长沙 　 ） 金士尧 （ 国防科学技术大学 计算机 学院 　 长沙 　 ） 吴 泉源 （ 国防科学技术大学 计算机 学院 　 长沙 　 ） Emailwensongiinchinanet 参考文献 ． KatzEDButlerMMcGrathRAscalableHTTPservertheNCSAprototypeComputerNetworksandISDNSystems ～ ． KwanTTMcGrathREReedDANCSAsworldwidewebserverdesignandperformanceIEEEComputer ～ ． BriscoTDNSsupportforloadbalancingRFChttpandrewandrewcmuedurfcrfchtml ． DahlinAFrobergMWalerudJetalEDDIEarobustandscalableInternetserverhttpwwweddiewareorg ． EngelschallRSLoadbalancingyourWebsitepracticalapproachesfordistributingHTTPtrafficWebTechniquesMagazinehttpwwwwebtechniquescom ． WalkerEpWEB — — aparallelWebserverharnesshttpwwwihpcnusedusgSTAFFedwardpwebhtml ． AndersonEPattersonDBrewerEThemagicrouteranapplicationoffastpacketinterposinghttpwwwcsberkeleyedu ～ eandersmagicrouter ． RijsinghaniAetalComputationoftheInternetchecksumviaincrementalupdateRFChttpwwwinternicnetds ． FieldingRGettysJMogulJetalHypertextTransferprotocol — — HTTPHttpwwwworgProtocols 收稿 修稿