计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERSVolNoPWindows 下 的 视频 应用 程序开发 郑东 　 陈 淑珍 摘 　 要 ： 介绍 了 视频 应用 程序开发 的 基本原理 ， 详细 地 说明 了 视频 显示 、 捕获 及 视频 数据 的 获取 及 处理 。 结合实际 应用 讲解 了 对 视频 帧 图象 的 DIB 操作 及 通过 回调 函数 对 视频 原始数据 的 实时 获取 、 处理 。 关键词 ： VFWDIB 回调 函数 　 前言 　 　 VFWMicrosoftVideoforWindow 是 微软公司 为 开发 基于 Windows 的 视频 捕捉 、 视频 编辑 和 视频 播放 等 视频 应用程序 提供 的 软件 开发工具 。 该 开发工具 包含 了 开发 视频 应用程序 所 需要 的 接口函数 APIs ， 以求 简化 程序员 开发 基于 Windows 的 视频 应用程序 的 工作 。 　 VFW 的 体系结构 　 　 VFW 包括 AVICAP 、 MCIAVI 、 DRAWDIB 、 AVIFILE 、 ICM 等 多个 组件 ， 通过 这些 组件 间 的 协调 工作 ， 来 完成 视频 图象 的 捕获 、 播放 、 编辑 、 文件 管理 等 各种 功能 。 图 描述 了 VFW 中 各 组件 的 相互 关系 。 图 　 　 在 视频 捕获 程序 中 ， VFW 利用 AVICAP 子集 生成 AVICap 窗口 类来 完成 视频 捕获 。 　 　 VFW 利用 DRAWDIB 子集 来 完成 视频 的 编辑 。 DRAWDIB 提供 了 高性能 的 DIB 图象 的 绘画 能力 。 DRAWDIB 可 利用 ICM 将 AVI 文件 转化 为 DIB 位图 ， 利用 ICM 来 支持 压缩 的 DIB 位图 。 　 　 AVICAP 、 DRAWDIB 都 可以 通过 ICM 可选 的 压缩 管理器 来 访问 AVIFILE 子集 。 在 VFW 中 ， ICM 用来 压缩 和 解压缩 视频 数据 ； 给 显示 翻译器 提供 压缩 的 数据 ； 程序 能够 定制 专用 的 压缩 管理器 来 压缩 、 解压缩 、 绘制 视频 图象 。 　 　 VFW 利用 AVIFILE 为 视频 的 捕获 、 播放 、 编辑 等 提供 文件 的 管理 功能 。 　 　 视频 图象 的 捕获 ： VFW 是 利用 AVICAP 子集 来 开发 视频 捕捉 应用程序 的 。 AVICAP 子集 包括 一个 AVICAP 窗口 类 、 与 视频 捕捉 相关 的 回调 函数 、 向 AVICAP 窗口 发送 消息 命令 的 消息 宏 函数 集 。 　 　 AVICAP 窗口 类 是 VFW 定义 的 Windows 窗口 类 ， 该子 窗口 的 客户 区 用来 显示 采集卡 传入 计算机 的 实时 视频 图象 。 客户 区里 的 图象 可以 有 两种 显示 模式 ： 一种 是 覆盖 OverLay 模式 ； 另 一种 是 预览 PreView 模式 。 覆盖 模式 的 显示 速度 比 预览 模式 要 快 ， 但是 如果 应用程序 要 对 捕获 的 图象 进行 加工 ， 就 只能 在 预览 模式 ， 先 把 图象 送到 系统 内存 ， 在 内存 里 对 图象 进行 加工 后 ， 然后 再 把 图象 显示 出来 。 　 　 创建 AVICAP 窗口 　 　 Windows 的 MDI 应用程序 可以 在 一个 框架 窗口 中 显示 多个 文档 子 窗口 。 MFC 中 ， 每个 文档 子 窗口 包括 一个 视类 ， 一个 文档 类 ， 视类 只 用作 与 用户 交互 的 接口界面 。 这样 可以 将 AVICAP 类 窗口 定义 为视类 的 子 窗口 ， 在 窗口 客户 区中 显示 采集 的 视频 图象 ， 同时 接收 用户 的 命令 。 　 　 窗口 的 创建 过程 如下 在 视类 的 OnCreate 中 ： capCreateCaptureWindow ； 　 　 　 　 　 　 创建 AVICAP 窗口 IfcapDriverConnect 　 　 　 　 　 　 　 　 AVICAP 窗口 与 驱动程序 连接 　 　 capDriverGetCaps ； capSetCallbackOnXXX ； 　 　 　 　 　 　 　 设置 回调 函数 capCreateCaptureWindow 　 　 　 　 　 　 　 是 AVICAP 窗口 创建 函数 　 　 capDriverConnect 将 AVICAP 窗口 与 采集卡 的 驱动程序 连接起来 ， 如果 连接 成功 该 函数 返回 真值 。 然后 调用 capDriverGetCaps 检查 视频 采集卡 所 支持 的 功能 ， 返回值 保存 在 CAPDRIVERCAPS 结构 中 。 该 结构 里 的 变量 表明 采集卡 能否 支持 覆盖 显示 模式 、 能否 改变 视频 图象 的 采集 硬件 、 能否 改变 采集 的 图象 格式 等 。 　 　 capSetCallbackOnXXX 将 程序员 定义 的 回调 函数 通知 底层 驱动程序 ， 供 采集 硬件 发出 中断 消息 时 调用 。 AVICAP 中 定义 了 多个 回调 函数 的 形式 来 响应 不同 的 中断 消息 ， 它们 通过 相似 的 消息 宏 函数 设置 。 设置 函数 的 参数 中 包含 待 定义 的 回调 函数 的 函数指针 、 应用程序 的 句柄 等 。 　 　 以上 是 一个 视频 处理程序 的 最 基本 部分 ， 当 与 视频 输入 设备 连接 成功 后 即可 对 采集 的 视频流 进行 处理 。 　 　 静态 帧 图象 的 捕获 及 显示 　 　 对于 AVICAP 窗口 的 动态 视频 图象 ， 有时 需 将 当前 显示 的 一帧 图象 捕获 并 显示 出来 ， 达到 画面 凝结 的 效果 。 　 　 先 通过 capGrabFrame 消息 函数 捕获 视频 图象 的 某 一帧 图象 ， 然后 把 它 转变 为 静态 图象 保存 在 帧 图象 缓冲区 里 。 保存 在 缓冲区 里 的 图象 可以 通过 capEditCopy 宏 函数 拷贝到 剪贴板 上 。 然后 通过 DIBdeviceindependentbitmap 操作 显示 出来 。 DWORDdwSizecapGetVideoFormatSizehWnd ； capGetVideoFormathWndBitMapInfodwSize ； BitMapInfobmiHeaderbiWidthcapwidth ； BitMapInfobmiHeaderbiHeightcapheight ； 　 　 先 获得 视频 图象 的 格式 ， 确定 其 width 和 height 。 HANDLEhData ； GlobalFreeHGLOBALhData ； hDataHANDLECopyHandleGetClipboardDataCFDIB ； 　 　 获得 通过 capEditCopy 宏 函数 拷贝到 剪贴板 中 图象 数据 的 　 　 HANDLE ， 通过 CFDIB 参数 指定 数据类型 为 DIB 。 图象 数 　 　 据 的 宽 和 高 即 capwidth 和 capheight 。 CPalettempalDIBnewCPalette ； CreateDIBPaletteHDIBhDatampalDIB ； CClientDCdcthis ； 　 　 获得 客户 区 的 DC 。 CRectdcrectLONGleftLONGtopLONGrightLONGbottom ； 　 　 　 　 　 　 　 　 　 　 　 　 实际 显示 图象 的 dcrectCRectdibrectcapwidthcapheight ； 　 　 　 　 　 　 　 　 　 　 　 　 要 显示 在 dcrect 中 的 图象 实际 大小 。 PaintDIBdcmhDCdcrectHDIBhDatamarray 　 　 dibrectmpalDIB ； 　 　 一般来说 ， dcrect 与 dibrect 不会 大小 一样 ， PaintDIB 可 自行 调整 放大 或 缩小 图象 至 dcrect 大小 。 在 将 图象 显示 出来 后 ， 可 调整 视频 显示 的 窗口 的 大小 ， 避免 图象 窗口 与 视频 窗口 重叠 。 SetWindowPoshWndNULLXpositionYpositionwidthheightNULL ； 　 　 在 一个 监视 安全 系统 中 ， 通过 相应 的 视频 切换 硬件 ， 在 计算机 上 可 分别 显示 多路 视频信号 以 达到 监视 的 目的 。 但 由于 计算机 上 视频 输入 设备 的 限制 ， 每次 只能 显示 一路 活动 视频 图象 ； 若想 同时 显示 多路 视频信号 只能 通过 专用 的 硬件 如 多画面 处理器 ， 先 将 多路 视频信号 合成 为 一路 信号 再 在 计算机 上 显示 。 而 通过 上述 静态 帧 图象 的 捕获 及 显示 的 方法 也 可 再 实现 多画面 的 效果 ， 即 建立 一个 循环 显示 机制 ， 依次 捕获 各路 视频信号 的 帧 图象 并 显示 ， 然后 依次 进行 刷新 ， 实际 测试 可 得到 每秒 帧 的 效果 。 虽 不如 专用 硬件 的 效果 ， 但 在 要求 不 严格 的 场合 ， 此 方法 已 可 满足 实际 的 需要 。 　 　 也 可以 通过 capFileSaveDIB 把 缓冲区 的 图象 转化 为 DIB 位图 保存 在 磁盘 上 。 　 　 得到 捕获 图象 的 数据 　 　 作为 视频 处理程序 ， 很 重要 的 一部分 即 是 对 捕获 图象 的 原始数据 进行 处理 ， AVICAP 通过 回调 函数 机制 来 支持 这些 特定 的 应用 。 AVICAP 的 回调 函数 中 包含 视频流 回调 函数 ， 应用程序 在 视频 的 流 捕获 中 利用 该 函数 访问 捕获 的 原始数据 ； 图象 帧 回调 函数 ， 应用程序 在 预览 的 模式 下 可以 利用 该 函数 访问 待 显示 的 图象 数据 。 　 　 无论 在 视频流 回调 函数 或者 帧 回调 函数 的 参数 中 ， 都 包含 一个 指向 视频头 VIDEOHDR 结构 的 指针 。 该 结构 如下 ： STRUCTVIDEOHDR 　 LPSTRlpData ； 　 　 　 　 　 　 指向 视频 数据 缓冲区 的 指针 　 DWORDdwBufferLength ； 　 视频 数据 缓冲区 的 长度 　 DWORDdwBytesUsed ； 　 　 　 　 缓冲 中 实际 的 数据 长度 　 DWORDdwTimeCaptured ； 　 　 距离 第一 帧 捕获 图象 的 时间 　 　 从 该 结构 的 成员 变量 可以 看到 ， 利用 该 结构 可以 访问 保存 在 视频 数据 缓冲区 里 的 被 捕获 图象 的 数据 。 图象 数据 的 排列 顺序 是 根据 视频 图象 的 显示 模式 按照 象素 的 顺序排列 的 。 　 　 AVICAP 利用 capSetCallbackOnVideoStream 消息 宏 函数 设置 流 回调 函数 ， 利用 capSetCallbackOnFrame 宏 函数 设置 帧 回调 函数 。 回调 函数 设置 后 ， 流 回调 函数 在 视频流 捕获 的 每 帧 图象 存盘 之前 被 Windows 调用 ， 帧 回调 函数 在 预览 的 图象 显示 之前 被 调用 。 回调 函数 是 由 Windows 系统 来 调用 的 消息 响应函数 ， AVICAP 子 集中 的 回调 函数 是 在 采集卡 的 驱动程序 向 Windows 发出 中断 的 消息 时 由 Windows 来 响应 的 。 回调 函数 及时 地 反映 了 诸如 帧 图象 的 捕获 完成 、 采集卡 的 状态 改变 、 捕获 后台 线程 让出 CPU 控制权 等 重要 信息 ， 在 应用程序 中 有着 重要 的 应用 。 　 　 在 视频 窗口 建立 后 ， 与 视频 输入 设备 建立 连接 及 初始化 完成 后 ， 设置 回调 函数 。 intCViewOnCreateLPCREATESTRUCTlpCreateStruct 　 CapSetCallbackOnVideoStreamhwndC 　 　 LPVOIDMakeProcInstanceFARPROCcapVideoStreamCallbackAfxGetInstanceHandle ； LRESULTCALLBACKEXPORTcapVideoStreamCallbackHWNDhWndLPVIDEOHDRlpVHdr 捕获 数据流 的 回调 函数 　 　 通过 VIDEOHDR 结构 的 指针 lpVHdr 即可 获得 视频 数据 并 　 　 进行 处理 。 　 　 帧 回调 函数 capSetCallbackOnFrame 在 预览 的 图象 显示 之前 被 调用 ， 工作 于 预览 Preview 模式 。 先 把 图象 送到 系统 内存 ， 在 内存 里 对 图象 进行 加工 后 ， 再 把 图象 显示 出来 。 逐帧 捕获 图象 数据 的 回调 函数 ， 速度 较慢 ， 但是 可以 将 处理 后 的 活动 视频 图象 显示 出来 。 例如 要 在 视频 图象 上 显示 一个 方框 以 标记 某一 特定 区域 就 可 使用 帧 回调 函数 。 CapSetCallbackOnFrame 的 设置 相同 于 capSetCallbackOnVideoStream 函数 。 LRESULTCALLBACKEXPORTcapVideoStreamCallbackHWND 　 hWndLPVIDEOHDRlpVHdr 捕获 数据流 的 回调 函数 BYTEdata ； 　 　 　 　 　 　 　 当前 的 图象 数据 kcapheightcapwidth ； 　 k 为 捕获 图象 的 实际 大小 foriik ； i 　 datailpvdhrlpDatai ； 　 捕获 的 图象 数据 读入 data 　 对应 于 方框 上 的 每 一点 ， 通过 其 在 图象 上 的 实际 坐标 找到 data 　 中 表示 该点 的 数据 ， 将 其 变为 黑色 。 returnLRESULTTRUE ； 　 　 将 视频 数据 保存 为 AVI 格式 的 文件 也 是 常用 的 处理 方式 　 　 AVI 文件格式 保存 。 捕获 过程 如下 ： capFileSetCaptureFile ； 　 　 　 　 设置 保存 文件 的 文件名 capFileAlloc ； 　 　 　 　 　 　 　 　 　 分配 捕获 文件 的 磁盘空间 可选 capCaptureSequence ； 　 　 　 　 　 　 开始 进行 视频 图象 的 捕获 capCaptureAbort ； 　 　 　 　 　 　 　 结束 视频 捕获 　 　 capFileAlloc 预先 分配 捕获 文件 所 占 磁盘 的 空间 大小 ， 可以 避免 在 磁盘 中 产生 碎片 ， 提高 视频 数据流 的 保存 速度 。 CapCaptureSequence 启动 图象 的 捕获 ， 捕获 的 时间 可以 在 CAPTUREPARMS 结构 里 设置 ， 也 可以 由 capCaptureAbort 中途 退出 捕获 过程 。 　 　 capCaptureSetSetup 配置 图象 捕获 过程 中 的 工作 参数 。 该 函数 的 参数表 包含 一个 指向 捕获 参数 CAPTUREPARMS 结构 的 指针 。 CAPTUREPARMS 结构 中 主要 成员 变量 和 它们 的 功能 如下 ： STRUCTCAPTUREPARMSDWORDdwRequestMicroSecPerFrame ； 　 　 　 　 　 　 　 　 　 每帧 图象 的 捕获 时间 ， 以 毫秒 为 单位 UINTwPercentDropForError ； 　 　 　 　 　 　 　 　 　 捕获 过程 中 ， 系统 忙 时 允许 的 掉 帧 数目 UINTwTimeLimit ； 　 捕获 的 时间 　 　 AVI 文件 是 一种 适合 存储 播放 视频 信息 的 文件格式 　 　 AVI 是 参考 交换 文件格式 RIFFReferenceInterchangeFileFormat 数据结构 型 文件 。 其 结构 如下 ： RIFFAVILISThdrl 　 AvihMainAVIHeader 　 　 LISTstrl 　 　 　 StrhStreamheader 　 　 　 StrfStreamformat 　 　 　 additionalheaderdata 　 　 LISTmovi 　 　 　 LISTrec 　 　 　 　 subchunk 　 　 　 　 subchunk 　 　 　 　 AVIIndex 　 　 　 　 MainAVIHeader 是 文件 头 结构 ， 规定 文件 中帧 数 和 文件大小 等 信息 ， Streamheader 是 关于 流 信息 的 数据流 结构 。 Streamformat 则 根据 流 的 类型 fccType 而定 ， 如是 视频流 ， 一般 是 一个 BITMAPINFO 结构 。 视频 数据 块 chunk 可 分为 类 ， db 为 未 压缩 的 RGBDIB 结构 ， dc 为 压缩 的 DIB 数据 ， pc 为 调色板 改变 了 的 数据 。 压缩 的 DIB 数据 在 播放 时 必须 调用 指定 的 解压缩 程序 。 　 　 处理 和 编辑 AVI 需要 获得 原始数据 流 。 AVIFileOpen ； 　 　 打开 一个 AVI 文件 并 获得 文件 的 句柄 AVIFileInfo ； 　 　 获得 AVI 文件 的 相关 信息 如 图象 的 Height ， 　 　 　 Width 和 AVI 文件 中 数据流 Datastream 的 数目 等 信息 AVIFileGetStream ； 　 建立 一个 指向 需要 访问 的 数据流 的 指针 AVIStreamInfo ； 　 读取 存储 数据流 信息 的 AVISTREAMINFO 结构 AVIStreamRead ； 　 　 　 　 　 读取数据 流中 的 原始数据 ， 视频 数据流 中 的 原始数据 　 　 　 　 　 是 构成 图象 的 数据位 。 对于 压缩 图象 ， 只有 对 其 解压 　 　 　 　 　 缩后 才能 使用 。 AVIStreamRelease ； AVIFileRelease ； 　 　 当 VideoStream 中 的 数据 是 经压缩 的 ， 可用 AVIStreamGetFrameOpen ， AVIStreamGetFrame 及 AVIStreamGetFrameClose 来 读取 。 PGETFRAMEAVIStreamGetFrameOpenpavilpbiWanted ； 　 pavi 是 指向 视频 数据流 的 指针 ， 返回 一个 GetFrame 对象 供 　 AVIStreamGetFrame 使用 来 读取数据 ， 如果 系统 不能 找到 能 　 将 压缩 的 视频 数据流 解压缩 的 解压缩 程序 ， 返回 NULL 。 LPVOIDAVIStreamGetFramePGETFRAMEpgfLONGlPos ； 　 lPos 指定 视频 数据流 中所 需 的 帧 的 位置 。 AVIStreamGetFrame 　 函数 读取 视频 数据流 的 格式 及 数据位 ， 根据 需要 它 还 对 压 　 缩 的 视频 数据流 进行 解压缩 。 返回 指向 　 BITMAPINFOHEADER 结构 的 指针 ， 通过 　 BITMAPINFOHEADER 结构 应用程序 可以 读取 解压缩 后 的 　 帧 图象 的 DIB 数据 。 LONGAVIStreamGetFrameClosePGETFRAMEpget ； 　 释放 系统资源 　 结束语 　 　 本文 对 视频 程序 的 开发 作 了 较为 详细 的 描述 ， 介绍 了 视频 应用程序 常见 的 编程 方法 ， 对 实际 开发 应用 中 的 问题 提出 了 相应 的 解决 方法 。 郑东 武汉大学 电信 学院 武汉 陈 淑珍 武汉大学 电信 学院 武汉 参考文献 MicrosoftCorporationVideoforWindowDevelopmentKitKateGregoryVisualC 开发 使用手册 北京 ： 机械 工业 出版社 收稿 日期 ： 年月日