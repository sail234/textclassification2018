计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERSVolNoP 分布式 智能 监控 系统 视频 多画面 显示 的 设计 与 实现 卢 选民 　 张原 　 史浩山 摘 　 要 ： 详细 讨论 了 基于 计算机网络 的 分布式 智能 视频 监控 系统 视频 多画面 显示 的 设计 原理 和 实现 方法 ， 给出 了 在 局域 和 广域 网络 环境 下 分布式 智能 视频 监控 系统 的 硬件 结构 和 视频 切换 卡 的 设计 与 应用 ， 并 给出 了 最终 采用 分 时 机制 和 消息 映射 模式 实现 视频 多画面 显示 的 软件 编程 。 关键词 ： 视频 监控 视频 切换 分 时 机制 消息 映射 　 引言 　 　 计算机技术 、 通信 技术 和 网络 技术 的 快速 发展 ， 加快 了 数字 监控 取代 模拟 监控 的 步伐 ， 数字化 视频 监控 已 成为 视频 监控 发展 的 必然趋势 。 数字化 监控 不仅 可以 利用 计算机网络 和 先进 的 视音频 压缩 、 解压缩 技术 实现 远程 视频 监控 ， 还 可 根据 报警 功能 需求 设置 灵活多样 的 报警 联动 ， 生成 详细 的 报警 记录 和 操作 记录 数据库 ， 设计 完善 的 系统 用户 权限 管理 等 功能 。 在 充分考虑 数字化 监控 系统 所 应有 特点 的 前提 下 ， 我们 设计 了 基于 CS 模式 的 分布式 智能 视频 监控 系统 。 本 系统 多媒体 软件 的 设计 以 MicrosoftWindows 为 操作控制 平台 ， 设计 的 显示 图象 和 图形界面 规范 、 友好 。 对 视频 、 音频 多媒体信息 的 编程 采用 了 Windows 下 的 VFW 多媒体 开发 制作 平台 和 Visual C语言 编写 ， 采用 先进 的 窗口 技术 和 计算机管理 控制技术 ， 实现 了 多媒体 监控 网络系统 的 功能 要求 。 系统 不仅 具有 数字 监控 系统 所 必备 的 特点 ， 还 具有 动态 视频 路由 选择 、 视频 桥 和 远程 视频 代理 功能 。 并 具有 ～ 多窗口 视频 显示 和动 、 静态 视频 捕捉 功能 ， 灵活 的 报警 信息 过滤 功能 ， 外接 电视墙 、 监视器 功能 ， 图形化 的 报警 布防 信息 设置 和 显示 功能 ， 以及 完善 的 系统 和 外设 异常 处理 功能 ， 在 实际 应用 中 取得 了 比较满意 的 效果 。 　 　 系统 图象 监视 功能 包括 计算机屏幕 上 实时 显示 多幅 动态 图象 ； 实现 多画面 与 单 画面 的 相互 切换 ； 视频 图象 信号 的 输入输出 以为 基本 单元 ， 并 可 根据 需要 随意 扩展 ； 循环 显示 多路 视频 图象 画面 和 音频 声音 等 。 　 　 在 VGA 监视器 上 实现 多画面 的 显示 ， 就是 在 VGA 监视器 的 不同 区域 上 显示 多路 CCD 摄像头 图象 信号 ， 以便 对 多个 地点 同时 进行 观测 。 一般 有 两种 实现 方法 ： 　 　 第一种 是 通过 多块 视频 叠加 卡 实现 多路 图象 信号 同时 显示 ， 即 每块 视频卡 接 一路 图象 信号 。 这种 方法 效果 好 ， 多路 图象 信号 在 监视器 不同 区域 上 各自 独立 地 同步 显示 ， 彼此 不 受 影响 。 缺点 是 实现 代价 太高 ， 多 一路 图象 信号 就要 多 一块 视频 叠加 卡 ， 而且 还 受 计算机 扩展槽 个数 的 限制 。 　 　 第二种 方法 是 采用 一块 视频 叠加 卡 实现 多路 信号 分 时 显示 ， 即 在 一块 视频 叠加 卡 的 图象 来源 上 接入 视频 切换 卡 ， 通过 视频 切换 卡 接入 多个 视频 源 信号 。 这种 方法 的 优点 是 成本低 ， 可以 直切 到 某个 视频 源上 单幅 画面 动态显示 ， 也 可以 通过 轮切 的 方式 实现 多幅 画面 的 同时 显示 ， 最多 可达 画面 ， 并且 各个 图象 视窗 的 尺寸 可 根据 需要 用 鼠标 拖动 随意 缩放 ； 缺点 是 多画面 显示 时 ， 各个 图象 信号 是 在 VGA 监视器 不同 区域 上 分时 显示 ， 因而 图象 有 跳动 感 。 当 画面 的 个数 比较 少 ， 并且 采用 高速 切换 开关 ， 同时 分时 的 时间 控制 恰当 时 ， 还是 可以 做到 多画面 同时 动态显示 的 效果 。 其 工作 原理 如图所示 。 图 　 视频 多画面 显示 工作 原理 　 视频 多画面 显示 的 硬件 结构 　 系统 硬件 结构 　 　 根据 系统 的 具体 要求 ， 我们 采用 第二种 方法 实现 视频 的 多画面 显示 功能 。 依 此 我们 构架 了 系统 的 硬件 结构 如图所示 ， 视频 主机 作为 本地 局 网上 的 一个 结点 ， 可以 通过 LAN 与 本地 其它 视频 主机 以 Mbps 速率 交换 信息 ， 可 通过 DDN 、 PSTN 、 ATM 等 广域网 或 园区 网 与 远程 视频 主机 相连 。 系统 中 每台 视频 主机 视 具体情况 可 分别 接 、 、 、 、 路 视频 输入 ， 系统 以 定时 轮切 和 手动 切换 方式 在 ～ 多窗口 中 动态 实时 显示 一路 视频 输入 ， 系统对 接入 视频 的 监控 是 通过 视频 矩阵 切换 卡 实现 的 ， 矩阵 切换 卡可 实现 输入输出 端的 全 连通性 。 图 　 系统 硬件 结构 　 视频 切换 卡 　 　 视频 切换 卡是 专为 视频信号 切换 而 设计 的 。 它 是 由 一组 视频 开关 矩阵 组成 的 路 输入 路 输出 开关 阵列 。 在 路 输入 中 ， 每 一路 都 可以 根据 不同 的 控制 命令 切换 到 路 输出 中 的 任何 一路 。 其 原理 框图 如图所示 。 图 　 视频 切换 卡 原理 框图 　 　 输入 和 输出 组成 了 一个 阵列 。 输入 相当于 行 ， 输出 相当于 列 。 在 行列 交叉点 上 都 有 一个 开关 。 开关 的 接通 与否 由 控制 寄存器 控制 。 在 输出 所在 的 列上 ， 每次 只能 有 一行 接通 。 这样 ， 每路 输出 都 可以 与 任何 一路 输入 接通 。 从而 达到 信号 的 切换 。 　 　 目前 市面上 有 多种 视频 矩阵 切换 芯片 可 供选择 ， 我们 选择 了 MAXIM 公司 的 MAX 芯片 ， 它 不但 具有 串 、 并行 数字 接口 ， 还 具有 通道 隔离度 高等 特点 ， MAX 有个 输入 端 和 个 输出 端 ， 通过 多块 MAX 可以 设计 出 输入 ， 输出 、 等 多种 规格 的 视频 矩阵 切换 卡 ， 为 达到 输入输出 的 全 连通性 ， 需要 片 MAXIM ， 需要 片 MAXIM ， 当 需要 更 多 的 输入输出 时 ， 考虑 到 切换 卡 不能 太 大 ， 可以 采用 多块 级 连 的 方式 。 　 　 最后 ， 我们 设计 实现 的 视频 切换 卡 引线 插座 位置 可 如图所示 。 图 　 视频 切换 卡 引线 插座 示意图 　 　 输出 输入 引线 　 　 输出 输入 引线 为 D B型 插座 ， 其 对应 关系 为 ： 引脚 ～ 对应 输出 第一路 到 第八 路 ； 引脚 ～ 对应 输入 第一路 到 第十六 路 。 其余 引脚 为 地线 。 　 　 扩展 引线 　 　 IN 、 IN 、 OUT 为 扩展 插座 ， 用以 扩展 输入输出 通道 数 使用 。 　 　 DIP 拨码 开关 　 　 本 开关 用以 选择 本卡 地址 编码 。 具体 使用 见 地址 选择 部分 。 　 　 负载 跳线 开关 　 　 LOAD 为 内外 负载 跳线 开关 ， 用来 选择 内外 负载 。 当单 块 卡 独立 使用 时 ， LOAD 接 “ ” ， 断开 “ ” 。 当 扩展 使用 时 ， 如果 几块 卡 输出 相连 即 扩展 输入 时 ， 只能 有 一块 卡 LOAD 接 “ ” ， 其余 卡均 接 “ ” 。 　 　 每块 视频 切换 卡 都 用 一个 位 DIP 拨码 开关 来 选择 该卡 的 地址码 ， 其 对应 关系 为 ： DIP 开关 的 第一位 对应 PC机 地址总线 的 A 。 第八位 对应 A 。 用户 可以 根据 实际 情况 选择 不同 地址 。 当 用户 要求 输入 大于 路 ， 输出 大于 路时 ， 可用 多块 卡来 扩展 输入 或 输出 的 数目 。 扩展 连接 示意 如图所示 。 图 　 视频 切换 卡 的 扩展 连接 　 　 该图 是 一 扩展 为路 输入 ， 路 输出 的 示意图 。 如图 把 左 半部 或 右半部 取掉 ， 就是 一个 路 输入 路 输出 的 扩展 。 如果 把 上半部 或 下 半部 取掉 ， 就是 一个 路 输入 路 输出 的 扩展 。 用户 也 照此 办法 ， 将 其 扩展 到 更 大 的 组合 。 　 视频 多画面 显示 的 软件 实现 　 　 要 实现 视频 多画面 分 时 显示 ， 首先 必须 有 分时 的 机制 。 在 本 系统 中 ， 通过 SetTimer 函数 建立 定时器 ， 每隔 一定 时间 发送 一次 WMTIMER 消息 。 VoidTVideoWindowWMCreateRTMessage 　 　 　 　 　 　 　 　 　 　 　 　 　 　 接收 WMCREATE 消息 TwindowSetupWindow 　 ifSetTimerHwindowVIDEOTIMEGAPNULLNULLMessageBoxNULL “ 定时器 建立 不 成功 ” 　 　 　 　 　 　 　 　 “ 错误信息 提示 ” MBOKCANCEL 　 　 当 消息 处理函数 接收 到 WMTIMER 消息 后 ， 用 FreezeVideo 冻结 目前 的 活动 图象 ， 然后 用 SetVideoSource 函数 把 视频 来源 切换 到 下 一个 ， 并用 SetVideoScaling 设置 图象 长宽 的 大小 ， 最后 用 SetCaptureAddress 函数 设置 下 一个 活动 图象 的 显示 位置 。 这样 ， 活动 画面 就 由 前 一个 转到 后 一个 ， 实现 视频 图象 的 分时 显示 。 程序逻辑 如图所示 。 图 　 程序实现 流程图 VoidTVideoWindowWMTimerTmessagemsg 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 接收 WMTIMER 消息 ifmsgWparamVIDEO 　 　 　 inti ； 　 　 intWidthxWinWidth ； 　 　 intskewWidth ； 　 　 ifwVideoSourcewVideoSource ； 　 　 FreezeVideo ； 　 　 SetVideoSourcewVideoSource ； 　 　 SetVideoScalingWidthskewyWinHeightTRUE ； 　 　 ifwVideoSource 　 　 　 SetCaptureAddress ； 　 　 else 　 　 　 SetCaptureAddressWidthskew ； 　 　 iwVideoSource ； 　 　 UnFreezeVideo ； 　 　 WVideoSource ； 　 　 　 在 本 系统 的 研制 与 开发 中 ， 我们 采用 视频 矩阵 切换 芯片 来 实现 视频 切换 。 但是 在 实际 应用 中 ， 我们 发现 其 切换 速度 还是 受到 一定 限制 。 在 实现 多画面 动态显示 的 过程 中 ， 当 画面 的 个数 较多时 图象 还是 无法 消除 跳动 感 ， 这 主要 是 由于 硬件 原因 造成 的 。 要 真正 消除 这种 画面 跳动 感 ， 只有 从 硬件 着手 。 一种 可选 的 方案 就是 采用 目前 正在 发展 并 不断 成熟 的 新型 图象 捕捉 卡来 代替 视频 切换 卡 ， 这种 图象 捕捉 卡 在 实现 视频 多画面 动态显示 时 的 工作 原理 和 多画面 分割器 基本 类似 ， 只不过 多画面 分割器 是 模拟 的 ， 而 图象 捕捉 卡是 数字 的 ， 并 采用 总线结构 ， 可 快速 实现 多路 视频信号 的 输入 和 轮流 采集 ， 最后 以 时分复用 方式 输出 一路 数字信号 。 这样 ， 通过 软件 编程 分 时 ， 就 可 直接 实现 多画面 在 监视器 不同 分区 以 帧 秒 的 速度 显示 ， 从而 较 好地解决 了 画面 的 跳动 问题 。 但 从 软件 编程 角度 来讲 ， 与 我们 所 采用 的 方法 是 一致 的 。 卢 选民 西北工业大学 电子 工程系 西安 张原 西北工业大学 电子 工程系 西安 史浩山 西北工业大学 电子 工程系 西安 参考文献 AndrewSTanenbaumComputerNetworksThirdEditionPrenticeHallInternationalIncMicrosoftCorparationVisualCOnlineHelp 王中平 魏云 王毅 计算机 MULTIMEDIA 多媒体 实用技术 西安 ： 陕西 电子 出版社 收稿 日期 ： 年月日