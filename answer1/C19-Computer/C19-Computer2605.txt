软件 学报 JOURNALOFSOFTWARE 年 第期 第卷 VolNo 基于 R PC机 制 的 容错 计费 系统 的 设计 与 实现 杨家 海 　 吴建平 　 　 摘要 　 网络 计费 管理 是 商业化 计算机网络 的 重要 网络管理 功能 随着 Internet 商业化 进程 的 推进 和 企业 Intranet 的 广泛 发展 与 应用 人们 对 网络 计费 管理 的 需求 越来越 迫切 对 计费 系统 的 一个 基本 要求 就是 高效 、 可靠 文章 提出 了 一个 基于 RPC 通信 机制 的 容错 计费 系统 FTChargefaulttolerantcharge 在 简述 了 计费 的 基本 依据 和 原理 以后 着重 论述 了 FTCharge 的 总体 结构 和 多 容错 机制 的 实现 　 　 关键词 　 计算机网络 Internet 网络管理 SNMPsimplenetworkmanagementprotocol 计费 管理 RPCremoteprocedurecall 　 　 中图法 分类号 　 TP 　 DesignandImplementationofanRPCbasedFaulttolerantAccountingManagementSystemYANGJiahaiWUJianpingDepartmentofComputerScienceandTechnologyTsinghuaUniversityBeijingNetworkResearchCenterTsinghuaUniversityBeijing 　 　 Abstract 　 NetworkaccountingmanagementistheimportantmanagementfunctionofcommercializedcomputernetworkWiththecommercializationofInternetandtheoccurrenceoflotsofIntranetsitsurgenttodevelopnetworkaccountingmanagementsystemAprincipalrequirementofsuchsystemsisefficiencyandreliabilityAfaulttolerantaccountingsystembasedonRPCremoteprocedurecallmechanism — — FTChargefaulttolerantchargeisproposedinthispaperAfterthebriefdiscussionoftheaccountingprinciplethedesignofthearchitectureandthefaulttolerancemechanismofFTChargesystemarediscussed 　 　 Keywords 　 ComputernetworkInternetnetworkmanagementSNMPsimplenetworkmanagementprotocolaccountingmanagementRPCremoteprocedurecall 　 　 随着 信息 社会 对 网络 的 依赖 程度 越来越 高 网络 的 高效 、 可靠 的 运行 管理 也 越来越 重要 ［ ］ 和 网络 互连 技术 本身 一样 网络管理 正在 向 标准化 的 方向 发展 ［ ］ 在 网络管理 技术 的 研究 、 发展 和 标准化 方面 国际标准化组织 ISO 和 Internet 体系结构 委员会 及其 下属 的 工作组 都 做 了 卓有成效 的 工作 早 在 世纪 年代 末 国际标准化组织 在 提出 其 开放系统 互连 参考模型 OSIRMopensysteminterconnectionreferencemodel 的 同时 就 提出 了 网络管理 标准 的 框架 即 开放系统 互连 管理 框架 ISO ［ ］ 并 制定 了 相应 的 协议 标准 即 公共 管理 信息 服务 和 公共 管理 信息 协议 CMISCMIPcommonmanagementinformationservicecommonmanagementinformationprotocol ［ ］ 开放系统 互连 管理 框架 ISO 将 网络管理 划分 为 大 功能域 即 配置管理 、 失效 管理 、 性能 管理 、 计费 管理 和 安全 管理 ［ ］ 在 此 框架 基础 上 Internet 体系结构 委员会 提出 了 相应 的 网络管理 标准 即 简单 网络管理 协议 SNMP （ simplenetworkmanagementprotocol ） ［ ］ 　 　 网络 计费 管理 是 商业化 计算机网络 的 重要 管理 功能 ［ ］ 早期 Internet 网络 是 一个 学术研究 网络 网络管理 技术 的 发展 相对 滞后 尤其 是 计费 管理 更 未 得到 应有 的 重视 随着 Internet 商业化 进程 的 推进 和 Intranet 的 广泛 发展 与 应用 人们 对 网络 计费 管理 的 需求 日益突出 ［ ］ 　 　 为了 满足 这种 需求 一些 网络 运行 主管部门 也 自行 开发 了 一些 计费 软件 但 这些 计费 软件 基本上 都 是 单机 运行 的 一旦 该机 出现 故障 或者 连接 该机 的 局部 网络 中断 就 会 丢失 计费数据 造成 直接 的 经济损失 因此 ， 如何 确保 计费 系统 的 高效 、 可靠 运行 ， 就 成 了 一个 亟待解决 的 问题 提高 可靠性 的 一个 直接 办法 是 多个 计费 系统 同时 运行 但 由于 大型 网络 的 计费数据 量 很大 而且 计费数据 本身 是 动态变化 和 不可 重复 出现 的 因此 如何 保证 几个 备份 的 计费 系统 之间 同步 协调 工作 就 成为 这 类 计费 系统 首先 要 解决 的 问题 本文 提出 了 一个 基于 R PC机 制 的 容错 计费 系统 FTChargefaulttolerantcharge 本文 在 简述 了 计费 的 基本 依据 以后 着重 论述 了 FTCharge 的 总体 结构 和 多 容错 机制 的 实现 费 的 依据 和 原理 　 　 计费 的 基本 依据 是 用户 使用 网络资源 的 情况 如 信息 传输 量 、 占用 线路 的 时间 等 对于 专用 租线 来说 最 常用 的 方法 就是 根据 每个 用户 通过 网络 使用 的 信息 传输 量 （ 通常 称为 计费数据 ） 来 计算 其 费用 计费数据 的 获取 有 两种 方式 一种 是 通过 标准 的 SNMP 操作 来 获取 另 一种 是 通过 总线 监听 来 获取 　 　 Internet 标准 网络管理 协议 SNMP 在 定义 了 基本 的 网络管理 操作 的 同时 也 定义 了 一系列 支持 操作 语义 的 管理 信息 变量 MIB （ managementinformationbase ） 其中 就 有 和 计费 相关 的 MIB 变量 只要 对 被 管理 对象 （ 通常 是 连接 本 网络 和 外部 网络 的 边界 路由器 ） 作 适当 的 配置 被 管 对象 将 自动记录 所有 通过 该 路由器 的 进出 流量 以 Cisco 路由器 为例 它 所 记录 的 计费 信息 是 如下 格式 的 一张 表 SourceIPAddress … … DestinationIPAddress … … nPkts … … nBytes … … 　 　 当 每 一个 数据包 由 路由器 通过 时 路由器 将 搜索 表中 是否 有 与 之 相匹配 的 SourceIPAddress 和 DestinationIPAddress 对 如果 找到 匹配 的 记录 则 将 其 累加 否则 创建 一个 新 记录 这些 记录 可 通过 SNMP 标准 操作 而 获得 　 　 另 一种 计费数据 获取 的 方法 是 利用 以太网 总线 的 广播 特性 在 网络连接 的 适当 地方 接入 一个 只 被动 接听 信息 的 设备 然后 运行 一个 只 截获 数据 包头 的 软件 通过 分析 数据 包头 的 有关 信息 可以 得到 用户 使用 网络 的 各种 信息 如 总 的 进出 流量 、 流量 的 类型 如 telnetftphttpmail 等等 　 　 上述 两种 计费数据 获取 方法 各有利弊 第种 方法 是 标准 的 方式 通过 SNMP 操作 即可 实现 而且 也 无需 额外 的 设备 投资 但 这种 方法 的 一个 缺点 是 计费数据 粒度 较 粗 只 计到 IP 级 即 用户 只能 知道 通信量 的 总 字节数 第种 方式 的 好处 是 用户 可以 根据 需要 指定 计费数据 的 粒度 ， 不但 可以 获取 总 通信量 还 可以 知道 各种 业务 类型 分别 占用 多少 这 将 有利于 用户 对 不同 流量 类型 采取 不同 的 收费 标准 也 有利于 用户 就近 配置 适合 的 资源 缺点 是 缺乏 标准 且 需 额外 的 设备 投资 而且 依赖于 网络拓扑 结构 用户 在 具体 应用 中 可以 根据 需要 选择 其中 的 一种 系统 总体 结构 　 　 FTCharge 系统 是 以 RPC 通信 为主 的 分布式 计费 系统 系统 的 总体 结构 如图所示 图 　 FTCharge 系统 总体 结构 　 　 整个 FTCharge 计费 系统 由个 管理 监控 子系统 、 个主 计费 系统 和 个 或 多个 备份 计费 系统 组成 管理 监控 子系统 Monitors 的 主要 功能 是 监视 主 计费 系统 和 各 备份 计费 系统 的 工作 情况 当 它 发现 主 计费 系统 出现 故障 时 将 根据 系统 预先 设定 的 策略 自动 地 从 多个 备份 计费 系统 中 选出 一个 正常 工作 的 系统 并 启动 该 系统 以 接替 计费数据 的 采集 工作 当 它 发现 主 计费 系统 的 故障 已经 修复 并 正常 工作 时 又 会 自动 停止 备份 计费 系统 的 工作 以 确保 任一 时刻 只有 个 计费 系统 在 工作 Monitors 以 ICMP 和 一个 进程 监视 工具 来 监视 计费 系统 的 网络连接 、 主机 本身 和 系统 各 进程 是否 正常 工作 　 　 计费 子系统 是 整个 FTCharge 的 核心 它 负责 所有 计费数据 的 采集 、 处理 和 加工 工作 从 理论 上 讲 ， 这些 工作 是 可以 在 一个 系统 上 实现 的 但 考虑 到 计费数据 可能 存在 于 多个 主机 上 为了 维护 数据 的 完整性 和 一致性 将 数据 的 采集 和 后续 的 加工 处理 分开 专门 设置 一个 数据库 服务器 来 加工 处理 来自 各个 主机 的 计费数据 这样 做 也 有利于 数据 采集 系统 集中力量 收集 数据 事实上 ， 计费数据 采集 的 实时性 是 很 强 的 由于 计费数据 在 被 读取 之前 需在 缓冲区 中 暂存 且 缓冲区 一旦 被 存满 之后 后续 的 数据 不再 写入 因此 数据 采集 系统 在 读取数据 之后 要 负责 清空 缓冲区 因此 任一 时刻 只 允许 一个 数据 采集 系统 进行 数据 采集 否则 将 引起 数据 的 不 完整性 和 不一致性 甚至 丢失 数据 　 　 备份 系统 本身 的 功能 是 与 主 计费 系统 完全 一样 的 只是 在 正常 情况 下 它 处于 空闲 （ idle ） 状态 一旦 主 系统 出现 故障 它 将 收到 来自 监控 子系统 的 指令 并 进入 工作 （ active ） 状态 此时 ， 它 完成 与 主 计费 系统 完全 一样 的 工作 容错性 的 实现 　 　 容错性 的 实现 是 提高 计费 系统可靠性 的 关键 本 系统 采用 基于 远程 过程 调用 RPC （ remoteprocedurecall ） 的 分布式 监视 和 控制 机制 来 实现 系统 的 容错性 对 计费 系统 的 监视 和 控制 是 由 监控 子系统 实现 的 　 　 监控 子系统 从 逻辑 上 分成 这样 几个 步骤 　 　 监视 主 计费 系统 的 网络 、 主机 及 系统 运行 情况 　 　 当主 计费 系统 发生 故障 时 选择 一个 可用 的 备份 计费 系统 并 启动 　 　 监视 当前工作 的 备份 计费 系统 　 　 继续 监视 主 计费 系统 （ 故障 恢复 情况 ） 　 　 在 当前 运行 的 备份 计费 系统 也 发生 故障 时 从 剩下 的 备份 计费 系统 中 选择 一个 可用 的 系统 并 启动 它 　 　 当主 计费 系统 已经 恢复正常 时 停止 备份 计费 系统 的 工作 为了 更好 地 描述 监控 系统 的 工作 过程 ， 下面 以半 形式化 的 语言 来 描述 它 的 实现 算法 Monitors 算法 BEGIN 　 　 定义 主 计费 系统 Primary 　 　 备份 计费 系统 数量 NUM 　 　 定义 备份 计费 系统 集 Backup ［ NUM ］ 　 　 定义 最大 重试 次数 MaxRetry 　 　 　 WHILETRUE 　 　 　 　 　 　 　 不间断 运行 　 　 　 　 　 ResultTestPrimary 　 　 　 　 测试 主 计费 系统 的 运行 情况 　 　 　 　 　 IFResult “ ok ” 　 　 　 　 　 THEN 　 　 　 　 　 　 　 　 　 　 主 计费 系统 正常 　 　 　 　 　 　 　 sleepawhile 　 　 　 　 　 隔 一段时间 继续 测试 　 　 　 　 　 　 　 continue 　 　 　 　 　 　 　 　 　 　 ELSE 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 Result “ failed ” 当前 测试 失败 　 　 　 　 　 　 　 i 　 　 　 　 　 　 　 　 　 一次 失败 不足以 下结论 　 　 　 　 　 　 　 WHILEi ＜ MaxRetry 　 　 　 　 　 　 　 　 　 　 　 ResultTestPrimary 　 　 　 　 　 　 　 　 　 　 　 IFResult “ ok ” 　 　 　 是 瞬时性 间断 现在 又 恢复 了 ！ 　 　 　 　 　 　 　 　 　 　 　 THEN 　 　 　 　 　 　 　 　 　 　 　 　 　 iMaxRetry 　 　 跳出 循环 　 　 　 　 　 　 　 　 　 　 　 ELSE 　 　 　 　 　 　 　 　 　 　 　 　 　 ii 　 　 进行 下 一次 测试 　 　 　 　 　 　 　 　 　 　 　 　 　 　 IFiMaxRetry 　 　 　 　 　 　 　 THEN 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 sleepawhile 　 　 　 　 　 　 　 　 　 continue 　 　 　 　 　 　 　 　 　 　 　 　 　 ELSE 　 　 　 　 　 　 　 MaxRetry 次测试 都 有 故障 可以 认为 该 系统 确实 发生 故障 　 　 　 　 　 　 　 　 　 　 　 　 　 　 x 　 　 　 　 　 　 　 　 WHILEx ＜ NUM 　 　 从 备份 系统 中 选择 一个 好 的 　 　 　 　 　 　 　 　 　 　 IFBackup ［ x ］ isOK 　 　 　 　 　 　 　 　 　 　 THEN 　 　 　 　 　 　 　 　 　 　 　 RPCstartBackup ［ x ］ 　 远程 过程 调用 启动 备份 系统 X 　 　 　 　 　 　 　 　 　 　 　 startmonitorBBackup ［ x ］ 　 开始 对 X 进行 监视 　 　 　 　 　 　 　 　 　 　 　 monitorPPrimary 　 继续 监视 主 计费 系统 以 了解 其 修复 情况 　 　 　 　 　 　 　 　 　 　 　 exit 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ENDofOuterWHILE 　 　 END 　 　 对 被 启动 的 备份 系统 的 监视 流程 与 此 相似 对 故障 主 计费 系统 进行 跟踪 监视 的 过程 也 与 此 相似 只不过 判断 条件 和 执行 的 动作 正好 相反 限于 篇幅 这里 就 不再 重复 了 计费 子系统 　 　 真正 完成 计费数据 采集 、 处理 、 加工 、 统计 乃至 最终 生成 报表 帐单 等 工作 的 是 计费 子系统 我们 设计 的 计费 子系统 以 关系数据库 为 核心 由 数据 采集 、 预处理 、 计费数据 处理 和 计费 信息 查询 等 几个 模块 组成 其 组成 结构 如图所示 图 　 计费 子系统 的 组成 结构 　 　 经过 多方 论证 在 目前 阶段 我们 决定 先 实现 第种 方式 的 数据 采集 功能 但 为 将来 采用 第种 方式 （ 总线 监听 ） 的 数据 采集 留出 扩展 接口 计费数据 以 小时 为 单位 先 形成 数据文件 预处理 模块 定期 接收 并 处理 这些 文件 预处理 模块 将 分析 数据 文件格式 的 正确性 、 IP地址 的 合法性 并 做 初步 的 统计 （ 累加 ） 工作 最后 形成 数据库 记录 并 入库 　 　 计费数据 处理 模块 的 功能 是 对 数据库 中 的 数据 进行 进一步 的 加工 和 处理 生成 各种 适用 于 专门 需求 的 数据 并 把 这些 数据 以 报表 或 帐单 的 形式 打印 出来 这些 数据 或 报表 可 根据 用户 的 不同 要求 灵活 指定 如 特定 网段 的 数据 汇总表 、 分项 数据 汇总表 、 IP地址 流量 明细表 、 各种 统计 分类 明细表 以及 计费 帐单 等 　 　 计费 信息 查询 模块 的 主要 功能 是 向 用户 提供 和 计费 相关 的 各种 数据 的 查询 由于 计费 系统 中 保存 着 连网 单位 用户 的 所有 计费数据 所以 计费 系统 应该 允许 对 帐单 有 疑问 的 连网 用户 查询 或 核实 本 单位 个人 或 IP地址 对外 通信 的 流量 情况 此外 计费 系统 还 保存 着 连网 单位 的 各种 信息 如 最新 、 最 精确 的 IP地址 分配情况 等 信息 这些 信息 可以 对 网络管理 人员 开放 同时 也 可以 对 具备 一定 条件 和 权限 的 其他 用户 开放 所有 这些 都 将 通过 计费 信息 查询 模块 来 实现 为了 最大 限度 地 实现 计费 信息 的 分布式 查询 计费 信息 查询 模块 采用 WEB 技术 加以 实现 使 用户 的 查询 可以 直接 通过 WEBBrowser 如 Netscape 等 进行 结束语 　 　 我们 已经 实现 了 一个 基于 上述 设计 的 实际 系统 并 投入 中国 教育 和 科研 计算机网 网络 中心 的 实际 管理 运行 经过 一段时间 的 试验 运行 证明 上述 设计 是 可行 的 系统 运行 的 可靠性 比 原先 单机 运行 的 时候 有 显著 的 提高 而且 保证 了 计费数据 的 完整性 和 一致性 基本 达到 了 预定 的 设计 目标 需要 指出 的 是 这样 一种 容错性 的 设计 并 不 局限于 计费 系统 任何 对 可靠性 有 较 高 要求 的 系统 都 可以 采用 　 　 这种 设计方案 的 一个 不足之处 是 对 设备 投资 的 要求 比较 高 对于 一些 中小型 的 网络 运行 管理 部门 来说 可以 在 经济性 和 可靠性 之间 作 一个 很 好 的 折衷 事实上 FTCharge 系统 的 很多 功能 是 可以 合并 到 一个 主机 上来 运行 的 如 数据 的 处理 和 数据 采集 管理 监控 子系统 和 备份 计费 系统 之间 等 都 可以 合并 当然 这 将 在 一定 程度 上 影响 可靠性 如何 在 降低成本 的 情况 下 仍 保持足够 的 可靠性 是 我们 下 一步 的 工作 目标 　 本文 研究 得到 国家 “ 矣 五 ” 科技 攻关项目 基金 资助 。 作者简介 　 杨家 海 ， 年生 ， 副教授 ， 主要 研究 领域 为 协议 一致性 测试 ， 网络 互连 技术 与 协议 ， 网络管理 　 　 　 　 　 吴建平 ， 年生 ， 教授 ， 博士生 导师 ， 主要 研究 领域 为 协议 一致性 测试 ， 网络 互连 技术 与 协议 ， 网络管理 本文 通讯联系 人 ： 杨家 海 ， 北京 ， 清华大学 CERNET 网络 中心 作者 单位 ： 清华大学 计算机科学 与 技术 系 北京 　 清华大学 信息网络 工程 研究 中心 　 北京 　 参考文献 　 　 AronoffRetalNetworkmanagementfunctionalrequirementsManagementofNetworksBasedonOpenSystemsInterconnectionOSIFunctionalRequirementsandAnalysisNISTSpecialPublicationNovhttp ∥ csrcnistgovnistpubssptxt 　 　 杨家 海等 Internet 网络管理 中国 计算机用户 ～ YangJiahaietalInternetnetworkmanagementChinaComputerUser ～ 　 　 ISOOSIBasicReferenceModelforOpenSystemInterconnectionISOct 　 　 ISOOSIManagementInformationServiceDefinitionPartCommonManagementInformationServiceISISOSwitzerlandMay 　 　 ISOOSIManagementInformationProtocolDefinitionPartCommonManagementInformationProtocolISISOSwitzerlandMay 　 　 JeffreyDCaseMarkFedoretalASimpleNetworkManagementProtocolSNMPRFCInternetNetworkWorkingGroupMay 　 　 JamesMGalvinKeithMcCloghrieAdministrativeModelforVersionoftheSimpleNetworkManagementProtocolSNMPvRFCInternetNetworkWorkingGroupApr 　 　 徐冈 汤俭 网络 计费 管理 见 ： 张德运编 CERNET 的 研究 与 发展 西安 西安交通大学 出版社 XuGangTangJianNetworkaccountingmanagementInZhangDeyunedTheResearchandDevelopmentofCERNETXianXianJiaotongUniversityPress 　 　 CiscoSystemsIncCiscoEnterpriseAccountingforNetflowVersionCiscoEnterpriseAccountingforISDNVersion ［ online ］ URLhttp ∥ wwwciscocom 本文 收到 原稿 ， 收到 修改稿