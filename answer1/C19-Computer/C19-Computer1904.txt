微型机 与 应用 WEIXINGJIYUYINGYONG 　 Vol 　 No 　 PCISCO “ 标记 交换 ” 机制 的 探讨 和 研究 胡泳 张志浩 陈福民 摘要 ： 对 CISCO 公司 提出 的 一种 新颖 的 网络层 数据包 传送 技术 标记 交换 作 了 比较 深入 的 探讨 。 关键词 ： 交换 路由 标记 标记 交换 　 　 Internet 规模 的 持续 扩大 与 多媒体 应用 的 增加 ， 要求 Internet 服务提供商 有 更 高 的 带宽 。 高带宽 也 意味着 路由器 对 单点 和 多点 传送 的 高 传输 性能 （ 每秒 包数 ） 。 　 　 Internet 的 普及 也 需要 Internet 路由 系统 增强 缩放 性 。 从 单个 路由器 获得 路由 信息 ， 创建 个 路由 知识 组织 的 能力 对 支持 高质量 、 可 缩放 路由 系统 是 非常 必要 的 。 　 　 在 增加 路由 功能 以 支持 多点 发送 、 路由 路径 的 控制 以及 提供 创建 路由 信息 能力 的 同时 ， 增强 传输 性能 是 非常 重要 的 。 不仅如此 ， 创建 一个 可以 满足 新 需求 的 路由 系统 也 是 很 关键 的 。 　 　 标记 交换 是 解决 这些 问题 的 高效 技术 。 标记 交换 把 网络层 路由 提供 的 灵活 、 丰富 的 功能 和 由 标记 交换 传送 规范 带来 的 简单 性 结合 在 一起 。 标记 交换 的 简单 机制 在 支持 高性能 价格比 的 同时 也 增强 了 传输 性能 。 通过 把 大 范围 的 传输 间隙 与 一个 标记 结合 起来 ， 同一个 传送 规范 可以 支持 很多 路由 功能 ， 如 基于 目标 的 路由 、 多点 发送 、 路由 知识 组织 和 灵活 的 路由 控制 。 最后 ， 简单 传送 、 大 范围 的 传送 间隙 和 维持 同一个 传送 范围 的 同时 ， 参与 路由 功能 三者 的 结合 可以 使 路由 系统 适应 新 的 需求 。 标记 交换 的 组成 　 　 标记 交换 由 传送 和 控制 二 部分 组成 。 传送 部分 使用 数据包 携带 的 标记 信息 和 标记 交换机 支持 的 标记 传输 信息 进行 数据包 传输 。 控制 部分 负责 在 组 互连 的 标记 交换机 中 维持 正确 的 标记 传输 信息 。 标记 交换 机制 可以 保持 IP 的 缩放 性质 、 增强 IP 网络 的 弹性 。 ． 传送 部分 　 　 标记 交换 使用 的 基本 的 传送 规范 是 基于 标签 交换 概念 的 。 当 个 标记 交换机 接收 到 个 携带 标记 的 数据包 时 ， 它 把 这个 标记 作为 自己 的 标记 信息 表 （ TIB ） 中 的 个 索引 。 TIB 中 的 每个 条目 由个 进入 标记 和 个 或者 多个 子 条目 （ 输出 标记 、 输出 接口 、 输出 链路层 信息 ） 组成 。 如果 标记 交换机 发现 个条 目的 进入 标记 与 收到 的 数据 报所 携带 的 标记 相匹配 ， 那么 交换机 用 输出 标记 代替 数据包 中 的 标记 ， 用 输出 链路层 信息 代替 数据 报中 的 链路层 信息 （ 如 MAC 地址 ） ， 然后 把 该 数据包 向 输出 接口 发送 。 　 　 从 上面 的 描述 中 可以 发现 ： （ ） 传送 策略 取决于 一个 确定 的 匹配 算法 ， 该 算法 使用 个定 长 、 相当 短 的 标记 作为 索引 ， 这样 就 简化 了 传送 过程 并且 增强 了 传输 性能 ， 而且 可以 直接 由 硬件 实现 。 （ ） 传送 策略 不 依靠 标记 的 传送 间隙 。 例如 ， 同个 传送 算法 既 适用 于 单点 发送 ， 又 适用 于 多点 发送 ， 个 单点 发送 的 条目 只 包含 个子 条目 ， 而个 多点 发送 的 条目 包含 个 或 多个 子 条目 （ 对于 多点 访问 链路 ， 输出 链路层 信息 包括 多点 发送 MAC 地址 ） 。 这 说明 了 相同 的 传送 算法 怎样 利用 标记 交换 支持 不同 的 路由 算法 。 　 　 这种 简单 的 传送 过程 本质 上 与 标记 交换 中 的 控制 部分 是 分开 的 。 可以 在 不 干预 传送 算法 的 情况 下 使用 新 的 路由 （ 控制 ） 功能 。 这 意味着 在 增加 新路 由 功能 的 同时 ， 没 必要 重新 优化 传送 性能 （ 通过 修改 软硬件 ） 。 数据包 携带 标记 信息 有 多种 方法 ： 　 　 （ ） 作为 个 小 的 标记 头 插入 到 第层 与 网络层 头部 信息 之间 ； 　 　 （ ） 如果 第层 头部 信息 提供 充分 的 语义 （ 例如 ATM ） 作为 第层 头部 信息 的 一部分 ； 　 　 （ ） 作为 网络层 头部 信息 的 一部分 （ 例如 使用 IPV 中 的 FLOWLABEL 域 ） 。 　 　 因此 ， 可以 在 任何 媒质 上 虚拟 地 实现 标记 交换 ， 包括 点到点 链路 、 多点 访问 链路 和 ATM 。 　 　 另外 ， 标记 传送 部分 与 网络层 是 无关 的 。 利用 与 特定 网络层 协议 相关 的 控制 部分 ， 可以 在 不同 的 网络层 协议 上 使用 标记 交换 。 ． 控制 部分 　 　 标记 交换 的 关键 是 标记 与 网络层 路由 的 绑定 。 为了 提供 良好 的 缩放 特性 ， 适应 不同 的 路由 功能 ， 标记 交换 支持 许多 传送 间隙 。 一方面 ， 个 标记 可以 绑定 到 组 路由 上 （ 取决于 路由 上 网络层 能 达到 的 信息 ） ； 另一方面 ， 它 可以 绑定 到 个 独立 的 应用 流 （ 例如 ， RSVP 流 ） ； 标记 也 可以 绑定 到 个 多点 播送 生成 树上 。 　 　 控制 部分 的 责任 是 创建 标记 绑定 ， 然后 把 标记 绑定 信息 在 标记 交换机 中 发布 。 控制 部分 以 多种 模型 的 集合 形式 存在 ， 每种 模型 支持 种 特定 的 路由 功能 。 若 增加 新 的 路由 功能 ， 只 需要 增添 新 的 模型 即可 。 下面 是 一些 模型 的 介绍 。 ． ． 基于 目的 的 路由 　 　 在 基于 目的 的 路由 中 ， 路由器 通过 数据 报 携带 的 目的 地址 和 传送 信息 表 （ FIB ） 中 的 信息 来 确定 传送 路径 。 路由器 通过 它 从 路由 协议 （ 如 OSPF ， BGP ） 中 得到 的 信息 来 构造 它 的 FIB 。 　 　 为了 支持 标记 交换 基于 目的 的 路由 ， 个 标记 交换机 像 路由器 一样 ， 参与 路由 协议 ， 并且 用 从 这些 协议 中 得到 的 信息 构造 它 的 FIB 。 　 　 有 三种 方式 进行 标记 配置 和 TIB 的 管理 ： （ ） 下游 标记 指派 ； （ ） 根据 需求 的 下游 标记 指派 ； （ ） 上游 标记 指派 。 所有 方式 中 ， 个 交换机 指派 个 标记 并且 把 它 与 FIB 中 的 地址 前缀 结合 。 在 下游 指派 中 ， 数据包 中 的 标记 生成 后 由 链路 下游 的 交换机 （ 以 数据流 方向 为 参考 ） 与 前缀 绑定 。 而 下游 指派 则 由 上游 的 交换机 完成 。 按 需求 指派 则 意味着 只有 当 上游 的 交换机 需要 时 下游 的 交换机 才 指派 个 标记 。 方式 （ ） 和 （ ） 在 ATM 网络 中 很 有用 。 在 下游 标记 指派 中 ， 交换机 负责 创建 与 输入 数据包 的 标记 结合 ， 同时 接收 从 其 邻居 来 的 输出 数据包 的 标记 绑定 。 在 上游 标记 指派 中 ， 交换机 负责 创建 与 输出 数据包 的 标记 结合 ， 同时 接收 从 其 邻居 来 的 输入 数据包 的 标记 绑定 。 　 　 下游 标记 指派 的 工作 如下 ： 对于 FIB 中 的 每个 路由 ， 交换机 指派 个 标记 ， 并且 在 它 的 TIB 中 创建 个 条目 ， 把 进入 标记 设置 为 指派 的 标记 ， 然后 把 这 对 路由 与 标记 的 绑定 信息 通知 给 相邻 的 标记 交换机 。 这种 通知 可以 通过 把 绑定 放在 已有 的 网络层 协议 之上 ， 或者 通过 独立 的 标记 发布 协议 （ TDP ） 来 完成 。 当 个 标记 交换机 接收 到 个 路由 的 标记 绑定 信息 ， 并且 该 信息 来自 这 条 路由 的 下 一 驿站 时 ， 交换机 就 把 绑定 信息 中 携带 的 标记 放到 与 这条 路由 相关联 的 TIB 条目 中 的 输出 标记 部分 。 这样 就 在 输出 标记 与 路由 之间 建立 了 绑定 。 　 　 根据 需求 的 下游 标记 指派 的 工作 过程 如下 ： 对于 FIB 中 的 每个 路由 ， 交换机 识别 它 的 下 一个 驿站 。 因此 ， 交换机 能够 向 该 路由 的 下 一个 驿站 发送 标记 绑定 请求 。 当下 一个 驿站 收到 请求 时 ， 它 就 指派 个 标记 ， 在 它 的 TIB 中 创建 个 条目 ， 并 把 进入 标记 设置 为 指派 的 标记 。 然后 把 路由 与 标记 的 绑定 信息 返回 给 发送 请求 的 交换机 。 当源 交换机 收到 绑定 信息 时 ， 便 创建 个 TIB 条目 ， 并 把 输出 标记 设置 为 绑定 信息 中 的 相应 的 部分 。 　 　 上游 标记 指派 的 工作 过程 如下 ： 如果 个 标记 交换机 有个 或 多个 点到点 的 接口 ， 那么 对于 FIB 中 的 每条 路由 （ 经过 这些 接口 可以 到达 它 的 下 一 驿站 ） ， 交换机 就 指派 个 标记 ， 在 它 的 TIB 中 创建 个 条目 ， 并 把 输出 标记 设置 为 指派 的 标记 。 然后 把 路由 与 标记 的 绑定 信息 通过 TDP 通知 给 下 一 驿站 。 当下 一 驿站 收到 绑定 信息 后 ， 便 把 与 这条 路由 相关 的 TIB 中 的 进入 路由 设置 为 绑定 信息 中 的 标记 。 　 　 一旦 设置 好 TIB 条目 中 的 输入 与 输出 标记 ， 标记 交换机 就 可以 使用 标记 交换 传送 算法 在 与 标记 绑定 的 路由 中 传送 数据包 了 。 　 　 当 标记 交换机 绑定 个 输出 标记 和 个 路由 时 ， 它 同时 也 利用 绑定 信息 更新 它 的 FIB ， 这样 交换机 就 可以 在 先前 没有 携带 标记 的 数据包 中 加入 标记 。 　 　 从 上面 的 分析 可以 看出 ， 基于 目的 路由 的 标记 交换机 支持 的 标记 总数 不能 比 FIB 中 的 路由 个数 多 ， 而且 个 标记 有时 与 多个 路由 链接 。 　 　 一般来说 ， 标记 交换机 利用 它 所能 达到 的 路由 的 输入 、 输出 标记 维护 它 的 TIB ， 因此 ， 所有 的 数据包 可以 利用 简单 的 标签 交换 传送 。 另外 ， 标记 的 分配 是 通过 路由 ， 而 不是 通过 数据流 ， 即 FIB 条 目的 存在 导致 标记 的 指派 ， 而 不是 数据包 的 到达 。 　 　 使用 与 路由 而 不是 与 数据流 相关 的 标记 ， 也 意味着 没有 必要 为 每个 数据流 执行 级别 检验 程序 而 决定 是否 为 这个 数据流 指派 个 标记 。 　 　 另外 ， 标记 交换机 用于 支持 基于 目的 的 路由 时 ， 也 不能 完全 排除 执行 普通 网络层 传送 的 需要 。 首先 ， 为了 给 个 事先 没有 标记 的 数据包 指派 标记 时 ， 需要 普通 网络层 传送 。 这个 功能 可以 由 第个 驿站 路由器 实现 ， 也 可以 由 能够 参与 标记 交换 的 路径 上 的 第个 路由器 实现 。 另外 ， 当 标记 交换机 把 组 路由 与 个 标记 相连 ， 而且 这些 路由 不 共享 个 公共 的 下 一 驿站 时 ， 交换机 将 为 携带 这一 标记 的 数据包 执行 网络层 传送 。 然而 ， 以上 这种 组 路由 与 个 标记 结合 的 情况 远比 利用 普通 网络层 传送 时 做 路由 决定 的 几率 小 ， 而且 ， 这种 结合 也 只 使用 与 交换机 支持 的 路由 的 个 子集 。 所以 ， 数据包 的 传输 大部分 时间 还是 利用 标记 交换 算法 。 ． ． 路由 知识 的 组织 　 　 IP 路由 体制 是 网络 以 路由 域 的 模式 存在 。 在 个域 中 ， 路由 通过 内部 路由 算法 （ 例如 OSPF ） 发现 路由 ， 而在域 之间 则 通过 外部 路由 算法 （ 如 BGP ） 发现 路由 。 然而 ， 域 中 所有 的 路由器 必须 维持 内部 路由 和 外部 路由 提供 的 信息 ， 因此 ， 带来 了 一些 问题 。 首先 ， 信息 的 数量 不是 重要 的 ， 它 把 额外 的 需要 放到 路由器 需要 的 资源 上 ； 其次 ， 路由 信息 的 增加 往往 增加 路由 收敛 时间 ， 也 就 降低 了 系统 的 性能 。 　 　 标记 交换机 允许 内部 和 外部 路由 的 分离 ， 这 就 使 处于 个域 边缘 上 的 交换机 仅仅 需要 维持 外部 路由器 提供 的 路由 信息 。 而 其它 处于 域 内部 的 交换机 仅仅 需要 维持 内部 路由器 提供 的 路由 信息 （ 这种 信息 比 外部 路由 信息 要少 得 多 ） 。 这样 就 减少 了 路由 在 非 边缘 交换机 上 的 加载 ， 从而 缩短 了 路由 收敛 时间 。 　 　 为了 支持 这种 功能 ， 个 标记 交换机 允许 数据包 携带 个 以上 的 标记 ， 而且 这些 标记 组织 成栈 的 形式 。 标记 交换机 可以 交换 栈顶 的 标记 ， 也 可以 弹栈 、 入栈 。 　 　 当 个 数据包 在 个 处于 不同 的 域 中 的 交换机 之间 传送 时 ， 其中 的 标记 栈 只 包含 个 标记 ， 而 在 同个域 中 传送 的 数据包 的 栈 则 包含 个 标记 （ 第个 标记 是 由域 的 扇入 交换机 压入 的 ） 。 标记 栈中 的 栈顶 标记 负责 数据包 向 合适 的 扇 出 边缘 交换机 传送 ， 第个 标记 负责 数据包 在 扇 出 交换机 中 的 正确 传送 。 　 　 在 这种 方式 下 使用 的 控制 成份 和 上面 提到 的 基于 目的 的 路由 使用 的 控制 成份 大体上 是 相似 的 。 二者之间 的 主要 差别 是 ： 在 这种 方式 下 ， 标记 绑定 信息 不仅 在 物理 上 相邻 的 交换机 中 发布 ， 而且 也 在 处于 同个域 中 的 边缘 交换机 中 发布 。 ． ． 多点 播送 　 　 多点 播送 的 关键 是 生成 树 概念 。 多点 播送 的 路由 程序 负责 建立 生成 树 ， 多点 播送 传送 负责 在 生成 树中 传送 数据包 。 　 　 为了 支持 标记 交换 中 的 多点 传送 功能 ， 每个 标记 交换机 必须 按 如下 方式 结合 个 标记 与 个 多点 播送 树 ： 当 个 标记 交换机 创建 个 多点 播送 条目 和 它 的 输出 接口 的 同时 ， 该 交换机 也 创建 本地 标记 集合 （ 与 每个 输出 接口 一一对应 ） 。 交换机 在 它 的 TIB 中 创建 个 条目 并且 为 每个 输出 接口 绑定 这些 信息 ， 同时 把 个 本地 生成 的 标记 放到 输出 标记 域 中 。 这样 就 在 多点 播送 树 和 标记 集合 之间 建立 了 绑定 。 交换机 然后 就 通过 和 条 目的 相连 的 输出 接口 广播 这些 绑定 信息 。 　 　 当 个 交换机 接收 到 来自 位于 其 上游 （ 以 多点 播送 树为 参考 ） 的 另个 交换机 的 树 和 标记 的 绑定 信息 时 ， 它 就 把 它 和 这棵树 相关 的 TIB 条目 中 的 输入 标记 设置 为 绑定 信息 中 的 标记 。 　 　 当组 标记 交换机 通过 个 多点 访问 子网 相连 时 ， 多点 播送 的 标记 分配 必须 和 交换机 协同 起来 。 其它 情况 与 基于 目的 路由 的 标记 分配 一样 。 ． ． 灵活 的 路由 　 　 基于 目的 的 路由 其 基本 特点 是 ： 个 数据包 中 用于 传送 的 信息 是 目的 地址 ， 虽然 这个 特点 保证 了 高性能 路由 ， 但是 同时 也 限制 了 利用 数据包 携带 的 路径 进行 路由 的 能力 （ 源 路由 ） ， 不利于 对 低 负荷 路径 的 利用 。 对于 支持 不同 类别 服务 的 ISP 而言 ， 基于 目的 的 路由 也 限制 了 它们 结合 不同 类别 服务 与 不同 链路 的 能力 。 现在 一些 ISP 利用 FRAMERELAY 和 ATM 克服 这种 限制 ， 然而 ， 标记 交换 由于 使用 了 灵活 的 标记 间隙 ， 不 需要 使用 FRAMERELAY 和 ATM 就 可以 克服 这些 限制 。 　 　 为了 达到 在 不同 与 基于 目的 路由 决定 的 路径 上 传输 的 目的 ， 标记 交换 中 的 控制 部分 在 标记 交换 机上安装 了 与 基于 目的 路由 的 路径 无关 的 标记 绑定 。 ATM 中 的 标记 交换 　 　 既然 标记 交换 传送 机制 是 基于 标签 交换 的 ， 而 ATM 也 是 基于 标签 交换 的 ， 所以 通过 标记 交换 中 的 控制 部分 ， 可以 把 标记 交换 用到 ATM 交换机 中 去 。 　 　 标记 交换所 需要 的 标记 信息 可以 放到 VCI 域 中 。 如果 需要 个 层次 的 标记 ， 可以 利用 VPI 。 虽然 使用 VPI 限制 了 网络 规模 ， 但是 一般 情况 个 层次 的 标记 足够 了 。 　 　 为了 获得 必要 的 控制 信息 ， 交换机 必须 能够 作为 一个 对 等 者 参与 到 网络层 的 路由 协议 （ 如 OSPF ， BGP ） 中 。 而且 ， 如果 交换机 需要 执行 路由 信息 解析 和 支持 基于 目的 的 路由 ， 它 应该 能 执行 网络层 的 数据 传送 。 　 　 为了 支持 基于 目的 路由 的 标记 交换 ， 个 ATM 交换机 可能 需要 多个 或个 路由 相关 的 标记 （ 或者 是 具有 同一个 下 一 驿站 的 组 路由 ） 。 这 对于 避免 来自 于 不同 的 标记 交换机 ， 却 被 发送到 相同 的 下 一 驿站 的 数据包 之间 的 冲突 是 必要 的 。 根据 需求 的 下游 标记 指派 和 上游 指派 应该 被 用于 标记 分配 和 ATM 交换机 的 TIB 维持 进程 。 　 　 因此 ， ATM 交换机 能 支持 标记 交换 ， 但是 它 至少 能够 实现 网络层 协议 和 标记 交换 中 的 控制 部分 。 同时 ， 它 也 需要 支持 一些 网络层 传送 。 　 　 在 ATM 交换机 上 实现 标记 交换 将 简化 ATM 交换机 和 路由器 间 的 连接 具有 标记 交换 的 ATM 交换机 将 以 一个 路由器 的 形式 出现 。 由于 机遇 目的 传送 机制 是 协议 驱动 的 而 并非 数据 驱动 ， 所以 这样 便 省去 了 ATM 地址 、 路由 和 信号 机制 。 标记 交换 中 的 服务质量 及 实施 战略 ． 服务质量 　 　 为了 获得 通过 路由器 和 标记 交换机 传送 数据包 的 服务质量 需要 二种 机制 ： 第一 ， 需要 把 数据包 划分 为 不同 的 类别 ； 第二 ， 服务质量 的 参数 （ 如 带宽 ） 要 提供 给 每 一 类别 。 　 　 标记 交换 提供 了 一个 简单 的 途径 使个 数据包 属于 特定 的 类别 。 类别 的 初始化 将 利用 网络层 或者 更 高层 的 头部 信息 实现 。 与 该 类别 相关 的 标记 将 用于 这个 数据包 中 。 这样 ， 被 标记 的 数据包 可以 被 标记 交换 路由器 灵活 地 控制 ， 而 不 需要 重新 分类 。 　 　 标记 交换 支持 的 服务质量 依靠 于 QoS 的 定义 。 如果 使用 RSVP 以 获得 一类 数据包 的 QoS ， 那么 必须 为 每个 RSVP 会话 分配 个 标记 。 这 可以 通过 TDP 或 RSVP 扩展 来 实现 。 ． 实施 战略 　 　 既然 标记 交换 在 个 相邻 的 标记 交换机 之间 进行 ， 而且 标记 的 绑定 信息 可以 在 双绞线 上 发布 ， 标记 交换 就 可以 用 相当 简单 的 语言 描述 。 例如 ， 一旦 一对 相邻 的 路由器 转变成 标记 交换机 ， 每 一个 交换机 将 对 要 传送 到 另外 一个 的 数据包 加 标记 ， 这样 就 使 另 一个 交换机 使用 标记 交换 。 既然 标记 交换机 使用 和 路由器 相同 的 路由 协议 ， 标记 交换机 的 引入 对 路由器 并 没有 影响 。 事实上 ， 个 连接 到 路由器 上 的 标记 交换机 就 像 个 路由器 一样 。 　 　 随着 越来越 多 的 路由器 升级 为 能够 支持 标记 交换 ， 标记 交换机 提供 的 功能 也 越来越 多 。 例如 ， 一旦 个域 中 的 路由器 都 支持 标记 交换 ， 使用 路由 知识 的 组织 功能 就 成为 可能 。 　 　 本文 对 标记 交换 技术 进行 了 探讨 。 标记 交换 并 不 限制 在 某 一个 特殊 的 网络层 协议 上 ， 它 是 一个多 协议 解决方案 。 标记 交换 中 的 传送 部分 非常简单 ， 方便 了 高性能 传送 ， 并且 可以 在 高性能 传送 硬件 （ 如 ATM ） 上 实现 。 控制 部分 相当 灵活 ， 可以 支持 许多 路由 功能 。 由于 许多 路由 间隙 与 标记 结合 ， 因而 能 提供 缩放 性能 强 的 、 丰富 的 路由 。 传送 间隙 与 不 依靠 传送 部分 的 控制 的 结合 ， 导致 了 可以 使用 新 的 路由 功能 去 满足 日益 发展 的 网络 需求 。 胡泳 （ 上海 同济大学 计算中心 ） 张志浩 （ 上海 同济大学 计算中心 ） 陈福民 （ 上海 同济大学 计算中心 ） 参考文献 ［ ］ RekhterY ， DavieB ， KatzD ， RosenE ， SwallowG ． RFCCiscoSystems ′ TagSwitchingArchitectureOverview ． ； 收稿 日期 ： － －