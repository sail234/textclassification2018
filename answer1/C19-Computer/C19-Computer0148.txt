微型 电脑 应用 MICROCOMPUTERAPPLICATIONS 　 Vol 　 No 　 P 地理信息系统 MapInfo 中 时间 函数 引起 的 年 问题 及其 解决 方法 张静怡 　 邓正栋 　 徐小明 　 丁健 　 李炎 新 摘 　 要 ： 本文 列举 了 地理信息系统 MapInfo 中 时间 函数 引起 的 年 问题 ， 并 阐述 了 解决 该 问题 的 一个 方法 ， 对 MapInfo 用户 认识 和 解决 应用 中 的 年 问题 有 借鉴 意义 。 关键词 ： MapInfo 　 MapBaisc 　 VisualBasicAbstract ： ThispaperpresentstheYKprobleminGISMapInfosystemsduetoembeddedtimerfunctionsinthemItproposesamethodtosolvethisproblemwhichprovesveryusefulinapplicationofMapInfosystemsKeywords ： MapInfo 　 MapBaisc 　 VisualBasic ▲ 一 、 引言 　 　 地理信息系统 MapInfo 是 世界 公认 的 标准 桌面 地理信息系统 ， 该 系统 在 我国 的 推广 和 应用 已有 几个 年头 了 ， 其 应用 范围 涉及 邮电通讯 、 交通运输 、 水利电力 、 国土 市政 、 公安 军事 、 石油 石化 等 行业 ， 许多 重点 机构 、 大型 工程 、 重点项目 已经 或 正在 采用 该 系统 进行 数据 的 可视化 分析 、 智能 辅助 决策 等 工作 。 　 　 在 应用 中 几乎 所有 的 高级 用户 都 依赖于 MapInfo 强有力 的 二次开发 语言 MapBasic 。 通过 使用 MapBasic 进行 二次开发 ， 能够 扩展 MapInfo 功能 ， 实现 程序 的 自动 重复 操作 并 使 MapInfo 与 其它 应用软件 集成 。 　 　 在 全球 面临 计算机 年 问题 的 今天 ， MapInfo 用户 是否 能 高枕无忧 呢 答案 是 “ 不能 ” 。 我们 在 开发 中 发现 ， MapBasic 的 时间 函数 也 存在 年 问题 。 这样 对于 一些 使用 到 存在 年 问题 时间 函数 的 系统 就 会 造成 隐患 。 另外 值得 指出 的 是 ， MapInfo 公司 在 其 新近 推出 的 MapBasic 中 尚未 提到 时间 函数 的 年 问题 。 二 、 MapInfo 的 时间 函数 简介 　 　 与 时间 有关 的 函数 有 CurDate 、 Day 、 Month 、 Weekday 、 Year 、 Timer 、 StringToDate 、 NumberToDate 个 。 　 　 其中 Day 、 Month 、 Weekday 、 Year 、 StringToDate 、 NumberToDate 个 函数 是 带 用户 定义 参数 函数 ， 本身 不会 产生 问题 。 　 　 CurDate 函数 返回 系统 当前 日期 。 　 　 Timer 函数 返回 一个 整型 数 ， 代表 自 年月日 午夜 至 调用 Timer 函数 时所 经历 的 秒数 ， 通过 在 一个 特殊 操作 中 调用 该 函数 我们 可以 检测 操作 所 经历 的 时间 ， Timer 也 经常 被 用于 循环 设置 。 三 、 MapInfo 的 时间 函数 存在 的 问题 　 　 CurDate 函数 返回 的 最远 有效 日期 是 年 月 号 ， 在 系统 日期 超过 年 月 号 后 ， CurDate 函数 返回 的 日期 数均 为 年 月 号 。 　 　 Timer 函数 　 　 由 Timer 的 功能 和 返回值 ， 我们 很 容易 看出 它 的 不足 。 首先 是 返回 整型 数 的 性质 ， 如果 计数 超过 整型 数个 字节 的 定义 范围 ， ， ， ， ， ， ， 那么 函数 执行 错误 ， 返回 。 这种 情况 理论 上 发生 在 年月日 以后 如同 位 的 Unix 系统 到 年 因 时间 计数器 溢出 而 自动 停止 工作 一样 ， 属 年 问题 。 年 问题 并 不 只是 一个 世纪 过渡 问题 ， 它 不但 有 可能 在 年月日 零时 发作 ， 也 有 可能 在 年 、 年 、 年 以后 的 一些 特殊 日子 发作 ， 但 在 实际 中 也 给 我们 带来 过 麻烦 ， 我们 的 一台 笔记本电脑 时间 被误 设为 年 ， 在 运行 基于 MapInfo 的 专题 地理信息系统 执行 到 由 Timer 函数 控制 的 循环 时 系统 进入 死循环 ， 费 了 好多 劲 才 查出 是 Timer 函数 的 问题 。 其次 ， Timer 返回 的 数值 不 “ 耐看 ” ， 比如 现在 是 北京 时间 年月日时 分 ， 此时 Timer 返回 “ ” 这样 一个 数值 ， 显然 该 数值 没有 实际意义 ， 这样 我们 就 涉及 到 一个 在 MapInfo 中 如何 显示 实际 时间 的 问题 。 四 、 解决 方法 　 　 一个 方法 是 通过 换算 ， 那 将 是 一大堆 程序 。 　 　 我们 采取 的 方法 是 用 MapBasic 联合 VisualBasic 编程 ， 因为 在 VB 中 时间 极易 提取 ， 而且 现在 VB 、 的 函数 已 注意 了 YK 问题 。 具体步骤 如下 ： 　 　 通过 VB 建立 一个 内有 时间 小节 和 当前 时间 的 INI 文件 ： 　 　 在 VB 中 建立 一个 VISIBLE 属性 为 FALSE 的 窗体 ， 窗体 FormLoad 事件 内 写入 下面 程序 ： PrivateDeclareFunctionWritePrivateProfileStringLibkerneAliasWritePrivateProfileStringAByVallpApplicationNameAsStringByVallpKeyNameAsAnyByVallpStringAsAnyByVallpFileNameAsStringAsLongPrivateSubFormLoad 　 　 DimXAsLongbuffAsStringiAsInteger 　 　 XWritePrivateProfileString 时间 程序 时间 StrTimeAppPath ＼ timerini 　 　 XWritePrivateProfileString 时间 程序 日期 StrDateAppPath ＼ timerini 　 　 EndEndSub 　 　 则 程序运行 后 ， 在 应用程序 目录 建立 一个 timerini 文件 ， 内容 为 ： 　 　 　 ［ 时间 程序 ］ 　 　 　 时间 　 　 　 日期 运行 后 程序 撤出 内存 。 将 此 工程 编译 为 可执行文件 timerexe ， 放置于下 面 的 MapBasic 文件 同一 目录 。 图 　 　 在 MapBasic 环境 下 编程 ： DeclareFunctionGetPrivateProfileStringLibkerneAliasGetPrivateProfileStringAByVallpApplicationNameAsStringByVallpKeyNameAsstringByVallpDefaultAsStringlpReturnedStringAsStringByValnSizeAssmallintByVallpFileNameAsStringAsintegerdeclaresubmainsubmain 　 　 DimtimebuffdatebuffAsString 　 　 dimiAsInteger 　 　 runprogramapplicationdirectorytimerexe 　 　 iGetPrivateProfileString 时间 程序 时间 timebuff ， ， applicationdirectorytimerini 　 　 iGetPrivateProfileString 时间 程序 日期 ， datebuffapplicationdirectorytimeriniENDSUB 　 　 则 在 上述 MapBasic 程序运行 后 timebuff 字符串 内 包含 有 当前 时间 ， 可 实时 显示 。 下图 为 运行 示意 。 　 　 亦 可以 在 MapBasic 中 直接 调用 WindowsAPI 函数 如 GetSystemTime 等 ， 但 比较而言 的 方法 简便 ， 因为 GetSystemTime 等 函数 也 不能 返回 直观 的 当前 时间 ， 而且 在 MapBasic 中 声明 一些 Windows 函数 数据结构 相当 麻烦 ， 需要 多次 调试 ， 诸如 内存地址 、 指针 等 变量 MapBasic 无法 定义 。 五 、 小结 　 　 本文 叙述 的 MapBasic 联合 VisualBasic 编程 的 方法 具有 可 借鉴 性 ， 不仅 可以 用来 解决 MapBasic 的 一些 缺陷 ， 还 可用 在 其他 开发 环境 中 。 ■ 作者 单位 ： 张静怡 河海大学 数理系 南京 参考文献 ： ［ ］ MapInfo 公司 ， MapBasicUserGuideTroyNewYork ［ ］ MapInfo 公司 ， MapBasicReferenceTroyNewYork ［ ］ MapInfoChinaMapInfo 应用 集锦 ， 中国 　 北京 　 ［ ］ 邓正栋 等 ， 应用 地理信息系统 MapInfo 管理 野戏 给水 条件 信息 的 实践 　 微型 电脑 应用 　 年 第期 ［ ］ 邓正栋 等 ， 数学 化 野战 给水 条件 图 制作 研究 　 微型 电脑 应用 　 年 第期 收稿 日期 ：