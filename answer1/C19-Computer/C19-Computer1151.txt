自动化 学报 ACTAAUTOMATICASINICA 年 第卷 第期 VolNo 线状 图形 矢量化 中 的 行段 分析 与 后处理 邹荣金 　 蔡士杰 　 张福炎 摘 　 要 　 针对 目前 工程图纸 识别 中 存在 的 几项 难点 技术 ， 提出 基于 行程 编码 的 矢量化 方法 ， 对 小 弯度 直线 的 纠正 问题 、 特征 线段 的 延伸 与 合并 算法 进行 了 研究 同时 使用 图像 局部 形态 分析 的 方法 ， 直接 在 原 图像 上 进行 识别 ， 保证 了 图像 信息 的 完整性 和 可 检测 性 该项 研究 结果 在 建筑 工程图纸 的 自动识别 及 自动 计算 中 得到 了 较 好 的 应用 关键词 　 图像 扫描 ， 行段 ， 工程图 矢量化 ， 识别 GRAPHSEGMENTANALYSISANDPOSTPROCESSINGOFLINEGRAPHICSINENGINEERINGDRAWINGSVECTORIZATIONZOURongjin 　 CAIShijie 　 ZHANGFuyanStateKeyLaboratoryofSoftwareNovelTechnologyMultimediaResearchInstituteNanjingUniversityNanjing 　 Abstract 　 ThispaperproposedavectorizationmethodbasedontherunlengthcodingforrecognitionofengineeringdrawingsWestudiedtheaspectsofthesmallbendlinecorrectionproblemaswellasthecombiningandextendingalgorithmofthevectorizationlinesegmentsAtthesametimeimagemorphologyanalysismethodwasalsousedintheresearchwhichensuredtheinformationintegrityandgraphictestabilitywhendirectlyusingtheoriginalscanningimageoftheengineeringdrawingsTheachievementshavebeenusedforautomaticalrecognitionandcalculationofarchitectureengineeringdrawingsKeywords 　 Imagescanninggraphsegmentengineeringdrawingsvectorizationrecognition 　 引言 　 　 长期以来 ， 人们 一直 在 努力 解决 图纸 自动 输入 的 问题 随着 近年来 扫描仪 的 迅速 发展 和 计算机 性能 的 大幅度提高 ， 工程图纸 的 矢量化 已 成为 学术界 与 业界 关注 的 一个 热点 ， 这方面 的 研究 对 多媒体技术 中 的 各种 图 、 表等 信息 的 自动 输入 和 应用 是 一个 极大 的 推动 　 　 计算机 能否 读懂 一张 图纸 ， 其中 有 许多 关键技术 问题 需要 解决 ： 图纸 的 矢量化 ， 字符 标识 的 识别 ， 图形 的 理解 近年来 的 研究 ［ ～ ］ 往往 是 使用 细化 的 算法 抽取 骨骼 线 ， 然后 设法 连成线 这种 方法 的 缺点 是 图形 失真 、 检出 线段 短 和 丢失 线宽 信息 　 　 本文 采用 的 基于 行程 编码 的 矢量化 算法 与 识别方法 较 好 地 利用 了 图像 信息 的 完整性 ， 可以 通过 形态 分析 获取 工程图纸 上 的 字 、 线 、 符号 等 多种 信息 　 基于 行程 编码 的 矢量化 方法 　 　 工程图纸 扫描 进入计算机 后 ， 一般 量 矢量化 为二值化 图像 ， 与 灰度 相比 占 的 存储空间 较 小 ， 即使 这样 ， 一幅 A 的 工程图纸 按 dpi 扫描 成二值 图像 其 空间 也 要 占 MB 左右 从 工程图纸 的 表现形式 看 ， 在 整个 幅面 上由线 黑色 像素 占 的 像素 很少 ， 空白处 较 多 ， 因此 使用 行程 编码 来 表示 黑色 像素 部分 的 线或 字 是 极为 有效 的 一种 方法 　 　 行程 编码 是 记录 每 一行 上 黑色 连续 像素 的 位置 ， 称之为 一个 行段 Segment 如果 行程 终止 点 位置 由 扫描 行 的 始点 算起 并 由 到达 行程 终点 的 像素 计数 确定 ， 便 称为 行程 终点 编码 如果 行程 终点 位置 由前 一 终点 的 相对 距离 确定 ， 则 称为 行程 长度 编码 　 　 目前 大多数 矢量化 方法 是 采用 细化 的 算法 ， 细化 虽然 一定 程度 上 可 获取 骨骼 线 ， 但会 导致 大量 信息 的 丢失 ， 尤其 对于 图纸 上 各种 不同 对象 形态 的 整体 理解 较为 困难 使用 行程 编码 能 有效 地 表达 图像 形态 特征 及其 相互 关系 　 　 为 进行 有效 地 对 行段 进行 跟踪 ， 首先 建立 如下 定义 　 　 定义 一段 直线 是 一组 等 长行 段 的 有续 排列 如图 a 所示 a 行段 的 表示 形式 b 等 长行 段 跟踪 c 行段 的 转折点 表示 图 　 直线 的 行段 定义 　 　 组成 一段 有效 直线 的 必要条件 是 ： 组成 该 直线 的 连续 行段 的 行长 相等 ， 即 llli … ln ， 在 有 毛刺 的 情况 下 ， 至少 应 满足 ｜ lili ｜ ε 这里 li 表示 第 i 段行 段 的 长度 ； 相邻 行段 的 中心 的 水平 位移 应 小于 线 的 最大 宽度 　 　 定义 若 上下 两个 行段 的 长度 差 超过 最大 线宽 ， 则 表示 它们 属于 两个 不同 的 直线 段 如图 b 　 　 定义 若 上下 两个 行段 的 中心 位移 大于 最大 线宽 ， 则 表示 该点 为 直线 的 一个 转折点 拐点 ， 如图 c 所示 　 　 定义 若 存在 两个 行段 ， 属于 连续 的 相邻 扫描 行 ， 且 黑色 像素 之间 重迭 或 最 多 相差 一个 像素 ， 则 称 该 两行 段 为 上下 相邻 行段 　 　 在 递归 扫描 相邻 行段 的 过程 中 ， 对 已 遍历 的 行段 建立 一个 特定 的 标识 ， 以 防止 重复 遍历 当对 整个 图像 遍历 一次 后 ， 就 自动 形成 了 行段 与 行段 之间 的 链接 关系 这样 ， 当要 获取 这些 行段 链 组成 的 直线 时 ， 只要 找前 趋 指针 为空 指针 的 节点 ， 并 按照 其 后继 可 将 连续 行段 全部 取出 直至 其 后继 为空 构成 所 需要 的 直线 线段 一般而言 ， 只要 连接 首尾 行段 的 中心点 ， 即可 获得 矢量 线 的 两端 点 坐标 　 　 由于 组成 直线 的 连续 行段 的 形态 不同 ， 其 直线 的 形状 、 位置 也 不同 为此 ， 进一步 建立 以下 定义 　 　 定义 水平 直线 是 由 一组 连续 的 行长 大于 最大 线宽 的 行段 组成 直线 的 端点 由 中心 行段 的 首尾 坐标 点 表示 ， 线宽 等于 行段 数如图 a 所示 　 　 定义 垂直 直线 或 斜 直线 是 由 一组 行段 数 小于 最大 线宽 的 连续 行段 组成 直线 的 端点 用 首尾 行段 的 中心点 坐标 来 表示 如图 a 　 　 对于 在 跟踪 方向 行段 呈 连续 分布 的 退化 情况 如图 a ， 需 将 连续 行段 再 做 行段 形态 分析 ， 以 确定 它们 是 属于 一段 直线 还是 多 段 直线 组成 的 直线 分割 的 方法 采用 了 Fractal 的 逐次 细分 的 思想 ， 即 首先 由 首尾 两行 段 中心 连线 ， 检测 出 中间 行段 的 中心点 的 最大 距离 H 的 一个 行段 如 这样 ， 直线 就 被 分割 为 两段 和 ， 再 对 和 两条 子 线段 中间 的 行段 做 上面 同样 的 测试 ， 直到 中间 行段 到 各个 直线 子 线段 的 距离 Hk ε 为止 对 检测 出 的 转折 行段 或 拐点 标以 特定 标识 ， 按照 标识 位置 即可 确定 每一子 线段 直线 a 行段 的 特征 退化 bFractal 的 逐次 细分 图 　 采用 逐次 细分 的 Fractal 方法 获取 直线 段 　 小 弯度 直线 端点 纠正 问题 　 　 在 基于 行程 编码 的 矢量化 过程 中 ， 对于 大 弯度 直线 具有 很 高 的 识别 精度 ， 其 拐点 的 行段 变化 方向 ， 行长 具有 明显 的 特征 但 在 小 弯度 情况 下 ， 其 拐点 处 的 特征 就 较为 模糊 ， 如图 a 所示 a 小 弯度 直线 拐点 的 模糊性 b 用 包围 矩形 确定 直线 的 端点 和 直线 的 宽度 图 　 小 弯度 直线 的 行段 特征 与 端点 定位 　 　 在 P ， P 两处 拐点 的 行长 处于 一种 均衡 增长 或 缩短 的 变化 过程 ， 即 由此 ， 可以 给出 以下 一般 直线 的 判别 条件 ： 　 　 若 ｜ lili ｜ ε ， 则 在 行段 i 处 存在 一 拐点 ； 　 　 若 对 所有 段 ， 存在 ｜ lilj ｜ ε ， 　 ij ∈ ［ m ］ ， 则 为 平稳 的 行段 组成 的 直线 ； 　 　 若 ｜ lil ｜ ε ， 但 lml ｜ δ ， 则 为 小 弯度 直线 　 　 小 弯度 直线 的 端点 位置 确定 可 依据 行长 变化 的 方向 来 确定 ， 其 判别 规则 为 　 　 若 lilii ∈ ［ m ］ ， 则 直线 长度 为 l ， 宽度 为 m 如 ； 　 　 若 lilii ∈ ［ m ］ ， 则 直线 长度 为 lm ， 宽度 为 m 如 　 　 依据 区段 内 的 有效 行段 ， 可以 确定 直线 的 端点 坐标 　 　 在 扫描 图像 质量 不高 、 有 较 多 毛刺 的 情况 下 ， 对大 倾角 的 直线 用 行程 编码 的 行段 分析 进行 矢量化 仍然 具有 很 高 的 精度 对 小 角度 、 小 弯度 的 水平 直线 作 上述 算法 处理 时 直线 方向 一般 较准 ， 但 端点 精度 会 受到 一定 影响 ， 因此 可 做 以下 的 进一步 验证 　 　 在 区段 内 中心 做 一 动态 矩形 ， 然后 采用 迭代 方法 逐次 放大 矩形 ， 直到 该 矩形 最大 限度 包围 区段 内 的 所有 行段 如图 b 所示 ， 矩形 的 最小 高度 或 宽度 为 一个 像素 　 　 动态 迭代 矩形 算法 如下 ： 　 　 从段 内 的 中心 ， 依据 方向 如 做 一小 矩形 ； 　 　 矩形 向 四边 方向 延伸 一个 Δ 值 Δ ； 　 　 判别 矩形 边上 的 采样 点 是否 完全 落 在 区段 内 某 一行 段 上 ， 即 若 矩形 k 边上 的 采样 点 不 在 区段 的 某 一行 段 上 ， 则 该 边 终止 向外 延伸 ； 若 矩形 k 边上 的 采样 点 仍 在 区段 的 某 一行 段 上 ， 则 返回 　 矢量化 线段 的 延伸 与 合并 算法 　 　 基于 细化 的 矢量化 方法 往往 产生 紊乱 的 连接 关系 ， 粗线 、 细线 被 连在一起 ， 没有 交点 的 地方 由于 图像 质量 等 因素 而 产生 了 许多 多余 的 交点 用 行程 编码 分析 行段 的 形态 识别方法 所 产生 的 直线 是 散列 的 线段 构成 的 矢量 线 ， 一般 它们 较 好 地 确定 了 各段 直线 的 方向 、 线宽 ， 但 直线 的 逻辑 连接 关系 还 没有 确定 　 散列 矢量 线 的 交点 计算 　 　 基于 行程 编码 的 矢量化 方法 所 得到 的 独立 线段 不会 产生 多余 的 拐点 ， 而 只是 本应 重合 的 两个 点 在 逻辑 上 还 没有 重合 ， 这时 需要 在 矢量 空间 进行 相交 直线 的 交点 归并 　 　 对于 多数 情况 的 两条 直线 相交 ， 如图 a 所示 ， 若 ， 则 直线 与 直线 相交 ， 并取 对于 多数 直线 相交 于同 一点 的 情况 如图 b ， 用 同样 方法 ， 取 ε 范围 内 的 全部 交点 的 平均 位置 点 作为 各段 直线 相应 端点 的 坐标值 a 直线 段 相交 b 多段 直线 交于 同 一点 c 两条 直线 的 合并 d 多条 直线 的 合并 图 　 相交 直线 端点 的 计算 与 同 向 、 同 属性 直线 的 合并 　 同 向 相连 直线 的 合并 　 　 按照 直线 矢量化 的 基本 思想 ， 具有 同 属性 的 一组 行段 组成 一个 矢量图 元 ， 如 直线 段 或 圆弧 段 但 由于 实际 工程 图形 的 复杂性 ， 有时 会 将 同 一根 直线 由于 相交 、 噪声 等 因素 分割 为 两段 或 多 段 ， 这样 就要 借助于 模仿 人 的 某些 理解 图形图像 的 思维 方式 ， 将 某些 割断 的 信息 重新组合 为 一个 完整 的 图形 信息 ， 这 就 好比 一个 人 看 一个 污染 或 残缺不全 的 字 或 图形 时 ， 他会 知道 不 清楚 的 地方 应是 什么 　 　 如图 c 所示 ， 直线 应是 一条 直线 ， 但 由于 直线 与 之 相交 ， 而 使 直线 被 分割 为 两段 ， 因此 对 相交 的 两条 直线 需 判定 二者 是否 合并 为 一条 直线 ， 其 合并 的 条件 为 　 　 直线 l 与 l 相交 于 一点 ， 即 存在 ； 　 　 直线 l 与 l 同方向 ， 即 l ∥ l ； 　 　 直线 l 与 l 具有 相同 的 线宽 　 直线 的 探测 延伸 　 　 在 直线 的 矢量化 过程 中 ， 由于 图形 要素 的 大小 、 比例 差异 较大 ， 很难 给出 一个 拒识 阈值 来 处理 所有 的 情况 往往 对于 较 均匀分布 的 图纸 ， 其 适应性 较强 ， 而 对于 不 均匀 、 具有 特殊性 的 图纸 ， 某些 图形 由于 阈值 的 不 适应性 而 拒识 采用 自 适应 、 学习 或 交互 的 方法 都 会化 去 大量 的 时间 ， 使 软件应用 效率 降低 　 　 本文 提出 的 思想 是 ， 在 前面 矢量化 的 基础 上 ， 对 图形 、 图像 作 进一步 的 局部 光栅 矢量 混合 探测 ， 自动 纠正 由于 参数 、 阈值 的 不 适应性 而 导致 的 拒识 如图所示 ， 一般 用人 眼较 容易 识别 出图 a 中 的 箭头 和 图 b 中 的 两根 钢筋 ， 而用 计算机 识别 时 ， 上面 所 描述 的 特征 在 这里 就 失去 了 ， 因此 还 必须 进一步 完善 行段 分析 的 方法 a 箭头 的 特征 被 混淆 b 平行 相连 直线 的 模糊性 c 探测 三角形 d 直线 的 动态 探头 图 　 特殊 组合 图形 特征 的 模糊性 与 推理 探测 　 　 对 箭头 而言 如图 c ， 在 前面 矢量化 的 基础 上 ， 可 得到 行段 的 局部 特征 ， 这时 假设 在 端点 处有 一 箭头 ， 其 比例 略 小于 实际 箭头 设 箭头 的 长度 ｜ L ｜ ， 直线 的 参数 方程 为 由 ， 即 ｜ xyxy ｜ ｜ L ｜ ， 其中 xxxxtyyyyt 代入 上 式 ， 可 计算 出 t ， 从而 确定 了 点 的 坐标 再设 箭头 的 宽度 为 w ， 与 相 垂直 的 直线 方向 为 ； 直线 的 长度 为 ｜ M ｜ 所以 ， 点 的 坐标 为 和 　 　 然后 再 判别 三角形 边上 的 点 是否 落 在 黑色 像素 内 ， 若 满足条件 则 表示 存在 一个 三角形 箭头 　 　 用 这种 基于 行段 的 链接 变化 特征 直接 识别 图像 的 形状 ， 具有 准确性 高 、 信息 完整 、 速度 快 等 特点 如果 使用 细化 算法 ， 则 无法 保证 这种 面状 图形 的 整体 信息 ， 而且 产生 细化 后 的 图形 变形 较大 ， 以致 无法 识别 　 实验 与 结论 　 　 工程图纸 线状 图形 矢量化 是 复杂 图形 识别 与 理解 的 基础 整体 识别 可以 在 信息 较完整 的 情况 下 获取 较 准确 的 结果 ， 使用 行程 编码 具有 信息量 小 、 数据 搜索 快 等 特点 ， 它 一般 要求 图像 的 连通 域 较完整 ， 对于 图面 质量 不高 的 图纸 ， 扫描 后 可先 做 ～ 次 的 膨胀 收缩 处理 ， 以 改进 其 连通性 本文 针对 建筑 结构图 的 识别 做 了 一定 试验性 研究 ， 该 项目 由 香港 有利 建筑 集团 资助 ， 目的 是 实现 钢筋 结构图 的 自动识别 和 自动 预算 图 a 表示 了 一根 梁 的 图纸 扫描 图像 ， 图 b 是 相应 的 矢量化 结果 a 图纸 的 扫描 图像 b 矢量化 后 的 图形 图 　 行段 分析 的 图形 矢量化 方法 用于 建筑 结构图 的 识别 实例 作者简介 ： 邹荣金 　 年 出生 ， 南京大学 计算机科学 系 博士 、 副教授 研究 方向 为 图形学 、 图像处理 与 识别 　 　 　 　 　 蔡士杰 　 年 出生 ， 南京大学 计算机科学 系 教授 、 博士生 导师 研究 领域 为 图形学 、 CAD 技术 　 　 　 　 　 张福炎 　 年 出生 ， 南京大学 计算机科学 系 教授 、 博士生 导师 研究 领域 为 多媒体技术 、 图形学 作者 单位 ： 南京大学 软件 新 技术 国家 重点 实验室 　 南京 　 参考文献 　 NagasamyVLangrnaNAEngineeringdrawingprocessingandvectorizationsystemComputerVisionGraphicsandImageProcessing ， ： ～ 　 HaralickRMQueeneyDUnderstandingengineeringdrawingdrawingsComputerVisionGraphicsandImageProcessing ， ： ～ 　 OsamuHorietalLinedrawinginterpretationusingprobabisticrelationMachineVisionandApplications ， ： ～ 收稿 日期 　 　 收 修改稿 日期 　