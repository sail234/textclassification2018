微型机 与 应用 WEIXINGJIYUYINGYONG 　 Vol 　 No 　 P 在 VisualBasic 程序 中 调用 Fortran 动态链接库 的 方法 鲜飞军 杨合 摘要 ： 用于 VB 应用程序 的 Fortran 动态链接库 及 在 VisualBasic 应用程序 中 调用 Fortran 动态链接库 的 方法 ， 给出 了 具体 的 应用程序 示例 。 关键词 ： 动态链接库 DLLVisualBasic 语言 Fortran 语言 可视化 　 　 Fortran 语言 以 其 清楚 的 结构 层次 、 强大 的 数值 计算 与 数学分析 能力 ， 而 广泛应用 于 数学 与 工程 计算 。 特别 适用 于 编制 具有 模块化 结构 的 大型 计算 程序 ， 如 有限元 数值 模拟 软件 。 软件 的 可视化 ， 一般 包括 界面 操作 、 数据 输入 与 数据 输出 的 可视化 。 可视化 编程 是 现代 计算 与 分析 软件设计 的 重要 发展 方向 之一 ， 直接 关系 到 应用程序 的 使用 效果 。 然而 ， Fortran 语言 的 一个 不足之处 是 进行 可视化 编程 难度 大 。 　 　 VisualBasic 语言 （ 以下 简称 为 VB ） 以其能 迅速 有效 地 编制 优良 的 交互 界面设计 性能 ， 被 越来越 广泛 地 应用 于 Windows 环境 下 系统 的 可视化 界面设计 。 VB 具有 简单 、 易学 易用 的 特点 ， 它 所 提供 的 对象 链接 与 嵌入 （ OLE ， ObjectLinkingandEmbeding ） 工具 ， 为 利用 其它 软件 进行 数据 的 可视化 处理 提供 了 方便 。 VB 的 缺点 在于 运算 速度慢 ， 不 适合 进行 大型 数值 计算 。 　 　 如果 能 将 Fortran 语言 强大 的 数值 计算能力 与 VB 在 界面 操作 、 数据 输入 与 数据 输出 方面 的 可视化 设计 能力 结合 起来 ， 则 可 充分利用 这 二种 语言 的 优势 。 二种 语言 结合 的 关键 是 建立 用于 VB 应用程序 的 Fortran 动态链接库 （ DLL ， DynamicLinkLibrary ） 。 VB 与 C 动态链接库 的 结合 ， 使 VB 进行 界面 开发 更为 方便 ， 可以 使用 经过 高度 优化 的 C 程序代码 ， 利用 C语言 与 计算机 底层 接口 通信 的 灵活性 还 可 实现 控制 方面 的 应用 。 虽然 如此 ， 但 考虑 到 C语言 的 数值 计算能力 不如 Fortran 语言 ， 而且 目前 Fortran 语言 在 工程 数值 计算 与 分析 中 的 广泛 应用性 ， 有 必要 对 实现 基于 VB 与 Fortran 语言 可视化 混合 编程 的 VB 调用 Fortran 动态链接库 这一 关键技术 进行 研究 。 为此 ， 本文 探讨 了 Fortran 动态链接库 的 创建 与 调用 方法 ， 最后 给出 了 应用 示例 。 Fortran 动态链接库 的 创建 　 　 创建 用于 VB 应用程序 的 Fortran 动态链接库 的 方法 与 步骤 如下 ： 　 　 （ ） 在 MicrosoftFortranPowerStation ． ／ ． 的 环境 下 ， 创建 工程 类型 为 Fortran 动态链接库 的 工程 文件 （ ． DSP ） ； 　 　 （ ） 编写 Fortran 源程序 （ ． FOR ） 并 加入 到 该 工程 ； 　 　 （ ） 编译 （ Compile ） 、 建造 （ Build ） 此 源程序 ， 即可 生成 动态链接库 文件 （ ． DLL ） 。 　 　 在 编写 Fortran 源程序 时要 声明 输出 的 子程序 或 函数 过程 名 、 子程序 或 函数 过程 别名 、 接口 参数 名称 与 类型 ， 以供 VB 应用程序 调用 。 子程序 或 函数 过程 名 与 别名 中 不要 用 下划线 字符 “ ＿ ” 。 声明 语句 的 形式 如下 ： 　 　 　 DEC ＄ ATTRIBUTESDLLEXPORT ： ： 子程序 或 函数 过程 名 　 　 　 DEC ＄ ATTRIBUTESALIAS ： ′ 过程 别名 ′ ： ： 子程序 或 函数 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 过程 名 　 　 　 输入 参数 类型 ， INTENT （ IN ） ： ： 输入 参数表 　 　 　 输出 参数 类型 ， INTENT （ OUT ） ： ： 输出 参数表 VB 应用程序 调用 Fortran 动态链接库 的 方法 ． Fortran 动态链接库 子程序 或 函数 过程 的 声明 　 　 由于 Fortran 动态链接库 中 的 子程序 或 函数 过程 相对 于 VB 系统 而言 是 外部 过程 ， 因而 在 调用 之前 必须 向 VB 声明 该 过程 的 一些 信息 ， 以便 编译器 能 找到 该 过程 ， 并 生成 正确 的 调用 接口 。 　 　 存储 在 Fortran 动态链接库 中 的 子程序 或 函数 过程 需要 在 全局 模块 或 表格 级 模块 中 声明 ， 下面 是 声明 的 格式 。 　 　 若 过程 是 子程序 ， 则 ： 　 　 DeclareSub ＜ 动态链接库 子程序 过程 名 ＞ Lib ″ 动态链接库 名 ″ ［ Alias ″ 过程 别名 ″ ］ ［ （ ＜ 参数表 ＞ ） ］ 　 　 若 过程 是 函数 ， 则 ： 　 　 DeclareFunction ＜ 动态链接库 函数 过程 名 ＞ Lib ″ 动态链接库 名 ″ ［ Alias ″ 过程 别名 ″ ］ ［ （ ＜ 参数表 ＞ ） ］ ［ As 数据类型 ］ 　 　 其中 ： 动态链接库 子程序 或 函数 过程 名是 被 调用 动态链接库 中 的 子程序 或 函数 的 名字 ； 动态链接库 名为 动态链接库 子程序 或 函数 过程 所在 的 动态链接库 名 ， 需要 指明 Fortran 动态链接库 文件 所在 的 全 路径名 ； 过程 别名 为 可选项 ， 用来 给 动态链接库 中 的 子程序 或 函数 过程 换个 新 名字 ； 参数表 为 可选项 ， 指出 了 当 VB 调用 Fortran 动态链接库 中 的 子程序 或 函数 过程 时 ， 由 VB 传递 给 Fortran 动态链接库 子程序 或 函数 过程 的 参数 及 类型 ， 或 由 Fortran 动态链接库 子程序 或 函数 过程 传递 给 VB 的 参数 及 类型 ； 数据类型 为 Fortran 动态链接库 函数 过程 的 参数值 类型 。 　 　 在 VB 中 ， 参数 的 传递 方式 有值 方式 （ ByValue ） 和 引用 方式 （ ByReference ） 。 若 按值 方式 传递 ， 则 在 参数 前 加上 “ ByVal ” 关键字 ； 若 按 引用 方式 传递 ， 则 无需 加此 关键字 。 在 调用 Fortran 动态链接库 时 ， 要 注意 VB 应用程序 中 的 参数 类型 与 Fortran 动态链接库 被 调用 子程序 或 函数 过程 的 参数 类型 保持一致 。 表 给出 了 基本 的 Fortran 语言 数据类型 及其 对应 的 VB 应用程序 的 数据类型 。 表 基本 数据类型 对照表 Fortran 语言 VisualBasicIntegerIAsIntegerRealRAsSingleBoublePrecisionDAsDoubleComplexLogicalLAsBooleanCharacterByValSAsString ． Fortran 动态链接库 子程序 或 函数 过程 的 调用 　 　 在 全局 模块 或 表格 级 模块 中 声明 Fortran 动态链接库 中 子程序 或 函数 过程 以后 ， VB 应用程序 就 可以 随意 调用 库中 任意子 程序 或 函数 过程 了 。 调用 的 主要 步骤 如下 ： 　 　 （ ） 先 定义 被 调用 子程序 或 函数 过程 参数 的 类型 ； 　 　 （ ） 给 子程序 或 函数 过程 中 的 输入 参数 赋值 ； 　 　 （ ） 用 Call 语句 调用 ， 调用 格式 如下 ： 　 　 Call 子程序 或 函数 过程 名 （ 实参 ， … ） 　 　 其中 ： 当 无 参数 时 ， 省略 括号 。 程序 示例 　 　 为了 全面 说明 创建 Fortran 动态链接库 及 VB 应用程序 调用 Fortran 动态链接库 的 方法 与 步骤 ， 下面 给出 了 个 简单 应用程序 示例 。 程序 的 功能 是 ： VB 提供数据 输入 、 输出 及 操作界面 ； Fortran 动态链接库 子程序 完成 个 实数 的 求和 。 下面 是 示例 程序 及其 创建 过程 。 　 　 （ ） 在 MicrosoftFortranPowerStation ． ／ ． 环境 下 ， 创建 类型 为 Fortran 动态链接库 的 工程 文件 ， 命名 为 Example ． DSP 。 　 　 （ ） 建立 个 命名 为 Example ． FOR 的 Fortran 源程序 ， 并 加到 此 工程 。 　 　 Example ． FOR 源程序 ： 　 　 SubroutineFortranDll （ r ， r ， Add ） 　 　 　 ！ DEC ＄ ATTRIBUTESDLLEXPORT ： ： FortranDll 　 　 　 ！ DEC ＄ ATTRIBUTESALIAS ： ′ FortranDll ′ ： ： FortranDll 　 　 　 REAL ， INTENT （ IN ） ： ： r ， r 　 　 　 REAL ， INTENT （ OUT ） ： ： Add 　 　 　 Add ＝ r ＋ r 　 　 EndSubroutine 　 　 （ ） 建造 Fortran 动态链接库 文件 Example ． DLL 。 　 　 （ ） 在 VB ． 中文 企业 版 环境 下 启动 个 新 的 工程 ， 建立 个 新 的 窗体 ， 窗体 及 控件 的 属性 如表 所示 ， 编写 的 程序代码 如下 ： 表 窗体 与 控件 属性 描述 控件 类型 属性 属性 值 窗体 NameCaptionfrmExampleVB 调用 Fortran 语言 DLL 示例 程序 标签 NameCaptionbInputr 输入 r 文本框 NameTexttxInputr 标签 NameCaptionbinputr 输入 r 文本框 NameCaptiontxinputr 标签 NameTextbOutput 输入 rr 文本框 NameTexttxtOutput 命令 按钮 NameCaptioncmdAdd 求和 命令 按钮 NameCaptioncmdExit 退出 　 　 Example ． FRM 源程序 ： 　 　 Dimr ， rassingle 　 　 DimAddassingle 　 　 PrivateSubcmdAdd ＿ click （ ） 　 　 　 r ＝ Val （ txtInputr ． Text ） 　 　 　 r ＝ Val （ txtInputr ． Text ） 　 　 　 CallFortranDll （ r ， r ， Add ） 　 　 　 txtOutput ． Text ＝ Str （ Add ） 　 　 EndSub 　 　 PrivateSubcmdExit ＿ Click （ ） 　 　 　 End 　 　 EndSub 　 　 （ ） 在 该 工程 下 添加 个 模块 ， 编写 程序代码 。 　 　 Example ． BAS 源程序 ： 　 　 DeclareSubFortranDllLib ″ D ＼ Fortran ＼ Example ＼ Example ． DLL ″ （ rasSingle ， rasSingle ， AddasSingle ） 　 　 （ ） 生成 Example ． EXE 文件 。 　 　 在 Windows 环境 下 运行 Example ． EXE ， 生成 如图所示 的 界面 。 输入 实数 r 、 r 的 值 ， 单击 “ 求和 ” 按钮 ， 可 获得 二数 之 和 ； 单击 “ 退出 ” 按钮 ， 结束 程序运行 。 图 VB 调用 Fortran 动态链接库 示例 程序运行 情况 结束语 　 　 通过 VisualBasic 与 Fortran 动态链接库 的 结合 来 实现 基于 VB 与 Fortran 语言 的 可视化 混合 编程 ， 可 充分利用 VB 方便 快速 的 界面 开发 与 Fortran 语言 强大 的 数值 计算能力 。 本文 介绍 的 创建 Fortran 动态链接库 并 在 VB 应用程序 中 调用 Fortran 动态链接库 的 方法 ， 为 基于 VB 与 Fortran 语言 可视化 混合 编程 提供 了 一种 简单 可行 的 方法 。 鲜飞军 （ 西北工业大学 材料科学 与 工程学院 信箱 ） 杨合 （ 西北工业大学 材料科学 与 工程学院 信箱 ） 参考文献 ［ ］ 潭浩强 ， 田淑清 ． FORTRAN 语言 － FORTRAN 结构化程序 设计 ． 北京 ： 清华大学出版社 ， ［ ］ 蔡青 ， 高光焘 ． CAD ／ CAM 系统 的 可视化 集成化 智能化 网络化 ． 西安 ： 西北工业大学 出版社 ， ［ ］ 崔俊芝 ． 现代 有限元 软件 方法 ． 北京 ： 国防工业 出版社 ， ［ ］ 胡衡江 ， 蔡寒阳 ． Windows 下 VB 调用 C 动态链接库 ． 微型机 与 应用 ， ； ［ ］ 贾宏宇 ， 赵俊峰 ． VB 应用程序 中 用户 自定义 动态链接库 的 关键技术 ． 计算机系统 应用 ， ； ［ ］ 王 向阳 ． 如何 在 VisualBasic 应用程序 中 调用 动态链接库 ． 微型机 与 应用 ， ； 收稿 日期 ： － －