计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 P 基于 SQLSERVER 的 POS 系统 的 开发 与 实现 李涛 　 张艳珍 　 黎华 　 欧宗瑛 摘要 介绍 一个 POS 管理系统 。 文中 首先 介绍 了 POS 终端 的 设计 ， 然后 介绍 了 服务器 的 设计 ， 最后 对 该 系统 所 采用 的 存储 过程 、 触发器 、 报表 输出 、 OPOS 等 关键技术 进行 了 讨论 。 关键词 数据库 POS 存储 过程 触发器 系统 概况 　 　 随着 计算机 软硬件 的 发展 ， POSPointofsale 销售 管理系统 也 不断 发展 。 针对 便民店 、 食品店 等 中小型 商店 的 需要 ， 我们 采用 数据库 快速 开发工具 VisualBasic 开发 了 基于 WINDOWSNTWORKSTATIONSERVER 、 SQLSERVER 、 OPOSOLEPOS 技术 的 POS 系统 。 本 POS 系统 包括 POS 终端 、 管理 服务器 。 管理 服务器 可以 连接 条码 打印机 、 手持 扫描器 、 手持 终端 、 页 式打印机 等 设备 。 条码 打印机 可以 打印 商店 内 自己 用 的 商品 条码 ， 手持 扫描器 用于 在 服务器端 进行 商品 条码 的 扫描 录入 ， 手持 终端 用于 在 进行 外卖 时 商品 及 收款 信息 的 输入 ， 页 式打印机 可 用于 打印 各种 报表 。 POS 端的 业务 包括 开闭 店 处理 、 通常 销售 、 销售 订正 、 打折 销售 、 现金管理 、 各种 结算 等 ； 服务器端 的 业务 包括 开闭 店 业务 、 销售 管理 、 定货 进货 管理 、 付款 管理 、 库存 管理 、 顾客 管理 、 收款 管理 以及 系统 基本 管理 。 系统 的 结构 如图所示 。 图 　 POS 管理系统 POS 终端 的 设计 　 　 POS 终端 的 功能 主要 有 如下 部分 ： 　 　 开店 处理 　 　 营业员 输入 营业 日期 、 准备 的 零钱 信息 、 营业员 信息 及 开店 确认 等 。 　 　 销售业务 　 　 销售业务 可以 进行 通常 的 销售 ， 能 进行 商品信息 的 输入 ， 如 条码 的 读取 、 条码 的 手 输入 、 商品 的 数量 录入 、 商品 部门 代码 的 录入 等 ， 顾客 结算 及 购物单 的 打印 ； 销售业务 还 可以 进行 空 容器 的 返还 和 销售 的 订正 ， 如 退货 等 。 另外 ， 在 POS 终端 ， 还 可以 进行 各种 打折 销售 。 　 　 各种 统计 结算 业务 　 　 输出 POS 的 各种 销售 报表 ， 如 营业员 销售 实绩 、 部门 的 销售 报告 、 商品 的 销售 报告 等 。 还 可 进行 现金结算 ， 检查 现金 有无 缺少 。 　 　 闭店 处理 　 　 对 当天 的 销售 数据 进行 处理 ， 输出 所 需要 的 报表 。 　 　 系统管理 业务 　 　 可以 进行 销售 的 练习 、 时刻 的 设定 、 营业员 的 变更 、 零钱 的 输入 等 。 服务器 的 功能设计 　 　 开闭 店 业务 　 　 在 每天 的 营业 开始 时 ， 服务器 要 首先 开机 并 启动 管理程序 ， 输入 当天 的 营业 日期 。 在 闭店 处理 时 ， 对 当天 的 销售 数据 、 定货 进货 数据 、 付款 数据 、 库存 数据 进行 处理 ， 生成 相应 的 结算 数据 ， 并 根据 需要 ， 选择 输出 相应 的 报表 。 如果 当天 是 月度 结算 日期 时 ， 还要 自动 进行 月度 结算 ， 将 该当 月度 的 销售 、 进货 、 付款 、 库存 等 数据 结算 成以 月 为 单位 的 数据 存入 到 数据库 中 ， 供下 月 的 业务 或 月度 报表 使用 ， 还 根据 选择 打印 商品 、 分类 、 部门 的 月度 销售 等 报告 。 　 　 销售 管理 业务 　 　 服务器 在 营业 时 ， 不断 对 POS 终端 传来 的 销售 数据 利用 SQLSERVER 的 触发器 进行 实时处理 ， 生成 中间 数据 。 这样 ， 可以 快速 地 查看 当天 的 销售 报表 和 掌握 实际 库存 ， 还 可以 大大减少 闭店 处理 所 需 的 时间 。 经过 闭店 处理 的 销售 数据 和 未作 闭店 处理 的 销售 数据 分别 存放 在 结构 相同 但表名 不同 的 表中 ， 即 分为 历史 销售 数据 、 临时 销售 数据 ， 闭店 处理 时 只 对 临时 销售 数据 进行 处理 ， 处理 后 将 其 全部 转 到 销售 历史数据 。 　 　 对于 大宗 商品 ， 利用 条码 扫描器 可以 在 服务器上进行 销售 。 可以 赊帐 销售 ， 以后 在 服务器 付款 。 如果 赊帐 销售 ， 应 登记 顾客 的 信息 ， 即 要 进行 顾客 管理 ， 定期 进行 顾客 的 收款 管理 。 　 　 如果 需要 开展 外卖 业务 ， 还 可以 利用 手持 终端 ， 到 顾客 处 销售 。 回到 店里 后 将 销售 数据传输 到 数据库 中 以便 进行 管理 。 　 　 定货 和 购进 业务 　 　 定货 业务 让 店长 根据 商品 的 库存 情况 或 自己 的 预测 进行 商品 的 定货 ， 可以 输出 定货 书 、 商品 的 定货 一览表 、 商品 库存 的 最低值 等 报表 。 　 　 购进 业务 可以 对 预定 的 货物 进行 进货 ， 还 可以 对 没有 定货 的 商品 进行 进货 。 可以 随时 输出 进货 一览表 。 在 进货 后 ， 要 及时 更新 库存 信息 。 　 　 付款 管理 业务 　 　 付款 管理 要 进行 向 供货商 付款 数据 的 录入 和 该当 结帐 日应 向 供货商 付款 额 的 计算 ， 还要 输出 支付 一览表 、 支付 预定 表 、 购货 信息 等 报表 。 　 　 库存 及 盘点 管理 业务 　 　 对于 损坏 或 过期 要 废弃 的 商品 要 向 计算机 输入 数量 、 金额 等 以 更新 商品 的 库存 数据 ， 便于 正确 地 定货 或 购进 。 在 商店 进行 商品 盘点 时 将 商品 的 实际 数据 输入 数据库 中 ， 计算 出 实际 库存 。 　 　 顾客 管理 业务 　 　 顾客 管理 要 进行 顾客 信息 的 登录 ， 发行 优惠卡 等 。 　 　 收款 管理 业务 　 　 收款 管理 要 对 赊帐 购物 的 顾客 进行 收款 管理 ， 可以 输入 收款 数据 ， 输出 以 顾客 为 单位 的 赊帐 信息 、 摧款 书 及其 一览表 、 收款 一览表 等 。 　 　 系统 基本 管理 　 　 为了 便于 对 商品 进行 管理 ， 商品 要 按 部门 、 分类 等 进行 分门别类 。 这 就要 输入 商品 的 部门 、 分类 数据 。 为了 定货 及 购进 ， 要 输入 供货商 的 数据 ， 设定 每个 供货商 的 结帐 日 和 付款 方式 。 基本 管理 可以 设定 各种 特卖 ， 输入 营业员 数据 。 关键技术 研究 　 　 触发器 的 使用 　 　 所谓 触发器 ， 就是 存储 于 数据库 中 的 存储 过程 ， 它 被 绑定 到 一个 指定 的 数据表 上 ， 在 对 该表中 的 数据 进行 指定 操作 后 被 自动 激发 ， 能够 激发 触发器 的 操作 可以 是 插入 、 删除 和 数据 更新 三种 。 　 　 在 本 系统 中 ， 为了 能 对 POS 终端 传来 的 销售 数据 进行 实时处理 ， 我们 利用 了 SQLSERVER 的 触发器 。 对于 每条 销售 数据 记录 的 插入 ， 都 将 激发 触发器 ， 进行 如下 工作 ： 如果 数据库 中 无 该种 商品 的 销售 统计数据 ， 则 生成 该 商品 的 销售 统计数据 ， 插入 一条 记录 ； 如果 有 ， 则 对 其 更新 。 这样 ， 不用 对 所有 商品 每天 都 生成 记录 ， 大大减少 数据库 的 数据量 。 对 销售 数据 进行 实时处理 减少 了 闭店 处理 所 需 的 时间 。 　 　 在 POS 终端 ， 对于 各种 销售 数据 ， 也 利用 了 触发器 对 销售 数据 进行 实时 统计 处理 。 　 　 利用 触发器 进行 实时处理 ， 对于 中 小商店 的 业务量 已经 足够 了 ， 一台 服务器 可以 带台 POS 终端 。 但是 ， 在 服务器上进行 如 进货 、 新 商品 登录 等 其它 业务 时 ， 对 数据库 中表 的 占用 时间 要 尽可能 地短 ， 要 极力 避免 造成 死锁 ， 影响 实时处理 ， 从而 使 前后 台 数据传输 的 停止 。 在 我们 的 测试 中 ， 这种 情况 从来 没有 发生 ， 证明 了 这种 方案 是 可行 的 。 原则上 ， 触发器 的 处理 时间 要 尽可能 地短 ， 不要 进行 太多 的 工作 。 　 　 存储 过程 的 使用 　 　 存储 过程 是 由 一些 SQL 语句 和 控制流 语句 组成 的 封装 起来 的 过程 ， 它们 已 编译 通过 且 存储 在 数据库 中 ， 可以 很快 地 执行 。 大型 数据库 一般 都 提供 这种 高效 灵活 的 查询处理 技术 。 存储 过程 可以 返回 包括 状态 在内 的 多个 结果 集 。 　 　 为了 提高 POS 终端 和 服务器 闭店 处理 的 速度 ， 对于 不 需要 进行 人机交互 的 处理 部分 ， 我们 采用 了 SQLSERVER 的 存储 过程 ， 而 不是 逐条 地发 SQL 语句 。 在 存储 过程 中 ， 我们 还 利用 了 临时 表 生成 临时 数据 ， 然后 更新 统计数据 。 在 以 月 为 单位 的 结算 处理 中 ， 对 所有 的 处理 都 采用 了 存储 过程 。 　 　 在 报表 的 生成 中 ， 为了 满足 格式 的 需要 和 提高 速度 ， 我们 也 采用 了 存储 过程 。 在 输出 报表 时 ， 先 在 数据库 中 ， 利用 存储 过程 生成 报表 所 需 的 临时 表 。 然后 通过 报表 控件 输出 。 　 　 RDO 的 使用 　 　 在 VisualBasic 中 ， 访问 SQLSERVER 数据库 有 很多 方式 ， 如 Data 控件 、 RemoteData 控件 、 ODBCAPI 、 数据 访问 对象 DAO 、 远程 数据 对象 RDO 及 VBSQL 等 。 Data 控件 、 RemoteData 控件 都 很 方便 但 不 灵活 。 利用 ODBCAPI 访问 数据库 编程 不 方便 。 VBSQL 是 SQLSERVER 为 VisualBasic 提供 的 访问 数据库 的 最 强大 的 访问 工具 ， 但是 编程 也 不 很 方便 ， 只 在 安装程序 中 建立 应用程序 的 数据库 时 使用 。 RDO 、 DAO 两种 对象 访问 数据库 都 很 方便 灵活 ， RDO 访问 数据库 的 速度 很快 ， 在 本 系统 中 ， 我们 采用 了 RDO 。 RDO 通过 SQL 语句 可以 很 方便 地 对 数据库 中 的 记录 进行 插入 、 更新 、 查询 和 删除 。 RDO 除了 可以 通过 发 SQL 语句 取得 需要 的 结果 集外 还 可以 执行 存储 过程 。 　 　 在 本 系统 中 ， POS 终端 、 服务器 都 是 通过 RDO 访问 数据库 。 POS 终端 、 服务器之间 也 采用 RDO 进行 数据库 间 的 通信 。 　 　 各种 报表 的 输出 　 　 在 POS 管理系统 中 ， 我们 常常 需要 在 后台 服务器 上 输出 各种 报表 。 如果 手工 编程 ， 则 费时费力 。 为了 满足需要 ， 我们 采用 了 水晶 报表 CrystalReports 、 FormulaOne 、 FirstImpression 等 控件 。 水晶 报表 是 VisualBasic 自带 的 。 水晶 报表 无需 编程 即可 输出 简单 的 报表 。 对于 稍微 复杂 的 报表 可以 利用 存储 过程 ， 生成 临时 数据 ， 然后 利用 水晶 报表 输出 。 FormulaOne 、 FirstImpression 是 由 开发 PowerBuilder 的 Sybase 公司 开发 的 ActiveX 控件 。 FormulaOne 、 FirstImpression 可供 VisualBasic 、 VisualC 及 PowerBuilder 等 使用 。 FormulaOne 类似 于 EXCEL ， 但是 有 很大 增强 。 利用 FormulaOne 可以 很 方便 地 在 屏幕 上 和 打印机 上 输出 极其 复杂 的 报表 ， 完成 报表 所 需要 的 换页 功能 。 FirstImpression 可以 在 屏幕 上 和 打印机 上 输出 相当 复杂 的 图形 报表 。 　 　 OPOS 技术 　 　 微软公司 为了 满足 业界 的 需要 ， 针对 各个 行业 推出 了 一系列 解决方案 的 标准 。 例如 ， 针对 零售业 ， 提出 了 POS 外围设备 的 OLE 接口 ， 供 POS 外围设备 开发商 和 POS 管理系统 开发者 参考 使用 。 这样 ， 不同 厂商 的 POS 外围设备 可以 互换 而 不必 修改 POS 应用程序 ， 极大 提高 了 应用 系统 的 可维护性 。 目前 ， OPOS 设备 标准 已经 有 POS 打印机 、 条码 扫描器 、 POS 键盘 、 钥匙 锁 、 顾客 显示器 、 钱箱 抽屉 等 常用 的 设备 。 　 　 对于 POS 管理系统 开发者 而言 ， 使用 OPOS 设备 如同 使用 ActiveX 控件 一样 ， 非常 方便 。 结束语 　 　 目前 ， 本 系统 已 投放市场 ， 正在 根据 用户 的 需要 进行 功能 的 强化 。 事实证明 ， 我们 所 采用 的 平台 及 技术 方案 是 正确 的 和 有 发展前途 的 。 　 　 本 系统 目前 只 适用 单个 商店 ， 若 稍加 改造 ， 增加 总店 的 管理 ， 可 用于 连锁店 ， 还 可 增加 同 供货商 的 联网 。 如果 需要 ， 还 可 增加 同 应用 系统 的 开发商 或 供货商 联网 ， 进行 系统 的 远程 维护 。 李涛 （ 大连理工大学 机械系 CAD 研究所 大连 ） 张艳珍 （ 大连理工大学 机械系 CAD 研究所 大连 ） 黎华 （ 大连理工大学 机械系 CAD 研究所 大连 ） 欧宗瑛 （ 大连理工大学 机械系 CAD 研究所 大连 ） 参考文献 ， TransactSQLReferenceMicrosoft ， DatabaseDevelopersCompanionMicrosoft ， VisualBasicBooksOnlineMicrosoft ， OLEforRetailPOSApplicationProgrammersGuideMicrosoft ， 石树刚 郑振楣 关系数据库 北京 清华大学出版社 收稿 日期 ： 年月日