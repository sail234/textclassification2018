计算机 应用 ComputerApplications 年 第卷 第期 VolNoPowerBuilder ／ Oracle 编程 应用 经验 张 　 坤 　 伊希荣 　 　 摘 　 要 　 本文 针对 PowerBuilder 和 Oracle 由于 推出 时间 上 的 差异 造成 的 不 完全 支持 的 情况 ， 对 应用 编程 中 日期 型 数据 的 输入 、 输出 ， 数据 窗口 记录 的 增 、 删 、 改 ， 以及 Table 表 之间 的 外键 连接 等 问题 进行 了 探讨 ， 并 给出 了 具体 解决方案 。 　 　 关键词 　 PowerBuilder 编程 应用 ， 日期 型 数据 ， 数据 窗口 ， 外键 连接 　 　 作为 客户机 服务器 开发 环境 的 PowerBuilder 具有 许多 优秀 的 功能 特性 ， 如 面向对象编程 、 可视化 开发 环境 、 事件驱动 编程 方式 、 开放式系统 、 图形用户界面 等 ， 尤其 是 开放系统 功能 是 PowerBuilder 最 优秀 、 最受 用户 欢迎 的 功能 之一 。 PowerBuilder 是 一个 开放 的 协作 式 环境 ， 它 可以 访问 任何 一个 常用 的 后台 数据库系统 ， 例如 Oracle 、 Sybase 、 Informix 或者 DB ， 同时 它 也 可以 把 许多 开发工具 集成 到 PowerBuilder 中 。 笔者 在 进行 企业 MIS 信息管理系统 的 开发 过程 中 ， 整个 系统 采用 CLIENTSERVER 结构 ， 采用 PowerBuilder 作为 CLIENT 端的 开发工具 。 数据库 服务器 为 ORACLEENTERPRISE 。 但 PowerBuilder 与 Oracle 相连 时 ， 由于 PowerBuilder 与 Oracle 之间 存在 推出 时间 上 的 差异 ， 后者 的 推出 时间 迟 于 前者 ， 因此 前者 对 后者 的 支持 依赖于 其 提供 的 补丁 程序 ， 这样 就 出现 了 没有 完全 支持 的 情况 。 例如 PowerBuilder 与 Oracle 中文版 日期 格式 不 兼容 等 。 这样 ， 在 编程 应用 中 就 存在 着 许多 值得注意 的 地方 。 　 　 　 日期 型 数据 的 输入 、 输出 　 　 PowerBuilder 的 数据 窗口 DataWindow 提供 了 大量 内置 的 功能 ， 在 应用 中 大多数 与 数据库 的 交互 都 可以 通过 DataWindow 来 完成 。 但 为 方便 编程人员 更加 深入 开发 数据库 应用 ， PowerBuilder 还 提供 了 一整套 嵌入式 SQL 命令 ， 编程人员 可以 在 PowerBuilder 脚本 中 自由 地 嵌入 SQL 命令 。 一般来说 ， 嵌入 的 SQL 语句 为 标准 SQL 语句 即可 。 但 PowerBuilder 与 Oracle 相连 时 ， 其 嵌入 的 SQL 语句 有 许多 值得注意 的 地方 。 例如 PowerBuilder 脚本 中 引用 字符串 ， 一般 不 限制 是 单引号 还是 双引号 ， 但 与 Oracle 库 相连 时 ， 调用 的 SQL 语句 中 用到 的 字符串 只能 使用 单引号 。 　 　 PowerBuilder 与 Oracle 相连 ， 尤其 当 嵌入 的 SQL 语句 中要 使用 到 日期 型 数据 时 ， 更要 使用 特定 的 转换 语句 ： 　 　 （ ） 从 数据库 调出 数据 时 ， 如果 是 日期 date 型 数据 ， 必须 使用 TO — CHAR 函数 。 TO — CHAR 函数 的 语法 为 ： TO — CHARdate ′ Format ′ ， 其 功能 是 根据 日期 描述符 设定 的 日期 格式 ′ Format ′ 得到 Oracle 数据库 中 日期 型 数据 相对 应 的 字符串 。 　 　 （ ） 把 数据 写入 数据库 时 ， 如果 是 日期 date 型 数据 ， 必须 使用 TO — DATE 函数 。 TO — DATE 函数 的 语法 为 ： TO — DATEstring ′ Format ′ ， 其 功能 是 将 一个 字符串 转换 为 给定 格式 的 日期 ， 并 写入 Oracle 数据库 中 。 　 　 （ ） 日期 描述符 ′ format ′ 必须 用 单引号 括 起来 。 在 单引号 内 ， 一个 特定 的 日期 符号 可以 与 任何 文本 字符 放在 一起 。 但 文本 字符 必须 用 双引号 括 起来 。 例如 这 ′ format ′ 格式 可以 设 为 ： ′ TheddofMonthintheyearYYYY ′ ， 类似 等等 。 　 　 同时 ， 如果 将 数据库 中 的 时间 数据 调出 显示 在 屏幕 上时 ， 应 注意 数据库 中 时间 为 空值 （ NULL ） 时 的 情况 。 例如 ， 窗口 中 定义 了 一个 掩码 编辑 （ EditMask ） 形式 的 单行 编辑器 em — ， 用来 存放 数据库 中 worker 表 的 birthday 字段 （ 日期 型 数据 ） 。 em — 的 掩码 格式 为 ： “ YYYYMMDD ” 。 按照 上面 中 提到 的 ， 首先 用 “ TO — CHAR ” 函数 ， 将 birthday 字段 从 数据库 中 取出 转换 到 变量 ls — birth 中 。 　 　 SelectTO — CHARbirthday ′ yyyymmdd ′ 　 　 　 Intols — birth 　 　 　 Fromworker 　 　 　 Whereworker — bhls — bh 　 　 　 Usingsqlca 　 　 此时 ， 要 将 birthday 数据 放到 em — 中 ， 如果 只是 简单 地写 上 ： em — textls — birth 是 不 准确 的 。 当 数据库 中 birthday 数据 为 空值 NULL 时 ， 取出 数据 则 会 出现 错误信息 ： “ Mismatchbetweenretrievecolumnsandfetchcolumns ” （ 数据类型 不 匹配 ） 。 正确 的 编程 是 要 加上 对 时间 数据 的 判断 ： 　 　 IfIsnullls — birthThen 　 　 　 em — text 　 　 Else 　 　 　 Em — textls — birth 　 　 EndIf 　 　 如果 要 将 em — 中 的 数据 写 回到 数据库 中 ， 同样 也 要 先 对 是否 为 空值 进行 判断 ， 然后 使用 “ TO — DATE ” 函数 。 　 　 Ifem — textThen 　 　 　 em — GetDatald — birth 　 　 　 　 　 　 获取 时间 　 　 Else 　 　 　 SetNullld — birth 　 　 EndIf 　 　 　 ls — birthstringld — birth ′ YYYYMMDD ′ 　 　 … … 　 　 UpdateworkerSet 　 　 　 　 BirthdayTO — DATEls — birth ′ YYYYMMDD ′ 　 　 　 　 Whereworker — bhls — bh 　 　 　 　 Usingsqlca 　 　 另外 还有 一些 值得注意 的 地方 ： Oracle 库中 的 日期 描述符 对时 、 分 、 秒 的 表示 与 PowerBuilder 有所不同 。 PowerBuilder 对时 、 分 、 秒 （ 小时 制 ） 是 用 hhmmss 来 表示 ， 而 Oracle 对时 、 分 、 秒 （ 小时 制 ） 是 用 hhmiss 来 表示 ， 这 一点 在 编程 书写 时 ， 尤其 要 注意 。 　 关于 数据 窗口 中 记录 的 增 、 删 、 改 　 　 在 PowerBuilder 开发 环境 中 ， 系统 给出 了 用来 访问 和 操纵 数据库 的 Database 描绘 器 ， 可以 非常 方便 、 容易 地 创建 、 访问 和 维护 所有 后 端 数据库 结构 ， 不管 是 哪 一种 数据库 或 服务器 ， Database 都 能 提供 完全相同 的 简单 易用 的 可视化 界面 来 使用 它们 。 但 PowerBuilder 与 Oracle 相连 时 ， 如果 Oracle 数据库 表中 有 日期 型 的 字 段 ， 则 对 数据库 表 的 记录 进行 增 、 删 、 改 存盘 时 ， 都 会 出现 数据库系统 错误信息 ， 而 操作 失败 。 其 原因 是 PowerBuilder 自动 将 Database 描绘 器中 的 操作 转换 为 标准 SQL 语句 送到 数据库 中 执行 ， 而 其中 用位 字母 表示 的 月份 ， Oracle 库 不 接受 。 例如 ， 笔者 专门 为此 建了 一个 text 表 ， 其中 有 text — id 和 date （ 日期 型 ） 字 段 。 当对 其中 已有 的 记录 进行 修改 时 ， 系统 给出 以下 错误信息 ： ORA 非法 的 月份 NochangesmadetodatabaseUpdateTEXTSetDATETO — DATE ′ Nov ′ ′ DDMONYYYYHHMISS ′ WhereTEXT — ID ′ 　 　 　 ′ AndDATETO — DATE ′ Nov ′ ′ DDMONYYYYHHMISS ′ 　 　 当对 库表 进行 增加 、 删除 记录 的 操作 时 ， 也 会 给出 类似 错误信息 。 　 　 在 编程 应用 时 ， 对 数据 窗口 进行 操作 ， 如果 存在 日期 型 字 段 也 会 存在 以上 问题 ， 给出 类似 数据 窗口 提交 出错 信息 。 在 具体 应用 中 ， 笔者 经过 编程 解决 了 这个 问题 。 具体 的 做法 是 首先 在 数据 窗口 的 dbError 事件 中 提取 到 原来 执行 的 SQL 语句 ， 经过 转换 得到 新 的 Oracle 库 可 接受 的 SQL 语句 ， 然后 在 类似 “ 存盘 ” 的 菜单 或 按钮 的 脚本 中 ， 执行 新 的 SQL 语句 即可 。 在 dbError 事件 中 能 接受 以下 参数 ： 　 　 sqldbcode ： 发生 错误 DBMS 专有 的 错误 号 ； 　 　 sqlerrtext ： DBMS 专有 的 错误信息 ； 　 　 sqlsyntax ： 错误 产生 时 正在 执行 的 SQL 语句 ； 　 　 buffer ： 导致 错误 的 行 所在 的 缓冲区 。 值为 DeleteFilter 或 Primary ； 　 　 row ： 导致 错误 的 行号 。 　 　 所以 数据 窗口 的 dbError 事件 脚本 可 写成 ： 　 　 IfsqldbcodeThen 　 　 　 　 　 　 　 　 　 数据库 操作 出现 错误 gs — old — sqlSQLsyntax 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 提取 原来 的 SQL 语句 赋值 给 全局变量 gs — old — sqlf — change — sql — date 　 　 　 　 　 　 　 进行 SQL 语句 的 转换 EndIfReturn 　 　 　 　 　 　 　 　 　 　 　 　 　 不 显示 出 系统 错误信息 　 　 其中 f — change — sql — date 是 对 SQL 语句 进行 转换 的 函数 ， 脚本 如下 ： longll — totalll — posstringls — sqlls — sqlgs — old — sqlgs — new — sqlDoll — totallenls — sqlll — posposls — sql ′ TO — DATE ′ Ifll — posThengs — new — sqlgs — new — sqlls — sqlReturnEndIfll — posposls — sql ′ ′ ll — posgs — new — sqlgs — new — sqlleftls — sqlll — posgs — new — sqlgs — new — sqlf — change — monthmidls — sqlll — posgs — new — sqlgs — new — sqlmidls — sqlll — pos ′ DDMMYYYYHHMISS ′ ll — posposls — sql ′ ′ ll — posls — sqlrightls — sqlll — totalll — posLoopUntilll — pos 　 　 其中 f — change — month 是 将 位 字母 表示 的 月份 转换 为 数字 月份 的 函数 ， 具体 脚本 这里 就 不 列举 了 。 gs — new — sql 是 全局变量 ， 用来 储存 经过 转换 后 数据库 可 接受 的 SQL 语句 。 最后 ， 在 类似 “ 存盘 ” 的 菜单 或 按钮 的 脚本 中 编程 执行 新 的 SQL 语句 即可 。 笔者 是 在 窗口 的 “ 存盘 ” 按钮 中 进行 编程 的 ， 具体 脚本 如下 ： 　 　 Integerrtnrtndw — UpdateIfrtnThenCommitUsingsqlcaElseRollbackUsingsqlcaExecuteimmediategs — new — sqlCommitUsingsqlcadw — RetrieveEndIf 　 　 　 Table 表 之间 的 外键 连接 　 　 数据库 表间 的 一对 多 的 关系 可以 是 主键 和 外键 的 关系 ， 例如 作者 和 作者 著作 表 的 关系 是 一对 多 的 关系 ， 即 一个 作者 可以 写 多 本书 ） ， 部门 雇员 关系 是 一对 多 的 关系 等等 ， 它们 之间 就 可以 建立 主键 和 外键 的 关系 。 在 数据库 管理 的 编程 应用 中 ， 我们 应当 利用 主键 和 外键 来 定义 数据库 的 引用 完整性 ， 有效 地 使用 它们 意味着 数据库 （ 不是 应用程序 ） 将 迫使 用户 提供 各种 有效值 ， 以 维护 数据库 的 完整性 、 一致性 。 拿 部门 雇员 关系 举个 例子 ， 假定 我们 虚构 一个 公司 是 由个 部门 组成 ， 而 每个 雇员 都 属于 一个 部门 管辖 。 在 这种 情况 下 ， 数据库 应 包含 雇员 表 和 部门 表 。 其中 ， 雇员 表 的 主键 是 emp — id ， 而 部门 表 的 主键 是 dept — id 。 雇员 表应 包含 一个 dept — id 列 ， 指出 某个 雇员 是 在 该 部门 工作 。 为了 把 引用 完整性 引入 数据库 ， 雇员 表中 的 dept — id 列 应当 指定 外键 以 指向 部门 表 。 这样 ， 应用程序 就 并不需要 为 确保 某个 雇员 所 指定 的 部门 代码 是 有效值 而 编写 具体 程序 ， 其 原因 是 数据库 会 自动 处理 此类 问题 ， 当为 某个 雇员 所 指定 的 部门 代码 是 无效 值时 ， 数据库 会 给出 系统 错误信息 ， 而 不 允许 这样 的 操作 。 　 　 在 PowerBuilder 中为 数据库 表 建立 主外键 关系 时 ， 有 一个 “ OnDeleteofPrimaryTableRow ” 选项 ， 说明 当 主表 中 的 行 被 删除 时 ， 从表中 对应 行 可能 的 几种 操作 ： 不 允许 删除 主表 中 的 记录 ； 自动 删除 从表中 的 所有 对应 行 的 记录 ； 将 从表中 相应 行 的 对应 列设 为 Null 。 拿 上面 的 部门 雇员 例子 来说 ， 雇员 表 依赖于 部门 表 （ 主表 ） ， 如果 一个 部门 被 删除 了 ， 那么 这个 部门 中 的 所有 雇员 该 怎么办 呢 ？ 可以 选择 下列 几种 方法 ： 　 　 （ ） 只要 部门 中 还有 雇员 ， 就 不 允许 删除 这个 部门 ； 　 　 （ ） 自动 删除 雇员 表中 dept — id 列值 指向 该 部门 的 所有 雇员 记录 ； 　 　 （ ） 对于 所有 在 被 删除 部门 工作 的 雇员 ， 在 雇员 表 中将 其 相应 的 部门 列 设置 为 Null 。 　 　 在 PowerBuilder 本地 库中 如 SybaseSQLAnywhere ， 当 建立 主外键 关系 时 ， 在 “ OnDeleteofPrimaryTableRow ” 选项 中 选择 第二项 ， 则 主表 中 的 行 被 删除 时 ， 从表中 与 之 相对 应 的 所有 行 记录 会 自动 删除 。 而 PowerBuilder 与 Oracle 相连 时 ， 即使 选项 选择 第二项 ， 却 实现 不了 以上 功能 。 必须 编程人员 自己 具体 编程 ， 先 删除 掉 所有 从表中 与 主表 行 相对 应 的 所有 行 记录 ， 才能 再 删除 主表 中 的 行 。 　 　 DeleteFromemployee 　 　 　 　 　 　 　 　 　 先 删除 从表 相关 记录 Wheredept — idls — dept — idUsingsqlca ； IfsqlcasqlcodeThenMessageBoxDatabaseErrorsqlcaSQLErrTextExclamationReturnEndIfDeleteFromdepartment 　 　 　 　 　 　 　 　 　 再 删除 主表 记录 Wheredept — idls — dept — idUsingsqlca ； IfsqlcasqlcodeThenMessageBoxDatabaseErrorsqlcaSQLErrTextExclamationReturnEndIf 　 　 　 结束语 　 　 PowerBuilder 的 开放 性功能 是 它 众多 优秀 功能 之一 ， 但 它 与 不同 的 后台 数据库 相连 时 ， 仍 存在 一些 细微 的 差别 。 在 具体 编程 应用 中 ， 要 注意 加以 区分 和 处置 。 本文 针对 PowerBuilder 与 Oracle 相连 时 编程 中 出现 的 一些 问题 ， 如 具有 外键 连接 的 Table 表 的 记录 删除 问题 ， 由于 PowerBuilder 与 Oracle 中文版 格式 不 兼容 造成 的 数据 及 数据 窗口 的 操作 问题 等 ， 都 进行 了 探讨 ， 并 给出 了 编程 形式 的 解决方案 。 此外 ， 还有 PowerBuilder 不能 读取 Oracle 中 的 表 目录 及 Oracle 中 的 表 结构 等 问题 ， 限于 篇幅 ， 本文 不再 详细 介绍 。 　 　 张 　 坤 　 讲师 。 主要 研究 方向 ： 企业 MIS 系统 、 数据库 技术 。 　 　 作者 单位 ： 张 　 坤 　 伊希荣 （ 总装备部 指挥 技术 学院 　 北京 ） 参考文献 ［ ］ 　 JohnAdolphPalinski ． Oracle 数据库 构造 工具 实用 指南 ． 北京 ： 机械 工业 出版社 ， ［ ］ 　 BillHatfield ． PowerBuilder 应用 程序开发 指南 ． 北京 ： 清华大学出版社 ， 收稿 日期