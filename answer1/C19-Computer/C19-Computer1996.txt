微型机 与 应用 WEIXINGJIYUYINGYONG 年 月 第卷 第期 volNo 基于 Intranet 的 数据库系统 二 谭立 湘 　 罗家 融 接上 期 　 Web 数据库 应用 实例 　 　 基于 前面 对 各种 方案 的 分析 与 比较 ， 下面 将 具体 给出 一个 企业 Intranet 中 Web 数据库 应用 的 实例 。 该 系统 是 一个 企业 Intranet 信息系统 ， 对内 承担 着 搜集 信息 、 管理 信息 并 提供 用户 查询 的 功能 ； 对外 可以 面向 Internet 进行 信息 的 发布 。 　 系统 平台 的 选择 　 　 网络平台 选用 WindowsNT 中文版 操作系统 ， 数据库 管理系统 选用 Microsoft 公司 的 SQLServer 。 微软 的 WindowsNT 与 SQLServer 的 结合 是 实现 BrowserServer 体系结构 下 WWW 与 数据库 互连 的 优秀 平台 。 只 需要 台 高性能 微机 就 可以 作为 整个 系统 的 服务器 ， 提供 完善 的 DNS 域名服务 、 邮件 服务 、 WWW 服务 、 FTP 服务 、 Gopher 服务 和 数据库 服务 。 　 Internet 信息 服务器 — — IIS 　 　 我们 所 构建 的 企业 Intranet 信息系统 的 核心 为 IIS 。 它 是 WindowsNT 自带 的 一个 捆绑 软件 ， 可以 配置 成 WWW 服务器 、 FTP 服务器 和 Gopher 服务器 ， 并 支持 CGI 和 ISAPI 。 IIS 主要 包括 下列 组件 ： 　 　 Internet 服务 ： WWW 、 FTP 和 Gopher ； 　 　 Internet 服务 管理器 ： 管理 Internet 各种 服务 的 工具 ； 　 　 Internet 数据库 连接器 IDC ； 　 　 密钥 管理器 ： 安装 安全套 接层 SSL 密钥 的 工具 。 　 　 IIS 集成 了 WindowsNT 的 安全性 和 联网 性 ， 并 使用 现有 的 用户 帐号 。 用户 可以 在 安装 WindowsNTServer 时 安装 它 ， 也 可以 在 安装 NT 之后 再 单独 安装 。 下面 主要 介绍 WWW 服务器 的 配置 。 　 　 在 Internet 服务 管理器 中 双击 要 进行 配置 的 服务器 名 ， 以 显示 其 属性 页 。 　 　 属性 页 包括 服务 Service 、 目录 Directories 、 记录 Logging 和 高级 Advanced 类 属性 。 服务 属性 中 可以 设置 连接 超时 、 最大 连接数 、 匿名登录 名 等 。 系统 默认 的 匿名登录 名是 IUSRcomputername ， 安全 的 做法 是 设置 IUSRcomputername 帐号 ， 不能 使用 WindowsNT 文件系统 NTFS 删除 或 更改 文件 。 目录 属性 页 中 列出 了 作为 WWW 服务 的 目录 ， 缺省 宿主 目录 为 ＼ wwwroot 。 当然 可以 改变 缺省 宿主 目录 ， 增加 其它 目录 或 设置 虚拟目录 。 同时 在 这页 中 也 设定 了 WWW 服务器 的 默认 文档 ， 以及 是否 允许 目录 浏览 。 记录 属性 页 中 可以 设置 把 WWW 服务器 的 运行 情况 记录 到 个 文件 或 SQLODBC 数据库 中 ， 以便 管理员 进行 安全 和 统计 的 审查 。 高级 属性 页 中 可以 设置 对 WWW 服务 的 访问 权限 ， 如 限制 某些 IP地址 的 访问 、 限制 网络 输出 带宽 。 　 　 停止 服务器 的 运行 ， 并 重新启动 。 　 　 一个 值得注意 的 问题 是 ， 如果 你 所 创建 的 Web 页面 中 运用 了 CGI 、 IDC 、 ActiveX 等 动态 页面 技术 ， 包含 这些 页面 的 目录 属性 中 访问 权限 必须 设置 为 可 “ 执行 ” ； 否则 将会 在 程序执行 时 予以 拒绝 。 作为 一项 准则 ， 对于 包含 CGI 或 InternetISAPI 应用程序 的 虚拟目录 只 授予 执行 权限 。 　 WWW 与 数据库 的 互连 　 　 我们 建议 采用 IIS 中 提供 的 Internet 数据库 连接器 IDC 组件 来 实现 WWW 与 数据库 的 连接 。 因为 这是 一种 简单 快捷 的 Web 数据库 应用 开发工具 ， 能 大大 减轻 开发者 的 编程 难度 ； 同时 IDC 又 是 基于 ISAPI 机制 的 ， 访问 数据库 的 效率高 ， 对 服务器 造成 的 负载 小 。 IDC 实际上 是 一个 ISAPI 应用程序 Httpodbcdll ， 它 使用 两类 文件 来 控制 访问 数据库 且 返回 结果 的 HTML 页面 的 构造 。 这 两类 文件 分别 为 ： 　 　 ① InternetDatabaseConnector 文件 idc 　 　 其中 包含 连接 到 ODBC 数据源 的 必要 信息 及要 执行 的 SQL 语句 ， 还 包含 了 HTML 扩展 文件 的 文件名 及其 路径 。 　 　 ② HTML 扩展 文件 htx 　 　 它 是 显示 查询 结果 的 HTML 文档 的 模板 文件 ， 它 同样 是 用 HTML 语言 编写 的 ， 其中 可 包括 文字 、 图像 、 音频 、 视频 等 。 模板 文件 的 作用 是 在 IDC 访问 数据库 后 将 所得 信息 如 查询 结果 插入 到 模板 文件 中 ， 以 形成 一个 完整 的 HTML 文档 。 　 　 IDC 工作 原理 　 　 利用 IDC 实现 WWW 与 数据库 互连 的 工作 流程 如图 。 即 Web 浏览器 使用 HTTP 将 请求 提交 给 Web 服务器 ， Web 服务器 将 HTML 格式 的 文档 传递 给 IDC 模块 ， 然后 由 IDC 转换成 相应 的 SQL 语句 ， 再 通过 ODBC 驱动程序 去 访问 数据库 。 具体 按步 执行 ： 　 　 ① 由 IIS 接收 URL ； 　 　 ② IIS 装载 IDC 模块 ， 并 提供 其 URL 中 保存 的 信息 ； 　 　 　 　 ③ Httpodbcdll 模块 读取 IDC 文件 ； 　 　 ④ IDC 与 ODBC 数据源 建立 连接 ， 并 调用 执行 IDC 文件 中 的 SQL 语句 ； 　 　 ⑤ IDC 将 从 数据库 中 取得 的 数据 合并 到 HTX 模板 文件 中 ； 　 　 ⑥ Web 服务器 将 合并 生成 的 HTML 文档 返回 给 客户端 浏览器 。 　 　 实现 IIS 访问 数据库 的 个 步骤 　 　 ① 为 IIS 安装 和 配置 ODBC 驱动程序 。 双击 “ 设置 ” 项 “ 控制面板 ” 中 的 ODBC 图标 ， 进入 “ ODBC 数据源 ” 对话框 ， 如果 以前 安装 了 某些 ODBC 驱动程序 ， 此时 会 在 列表 中 显示 相应 的 数据源 。 　 　 单击 “ 系统 DSN ” 按钮 ， 出现 “ 系统 数据源 ” 对话框 。 　 　 图 IDC 实现 WWW 与 数据库 互连 的 工作 流程 单击 “ 添加 ” 按钮 ， 出现 “ 添加 数据源 ” 对话框 ， 选定 “ ODBC 驱动程序 ” 并 “ 确定 ” ， 将 出现 专用 于 驱动程序 的 对象 ， 如 SQLServer 。 　 　 输入 数据源 名称 逻辑 名 ， 如 “ LocalServer ” ， 单击 “ 确定 ” 之后 ， 逐步 关闭 即可 。 　 　 注意 ， IDC 使用 的 是 系统 数据源 ， 因此 一定 要 保证 正确 设置 DSN 。 　 　 ② 编写 利用 表单 Form ， 接受 用户 输入 并 调用 IDC 文件 的 HTML 文档 。 　 　 在 表单 Form 的 编写 中 ， 可以 充分利用 所 提供 的 文本 text 、 口令 password 、 复选框 checkbox 、 单选 按钮 radio 输入 类型 以及 多重选择 输入 列表框 select ， 来 设计 最 便于 用户 输入 的 精美 页面 。 　 　 ③ 编写 IDC 文件 。 IDC 文件 中 包含 用于 访问 数据库 的 信息 ， 它们 的 格式 为 “ 域名 ： 值 ” ， 可 分为 如下 几类 ： 　 　 必要 域 ： 　 　 Datasource ： ODBC 系统 数据源 名称 DSN 。 　 　 Template ： 模板 文件 的 名称 和 路径 。 　 　 SQLStatement ： 所 要 执行 的 SQL 语句 。 　 　 可选域 ： 　 　 Username ： 若 不 使用 SQLServer 集成 的 安全性 ， 可 指定 一个 访问 数据库 的 有效 用户名 。 　 　 Password ： 与 用户名 对应 的 口令 ， 省略 此域 表示 无 口令 。 　 　 DefaultParameters ： 用户 未 填 的 表 单项 的 默认值 。 　 　 RequireParameters ： 要求 用户 必须 填写 的 表 单项 。 　 　 MaxFieldSize ： 每个 字段 的 最大 缓冲 空间 ， 默认值 为 B 。 　 　 MaxRecords ： 查询 可 返回 的 最大 记录 量 。 　 　 Expires ： 可 指定 高速 缓冲区 多少 秒 刷新 次 ， 否则 每次 都 要 访问 数据库 。 此域 指定 后 可 降低 系统 的 负荷 。 　 　 ODBC 高级 选项 ： 　 　 这些 选项 允许 调整 由 IDC 使用 的 ODBC 驱动程序 。 它们 的 格式 为 ： 　 　 ODBCOptionsOptionNameValue ［ OptionNameValue … 　 　 例如 ， 要 使 SQL 语句 停止 运行 十几秒 ， 并 停止 其 对 ODBC 函数调用 的 跟踪 ， 则 在 IDC 文件 中 指定 ： 　 　 ODBCOptionsSQLQUERYTIMEOUTSQLOPTTRACESQLOPTTRACEFILEC ＼ Sqllog 　 　 下面 给出 个 查询 的 例子 — — queryidc 　 　 DatasourceLocalServer 　 　 Usermameguest 　 　 Passwordok 　 　 Templatequeryhtx 　 　 SQLStatement 　 　 selectnameagesexidbirthdayphonesalary 　 　 frompubsdbopersonnel 　 　 wherenamelikenamepandsalarysalaryp 　 　 orderbyid 　 　 这里 要 特别 注意 百分号 的 用法 ， 是 SQL 中 的 通配符 。 在 SQL 查询 中 使用 通配符 可以 搜索 包含 特定 字符 的 表中 的 元素 。 在 前 又 使用 “ ” ， 是 为了 防止 IDC 试图 使用 作为 参数 标记 符 。 　 　 在 IDC 文件 中 ， 可以 将 SQL 查询 分为 组 ： 批处理 查询 和 多步 查询 。 　 　 批处理 查询 　 　 如果 数据库系统 可 同时 处理 几个 SQL 语句 ， 则 应 采用 批处理 查询 格式 。 例如 ： 　 　 SQLStatement 　 　 insertintoperftesttimetagvaluesgetdatetag 　 　 selectaulnameytdsalesfrompubsdbotitlewhereytdsales 　 　 selectcountasnrecsfrompubsdbotitlewhereytdsales 　 　 多 步 查询 　 　 如果 数据库系统 查询 不能 同时 处理 组 SQL 语句 ， 则 将 这些 查询 语句 配置 为 多步 查询 格式 。 例如 ： 　 　 SQLStatement 　 　 insertintoperftesttimetagvaluesgetdatetag 　 　 SQLStatement 　 　 selectaulnameytdsalesfrompubsdbotitlewhereytdsales 　 　 SQLStatement 　 　 selectcountasnrecsfrompubsdbotitleviewwhereytdsales 　 　 批处理 查询 将 次 处理完毕 所有 查询 ， 而多步 查询 每次 只 处理 个 。 因此 ， 如果 数据库系统 可 进行 批处理 查询 ， 将 查询 格式化 为 批处理 方式 可 获得 更好 的 性能 。 SQLServer 正是 这样 的 数据库系统 。 　 　 ④ 编写 HTX 模板 文件 ， 把 SQL 应答 转换 为 HTML 文件 。 　 　 HTX 模板 文件 是 含有 以括 起来 的 附加 标签 的 HTML 文档 ， IDC 能 识别 这些 标签 ， 并 将 动态数据 添加 到 文档 中 。 HTX 文件 中有 个 关键字 begindetailenddetailifelseendifand 、 种 操作符 LT 、 EO 、 GT 、 CONTAINS 和 个 内置 变量 CurrentRecord 和 MaxRecords ； 另外 还 可以 使用 各种 HTTP 变量 、 来自 IDC 文件 的 参数 、 数据库 列名 及 常数 。 下面 请 看 ③ 中 查询 示例 的 HTX 文件 — — queryhtx 　 　 html 　 　 headtitle 查询 结果显示 titlehead 　 　 bodybackground “ 纹理 gif ” 　 　 centerh 人员 信息 查询 结果 h 　 　 tableborderwidth 　 　 begindetail 　 　 ifCurrentRecordEQ 　 　 trth 编号 thth 姓名 thth 年龄 thth 性别 th 　 　 th 出生日期 thth 电话 thth 薪水 thtr 　 　 endif 　 　 trtdbidbtdtdbnamebtd 　 　 tdbagebtdtdbsexbtd 　 　 tdbbirthdaybtdtdbphonebtd 　 　 tdbsalarybtdtr 　 　 enddetail 　 　 ptablecenter 　 　 ifCurrentRecordEQ 　 　 h 抱歉 ， 没有 满足 查询 条件 的 数据 h 　 　 else 　 　 hrsize 　 　 endif 　 　 body 　 　 html 　 结束语 　 　 随着 基于 Intranet 信息技术 的 进一步 推广 ， 必将 加速 企业 由 传统 的 ClientServer 模式 向 先进 的 BrowserServer 模式 转换 ， 在 此基础 上 建立 自己 的 信息系统 ， 提高 企业 的 开放性 和 管理效率 。 作者 单位 合肥 中科院 等离子体 物理 研究所 计算中心 　 　 参考文献 　 　 MillecanJUnlockingMicrosoftInternetInformationServer 北京 ： 清华大学出版社 、 西蒙 与 舒斯特 国际 出版 公司 ， 　 　 MicrosoftCorpMicrosoftInternetInformationServerInstallationandplanningGuide 　 　 赵春泉 Microsoft 客户服务器 开发工具 实用手册 北京 ： 清华大学出版社 ， 　 　 王 文泰 ， 许景超 ， 施玉勋 Internet 王牌 — — WWW 使用指南 合肥 ： 中国 科学技术 大学 出版社 ， 　 　 StoutRTheWorldWideWebCompleteReference 北京 ： 海洋 出版社 ， 　 　 DwightJSpecialEditionUsingCGI 北京 ： 机械 工业 出版社 、 西蒙 与 舒斯特 国际 出版 公司 ， 　 　 HipsonPD 著张 达译 WindowsNTServer 北京 ： 电子 工业 出版社 ， 　 　 全文完 收稿 日期 ：