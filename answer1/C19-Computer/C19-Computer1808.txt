微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 　 No 　 No 　 PTCP ／ IP － ATM 网关 的 设计 与 实现 武岩 　 李津生 摘要 ： TCP ／ IP 与 ATM 网络 的 互联 问题 及 具体 的 解决方案 。 关键词 ： TCP ／ IP 异步 传输 模式 网关 　 　 面向 世纪 的 通信网 将 以 宽带 化 、 智能化 和 个人 化为 发展 方向 。 就 目前 的 通信 网络 来说 ， 基本 都 是 按照 业务 需要 分别 组建 的 ， 彼此之间 相互 独立 。 当 用户 需要 利用 多种 业务 时 ， 必须 分别 申请 ， 引入 多条 连接 不同 终端 的 用户线 。 这样 就 造成 了 资源 的 浪费 。 而 引入 带宽 综合 业务 数字网 （ B － ISDN ） 之后 ， 则 可以 将 各类 业务 综合 在 一个 通信网 内 ， 用户 只 需 提出 次 申请 ， 仅用 条 用户线 和 个 电信 号码 就 可 将 不同 业务 类型 的 终端 接入网 内 。 另外 ， 研究 表明 ， 可以 采用 异步 传输 模式 （ ATM ） 实现 通信网 的 宽带 化 。 ATM 本质 上 是 一种 快速 分组 交换 方式 ， 能够 适应 多种 速率 的 要求 。 基于 上述 理由 ， ITU － T 在 I ． 建议 中 指出 ATM 是 实现 B － ISDN 的 传送 方式 。 　 　 为了 实现 各种 业务 接入 B － ISDN ， 必须 提供 标准 的 用户 － 网络接口 （ UNI ） 实现 端到 端 连接 。 就 目前 来讲 ， 由于 LAN 的 广泛 使用 ， 通过 ATM 实现 LAN 之间 的 互联 具有 很大 的 现实意义 。 将 LAN 接入 B － ISDN ， 在 LAN 与 B － ISDN 之间 应有 个 网关 （ Gateway ） ， 以 实现 LAN 与 ATM 的 协议 转换 。 目前 ， TCP ／ IP 协议 是 使用 最为 广泛 的 网络协议 ， 已经 成为 事实上 的 网络协议 标准 。 因此 本文 将 讨论 TCP ／ IP 与 ATM 的 互联 ， 即 网关 如何 实现 TCP ／ IP 和 ATM 之间 的 协议 转换 。 　 　 本文 将 分个 部分 对 网关 的 设计 与 实现 进行 讨论 ， 首先 介绍 TCP ／ IP 协议 模型 ， 其次 简要 叙述 ATM 协议 ， 最后 给出 网关 的 实现 。 TCP ／ IP 协议 模型 　 　 TCP ／ IP 协议 分为 如下 几个 层次 ： 　 　 ． 应用层 。 向 用户 提供 组 常用 的 应用程序 ， 如 文件传输 、 电子邮件 等 。 　 　 ． 传输层 。 提供 应用程序 间端 到 端的 通信 。 　 　 ． 网络层 。 负责 计算机 之间 的 通信 。 功能 包括 ： 处理 来自 传输层 的 分组 发送 请求 ； 处理 输入 数据 报 ； 处理 控制 报文 。 　 　 ． 数据 链路层 。 为 网络层 提供 可靠 的 信息 传送 机制 。 分为 逻辑 链路层 （ LLC 层 ） 和 介质 访问控制 层 （ MAC 层 ） 。 　 　 ． 物理层 。 负责 用户 设备 和 网络 端 设备 之间 物理 的 和 电气 的 接口 。 ATM 协议 　 　 ATM 协议 分层 如下 ： 　 　 ． 物理层 。 规定 了 传输 信息 的 物理 媒介 的 种类 、 比 特定 时 （ bittiming ） 、 传输 帧 结构 以及 信元 在 传输 帧 内 的 位置 。 　 　 ． ATM 层 。 处理 信元 的 传输 。 该层 规定 了 信元 复用 传输 方法 、 信头 的 生成 ／ 删除 ／ 校验 以及 信元 类型 指示 。 　 　 ． ATM 自 适应 层 （ AAL ） 。 利用 ATM 层 的 信元 传送 能力 来 提供 高层 各种 业务 所 需 的 功能 。 目前 已经 制定 的 AAL 协议 类型 有 AAL 、 AAL 、 AAL 、 AAL 、 AAL 。 其中 ， AAL 应用 最为 广泛 ， 这种 业务 类型 非常适合 于 变长 的 突发性 的 大型 数据包 的 传输 。 因此 ， 对于 IP 报文 来说 ， 通常 都 采用 AAL 业务 类型 来 实现 协议 间通信 。 　 　 根据 I ． 协议 ， AAL 层 分为 会聚 子层 （ CS 子层 ） 和 分段 重组 子层 （ SAR 子层 ） ， CS 子层 又 分为 业务 专用 部分 （ SSCS ） 和 公共 部分 （ CPCS ） 块 ， 对于 AAL ， SSCS 可以 不 存在 ， 即 AAL 层 可 分为 CPCS 子层 和 SAR 子层 二 部分 。 　 　 AAL 层 将 AAL 业务 数据 单元 （ AALSDU ） 分段 ， 形成 SAR 协议 数据 单元 （ SARPDU ） ， 再 将 SARPDU 传给 ATM 层 发送 出去 ； 同时 对 ATM 层 收到 的 SARPDU 进行 重组 ， 形成 AALSDU 送给 上层 协议 。 网关 的 实现 网关 建立 的 层次 　 　 作为 网关 ， 为了 实现 不同 协议 的 转换 ， 理想 的 情况 是 这种 协议 具有 相互 对 等 的 一层 。 如图所示 ， 网关 建立 在 对 等 层 N 上 ， 将 N 层 以下 的 数据 集中 到 N ， 转化 为 另 一种 协议 的 N ′ 层 ， 再 利用 N ′ 以下 各层 发送 出去 。 这样 就 实现 了 协议 的 转换 。 图 协议 转换 　 　 但是 严格 地说 ， TCP ／ IP 和 ATM 协议 作为 适用 于 不同 通信网 的 协议 ， 它们 之间 并 不 具有 完全 对应 的 一层 ， 尽管 它们 都 与 OSI 参考模型 具有 一定 的 相似性 ， 但 在 许多 具体 细节 上 有 较大 的 差别 ， 将 网关 建立 在 完全 对 等 的 层次 上 的 想法 是 不 现实 的 。 　 　 为了 实现 网关 ， 必须 抛弃 那种 追求 严格 对 等 的 想法 ， 要 在 保留 网关 主要 功能 （ 即 完成 数据 转发 ） 的 基础 上 舍弃 一些 相对 不太 重要 或者 暂时 用 不到 的 细节 。 TCP ／ IP 和 ATM 在 协议 结构 上 有 一定 差别 ， 但 它们 在 一定 层次 上 又 存在 着 很大 相似性 ， 即 主要 功能 相似 而 一些 细节 上 有 差异 ， 这样 就 可以 把 它们 近似 地 当作 对 等 来 处理 ， 从而 在 理论 上 解决 了 网关 实现 的 困难 （ 实际上 ， 任何 二种 协议 都 不是 完全 对 等 的 ， 网关 在 进行 协议 转换 时 或多或少 都 有 一定 误差 ） 。 经过 认真 研究 ， 发现 IP 层 和 CPCS 子层 具有 很大 的 相似性 。 同时 ， 网关 建立 在 IP 层 和 CPCS 子层 上 ， 可以 避免 与 硬件 直接 接触 ， 受 冲击 的 可能性 小 ， 处理 的 情况 相对 简单 ， 网关 的 可靠性 高 。 因此 ， 本 系统 中 网关 建立 在 IP 层 和 CPCS 子层 上 。 网关 实现 中 的 地址 转换 问题 　 　 地址 的 编码 对于 通信网 来说 是 至关重要 的 ， 它 用来 标识 主机 ， 并且 在 一定 程度 上 反映 主机 所处 的 位置 （ 如 IP 协议 中 ， 通过 IP地址 可以 查明 主机 处于 哪个 网络 中 ） 。 基于 TCP ／ IP 的 LAN 和 B － ISDN 的 地址 编码方案 是 完全 不同 的 。 在 B － ISDN 中 ， 目的 主机 是 通过 E ． 所 规定 的 地址 来 标识 的 。 通过 E ． 地址 ， 利用 信令 方式 建立 虚 连接 （ 用 VPI 和 VCI 标识 ） ， 从而 在 物理层 上 确定 了 数据传输 的 路径 。 　 　 在 网关 中 ， 存在 这样 张 路由表 ， 包含 各个 主机 的 IP地址 及 与其 相对 应 的 E ． 地址 ， 当 网关 从 LAN 上 收到 个 IP 数据包 后 ， 根据 IP 包头 中 的 目的 IP地址 查出 与 之 相应 的 E ． 地址 ， 再 利用 信令 方式 建立 虚 连接 。 考虑 到 信令 方式 的 有关 协议 还有 待 完善 ， 目前 可以 略去 信令 方式 ， 直接 规定 与 某 一 IP地址 相对 应 的 虚 连接 （ VPI 和 VCI 值 ） ， 相当于 建立 了 永久性 虚 连接 （ PVC ） 。 在 路由表 中 包含 IP地址 和 相应 的 VPI 、 VCI 值 ， 通过 查表 直接 得到 与 某 一 IP地址 相对 应 的 虚 连接 。 网关 的 结构 和 操作 流程 　 　 网关 的 结构 如图所示 ， 由台 PC机 作为 主 处理器 ， 再接 上网卡 和 光 接口 。 其中 光 接口 由 专用 硬件 芯片 实现 ， 能够 完成 信元 的 发送 和 接收 。 图 网关 的 结构 　 　 网关 的 操作 主要 包含 以下 几个 方面 ： 　 　 ． IP 协议 的 实现 ， 包括 实现 地址 解析 协议 （ ARP ） 以及 将 IP 报文 从 以太网 帧 中 提取 出来 。 　 　 ． ATM 协议 的 实现 ， 包括 ： （ ） 将个 CPCSSDU 进行 相应 处理 后 通过 光 接口 发送 出去 ； （ ） 从光 接口 收到 信元 ， 从 其中 抽取 出 有效载荷 并 进行 重组 等 操作 直到 提取 出个 CPCSSDU 。 　 　 ． IP 协议 和 AAL 协议 的 相互 转换 。 　 　 利用 一些 TCP ／ IP 软件包 ， 如 LANWORKPLACE ， 可以 完成 TCP ／ IP 协议 的 一些 底层 功能 ， 包括 实现 地址 解析 协议 （ ARP ） 以及 将 IP 报文 从 以太网 帧 中 提取 出来 。 因此 ， 网关 的 实现 主要 集中 在 IP 协议 与 AAL 协议 的 转换 和 ATM 协议 的 实现 。 　 　 （ ） ATM 协议 的 实现 ATM 协议 可以 按照 层次 的 划分 分层 实现 。 　 　 ATM 层 包含 以下 调用 过程 ： 　 　 ① ATMSEND ： 接受 B 的 ATM 业务 数据 单元 （ ATMSDU ） 、 VPI ／ VCI 及 有关 控制 信息 ， 填充 信元头 ， 组装 信元 ， 通过 光 接口 发送 ； 　 　 ② ATMRECV ： 通过 光 接口 收到 B 的 信元 ， 从 其中 得到 B 的 ATMSDU 和 有关 控制 信息 。 　 　 SAR 子层 包含 以下 调用 过程 ： 　 　 ① SARSEND ： 将 SARSDU 拆 分为 B 组 的 ATMSDU ， 交给 ATM 层 发送 ； 　 　 ② SARREASSEMBLE ： 通过 ATMRECV 收到 ATMSDU 、 VPI ／ VCI 及 有关 控制 信息 ， 根据 VPI ／ VCI 的 值 ， 将 其中 的 有效载荷 添加 到 重组 缓冲区 中 ， 并且 根据 ATM 用户 － 用户 信息 （ AUU ） 的 值 设置 接收 完成 标志 ； 　 　 ③ SARGET ： 检查 重组 缓冲区 ， 如果 有 完整 的 SARSDU 收到 ， 则 将 其 从 缓冲区 中 读出 ， 交给 CPCS 子层 。 　 　 CPCS 子层 包含 以下 过程 ： 　 　 ① CSSEND ： 接收 要 发送 的 CSSDU ， 构造 CPCSPDUTRAILER ， 组装 SARSDU 调用 SARSEND 发送 ； 　 　 ② CSRECV ： 调用 SARGET 接收 SARSDU ， 从 其中 提取 出 CSSDU ， 并 得到 有关 控制 信息 。 　 　 （ ） IP 和 AAL 的 转换 　 　 网关 收到 个 IP 数据包 后 ， 首先 从 IP 包头 中 取出 目的 IP地址 ， 根据 此 地址 查找 路由表 ， 得到 与 之 相对 应 的 VPI ／ VCI 值 ， 再 将 整个 IP 数据包 作为 CPCSSDU ， 交给 CPCS 子层 发送 （ 通过 CSSEND ） 。 　 　 反过来 ， 如果 网关 从条 虚 连接 （ 由 VPI ／ VCI 标识 ） 收到 个 完整 的 CPCSSDU ， 则 根据 VPI ／ VCI 值查 路由表 得到 与 之 对应 的 目的 IP地址 ， 再 将 CPCSSDU 作为 个 IP 数据包 ， 交给 TCP ／ IP 软件包 中 的 相应 过程 发送 出去 。 实验 测试 　 　 我们 利用 Novell 的 LANWORKPLACE 软件包 对 网关 进行 了 测试 。 该 软件包 中 包含 个 测试程序 ， 分别 基于 TCP 和 UDP 。 每个 测试程序 由 客户端 和 服务器 个 可执行文件 组成 ， 在 不同 的 计算机 上 （ 不同 的 IP地址 ） 分别 运行 客户程序 和 服务器程序 ， 正常 情况 下 双方 能够 建立 连接 并 相互交换 数据 。 在 实验 中 ， 客户 与 服务器 分别 处于 LAN 和 LAN 中 ， 网关 （ Gateway ） 和 网关 （ Gateway ） 设 为 对应 LAN 中 的 缺省 路由器 （ DefaultRouter ） ， 经过 测试 ， 无论 基于 TCP 或者 基于 UDP ， 客户 与 服务器 都 能够 利用网关 经过 B － ISDN 实现 互联 。 图 　 利用 LANWORKPLACE 对 网关 进行 测试 本文 研究 得到 项目 资助 武岩 （ 中国 科学技术 大学 电子 工程 与 信息 科学系 ） 李津生 （ 中国 科学技术 大学 电子 工程 与 信息 科学系 ） 参考文献 ， ATMForum ． ATMUser － NetworkInterfaceSpecifica － tionV ． ， AndrewS ． Tanenbaum ． ComputerNetwork ． Prentice － HallInc ， ， 胡道 元 ． 计算机 局域网 ． 北京 ： 清华大学出版社 ， 收稿 日期 ： － －