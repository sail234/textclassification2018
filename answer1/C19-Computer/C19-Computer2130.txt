计算机 工程 COMPUTERENGINEERING 年 第卷 第期 volNoCEBus 中 的 电力线 载波 网 技术 及 改进 吴 　 刚 　 王伟艺 　 唐 志强 　 陈章 龙 　 涂时亮 　 　 用 模拟 技术 在 电力线 上 传递 载波 信号 很 早就 有 了 。 把 电力线 通信 技术 、 网络 、 微控制器 相结合 ， 是 在 现有 基础 上 推进 家庭 自动化 的 最 现实 途径 。 即以 电力线 为 物理 媒介 ， 把 分布 在 住宅 各个 角落 的 微控制器 和 家用 PC机 连成 一个 网络 。 其 优点 是 ： 电力线 和 信号线 合一 ， 无须 布设 信号线 ， 人们 原来 使用 和 维护 电器 的 习惯 都 不受 影响 ； 家电 无须 增加 双绞线 、 红外 等 接口 ， 只要 在 内部 配备 电力线 载波通信 芯片 ， 再 更新 程序 就行了 ， 对 老式 家电 的 改造 也 很 容易 ； 家电 的 信息量 小 ， 电力线 载波 速度慢 的 缺点 不 突出 ； 除了 家庭 ， 它 还 可 作为 智能 大楼 的 后备 网络 ； 由于 底层 功能 实现 了 芯片 化 ， 接入 设备 比较 便宜 。 目前 市场 上 此类 芯片 有 LM 国家 半导体 、 STSGSThomson 公司 、 SSCPIntellon 公司 等 。 　 　 美国 ElectronicIndustriesAssociation 于 年 正式 发布 了 针对 家庭 的 电器 联网 标准 CEBus 消费 电子 总线 、 家庭 总线 ， 编号 EIA ； 后 又 经过 若干次 修改 ， 并 一直 受到 EIA 的 下属 组织 ConsumerElectronicsManufacturesAssociation 的 大力推广 。 CEBus 已获 AmericanNationalStandardsInstitute 承认 。 　 　 下面 先 简要 介绍 CEBus ， 再 从 硬件 和 策略 两个 角度 提出 改进 思路 。 下文 的 设备 指 具有 CEBus 接口 的 家电 。 CEBus 简介 　 　 CEBus 是 参考 ISO 的 OSI 七层 模型 设计 的 ， 其 基本 架构 和 主要 原语 在 图 中示 出 ， 可 看出 它 比 OSI 模型 要 简单 得 多 ， 但 未来 有 可能 增加 传输层 ， 实际上 ， CEBus 的 设计者 考虑 了 多种 媒体 ， 包括 电力线 、 红外线 、 无线电 、 双绞线 、 同轴电缆 乃至 光纤 。 本文 的 重点 在于 电力线 PL 。 　 　 MDP 子层 负责 往 电力线 上 发送 信号 ， 该子层 还 不间断 地 侦听 电力线 的 状态 。 如果 电力线 上 有 载波 ， 就 说明 电力线 处于 S 状态 ， 否则 就 处于 I 状态 。 显然 ， 只要 有 一台 设备 试图 使 电力线 处于 S 态 发送 载波 ， 整条 电力线 就 处于 S 态 。 载波 的 频率 范围 是 K 到 K 。 SE 子层 用 原语 MSTATErequest 通知 MDP 子层 发送 或 不 发送 载波 ， 而 MDP 用 MSTATEindication 报告 SE 电力线 的 状态 。 假设 MDP 在 不 发送 载波 时 发现 电力线 处于 S 态 侦听 到 别人 的 载波 ， 它会 立刻 拒绝 SE 要 它 发送 载波 的 请求 。 图 CEBus 的 架构 和 主要 原谱 　 　 编解码 工作 是 在 SE 子层 实现 的 。 CEBus 标准规定 ， 当 媒体 是 电力线 时 ， SE 子层 还要 能够 查错 。 CEBus 采用 NRZ 编码 体制 ， 用 脉冲 宽度 表示 信号 。 种 信号 及其 脉冲 宽度 是 ： UST ， UST ， EOFUST ， EOPUST 。 EOF 即 EndofField ， EOP 即 EndofPocket 。 UST 即 UnitSymbolTime ， 是 编码 和 解码 的 计时 基准 ， 由 SE 子层 给出 。 个 UST 在 微秒 左右 。 MAC 子层 用 PHCCDATArequest 命令 SE 发出 种 信号 中 的 一种 。 但是 ， 如果 侦听 到 别人 的 载波 ， 则 SE 用 PHCCSTATUSindication 向 MAC 报告 CHANNELACTIVE ， 并且 等 解码 成功 以后 用 PHCCDATAindication 报告 别人 发出 的 信号 。 　 　 CEBus 要求 收到 的 包 的 正确率 达到 。 整个 物理层 的 功能 已经 芯片 化 ， 某些 芯片 还 包括 了 数据 链路层 的 功能 。 　 　 MAC 子层 提供 带 或 不带 应答 的 无 连接 数据 传送 服务 。 如 SE 不 负责 查错 ， 则 MAC 承担 查错 任务 。 MAC 还要 生成 包 的 控制 域 ， 以 标明 包 的 类型 、 优先级 、 服务 级别 和 序列号 。 优先级 分级 ， 高级 专门 用于 与 人 交互 的 进程 和 开环 控制 的 进程 ， 其他 进程 为 中 或 低级 。 　 　 LLC 子层 是 个 空壳 ， 只 转发 命令 ， 无 实质性 工作 。 　 　 网络层 负责 路由 、 路桥 brouter 、 确定 网址 、 流量 控制 、 给 数据 分段 、 丢弃 无线 媒体 收到 的 重复 包等 。 由于 网络层 已 超然 于 媒体 之上 ， 所以 要 考虑 信息 的 跨媒体 传输 问题 。 　 　 应用层 可以 通过 原语 向 网络层 指明 ： 优先级 、 是否 需要 应答 、 是否 有 网址 、 是否 使用 流量 控制 、 路由 方式 、 允许 在 什么 媒体 上 传输 、 是否 使用 路桥 以及 路桥 的 网址 等等 。 　 　 由于 CEBus 覆盖 了 家庭 中 的 一切 传输媒体 ， 所以 有 路桥 的 概念 。 路桥 指能 在 无线 媒体 红外线 或 射频 与 有线 媒体 电力线 、 同轴电缆 、 双绞线 或 光纤 之间 转发 包 的 设备 。 一台 内 藏 微控制器 、 配备 CEBus 软件 的 电视 是 红外线 和 电力线 之间 的 路桥 ， 因为 它 和 电力线 相连 ， 同时 还 使用 红外 遥控器 。 一台 类似 的 无绳电话 则 是 无线电 、 电力线 和 双绞线 之间 的 路桥 。 跨媒体 传输 提高 了 网络 的 健壮性 和 灵活性 ， 同时 也 使 生活 空前 方便 。 例如 ， 电视 购物 时 可用 电视 遥控器 发出 指令 ， 经 红外线 、 电力线 到 家用 PC ， 再 由 PC 通过 互连网 发出 购物 信息 ， 或 在 院子 里 用 无绳电话 经过 射频 、 电力线 打开 空调 。 NPDU 中 可 包含 两个 路桥 的 网址 ， 配合 允许 在 什么 媒体 上 传输 选项 ， 为 跨媒体 传输 提供 了 足够 的 灵活性 。 　 　 路由 方式 有 洪水 路由 floodrouting 和 目录 路由 directoryrouting 两种 。 　 　 洪水 路由 ： 包向 任何 一个 可能 的 地方 转发 ， 但 受 前述 媒体 和 路桥 的 限制 。 　 　 目录 路由 ： 包仅 被 位于 传输 路径 上 的 路由器 转发 。 任何 一个 设备 ， 当 它 上 电 或 改动 网址 时 ， 都 要 发出 一个 ID 包以 声明 自己 的 新网址 。 该 ID 包将 传遍 网络 ， 帮助 路由器 更新 各自 的 路由表 。 如果 路由器 在 转发 一个包 时 ， 发现自己 的 路由表 中 没有 该包 的 目的 网址 ， 它 就 通过 设置 一个 标志 位 ， 把 该 包 变为 ID 需求 包 然后 转发 。 目的 网址 收到 ID 需求 包后 ， 要 发出 一个 ID 包 。 所以 路由器 的 设置 是 全自动 的 。 　 　 CEBus 在 防止 碰撞 方面 的 策略 基本 是 ： 发送 前如 发现 电力线 处于 S 态 ， 则 推迟 发送 直至 侦听 到 EOP 。 侦听 到 EOP 以后 ， 再 等 个 UST 以防 应答 和 重传 。 这个 UST 之后 ， 高 优先级 的 包 再 随机 等待 到 个 UST 后 开始 发送 ； 中 优先级 的 包 等待 到 个 UST ； 低优先级 的 包 等待 到 个 UST 。 每个 包 的 开头 是 随机 生成 的 位 二进制码 ， 用来 让 其他 电器 探测 到 S 态 ， 达到 争取 信道 的 目的 。 此外 ， 如某 设备 刚刚 成功 地 发送 了 一个包 ， 它 在 下次 发送 前 还 会 额外 再 等 个 UST 。 最后 ， 发生 碰撞 时 ， 试图 使 电力线 处于 I 态 的 设备 发现 电力线 是 S 态 ， 它会 自动 停止 ， 等 别人 发完 了 再 重发 。 　 　 由于 电力线 的 传输 质量 较差 ， 为 保证 收到 可能 要 重复 发 若干次 。 这时 凭 序列号 会 丢弃 重复 收到 的 包 。 　 　 应用层 通过 CALCommonApplicationLanguage 和 应用程序 连接 。 CAL 是 CEBus 专为 设备 之间 相互 通信 而 设计 的 面向对象 语言 。 网络资源 的 分配 和 控制 也 通过 CAL 完成 。 在 目前 的 CEBus 标准 中 只有 一个 信道 controlchannel ， 将来 可能 要 增加 个 或 几个 datachannel ， 届时 资源分配 将 复杂 起来 。 　 　 由于 家庭 中 很多 地方 是 控制 工作 的 ， 所以 CAL 中 安排 了 一种 安全 机制 ： 一台 设备 可以 验证 另一台 设备 的 身份 。 有 两种 验证 方式 ， 一是 握手 式 验证 ： 设 E 是 加密 函数 ， S 是 和 设备 甲 有关 的 常量 ， S 是 和 设备 乙 有关 的 常量 。 S 、 S 可以 是 设备 标号 、 类型 代码 等 。 甲 产生 随机数 R ， 把 XES ， R 放在 ChallengeRequest 类型 的 包里 传给 乙 ， 即甲 向 乙 挑战 或 质疑 。 乙求 出 AESX 、 BES ， A ， 把 B 放在 AuthenticateResponse 包里 传给 甲 应战 或 答疑 。 甲求 出 YESB ， 如果 YR ， 则 乙 的 资格 得到 确认 。 二是 不 握手 验证 。 E 、 S 如上所述 ， R 是 一个 双方 都 知道 的 变量 ， 如 时间 。 乙向 甲 发出 XES ， R ， 甲求 出 AESX ， 如 AR ， 则 乙 被 确认 。 一般 说 ， 仅 当乙要 对 甲 做 某些 敏感 控制 时 ， 甲才 会 去 验证 乙 的 身份 ， 并 于 验证 成功 后 执行 乙在 验证 前 发出 的 控制指令 ， 即先 指示 ， 后 验证 ， 再 执行 。 　 　 智能化 住宅 的 服务器 无疑 是 家用 PC 。 CAL 的 面向对象 特性 使 CAL 很 容易 在 PC 上 应用 。 但是 ， 对于 分布 在 家庭 各个 角落 的 微控制器 来说 ， CAL 不 实用 。 考虑 到 PC 数量 远 少于 微控制器 ， 并且 PC 使用 高级 语言 、 又 有 CAL 支持 ， 而 微控制器 主要 使用 汇编语言 、 多为 实时控制 、 目前 还 没有 单片机 支持 CEBus ， 就 得到 结论 ： 智能化 住宅 软件开发 的 重点 和 难点 是 在 微控制器 上 ， 微控制器 程序员 完全 可以 抛开 应用层 ， 在 较 低层次 上 介入 CEBus 体系 。 为了 提高 微控制器 软件开发 、 维护 效率 及 可靠性 ， 需要 专 为 微控制器 设计 的 实时 多任务 操作系统 。 如 FDCX 、 FRMX 等 。 对 CEBus 的 改进 　 　 图示 出 了 根据 CEBus 构造 智能化 住宅 的 大体 情况 。 图 家用 PL 网 的 拓扑 　 　 对 电力线 载波 影响 最大 的 干扰 是 PC机 等 使用 的 开关电源 ， 其 噪声 覆盖 了 载波 频段 。 对策 是 使用 小而 便宜 的 阻波器 ， 开关电源 通过 它 与 电力线 相连 ， 如图 。 这 就 可以 消除 开关电源 的 干扰 。 当然 ， 实际 应用 中 可能 仅 部分 开关电源 使用 了 阻波器 ， 再 考虑 到 电器 随意 开关 ， 所以 线路 质量 不 稳定 。 图阻 波器 的 使用 　 　 主张 在 入户 电表 上 也 安装 阻波器 ， 把 家庭 内部 的 PL 网 与 外面 相 隔离 。 内部 的 PL 网 走私 人 信息 ， 外部 的 PL 网走 公共信息 ， 例如 每户 家庭 的 耗电量 、 用水量 、 整个 大楼 的 安全 信息 、 中央空调 的 控制 信息 等 ， 从而 提高 健壮性 、 保密性 信息 无法 在 外界 和 家庭 内部 之间 传递 ， 同时 也 降低 网络 负载 。 主人 可用 电话 、 互连网 从 外面 访问 家里 的 PL 网 。 　 　 如何 保证 包 在 电力线 上 可靠 地 传输 ， 这 在 CEBus 中 只 简单 地 提到 两点 ： 物理层 要 保证 收到 的 包 的 正确率 达 ； 发送 方 重复 发送 。 这 实际上 限制 了 CEBus 网络 的 规模 ， 如果 网络 较大 就 不 实用 了 。 家用 电力线 载波 网 的 应用环境 的 特点 是 由 不 懂 计算机 的 大众 使用 ， 家电 的 布置 非常 随意 且 经常 变动 ， 而且 还要 一定 的 可靠性 。 所以 ， 提出 用 随机 转发 方法 ， 不要 路由器 ， 任何 一台 设备 都 负责 转发 包 ， 保证 包 传遍 PL 网 ， 从而 实现 了 方便性 用户 不 需要 任何 计算机 知识 ， 可 随意 改动 电器 布置 和 可靠性 保证 收到 每 一个包 。 代价 是 降低 了 带宽 利用率 ， 好 在 家电 的 信息量 本来 就 很小 。 　 　 方法 是 ： 每 一个包 都 有 一个 生命力 域 ， 记其值 为 A 。 当某 设备 甲要 发送 包时 ， 它 给 A 赋 初值 ， 某台 设备 乙 收到 该包 ， 如果 乙 就是 包 的 目的地 ， 那么 乙 可能 发 或 不发 应答 包 ； 如果 乙 不是 目的地 ， 且 从 序列号 判断 该包 不 在 自己 的 缓冲区 里 ， 且 A ， 则 把 包 放在 缓冲区 里 ， A 减 ， 等待 随机 时间 后 发送 包 ； 如果 乙 不是 目的地 ， 且 从 序列号 判断 该包 已经 在 自己 的 缓冲区 里 ， 且 该 包 的 生命力 为 A ， 则 把 缓冲区 里 包 的 生命力 值 改为 A 和 A 中较 小 的 ， 若 新 的 生命力 值 ， 则 再 等待 随机 时间 后 发送 包 ， 否则 从 缓冲区 中 删去 该包 ； 如果 乙 发现自己 收到 的 是 一个 应答 包 ， 且 该 包所要 应答 的 包 P 正在 自己 的 缓冲区 里 ， 则 从 缓冲区 中 删掉 P 。 图 给出 了 工作 流程 和 数据结构 。 在 后面 的 改进 方案 中 ， 要 在 该 图 中 的 ＠ 处 插入 一个 操作 。 图 随机 转发 方法 的 流程 和 数据结构 　 　 该 方法 的 合理性 在于 它 所 依赖 的 不是 整个 PL 网上 的 质量 M ， 而是 相邻 两台 设备 之间 的 传输 质量 m 。 M 是 某 设备 能 正确 地 收到 网上 任何 一台 设备 发出 的 包 的 概率 ， CEBus 要求 M 达到 。 m 是 某 设备 正确 地 收到 与 它 相邻 的 设备 发出 的 包 的 概率 。 根据 实验 ， 不论 接入 PL 网 的 设备 多少 ， 只要 适当 用 阻波器 排除 干扰 ， 传送 距离 对 m 的 影响 就 很小 。 从而 传输 可靠性 就 比较稳定 。 当然 ， M 对 传输速度 还是 有 影响 的 。 　 　 该 方法 要求 较大 的 缓冲区 ， 这 对 目前 的 位 微控制器 来说 不成问题 。 　 　 该 方法 使 所有 设备 的 通信 规程 都 一样 ， 便于 芯片 化 ， 节省 CPU ， 降低 软件开发 成本 ， 方便 开发者 和 最终用户 。 　 　 随机 转发 方法 的 缺点 是 显然 的 。 如图所示 ， 假设 有 n 个 相邻 的 设备 都 收到 了 一个包 ， 那么 在 下 一次 转发 中包 到达 距离 为 k 跳 的 设备 A 的 概率 是 ： 图 随机 转发 的 缺点 　 　 　 　 　 　 　 　 　 　 　 当 k 恒定 时 ， P 是 n 的 单调 减 函数 。 这 是因为 离 A 较远 的 设备 会 和 离 A 近 的 设备 争夺 转发 包 的 机会 。 　 　 克服 上面 缺点 的 思路 是 改进 硬件 ， 使 它 能 测量 接收 包 时刻 的 通信 质量 。 当 质量 较 高时 ， 就 认为 该 包能 顺利 到达 下 一个 设备 ， 于是 就 不 转发 。 这样 ， 当某 设备 发送 一个包 时 ， 在 所有 能 正确 接收 该包 的 设备 中 ， 仅 通信 质量 较差 的 设备 才能 转发 。 通信 质量 用 误码率 衡量 。 实际上 ， SSCP 中 就 有 查错 功能 ， 只是 没 提供 给 外界 而已 。 改进 后 的 转发 策略 是 在 图 的 处 增加 判断 ， 如该 包 的 误码率 低于 阈值 ， 中断 返回 ， 否则 继续 。 　 　 已经 研究 出 的 低频 载波 技术 允许 信号 在 电力线 上 传输 很远 的 距离 ， 甚至 能 穿过 变压器 ， 非常 可靠 。 可以 在 电力线 上 同时 使用 高频 和 低频 信号 ， 用 低频 信号 完成 网络 配置 和 转发 调度 工作 。 两者 取长补短 ， 可 大大提高 网络 性能 。 另外 ， AdaptiveNetwork 公司 正在 研究 速率 达 K 的 电力线 载波 技术 。 建议 应 给予 足够 的 重视 。 作者 单位 ： 复旦大学 计算机系 微机 实验室 ， 上海 参考文献 ElectronicIndustriesAssociationEIA ， AndrewSTComputerNetworks ， PrenticeHall 涂时亮 ， 张友德 单片微 机 控制技术 上海 ： 复旦大学 出版社 ， 普罗 基斯 约翰 G 著齐 怀亮 译 数字通信 北京 ： 电子 工业 出版社 ，