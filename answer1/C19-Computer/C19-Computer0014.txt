计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNoPowerBuilder 的 若干 公用 对象 设计 李 振华 　 吕国斌 　 墙芳躅 　 　 摘 　 要 　 在 PowerBuilder 开发 过程 中 ， 将 常用 操作 做成 公用 对象 ， 并 存入 公用 库 （ pbl ） 中 ， 这种 设计 方法 有利于 提高 程序 的 可 重用 性 和 可维护性 。 设计 公用 对象 的 一种 方法 及其 设计 实例 在 本文 中作 了 探讨 。 　 　 关键词 　 PowerBuilder ， 公用 对象 ， 公用 库 引言 　 　 PowerBuilder 作为 主要 的 数据库 前台 开发 语言 ， 已 得到 了 广泛 的 应用 。 但 在 实际 的 开发 过程 中 ， 特别 是 在 大型 的 开发 项目 中 ， 某些 操作 总会 多处 重复 出现 ， 比如 查询 、 打印 等 操作 ， 几乎 在 每 一个 窗口 里 都 会 出现 。 如果 每 出现 一次 这样 操作 都 相应 的 为 其 写 一次 程序 的话 ， 那么 ， 这些 不同 窗口 中 的 程序 是 相似 的 甚至 是 重复 的 ， 这 既 增加 了 程序 的 编写 工作量 ， 又 增加 了 程序 的 维护 工作量 。 一种 可行 的 方法 是 将 这些 常用 操作 做成 公用 对象 ， 并 存入 公用 库 （ pbl ） 中 ， 这样 ， 在 程序设计 时 便 可 直接 地 调用 或 使用 这些 对象 。 这种 做法 既 提高 了 程序 的 可 重用 性 和 程序编制 效率 ， 又 提高 了 程序 的 可维护性 。 　 设计 思想 　 　 公用 对象 的 设计 难点 在于 其 通用性 的 设计 ： 能 普适 几乎 所有 的 操作 要求 ， 同时 其 程序设计 又 必须 保持 独立 。 本文 所 提出 的 方法 是 采用 参数传递 ： 公用 对象 只 针对 入口 参数 进行 设计 ， 使用 或 调用 公用 对象 时 再 向 其 传入 具体 的 参数 ， 这样 ， 公用 对象 的 设计 便 可 与 具体 的 应用 设计 相互 独立 。 当然 ， 采用 此种 方法 ， 设计 的 关键 就 在于 传递 参数 的 选择 及其 处理 。 　 几个 设计 实例 　 　 以下 将要 讨论 的 几个 公用 对象 按 其 性质 可以 分为 两类 ： 窗口 和 自定义 控件 。 相应 的 ， 它们 的 使用 方式 也 不 相同 ， 公用 窗口 需带 参数 的 调用 ； 而 控件 则 可 直接 在 父 窗口 中 被 使用 。 以下 分述 之 。 　 窗口 类 　 查询 窗口 　 　 查询 窗口 的 设计 流程 是 ： 在 获取 了 被 查询 数据 窗口 的 有关 参数 后 ， 即弹 出本 窗口 ， 由 用户 在 本 窗口 中 构造 出 检索 表达式 （ 或称 条件 表达式 ， 同 where 子句 ） ， 并 将 此 表达式 回送 原 数据 窗口 进行 过滤 ， 并 在 原 数据 窗口 中 得到 用户 所 需 的 查询 结果 。 　 　 在 使用 查询 窗口 前 ， 需 知道 被 查询 窗口 的 有关 参数 。 因此 须 先 定义 一 公用 函数 ， 以 获取数据 窗口 的 有关 参数 。 　 　 数据 窗口 参数 获取 函数 　 　 本 函数 获取数据 窗口 以下 参数 ： 所有 的 字段名 及其 数据类型 和 标识 。 　 　 定义 如下 　 　 入口 参数 ： 数据 窗口 控件 名 （ 类型 Reference ） 。 返回值 ： 字符串 。 　 　 设计 步骤 如下 限于 篇幅 ， 仅 给出 关键 的 实现 语句 ： 　 　 ① 得到 数据 窗口 中字段 个数 。 i — ColCountIntegerdw — Describe ′ DataWindowColumnCount ′ ZK 〗 　 　 其中 dw — 为 欲 检索 的 数据 窗口 对象 。 　 　 ② 建立 循环 ， 以 第步 得到 的 字 段 个数 为 循环 次数 ， 依次 得到 数据 窗口 中 每个 字段 的 字段名 及其 数据类型 和 标识 ， 并 将 它们 存入 字符串 中 。 　 　 相关 语句 如下 ： 　 　 取 字段名 ： s — ColNamedw — Describe ′ ′ Stringi ′ name ′ 　 　 取字 段 类型 ： s — ColTypedw — Describe ′ ′ Stringi ′ coltype ′ 　 　 取字 段 标识 ： s — ColTextdw — Describes — ColName ′ — t ′ ′ text ′ 说明 ： 在 生成 数据 窗口 时 ， 系统 缺省 地 将 字 段 标识 的 名字 定为 字段名 ′ — t ′ 　 　 上述 语句 中 的 dw — 为 入口 参数 ， i 是 指 第几个 字 段 。 　 　 ③ 返回 此 字符串 。 　 　 查询 窗口 　 　 定义 如下 　 　 入口 参数 ： 字符串 （ 系 上述 公用 函数 返回 结果 ） 。 返回值 ： 字符串 （ 即 检索 表达式 ） 。 　 　 窗口 中 主要 控件 为 一 数据 窗口 和 一 命令 钮 （ 见图 ） 。 图 　 公用 查询 窗口 示例 　 　 数据 窗口 控件 用于 构造 检索 表达式 ， 它 对应 的 数据 窗口 对象 以 入口 参数 （ 即原 数据 窗口 有关 参数 ） 为 数据源 （ 其 数据源 设计 为 外部 （ External ） ） ， 其 结果 集 （ ResultSet ） 由 以下 四项 组成 ： 　 　 ① 字 段 标识 — — 由 入口 参数 提供 ， 在 窗口 open 事件 中 生成 ， 编辑 形式 为 下 拉 列表框 ， 其 显示 值 （ DisplayValue ） 对应 于 入口 参数 中 s — ColText ， 其 数据 值 （ DataValue ） 对应 于 入口 参数 中 s — ColName 。 　 　 ② 检索 符 — — 关系 运算符 ， 编辑 形式 为 下 拉 列表框 。 　 　 ③ 检索 值 — — 此项 由 用户 填入 。 　 　 ④ 逻辑 符 — — 与 或 符 ， 编辑 形式 为 下 拉 列表框 。 　 　 命令 钮则 根据 数据 窗口 的 用户 操作 结果 ， 生成 一 字符串 （ 即 检索 表达式 ） 并 返回 。 　 　 有关 的 程序设计 主要 有 ： 　 　 本 窗口 open 事件 ： 　 　 ① 获取 传入 的 参数 。 并 将 它们 传入 数据 窗口 标识 字段 的 编辑 形式 中 。 dw — Modify ′ values ′ MessageStringParm ′ ′ 　 　 注意 传入 参数 MessageStringParm 须 符合 编辑 形式 的 定义 格式 。 ② 如 第步 操作 无误 ， 则 在 数据 窗口 是 插入 一 空行 ， 等待 用户 的 输入 。 　 　 数据 窗口 的 itemchanged 事件 ： 当 数据 窗口 中 当前 行 的 所有 列 都 填满 时 自动 插入 一行 ， 等待 用户 下 一行 的 输入 （ 程序 略 ） 。 　 　 命令 钮 clicked 事件 ： 　 　 ③ 删除 空行 。 　 　 ④ 计算 当前 数据 窗口 中行 数 。 如为 空 ， 则 返回 空值 。 否则 以 数据 窗口 中行 数为 循环 次数 ， 依次 取 字段名 ， 检索 符 ， 检索 值 （ 并 根据 其字段 类型 决定 其 表示 形式 ） ， 逻辑 符 ， 并 将 以上 各项 存入 字符串 中 返回 。 此 返回 的 字符串 即 为 所 需 的 检索 表达式 。 　 打印 预览 窗口 　 　 本 窗口 对 数据 窗口 如下 参数 作 定义 ： 边界 、 纸张 尺寸 、 打印 方向 、 预览 缩放 比例 ， 并作 相应 输出 。 　 　 定义 如下 ： 　 　 入口 参数 ： 数据 窗口 对象 　 　 　 返回值 ： 无 　 　 窗口 除 数据 窗口 控件 外 ， 其余 主要 的 控件 可 分为 两类 ： 参数设置 类 、 操作 类 。 　 　 数据 窗口 是 原 数据 窗口 的 一个 拷贝 。 本 窗口 的 所有 操作 都 是 针对 此 拷贝 数据 窗口 进行 。 不 直接 对原 数据 窗口 进行 操作 也 是 基于 通用性 的 考虑 。 　 　 参数设置 类 控件 一般 为 单行 编辑框 或 下拉式 列表框 ， 供 用户 设置 打印 参数 。 　 　 操作 类 控件 一般 为 命令 钮 或 检查 框 。 　 　 有关 的 程序设计 主要 有 ： 　 　 本 窗口 的 open 事件 ： 　 　 ① 取 入口 参数 ， 并 据此 产生 本 数据 窗口 数据源 。 　 　 dw — Createdw — sourceObjectDataWindowSyntax 其中 dw — source 为原 数据 窗口 　 　 ② 取本 窗口 中 数据 窗口 有关 打印 参数 ， 并 将 它们 填入 相应 的 控件 中 。 有关 参数 有 ： 边界 、 纸张 尺寸 、 打印 方向 、 页数 。 图 　 公用 打印 预览 窗口 示例 　 　 以取 边界 参数 为例 ： 　 　 取上 边界值 em — toptextdw — ObjectDataWindowPrintMarginTop 取 边界 参数 单位 st — topunittext ′ PBU ′ （ 据 取得 单位 程序 ′ ′ ， ′ ′ ， ′ ′ ， ′ ′ 相应 地 给 ′ pbu ′ ， ′ pxl ′ ， ′ in ′ ， ′ cm ′ 值 ） 　 　 虽然 每个 参数 都 要 进行 设置 ， 但 它们 的 操作步骤 是 相同 的 ： 　 　 ① 参数设置 。 用 Modify 函数 实现 。 　 　 以 边界 参数设置 为例 ： 　 dw — Modifydatawindowprintmargintopem — toptextdatawindowprintmarginbottomem — bottomtextdatawindowprintmarginleftem — lefttextdatawindowprintmarginrightem — righttext 　 　 ② 重新 计算 页数 。 如 当前 数据 窗口 已 在 预览 状态 下 ， 则 直接 计算 出 。 否则 须 改变 数据 窗口 至 预览 览 态下 计算 ， 计算 毕 ， 再 改变 回原 状态 。 　 　 计算 页数 ： i — Countdw — DescribeEvaluate ′ PageCount ′ 　 　 改变 至 预览 状态 ： 　 　 dw — Modifydatawindowprintpreviewyes 　 　 至于 打印 操作 ， 可 另 建一 公用 打印 窗口 ， 用于 设置 打印 选项 ， 如 打印 范围 、 打印 方式 （ 分奇 、 偶数 ） 、 自动 分页 、 打印 份数 、 打印 定向 （ 到 文件 或 打印机 ） 等 。 限于 篇幅 ， 不再 赘述 。 　 　 要 说明 的 是 ， 上述 只是 常用 的 公用 窗口 两个 特例 ， 参照 以上 方法 ， 可以 建立 其它 的 公用 窗口 。 　 控件 　 　 插入 、 删除 、 保存 等 也 是 数据 窗口 经常 要 使用 的 操作 。 用 自定义 控件 实现 这些 操作 是 一种 可行 的 方法 。 用 以下 方法 设计 的 自定义 控件 ， 可 在 父 窗口 中 直接 被 使用 。 　 　 以 删除 操作 为例 进行 说明 ， 其余 操作 的 设计 方法 与 此 类似 。 删除 操作 的 完整 脚本 如下 ： 　 注意 ： 本 自定义 对象 的 设计 只 针对 父 窗口 中 只有 一个 数据 窗口 的 情形 如父 窗口 有 多个 数据 窗口 则 选取 排序 最靠 前 的 数据 窗口 作为 操作 对象 Windoww — ParentGraphicObjectgb — WhichControlDataWindowdw — Hereintegeri — Countiw — ParentPARENTi — CountUpperBoundw — ParentControl ［ ］ 依次 寻找 当前 窗口 中 的 所有 控件 ， 直到 找到 数据 窗口 FORiTOi — Countgb — WhichControlw — ParentControl ［ i ］ CHOOSECASETypeOfgb — WhichControlCASEDataWindowdw — Heregb — WhichControlEXITENDCHOOSENEXT 删除 操作 dw — HereDeleteRow 　 　 这 段程序 中 ， 真正 执行 删除 操作 的 语句 只 涉及 最后 一行 ， 其余 的 程序 都 是 针对 通用性 所 进行 的 设计 。 　 　 以上 讨论 了 两类 公用 对象 ： 窗口 类 和 控件 类 。 当然 ， 这 两类 公用 对象 在 设计 时 也 可以 互相 包含 ， 公用 窗口 中 可以 直接 使用 公用 控件 ， 反过来 ， 公用 控件 也 可以 调用 公用 窗口 。 　 结语 　 　 将 常用 操作 做成 公用 对象 放入 公用 库中 ， 在 设计 时 直接 调用 或 使用 它们 ， 是 一种 有效率 和 可维护性 好 的 设计 方法 ， 在 大型 开发 项目 中 ， 这种 设计 方法 的 优越性 更为 明显 。 在 本文 中 ， 为 保证 公用 对象 的 通用性 ， 采取 了 参数传递 的 方法 。 当然 ， 为了 获得 通用性 ， 牺牲 了 一定 程序运行 效率 。 　 　 在 程序编制 和 撰写 本文 的 过程 中 ， 得到 了 武汉 菲旺 电子科技 有限公司 的 大力 帮助 ， 在 此 深表谢意 ！ 作者简介 ： 李 振华 　 讲师 。 吕国斌 　 副教授 。 墙芳躅 　 教授 。 均 从事 计算机网络 及 应用 的 教学 与 科研 。 作者 单位 ： 中国地质大学 网络 中心 　 湖北 武汉 （ 参考文献 ［ ］ 　 BiberdorfD 著 PowerBuilder 开发人员 指南 陈向 群译 北京 ： 机械 工业 出版社 ， 收稿 日期 修改稿