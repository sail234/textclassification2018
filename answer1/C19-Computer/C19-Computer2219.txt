计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERSVolNoP 一种 基于 ISAPI 扩展 的 安全 验证 方法 陈晓苏 　 张涛 　 肖道 举摘 　 要 ： 分析 了 HTTP 基本 验证 、 NT 安全 模型 以及 IIS 的 用户 安全 机制 ， 讨论 了 它们 在 用户 安全 验证 中 存在 的 问题 和 改进 的 设想 ， 并 给出 了 一种 基于 ISAPI 扩展 的 安全 验证 方法 。 关键词 ： NTIIS 安全 验证 ISAPI 扩展 　 引言 　 　 由于 企业 管理 的 需要 ， 越来越 多 的 企业 构建 基于 WindowsNT 的 内 联网 Intranet ， 并 建立 自己 的 Web 网站 ， 以 主页 的 形式 发布 企业 信息 。 为了 合理 的 管理 和 利用 大量 的 已有 信息 ， 不少 企业 将 Web 与 数据库 管理系统 相结合 ， 开发 开放性 的 Web 应用 系统 ， 提供 面向 Web 的 交互式 数据库 访问 平台 。 基于 这种 应用 特征 ， 如何 保证系统 的 安全 运行 环境 ， 如 操作系统 、 Web 服务器 和 数据库系统 的 安全 等 ， 就 显得 十分 重要 。 　 　 本文 从 分析 HTTP 基本 验证 机制 入手 ， 考察 WindowsNT 与 IIS 的 用户注册 和 身份验证 的 过程 ， 讨论 了 它们 在 维护 网络安全 方面 存在 的 缺陷 ， 特别 对于 访问 WindowsNT 网址 的 用户 增多 造成 其 安全 验证 性能 迅速 下降 ， 以及 IIS 无法 支持 第三方 安全 数据库 等 方面 问题 进行 了 深入 地 剖析 。 为 解决 上述 缺陷 ， 给出 了 基于 ISAPI 扩展 的 安全 验证 方法 ， 以 代替 IIS 缺省 的 网络 安全性 检验 。 　 HTTP 规范 的 基本 验证 机制 　 HTTP 的 验证 进程 　 　 HTTP 标准协议 中 定义 了 一个 简单 、 灵活 、 可 扩展 的 ChallengeResponse 进程 来 验证 用户 的 身份 。 在 匿名 用户 请求 受限 的 资源 之前 ， 用户 一直 保持 匿名 状态 ， 直到 匿名 用户 请求 安全 资源 时 ， 验证 进程 开始 。 服务器 将 产生 一个 标准 的 HTTP “ Accessdenied ” 消息 ， 响应 远程 浏览器 ， 通知 请求 被 拒绝 。 由于 HTTP 是 无 状态 的 协议 ， 服务器 不 跟踪 初始 请求 中 所 指定 的 资源 ， 要求 浏览器 重新 形成 安全 凭证 并 再次 提交 请求 。 在 重新 提交 的 请求 中 附加 包含 请求 头部 “ Authorization ” ， 其后 包含 已 编码 的 凭证 和 用于 编码 凭证 的 验证 方案 的 名字 。 验证 请求 提交 后 ， 服务器 在 请求 中 找到 Authorization 头部 ， 并 使用 凭证 记录 来 确定 用户 的 身份 。 验证 的 结果 可能 是 请求 被 拒绝 ， 要求 浏览器 再次 提交 新 的 凭证 提交 的 次数 根据 浏览器 而定 ； 可能 提供 的 新 凭证 是 合法 的 ， 服务器返回 所 请求 资源 。 　 HTTP 的 验证 方案 　 　 验证 方案 是 用于 从 浏览器 传送 安全 凭证 到 服务器 的 机制 。 HTTP 规范 中 验证 方案 通常 有 两种 ， 即 基本 验证 方案 和 NTLN 方案 。 　 　 基本 验证 方案 　 　 该 方案 被 大多数 Internet 服务器 支持 ， 实现 跨 网络 传输 用户名 和 口令 的 编码 。 服务器 通过 在 响应 头 中 包括 如 ： WWWAuthenticate ： Basicreaml “ localhost ” 的 验证 记录 来 表明 它 支持 该 验证 方案 。 另外 ， 基本 验证 方案 请求 中 的 授权 记录 包含 有 检查 编码 凭证 的 方案 名字 ， 如 ： Authorization ： BasiccrbWMeHh 用户 验证 记录 的 MIMEBasic 格式 编码 。 由于 基本 验证 方案 对 传输 的 数据 只是 进行 编码 而 未 加密 ， 因此 基本 验证 方案 只能 是 一种 认定 用户 的 方法 ， 不能 实现 真正 的 网址 安全 保护 。 　 　 NTLN 验证 方案 　 　 该 方案 由 IIS 和 InternetExplorer 实现 ， 完成 从 操作系统 用户 登录 数据库 中 获取 工作站 注册 凭证 ， 以此 作为 服务器 的 安全 凭证 。 该 方案 仅 在 NT 或 LANManager 网络 中 使用 。 　 WindowsNT 的 安全 模型 与 IIS 的 安全 环境 　 　 在 WindowsNT 中 ， 验证 实际上 是 WWW 用户 的 NT 登录 进程 。 一个 服务 是 任何 登录 用户 独立 运行 的 一个 程序 一般 为 后台 进程 。 常见 的 服务 包括 ： 　 　 登录 服务 ： 处理 Client 登录 请求 ， 对 用户 进行 认证 。 　 　 DNSServer ： 处理 Internet 域名 解释 。 　 　 远程 过程 调用 服务 ： 处理 ClientRPC 请求 ， 并 将 它们 映射 到 已 注册 的 RPCServer 上 。 　 　 WindowsNT 的 名字 库是 NT 用户 管理器 中 定义 的 一系列 用户 ， 每个 记录 中 的 用户名 和 口令 用于 WindowsNT 登录 ， 以 验证 用户 访问 NT 的 身份 。 由于 WindowsNT 的 用户名 和 口令 以 一种 易于 解码 的 形式 传递 ， 因而 从 严格 地 意义 上 讲 ， NT 用户 身份验证 也 不能 实现 真正 的 网址 安全 保护 。 IIS 系统 中 的 安全 通过 使用 标准 WindowsNT 访问 权限 来 管理 。 用户 在 服务器 上 检索 资源 的 权利 是 通过 检查 WindowsNT 用户 的 访问 权限 来 确定 。 　 　 IIS 认证 Client 请求 有 三种 方法 ： 匿名 注册 、 基本 验证 、 WindowsNT 询问 响应 认证 。 匿名 认证 设置 透明 的 用户名 和 密码 ， 允许 匿名 用户 访问 一定 的 资源 。 当 匿名 用户 请求 其它 网络资源 时 ， Server 启动 后 两种 认证 方式 中 的 一种 。 根据 对 HTTP 基本 验证 的 分析 ， 由于 用户名 和 密码 采用 MIMEBasic 编码 ， 以 可见 的 明文 传输 ， 因而 采用 基本 认证 会 对 IIS 的 安全性 带来 潜在 的 危险 。 当 IIS 采用 WindowsNT 询问 响应 认证 时 ， IIS 从 WindowsNT 的 名字 库中 获取 Client 的 注册 凭证 。 但是 必须 看到 ， 当 大量 的 网络 用户 访问 NT 网站 时 ， 由于 WindowsNT 本身 的 局限性 ， 其 安全 验证 性能 会 显著 下降 。 　 验证 过滤器 应 解决 的 问题 　 　 从 前面 的 分析 中 可以 看出 ， WindowsNT 与 IIS 中 的 基本 验证 过程 ， 存在 以下 问题 ： 　 　 由于 用户名 和 密码 没有 加密 ， 因而 用 基于 编码 和 解码 用户名 和 口令 的 方法 来 验证 网络 用户 的 资源 访问 权限 ， 验证 本身 并 不能 保证 网址 的 安全 。 　 　 WindowsNT 域 上 的 网址 超过 用户 时 ， NT 中 的 安全 管理器 的 安全 验证 性能 会 显著 下降 。 　 　 对于 一些 实现 了 某种 安全性 的 网址 ， 如 银行 的 在线 帐户 系统 ， 如果 网络 服务器 安全 数据库 与 银行帐户 数据库 不 一致 ， 势必会 给 银行 客户 的 身份验证 带来 困难 。 另外 ， 由于 必须 由 网络管理员 维护 应用程序 的 安全 数据库 ， 因而 给 网络 维护 带来 麻烦 。 　 　 在 WindowsNT 基本 验证 中 ， 用户名 和 密码 只能 用于 身份验证 ， 而 不能 作为 资源 访问 权限 的 凭证 。 很 明显 资源 访问 权限 是 由 管理员 分配 的 ， 与 用户名 没有 直接 关系 。 　 　 针对 IIS 和 WindowsNT 在 安全 验证 中 存在 的 问题 ， 可以 采用 ISAPIInternetServerApplicationProgramInterface 扩展 改变 IIS 缺省 的 安全 验证 行为 。 这种 扩展 可以 保证 IIS 的 安全 数据库 不 依赖于 WindowsNT 的 名字 库 ， 即 可以 利用 外部 系统 的 口令 和 用户名 实现 安全性 检查 ， 达到 支持 应用程序 中 的 第三方 安全 数据库 ， 支持 面向 ODBC 的 安全 数据库 连接 的 目的 。 此外 ， 利用 基于 角色 的 系统 ， 使得 验证 不再 针对 用户 身份 ， 而是 针对 用户 的 行为 来 确定 用户 的 信息 范围 或 适合 的 功能 。 　 验证 过滤器 的 设计 与 实现 　 验证 过滤器 的 性能 要求 　 　 数据 存储 要求 　 　 过滤器 应该 能 从 外部 数据源 获取 验证 的 用户名 、 口令 和 角色 ， 可以 访问 ODBC 数据 存储 ， 支持 多线程 。 　 　 执行 效率 要求 　 　 设想 对 每 一个 资源 请求 包括 嵌入 对象 、 Applet 、 ActiveX 控件 等 ， 验证 过滤器 将 被 激活 ， 这 就 意味着 一个 HTML 网页 会 产生 若干次 的 过滤器 引用 。 这 就 要求 验证 过滤器 具有 高性能 的 执行 效率 ， 快速 获取 并 验证 用户 的 凭证 。 　 　 安全 性能 要求 　 　 由于 ISAPI 扩展 可以 直接 访问 IIS 的 数据结构 ， 因此 验证 过滤器 可能 会 给 IIS 的 安全性 带来 严重 的 潜在 危险 ， 从而 要求 实现 验证 过滤器 时 必须 考虑 线程 的 安全 问题 。 此外 ， 考虑 到 对 多线程 数据 存储 的 支持 ， 也 要求 过滤器 支持 数据库 访问 和 同步 管理 。 　 过滤器 的 设计 与 实现 　 　 验证 过滤器 的 实现 集中 在 三个 类上 ： 　 　 CDatabaseManager 数据库 管理器 　 　 该类 负责 从 ODBC 数据库 中 检索 用户 安全 记录 。 在 实现 数据库 管理器 时 ， 应 考虑 到 线程 同步 ， 以 确保 数据 一致性 。 此外 ， 为 快速 获得 安全 记录 ， 应该 避免 频繁 出现 ODBC 登录 ， 以 满足 执行 效率 的 要求 。 该类 主要 成员 函数 包括 ： 　 　 CDatabaseManagerStringConnectString ， BooluseCriticalSectiontrue ， 用于 ODBC 数据库 的 连接 和 对 访问 基础 数据库 请求 提供 类 保护 ； 　 　 BoolLookUserStringuserCuserSecurityEntryentry ， 用于 检索 来自 安全 数据库 的 用户 记录 ； 　 　 VoidEnterCriticalSection 以及 VoidExitCriticalSection ， 这 两个 函数 用来 检查用户 mUserCriticalSection 标识符 ， 以 判断 是否 访问 基础 数据库 ， 如果 是 ， 则 使用 CCriticalSection 对象 管理 线程 同步 。 　 　 私有 数据 有 ： 　 　 BoolmUserCriticalSection ， 访问 数据库 线程 同步 标志 ； 　 　 CUserCacheManagemUserCache ， 用户 记录 缓冲器 对象 ； 　 　 CDatabasemDd ， 数据库 对象 ； 　 　 CCriticalSectionmCriticalSection ， 线程 同步 对象 。 　 　 CUserCacheManager 缓存 管理器 　 　 该类 负责管理 用户 安全 记录 的 内存 缓存 。 当 众多 的 用户 在 较 短 的 时间 内 同时 访问 网址 时 ， 对 安全 记录 的 验证 很 可能 集中 在 有限 几个 安全 记录 的 多次 验证 上 因为 一个 用户 下载 网页 资源 ， 会 连续 多次 触发 过滤器 。 因而 可以 假设 ， 在 大多数 情况 下 ， 缓存 操作 的 用户 安全 信息 请求 记录 是 相似 的 ， 从而 可以 为 每 一个 驻存 记录 设置 延缓 时间 来 确定 缓存 记录 的 有效性 ， 以便 从 缓存 中 清除 过期 记录 ， 恢复 缓存 空间 。 该类 主要 成员 函数 包括 ： 　 　 VoidAddEntryConstCUserSecrityrUser ， 用于 增加 新 的 安全 记录 到 缓存 ； 　 　 BoolLookupEntryStringUserNameCUserSecrityEntryrEntry ， 用于 从 缓存 中 检索 安全 记录 并 检查 该 用户 安全 记录 是否 到期 ； 　 　 VoidPurgeCache ， 用于 将 过期 的 安全 记录 移出 缓存 。 　 　 CAuthFilter 　 　 该类 为 CHTTPFilter 的 派生类 ， 是 过滤器 与 IIS 的 接口 ， 其 主要 成员 函数 包括 ： 　 　 VirtualBOOLGetFilterVersionPHTTPFILTERVERSIONpVer ， 用于 MFCISAPI 过滤器 的 初始化 和 处理 请求 验证 的 安全 连接 和 非 安全 连接 ； 　 　 VirtualDWORDOnAuthenticationCHTTPFilterContextpCtxtPHTTPFILTERAUTHENTPauthent ， 用于 完成 用户 安全 身份 检查 。 　 　 其它 两个 附加 类 CUserSecurityEntry ， 用于 传递 数据库 中 所 定义 的 关于 用户 的 信息 。 　 　 CCacheEntry ， 用于 封装 在 缓存 管理器 中 使用 的 用户 安全 入口 。 　 结束语 　 　 验证 过滤器 作为 一个 动态 连接 库 DLL ， 需将 其 注册 到 HKEYLOCALMACHINECurrentControlSetServicesWVCParametersFilterDLL 验证 过滤器 名上 。 当 远程 浏览器 访问 IIS 时 ， IIS 装载 并 启动 验证 过滤器 ， 使 IIS 不再 使用 NT 安全 验证 方法 。 这样 不仅 避免 了 NT 域 因 用户 增加 造成 安全 验证 性能 下降 ， 同时 使得 IIS 支持 应用程序 第三方 安全 数据库 ， 降低 了 NT 安全 数据库 维护 工作量 ， 提高 了 IIS 的 安全 性能 。 不过 ， 由于 过滤器 本身 并 没 对 安全 记录 加密 ， 因而 还 无法 实现 网址 安全 保护 。 进一步 考虑 ， 可以 引入 对 验证 过滤器 动态 连接 库 实施 数字签名 ， 通过 对 验证 过滤器 加密 授权 间接 实现 网址 的 安全 保护 。 陈晓苏 华中理工大学 计算机科学 与 技术 学院 武汉 张涛 华中理工大学 计算机科学 与 技术 学院 武汉 肖道 举 华中理工大学 计算机科学 与 技术 学院 武汉 参考文献 KClementsandCWuestefeld 著 朱 玉山 王晓冬译 ISAPI 实用技术 指南 北京 ： 清华大学出版社 MicrosoftIISandISAPISecurityofMSDNTonyBeveridgeISAPINSAPIWeb 高级 编程 北京 ： 中国 水利电力 出版社 收稿 日期 ： 年月日