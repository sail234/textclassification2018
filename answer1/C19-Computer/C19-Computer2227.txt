计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERSVolNoP 如何 实现 基于 WindowsCE 的 移动 设备 CS 模式 的 红外 网络连接 胡 虚怀 摘 　 要 ： 介绍 了 WindowsCE 所 支持 的 WinSock 的 一个 扩展 基于 红外技术 的 IrSock 。 讨论 了 利用 工业 标准 IrDA 协议 实现 红外线 通信 的 方法 ， 并 给出 了 CS 模式 的 应用程序 实例 。 关键词 ： WindowsCE 移动 计算 掌上电脑 客户机 服务器 红外 套 接字 　 前言 　 　 WindowsCE 是 专门 为 信息 设备 、 移动 应用 、 嵌入式应用 等 设计 的 操作系统 ， 它 具有 功能强大 的 通讯 功能 ， 可以 支持 范围 广泛 的 通信 硬件 和 数据 传送 协议 。 对于 基于 WindowsCE 平台 的 移动 计算 设备 如 HPC 、 PlamPC 来说 ， 最 灵活 的 通信 方式 当属 利用 红外技术 的 局域网 连接 。 红外技术 是 依靠 红外线 波长 介于 红光 和 微波 之间 ， 从 毫微米 至 毫米 来 传输数据 的 ， 它 的 优点 是 带宽 较 高 可达 Mbps ， 不 需要 分配 无线电 频谱 ， 不易 受 电磁干扰 ， 但 受 视距 限制 不到 英里 ， 一般 用于 建立 局域网 。 红外 网络连接 的 基本模式 是 CS 客户服务器 模式 ， 本文 将 讨论 这种 模式 的 实现 方法 ， 并 将 给出 相应 的 CS 应用程序 实例 。 　 WindowsCE 所 支持 的 红外 局域网 下 的 CS 模式 　 　 CS 技术 是 随着 计算机网络 的 发展 而 发展 起来 的 。 自 年代 开始 ， 计算机 局域网 和 广域网 中 数据库 管理系统 开始 向 CS 模式 转变 ， 并 迅速 占据 了 主导地位 。 在 CS 组成 的 系统 中 ， 拥有 众多 资源 的 主机 提供 服务 ， 资源 较少 的 客户 请求 服务 ， 服务器 处理 客户 的 请求 后 将 结果 返回 给 客户 ， 这一非 对 等 作用 是 通过 网间 的 进程 完成 的 。 由于 进程 通信 是 完全 异步 的 ， 相互 通信 的 进程 间 不 存在 父子关系 ， 又 不 共享内存 缓冲区 ， 因此 需要 一种 机制 为 希望 通信 的 进程 间 建立联系 ， 为 两者 的 数据交换 提供 同步 。 跟 传统 的 做法 一样 ， WindowsCE 也 采用 WindowsSocket 套 接字 通信 机制 来 实现 进程 间 的 这种 双向 数据传输 。 WindowsSocket 一般 称为 WinSock 。 WinSock 需要 考虑 通信 双方 约定 的 协议 。 在 有线 固定 网络 环境 下 ， 最 典型 的 协议 就是 著名 的 TCPIP ； 而 在 红外 无线网络 环境 下 使用 的 协议 为 IrDAInfraredDataAssociation 。 IrDA 是 计算机 、 通信 等 工业 组织 所 制定 的 工业 标准 ， 常用 于 计算机 与 外围设备 如 具有 红外 端口 的 打印机 之间 的 通信 。 WindowsC E通 过 WinSockAPI 支持 IrDA 标准 。 一般 将 支持 IrDA 标准 的 Socket 称为 IrSock ， 并 以此 作为 WinSock 的 扩展 。 　 　 在 WindowsCE 所 支持 的 红外 局域网 中 使用 IrDA 协议 与 固定 网络 中 使用 TCPIP 协议 是 不 一样 的 。 主要 的 差别 是 ： 　 　 ． 名字 服务 　 　 传统 的 WinSock 名字 服务 对于 固定 网络 是 合适 的 ， 因为 网络 中 建立 了 Socket 连接 的 各种 设备 是 静止 的 。 但是 在 移动 计算环境 中 ， 许多 设备 在 红外线 的 有效 视距 范围 内 来来往往 ， 频繁 出没 ， 此时 名字 服务 就 不 适应 了 。 因此 在 IrSock 所 建立 的 连接 中 ， WinSock 名字 服务 函数 是 不能 使用 的 ， 需要 将 名字 服务 合并 到 通信 流中 。 　 　 ． 编址 方法 　 　 编址 是 以 逻辑 服务 访问 点 选择器 LSAPSELs 为 基础 的 ， 编址 数从 l 到 。 因为 可用 值 的 范围 较 小 ， 通常 不 将 Sockets 直接 与 逻辑 服务 访问 点 结合 ， 而是 通过 信息 访问 服务 IAS 所 提供 的 方法 来 实现 Sockets 与 逻辑 服务 访问 点 的 绑定 。 为了 使用 IAS ， 服务器应用程序 先 将 一个 Socket 与 一个 IAS 服务 名 结合 ， 而 客户 应用程序 则 通过 Connect 函数 使用 服务 名 。 应用程序 不 知道 也 不必 知道 由 IAS 所指 派 的 逻辑 服务 访问 点 。 这个 处理过程 将 在 下面 的 实例 中 予以 描述 。 　 　 ． 增强 的 Socket 选项 　 　 WindowsCE 所 包含 的 某些 Socket 选项 对 TCPIP 协议 是 不 适应 的 ， 它 仅 用来 访问 IrDA 协议 中 的 某些 独有 特性 。 限于 篇幅 ， 本文 不予 讨论 。 　 基于 WindowsCE 的 移动 设备 建立 CS 模式 的 应用程序 的 步骤 　 　 VC 以上 版本 的 编程语言 配合 相应 的 WindowsCEToolkitforVC 可 提供 对 IrSock 的 支持 。 我们 知道 Sockets 支持 两种 套 接字 ： 流套 接字 SOCKSTREAM 和 数据 报套 接字 SOCKDGRAM 。 流式 套 接字 提供 了 一个 面向 连接 的 、 可靠 的 、 数据 无错 、 无 重复 地 发送 及 按 发送 顺序 接收 的 服务 。 内设 流量 控制 ， 避免 数据流 超限 ， 数据 被 看作 是 字节 流 ， 无 长度 限制 。 数据 报套 接字 提供 了 一个 无 连接 服务 、 数据包 以 独立 包 形式 发送 ， 不 提供 无差错 保证 ， 数据 可能 丢失 或 重复 ， 并且 接收 顺序 混乱 。 对 建立 CS 模式 的 应用程序 ， 两种 套 接字 的 方法 是 基本一致 的 ， 这里 仅 介绍 流式 套 接字 的 方法 。 　 建立 服务器应用程序 　 　 用 SOCKET 指派 一个 流式 Socket ， 以 AFIRDA 作为 地址 参数 ， SOCKSTREAM 作为 类型 参数 。 　 　 调用 Bind 将 服务 名 与 Socket 结合 ， 以 SOCKADDRIRDA 作为 地址 参数 的 结构 类型 。 　 　 调用 Listen 侦听 客户 连接 请求 。 　 　 当 侦听 到 客户 请求 时 调用 Accept 接收 客户 。 　 　 调用 Send 和 Recv 与 客户 进行 通信 。 　 　 调用 Closesocket 关闭 Socket 。 　 建立 客户 应用程序 　 　 与 服务器应用程序 一样 ， 指派 一个 流式 Socket 。 　 　 搜索 服务器 ， 调用 Getsockopt 获取 它 的 ID 值 。 　 　 以 SOCKADDRIRDA 作为 名字 参数 ， 调用 Connect 建立 与 服务器 的 连接 。 　 　 调用 Send 和 Recv 与 服务器进行 通信 。 　 　 调用 Closesocket 关闭 Socket 。 　 示例 　 　 下面 的 InfraredSocket 服务器 和 客户 应用程序 可以 运行 于 一对 基于 WindowsCE 的 HPC 或 PalmPC 之上 。 若 在 WindowsNT 网上 ， 利用 WindowsCEEmulationSoftwareDevelopmentKitSDK 以上 版本 来 模拟 HPC 的 环境 ， 也 可以 予以 验证 。 InfraredSocket 服务器 includewindowshincludeafirdahintWINAPIWinMainHINSTANCEhInstanceHINSTANCEhPrevInstanceLPTSTRlpCmdLineintnCmdShowSOCKETServerSockClientSock ； 　 SOCKADDRIRDAaddressAFIRDAMyServer ； 　 charhelloServer ； ASCII 串 　 TCHARhelloText ； UNICODE 串 　 intidx ； 　 ServerSocksocketAFIRDASOCKSTREAM ； 　 bindServerSockstructsockaddraddresssizeofaddress ； 　 listenServerSock ； 　 ClientSockacceptServerSock ； 　 recvClientSockhelloServersizeofhelloServer ； 　 foridxidxsizeofhelloServeridx 　 　 　 helloTextidxhelloServeridx ； 　 MessageBoxNULLhelloTextTEXTIRServerMBOK ； 　 sendClientSockHelloClientstrlenHelloClient ； 　 closesocketClientSock ； 　 closesocketServerSock ； 　 return ； InfraredSocket 客户 includewindowshincludeafirdahdefineNumRetriesintWINAPIWinMainHINSTANCEhInstanceHINSTANCEhPrevInstanceLPTSTRlpCmdLineintnCmdShowSOCKETsock ； 　 SOCKADDRIRDAaddressAFIRDAMyServer ； 　 EVICELISTdevList ； 　 Int 　 　 devListLensizeofdevList 　 　 　 　 　 cnt 　 　 　 　 　 idx ； 　 charhelloClient ； 　 TCHARhelloText ； 　 socksocketAFIRDASOCKSTREAM ； 　 devListnumDevice 设备 号 初始化 为 whiledevListnumDevicecntNumRetries 　 　 getsockoptsockSOLIRLMPIRLMPENUMDEVICESchardevListdevListLen ； 　 　 cnt ； 　 　 Sleep ； 重试 前 等待 一秒 ifcntNumRetries 　 　 　 MessageBoxNULLTEXTServercouldnotbelocatedTEXTIRCientMBOKelse 获取 服务器 的 socket 地址 　 　 foridxidxidx 　 　 　 addressirdaDeviceIDidxdevListDeviceirdaDeviceIDidx ； 　 　 connectsockstructsockaddraddresssizeofSOCKADDRIRDA ； 　 　 sendsockHelloServerstrlenHelloServer ； 　 　 recvsockhelloClientsizeofhelloClient ； 　 　 foridxidxsizeofhelloClient ； idx 　 　 　 　 helloTextidxhelloClientidx ； 　 　 MessageBoxNULLhelloTextTEXTIRClientMBOK ； closesocketsock ； 　 return ； 　 结束语 　 　 基于 WindowsCE 的 设备利用 IrDA 协议 建立 客户机 服务器 工作 模式 的 红外线 连网 是 实现 别具一格 的 移动 计算环境 的 最 有效 的 途径 。 通过 对 以上 的 分析 ， 我们 可以 基本 掌握 IrSock 网络 程序设计 的 基本原理 及 实现 方法 。 胡 虚怀 岳阳 师范学院 计算机系 湖 南岳 阳 参考文献 WindowsCEProgrammersGuideMicrosoftPresshttpmicrosoftcomwindowsce 寥俊段 爱民 译 Windows 位 编程 指南 北京 清华大学出版社 收稿 日期 ： 年月日