计算机 工程 ComputerEngineering 年 　 第卷 　 第期 　 VolNo 使用 协议 分析 预警 、 排除 Novell 网络故障 李德 鹏 　 史 清华 　 　 摘 　 要 ： 针对 Novell 网络 ， 介绍 如何 使用 Novell 网络操作系统 的 一些 特殊 性质 协议 ， 预警 网络 异常情况 ． 网络管理员 可以 以此 为 依据 ， 防患于未然 ． 然后 进一步 讨论 如何 利用 Novell 网络协议 定位 网络故障 ， 并且 提供 几个 网络故障 排除 的 例子 ． 　 　 关键词 ： NetWare 网络操作系统 ； Watchdog 协议 ； 故障 预警 ； 故障 排除 AlarmandTroubleshootingNovellNetworkwithNetWareProtocolLiDepengComputerCenterofShandongProvNetworkKeyLabofShandongProvJinanShiQinghuaDepartmentofComputerShandongIndutrialUniversityJinan 　 　 Abstract 　 ThisArticletalkedabouthowtoalarmandtroubleshootNovellnetworkwithNetWareprotocolTheNetworkadministratorcanpreventnetworkformbeendamagedAnditgivessomesampletodiscussabout 　 　 Keywords 　 NetWarenetworkWatchdogprotocolAlarmTroubleshooting 　 　 由于 NetWare 网络操作系统 没有 提供 网络 故障诊断 工具 ， 所以 网络管理 人员 如何 有效 快速 定位 解决 这些 故障 ， 以 避免 更大 经济损失 是 迫切需要 解决 的 问题 。 NetWare 网络操作系统 提供 许多 协议 用于 服务器 与 工作站 之间 有关 异常情况 的 磋商 、 对话 ， 对 网络故障 预警 、 排除 都 有所 帮助 。 结合 网络故障 解决 的 实际 经验 ， 讲述 如何 使用 Novell 的 网络协议 定位 、 排除故障 ， 解决问题 。 　 NetWare 的 重要 协议 　 基本 帧 格式 　 　 NetWare 网络操作系统 支持 种 不同 的 以太网 帧 结构 。 分别 称为 Ethernet 、 Ethernet 、 EthernetSNAP 、 EthernetII 。 通常 人们 使用 Ethernet 、 Ethernet 支持 IPXSPX 协议 ， 使用 EthernetII 支持 TCPIP 协议 ， 而用 EthernetSNAP 支持 AppleTalk 协议 。 　 　 由于 NetWare 网络 要求 ， 工作站 和 服务器 只能 使用 相同 帧 格式 ， 双方 才 可以 通信 。 所以 如果 工作站 使用 不同于 服务器 的 帧 格式 ， 必然 导致 工作站 无法 同 服务器 建立 连接 ， 也 就是 工作站 得到 FileServerhasnotbeenfound 的 提示 。 　 　 下面 简要 介绍 种 不同 的 帧 格式 ， 解决 工作站 无法 找到 服务器 的 问题 。 　 　 Ethernet 前 辍 SFD 字节 目的 地址 字节 源地址 字节 长度 字节 上层 协议 类型 字节 　 　 　 注解 ： 上层 协议 类型 是 XFFFF 表示 为 IPX 协议 头 　 　 Ethernet 前 辍 SFD 字节 目的 地址 字节 源地址 字节 长度 字节 DSAP 字节 SSAP 字节 控制 字节 上层 协议 类型 字节 　 　 DSAP 指明 数据包 目的地 上层 网络层 协议 的 类型 。 E 表示 是 IPXSPX 类型 。 　 　 SSAP 指明 数据包 源地址 上层 网络层 协议 的 类型 。 E 表示 是 IPXSPX 类型 。 　 　 如果 使用 NetWare 的 IPXSPX 协议 ， 并且 控制 域 的 数值 为 X 时 ， 表示 不 编号 ， 意味着 LLC 层 提供 无 连接 服务 。 前 辍 字节 目的 地址 字节 源地址 字节 长度 字节 DSAP 字节 SSAP 字节 控制 字节 组织 代码 字节 　 Ethernet 类型 字节 　 　 　 EthernetSNAP 　 　 DSAP 字 段长度 为 字节 ， 值为 XAA 表示 帧 格式 是 SNAP ， 控制 域 为 X 表示 无 连接 组织 代码 为 表示 该 帧 是 NetWare 的 IPXSPX 数据包 。 Ethernet 类型 字段 的 功能 是 规定 上层 协议 ， NetWare 的 Ethernet 数是 X 。 详见 表 。 表 各种 协议 的 数值 对照表 协议 名称 数值 IPXARPXPARPXAppleTalkXBAppleTalkarpXfNetWareIPXSPXX 　 　 EthernetII 前 辍 SFD 字节 目的 地址 字节 源地址 字节 类型 字节 　 　 EtherNetII 与 前种 不同 ， 前种 帧 格式 的 源地址 字段 后 是 长度 字 段 ， 而 EtherNetII 是 类型 字 段 ， 类型 字段 的 数值 所 表示 的 协议 类型 见表 。 延迟 帧 　 　 NetWare 中 ， NCPNetWare 核心 协议 是 用 IPXSPX 协议 封装 的 。 NCP 请求 是 工作站 请求 服务器进行 文件 读写 、 创建 队列 作业 、 决定 驱动 映射 、 搜索 目录 等 。 服务器 用 NCP 应答 NCP 请求 。 其中 应答 类型 是 的 协议 表示 工作站 的 请求 正在 被 处理 。 该类 帧 也 被称作 延迟 帧 RequestingBeingProceed 。 帧 格式 如下 ： 以太网 数据 头 IPX 数据 头 SPX 数据 头 NCP 请求 头标 NCP 数 　 　 以太网 数据 头见 所述 的 几种 帧 格式 。 　 　 IPX 数据 头 ： 校验 和 字节 长度 字节 传输 控制 字节 分组 类型 字节 目的 节点 地址 字节 目的 网络地址 字节 目的 Scoket 字节 源 节点 地址 字节 源 网络地址 字节 源 Scoket 字节 　 　 SPX 数据 头 ： 连接 控制 字节 数据流 控制 字节 源 连接 字节 目的 连接 字节 顺序号 字节 确认 号 字节 分配 数字 节 　 　 　 NCP 应答 头标 ： 请求 类型 字节 顺序号 字节 连接号 低 字串 字节 任务 号 字节 连接号 高字节 字节 完成 码 字节 连接 状态 字节 　 　 　 客户机 传送 请求 至 服务器 ， 然后 等待 服务器 应答 。 如果 超时 限度 内 没有 收到 应答 就 重新 发送 。 如果 服务器 太忙 ， 无法 处理 客户机 的 该 请求 ， 就 发送 NCP 应答 类型 是 的 数据包 ， 表示 请求 正在 处理 。 客户机 收到 该 请求 正在 处理 数据包 ， 复位 IPX 超时 计数器 并 继续 等待 超载 服务器 的 应答 。 　 　 若 网络 出现 延迟 数据包 ， 说明 有 NetWare 服务器 运行 在 超 负载 情况 下 ， 正在 处理 工作站 的 请求 ， 希望 工作站 等待 。 　 　 ． Watchdog 分组 　 　 Watchdog 分组 是 服务器 用来 同 工作站 保持 连接 的 协议 。 在 Novell 环境 中 ， 工作站 同 服务器之间 存在 连接 。 如果 很 长时间 双方 没有 通信 ， 为了 确认 客户机 依然 存在 ， 没有 Down 机 ， NetWare 服务器 向 工作站 发送 Watchdog 协议 。 如果 工作站 在 一定 时间 默认 时间 是 分钟 秒 不 向 服务器发送 任何 分组 ， 服务器 将 向 工作站 发送 Watchdog 协议 分组 。 分组 的 数据格式 如下 ： 帧 头 IPX 头 连接号 字节 签名 字符 域 字节 　 　 如果 服务器 没有 收到 来自 工作站 的 应答 ， 会 发送 组 附加 的 Watchdog 分组 ， 间隔时间 默认值 为 s 。 如果 工作站 不 响应 ， 则 服务器 终止 该 工作站 的 连接 。 　 　 Nowvell 用户 可以 通过 下列 语法 修改 分组 发送 间隔 ： 　 　 SetNumberofWatchdogPackets 　 　 　 　 　 n 　 　 SetDelayBetweenWatchdogPackets 　 　 　 n 　 　 SetDelayBeforeFirstWatchdogPackets 　 n 　 网络故障 预警 、 排除 的 实现 　 　 系统 采用 予留 缓冲区 扑 获 数据 、 协议 解码 、 统计 重要 协议 数据包 的 方法 ， 统计 异常 网络协议 传送 数量 、 比例 ， 并且 根据 经验 预警 网络故障 ， 排除 网络故障 。 使用 前 过滤 机制 ， 捕获 预定 数据包 　 　 考察 前 过滤 、 后 过滤 机制 、 硬件平台 的 普遍性 、 予留 数据 缓冲区 ， 有 针对性 地 截获 发送 特殊 协议 的 数据包 ， 给出 屏幕提示 以及 响应 的 统计数据 ， 作为 网络管理 人员 监控 网络 、 排除 差错 的 依据 。 列出 服务器 名称 和 所用 网卡 封装 的 帧 格式 　 　 根据 网络 服务器 所 发送 的 广播 包 ， 分析 解码 协议 帧 ， 列出 服务器 名称 以及 所 使用 的 帧 格式 。 在 服务器 、 工作站 、 中间 连接 设备 都 正常 的 情况 下 ， 有时 会 出现 工作站 无法 连接 服务器 的 问题 。 导致 这种 情况 的 原因 很多 ， 其中 由于 工作站 、 服务器 所 使用 的 帧 格式 不同 而 导致 出现 该 问题 占 的 比例 很大 。 如果 服务器 网卡 使用 的 帧 格式 为 EtherNet ， 而 工作站 使用 的 帧 格式 为 EtherNet 由此 造成 相互 无法 发现 彼此 的 存在 。 根据 屏幕 列出 的 服务器 名称 及 所 使用 的 数据 帧 ， 判断 是否 存在 这种 情况 。 　 　 另外 ， 造成 工作站 无法 连接 服务器 的 原因 还有 网卡 硬件 故障 、 电缆 链路 质量 、 网卡 驱动程序 配置 等 。 值得一提的是 由于 服务器 License 许可证 数量 不足 ， 造成 工作站 无法 登录 服务器 ， 但 有趣 的 是 工作站 得到 的 提示 为 AFileServerCouldnotbefound 。 例如 ， 在 一次 故障 排除 中 碰到 这种 情况 ： 在 增加 几十台 工作站 之后 ， 突然 之间 不时 有 工作站 无法 登录 服务器 ， 而且 工作站 的 型号 、 网卡 的 型号 、 用户 名称 各不相同 ， 后来 才 发现 该 服务器 是 用户 版 ， 而 当时 使用 的 工作站 超过 台 。 统计 延迟 帧 发送 的 数量 及 占 网络 数据 帧 总量 的 比例 　 　 凭借 检测 到 该类 数据包 进行 网络故障 定位 、 排除 很 有效 。 如果 延迟 帧 占 数据 帧 总量 的 比例 大于 ， 系统 应弹 出 报警信号 。 提示 网络管理 人员 ： 网络 处于 超 负载 状况 。 　 　 一个 实际 网络故障 排除 的 例子 是 ： 某 网络 运行 速度 很 慢 ， 经 检查 服务器 发现 服务器 的 CPU 和 硬盘 的 利用率 都 很 低 ， 服务器 中 的 缓存 也 充足 。 服务器 采用 M 快速 以太网卡 ， 针对 网络 数据 流量 测试 后 发现 数据 流量 占 总 带宽 的 ， 所有 这 一切 都 不应 造成 网络 瓶颈 ， 但是 ， 工作站 在 同 服务器进行 数据传输 的 过程 中 速度 很 慢 。 　 　 根据 协议 分析 的 方法 ， 在 网络 上 发现 大量 的 延迟 数据包 ， 这同 前面 的 分析 恰恰相反 ， 说明 网络 服务器 在 重 负荷 下 工作 ， 由于 CPU 、 硬盘 、 缓存 都 宽裕 ， 所以 可能 是 网卡 造成 网络 数据传输 瓶颈 。 由于 采用 M 网卡 ， 所以 网卡 速度慢 的 可能性 也 排除 。 检查 网卡 驱动程序 ， 发现 由于 驱动程序 过时 导致 配置 不当 ， 使得 数据 发送 不 及时 ， 造成 延迟 ， 才 发送 大量 的 延迟 数据包 。 监视 Watchdog 数据包 　 　 频繁 多次 收到 Watchdog 数据包 ， 而 工作站 没有 作出 反映 ， 系统 应 提示 网络连接 可能 发生 中断 ， 工作站 可能 掉 网 。 　 　 曾 碰到 一例 网络故障 ： 某 单位 的 网络 升级 改造 完成 后 ， 出现 异常现象 。 登录 服务器 的 工作站 常 与 服务器 失去 连接 ， 也 就是 通常 所说 的 间歇性 掉 网 。 一般 时间 是 登录 服务器 半小时 左右 。 用户 不得不 多次 启动 工作站 。 严重 降低 办公 效率 。 　 　 使用 协议 分析 的 方法 进行 检查 ， 发现 工作站 登录 服务器 后 不久 就 不再 向 服务器发送 数据包 ， 分钟 后 ， 服务器 向 工作站 发送 Watchdog 分组 ， 工作站 也 没有 进行 响应 。 由此 初步 判定 故障 出 在 工作站 一端 。 由于 网络 升级 以前 ， 网络 工作 正常 ， 对原 系统 进行 协议 分析 ， 发现 工作站 的 响应 方式 正常 。 网络 升级 针对 工作站 一端 所 做 工作 在于 网卡 由 M 升级 至 M ， 由 ODI 方式 改为 VLM 方式 。 进一步 使用 替换 排错 的 方法 定位问题 出 在 VLM 方式 与 网卡 的 互操作 上 ， 由于 存在 漏洞 ， 所以 造成 一段时间 之后 ， 网卡 无法 发送数据 。 　 小结 　 　 因为 导致 Novell 网络故障 发生 的 可能性 成千上万 。 本文 提出 根据 网络协议 预警 网络故障 的 办法 仅仅 能够 解决 一小部分 问题 。 对 网络管理 人员 来说 ， 留心 重要 的 可以 报警 异常情况 的 协议 格式 ， 在 网络 异常 的 情况 下 ， 采用 协议 分析 的 方法 可以 迅速 定位 网络故障 ， 为 网络 排错 。 作者简介 ： 李德 鹏 ～ ， 男 ， 助理 研究员 ， 主要 研究 方向 为 计算机 检测 评估 作者 单位 ： 李德 鹏 　 山东省 计算中心 ， 山东省 网络 重点 实验室 ， 济南 　 　 　 　 　 　 史 清华 　 山东 工业 大学 计算机系 ， 济南 　 参考文献 ChappellAHakesETheCompleteGuidetoNetWareLANAnalysisrdEDAllenNNetworkMaintenceandTroubleshootingGuide 收稿 日期 ：