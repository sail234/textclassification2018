计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 面向对象 数据库 中 的 索引 实现 技术 程胜 　 谌潜 　 董金 祥 摘要 ： 首先 介绍 主要 的 种 嵌套 属性 上 的 索引 实现 技术 及其 操作 算法 ， 并 分析 和 比较 了 它们 的 优缺点 ， 然后 介绍 了 面向对象 工程 数据库 管理系统 OSCAR 中 的 索引 实现 技术 。 关键词 ： 面向对象 工程 数据库 管理系统 ； 查询 优化 ： 复杂 对象 IndexImplementationTechniquesintheObjectorientedDatabasesChengShengChenQianDongJinxiang （ CADCAMCenterofChinaAerospaceCorporationBeijingArtificialIntelligenceInstituteofZhejiangUniversityHangzhou 【 Abstract 】 Thispaperfirstlyintroducestheimplemetationtechniqueandoperationalgorithmsofthreemainindexs ， analysingandcomparingthemformthedimensionsoffeasibilityandperformanceThentheindeximplementationtechniquesinOSCARwhichisanobjectorientedengineeringdatabasemangementsystemwerepresented 【 Keywords 】 ObjectorientedengineeringdatabasemangementsystemQueryoptimizationComplexobject 　 　 建立 在 类 聚集 层次 上 的 索引 方法 大致 可 分为 类 ： 嵌套 索引 NestedIndex ， 路径 索引 PathIndex ， 多 索引 Multiindex 。 本文 详细 讨论 了 类 索引 的 实现 方法 和 操作 算法 ， 并 对 这种 索引 方法 从 实现 方法 和 操作 性能 上 进行 了 分析 和 比较 。 文章 最后 介绍 了 我们 自主 开发 的 、 面向对象 的 工程 数据库 管理系统 OSCAR 中 的 路径 索引 实现 技术 。 建立 在 类 聚集 层次 上 的 类 索引 基本概念 　 　 定义 　 设 H 是 一类 聚集 层次 CC … Cn ， H 上 的 一条 路径 定义 为 PCAA … Ann ， 其中 　 　 · Ci 是 H 中 的 一个 类 ， Ai 是 中 Ci 的 一个 属性 ， 　 　 · Ci 是 类 Ci 的 一个 属性 Ai 的 值域 i ≤ n 。 　 　 定义 　 设有 路径 PCAA … AnP 上 的 一个 实例 定义 为 n 个 对象 的 序列 OO … On ， 其中 　 　 · O 是 P 上类 C 的 一个 实例 　 　 · Oi 是 类 Oi 的 属性 的 一个 值 i ≤ n 。 　 　 定义 　 设有 路径 PCAA … An ， P 的 一个 部分 实例 定义 为 对象 序列 OO … Oj ， jn ， 其中 　 　 · O 是 P 上 的 一个 类 Ck 的 一个 实例 knj ， 并且 　 　 · Oi 是 对象 Oi 的 属性 Ai 的 一个 值 i ≤ j 。 　 　 为 更 清楚 地 说明 这 几种 索引 方法 ， 在 以下 的 讨论 中 以图 中 的 对象 数据库 模式 片段 和 图 中 的 一些 对象 实例 为 例来 说明 这 类 索引 。 图 一个 对象 数据库 模式图 一些 对象 实例 嵌套 索引 定义 　 　 设有 路径 PCAA … An ， 在 P 上 的 嵌套 索引 定义 为 OS 的 集合 ， 其中 　 　 · SO 使得 存在 P 的 实例 OO … On ， 其中 OO ， OOn 　 　 OS 对 中 的 O 是 索引 关键字 。 　 　 下面 是 建立 在 路径 P 公民 拥有 汽车 制造商 股票价值 上 的 嵌套 索引 ： 　 　 ， 教授 A 　 　 ， 经理 A 　 　 ， 经理 A 教授 B ， 经理 B 　 　 为 方便 起 见 ， 在 以下 的 讨论 中将 路径 实例 中 第一个 对象 和 最后 一个 对象 分别 称为 起始 对象 和 结尾 对象 。 嵌套 索引 的 操作 算法 　 　 给定 一 路径 PCAA … An 以及 一个 定义 在 该 路径 上 的 嵌套 索引 ， 　 　 检索 算法 　 对类 C 的 嵌套 属性 An 上 的 谓词 的 计算 需要 查找 索引 。 对于 嵌套 索引 的 查找 与 一般 索引 的 查找 是 相同 的 ， 即 通过 关键字 直接 找到 相应 的 起始 对象 的 标识 OID 。 　 　 索引 更新 算法 　 设 对象 Oi ≤ i ≤ n 是 路径 上类 Ci 的 一个 实例 ， 对象 Oi 的 属性 Ai 的 值 是 Oi ， 并且 Ai 的 值 要 被 Oi 替代 。 下面 是 嵌套 索引 更新 的 算法 ： 　 　 根据 Oi 查找 出 所有 An 的 值 放入 集合 Sold ， 查找 是 一个 从 Oi 开始 到 An 的 正向 游历 过程 。 通常 Sold 只 包含 一个 元素 ， 除非 路径 上 某个 Ai 是 多值 的 ； 　 　 根据 Oi 找出 所有 An 的 值 放入 集合 Snew 。 如果 SnewSold ， 则 说明 索引 不必 更新 。 否则 ， 转 ； 　 　 找出 所有 直接 或 间接 引用 Oi 的 类 Ci 的 实例 。 这是 一个 从 Oi 开始 的 反向 游历 过程 ， 如果 i ， 则 ROi 　 　 索引 更新 步骤 如下 ： 　 　 ① 如果 Snew ≤ Sold 则 △ SoldSnew ； 对于 △ 中 的 每个 关键字 k ， 从 k 的 索引 纪录 中 删去 所有 在 R 中 的 的 OID ； ② 如果 Sold ≤ Snew ， 则 △ SnewSold ； 对于 △ 中 的 每个 关键字 k ， 将 △ 中 的 OID 加入 到 k 的 索引 纪录 中 去 ； ③ 否则 △ SoldSnew 并且 △ SnewSold ； 对于 △ 中 的 每个 关键字 k ， 从 其 索引 纪录 中 删去 R 中 的 OID ； 对于 △ 中 的 每个 关键字 k ， 把 R 中 的 OID 加入 到 其 索引 纪录 中 去 。 实现 方法 及 分析 　 　 嵌套 索引 提供 了 路径 的 起始 对象 和 结尾 对象 间 的 直接 关联 。 嵌套 索引 可以 用 B 树结构 或 哈希 算法 实现 。 如果 用 B 树 实现 ， 则 需要 用 两棵 B 树来 分别 实现 主 、 副 索引 。 其中 主 索引 包含 与 关键字 对应 的 路径 上 的 所有 类 的 对象 标识 ， 副 索引 把 主 索引 纪录 中 的 这些 对象 标识 作为 关键字 ， 它 将 每个 对象 标识 与 一列 该 对象 的 直接 祖先 相关联 。 　 　 注意 到 建立 和 维护 嵌套 索引 时 都 要 对 路径 进行 反向 游历 ， 这 要求 对象 的 反向 引用 的 存在 ， 但 在 实际 的 对象 数据库 模式 中 这种 双向 引用 关系 并不多 。 如果 用户 建立 的 数据库 模式 中 不 存在 反向 引用 ， 一个 解决 方法 是 由 数据库 管理系统 把 所有 的 单向 对象 引用 关系 变为 双向 的 对象 引用 关系 ， 系统 添加 的 引用 关系 对 用户 是 不 可见 的 ， 它 的 作用 仅仅 是 使 系统 能够 更 有效 地 在 对象 空间 中 游历 。 但 这种 方法 使 系统 必须 对 这种 关系 进行 维护 而 增添 很多 额外 的 开销 ， 结果 导致系统 整体 性能 的 下降 ， 很 有 可能 是 得不偿失 。 而且 嵌套 索引 本身 的 实现 结构 已经 很 复杂 ， 维护 也 比较 困难 ， 所以 如果 数据库 模式 中 不 存在 足够 的 双向 引用 关系 ， 一般 不宜 建立 嵌套 索引 。 多 索引 定义 　 　 设有 路径 PCAA … An ， 多 索引 定义 为 　 　 ∪ ≤ i ≤ nII … Ii ， 　 　 其中 Ii ≤ i ≤ n 是 定义 于 路径 上 的 单 索引 。 　 　 CiAi 上 的 单 索引 是 指 OS 对 的 集合 ， O 是 属于 Ai 值域 的 一个 值 ， 并且 SOOAiO 。 　 　 注意 ， 在 单 索引 中 ， 关键字 可以 是 基本 类型 如 整型 ， 字符串 等 ， 也 可以 是 对象 标识 。 　 　 建立 在 路径 P 公民 拥有 汽车 制造商 股票价值 上 的 多 索引 如下 ： 　 　 　 建立 在子 路径 经理 拥有 汽车 的 单 索引 有 ： ① 轿车 A ， 经理 B ； ② 轿车 B ， 经理 A ； ③ 轿车 C ， 教授 A ； ④ 轿车 D ， 教授 B ； ⑤ 轿车 E ， 经理 A 。 　 　 　 建立 在子 路径 拥有 汽车 制造商 的 单 索引 有 ： ① 公司 A ， 轿车 C ； ② 公司 B ， 轿车 A ， 轿车 D ， 轿车 E ； ③ 公司 C ， 轿车 B ， 轿车 F 。 　 　 　 建立 在子 路径 制造商 股票价值 的 单 索引 有 ： 　 　 ① ， 公司 A ； ② ， 公司 B ； ③ ， 公司 C ； 　 主要 操作 算法 　 　 设有 路径 PCAA … An ， 对类 Ci ≤ i ≤ n 的 嵌套 属性 An 上 谓词 计算 需要 查找 ni 个单 索引 。 先 要 查找 索引 In ， 然后 是 In 直到 Ii ， 这是 一个 对 路径 的 反向 游历 的 过程 ， 但 这个 过程 的 反向 游历 并不需要 对象 反向 引用 的 存在 ， 因为 根据 索引 就 可以 找到 路径 中 的 前 一个 对象 。 可以 看出 ， 利用 多 索引 并 不能 直接 根据 关键字 找到 相应 的 对象 ， 而是 要 查找 路径 上 的 每个 单 索引 ， 所以 多 索引 的 检索 性能 一般 不如 嵌套 索引 当 路径 长度 大于 时 。 　 　 对 多 索引 的 维护 就是 对 每个 单 索引 的 维护 ， 对单 索引 的 维护 算法 是 比较简单 的 。 　 实现 方法 及 分析 　 　 多 索引 可以 用 多棵 B 树 分别 实现 各个 单 索引 。 虽然 多 索引 的 结构 不 复杂 ， 维护 也 比较简单 ， 但 其 检索 性能 并 不 理想 在 路径 长度 大于 时 ， 所以 如果 查询 中 的 路径 表达式 的 长度 一般 都 大于 时 ， 实现 多 索引 并 不是 很 划算 。 　 路径 索引 　 定义 　 　 设有 路径 PCAA … An ， 路径 索引 定义 为 OS 对 的 集合 ， 其中 　 　 · O 是 An 值域 的 一个 值 ， 　 　 · S Π njPiPiOiOi … On 是 一个 路径 的 无 冗余 或 完全 实例 ， 并且 OnO 。 　 　 路径 索引 所在 的 每个 与 以为 要 结尾 的 所有 路径 实例 间 建立 了 联系 。 　 　 根据 图 图 ， 建立 在 路径 P 公民 拥有 汽车 制造商 股票价值 上 的 路径 索引 如下 ： 　 　 · 教授 A 轿车 C 公司 A 　 　 · 轿车 E 公司 B ， 教授 B 轿车 D 公司 B ， 经理 B 轿车 A 公司 B ， 经理 A 轿车 E 公司 B 　 　 · 轿车 F 公司 C ， 经理 A 轿车 B 公司 C 　 主要 操作 算法 　 　 在 以下 操作 算法 的 讨论 中 ， 假设 索引 是 以 页面 为 单位 组织 的 ， 每个 页面 由 若干个 索引 纪录 组成 ， 每个 索引 纪录 又 由 若干个 路径 实例 组成 ， 路径 实例 都 是 以 长度 等于 路径 表达式 长度 的 数组 形式 存储 。 　 　 给定 一个 路径 PCAA … An 以及 定义 在 P 上 的 路径 索引 ， 　 　 检索 算法 　 对于 类 Ci ， ≤ i ≤ n 的 属性 An 上 的 嵌套 谓词 的 计算 ， 只 需要 对 索引 的 一次 查找 ， 只要 找到 与 关键字 相关 的 路径 实例 ， 其 第 i 个 元素 就是 要 找 的 类 Ci 的 实例 OID 。 对 路径 索引 的 查找 一般 要 比 嵌套 索引 的 查找 涉及 更 多 的 页 ， 这 是因为 路径 索引 的 索引 纪录 包含 了 比 嵌套 索引 相应 纪录 更 多 的 信息 。 　 　 索引 更新 算法 　 设 路径 上类 Ci 的 一个 实例 Oi ， ≤ i ≤ n ， 其 属性 Ai 的 值 Oi 被 Oi 所 取代 。 其 索引 更新 算法 如下 ： 　 　 ① 根据 Oi 找出 相应 的 An 的 值 并 放入 集合 Sold ， 一般 Sold 只 包含 一个 元素 ， 除非 路径 上 的 某些 属性 是 多值 的 ； 　 　 ② 找出 从 Oi 到 属性 An 的 部分 实例 并 将 其 放入 集合 SPnew ， 将 从 Oi 开始 遍历 找到 的 An 的 值 放入 Snew ； 　 　 ③ 对于 Sold 中 的 每个 关键字 k 找出 其 索引 纪录 ， 对于 纪录 中 的 每个 路径 实例 P 如果 其 第 i 个 元素 为 On ， 第 i 个 元素 为 Oi ， 则 执行 以下 步骤 ： 　 　 · 　 将 P 的 从 第个 到 第 i 个 的 部分 实例 放入 临时 集合 T ， 　 　 · 　 将 P 从 纪录 中 删除 ； 　 　 ④ 生成 第 i 个 元素 为 Oi ， 第 i 个 元素 为 Oi 的 新 路径 实例 ， 设新 实例 为 pnew ， 则 pnew 为 T 的 一个 元素 ， 及 Oi ， Oi 和 SPnew 中 一个 元素 的 串接 。 pnew 的 总数 为 nn 、 n 、 n 分别 为 T 、 SPnew 中 元素 的 个数 ； 　 　 ⑤ 对于 Snew 中 的 每个 关键字 k ， 找到 相应 的 时 索引 纪录 ， 将 所有 pnew 加入 到 纪录 中 去 。 　 　 从 以上 索引 更新 算法 可以 看出 ， 路径 索引 不 需要 反向 游历 ， 而 它 在 嵌套 索引 中是 必需 的 ， 因此 路径 索引 比 嵌套 索引 有 更好 的 可用性 。 　 实现 方法 及 分析 　 　 路径 索引 可以 一棵 B 树 实现 ， 所以 就 实现 来说 路径 索引 最为 方便 。 但 根据 文献 中 的 代价 模型 分析 ， 当 路径 长度 大于 时 ， 路径 索引 的 检索 性能 并 不是 最好 的 ， 嵌套 索引 的 检索 性能 最好 ， 多 索引 的 检索 性能 最差 ； 就 维护 代价 来说 ， 多 索引 最优 ， 路径 索引 次之 ， 嵌套 索引 最差 。 当 路径 长度 等于 时 ， 种 索引 都 退化 为 简单 索引 。 　 　 经过 对 索引 性能 、 维护 代价 、 实现 技术 复杂度 的 综合 权衡 ， OSCAR 中 采用 了 路径 索引 。 由于 B 树 查找 效率 比较 高 一般 访问 三层 树 结点 就 可 找到 所 需 纪录 ， 所以 目前 大部分 商用 数据库系统 中 索引 的 物理 实现 主要 采用 B 树 或 其 变种 如 H 树 等 ， OSCAR 中 也 主要 采用 B 树 实现 其 索引 。 　 OSCAR 中 路径 索引 的 实现 方法 　 　 面向对象 工程 数据库 管理系统 OSCAR 是 由 浙江大学 人工智能 所 和 中国 航天工业 总公司 CADCAM 中心 合作 研制 的 、 CADCAPPCAM 集成 环境 下 的 数据库 支撑 软件产品 。 为 提高 系统 的 查询处理 能力 ， OSCAR 中 采用 了 多种 索引 技术 ， 其中 就 有 为 支持 嵌套 谓词 优化 的 路径 索引 。 为了 实现 在 并发 条件 下 对 索引 树 的 操作 ， OSCAR 的 索引 操作 算法 中 采用 了 特殊 的 并发 控制策略 。 索引 操作 的 并发 控制 是 一个 复杂 的 问题 ， 本文 不 对 该 问题 进行 探讨 。 　 索引 纪录 结构 　 　 如前所述 ， OSCAR 中 的 路径 索引 用 B 树 实现 。 B 树 的 结点 以 页面 为 单位 组织 ， 对于 非叶 结点 每个 结点 占 一个 页面 ； 而 对于 叶 结点 则 占有 一个 或 一个 以上 的 页面 ， 具体 的 页面 数 取决于 插入 该 页面 的 索引 纪录 数 以及 每个 索引 纪录 中 的 路径 实例 数目 。 　 　 B 树 的 阶数 等于 页面 大小 除以 非 页面 索引 纪录 的 大小 。 为 实现 高效 的 IO 操作 ， 页面 一般 取 磁盘 块 大小 的 整数倍 。 在 OSCAR 中 ， 页面 为 kB 。 　 　 在 以下 的 讨论 中 ， 用 以下 的 符号 表示 相应 的 参数 ： 　 　 RL 表示 纪录 长度 ； KL 表示 关键字 长 ； KV 表示 关键字 长 ； IN 表示 路径 实例 个数 ； INSTi 表示 路径 实例 i ； PNEXT 表示 指向 索引 树中 一个 结点 的 指针 ； DIR 表示 纪录 各个 路径 实例 的 地址 的 目录 项 。 　 　 索引 树非 叶面 结点 中 的 索引 纪录 在 页面 中是 根据 关键字 值 大小 按照 升序 排列 的 ， 一个 非叶 结点 的 纪录 结构 是 这样 的 ： 　 　 对于 索引 树叶 面 结点 中 的 索引 纪录 ， 　 　 　 当 纪录 长度 不 超过 一个 页面 的 大 小时 ， 纪录 是 这样 组织 的 ： 　 　 其中 路径 实例 以 数组 形式 存放 ， 数组 中 的 元素 为 按照 路径 正向 游历 顺序 存放 的 ， 路径 实例 中 的 对象 的 OID ， 数组 的 长度 都 为 路径 表达式 的 长度 ， 开始 时 整个 数组 初始化 为空 。 如果 路径 实例 不是 完全 路径 实例 ， 则 数组 中有 一部分 元素 为空 。 　 　 　 当 纪录 长度 超过 一个 页面 的 大 小时 ， 一个 纪录 的 路径 实例 要 存储 在 多个 页面 上 ， 这时 要 在 纪录 头上 增加 一个 目录 项 ， 用来 纪录 每个 路径 实例 的 地址 ， 路径 实例 的 地址 是 二元 组 页面 号 ， 页 内 偏移 。 纪录 结构 为 如下 形式 其中 ADDRi 表示 INSTi 的 地址 ： 　 结束语 　 　 本文 介绍 了 目前 面向对象 数据库 中 建立 在 复杂 对象 上 的 类 索引 ， 并 分析 和 比较 了 它们 的 实现 方法 和 主要 操作 算法 ， 还 介绍 了 OSCAR 中 路径 索引 的 实现 方法 。 但 目前 这 几种 索引 技术 还 未 见 有 商用 系统 实现 它们 的 报道 。 就 OSCAR 中 实现 的 路径 索引 来看 ， 其 实现 的 技术难度 不 大 ， 索引 的 操作 性能 也 比较 令人满意 。 基金项目 ： 国家自然科学基金 资助 作者简介 ： 程胜 （ ～ ） ， 男 ， 研究生 ， 主要 从事 面向对象 数据库 查询处理 研究 作者 单位 ： 程胜 　 谌潜 （ 中国 航天工业 总公司 CADCAM 中心 ， 北京 ） 　 　 　 　 　 董金 祥 （ 浙江大学 人工智能 所 ， 杭州 ） 参考文献 BertinoECataniaBChiesaLDefinitionandAnalysisofIndexOrganizationforObjectorientedDatabaseSystemsTechnicalReportUniversityofMilanoBertinoEFoscoliPIndexOrganizationsforObjectorientedDatabaseSystemsIEEETransonKnowledgeandDataEngineeringBertinoEKimWIndexingTechniquesforQueriesonNestedObjectsIEEETransonKnowledgeandDataEngineering 收稿 日期 ：