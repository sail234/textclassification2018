计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 　 第卷 　 第期 　 Vol 　 No 　 自动 并行 库中 基于 存储转发 机制 的 通信 优化 祝明 　 胡永刚 　 祝明发 　 张兆庆 　 　 摘 　 要 　 文中 工作 是 在 曙光 上 的 PVM 环境 中为 自动 并行 识别系统 AutoPar 实现 的 ， 介绍 的 是 数据 收集 函数 Collect 算法 及其 设计 优化 以及 对 原有 算法 所作 的 结构性 改进 ， 主要 思想 是 将 存储转发 机制 引入 到 数据 收集 算法 中 ， 从而 省去 了 大量 的 数据 填充 及 抽取 操作 ， 并 防止 了 由此 产生 的 数据 收集 错误 众所周知 ， 通信 问题 在 并行机 系统 中是 关键问题 ， 因此 ， Collect 效率 的 高低 直接 关系 到 AutoPar 的 加速 比 采用 本 算法 后 ， 其 效率 成倍增加 　 　 关键词 　 并行 化 ， AutoPar ， PVM ， 数据 收集 算法 ， 存储转发 　 　 中图法 分类号 　 TPCOMMUNICATIONOPTIMIZATIONOFPARALLELLIBRARYBYSTOREANDFORWARDMECHANISMZHUMingHUYongGangZHUMingFaandZHANGZhaoQingNationalResearchCenterofIntelligentComputingSystemsInstituteofComputingTechnologyChineseAcademyofSciencesBeijingResearchCenterofHighPerformanceComputersInstituteofComputingTechnologyChineseAcademyofSciencesBeijing 　 　 Abstract 　 TheworkinPVMsenvironmentontheDawningsystemisrealizedfortheautomaticparallelrecognitionsystemAutoParIntroducedhereisthedatacollectionfunctionCollectsalgorithmanditsdesignoptimizationandthestructureimprovementoftheoriginalalgorithmCollectalgorithmanditsdesigninAutoParsparallelcommunicationlibrarybasedonPVMarestudiedandanewalgorithmandstoreandforwardmechanismarefoundtoimplementCollectwhichisfasterthanitsoriginaloneBecauseitemphasizesparticularlythecommunicationamongprocessorsCollectwillinfluencethespeedupofAutoParatDawningItsmajorideaistointroducethesavetransmitmechanismintothedatacollectionalgorithmreducingalargenumberofdatafillsinanddrawsoutoperationandpreventingthedatacollectionmistakesfrombeingproducedAseveryoneknowsthecommunicationprobleminrunningparallelmachinesystemisavitalproblemsotheheightofCollectsefficiencydirectlyconcernshowthequickeningofAutoPariscomparedAfterthealgorithmisuseditsefficiencyisdoubledthroughrealtesting 　 　 Keywords 　 parallelizationAutoParPVMcollectalgorithmstoreandforward 　 引言 　 　 高性能 计算 一般 是 以 其 高速 的 硬件 系统 为 基础 的 而 计算机系统 性能 的 整体 改善 在 很大 程度 上 却是 取决于 其 软件 性能 的 提高 为了 充分发挥 高性能 计算机所 提供 的 高速 计算 性能 利用 自动 并行 重构 技术开发 超级 编译器 已 成为 计算机软件 的 重要 研究课题 在 这 一 领域 代表性 的 系统 有 ： Rice 大学 的 FPPSIllinois 大学 的 PARADIGM ， IBM 的 PTRANStanford 大学 的 SUIF 等 近年来 对 并行 重构 的 研究 大多 是 针对 Fortran 源程序 的 ， 这 主要 是因为 Fortran 作为 一种 科学计算 语言 ， 积累 了 大量 的 应用程序 对 串行 的 Fortran 源程序 做 源源 变换 ， 将 其 转换 为 带 并行 代码 的 扩展 Fortran 源程序 曙光 计算机系统 配置 的 自动 并行 识别系统 AutoPar 就是 对 Fortran 源程序 做 源源 变换 本文 是 以 曙光 计算机系统 配置 的 自动 并行 识别系统 为 研究 背景 ， 主要 介绍 其 PVM ［ ］ 并行 通信 库中 ［ ］ 至关重要 的 数据 收集 功能 函数 的 算法 设计 它 针对 SPMD 并行程序 的 需求 采用 了 存储转发 的 思想 ， 使得 其 算法 流程 中 的 关键 路径 大大缩短 ， 其 效率 比 已 做 了 大量 优化 的 前 算法 ［ ］ 成倍 提高 本文 对 其 收集 函数 Collect 的 优化 算法 作 了 详细 的 介绍 　 基于 存储转发 机制 的 Collect 算法 　 Collect 的 算法 框图 　 　 用户程序 并行 化后 ［ ］ ， 势必 要 进行 循环 分割 运算 ， 这 就 导致 各 节点机 只有 部分 数据 参加 运算 ， 而 数据 的 其它 部分 则 要 从 其它 节点 上 得到 ， 即作 数据 收集 操作 下面 给出 其 算法 框图 　 原 算法 框图 　 　 从图 的 原 算法 框图 中 可以 看出 ， 在 算法 流程 的 关键 路经 上 ， 有 较 多 的 等待 延迟 和 通信 延迟 ， 因此 ， 影响 了 原 算法 的 优化 性能 在 随后 作者 提出 的 新 算法 框图 中 ， 上述 延迟 大大减少 图 　 原 算法 框图 　 新 算法 框图 　 　 新 算法 是 基于 存储转发 的 思想 ， 主机 把 各个 从机 的 有效 数据 存储 在 其 动态 申请 的 内存 中 ， 然后 ， 再 将 其 广播 至 各个 从机 从而 ， 省去 了 前 算法 的 多次 发送 接收 操作 以及 主机 上 的 数组 填充 ， 集成 处理 参见 图 图 　 新 算法 框图 　 Collect 的 算法 描述 　 　 在 这里 ， “ rangeinformation ” 就是 “ 数组 界 ” ； “ copythedatamodifiedbyitselftoadatabuffer ” 就是 “ 数组 集成 ” “ fillinthedatatoitslocalarrayfortheneweststatus ” 就是 “ 数组 填充 ” 　 Collect 原 算法 　 　 收集 函数 Collect 的 算法 描述 ： intAUTOPARCOLLECT 　 　 ifthisprocessismaster 　 　 　 ① 　 receivetherangeinformationofarraydatafromallothernodes 　 　 ② 　 broadcastallrangeinformationreceivedfromallothernodes 　 　 ③ 　 receivethedataofarrayfromallothernodes 　 　 ④ 　 fillinthedatatoitslocalarrayfortheneweststatus 　 　 ⑤ 　 calculatedtheminimumandmaximumrangeinformationforeverydimofthewholearrayandthencopythedataofthespecifiedrangeofthearraytoadatabuffer 　 　 ⑥ 　 broadcastthedatabuffertoallothernodes 　 　 　 　 　 elsethisprocessisaslave 　 　 　 　 　 ① 　 senditsrangeinformationofarraydatatothemaster 　 　 　 ② 　 receiveallrangeinformationfromthemaster 　 　 　 ③ 　 copythedatamodifiedbyitselftoadatabuffer 　 　 　 ④ 　 sendthedatabuffertothemaster 　 　 　 ⑤ 　 receivethenewestdataofthewholearrayfromthemaster 　 　 　 ⑥ fillinthenewestdatatoitslocalarraytokeeptheneweststatusofthearray 　 　 　 　 　 　 　 在 此 算法 流程 中 ， 关键 路径 上 共有 次 send ＿ receive 调用 ， 次 Collect ＿ local ＿ data 和 次 Fill ＿ data ， 尽管 这 两个 子函数 在 算法 上 已 做 了 大量 改进 ［ ］ ， 但是 由于 频繁 的 调用 和 通信 ， 导致 其 性能 的 下降 作者 在 分析 了 上述 的 算法 流程 后 ， 巧妙 地 引入 了 存储转发 机制 ， 大大降低 了 通信 开销 ， 从而 使 其 效率 成倍 提高 下面 就 来 讨论 新 算法 　 Collect 新 算法 　 　 首先 ， 简要 介绍 一下 新 算法 所 需 的 数据结构 数据 长度 数组 维 边界 信息 处理机 号 数组 数据 　 　 上述 数据结构 将 由 主机 申请 并 使用 ， 从机 将 其 数据 发送到 主机 ， 主机 将 各 从机 的 数据 按 上述 数据结构 拼装 ， 拼装 完毕 后 ， 主机 将 其 广播 至 各个 从机 ， 从机 再 根据 “ 处理机 号 ” ， 把 其他 从机 的 数据 填充 到 它 本身 的 数组 中 　 　 　 　 采用 此新 算法 ， 从 逻辑 上 可知 其 效率 将会 成倍增加 而且 其 实际 效率 也 确实 如此 Newalgorithm 　 　 ifthisprocessisamaster 　 　 　 ① 　 mallocalargememoryasthedatabufferandcopyitslocalnewestdatatodatabuffermeantimefillits ‘ processor ＿ num ’ tothecorrespondentposition 　 　 ② 　 receivetherangeinformationandthemodifieddataofthearrayfromallothernodes 　 　 ③ 　 accordingtotherangeinformationofeverynodefillinitsnewestdatatoitslocalarrayforitsneweststatus 　 　 ④ 　 broadcastthedatabufferwhichincludesallnewestrangeinformationofdataofeverynode 　 　 　 elsethisprocessisaslaver 　 　 　 ① 　 copyitsnewestrangeinformationanddataofitsarraytoalittledatabuffermeantimefillits ‘ processor ＿ num ’ toitscorrespondentpositioninthebuffer 　 　 ② 　 sendthemessageindatabuffertothemaster 　 　 ③ 　 mallocalargememoryasthedatabuffer 　 　 ④ 　 receivethebroadcastmessagefromthemaster 　 　 ⑤ 　 accordingtotherangeinformationand ‘ processor ＿ num ’ inthebroadcastmessagefillinthenewestdatatoitslocalarraytokeepitsdatavalidate 　 　 　 在 此 算法 流程 中 ， 关键 路径 上 ， 共有 次 send ＿ receive 调用 ， 次 Collect ＿ local ＿ data 和 次 Fill ＿ data 可见 ， 存储转发 的 引用 ， 使得 通信 开销 大大降低 从而 ， 将 大大提高 程序 并行 化 的 效率 　 新 算法 的 效率 　 　 下面 以 一个 × × 的 三维 数组 运算 为例 ， 下面 的 数据 来自 国家 智能机 中心 的 曙光 机 ＿ Plus 上 　 　 　 　 源 ＿ 源 变换 后 × × 的 三维 数组 运算 的 部分 Fortran 并行 代码 ， 其中 含有 对 AUTOPAR ＿ COLLECT 的 调用 ： 　 　 　 S 　 　 　 DOM 　 　 　 SSD 　 　 　 CALLF ＿ AUTOPAR ＿ LOOP ＿ SPLITF ＿ AUTOPAR ＿ LOOP ＿ STARTF ＿ AUTOPAR ＿ LOOP ＿ END 　 　 　 　 　 DOJF ＿ AUTOPAR ＿ LOOP ＿ STARTF ＿ AUTOPAR ＿ LOOP ＿ END 　 　 　 　 　 DOI 　 　 　 　 　 AIJM 　 　 　 CONTINUE 　 　 　 CONTINUE 　 　 　 CALLF ＿ AUTOPAR ＿ SET ＿ RANGE ＿ D 　 　 　 CALLF ＿ AUTOPAR ＿ SET ＿ RANGE ＿ UD 　 　 　 CALLF ＿ AUTOPAR ＿ SET ＿ RANGE ＿ DMM 　 　 　 CALLF ＿ AUTOPAR ＿ LAYOUTA 　 　 　 CALLF ＿ AUTOPAR ＿ COLLECTA 　 　 其 运行 时间 统计 对 比如 表 所示 ： 表 　 机器 结点 数新 算法 秒 原 算法 秒 加速 比 　 　 从 这个 小 例子 就 可以 看出 此 算法 的 效率 较原 算法 已 大大提高 而且 ， 随 计算 量 和 处理机 数量 的 增加 ， 其 优势 更能 得到 体现 表 所示 是 一些 大型 BENCHMARK 测试数据 环境 为 PVM ， 节点 数为 ： 表 　 BENCHMARK 新 算法 秒 原 算法 秒 加速 比 BWSRWLG 　 　 注 ： 　 　 ① BENCHMARK （ B ） 的 NUMBEROFSTEPS 为 　 　 　 　 ② WSRSOLVESTHEEULEREQUATIONSINGENERALIZEDCURVILINEARCOORDINAUSINGANIMPLICITFINITEDIFFERENCEALGORITHMWITHAPPROXIMATEDFACTORIZATIONANDADIAGONALIZATIONOFTHEIMPLICITOPERATORS 　 　 ③ WLGISPUREGAUGESUMONTECARLO 　 结 　 论 　 　 综上所述 ， 由于 将 存储转发 机制 引入 到 数据 收集 算法 中 ， 省去 了 大量 的 数据 填充 及 抽取 操作 ， 不但 防止 了 由此 产生 的 数据 收集 错误 ， 而且 大大降低 了 通信 开销 采用 本 算法 后 ， 其 总体 效率 比 曙光 AutoPar 的 α 版本 提高 了 很多 ， 为 曙光 AutoPar 的 最终 实用化 奠定 了 基础 本 课题 得到 国家 高技术 “ 八 六三 ” 项目 基金 资助 作者简介 ： 祝明 ， 男 ， 年月生 ， 助理 研究员 ， 硕士 ， 主要 从事 计算机 算术 运算 、 高速 电子线路 计算机网络 方面 的 研究 　 　 　 　 　 胡永刚 ， 男 ， 年月生 ， 助理 研究员 ， 硕士 ， 主要 从事 自动 并行 编译 识别 工具 和 NT 机群系统 开发 研究 　 　 　 　 　 祝明发 ， 男 ， 年月生 ， 研究员 ， 主要 从事 高性能 并行 计算机 的 研究 开发 　 　 　 　 　 张兆庆 ， 女 ， 年月生 ， 研究员 ， 主要 从事 自动 并行 编译 识别 工具 的 研究 开发 作者 单位 ： 祝明 　 祝明发 　 张兆庆 　 中国科学院计算技术研究所 智能机 研究 开发 中心 　 北京 　 　 　 　 　 　 　 　 胡永刚 　 中国科学院计算技术研究所 高性能 计算机 研究 中心 　 北京 　 参考文献 　 　 　 PVMUsersGuideandReferenceManualDepartmentofComputerScienceUniversityofTennesseeKnoxville 　 　 　 ASPAR — — AnAutomaticParallelizerforCProgramsParasoftCorporationPasadena 　 　 　 CytronRCompiletimeschedulingandoptimizationforasynchronousmachines ［ PhDdissertation ］ UniversityofIllinoisatUrbanaChampaignIllinois 　 　 　 WolfeMDatadependenceandprogramrestructuringTheJournalofSupercomputer ～ 原稿 收到 日期 ： ； 修改稿 收到 日期 ：