微型机 与 应用 MICROCOMPUTERITSAPPLICATIONS 年 第卷 第期 VolNo 虚拟 设备 驱动程序 VxD 的 开发 何 海波 　 成建波 　 张 　 浩 　 　 摘 　 要 ： 虚拟 设备 驱动程序 的 基本概念 和 几种 常用 的 开发工具 ， 并 对 它们 的 使用 进行 了 简略 的 评述 。 　 　 关键词 ： WindowsNT 　 虚拟 设备 驱动程序 VxD 　 DDK 开发包 　 VToolsD 工具箱 　 WinDriver 工具包 　 虚拟 设备 驱动程序 　 　 设备 驱动程序 是 管理系统 软硬 资源 的 二进制 可 执行 代码 。 它 是 个位 保护模式 下 的 可 执行 DLL ， 在位 的 Windowsx 中 ， VxDs 一般 具有 后缀名 ， 并且 在 SYSTEMINT 文件 的 ［ Enh ］ 节中 静态 地 加载 。 在 Windows 中 ， 由于 即插即用 的 引入 ， VxD 的 功能 也 被 增强 了 。 现在 VxD 可以 动态 地 加载 或 卸载 ， 以 节省 系统资源 。 在 很大 程度 上 VxD 起到 了 原来 BIOS 的 作用 。 　 　 VxD 中 的 “ x ” 代表 “ 某些 ” ， VxD 是 虚拟 设备 驱动程序 的 统称 ， VxD 对 硬件 设备 进行 虚拟化 ， 软件 可 通过 VxD 的 服务 来 使用 相应 的 设备 。 　 　 所有 的 VxD 的 运行 都 处于 Windows 虚拟机 管理器 VirtualMachineManagementVMM 的 监控 下 。 VMM 包含 了 所有 基本 的 系统 功能 ， 如 任务调度 、 虚拟内存 操作 、 程序 装入 及 终止 、 任务 间通信 ， 此外 ， 还 负责 处理 主要 的 中断 处理 及 例外情况 。 正是 VMM 和 VxD 构成 了 Windows 的 系统核心 。 　 开发工具 介绍 　 　 DDKDeviceDriverKit 　 　 DDK 是 Microsoft 公司出品 的 设备 驱动程序 开发包 ， 有 WindowsNT 个 版本 。 用 它 开发 VxD ， 需要 对 WindowsNT 的 系统结构 、 VxD 的 构成 、 VMM 的 功能 有 较 深入 的 认识 ， 并且 还要 有 一定 的 汇编语言 编程 经验 。 　 　 VToolsD 工具箱 　 　 组成 。 VToolsD 是 美国 VireoSoftware 公司 开发 的 用于 编写 设备 驱动程序 的 工具包 。 它 包括 个 可视化 VxD 代码生成 器 QuickVxD 、 可 加载 和 卸载 VxD 的 工具 VxDLoad 、 可 给出 系统 加载 VxD 时 的 系统 信息 的 VxDView ， 以及 ANSIC 运行库 、 VMMVxD 服务 库 、 VxD 的 C 类库 。 此外 ， VToolsD 还 为 刚 接触 它 的 新手 提供 了 大量 的 C 或 C 例程 。 　 　 在 编写 过程 中 ， 绝大多数 的 VMM 和 VxD 的 服务 都 可以 通过 类库 中 的 成员 函数 来 实现 。 由于 VToolsD 在 这些 类中 封装 了 一些 任务 ， 节省 了 大量 的 编程 时间 ， 同时 也 减少 了 错误 的 发生 。 即使 是 运用 它 的 C 运行库 ， 也 可以 使 编程 效率 大大提高 。 　 　 应用 。 首先 运行 QuickVxd 程序 。 　 　 对于 开发人员 来说 ， QuickVxD 是 种 可以 自动 生成 VxD 基本 框架 的 表 格式 工具 。 它 使 你 能够 快速 开始 编写 个 新 的 VxD ， 而 无需 了解 太多 VxD 的 低层 细节 。 只要 正确 定义 好 设备 名 、 控制 消息 以及 其他 一些 文件名 和 类名 后 ， QuickVxD 便 可以 生成 个 MAKE 文件 、 个头 文件 和 个 包含 VxD 框架 的 C 或 C 的 程序 文件 。 一般 设备 ID 和 设备 初始 序号 分别 使用 缺省值 。 　 　 完成 了 VxD 框架 构成 后 ， 则 需要 在 其中 加入 自己 的 代码 ， 以 最终 实现 所 需 的 功能 。 在 这里 要 特别 注意 以下 几条 Windows 控制 消息 ： SYSDYNAMICDEVICEINIT 和 SYSDYNAMICDEVICEEXIT ， 它们 分别 是 VxD 程序 动态 加载 和 卸载 时 的 控制 消息 ； WDEVICEIOCONTROL 则 是 当 应用程序 调用 CreateFile 或 DeviceIoControl 函数 时 ， 系统对 特定 的 VxD 发出 的 消息 ， 它 为位 应用程序 提供 了 个 利用 VxD 服务 的 途径 。 　 　 此外 ， VToolD 类库 中有 个 基本 的 类 非常 主要 ： VDevice 、 VVirtualMachine 、 VThread 。 其中 VDevice 的 成员 函数 用于 响应 VMM 或 由 其他 VxD 传来 的 消息 ， 所有 使用 VToolD 类库 的 VxD 程序 都 必须 从 VDevice 类中 派生 。 VVirtualMachine 和 VThread 则 提供 基于 虚拟机 和 线程 的 控制 消息 函数 。 如果 要 想 利用 其他 一些 VMMVxD 的 服务 ， 例如 中断 、 DMA 、 热键 、 IO 端口 、 内存 分配 、 定时 、 事件处理 等等 ， VToolD 类库 中 还 实现 了 多个 类以 实现 这些 服务 。 　 　 值得一提的是 ， VToolsD 提供 了 个 inf 文件 编写 工具 INFEditor ， 使用 它 可以 轻松 地 编写 inf 文件 。 　 　 编译 与 调试 。 使用 VisualC 的 NMAKE 或 BorlandVc 的 MAKE 都 可以 用来 编译 。 在 调试 过程 中 ， NumegaTechnologies 公司 的 SoftICEforWindows 以其 方便 的 中断 功能 正 被 广泛 地 使用 。 当然 ， VToolsD 工具箱 中 的 MicrosoftWDEB 也 是 个 不错 的 调试 工具 。 　 　 ． WinDriver 工具包 　 　 组成 。 WinDriver 是 美国 KRFTech 公司出品 的 用于 编写 驱动程序 的 另 一种 工具包 。 它 包括 个 类似 于 QuickVxD 的 代码生成 器 WinDriverWizard 、 个 WinDriver 发行 包 、 个 公用 程序 pciscanexe 、 pcidumpexe 和 一些 例程 ， 其中 pciscanexe 可以 给出 安装 的 PCI 卡及 系统 为 它们 分配资源 的 列表 ， pcidumpexe 则 负责 得到 已 安装 PCI 卡 的 系统配置 信息 。 　 　 与 VToolsD 一样 ， WinDriver 工具包 的 优点 在于 可以 使 编程人员 用 C 或 C语言 来 编写 设备 驱动程序 ， 而 不是 将 大量 精力 放在 编写 那些 复杂 的 、 难于 调试 的 内核 模式 代码 。 　 　 应用 。 首先 从 运行 WinDriverWizard 开始 。 　 　 WinDriverWizard 可以 让 你 立即 接触 到 硬件 而 不用 做 任何 事情 。 这种 便利 来自 它 的 自动检测 功能 ， 它会 自动 地 读写 卡上 的 内存 、 IO 地址 乃至 为 你 帧 听 中断 。 在此之后 ， 通过 选择 产生 代码 选项 ， WinDriverWizard 会为 你 的 卡 产生 基本 的 程序代码 。 而 我们 实际上 要 做 的 仅仅 是 选择 了 个 选项 而已 ， 其余 都 是 由 WinDriverWizard 自动 产生 的 。 　 　 WinDriver 提供 了 许多 例程 ， 使用者 可以 利用 它们 来 产生 自己 驱动程序 的 基本 框架 。 与此同时 ， 在 WinDriver 提供 的 在线 帮助 里 ， 可以 查 到 许多 WinDriver 提供 的 功能 函数 ， 这些 函数 能 方便 地 实现 中断 处理 、 DMA 传输 、 IO 操作 、 内存 映射 以及 即插即用 等 功能 。 　 　 这里 要 特别 注意 以下 几个 函数 ： WDOpen 、 WDClose 、 WDCardRegister 、 WDCardUnRegister 。 其中 前 二者 是 程序 在 开始 和 结束 时所 必须 调用 的 个 函数 ， 后 二者 则 负责 对卡 登记 的 建立 和 删除 以及 资源分配 和 释放 。 这里 的 资源 主要 指 的 是 中断 处理 、 IO 操作 和 内存 分配 。 　 　 编译 和 调试 与 VToolsD 基本相同 　 结 　 论 　 　 以上 介绍 的 种 工具 各有 优点 。 DDK 功能强大 ， 编程 灵活 ， 适用范围 广 ， 可 应用 于 各类 硬件 驱动程序 的 编写 ， 但 编程 难度 较大 ， 对 编程人员 的 要求 也 较 高 。 VToolsD 主要 工作 环境 是 在 Windows 下 ， 它 具有 较强 的 开发 能力 和 较 高 的 开发 效率 ， 是 个 非常 优秀 的 工具 。 WinDriver 的 适用 面要 较 前面 种 工具 窄 ， 它 主要 针对 ISAPCI 插卡 ， 而 对 其他 类 硬件 的 技术支持 较 少 ， 但 它 编写 的 程序 可 同时 工作 在 WindowsNT 种 操作系统 中 。 用户 在 选用 工具 时 ， 应 根据 自己 的 需要 正确 进行 选择 。 作者 单位 ： 西安交通大学 收稿 日期 ：