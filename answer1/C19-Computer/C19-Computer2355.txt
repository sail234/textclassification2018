计算机 研究 与 发展 JOURNALOFCOMPUTERRESEARCHANDDEVELOPMENT 年 第卷 第期 VolNo 运动 估计 芯片 中 降低 局存 与 脉动阵列 数据 宽度 的 设计 方法 傅宇卓 　 胡铭 曾 　 方滨兴 摘 　 要 　 文中 针对 运动 估计 芯片 中 极为重要 的 存储器 的 结构设计 ， 提出 了 一种 降低 局存 与 运算 阵列 端口数 的 设计 方法 ， 使局 存 的 控制结构 得到 极大 简化 文中 应用 这种 方法 ， 对 AB ， AS 结构 进行 改造 ， 得到 两种 具有 工程 实用性 的 新型 结构 端口数 的 降低 会 带来 运算 阵列 计算 效率 的 下降 ， 为此 又 推导 了 一个 平衡 端口数 与 计算 效率 的 公式 本文 研究 来自 于 实现 运动 估计 芯片 的 工作 中 ， 对 研究 MPEG 视频 编码器 的 VLSI 实时 实现 有 一定 的 参考价值 关键词 　 FBMA ， 运动 估计 ， 动态 存储器 ， 脉动阵列 中图法 分类号 　 TPAMETHODOFDECREASINGDATAWIDTHBETWEENCACHEANDSYSTOLICARRAYONMOTIONESTIMATIONCHIPFUYuZhuoHUMingZengandFANGBinXingDepartmentofComputerScienceandTechnologyInstituteofHarbinTechnologyHarbinAbstract 　 AimingatcachedesignwhichplaysanimportantroleinmotionestimationMEchipadesignmethodofdecreasingdatawidthbetweencacheandsystolicarraywhichsimplifiesdesignofcachecontrolTwonewarchitecturesonABandASareconstructedbyusingthenovelmethodDecreasingtheportnumberwillbringabouttheproblemoflowefficiencyAformulawhichshowsconnectionbetweenportnumberandcomputingtimecangiveatradeoffTheresearchresultcomingfromtheworkofMEchipsrealizationisbeneficialtotheworkofstudyingMPEGencoderKeywords 　 FBMAmotionestimationdynamicmemorysystolicarray 　 引 　 言 　 　 实时 运动 估计 芯片 作为 MPEG 压缩 编码 的 关键 部分 ， 其 研究 随着 通信 、 存储 、 广播 、 高清晰度电视 的 发展 ， 已经 越来越 多地 为 世界 各大 公司 所 重视 继 ST 公司 推出 三片 型 的 STi ［ ］ 之后 ， IBM 最近 又 推出 单片 型 ME 芯片 MPEGS ［ ］ ， 与此同时 ， SONY 也 有 像 CXDQ ［ ］ 这样 的 主打产品 　 　 全 搜索算法 fullsearchblockmatchalgorithm ， 简称 FBMA 是 运动 估计 中 的 基础 算法 ， 从 理论 上 讲 ， 它 是 匹配 效果 最好 的 算法 ［ ］ 在 FBMA 中 ， 已 传输 的 图像 称为 先前 帧 ， 将要 传输 的 帧 为 当前 帧 每 帧 图像 划分 成 N × N 的 宏块 ， 当前 帧 的 每 一个 宏块 称为 参考 块 ： referenceblock 与 先前 帧 中 对应 搜索 区域 的 宏块 称为 候选 块 ： candidateblock 进行 匹配 计算 ， 找出 最佳 匹配 块 ， 输出 其 行列 坐标 称为 运动 向量 ： motionvector 　 　 按照 SYHung 提供 的 数据 相关 图 的 设计 方法 ［ ～ ］ ， ThomasKomark 已经 描述 了 一族 基于 FBMA 脉动阵列结构 ［ ］ 在 工程 中 ， 为了 达到 具体 应用 的 估计 时间 、 外存 存取时间 等 指标 ， 结构 设计者 除了 寻找 一种 易于 VLSI 实现 的 运算 阵列 之外 ， 一个 更为重要 的 问题 ： 进行 与 结构 密切相关 的 局部 存储器 结构 及 控制 的 复杂性 的 考虑 　 　 对于 脉动阵列 的 结构 选择 ， 十分 重要 的 一点 是 送入 阵列 的 数据流 能否 便于 实现 由于 大部分 脉动阵列 ［ ］ 是 通过 多 端口 送入 数据 的 ， 这 就 要求 局存 的 设计 也 要 满足 这一 特征 ， 若 数据流 的 次序 与 存储器 顺序 性 特征 差别 过大 ， 则 对 存储器 要求 更 多 、 调度 也 更 复杂 　 　 局存 数据 从单 端口 灌入 阵列 是 一种 控制 简单 的 方案 SYKUNG 在 讨论 把 二维 相关 图 映射 到 一维 信号流图 时 ， 曾 提出 一种 消除 位于 中间 节点 IO 边 的 方法 ［ ］ ， 这种 方法 只能 用 在 二维 相关 图中 对于 更 高维 的 相关 图 ， 这种 映射 方法 是 不能 将 IO 边 映射 到 边界 的 某 一点 上 的 为此 ， 需要 为 IO 再 做 一次 单独 映射 　 　 本文 第节 形式化 描述 这一 映射 方法 并 证明 这种 映射 方法 的 正确性 ； 第节 应用 这一 方法 改造 AB ， AS 结构 ［ ］ 并 给出 平衡 数据 宽度 和 运算 时间 的 公式 ； 第节 概述 局存 和 延迟 寄存器 的 动态 存储器 实现 方案 　 降低 局存 与 运算 阵列 数据 宽度 的 方法 　 　 我们 用 表示 一个 具有 两 输出 端口 的 模型 在 时刻 i 的 端口 输出 ， 且 端口 输出 数据 为 m ， 端口 输出 数据 为 n 其中 ， D 为 输入 数据 的 定义域 ， Δ 为 无效 数据 有 了 这种 表示 方法 ， 我们 就 可以 描述 降低 端口数 的 过程 为了 说明 变换 后 的 端口 模型 能够 起到 和 原 模型 一样 的 作用 ， 我们 首先 做 两个 定义 ： 　 　 定义 对于 两 输出 端口 模型 A ， 若 存在 一段 连续 时刻 的 输出 序列 ： 　 ， 有 mpnp 至少 有 一个 不 等于 Δ ， 则 称 这 一序列 为 A 的 有效 输出 　 　 定义 两 输出 端口 模型 A ， B 的 有效 输出 分别 为 如果 存在 下述 对应 关系 ： 　 　 如果 mi ≠ Δ 则 mixi 否则 xi 为 D ∪ ｛ Δ ｝ 中 任意 值 ； 　 　 如果 ni ≠ Δ 则 niyi 否则 yi 为 D ∪ ｛ Δ ｝ 中 任意 值 ， 则 称 B 可以 完成 A 　 　 定理 两 输出 端口 模型 A 的 有效 输入 为 见 图 A 则 通过 变换 有效 输入 见图 B 得到 的 两 输出 端口 模型 B 可以 完成 A ， 其中 Ln Ω 　 　 证明 我们 只 考虑 输入 端口 数据 都 有效 的 情况 ， 其他 几种 情况 类似 　 　 对于 模型 A 有效 输入 中 的 ； 在 模型 B 中 ， 当 α i 出现 于 端口 时 ， 出现 于 端口 的 数据 β j ′ 的 下标 关系 为 ， 因此 为 模型 B 有效 序列 中 的 元素 　 　 推论 两 输出 端口 模型 A 的 有效 输入 为 见 图 A 图 　 第一类 映射 方法 则 通过 变换 有效 输入 见图 B 得到 的 两 输出 端口 模型 B 可以 完成 A ， 其中 Ln Ω 图 　 第二类 映射 方法 其 证明 与 上 一个 定理 的 证明 类似 ， 不再 赘述 　 　 事实上 ， 我们 正是 通过 这种 方法 来 改造 AB ， AS 结构 的 另外 ， 端口数 的 降低 必须 导致 数据 输出 时间 的 增加 ， 因此 时间 增加率 τ 成为 评价 结构 改造 的 指标 之一 　 　 其中 ， Δ T 为 映射 后 增加 的 运算 时间 ； T 为 数据流 完成 输入 的 时间 mn Ω 见图 ， l 表示 数据流 输入 中 去除 延迟 和 公用 数据 后 完成 输入 所 需 时间 　 　 我们 总是 期望 τ 尽可能 小 ， 因此 公式 告知 了 一个 变换 准则 ： ① 选择 数据 扭斜 大 Ω 大 的 端口 作 映射 ； ② 选择 公用 数据 多 m 大 的 端口 作 映射 　 　 由于 脉动阵列 的 数据 输入 中 端口 间 可 重用 数据 多 ， 数据 扭斜 输入 即 m Ω 较大 ， 使用 推论 所 描述 的 方法 可以 带来 较 好 的 性能 提高 　 以 AB 结构 为例 的 改造 过程 和 效率 分析 　 AB 结构 的 改造 　 　 对于 图 图 、 图中令 NpN 为宏块 的 尺寸 ， p 为 搜索 区域 的 尺寸 结构 来说 ， 从 A 输入 的 数据 扭斜 最大 ， 因此 将 其它 端口 的 数据 向 这 一 端口映射 映射 的 方法 参照 推论 提供 的 过程 ， 沿 j 增加 的 方向 逐行 映射 ， 直至 A 为止 需要 说明 的 是 ， 每 经过 一次 映射 ， 未 映射 到 的 端口 输入 需要 推迟 LN Ω np 个 单位 　 　 这样 我们 就 得到 了 图 所示 的 结构 它 的 好处 是 能够 使 搜索 区域 局存 的 数据 从 一个 端口 顺序 流入 ， 这种 控制 输入 的 方式 无疑 是 简单 的 　 　 数据 带宽 降低 同时 也 带来 负面影响 ： 由于 数据 的 准备 时间 增加 ， 阵列 的 计算 效率 下降 ， 计算 时间 增加 仍以 AB 为例 ， 要 达到 AB 结构 的 初始状态 ， 改造 后 的 结构 需要 经过 额外 Np × N 个 时钟 周期 ， 而 改造 后 结构 的 运行 时间 增长率 λ ： 图 　 AB 的 硬件 结构图 图 　 改造 后 的 AB ′ 硬件 结构 　 　 由此可见 ， 改造 后 结构 的 运行 时间 提高 了 近 ， 即 计算 的 数据 中有 一半多 是 无效 的 ， 这个 损失 很大 为此 可以 将 端口数 稍作 增加 ， 令 改造 后 的 端口数 为 γ ， 这一 参数 对 λ 的 影响 可以 从 下式 中 看到 式 是 我们 进行 端口映射 的 评价 指标 对于 N ～ p 的 情况 ， 比如 令 γ ， 此时 局存 从 两个 端口 向 运算 阵列 供数 ， 控制 不会 复杂 太 多 ， 而 λ ， 运行 时间 仅 增加 了 ， 效果 十分 显著 ， 因此 这是 一个 工程 可用 的 指标 　 AS 结构 的 改造 　 　 AS 结构 的 改造 过程 同 AB 是 一样 的 ， 因此 下面 只 列出 改造 后 结构 见图 ， 不再 具体 说明 需要 注意 的 是 ， 这种 结构 能够 在 更 短 的 时间 内 完成 计算 ， 因此 可以 应用 于 更 高 的 视频 标准图 　 改造 后 的 AS ′ 结构图 　 局存 和 延迟 寄存器 的 动态 存储器 实现 　 局存 的 动态 存储器 实现 　 　 在 实现 FBMA 的 结构 中 ［ ］ ， 由于 采用 了 单 端口 或 少数 端口 ， 使得 数据 从局 存中 顺序 读入 ， 如果 将 局存 设计 成 动态 存储器 ， 可以 利用 这种 读数 过程 完成 刷新 的 工作 仍以 AB 为例 ， 将 其 搜索 区域 局存用 动态 存储器 实现 其 刷新周期 为 读取 局存 一行 数据 的 时间 TNT 其中 ， T 为 运算 阵列 的 工作 周期 ， ， 这种 情况 下 ， 片上 动态 局存 的 数据 挥发 时间 不能 低于 ns 。 　 　 动态 存储器 的 局存 设计 ， 可以 节省 至少 的 芯片 面积 和 功耗 ［ ］ 而 设计 实现 时 ， 不 需要 刷新 电路 ， 不 需要 进行 行选 、 列选 ， 其 性能 价格比 远 优于 静态 存储器 设计 　 延迟 寄存器 的 动态 存储器 实现 　 　 在 算法 映射 到 结构 的 过程 中 ［ ］ ， 为了 达到 局部 通信 的 目的 ， 引入 了 大量 的 延迟 寄存器 ； 当 降低 阵列 输入 数据 宽度 时 ， 这一 数目 愈加 庞大 ， 在 面积 、 功耗 方面 极大 地 影响 了 芯片 的 性能 由于 延迟 寄存器 每一 周期 都 保存 新 的 数据 ， 用 动态 结构 实现 更 经济 、 可 行为 此 可以 设计 一种 动态 存储单元 ， 其 面积 大约 是 λ 远 小于 λ 的 静态 触发器 ［ ］ 限于 篇幅 ， 不 在 本文 展开 阐述 　 结 　 论 　 　 运动 估计 芯片 的 结构设计 中 ， 局存 的 结构设计 十分 重要 有时 尽管 得到 的 结构 有着 非常 好 的 性能 ， 但是 由于 其 供应 数据 复杂 而 导致 局存 设计 困难 ， 最终 让 设计者 放弃 这种 结构 ， 为此 本文 给出 了 一种 降低 局存 与 阵列 间 数据 宽度 的 方法 ， 降低 了 局存 设计 的 复杂度 ； 另一方面 ， 实现 FBMA 的 多个 结构 往往 输入 带宽 不同 ， 使 设计者 很难 相互 比较 ， 而 将 其 映射 成 相同 带宽 时 ， 相互 比较 无疑 会 更 客观 　 　 在 具体 应用 这种 方法 时 依据 两个 变换 准则 ， 尽可能 降低 时间 开销 ； 为了 在 运算 时间 和 通信 端口数 之间 进行 折衷 ， 以式 作为 端口映射 的 评价 指标 　 　 AB ， AS 是 运动 估计 中 基于 FBMA 的 两个 基本 运算 阵列 ， 本文 在 这 两个 阵列 上 施加 端口映射 变换 ， 得到 两个 适用性 极强 的 新型 结构 　 　 映射 变换 使得 局 存有 了 顺序 读写 的 特性 ， 这 使得 局存 的 动态 存储器 实现 变得 简单 ； 另一方面 ， 尽管 运动 估计 芯片 中 存在 着 大量 延迟 寄存器 ， 也 可以 通过 动态 设计 降低 开销 基金项目 ： 本 课题 得到 国家 “ 八 六三 ” 计划 基金 资助 项目编号 作者简介 ： 付宇卓 ， 男 ， 年月生 ， 博士 研究生 ， 研究 方向 为 图像 压缩算法 设计 与 实现 、 VLSI 设计 、 计算机系统 结构 胡铭 曾 ， 男 ， 年生 ， 教授 ， 博士生 导师 ， 研究 方向 为 高性能 计算机 体系结构 方滨兴 ， 男 ， 年月生 ， 教授 ， 博士生 导师 ， 研究 方向 为 高性能 体系结构 、 并行 编译器 等 作者 单位 ： 傅宇卓 　 胡铭 曾 　 方滨兴 　 哈尔滨工业大学 计算机科学 与 技术 系 　 哈尔滨 　 参考文献 　 VirtusoBCXDQAnindustrybreakthroughinMPEGtechnologyhttpwwwselsonycomsemiaudiovidhtm 　 httpeustcomstonlinebooksindexhtm 　 httpwwwibmcomproductsindexhtm 　 TekalpAM 数字视频 处理 北京 电子 工业 出版社 ， TekalpAMDigitalVideoProcessinginChineseBeijingElectronicIndustryPress 　 HungSYVLSIArrayProcessorsEnglewoodCliffsNJPrenticeHall 　 KungHTWhySystolicArchitectureIEEEComputer ～ 　 KomarekTPirschPArrayarchitecturesforblockmatchingalgorithmIEEETransCircuitsandSystems ～ 　 傅宇卓 基于 MPEG 运动 估计 芯片 的 结构设计 哈尔滨工业大学 ［ 硕士论文 ］ ， FuYuzhuoThearchitecturedesignofmotionestimationchipwhichsupportsMPEG ［ Masterdissertation ］ HarbinInstituteofTechnology 　 PuncknellDAEshraghianK 超大规模 集成电路 设计 基础 北京 ： 科学出版社 ， PuncknellDAEshraghianKTheDesignofVLSIinChineseBeijingSciencePress 收到 日期 ： 修改 日期 ：