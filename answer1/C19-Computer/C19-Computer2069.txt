计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 基于 C 的 HSI 替代 串行口 数据 采集 与 处理 系统 史 清华 摘要 提出 了 一个 高性能 IntelC 特有 的 HSI 替代 串行 输入 中 多通道 串行 数据 采集 与 处理 系统 的 设计方案 ， 并 介绍 了 与 该 方案 相匹配 的 信号 捕捉 ， 位 同步 及 差错控制 算法 。 关键词 数据 采集 HSI 监控 同步 数据 校对 TheHSIReplacesSerialPortDataSampleandProcessSystemBasesonCShiQinghua （ DepartmentofComputerScienceandTechnology ， ShandongUniversityofTechnologyJian ） AbstractthearticledemonstratesthedesigningplanofHISReplacesSerialPortMultichannelSerialDataSampleandProcessingSystembasesonhighperformanceIntelC ， andtakesdetaileddiscussionaboutsignalcapture ， bitsynchronizationanderrorcontrolmethod 。 KeywordsDatasample ； HSI ； Supervisory ； Synchronizationdata ； Cahecking 　 　 在 工业 控制 领域 ， 由于 IO 接口 在 空间 上 分布 的 离散性 以及 站点 多 、 数据量 大 等 特点 ， 现场 数据 既 需要 就 地 和 实时 的 处理 ， 又 需要 远动 中心 的 监视 与 遥控 ； 因此 ， 用 多个 CPU 构成 分布式 监控 系统 已 成为 过程 控制技术 发展 的 必然趋势 。 为了 提高 整个 监控 网 的 质量 ， 有利于 分站 数量 的 灵活 扩充 ， 采用 新一代 IntelCCPU 所 特有 的 路 HSI 通道 替代 串行 输入 口 的 设计 手段 ， 同步 通信 的 软件 位 锁相 算法 具有 一定 特色 ， 保证 了 新一代 监控 网 的 各 方面 要求 。 通用 多路 数据 采集 与 处理 系统 的 设计 与 实现 硬件 设计 　 　 在 分布式 监控 系统 中 ， 各 工作 站点 数据 的 产生 具有 并发 特点 ， 因此 ， 采集 单元 应 采用 集中 、 并行 的 数据 接收 方式 ； 若用 常规 方法 利用 串行 通信 芯片 实现 多通道 接收 ， 硬件 开销 较大 ； 并且 系统 CPU 被 频繁 中断 ， 会 影响 系统 程序 的 运行 效率 ， 当 RTU 数量 增多 时 ， 甚至 会 产生 瓶颈 阻塞 现象 。 因此 ， 本 系统 使用 一片 CCPU 代替 片 ， 设计 了 通道 数据 采集 与 处理 系统 。 该 系统 可 同时 接收 个 通道 传送 来 的 信息 ， 设计 允许 的 数据 传送 速率 为 波特 。 多通道 数据 采集 与 处理 系统 采集 单元 原理 框图 见图 ， 完成 以下 任务 ： 图 多通道 数据 采集 与 系统 原理 框图 （ 略去 键盘 与 LED 电路 ） 　 　 多路 模数转换 ； 　 　 多路 串行 同步 数据 接收 ； 　 　 软件 完成 位 锁相 并 在 失步 的 情况 下 自动 搜索 同步 字头 ； 　 　 支持 向 工业 控制 通信网 传送 实时 数据 信息 具备 两种 标准 串行接口 。 　 　 采用 ACH 端 做 为模 似量 的 输入 口 ， 使用 了 多个 多路 选择器 ， 可 输入 路 的 模拟信号 ； 而 由于 输入 的 是 V 交流 模拟信号 ， 所以 加 两个 LF 作 放大 调整 ， 使 输入 电压 限制 在 V 之间 ， 这 符合 ACH 端的 电平 输入 标准 。 系统 采用 软件 轮询 的 方式 进行 多路 AD 转换 ， C 芯片 的 AD 转换 时间 为 μ s ， 假如 每路 进行 次 采样 以 计算 有效值 ， 采样 定时 标准 是 ms ， 则 路 模拟信号 轮询 一遍 需 ms 。 实际上 ， C 的 AD 转换 允许 更 多次 采样 以求 出 更 精确 值 。 另外 ， 还 配备 了 两种 串行 通信接口 RS 和 RS 标准接口 。 其中 R 接口 允许 以 不 低于 bs 的 数据 传输速率 进行 较强 干扰 下 的 中 近距离 通信 ， 其 传送 和 接收数据 由 P 端的 电平 控制 。 　 　 利用 C 特有 的 高速 输入 口 HSIHSI 进行 基带 信号 或是 经 解调 或 去 干扰 以后 的 串行 同步 信号 的 接收 工作 ， 这一 新颖 的 尝试 是 本 系统 的 关键技术 措施 。 它 的 接收 过程 是否 正确 可靠 ， 将 直接 影响 该 系统 是否 能 正常 运转 。 从 硬件 上 看 ， 串行 同步 信号 在 输入 HSI 口 之前 ， 实施 了 以下 抗干扰 措施 ： 路 信号 经过 解调 ， 又 经过 一个 带回 滞 曲线 特性 的 施密特 或门 ， 已 基本上 滤掉 了 杂波 和 干扰信号 ， 输入 到 HSI 口 的 数据信号 ， 其 信号 的 捕捉 和 位 锁相 过程 以及 在 失步 状态 下 的 命令 头 自动 捕捉 等 处理 措施 ， 都 将 由 监控 软件 来 完成 。 HIS 端口 用作 串行 输入 口 的 实用软件 设计 及位 同步 的 实现 　 　 主 监控 程序 由 与 各 部分 硬件 功能 有关 的 任务 模块 组成 ： 主程序 负责 任务调度 ， 按照 一定 的 优先级 轮询 各 任务 ， 当 发现 某个 任务 的 有效 标志 被 置 位时 ， 程序 转 去 执行 该 任务 ， 完毕 后 返回 主程序 。 各 任务 的 有效 标志 是 在 不同 的 中断 处理程序 中置位 的 ， 例如 任务 负责 处理 HSI 口 的 输入 数据 ， 该 任务 的 有效 标志 就是 在 HSIDATA 中断 处理程序 中 被 置位 。 　 　 C 的 HSI 可用 以 记录 某一 外部 事件 触发 时 的 状态 和 时刻 ， 共有 路 通道 ， 即 HSIHSI ； 每个 通道 的 事件 触发 方式 都 有种 ， 而 当 HSI 作为 一种 替代 的 串行口 来 使用 时 ， 只有 方式 合乎 要求 。 即 HSI 引脚 上 每 发生 一次 跳变 无论 正负 均 能 触发 HSI 数据 有效 中断 中断向量 为 H ， 该 中断 有 两种 中断 源 ： FIFO 溢出 或 保持 寄存器 已 装载 。 为 能 使 通过 HSI 输入 的 数据 得到 及时处理 ， 避免 FIFO 溢出 所 产生 的 数据 丢失 的 现象 ， 本 系统 指定 保持 寄存器 加载 后 就 产生 中断 的 模式 ， 即 事件 电平 跳变 一旦 发生 ， 则 状态 和 时间 送 至 保持 寄存器 ， 并 产生 中断 。 在 中断 处理程序 中 使用 字 寄存器 PBX 记录 下 定时器 HSITIME 的 值 ， 使用 字节 寄存器 PAH 记录 下 HSISTAT ， 使用 ETIMER 寄存器 记录 下 定时器 T 的 溢出 次数 ， 并 在 每次 进入 该 HSI 中断 处理程序 时 对 ETIMER 作 一次 调整 ， 以 避免 T 溢出 时 的 错误 计数 。 为了 防止 在 HSI 中断 时 又 有 HSI 口 数据 输入 ， 程序 采取 了 相应措施 以防 数据 丢失 。 记录 下 的 数据 被 推入 QA 队列 中 ， 同时 置 上 任务 标志 ， 然后 中断 处理程序 返回 现场 。 　 　 HSI 数据处理 的 工作 由 任务 完成 ， 见图 。 任务 进行 串行 数据 变 并行处理 ， 并且 用 软件 完成 位 锁相 ； 在 失步 的 情况 下 搜索 命令 头 。 在 程序 中 设置 了 一 通道 计数器 进行 HSI 个 通道 轮流 处理 时 的 计数 ， 以 保证 每一 通道 输入 的 数据 都 能 得到 及时处理 。 程序 中 使用 了 一种 双字 移位 接收 位 信息 的 办法 来 进行 命令 头 捕捉 和 数据 接收 。 具体说来 就是 当 本次 为 上升 沿时 ， 则 在 此 以前 为 低电平 ， 所以 接收数据 。 反之 ， 本次 是 下降 沿时 ， 则 接收数据 。 系统 每次 检测 到 串行 队列 中 的 到 ， 跳变 时 或者 到 跳变 ， 便 记下 此处 的 当前 相位 ， 由于 收发 两端 时钟 不 可能 绝对 同步 ， 经过 一段时间 后 ， 收端 相对 相位 必然 发生 漂移 ， 而 不是 每次 间隔 标准 时间 由 波特率 决定 才 进行 跳变 。 如果 在 程序 中 检测 到 串行 队列 中由到 ， 就 把 上次 相位 与 当前 相位 进行 比较 ， 取其 差值 ， 再 与 标准 间隔时间 进行 比较 ， 若 第一次 超过 标准 间隔时间 ， 则 按 差值 加权 算法 进行 小 调整 ， 使 相位 向前 微调 ； 若 是 连续 多次 超过 标准 时间 ， 则 进行 较大 调整 。 若 当前 相位 与 上次 相位 的 差值 小于 标准 间隔时间 ， 则 说明 相位 超前 ； 若 是 第一次 超前 ， 使 相位 向 后 微调 ， 若 是 连续 多次 不够 减 ， 则 使 相位 向 后作 较大 调整 。 若 上次 相位 与 当前 相位 之差 等于 标准 时间 间隔 ， 则 说明 收发 两端 完全 同步 而 不必 进行 相位 调整 。 这样 ， 用 软件 方法 实现 了 收发 两端 的 位 同步 。 图 HSI 数据处理 程序 通信 信息 的 检错 、 纠错 及 解码 算法 　 　 多通道 数据 采集器 接收 的 各 RTU 数据 ， 存放 在 相应 的 接受 队列 中 等待 处理 ， 当 程序 查询 到 某 队列 已满 一帧 时 ， 则 对 该 帧 进行 解码 处理 。 首先 ， 用 查表 法求 出该 帧 前 字节 的 CRC 余数 并 与 该 帧 的 后 两 字节 CRC 检验码 比较 ， 若 两者 相等 ， 说明 接收数据 正确 无误 ； 若 不 相等 ， 说明 该 帧 有 错位 ， 如果 错位 在 可纠正 范围 内 ， 则 进行 纠错 处理 ， 否则 进行 错误处理 。 　 　 由于 采用 的 是 ， 线性 循环码 ， 根据 抗干扰 编码 理论 中 的 循环 编码 原理 ， N ， K 循环码 满足 公式 ： CXMXGXXnkMXRX 　 　 其中 ， CX 用 循环码 编码方法 得到 的 循环码 字 ， 即 通信 中 传送 的 码组 。 　 　 MX 待 编码 的 信息 多项式 K － 。 　 　 GX 次数 为 N － K 的 生成 多项式 ； GX 应选 用经 理论 与 实践 验证 过 的 推荐 式 。 　 　 RX 将 MX 左移 N － K 位后模 除以 GX 所得 之余式 ， 也 就是 CRC 校验码 。 　 　 在 某些 大规模 集成电路 串行 通信 芯片 中 ， 如 Intel 及 等 集成 有 一定 生成 多项式 的 CRC 编码 译码 电路 ， 其 优点 是 处理速度 快 ， 但 可 供选择 的 生成 多项式 少 ， 难以 支持 各种 复杂 的 抗干扰 编译 码 电路 的 需要 ， 因此 ， 当 编码 速度 要求 不高时 ， 多 采用 软件 方法 进行 抗干扰 编码 译码 。 　 　 N ， K 循环 抗干扰 编码 无论是 发送 端 还是 接收端 ， 其 软件 算法 是 一致 的 ； 即以 GX 为 除数 对 XnkMX 做模 除法 运算 ， 得到 余数 RX ， 在 发送 端 将 余数 RX 附加 在 MX 之后 送信 道 传输 即可 ， 在 接收端 将求 出 的 RX 与 收到 的 检验码 进行 比较 ， 若 两者 一致 表示 无错 ， 否则 帧 内码 存在 误差 。 　 　 N ， K 循环码 的 软件 求 余数 的 常规 方法 是 将 MX 左移 K 次 ， 每次 移出 的 最高 位为 时 便 将 上次 之 部分 余式 与 GX 进行 异或 运算 ， 得到 本次 的 部分 余数 ； 这样 重复 K 次 运算 完成 时 ， 便 得到 最终 余数 RX 。 该 算法 虽 简单 ， 但 当 信息 位较 多时 如 几百 或 上千 ， 会 影响 编码 速度 。 为了 提高 对长 信息 的 编译 码 速度 ， 可用 分段 查表 法来求 余数 ， 其 具体做法 是 将 信息 码 分成 若干段 ， 根据 每段 的 值查 余数 表 得到 一个 部分 余数 ， 完成 各段 求解 后 就 得到 最终 余数 。 显然 ， 分段 越 多 部分 余数 占用 空间 越小 ， 但 查表 次数 增多 ， 运算 速度 变慢 ， 分段 越 少 余数 表 占用 空间 越大 ， 但 查表 次数 变 少 ， 运算 速度 加快 。 以 ， 循环码 为例 ， 其 生成 多项式 为 ： GXXXX ， 用该 生成 多项式 求得 余数 为位 ， 若 按位 来 分段 ， 则 需一 长度 字节 的 部分 余数 表 ， 这 显然 不 适用 。 考虑 到 C 指令系统 也 支持 字节 操作 ， 且 RAM 不 可能 太 大 ， 可 将 XC 按 字节 分段 并 按 字节 取 余数 ， 每个 余数 查 两次 表 即可 获得 ， 这样 部分 余数 表所 占 内存空间 只有 字节 ， 这 在 实际 中是 完全 可行 的 。 　 　 字节 求 余数 法比字求 余数 法多 了 一些 操作步骤 但 所 需 的 存储空间 大大减少 了 ， 它 通过 增加 运算 时间 的 减少 存储量 ， 是 比 直接 求 余数 法 更 快 的 一种 实用 算法 。 结语 　 　 提出 的 基于 IntelC 的 多路 数据 采集 与 处理 系统 及 配套 软件设计 ， 能够 满足 现场 通信 的 要求 并 具有 一定 的 通用性 ， 其 硬件 电路 结构 清晰 简练 ， 具有 很 高 的 性能 价格比 ， 且 处理 数据 精度高 ， 是 一种 通用性 、 实用性 很强 的 多通道 通信 接收 系统 。 　 　 所 介绍 的 软件 位 锁相 算法 ， 使 收发 两端 的 晶振 频率 不 稳定度 或 通信 波特率 偏差 允许 范围 是 － ， 因此 该 方法 是 完全 实用 的 。 　 　 介绍 的 分布式 局域网 监控 系统 已 在 山东省 电力系统 下属单位 及 生产 企业 等 多处 得到 实际 应用 ， 证明 性能 可靠 ， 效果 良好 ， 被 认为 值得 进一步 推广 。 作者简介 ： 史 清华 男 ， 岁 ， 讲师 ， 主要 研究 计算机网络 ， 数据通信 ， 自动控制 等 作者 单位 ： 山东 工业 大学 计算机 科学技术 系 济南 参考文献 IntelMicrocommunicationsHandbookUSA ： IntelCorpWyattALUsingAssemblyLanguageUSAQUECorporationIntelEmbeddedMicrocontrollersandProcessorsVolIUSA ： IntelCorp ， 张 迎新 单片微 型 计算机 原理 、 应用 及 接口技术 北京 ： 国防工业 出版社 ， 潘 新民 单片微 型 计算机 实用 系统 设计 北京 ： 人民邮电出版社 ， 收稿 日期 ：