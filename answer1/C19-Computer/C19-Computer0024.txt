计算机 应用 COMPUTERAPPLICATIONS 年 第卷 第期 VolNo 非 绑定 DBGrid 的 系统 问题 及 解决 方法 李来 龙 　 罗蔚文 　 　 摘 　 要 　 根据 实际 使用 VB 的 实践 ， 详细 介绍 DBGrid 中 的 一个 系统 问题 ， 主要 介绍 了 其 现象 和 错误 之 处 ， 深入研究 错误 的 根源 ， 并 提出 解决 的 方法 。 　 　 关键词 　 VB ， DBGrid ， Col ， Row ， 标签 ， 事件 过程 　 VB 并非 十全十美 　 　 随着 计算机软件 和 硬件 的 发展 ， 人人 都 可以 设计 出 符合要求 的 软件系统 和 人机界面 。 在 当今 众多 可以 设计 人机界面 的 软件 中 ， VisualBasic （ 简称 为 VB ） 可以 说 是 最 易学 、 最好 用 的 软件 之一 。 特别 是 对于 非 计算机专业 的 设计者 ， VB 非常 实用 。 设计者 可以 不 了解 其它 的 东西 而 直接 用 VB 设计 界面 ， 而且 VB 的 操作 比较 方便 。 　 　 所以 ， 当今 VB 的 使用 范围 很广 。 但是 ， VB 也 有 一些 问题 ， 甚至 有 错误 ， 笔者 就 发现 了 一个 ， 现 提出 问题 和 解决 方法 ， 以免 后来者 继续 做 这 无用 的 工作 。 　 问题 的 发现 和 现象 　 　 笔者 前段时间 开发 一个 桥梁 检算 系统 ， 用 FORTRAN 语言 编制 了 计算 部分 ， 用 VB 做 界面 。 系统 中有 许多 输入输出 数据 ， 这些 数据 的 输入输出 基本 都 以 表格 方式 进行 。 由于 FORTRAN 需要 的 数据 文件格式 比较 严格 ， 所以 ， 系统 使用 了 非 绑定 式 的 DBGrid ， 用 数组 UserData 存储 表格 的 内容 。 又 由于 系统 的 表格 行数 和 列数 都 是 根据 前面 的 数据 确定 的 ， 不会 删除 和 添加 行或列 ， 所以 系统 只用 了 两个 事件 子程序 ： 表格 数据 改变 后 ， 对 用于 存储 表格 数据 的 数组 的 数据 进行 更新 的 事件 过程 UnboundWriteData 和 从 数组 中 读取数据 到 表格 的 事件 子 过程 UnboundReadData 。 这 两个 事件 子程序 都 是从 VB 中 的 例题 拷贝 过来 ， 然后 稍加 改动 就 运用 。 例题 的 路径 和 名字 为 ： DVBsamplesMiscUnBndGrdUnbndgrdvbp 。 但是 ， 在 使用 一段时间 后 ， 发现 问题 ， 问题 的 现象 如下 ： 　 　 ① 每个 单元 的 内容 改变 以后 ， 如果 不 把 光标 移 到 其他 单元 ， 就 马上 卸载 窗体 （ 如 按 窗体 右上角 的 关闭 按钮 或 ALTF 退出 ） ， 再次 加载 该 窗体 时 ， 修改 过 的 单元 内容 没有 改变 。 　 　 ② 经常 会 有 这种 问题 出现 ： 如果 DBGrid 表格 的 所有 行都 能 在 一屏 中 显示 出来 ， 不 需要 滚动条 ， 在 表格 最后 一行 输入 数据 ， 移开 光标 后 ， 改变 处 的 值 又 变成 原值 ； 如果 DBGrid 表格 比较 大 ， 一屏 显示 不 完 ， 需要 滚动 才能 看到 全部内容 ， 在 DBGrid 的 最后 一行 输入 数据 ， 移开 光标 后 ， 输入 单元 的 值 未 改变 ， 但是 与 此 单元 同列 的 第一行 单元 的 值 变成 了 输入 值 。 如果 在 窗体 一 加载 就 修改 最后 一行 ， 肯定 出现 以上 问题 ， 如果 从 前面 慢慢 地 修改 到 最后 行 ， 则 不会 出现 这种 问题 。 如果 不是 一 开始 就 修改 最后 一行 ， 在 使用 中 有时 也 会 出现 问题 ， 但是 出现 这种 问题 的 情况 没有 非常 明确 的 规律性 。 　 　 ① ② 两个 问题 经常 同时 出现 ， 产生 共同 影响 ， 使 问题 复杂化 。 　 错误 根源 的 研究 　 　 由于 程序 的 代码 用 的 是 VB 中 例题 的 代码 ， 只是 改变 了 一小部分 代码 ， 而且 总 的 代码 量 很少 ， 出 问题 的 可能性 比较 小 。 经过 长时间 的 检查 ， 发现 修改 部分 代码 没有 问题 ， 问题 很 可能 出 在 例题 考虑不周 到 或者 是 VB 软件 本身 。 于是 ， 笔者 根据 问题 的 现象 摸索 其 错误 根源 。 　 　 第一个 问题 好 解决 。 这个 问题 主要 是 由于 对非 绑定 DBGrid 表格 更新 事件 （ UnboundWriteData ） 的 激发 机理 了解 不够 引起 的 。 非 绑定 DBGrid 用 一个 数组 储存 表格 中 的 内容 ， 一个 单元 的 内容 对应 于 数组 的 一个 值 。 每当 DBGrid 控件 中 单元 的 内容 修改 ， 并且 把 光标 移动 到 其他 行后 ， UnboundWriteData 事件 就 激发 （ 移动 到 同一 行 的 不同 列时 ， 不能 激发 ） 。 UnboundWriteData 事件 激发 后 ， 在 此 事件 过程 中 ， 对 数组 的 内容 做出 修改 。 这个 问题 的 解决办法 比较简单 ， 只要 在 DBGrid 的 Change 事件 过程 中 加入 以下 代码 即可 （ 假设 存贮 表格 数值 的 数组 为 UserData ， 窗体 中 DBGrid 控件 的 名称 为 DBGrid ） ： 　 　 DimIAsIntegerJAsIntegerIDBGridCol 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 取列 号 JDBGridRow 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 取 行号 UserDataIJDBGridText 　 　 　 　 　 　 　 　 　 　 　 ′ 把 输入 值赋 给 当前 单元 对应 的 数组 单元 　 　 第二个 问题 比较 麻烦 。 开始 时 ， 笔者 以为 跟 第一个 问题 一样 ， 有 可能 是 有 的 地方 考虑不周 或者 是 第一个 问题 的 连锁反应 。 但 经过 仔细检查 ， 没有 发现 代码 中有 任何 问题 。 解决 第一个 问题 后 ， 运行 程序 过程 中 中断 程序 ， 在 Debug 窗口 查看 数组 的 值 发现 ： 与 改变 过 的 单元 对应 的 数组 单元 的 值 已经 改变 ， 与 表格 中 输入 的 值 一样 。 但是 表格 中 显示 的 值 还是 没有 变 ， 第一行 显示 的 仍 是 最后 一行 输入 的 数值 。 笔者 想 是不是 改变 单元 内容 后 ， DBGrid 没 来得及 刷新 表格 。 于是 ， 作者 在 程序 中 加入 代码 ， 每当 单元 修改 后 ， 强行 刷新 表格 。 在 DBGrid 的 AfterColEdit 事件 过程 中 加入 一行 代码 ： 　 　 DBGridRefresh 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 刷新 DBGrid 　 　 经过 这样 处理 ， 运行 后 一看 ， 问题 解决 了 ， 最后 一行 能 显示 改变 后 的 内容 ， 第一行 的 值 也 不变 ！ 当时 作者 以为 问题 根除 了 ， 此后 就照 此用 。 直到 有 一次 ， 笔者 用到 一个 比较 大 的 数组 ， 表格 中一屏 显示 不 完 ， 表格 有 滚动条 ， 表格 滚动 一屏 后 ， 前面 的 问题 又 出现 了 ， 只是 从 最后 一行 输入 的 内容 不是 出现 在 第一行 ， 也 不是 出现 在 最后 一行 ， 而是 出现 在 行号 等于 显示 行数 减 的 行上 ， 列号 相同 （ 所谓 显示 行 数 就是 DBGrid 中 不用 滚动 而 直接 可以 看到 的 行数 ） 。 　 　 经 多方面 检查 ， 最终 得出结论 ： 这是 VB 软件 本身 的 问题 。 VB 的 例题 也 有 同样 的 问题 。 在 VB 中 ， DBGrid 的 每 一个 元素 都 有 三个 定位 参数 ： 行号 （ Row ） 、 列号 （ Col ） 、 标签 （ Bookmark ） 。 列号 Col 很 容易 区别 ， 从 到 最大 列 依次 编号 。 行号 和 标签 容易 混淆 ， 是 有 很大 区别 的 。 行号 表示 某 行 如果 显示 出来 时 在 显示 行中 的 行号 ， 第一个 显示 行 的 行号 为 ， 以下 依次 类推 ， 直到 表格 中 可见 的 最后 一行 。 这样 ， 行号 是 可以 变化 的 ， 而且 对于 没有 显示 的 行 是 没有 行号 的 。 而 某行 的 标签 表示 该行 在 所有 行中 的 排号 ， 不管 是 显示 还是 没有 显示 出来 的 。 数组 的 第一行 的 标签 为 ， 最后 一行 的 标签 为 数组 行数 减 。 　 　 根本 问题 就 出 在 VB 软件系统 中 有时 把 最后 一行 的 Bookmark 值置 为 ， （ 特别 是 当 窗体 一 启动 就 直接 修改 最后 一行 时 ） 。 这 与 第一行 的 Bookmark 值 一样 ， 所以 就 出现 了 问题 。 弄清 了 以上 Row 和 Bookmark 的 区别 后 ， 也 就 可以 理解 为何 出现 前面 提到 的 问题 了 。 　 　 现在 可以 重新 理一理 出现 错误 的 机理 。 如果 表格 内容 可以 用 一屏 显示 ， 每当 修改 最后 一行 后 ， 先 激发 UnboundReadData 事件 过程 ， 然后 激发 UnboundWriteData 时间 过程 ， 系统 就 把 值 赋 给 第一行 ， UserData 数组 已 改变 ， 但 表格 没有 刷新 ， 还是 原来 的 内容 ， 就 出现 了 问题 ② 的 第一种 情况 。 如果 ， 表格 内容 一屏 显示 不 完 ， 每当 修改 最后 一行 后 ， 前面 的 过程 一样 ， 但是 滚动 到 第一行 是 ， 内容 已经 刷新 ， 所以 看到 的 是 改变 过 的 第一行 ， 这 就是 问题 ② 的 第二种 情况 。 　 问题 的 解决 方法 　 　 笔者 经过 实践 ， 给出 如下 解决办法 ： 在 程序 中 加入 代码 判断 当 Bookmark 为 时 ， 修改 行是 第一行 还是 最后 一行 ， 用 Boolean 型 变量 Lastrow 表示 。 根据 判断 的 结果 决定 把 输入 值赋 给 数组 的 相应 单元 。 具体 要 在 各个 事件 程序 中加 的 代码 如下 ： 　 　 在 窗体 的 声明 部分 加入 以下 代码 ： 　 　 PrivateLastrowAsBoolean 　 　 　 　 　 　 　 　 　 　 　 　 ′ 定义 判断 是否 为 最后 一行 的 参数 　 　 PrivatemTotalRows 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 定义 DBGird 的 最大 行 数 　 　 在 DBGrid 的 AfterColEdit 事件 过程 中 加入 以下 代码 ： 　 　 IfLastrowThen 　 　 DBGridRefresh 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 刷新 DBGridDBGridScrollDBGridVisibleRows 　 　 　 　 　 　 　 　 　 　 　 ′ 重新 滚到 能 看到 最后 一行 LastrowFalse 　 　 　 　 　 　 　 　 　 　 　 　 ′ 因为 光标 已经 移 到 别处 所以 把 Lastrow 设为 FalseEndIf 　 　 在 DBGrid 的 Change 事件 过程 中 加入 以下 代码 ： 　 　 DimiAsIntegerjAsIntegeriDBGridCol 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 列号 jDBGridRow 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 行号 IfDBGridBookmarkThenIfjThen 　 　 　 　 　 　 　 　 　 　 　 　 ′ 如果 Bookmark 为 而且 行号 大于 ， 一定 是 最后 一行 UserdataimTotalRowsDBGridText 　 　 　 　 　 ′ 把 输入 值赋 给 最后 一行 的 相应 列 LastrowTrueElse 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 如果 不是 最后 一行 UserDataiDBGridBookmarkDBGridText 　 　 　 　 　 　 ′ 把 输入 值赋 给 第一行 的 相应 列 EndIfElse 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 如果 Bookmark 不 等于 UserDataiDBGridBookmarkDBGridText 　 　 　 　 　 ′ 把 输入 值赋 给 数组 的 对应 的 元素 EndIf 　 实践证明 可行 　 　 本文 在 实践 的 基础 上 ， 发现 问题 ， 研究 问题 ， 最后 解决问题 。 得到 了 有效 的 成果 ， 弥补 了 VB 系统 的 缺陷 ， 为 以后 的 使用者 在 遇到 同样 的 问题 时 提供 了 思想 方法 和 解决 方法 ， 避免 再 走弯路 。 作者简介 ： 李来 龙 　 硕士 研究生 。 主要 研究 方向 ： 程序设计 、 软件 可视化 技术 。 罗蔚文 　 副教授 。 作者 单位 ： 上海 铁道 大学 土木工程 系 　 上海 （ ） 收稿 日期