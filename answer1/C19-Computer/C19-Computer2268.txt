计算机 应用 研究 APPLICATIONRESEARCHOFCOMPUTERS 　 Vol 　 No 　 P 广域网 异步 通信 系统 的 设计 和 实现 蒋旭宪 　 张德运 　 郑小军 摘要 广域网 路由器 异步 通信 系统 是 路由器 中 的 一个 重要 的 组成部分 ， 它 是 家庭 计算机用户 访问 Internet 的 主要 途径 之一 。 从 硬件 和 软件 两个 方面 ， 详细 介绍 了 广域网 路由器 异步 通信 系统 的 设计 和 实现 。 关键词 广域网 路由器 PPP 协议 异步 通信 系统 通用 异步 收发器 绪论 　 　 当今社会 ， 随着 计算机 互联网络 技术 的 飞速发展 ， Internet 已经 渗透到 社会 生活 的 各个方面 。 由于 在 Internet 上 蕴藏 了 丰富 的 信息 资源 ， 越来越 多 的 人们 渴望 通过 访问 Internet 来 获得 自己 需要 的 信息 ， 因而 解决 用户 与 Internet 的 互联 问题 变得 越来越 重要 和 迫切 。 　 　 实现 计算机网络 互联 的 方法 有 多种 。 在 广域网 中 主要 采用 ： 拨号 连接 ， 专线 连接 ， 公共 分组 交换 数据网 ， 无线网 等 方法 。 对于 广大 的 单个 计算机用户 而言 ， 最 常用 的 上网 方法 就是 拨号上网 。 本文 讨论 了 适用 于 这种 拨号上网 的 广域网 异步 通信 网络系统 的 设计 和 实现 问题 。 拨号 连接 的 几种 方式 　 　 一般 常见 的 拨号 方式 有 ： 　 　 ． 远程 终端 访问 服务器 方式 的 拨号 连接 　 　 这种 拨号 连接 的 方式 应用 于 单个 远程 计算机 与 Internet 连接 的 环境 。 在 这种 方式 下 ， 通常 由 网络 服务提供者 ISP 提供 一 与 Internet 相连 的 称为 通信 服务器 的 主机 。 单个 计算机用户 通过 远程 拨号 登录 到 该 通信 服务器 主机 上 ， 作为 通信 服务器 的 一台 终端 在 其 上 操作 ， 达到 访问 Internet 的 目的 。 由于 是 终端 访问 方式 ， 因而 很难 获得 齐全 的 Internet 服务 。 这种 方式 比较 适用 于 大型 集团 用户 和 ISP 服务 。 　 　 ． 路由器 入网 方式 的 拨号 连接 路由器 入网 方式 使得 用户 直接 访问 Internet 如图所示 ， 因而 这种 方式 获得 了 广泛 的 应用 。 这种 连接 方式 要求 服务提供者 ISP 提供 一台 路由器 ， 该 路由器 提供 若干 异步 通信 口 ， 同步 通信 口 和 局域网 口 。 异步 通信 口 的 作用 就是 负责 将 单个 计算机用户 通过 PSTN 连入 局域网 中 。 由于 此时 用户 是 局域网 中 的 一个 合法 的 用户 ， 因而 可以 获得 普通 Internet 用户 拥有 的 所有 服务 。 这种 方式 比较 适用 于 小型 团体 用户 。 因而 这种 方式 下 的 异步 通信 口 的 设计 和 实现 是 本文 的 讨论 所在 。 图 路由器 提供 拨号 连接 　 　 ． 按 需 拨号 路由 实现 的 局域网 互连 　 　 按 需 拨号 路由 DDR 是 根据 用户 拨号 的 需要 ， 路由器 自动 地 拨号 与 目的 局域网 建立 连接 。 一旦 拨号 成功 ， 就 会 在 两个 局域网 之间 建立 一条 物理 连接 ， 实现 了 两个 局域网 中 的 互联 。 路由器 异步 通信 系统 的 设计 和 实现 　 　 路由器 异步 通信 系统 包括 硬件 系统 和 软件系统 。 硬件 系统 包括 数据 的 发送 和 接收 ， MODEM 的 控制 ， IO 端口地址 的 分配 ， 多 中断 源 的 中断 控制 等 ； 软件系统 包括 异步 卡 驱动程序 的 设计 以及 PPP 协议 的 设计 。 图 说明 了 整个 路由器 异步 通信 系统 的 结构 。 图 路由器 异步 通信 系统 硬件 系统 的 设计 　 　 本 异步 通信 卡为 用户 异步 卡 ， 可以 支持 个 异步 口 同时 全双工 工作 ， 也 就 可 为 个 用户 同时 提供 服务 ， 硬件 逻辑 框图 如图所示 。 由图 可见 ， 它 的 核心 是 对 UART 芯片 的 选择 。 图 路由器 通信 卡 的 硬件 设计 　 　 UART 一般 有 下面 三种 不同 类型 ： 　 　 ． 最早 的 UART 称为 ， 它 一般 用 在 IBM 的 异步 通信 卡上 ， 它 的 速度 太慢 ， 最大 的 通信 速率 为 bps ， 跟不上 AT 型 计算机 中 的 中档 速度 ， 而且 这种 芯片 只有 个 字节 的 内部 缓冲 。 　 　 ． UART 是 与 完全 兼容 的 新一代 UART ， 它 的 速度 比 快得多 ， 最大 的 通信 速率 为 bps 。 但 它 的 最大 的 缺点 是 仍然 只有 个 字节 的 缓冲区 。 这 在 高 传送速度 及 多任务 软件 中 ， 它 仍然 会 产生 覆盖 错误 。 故 这种 芯片 也 不 适用 我们 的 端口 的 要求 。 　 　 ． 第三种 类型 是 。 与 前 两种 相比 ， 它 的 缓冲区 扩大 为个 字节 称之为 FIFO 缓冲区 。 这 意味着 在 数据 发生 覆盖 前 ， 有 微秒 的 时间 接收数据 ， 这 显然 要 比 有 了 很大 的 提高 。 另外 的 管脚 与 完全 兼容 ， 而且 生产 芯片 的 厂家 较 多 ， 较易 在 市场 上 买 到 。 故 在 本 异步 通信 卡中 ， 我们 就 选定 了 芯片 。 　 　 随着 科学技术 的 发展 ， 现在 的 UART 厂商 又 推出 了 比 性能 更好 的 芯片 。 如 ： l 内带 缓冲区 字节 ， 内带 缓冲区 字节 ， 内带 缓冲区 字节 。 这样 ， 使得 异步 通信 速率 达到 了 前所未有 的 高度 。 　 　 UART 可以 完成 以下 基本功能 ： 　 　 ． 传输速率 可 在 一定 的 范围 内 可 设置 ； 　 　 ． 字符 格式 可 选择 ； 　 　 ． 有 独立 的 时钟 ， 而 不 依赖 母板 的 时钟 ； 　 　 ． 具有 与 MODEM 接口 和 控制 的 能力 ； 　 　 ． 具有 独立 的 中断 优先级 控制能力 。 　 　 具体 的 芯片 的 技术细节 可 参考 。 　 　 由于 异步 通信 卡 采用 ISA 总线 接口 为 CPU 交换 信息 ， 且 为 个 用户 提供 服务 ， 故 需要 对 相应 的 地址 进行 译码 ， 这个 可 通过 译码器 和 GALV 来 实现 。 使用 GALV 的 好处 是 可以 按 需要 对 地址 进行 分配 ， 以免 与 其它 的 IO 地址 冲突 ， 这 增加 了 灵活性 。 另外 由于 个 端口 是 相互 独立 的 ， 所以 就 有 必要 对 相应 的 中断 源 进行 判定 ， 以 确定 是 由 哪个 端口 发出 的 请求 。 为了 印刷 电路板 的 灵活 和 方便 ， 我们 采用 了 GAL 简单 的 可编程 逻辑 器件 ， 来 产生 中断 中断 号 可 根据 实际 的 需要 对 GAL 进行 相应 的 编写 和 给出 中断 源 。 在 印刷 电路板 的 调试 当中 ， GAL 的 选择 确实 给 了 我们 很大 的 方便 。 　 　 电平 转换 电路 是 为 符合 RS 标准 所 必需 的 ， 它 主要 是 为了 与 MODEM 的 信号 电平 相匹配 。 　 　 通过 对 通用 异步 通信 UART 芯片 寄存器 的 存取控制 ， 可 实现 对 数据格式 、 数据 长度 位 、 位 、 位 或位 、 停止 位 、 校验位 、 传输速率 等 的 设置 ， 通过 对 MODEM 寄存器 的 配置 ， 可以 实现 与 MODEM 的 握手 交互 。 时钟 可 采用 M 的 晶振 。 软件系统 的 设计 　 　 软件系统 共 分为 两级 ： 它们 是 异步 卡 驱动程序 ， PPP 驱动程序 。 异步 卡 的 主要 功能 是 完成 与 硬件 有关 的 操作 。 它 是 整个 异步 通信 系统 的 起点 和 终点 。 它 主要 向 PPP 驱动程序 提供 方面 的 基本功能 。 它们 是 ： 数据 的 接收 、 数据 的 发送 、 各种 控制 操作 、 端口 的 初始化 、 端口 的 关闭 。 只有 这些 功能 的 提供 才能 保证 上层 PPP 协议 的 正确 执行 。 PPP 驱动程序 的 主要 工作 是 完成 PPP 协议 包 的 封装 ， LCP 层 链路 的 协商 ， 用户 身份 的 认证 以及 IPCP 层 协议 的 协商 。 这些 状态 的 转化 是 通过 有限 状态机 FSM 紧密 地 结合 在 一起 的 。 PPP 链路 的 建立 就 可以 传输 上层 的 IP 包了 。 图 给出 了 异步 通信 系统 的 软件体系结构 图 。 图 异步 通信 系统 的 软件体系结构 异步 卡 驱动程序 的 设计 　 　 驱动程序 是 上层 软件 和 下层 硬件 的 接口 ， 它 负责 实现 从 硬件 端口 收发 数据 的 操作 和 有关 端口配置 的 操作 ： 包括 各个 异步 口 寄存器 的 初始化 和 配置 参数 的 设置 ， 相关 数据结构 的 初始化 ， 通过 中断 从 指定 的 端口 发送数据 和 接收数据 等 。 　 　 它 的 主要 模块 有 ： 　 　 端口 的 初始化 。 它 在 系统启动 的 时候 被 调用 。 主要 的 操作 有 ： 　 　 ． 关闭 UART 的 中断 ； 　 　 ． 清空 端口 的 数据结构 ； 　 　 ． 设置 初始化 Initialed 标志 。 　 　 端口 的 打开 。 它 在 系统 要求 启动 某一 端口 上 的 服务 时 被 调用 。 主要 的 操作 有 ： 　 　 ． 检查 端口 的 初始化 标志 是否 合法 ； 　 　 ． 设置 相关 控制 寄存器 ， 规定 相应 的 通信 规程 ； 　 　 ． 初始化 该 端口 的 数据结构 ； 　 　 ． 中断 服务程序 的 驻留 ； 　 　 ． 设置 该 端口 的 打开 Opened 标志 。 　 　 端口 的 关闭 。 当 相应 端口 的 通信 结束 时 ， 需要 关闭 端口 。 主要 的 操作 有 ： 　 　 ． 关闭 该 端口 的 中断 ； 　 　 ． 释放 这个 端口 占用 的 内存 ； 　 　 ． 清空 端口 的 打开 标志 。 　 　 IO 控制 模块 。 当 上层 需要 对 下层 的 某些 参数 进行 设置 时 ， 需要 调用 IO 控制 模块 。 如对 端口 标识 的 查询 ， MODEM 接口 有关 的 硬件 状态 的 查询 和 配置 ， 波特率 的 设置 等 。 　 　 发送 模块 。 主要 执行 ： 　 　 ． 关闭 该 端口 的 发送 中断 ； 　 　 ． 将要 发送 的 数据 加 在 发送 队列 的 最后 ； 　 　 ． 重新 打开 该 端口 的 发送 中断 。 　 　 中断 服务 模块 。 它 对 端口 引起 中断 的 原因 进行 判断 ， 然后 进行 相应 的 处理 。 主要 有 发送缓冲区 空 ， 接收缓冲区 满 ， 接收缓冲区 发生 出错 ， MODEM 状态 的 改变 等 。 PPP 驱动程序 的 设计 　 　 PPP 协议 具有 错误 检测 功能 ， 支持 多种 协议 ， 允许 在 链路 建立 阶段 协商 IP地址 ， 以及 认证 功能 。 它 主要 包括 三 方面 的 内容 ： 　 　 ． 帧 的 封装 格式 。 它 的 任务 是 将 前 一帧 的 帧 尾 与 后 一帧 的 帧 头 区分 开 ， 同时 它 也 提供 错误 检测 功能 。 　 　 ． LCPLinkControlProtocol 链路 控制协议 ， 包括 链路 的 建立 ， 测试 ， 协商 和 拆除 等 。 　 　 ． NCPNetworkControlProtocol 网络 控制协议 ， 用来 协商 网络层 的 选择项 。 PPP 链路 从 建立 到 终止 的 过程 中 ， 经历 了 几个 阶段 。 如图所示 。 图 PPP 链路 状态 转换 图 　 　 有关 PPP 协议 的 细节 可 参考 。 由于 关于 PPP 协议 的 文档 比较 多 ， 关于 它 的 实现 就 不再 赘述 。 结束语 和 进一步 的 工作 展望 　 　 本文 详细 地 讨论 了 广域网 异步 通信 系统 的 设计 和 实现 ， 包括 它 的 硬件 设计 和 软件 驱动程序 的 编写 。 通过 该 异步 通信 卡 ， 我们 实现 了 与 微机 之间 的 直接 连接 ， 通过 MODEM 的 直接 连接 ， 以及 通过 电话网 拨号 通信 方式 等 的 实验 。 同时 ， 我们 也 看到 了 系统 在 以下 方面 还 需 得到 改进 ： 　 　 ． 异步 口 的 数量 需要 增加 。 从 现在 的 个 到 个 ， 个 ， 甚至 是 个 。 　 　 ． 虽然 芯片 内有 个 缓冲区 ， 但 中断 的 处理 还是 占 了 CPU 的 许多 时间 ， 这 就 需要 为 异步 卡 增加 小型 的 CPU 。 这 在 异步 口 的 数量 增加 时 显得 尤其 重要 。 　 　 ． 由于 每个 异步 口 需要 个 IO 端口 ， 所以 ， 当 异步 口 的 数量 增加 时 ， 会 占用 过多 的 IO 端口 ， 故 还 需 设计 IO 端口地址 复用 电路 。 蒋旭宪 西安交通大学 西安 张德运 西安交通大学 西安 郑小军 西安交通大学 西安 参考文献 ， 张德运 网络理论 及其 计算机网络 西安 西安交通大学 出版社 ， EXARSTCDC 产品 说明 ， WSimpsonThePointtopointProtocolPPPSTDRFCDaydreamerJulyl 收稿 日期 ：