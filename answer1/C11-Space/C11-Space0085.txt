航空 计测 技术 AVIATIONMETROLOGYMEASUREMENTTEHNOLOGY 年 　 第卷 　 第期 　 Vol 　 No 　 一种 实现 实时 多任务 操作 机制 的 方法 吴惠明 摘 　 要 　 介绍 一种 实现 实时 多任务 操作 机制 的 方法 和 两个 实例 ， 这种 方法 可以 用于 嵌入式 系统 中 。 关键词 　 实时 多任务 操作 　 单片机 　 嵌入式 系统 APracticalMethodtoRealiseMult － taskReal － timeOperationWuHuimingAbstract 　 Thisarticledescribesapracticalmethodtorealisemult － taskreal － timeoperationwhichcanbeusedinembeddedsystemTwoapplicationcasesarepresentedKeywords 　 Mult － taskreal － timeoperationMCUembeddedsystem 　 　 实时 多任务 操作系统 通过 对 内部 各项任务 进行 调度 实现 对外部 输入 的 响应 ， 使 系统 在 相应 的 工作 环境 中 ， 即使 在 外部 事件 到达 时间 无法 预知 的 情况 下 ， 也 能 有序 和 有效 地 实现 其 系统 功能 。 现已 对 实时 多任务 操作系统 有 了 深入 的 研究 ， 已有 专业 厂家 提供 实时 多任务 系统 开发工具 旨在 帮助 产品 开发者 有效 地 将 实时 多任务 机制 嵌入 到 相应 的 系统 中 ， 目前 典型 的 实时 多任务 系统 开发工具 有 MicrotecResearch 公司 的 VRTX ／ OS 系统 和 INTEL 公司 的 IRMAX 系统 。 据 资料 介绍 MicrotecResearch 公司 的 VRTX ／ OS 已有 ， 多个 用户 ， 具体 的 应用 很广 ， 大到 如 A 、 波音 喷气 客机 ， F — 战斗机 ， 程控 交换机 ， 小到 如 MOTORLA 手持 无线电话 等 精密 机电产品 的 系统 内核 ， 都 是 用 VRTX ／ OS 实时 多任务 系统 开发工具 来 实现 的 。 实时 多任务 系统 的 设计 方法 在 精密 机电产品 的 开发 中 已有 深入 广泛 的 应用 。 　 　 笔者 在 以 单片机 为 核心 的 嵌入式 测试 控制 仪表 产品开发 的 多年 实践 中 ， 深切体会 到 实现 实时 多任务 机制 的 重要性 ， 经过 探索 掌握 了 一种 实时 多任务 操作 的 实现 方法 ， 使 开发 的 产品 有 较 好 的 性能 和 较 高 的 技术 附加值 ， 并 在 几项 替代 进口产品 开发 中 发挥 了 作用 。 　 实现 方法 　 　 实现 实时 多任务 操作 的 方法 是 ： 将 系统软件 拆成 相对 独立 的 任务 ； 设立 任务调度 中心 ； 将 任务调度 中心 和 所有 的 任务 连成 一个 总 循环 。 　 　 整个 系统 由 任务调度 中心 和 一队 待 执行 的 任务 组成 并 形成 一个 总 循环 ， 任务 间 的 参数传递 ， 通过 公共数据 存储单元 来 实现 。 被 激活 的 任务 完成 之后 ， 自行 将 激活 标志 关闭 ， 再 回到 总 循环 中 。 任务调度 中心 根据 系统 功能 和 当前 发生 的 事件 ， 设置 相应 任务 的 激活 标志 ， 整个 系统 总 循环 始终 在 进行 中 ， 以 实现 系统对 发生 事件 的 迅速 响应 。 　 　 程序流程 总图 如图所示 。 图 　 程序流程 总图 　 　 测试 控制 仪表 一般 由 数据 采集 、 数据处理 、 键盘输入 、 显示 、 打印 、 串行 通讯 、 控制 输出 等 几 部分 组成 。 这图 　 固体 物料 流量 电子秤 些 部分 对 不同 的 测试 控制 仪表 来说 基本相同 ， 因而 任务调度 中心 成 了 确定 测试 控制 仪表 具体 特性 的 关键 。 　 　 下面 以 两个 实例 说明 ： 　 具体 实例 　 KF 控制 仪 　 　 KF 控制 仪是 固体 物料 流量 电子秤 的 核心 。 固体 物料 流量 电子秤 用于 生产线 上 的 物流 计量 和 工艺 控制 ， 应用 于 粮食 、 化工 、 糖业 、 建材 等 行业 。 图 　 KF 的 任务调度 框图 　 　 KF 是 比较 典型 的 机电 一体化 产品 ， 不仅 要 称重 而且 还要 进行 一系列 的 动作 控制 如图所示 。 先 打开 进料 闸门 ， 然后 实时 称重 ， 物料 达到 一定量 时 提前 关闭 进料 闸门 ， 称重 结束 后放料 ， 放料 结束 后 又 重新 进料 ， 如此 循环 动作 ， 实现 物料 流量 的 控制 和 计量 。 过去 这样 的 设备 都 需要 进口 。 　 　 在 设计 过程 中 ， 共建 了 七个 任务 ， 分别 是 ： A ／ D 转换 和 数据处理 、 自检 、 键盘 处理 、 调试 口令 处理 、 调试 命令 处理 、 显示 和 循环 程序控制 。 任务调度 中心 的 框图 如图所示 。 　 　 图中带 stb 后缀 的 是 申请 标志 位 ， 带 boxb 后缀 的 是 激活 标志 位 。 例如 ： errtstb 为 时 ， 表示 有 自检 申请 。 该 申请 是 在 每 一 循环 动作 时 提出 的 ， 经过 任务调度 中心 的 处理 ， 自检 申请 在 一定 条件 下 被 接受 。 自检 申请 被 接受 后 ， 自检 申请 标志 位 errtstb 清为 clrerrtstb ， 自检 任务 激活 标志 位置 为 setberrtboxb 。 自检 任务 就 被 执行 。 任务调度 中心 的 职能 实际上 是 根据 系统 状态 受理 任务 申请 ， 然后 激活 相应 的 任务 或 提出 任务 申请 。 　 　 KF 固体 物料 流量 电子秤 控制 仪是 采用 实时 多任务 操作方法 设计 的 第一个 产品 。 因为 固体 物料 流量 电子秤 与 物料 打包 电子秤 相似 ， 它 的 许多 动作 是 同时 进行 的 。 正是 固体 物料 流量 电子秤 的 要求 ， 迫使 我们 采用 实时 多任务 操作 的 设计 方法 。 KF 固体 物料 流量 电子秤 控制 仪和上 一代 替代 进口 的 原粮 秤 控制 仪 相比 ， 性能 有 明显提高 ， 附带 地 还 实现 了 物料 流量 的 自 适应 调节 。 　 KF 高精度 智能 称重 仪 　 　 国家 重点项目 大同 矿务局 马 脊梁 矿 高山 集运 站 ， 定量 装车 系统 国产化 项目 中 ， 所 使用 的 KF 高精度 智能 称重 仪 ， 也 是 用 这种 实时 多任务 操作 的 方法 设计 的 。 煤炭 集运 站 定量 装车 系统 对称 重仪 要求 较 高 ， 称重 仪是 定量 装车 系统 的 眼睛 ， 称重 仪将 负荷 称重 传感器 输出 信号 放大 处理 后 ， 将 重量 值 实时 显示 出来 ， 并 即时 将 称重 值 通过 RS 口以 BIT ／ S 的 波特率 传到 MODICON 主控 机 ， MODICON 主控 机 根据 该 称重 值 控制 四个 进料 闸门 的 关闭 ， 实现 定量 装车 。 结构 如图所示 。 图 　 定量 装车 系统 图 　 KF 的 任务调度 框图 　 　 在 设计 过程 中 ， 共建 了 九个 任务 ， 分别 是 ： A ／ D 转换 、 不 稳 测试 、 重量 计算 、 键盘 处理 、 调试 口令 处理 、 零位 处理 、 调试 命令 处理 、 显示 任务 和 通讯 处理 。 其 任务调度 中心 的 框图 如图所示 。 　 　 与 KF 固体 物料 流量 电子秤 控制 仪 的 任务调度 中心 图 一样 ， 带 stb 后缀 的 是 申请 标志 位 ， 带 boxb 后缀 的 是 激活 标志 位 。 例如 ： zerostb 为 时 表示 有置 零 申请 ， 申请 由 键盘 处理 任务 中 提出 ， 经过 任务调度 中心 的 处理 ， 置 零 申请 在 一定 条件 下 被 接受 。 置 零 申请 被 接受 后 ， 置 零 申请 标志 位 zerostb 清为 clrzerostb ， 零位 处理 任务 激活 标志 位置 为 setbzeroboxb ， 置 零 就 被 执行 。 　 　 由于 在 仪表 内部 实现 了 实时 多任务 机制 ， 不 发生 CPU 运行 等待 的 状况 ， 硬件资源 得到 了 最大 限度 的 利用 ， 较 好地解决 了 精度 与 速度 的 矛盾 ， 而 KF 高精度 智能 称重 仪 的 技术 性能指标 也 达到 了 较 高 的 水平 ， 以 其 高精度 级 、 响应 快 数据 采样 和 运算 处理 可达次 ／ s ， 列为 国家 测力 称重 仪表 的 最高 等级 ， 而且 也 优于 许多 同类 进口产品 一般 测力 称重 仪表 的 技术指标 精度 为级 ， 数据 采样 和 运算 处理速度 次 ／ s 。 KF 高精度 智能 称重 仪 的 调试 很 简便 ， 可 实现 在线 调试 。 在 称重 仪 现场 运行 的 同时 可 对 其 进行 调试 参数 的 设置 。 年 月 KF 高精度 智能 称重 仪在 装车 现场 投入 运行 ， 年 月 集运 站 定量 装车 系统 国产化 项目 ， 通过 了 煤炭部 组织 的 鉴定 ， 结论 为 ： 达到 国际 先进 水平 ， 填补 国内 空白 。 KF 高精度 智能 称重 仪 一直 正常 运行 至今 ， 在 装车 现场 经受 了 长期 的 考验 。 年 在 我们 承接 的 大同 矿务局 云岗 矿 和 四台 矿 两套 集运 站 定量 装车 称重 系统 改造 项目 中 ， KF 高精度 智能 称重 仪 替换 了 原 进口 的 不能 使用 的 称重 仪 ， 并 达到 很 好 的 效果 ， 在 可靠性 和 精度 等 各 方面 都 超过 了 原 进口 的 称重 系统 。 其中 云岗 矿 集运 站 定量 装车 称重 系统 ， 测量 不 确定 度为 ％ ， 这样 高 的 精度 在 工业 现场 环境 中是 少见 的 。 　 特点 　 　 这种 实时 多任务 操作 的 实现 方法 简便 实用 ， 而且 还 可用 比较简单 而 明晰 的 流程图 ， 描述 比较复杂 的 系统 功能 ， 这 对系统 的 设计 调试 和 维护 是 非常 有益 的 。 而且 从 程序流程 总图 KF 高精度 智能 称重 仪 任务调度 中心 框图 和 KF 固体 物料 流量 电子秤 控制 仪 任务调度 中心 框图 来看 ， 两个 产品 虽 不同 ， 但 内部结构 却 几乎 相同 。 用 一种 同样 的 结构 去 实现 不同 的 产品 ， 可以 大大 地 提高 产品 的 开发 效率 和 成功率 。 年 月 我们 从 接到 任务 开始 编 相应 的 软件 一直 到 现场 调试 成功 仅用 了 不到 天 的 时间 ， 而且 KF 高精度 智能 称重 仪在 现场 一直 正常 运行 至今 。 之所以 能 做到 这 一点 ， 重要 的 因素 就是 用 一种 同样 的 结构 实现 并 利用 了 已经 过 长期 考验 的 程序代码 。 　 　 我们 还 用 这种 实时 多任务 操作系统 的 设计 方法 成功 地 设计 了 动态 汽车衡 、 动态 轨道衡 ， 都 取得 了 较 好 的 社会 和 经济效益 。 　 　 产品 在 构思 、 设计 、 制造 、 销售 、 用户 使用 、 维护 到 报废 整个 过程 中 ， 有 其 固有 的 规律 值得 去 发现 和 应用 ， 掌握 这些 规律 可 在 产品 研究 开发 过程 中 掌握主动 。 我们 认为 ， 实时 多任务 操作系统 的 研究 是 精密 机电产品 固有 规律 研究 的 一个 重要 领域 ， 特别 是 随着 计算机技术 的 高速 发展 以及 相关 产品 更新换代 周期 的 加快 ， 这 一类 研究 工作 就 更 显得 重要 。 作者简介 ： ＋ 岁 　 男 　 高级 工程师 作者 单位 ： 长城 计量 测试 技术 研究所 ， 北京市 信箱 ， 收稿 日期 ： 收稿 ， 收 修改稿