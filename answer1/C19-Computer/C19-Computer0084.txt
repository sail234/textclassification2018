计算机 工程 COMPUTERENGINEERING 年 第卷 第期 VolNo 基于 事件驱动 的 多媒体 同步 与 链接 机制 余阳 ， 蔡少书 ， 黄欣 摘要 ： 结合 面向对象 技术 ， 提出 了 基于 事件驱动 的 多媒体 同步 与 链接 机制 ， 在 控制 的 灵活性 与 对 用户 的 友好 性 方面 具有 其 独特 的 优点 。 关键词 ： 多媒体 ； 超级 媒体 ； 同步 ； 链接 ； 事件驱动 MultimediaSynchronizationChaningMechanismBasedonEventdrivenYuYangCaiShaoshuHuangXinResearchCenterforElectronicalMechanismZhongshanUniversityGuangzhou 【 Abstract 】 ThispaperpresentstheMultimediaSynchronizationChainingMechanismBasedonEventdrivenwhichleadstomoreflexiblecontrolandfriendlyuserinterface 【 Keywords 】 MultimediaHypermediaSynchronizationChainingEventdriven 　 　 所说 的 基于 事件驱动 的 多媒体 同步 与 链接 机制 是 一种 基于 面向对象 的 方法 。 它 将 面向对象 的 思想 进一步 强调 ， 并 一致性 地 贯彻始终 。 它 将 所有 的 多媒体 元素 图 、 文 、 声 、 动画 、 视频 等 以及 控制性 元素 如 ： 按钮 、 时钟 等 均 看作 是 独立 的 对象 ， 对象 的 活动 产生 事件 ， 而 事件 又 可 触发 对象 的 动作 或 节点 间 的 转移 关系 顺序 、 跳转 、 循环 等 。 事件 是 节点 中 对象 同步 与 节点 间 转移 链接 的 唯一 动力 。 从 用户 的 观点 来看 ， 一个 节点 就 像 一出 戏剧 中 的 一幕 ， 一个个 的 对象 就是 布景 、 道具 、 人物 … … ， 而 用户 本身 就是 整出戏 的 导演 。 它 通过 角色 的 动作 协调 它们 的 关系 以及 一幕 的 结束 ， 下 一幕 的 开始 。 基本概念 及其 语言 描述 基本概念 的 定义 　 　 对象 ： 它 是 系统 中 最 基础 的 概念 ， 包括 媒体 对象 和 控制 对象 ． 媒体 对象 是 能够 单独 播放 的 基本 元素 ， 如 ： AVI 视频文件 、 FLIampFLC 动画文件 、 MPEG 文件 、 WAV 文件 、 实时 视频 、 文字 、 图象 等等 。 控制 对象 是 用来 控制 媒体 对象 动作 的 基本 元素 ， 如 ； 按钮 、 定时器 等 。 　 　 每个 对象 都 有 一组 属性 对 它 进行 描述 ， 既有 文件名 、 播放 位置 、 字体 等 静态 属性 ， 又 有 打开 、 播放 、 暂停 、 关闭 等 动态 属性 。 可以 将 对象 看作 演员 、 道具 、 信号 等 ， 静态 属性 描述 其 外貌 、 位置 ， 而 动态 属性 描述 其 动作 能力 。 　 　 节目 ： 是 一组 在 时间 上 有 同时性 、 或 空间 上 有 交叠 、 或 彼此间 相互 关联 、 有 控制关系 的 对象 的 集合 。 它 是 系统控制 播放 的 基本 单位 。 　 　 可以 直观 地 将 节目 比作 文艺演出 中 的 一个 节目 或 戏剧 中 的 一幕 ， 它 将 演员 、 道具 等 在 时空 上 紧密 组合 起来 以 表达 一定 的 含义 。 　 　 节目单 ： 是 一组 节目 在 控制结构 如 顺序 、 跳转 、 循环 、 定时 的 编排 下 形成 的 有序 集合 。 若 不 考虑 控制结构 的 多样性 ， 可以 将 节目单 类比 文艺演出 的 ＂ 节目单 ＂ 。 　 　 事件 ： 对象 媒体 对象 、 控制 对象 的 活动 产生 事件 ， 而 一个 事件 可以 引发 一个 或 多个 对象 改变 活动 的 方式 如 ： PLAY 变为 FASTPLAY ， STOP 变为 REWIND 等等 、 或 由 非 活动状态 开始 动作 、 或 结束 整个 节目 。 目前 ， 我们 仅仅 简化 地 定义 了 类 事件 ： 所有 媒体 对象 在 播出 结束 时 产生 结束 事件 ， 定时器 在 时间 到 时 产生 定时 事件 ， 按钮 被 点击 时 产生 点击 事件 。 　 　 基于 以上 概念 的 定义 ， 我们 可以 在 一个 节目 中 清晰 地 表达 ： ＂ 节目 开始 即 播放 视频 ， 秒钟 后 叠加 字幕 ， 同时 配音 ， 视频 播放 完毕 接着 反复 播放 动画 ， 若 反复 播放 动画 秒 仍 未 点击 按钮 A ， 则 转向 下 一个 节目 ； 若 点击 了 按钮 A ， 则 转向 本 节目单 第一个 节目 。 基本概念 的 语言 描述 图 多媒体 对象 的 类 派生 结构 　 　 基于 面向对象 技术 ， 可以 按图 所示 的 概念 层次结构 封装 系统 中 的 对象 。 高层 节点 称为 低层 节点 的 “ 超类 ” 。 低层 节点 称为 高层 节点 的 “ 子类 ” 。 超类 派生 子类 ， 子类 不但 继承 了 其 超类 的 属性 和 方法 ， 还 可以 拥有 自己 独特 的 属性 和 方法 。 　 　 这里 ， 用 C语言 举例 描述 其中 的 几个 类 ： 　 　 structEVENT 　 　 intObjectID 对象 ID 　 　 intAction 动作 　 　 longPara 参数 　 　 EVENTNext 下 一个 EVENT 结构 指针 　 　 　 　 classObject 　 　 　 　 public 　 　 longObjectID 　 对象 ID 由 播放 控制 程序定义 　 　 intType 　 　 　 　 对象 类型 　 　 HWNDhViewWin 　 对象 播出 窗口 句柄 　 　 UINTwDeviceID 　 播出 设备 ID 　 　 intTop 　 　 intLeft 　 　 intBottom 　 　 intRight 　 　 boolActive 　 　 是否 处于 活动 态 　 　 boolobPause 　 　 是否 暂停 　 　 　 　 　 　 　 　 EVENTEvent 　 　 事件 定义 表 指针 　 　 ObjectNext 　 　 下 一个 对象 指针 　 　 Object 　 　 virtual ～ Object 　 　 virtualDWORDOpen 　 　 virtualDWORDPlay 　 　 virtualDWORDPause 　 　 virtualDWORDResume 　 　 virtualDWORDStop 　 　 virtualDWORDSeekDWORDcmdDWORDloc 　 　 virtualDWORDClose 　 　 　 　 classMCIObjectpublicObject 　 　 　 　 public 　 　 DWORDSFrame 　 　 开始 帧 　 　 DWORDEFrame 　 　 终止 帧 　 　 　 　 　 　 　 　 MCIObject 　 　 virtual ～ MCIObject 　 　 virtualDWORDOpen 　 　 virtualDWORDPlay 　 　 DWORDPause 　 　 DWORDResume 　 　 DWORDStop 　 　 DWORDSeekDWORDcmdDWORDloc 　 　 DWORDClose 　 　 　 　 classImgTxtObjectpublicObject 　 　 　 　 public 　 　 intInEffect 进入 时 过场 效果 　 　 intOutEffect 退出 时 过场 效果 　 　 intDelay 入场 后 停留时间 　 　 　 　 　 　 　 　 ImgTxtObject 　 　 virtual ～ ImgTxtObject 　 　 virtualDWORDOpen 　 　 DWORDPlay 　 　 DWORDPause 　 　 DWORDResume 　 　 DWORDStop 　 　 DWORDSeekDWORDcmdDWORDloc 　 　 DWORDClose 　 　 　 　 节目 是 由 一系列 对象 组成 的 ， 可以 用 对象 组成 的 链表 表示 ： 　 　 　 　 ObjectScene ； 　 　 链表 中 对象 的 先后 关系 隐含 着 对象 在 空间 上 的 前后 关系 ， 用于 处理 对象 在 空间 上 的 叠加 。 　 　 在 我们 的 系统 中 ， 节目 是 播放 的 基本 单位 ， 以上 是 播放 级 概念 的 数据结构 ， 无须 对 节目单 进行 描述 。 在 用户 交互 级 ， 用 关系数据库 记录 用户 对 节目单 、 节目 、 对象 、 属性 的 描述 ， 并 在 播放 控制 级 实时 将 数据库 的 内容 通过 一个 中间 描述 层 转换 为 播放 级 的 结构 。 同步 与 链接 机制 的 实现 　 　 在 具体 实现 这种 基于 事件 的 同步 与 链接 机制 时 ， 考虑 到 其 自身 的 特点 及 复杂性 分解 、 功能 独立 、 易 扩展 等 技术 要求 ， 我们 将 系统 的 实现 划分 为 两大 模块 ： 多 媒体播放器 及 播放 控制器 。 多 媒体播放器 与 对象 同步 机制 　 　 多 媒体播放器 的 任务 是 具体实施 一个 节目 的 播放 。 它 必须 处理 一个 节目 中 各 对象 在 空间 上 的 叠加 和 在 时间 上 的 同步 。 首先 ， 它 通过 DDE 接收 播放 控制器 传来 的 一个 节目 中 各 对象 的 形式化 描述 ， 并 将 其 转化 到 自身 的 数据结构 中 存储 起来 。 接着 ， 将 处于 活动状态 的 对象 Activetrue 投入 运行 。 这时 ， 播放器 处于 事件 监控 状态 。 在 Windows 系统 中 ， “ 事件 ” 的 具体 表现形式 是 消息 。 当 活动 的 对象 有 消息 事件 传来 ， 播放器 就 根据 该 消息 附带 的 对象 类型 Type 和 播出 设备 标识 wDeviceID 匹配 对象 链 ， 找到 发出 消息 的 对象 ， 并 取出 其 事件 定义 表 。 根据 该表 的 内容 ， 去 改变 当前 活动 对象 的 动作 ， 或 启动 一个 处于 非 活动状态 的 对象 。 为了 提供 结束 该 节目 的 手段 并 与 链接 机制 相衔接 ， 我们 定义 了 一个 特殊 的 对象 ： System ， 它 具有 顺序 Next 、 跳转 Jump 、 循环 Loop 等 动态 属性 。 一旦 有 事件 触发 了 该 对象 ， 播放器 即 关闭 所有 正在 活动 的 对象 ， 结束 该 节目 的 执行 ， 并 将 System 的 动作 传给 播放 控制器 ， 由 它 具体实施 。 播放 控制器 与 节点 链接 机制 　 　 播放 控制器 的 主要 任务 是 将 用户 定义 的 节目单 解释 到 节目 一级 ， 并 将 一个 节目 的 所有 对象 属性 转化 为 一种 形式化 描述 ， 通过 DDE 提交 给 多 媒体播放器 。 要 做到 这 一点 ， 播放 控制器 必须 解释 节目单 中 的 顺序 、 跳转 、 循环 等 控制结构 。 为了 满足用户 需要 ， 我们 还 提供 了 子 节目单 、 定时 插播 、 手工 插播 等 控制结构 。 由于 采用 了 关系数据库 存放 与 用户 交互 的 数据 ， 使得 播放 控制器 可以 利用 数据库 的 成熟技术 方便 地 进行 查询 、 定位 等 操作 ， 为 功能 的 实现 提供 了 坚实 可靠 的 技术 保证 。 在 控制器 与 播放器 之间 ， 我们 以 DDE 为 基础 ， 定义 了 一个 简单 有效 的 通信协议 ， 以 保障 命令 、 数据 、 状态 的 有效 传递 。 图 简要地 图示 了 这种 协议 。 图 节目单 传送 协议 　 　 通过 多 媒体播放器 与 播放 控制器 的 分离 ， 不但 有效 地 控制 了 整个 系统 的 复杂性 ， 还 为 我们 对系统 进行 进一步 的 性能 改进 和 功能扩充 预留 了 广阔 的 发展 空间 。 如 ： 通过 对 通信协议 的 改进 ， 可以 实现 节目 数据 的 预 传送 ， 进一步提高 系统 性能 。 通过 对 用户界面 和 控制器 的 改造 ， 可以 快速 地 响应 用户 需求 ， 定制 出 不同 领域 的 专用 多媒体 编播 工具 。 应用 实例 　 　 我们 应用 前述 概念 和 原理 ， 具体 实现 了 一个 多媒体 编播 控制系统 MEDS 。 它 通过 所见即 所得 的 交互 界面 将 用户 编导 的 节目单 、 节目 、 对象 数据 存储 于 多媒体信息 数据库 ， 由 播放 控制器 解释 节目单 中 的 控制结构 ， 并 将 分离 出 的 节目 数据 通过 DDE 实时 传送 给 播放器 ， 协同 完成 节目单 的 播放 。 统计 报表 子系统 将 播放 控制器 记录 的 播放 情况 每个 节目 播出 的 时间 、 频率 、 最大 间隔 、 被 中断 次数 等等 形成 报表 提交 用户 。 MEDS 的 软件结构 如图所示 。 图 MEDS 软件 结构图 　 　 目前 ， MEDS 主要 用于 本 单位 开发 的 LED 大 屏幕显示 系统 的 编播 控制 ， 适用 于 广告宣传 、 娱乐 等 领域 。 已 应用 于 国内 多项 工程 ， 并 出口 到 美国 、 英国 、 比利时 、 马来西亚 等 多个 国家 和 地区 。 其 强大 的 功能 和 易用性 受到 用户 的 广泛 赞誉 。 　 　 以多 媒体播放器 及其 形式化 描述 界面 为 核心 ， 针对 不同 的 用户 要求 ， 通过 用户界面 及 控制器 的 用户 化 ， 可以 构建 各种 业务 信息 的 实时 发布 系统 。 目前 我们 已 开发 出 面向 火车站 、 机场 、 体育场 等 的 用户 系统 。 相信 经过 进一步 的 开发 和 完善 ， 其 应用领域 会 不断 拓宽 。 作者 单位 ： 中山大学 电子机械 研究 中心 ， 广州 参考文献 蔡茂国 肖自美 面向对象 的 超级 媒体 技术 全国 第四届 多媒体技术 学术会议 论文集 柯清超 基于 时间轴 的 多媒体演示 系统 的 设计 全国 第七届 多媒体技术 学术会议 论文集 杨士强 张国光 实用 多媒体系统 的 著作 工具 全国 第四届 多媒体技术 学术会议 论文集