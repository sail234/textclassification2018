计算机 工程 COMPUTERENGINEERING 年 第卷 第期 volNoQoS 路由器 关键技术 分析 陈依群 　 铁 　 玲 　 顾尚杰 　 诸 鸿文 　 　 随着 因特网 作为 信息 基础设施 迅速 发展 ， 路由器 特别 是 骨干网 路由器 的 设计 和 实现 主要 面临 着 两个 挑战 ： 一是 网络 用户 增加 及 多媒体 应用 的 出现 ， 对 网络带宽 提出 更高 要求 ， 链路 和 路由器 需 拥有 更 高带宽 ； 二是 网络 用户 和 应用 的 要求 提供 不同 的 服务质量 ， 路由器 应 具备 区别 服务 包括 IETF 定义 的 IntServ 和 DiffServ 两种 服务 的 机制 。 　 　 同时 支持 高带宽 和 区别 服务 ， 使 路由器 简称 QoS 路由器 设计 和 实现 更为 复杂 。 高带宽 要求 路由器 快速 地 处理 和 转发 每个 数据包 ， 也 就 要求 路由器 内部 处理 尽可能 简单 ； 而 区别 服务 需要 在 路由器 内部 保持 更 多 的 连接 状态 信息 ， 以便 按 连接 或 一组 连接 分类 识别 数据包 和 分配 网络资源 ， 这使 数据包 处理 和 转发 更为 复杂 。 为 解决 这一 矛盾 ， 同 传统 Besteffort 路由器 相比 ， QoS 路由器 需要 在 体系结构 和 资源管理 等 方面 进行 改进 ， 主要 特点 是 利用 交换 技术 和 并行处理技术 来 提高 路由器 的 性能 。 QoS 路由器 体系结构 路由器 的 物理 组成 　 　 一个 通用 的 路由器 结构 如图所示 。 它 由 部分 组成 ： 输入 端口 、 交换 结构 、 路由 处理器 和 输出 端口 。 输入 端口 与 输入 链路 相连 ， 执行 物理层 和 链路层 功能 ， 接收 数据包 ， 根据 IP地址 查找 路由表 确定 数据包 的 输出 端口 和 下 一段 地址 。 输出 端口 与 输出 链路 连接 ， 也 执行 物理层 和 链路层 功能 ， 存储 和 发送 数据包 。 路由 处理器 运行 路由 协议 维护 路由表 和 执行 网络管理 功能 。 交换 结构 连接 输入 端口 、 输出 端口 和 路由 处理器 ， 以便 把 输入 端口 的 数据包 交换 到 一个 或 多个 输出 端口 或者 路由 处理器 。 图 路由器 组成 QoS 路由器 的 逻辑 组成 　 　 QoS 路由器 逻辑 组成 如图所示 ， 其中 实线 和 虚线 分别 表示 数据 包转发 路径 和 控制 路径 。 在 转发 路径 上 ， QoS 路由器 除了 执行 路由表 查找 、 从 输入 端口 到 输出 端口 交换 数据包 外 ， 还 执行 数据包 分类 ， 并 采用 复杂 的 调度 和 缓冲 管理 方法 给 网络连接 分配资源 。 图 比较 BestEffort 路上 器 和 QoS 路由器 　 　 在 控制 路径 上 ， QoS 路由器 除了 维护 路由表 和 执行 网络管理 功能 外 ， 还 运行 RSVP 信令 协议 和 执行 接入 控制 。 RSVP 协议 和 接入 控制 用于 给 网络连接 保留 资源 ， 在 转发 路径 上 设置 用于 控制 资源分配 的 状态 信息 ， 如 区别 服务类型 、 优先级 等 。 QoS 路由器 的 关键技术 　 　 提高 QoS 路由器 性能 的 关键在于 提高 转发 路径 性能 ， 即 提高 构成 转发 路径 的 各 路由器 机制 ， 包括 交换 结构 、 数据包 分类 、 路由表 查找 和 资源管理 的 带宽 。 交换 结构 　 　 交换 结构 是 路由器 的 核心 ， 有 总线 、 共享内存 和 交叉开关 种 类型 。 总线结构 是 指 路由器 的 各 输入 端口 和 输出 端口 都 同 总线 相连 ， 其 结构 简单 ， 便于 实现 。 但 总线结构 限制 了 输入 和 输出 端口 间 每次 只 允许 交换 一个 数据包 ， 同时 总线 仲裁 结构 实现 复杂 ， 从而 限制 总线 带宽 提高 。 因而 总线结构 只 适用 于 访问 路由器 或 企业 路由器 。 　 　 共享内存 结构 的 路由器 把 接收 的 数据包 存储 在 共享内存 ， 端口 间 只 需 交换 数据包 指针 而 无需 拷贝 整个 数据包 ， 可 有效 提高 交换 结构 带宽 利用率 。 但 存储器 存取速度 受限制 ， 也 限制 路由器 带宽 。 　 　 交叉开关 在 N 个 输入 端口 和 N 个 输出 端口 间 建立 N 条 共享 总线 。 输入 和 输出 端口 通过 并发 交换 多个 数据包 而 提高 带宽 。 但 一般 的 交叉开关 存在 的 一个 问题 是 ， 输入 端口 HOL 阻塞 使 带宽 利用率 低 。 一个 解决 方法 是 内部 加速 ， 使 交叉开关 的 内部 带宽 大于 输入 链路 带宽 总和 ， 输出 端口 同时 接收 多个 输入 端口 的 数据包 。 这种 输出 排队 方式 优点 是 数据包 只 存在 输出 排队 时延 ， 但 缺点 是 扩展性 较差 。 另 一个 解决 方法 是 输入 虚拟 排队 。 交叉开关 在 每个 输入 端口 对应 于 一个 输出 端口 维持 一个 FIFO 队列 。 模拟 结果 和 解析 方法 已 证明 这种 方式 可 获取 吞吐量 ， 并且 只 需 内部 加速 比 为 ， 可 获得 同 内部 加速 比 N 相似 的 吞吐量 ， 因而是 可 扩展 的 。 交叉开关 另 一个 问题 是 采用 可变 长度 交换 或 固定 长度 交换 。 采用 可变 长度 交换 能 提高 带宽 利用率 ， 变 长 交换 控制 逻辑 十分复杂 ， 因此 理想 的 是 采用 固定 长度 交换 。 路由器 需 把 可变 长度 的 IP 数据包 划分 定 长信 元 交换 ， 并 采用 标记技术 ， 把 信元 交换 到 输出 端口 ， 并 在 输出 端 重组 IP 数据包 。 IP 数据包 处理 　 　 IP 数据包 处理 包括 数据包 分类 、 路由表 查找 和 一般性 处理 ， 如 报头 校验 、 修改 报头 、 IP地址 验证 、 IP 选项 处理 等 。 其中 ， 路由表 查找 和 数据包 分类 最为 复杂 。 　 　 路由表 查找 算法 Internet 采用 CIDRClasslessInterDomainRouting 地址 结构 。 路由器 接收 到 每个 数据包 ， 需 查找 具有 最长 掩码 或 最长 匹配 前缀 的 路由表 项 ， 把 数据 包转发 到 路由表 项 指定 的 输出 端口 。 查找 最长 匹配 前缀 使用 传统 的 完全 匹配 方法 ， 如 完全 哈希 链表 、 二进制 查找 、 标准 相联 存储器 不能 直接 应用 于 路由表 查找 。 另外 ， 一个 路由表 ， 一般 存在 数千个 甚至 上万个 路由表 项 ， 若 同时 数据包 长度 很 短 ， 都 使 路由表 查找 实现 变得 困难 。 路由表 查找 是 影响 路由器 带宽 的 一个 主要 因素 。 　 　 最近 ， 已 提出 多种 可 有效 改进 路由 查找 性能 的 算法 ， 这些 改进 算法 可 分为 ： 硬件 方法 ； 压缩 方法 ； 哈希 表 方法 。 传统 的 硬件 方法 是 使用 联想 存储器 ContentAddressableMemories 和 高速 缓冲 Cache 存储 路由表 。 这 两种 方法 扩展性 差 ， 而 不适 用于 支持 大 路由表 的 高性能 路由器 。 一种 改进 方法 是 把 逻辑电路 和 存储器 组合 在 一起 ， 使 存储器 智能化 ， 可以 极大地提高 存储器 访问速度 。 另 一种 改进 方法 是 利用 大 存储空间 存储器 存储 整个 路由表 ， 并 采用 专用 硬件 修改 路由表 方法 克服 路由表 修改 困难 的 缺点 。 　 　 压缩 技术 是 利用 路由表 稀疏 特性 构造 一个 复杂 和 紧凑 的 路由表 ， 以便 能 把 整个 路由表 存放 在 路由 处理器 的 一级 高速 缓冲 内 ， 这样 可 实现 高速 路由表 查找 。 　 　 一种 改进 哈希 表 方法 是 对于 一个 给定 IP地址 ， 循环 地 选取 不同 的 前缀 表达式 ， 分别 求 哈希 表值 。 但 这种 方法 扩展性 差 。 另 一种 可 扩展 哈希 表 查找 算法 是 对于 一个 N 位 地址 ， 只 需用 OlogN 时间 查找 最长 前缀 匹配 。 这种 算法 为 每个 可能 的 最长 前缀 匹配 计算 一个 独立 的 哈希 表 ， 根据 前缀 表达 长度 使用 二进制 查找 算法 而 不是 从 可能 最长 前缀 表达式 开始查找 。 另外 ， 该 算法 需要 为 每个 哈希 表项 存储 内部 标记 ， 当 哈希 表 查找 失败 时 ， 指向 另 一个 短缀 表达式 的 哈希 表 。 一个 路由表 项 内部 标号 用 压缩 方式 存储 保存 有效 减少 标记 项 存储空间 要求 。 最后 ， 预先 用 一个 前缀 表达式 预先 求 出 一个 包括 所有 路由表 项 哈希 表 ， 可以 快速 改变 哈希 表 ， 可 进一步 减少 平均 存储 时间 为 。 　 　 数据包 分类 算法 数据包 分类 是 支持 区别 服务 的 一个 重要 机制 。 QoS 路由器 识别 由 一个 连接 或 一组 连接 发送 的 数据包 ， 以便 分配 所 需要 的 网络资源 以 满足用户 的 区别 服务 要求 。 按 连接 分类 数据包 ， QoS 路由器 不但 需要 根据 每个 数据包 的 IP 目的 地址 ， 而且 还 根据 源地址 ， 甚至 更 复杂 但 也 更 灵活 的 ， 是 按 协议 类型 、 服务类型 和 TCPUDP 端口号 在 过滤 库 检索 一个 最佳 匹配 规则 来 分类 数据包 。 IPv 的 源 、 目的 地址 长度 之 和 为位 ， 若 加上 协议 类型 、 服务类型 和 TCPUDP 端口号 字 段 ， 其 长度 之 和 为位 。 而 骨干 路由器 的 过滤 库 一般 含有 大量 的 分类 规则 如 k ～ k ， 在 这种 情况 下 ， 要 实现 快速 数据包 分类 比 实现 快速 路由表 查找 更为 困难 。 已 提出 的 一些 快速 路由表 查找 算法 能 实现 按线速 查找 位 地址 ， 但 这些 算法 并 不能 被 轻易 修改 而 适用 于 快速 数据包 分类 。 　 　 最近 ， 已 提出 数据包 分类 的 一些 快速 实现 方法 。 一种 是 针对 QoS 路由器 通常 按 目的 、 源 IP地址 分类 数据包 的 情况 ， 提出 了 一种 gridoftries 的 优化 算法 ； 同时 还 针对 按 目的 、 源地址 和 端口号 等 多维 空间 中 分类 数据包 的 情况 ， 提出 了 一种 crossproducting 算法 ， 这 两种 算法 最 多 需要 次 存储器 访问 和 次 存储 访问 。 另 一种 是 基于 硬件 的 并行 分类 方法 实现 。 该 方法 把 路由器 按 目的 、 源地址 和 端口号 等 分类 数据包 一般 化为 多维 空间 检索 问题 ， 采用 分解 方法 把 多维 空间 检索 简化 为 多个 条件 表达式 求解 ， 再求 各 表达式 交集 。 　 　 按 连接 分类 实现 区别 服务 ， 非常灵活 ， 但 对于 骨干 路由器 而言 ， 实现 按 连接 分类 非常 困难 ， 其 扩展性 差 。 因此 ， 在 灵活性 和 扩展性 间 折衷 ， 骨干 路由器 用 聚合 的 方法 实现 区分 服务 。 对于 每个 到达 数据包 ， 路由器 只 需 按 区别 服务 域 分类 ， 易于 高速 实现 。 　 　 分布 或 集中处理 路由器 可 采用 硬件 方法 ， 即 通过 提高 IP 处理器 的 性能 来 增加 IP 处理 带宽 。 相应 地 ， 处理 结构 可 划分 为 集中 和 分布式 两种 。 集中式 结构 是 采用 一个 高性能 转发器 ， 所有 转发 功能 都 在 一个 中心 处理器 执行 。 　 　 分布式 结构 是 采用 一些 低 性能 处理器 ， 利用 并行处理技术 提高 IP 处理 带宽 。 同 集中式 结构 相比 ， 分布式 结构 扩展性 好 ， 但 控制 更加 复杂 。 首先 ， 路由器 必须 采用 均衡 机制 使 各个 处理器 具有 类似 负荷 以 防止出现 数据包 在 一些 处理器 前 排队 而 另 一些 处理器 空闲 等待 现象 。 其次 ， 路由器 必须 维持 全局 一致 路由表 。 为 更好 解决 这 两个 问题 ， 可 采用 一种 功能 专用化 的 分布式 结构 。 路由器 把 整个 IP 处理过程 分 成为 多个 执行 特定 功能 阶段 ， 每个 IP 处理器 只 执行 一个 专门 任务 ， 数据包 从 一个 处理单元 流向 另 一个 处理单元 。 这样 ， 可简化 各 处理单元 设计 ， 但 同时 使 处理器 间通信 开销 增加 。 　 　 标号 交换 技术 提高 路由器 IP 处理 性能 另 一种 方法 是 路由器 采用 标号 交换 技术 。 标号 交换 不同于 传统 基于 路由 交换 方法 ， 其 基本 思想 是 路由器 给 一个 连接 的 数据包 分配 一个 标号 ， 下 一段 路由器 根据 数据包 标号 用 完全 匹配 方式 转发 和 调度 从 第二个 开始 的 数据包 ， 这样 简化 了 路由表 查找 和 数据包 分类 问题 ， 便于 路由器 利用 ATM 交换 技术 提高 数据 包转发 速度 。 但 标号 交换 技术 要求 路由器 实现 标号 发布 协议 ， 这 将 重大 改变 当前 的 Internet 结构 ； 另外 ， 使 路由器 具有 的 链路 容错 能力 相对 降低 。 资源管理 　 　 路由器 资源管理 包括 输出 链路 带宽 及 缓冲 空间 管理 。 前面 讨论 的 数据包 分类 算法 把 每个 数据包 按 一个 连接 或 一组 连接 分类 ， 数据包 调度 和 缓冲 管理 算法 则 给 一个 连接 或 一组 连接 分配 链路 带宽 和 缓冲 ， 以 满足 各 连接 的 服务质量 要求 。 调度 算法 　 　 调度 算法 确定 各 排队 数据包 在 路由器 输出 端口 的 发送 顺序 。 调度 算法 包括 先来 先 服务 传统 、 优先级 服务 ， 以及 复杂 的 加权 公平 排队 和 分层 链路 共享 算法 。 先来 先 服务 调度 算法 ， 实现 简单 ， 但 先来 先 服务 缺点 是 不能 控制 分配 网络带宽 ， 不能 保证 一些 连接 比 别的 连接 具有 更 小 的 端 到 端 时延 ， 以及 防止 一些 恶意 连接不断 发送 数据包 使 别的 连接 不能 公平 地 使用 网络资源 。 　 　 加权 公平 排队 算法 是 一种 理想 的 调度 算法 。 它 根据 每个 连接 权值 分配 链路 带宽 。 设 各 连接 权值 可 表示 为 ww … wn ， 其中 Σ wi ， 则 排队 连接 k 具有 可 保证 带宽 wkR Σ wi ， R 为 链路 带宽 。 因此 ， 加权 公平 排队 算法 可 保护 和 隔离 连接 ， 公平 分配 剩余 带宽 ， 并且 若 连接 发送 速率 受限于 漏桶 控制算法 ， 则 该 连接 具有 一个 可 保证 的 端 到 端 时延 上限 。 但 加权 公平 排队 算法 缺点 是 需要 保存 每个 排队 连接 状态 信息 ， 各 数据包 需求 虚拟 时钟 并且 按 优先级 排队 ， 其 扩展性 差 。 　 　 分层 链路 共享 服务 是 指 按类 层次 组织 一个 链路 的 所有 连接 ， 路由器 基于 策略 地 给 每个 类 对象 分配 链路 带宽 。 分层 链路 共享 需要 实现 以下 几个 目标 ： 若 一个 类有 足够 带宽 需求 ， 应 保证 该类 的 最小 网络带宽 ； 若 一个 类 具有 剩余 带宽 ， 应 保证 各 兄弟 类 公平 使用 这些 剩余 带宽 ； 在 类 层次 内 ， 支持 实时 和 优先级 服务 。 对于 以上 这些 目标 ， 有时 可能 是 冲突 的 ， 调度 算法 应 实现 相应 机制 优先 满足 某些 目标 要求 。 用于 分层 链路 共享 服务 的 调度 算法 主要 包括 基于 类 排队 ClassBasedQueueing ， 分层 加权 公平 排队 算法 HierarchicalPacketFairQueueing 和 分层 服务 曲线 算法 HierarchicalFairServiceCurve 。 其中 ， 分层 服务 曲线 算法 具有 时延 和 带宽 解 耦 特点 ， 可 更 有效 利用 带宽 资源 。 缓冲 管理 　 　 缓冲 管理 给 各 连接 分配 缓冲 和 缓冲 溢出 时 如何 丢弃 数据包 。 同 调度 算法 相比 ， 缓冲 管理 算法 由于 只 需 根据 固定 状态 信息 ， 特别 是 一些 全局 状态 信息 ， 或 一些 特定 连接 状态 信息 来 决定 接收 或 丢弃 数据包 ， 而 便于 高速 实现 。 　 　 缓冲 管理 算法 主要 包括 尾部 丢弃 、 随机 提前 检测 RandomEarlyDetection 及 改进 算法 。 传统 路由器 一般 采用 尾部 丢弃 算法 。 尾部 丢弃 算法 是 在 缓冲 溢出 时 丢弃 数据包 。 它 简单 实用 ， 但 存在 两个 主要 问题 ： 一个 是 不 公平 占用 缓冲 ， 单个 或 少数 TCP 连接 可能 占用 大量 缓冲 ， 阻止 别的 连接 公平 使用 网络资源 ； 另 一个 是 过度 占用 缓冲 ， 路由器 在 缓冲 溢出 时易 丢弃 大量 突发 IP 包 ， 使 一些 TCP 连接 同步 减少 发送窗口 ， 降低 链路 利用率 。 　 　 RED 算法 是 一种 主动 排队 管理 算法 。 和 尾部 丢弃 算法 不同 ， RED 路由器 在 缓冲 溢出 前 随机 丢弃 数据包 或 设置 显式 拥塞 指示 ， 提前 通知 各 TCP 连接 降低 数据包 发送 速率 。 它 使用 指数 加权 移动 平均 低通滤波器 计算 平均 队列 长度 。 路由器 把 平均 队列 长度 和 两个 高 、 低 门限 比较 。 当 平均 队列 长度 小于 低门 限时 ， 路由器 不 丢弃 任何 数据包 或 在 数据包 报头 设置 拥塞 标识 。 当 平均 队列 长度 大于 高 门 限时 ， 路由器 在 每个 数据包 报头 设置 拥塞 标号 。 若 平均 队列 长度 在 高 、 低 门限 之间 ， 路由器 以 概率 pa 在 每个 新 到达 IP 包 报头 设置 拥塞 标识 。 pa 是 平均 队列 长度 变量 函数 。 这样 ， RED 路由器 可 维持 一个 相对 短 的 平均 排队 长度 ， 可 减少 数据包 排队 时延 ； 同时 按 各 连接 数据包 到达 速率 成 比例 的 随机 丢弃 数据包 ， 可 保证 一定 的 公平性 和 防止 所有 连接 同步 地 降低 吞吐量 。 　 　 RED 改进 算法 包括 FREDFlowRandomEarlyDetection 和 RIORedwithInOut 。 FRED 同 RED 算法 相比 ， 可 更好 地 保证 TCP 连接 公平 使用 带宽 ， 但 FRED 需要 按 连接 分类 数据包 ； RIO 算法 则 把 RED 算法 应用 于 数据包 具有 不同 丢弃 优先级 情况 ， 其 基本 思想 是 当 路由器 检测 拥塞 时高 概率 地 丢弃 低优先级 数据包 ， 可 实现 一种 低 代价 区别 服务 机制 。 结论 　 　 本文 讨论 了 QoS 路由器 基本 结构 ， 概述 了 路由器 内部 机制 ， 包括 交换 结构 、 数据包 分类 、 数据包 调度 和 缓冲 管理 的 实现 算法 。 这些 实现 方法 一种 情况 是 如 WFQ ， 具有 很 好 的 灵活性 ， 能 满足 区别 服务 要求 ， 但 扩展性 较差 或 实现 复杂性 高 ； 但 另 一种 情况 是 如 RIO 算法 ， 具有 很 好 的 扩展性 和 低 的 实现 复杂度 ， 但 支持 区别 服务 灵活性 稍差 ； 如何 改进 或 结合 这些 算法 以 同时 满足 灵活性 、 可扩展性 和 实现 复杂性 要求 ， 还 需要 进一步 研究 。 作者 单位 ： 上海交通大学 电子 工程 上海 参考文献 ClarkDDShenkerSZhangLSupportingRealtimeApplicationsinanIntegratedServicesPacketNetworkArchitectureandMechanismSIGCOMM ： DegermarkMBrodnikACarlssonSetalSmallForwardingTablesforFastRoutingLookupsSIGCOMM ： SrinivasanVVargheseGSuriSetalFastandScalableLayerFourSwitchingSIGCOMM ： FloydSJacobsonVLinkingsharingandResourceManagementModelsforPacketNetworksIEEEACMTransactionsonNetworking ： FloydSJacobsonVRandomEarlyDetectionGatewaysforCongestionAvoidanceIEEEACMTransactionsonNetworking ， ：