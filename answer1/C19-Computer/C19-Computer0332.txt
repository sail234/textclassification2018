计算机 应用 ComputerApplications 年 第卷 　 第期 Vol 　 No 虚拟现实 在 水坝 系统 中 的 实现 梁 　 民 　 刘珍平 　 张培仁 　 梁 　 兵 　 　 　 摘 　 要 　 本文 结合 作者 在 “ 二滩 大坝 安全 在线 监控 系统 ” 项目 中 有关 虚拟现实 的 开发 实践 ， 阐述 了 虚拟现实 的 概念 及其 在 二滩 水坝 系统 中 的 实现 。 　 　 关键词 　 虚拟现实 三维 显示 　 前言 　 　 虚拟现实 作为 当今 计算机 最 热门 的 技术 之一 ， 它 极大 地 突破 了 事物 表达 传统 方法 的 局限 ， 使 人们 可以 将 任何 想象 的 环境 虚拟 实现 ， 并且 人们 可以 在 其中 以 最 自然 的 动作 与 这种 虚拟现实 进行 交流 。 目前 ， 虚拟现实 技术 已 在 认真 地 寻找 行业性 的 应用 ， 比如 ： 虚拟现实 教学系统 、 远程 诊断 、 汽车 制造 设计 等等 。 鉴于 虚拟现实 的 强大 优势 ， 我们 便 将 其 首次 应用 于 国内 水利 系统 中 ， 在 SGI 工作站 上 实现 了 二滩 水坝 的 整个 枢纽 布置 及其 周围 地理环境 的 虚拟环境 ， 使得 用户 能够 运用 小小的 鼠标 突破 物理 、 空间 、 时间 的 限制 ， 充分 领略 作为 中国 第一 高 、 世界 第三 高 的 二滩 大坝 的 雄伟 风姿 ， 轻松 徜徉于 高米 、 底 宽 米 、 顶 宽 米 的 大坝 的 任意 一个 部位 。 　 　 虚拟现实 是 利用计算机 将 客观 世界 的 局部 仿造 出来 ， 并且 允许 用户 利用 自然 的 动作 与 这个 仿造 的 局部 世界 进行 交互 ， 产生 身临其境 的 感觉 。 “ 虚拟 ” 指 的 是 利用 虚拟现实 技术 所 产生 的 局部 世界 是 虚构 的 ， 而 “ 现实 ” 说明 对于 进入 这一 虚构 的 局部 世界 的 人 来说 ， 在 感觉 上 是 进入 了 现实 世界 。 虚拟环境 的 特征 是 交互性 和 浸入 性 。 一个 基本 的 虚拟现实 系统 由 虚拟环境 发生器 、 虚拟环境 、 传感器 件 、 作用 器件 及人 组成 。 虚拟现实 的 模型 图 如下 ： 图 　 虚拟现实 的 模型 　 二滩 虚拟现实 系统 的 实现 　 系统 实现 硬件 环境 　 　 我们 在 SGI 工作站 Indigo 机型 上 实现 虚拟现实 系统 。 Indigo 是 一种 高性能 的 图形工作站 ， 采用 MipsMHz 主频 CPUR ； 具有 两个 PP 像素 管道 处理器 ， 提供 混合 、 深度 和 抖动 ； 一个 GE 几何图形 图像 发生器 ； 一个 RE 光栅 发生器 、 能作 　 　 MSec 像素 填充 。 　 三维 建模 　 　 由于 项目 并未 购买 昂贵 的 SGI 工作站 建模 软件 ， 故 我们 利用 PC机 上 较 常见 的 Autocad 和 DS 软件 进行 建模 。 我们 利用 二滩 大坝 工程图纸 ， 从中 取出 大坝 模型 、 地下 厂房 模型 及 周围 地形模型 。 　 　 周围 地形模型 的 抽取 　 由于 二滩 周围 的 地形 勘探 较 早 ， 只有 依据 航空 拍摄 人工 描出 的 几张 工程 蓝图 。 所以 地形 的 等高线 矢量化 成为 三维 地形 建模 的 重点 。 模型 抽取 工作 分为 以下 几个 步骤 ： 　 　 a 图纸 的 扫描 将 图纸 以 灰度 方式 扫入 ， 如果 一 开始 就 以二值 图像 方式 扫入 ， 效果 会 很 差 ， 甚至 面目全非 。 故 必须 以 灰度 方式 扫入 ， 经 处理 后 转化成 二值 图象 。 　 　 b 预处理 和 阀值 化去 噪音 ， 改善 图像 质量 并 转化 为二值 图象 ， 将 扫入 的 图像 采用 基于 图像 的 边缘 检测 的 “ 最近 有效 灰度 阀值 平均法 ” 对 图纸 进行 净化 ， 尽量 除去 图中 的 噪音 并且 保持 图形 的 原貌 。 最后 二值化 转化 为 黑白 二值 图像 。 　 　 c 细线 化将 线段 变为 单位 线宽 ， 将二值 图像 中 很粗 的 线段 全部 转化 为 单位 线宽 的 线段 ， 采用 基于 轮廓 搜索 的 方法 。 　 　 细线 化 过程 ： 对 目标 像素 集 R ， 确定 骨架 像素 和 R 的 轮廓 像素 ， 然后 ， 移 去 所有 不是 骨架 的 轮廓 像素 ， 并且 用 这样 求出 的 集 代替 R ； 重复 这一 过程 ， 直至 剩下 仅 由 骨架 像素 所 组成 的 集 为止 。 　 　 d 矢量化 将 图形 文件格式 转化 为 等高线 数据文件 ， 将 等高线 的 图形文件 转化 为 坐标 的 数据文件 。 对于 用于 存储 和 显示 的 可以 采用 Freeman 直线 链码 方法 ， 对于 等高线 的 矢量化 采用 方向 优先 搜索 的 改进 方法 。 　 　 基于 三维 显示 用 的 等高线 的 矢量化 有 其 特殊性 ， 具体 实现 时 我们 注意 了 以下几点 ： 等高线 数据文件 存储 格式 ： 等高线 坐标 数据 以 一个 高层 为 一个 数据文件 存储 ； 解决 多 分支 的 跟踪 算法 ： 此 部分 程序 采用 堆栈 存储 的 方法 。 若 搜索 点 周围 有 一条 以上 的 路径 （ 不 包括 搜索 过来 的 路径 ） ， 即 有 分支 ， 则 将 此点 坐标 压入 堆栈 存储 。 沿 一条 路径 搜索 结束 后 再 将 压入 堆栈 的 搜索 点弹 出 ， 向 另 一支 搜索 。 这样 可 解决 多 分支 的 问题 ； 起始 点 确定 的 方法 ： 由于 每个 高层 值要 当场 输入 ， 最好 的 方法 是 采用 人机交互 的 方法 输入 高层 值 。 　 　 e 依 等高线 数据 生成 三维 模型 ， 对 等高线 数据 进行 插值 运算 ， 生成 可以 读入 DS 的 asc 三维空间 网格 文件 。 　 　 网格 点 三维 坐标 生成 ： 由 用户 输入 网格 大小 ， 由 图形 左上 点 向 右 下点 对 网格 结点 进行 线性插值 ， 插值 时 从 等高线 数据文件 中 搜索 距离 此点 最近 等高线 的 坐标值 和 高层 值 ， 并 对 当前 网格 点 进行 线性插值 ， 将 X 、 Y 、 Z 值 写入 点 数据文件 。 　 　 当 所有 网格 点 三维 坐标 生成 完毕 后 ， 则 根据 网格 点 坐标 生成 网格 面 坐标 ， 并 进一步 生成 asc 三维空间 网格 文件 。 　 　 f 将 DS 模型 数据 和 材料 属性 转化成 SGI 上 所能 使用 的 SuperView 格式文件 ， 并 在 工作站 上 运行 我们 编制 的 虚拟环境 生成器 来 进行 三维 虚拟现实 显示 。 　 　 大坝 模型 、 地下 厂房 模型 的 建立 　 大坝 和 地下 厂房 的 工程图 均 属于 精确 的 施工 图纸 ， 其 建模 方法 类似 。 利用 Autocad 软件 从 施工 设计 CAD 图中 抽取 较为 精确 的 模型 数据 ， 输入 DS 中 进行 建模 ， 在 DS 中 逐步 调整 各种 模型 的 材料 属性 ， 使 之 接近 真实 物体 。 最后 ， 将 DS 模型 数据 和 材料 属性 转化成 SGI 工作站 所 能 使用 的 SuperView 格式文件 。 　 　 建好 的 模型 示意图 如图所示 ： 图 　 枢纽 布置 三维 模型 列表 　 虚拟环境 发生器 　 　 SGIIndigo 工作站 是 性能 较 好 的 图形工作站 ， 它 自带 了 许多 高性能 的 图形库 ， 以 方便 用户 开发 ， 其中 ， Performance 库 就是 专门 用于 虚拟环境 、 视觉 仿真 的 图形库 。 Performance 面向 硬件 结构 ， 能 提供 多通道 的 高 解析度 （ × ） 输出 ， 并 支持 多个 CPU 。 根据 硬件 配置 ， Performance 能 自动 调整 选择 最佳 运行 状态 ， 以 产生 每秒 帧 的 光滑 画面 输出 。 Performance 还 支持 第三方 厂家 的 数据文件 。 我们 利用 Performance 库 强大 的 功能 ， 编制 了 虚拟环境 发生 程序 。 只要 输入 三维 模型 文件 ， 便 可 生成 虚拟现实 世界 。 虚拟环境 发生 程序 的 结构 框图 如图所示 。 图 　 虚拟环境 发生 程序 的 结构 框图 　 　 由于 大坝 模型 组成部分 众多 如图所示 ， 若 将 全部 模型 调入 ， 数据量 巨大 ， 运行 速度慢 ， 视觉 感官 不 甚 流畅 ， 所以 我们 提供 了 可选择性 地 调入 所 需 三维 模型 的 功能 ， 用户 可 根据 需要 调入 模型 ， 例如 ， 用户 可 只 调入 大坝 的 模块 ， 而无须 将 地下 厂房 和 地形 模块 调入 。 另外 ， 考虑 到 用户 在 复杂 繁多 的 二滩 虚拟环境 中 漫游 容易 迷失方向 ， 我们 又 特意 编制 一 程序 与 虚拟环境 发生 程序 进行 通讯 ， 建立 数据通道 ， 实时 取得 用户 视点 的 当前 三维 位置 ， 并 在 虚拟环境 界面 旁边 生成 一个 俯视 的 平面 示意图 ， 图内 一 小圆点 随 用户 视点 变化 而 移动 如图所示 。 类似 于 某些 汽车 游戏 中 的 汽车 当前 位置 示意图 。 图 　 左图 为 某 一 视点 下 的 虚拟现实 三维图 ， 右图 为 俯视 的 平面 示意图 　 　 （ 俯视 的 平面 示意图 中 接近 底部 有 一 圆点 代表 当前 视点 位置 ） 　 交互方式 　 　 本 系统 的 交互 手段 较为简单 ， 用户 利用 鼠标 与 虚拟环境 进行 交互 ， 通过 鼠标 控制 漫游 方向 及 速度 ， 另外 ， 还 可 通过 从 菜单 中 设置 运动 方式 改变 交互方式 。 　 　 根据 运动 规律 ， 模拟 人 在 虚拟环境 中 的 运动 情况 ， 我们 提供 了 三种 运动 模式 ： 跟踪 （ Track ） 、 行走 （ Drive ） 、 飞行 （ Fly ） 。 　 　 用户 可 利用 这 三种 方式 轻松 游览 于 二滩 环境 中 。 其中 ， 跟踪 可以 用 鼠标 任意 移动 、 翻转 对象 （ 用户 的 视点 在 对象 外部 ） ； 行走 模拟 人 在 地面 的 行走 状态 ； 飞行 可以 设置 碰撞 模式 ， 碰撞 模式 若 开启 ， 则 会 有 反弹 效果 ， 碰撞 模式 若 关闭 则 为 可 穿墙 状态 ， 用户 可 穿越 障碍物 任意 飞翔 进行 漫游 ， 能力 大大 超过 电影 《 超人 》 中 的 超人 。 　 虚拟现实 在 水利 系统 中 的 应用 前景 　 用于 大型 水利 设施 的 设计 中 　 　 由于 大型 水利 设施 的 建造 不同于 一般 的 建筑 ， 它 往往 投资 大 ， 周期长 ， 不 可能 事先 进行 试验 ， 比如 已 建成 的 二滩 大坝 ， 正在 建 的 三峡大坝 ， 坝 高 都 在 米 以上 ， 耗资 巨大 。 所以 一个 合理 可行 的 大坝 施工 设计 是 事关 国民 生计 的 大事 。 　 　 在 大坝 设计阶段 中 ， 通常 用 传统 的 二维 图纸 设计 方法 ， 这种 方法 由于 是 二维 的 ， 它 限制 了 人们 的 空间设计 能力 ， 若能 结合 先进 的 三维 虚拟现实 技术 ， 可用 来 考察 设计 出 的 大坝 是否 结构合理 ， 有 无需 改进 之 处 ， 如 有 ， 进行 改进 ； 改进 后 ， 重新 建模 进行 虚拟现实 显示 ， 再次 考察 改进 ； 如此 经过 若干次 反馈 ， 最终 将会 得到 令人满意 的 设计 结果 。 在 计算机 进行 模拟 建造 的 投资 与 大坝 实际 建造 的 投资 相比 是 微不足道 的 ， 但 却 能 取得 很 好 的 经济效益 。 　 电子 沙盘 　 　 大坝 一旦 建成 ， 对于 它 的 许多 结构 ， 水利 专家 和 旅游者 只能 进行 远观 ， 无法 看清楚 具体 的 构造 ， 比如 大坝 的 表 、 中 、 底孔 及 大坝 内部 的 一些 结构 等 。 一旦 有 了 虚拟现实 环境 ， 用户 不但 可以 细看 任何 结构 ， 甚至 可以 享有 现实 世界 不 可能 有 的 能力 ， 穿越 墙壁 任意 游览 。 　 可以 模拟 一定 物理 条件 下 大坝 的 安全 状态 　 　 如 给定 假设 的 某 一 外界 作用 ， 可 观察 大坝 的 运行 状态 。 例如 ， 我们 利用 SGI 高档 机型 上 的 特定 软件 再现 了 二滩 大坝 中孔 泄洪 、 中表孔 对撞 泄洪 等 宏伟 壮观 的 场面 。 作者简介 ： 梁 　 民 　 刘珍平 　 研究生 。 主要 研究 方向 ： 三维 图形 、 科学 可视化 、 数据库 应用 。 　 　 　 　 　 　 张培仁 　 教授 。 主要 研究 方向 ： 远程 监控 网络 、 现场 总线 等 。 　 梁 　 兵 　 讲师 。 主要 　 　 　 　 　 研究 方向 ： 应用 数学 。 作者 单位 ： 梁 　 民 　 刘珍平 　 张培仁 　 中国 科学技术 大学 自动化系 　 安徽 ． 合肥 （ ） 　 　 　 　 　 梁 　 兵 　 成都 电子机械 高等 专科学校 数学系 　 四川 ． 成都 （ ） 参考文献 　 ［ ］ 　 王维 平 胡晓峰 沙基昌 灵境 技术 及其 在 仿真 中 应用 展望 系统 仿真 学报 ， 　 ［ ］ 　 敬万钧 ， 刘锦德 虚拟现实 中 的 视觉 系统 与其 实现 技术 计算机 应用 ， ， 收稿 日期 修改稿 　