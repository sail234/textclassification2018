微型机 与 应用 MICROCOMPUTERITSAPPLICATIONSVolNoPWeb 邮件系统 的 设计 和 实现 贺 红心 　 谢 洪涛 　 卜淮原 　 　 摘 　 要 ： WEB 邮件 服务 系统 的 原理 、 特点 和 它 与非 WEB 邮件 服务 的 区别 并 探讨 了 基于 IIS 的 WEB 邮件 服务 系统 的 设计 和 实现 　 　 关键词 ： WEB 邮件 服务 SMTP 服务器 POP 服务器 CDforNTS 组件 　 　 电子邮件 服务 是 网络服务 最早 和 最 基本 的 功能 之一 许多 邮件 服务器软件 都 可以 建立 电子邮件系统 。 常用 的 邮件 服务器软件 有 LoutusNotes 、 MicrosoftExchangeServer 等 。 而 传统 的 邮件系统 一般 是 客户机 服务器 结构 它们 本身 比较复杂 与 操作系统 的 集成度 低 额外 占用 了 服务器 的 资源 影响 了 系统 的 性能 增加 了 系统 的 管理负担 。 同时 每种 邮件 软件 都 有 服务器端 软件 和 特定 的 客户端 软件 增加 了 系统 的 构造 成本 。 而 微软 新 推出 的 IIS 加 了 许多 新 的 功能 其中 的 IISSMTP 服务器 组件 提供 了 便捷 高效 的 Web 邮件 服务 可望 有效 解决 传统 邮件系统 的 不足 。 传统 邮件系统 的 运行 机理 　 　 传统 邮件系统 一般 由 发送 系统 和 接收 系统 二 部分 组成 。 发送 系统 负责 邮件 从 客户端 邮件 程序 （ 如 outlookexpress 等 ） 到 邮件 服务器 从个 邮件 服务器 到 另个 远程 邮件 服务器 的 传送 。 接收 系统 负责 用户 从 邮件 服务器 把 邮件 接收 到 客户端 邮件 程序 的 用户 收件箱 。 用户 使用 特定 的 客户端 邮件 程序 收发 邮件 。 邮件 的 发送 和 SMTP 服务器 　 　 邮件 的 传递 过程 是从 像 OutlookExpress 这样 的 客户端 邮件 程序 将 封 电子邮件发送 给 个 SMTP 服务器 开始 的 。 个 客户端 只 知道 个 与 之 相连 的 SMTP 服务器 所以 本地 客户 发出 的 全部 邮件 不管 其 目的 地址 是 哪里 都 将 发送到 同一个 服务器 。 然后 本地 的 SMTP 服务器 负责 决定 如何 处置 该 邮件 。 　 　 相连接 的 所有 SMTP 服务器 都 可以 通过 SMTP 协议 相互 通信 。 当 封电子邮件 从 客户端 发送到 SMTP 服务器 后 服务器 检查 邮件 的 目的 地址 如果 目的 地址 就是 本 地域 的 SMTP 服务器 邮件 就 会 一直 被 存放 在 本地 SMTP 服务器 的 邮件 库中 直到 收件人 访问 服务器 取回 自己 的 邮件 。 如果 邮件 的 目的 地址 是 另 一个 远程 域 的 SMTP 服务器 SMTP 服务器 就 查询 DNSMailExchanger 记录 该 记录 为 进入 相应 域 的 所有 邮件 提供 SMTP 服务器 的 IP地址 在 找到 该 地址 后 本地 的 SMTP 服务器 就 会 把 邮件 从 本地 邮件 库 发送到 该 地址 的 SMTP 服务器 。 所以 在 这种 情况 下 邮件 先 从 用户 的 发件箱 发送到 本地 SMTP 服务器 再 从 本地 SMTP 服务器发送 到 目的 域 的 SMTP 服务器 。 邮件 的 接收 和 POP 服务器 　 　 SMTP 协议 只 负责 邮件 从 客户端 发送到 目的 域 的 SMTP 服务器 用户 要 从 服务器 接收 邮件 服务器端 还 必须 提供 邮件 接收 服务 而 POP 就是 用户 取回 他们 的 邮件 的 协议 POP 服务器 负责 邮件 的 接收 。 　 　 POP 服务器 在 服务器 上 一直 运行 等待 来自 客户端 的 连接 。 当 客户端 试图 连接 到 POP 服务器时 该 客户 使用 邮件 账号 的 用户名 和 密码 来 标示 自己 邮件 服务器 验证 用户 身份 后 POP 服务器 将 该 用户 的 邮件 从 SMTP 邮件 库 发送到 用户 的 收件箱 。 SMTP 服务器 一般 为 每个 用户 设立 个 目录 它 类似 于 用户 的 邮件 箱 。 这种 目录 结构 使得 POP 服务器 可以 高效 地 取出 指定 用户 的 全部 邮件 。 　 图 传统 邮件系统 的 运行 机理 　 　 图 说明 了 传统 邮件系统 的 运行 机理 。 IIS 的 Web 邮件系统 解决方案 基于 IIS 的 Web 邮件系统 的 工作 原理 　 　 对 已经 发送到 SMTP 服务器 邮件 库中 的 邮件 客户 用种 方式 取回 自己 的 邮件 直接 访问 邮件 方式 和 POP 服务器 方式 。 因为 电子邮件 只是 SMTP 服务器 上 的 ASCII 文件 所以 编写 不 使用 POP 服务器 直接 从 邮件 库 访问 邮件 的 程序 是 可行 的 。 基于 IIS 的 Web 邮件系统 使用 的 就是 这种 方式 。 图 IISWeb 邮件系统 的 原理 示意图 　 　 图 表示 了 IISWeb 邮件系统 的 原理图 。 　 　 IISSMTP 服务器 负责 邮件 的 传送 它 为 所有 进入 的 邮件 仅 设立 个 目录 因此 不能 将 用户 的 邮件 分类 进入 个人 邮箱 。 它 或者 将 邮件 发送到 其它 SMTP 服务器 或者 把 邮件 存储 在 全局 邮件 目录 （ 邮件 库 ） 中 IISSMTP 服务器 默认 的 全局 邮件 目录 是 “ MAILROOTDROP ” 目录 。 　 　 由于 没有 POP 服务器 邮件 的 接收 通过 用 ASP 脚本 程序 直接 从 SMTP 邮件 库 检索 邮件 到 Web 浏览器 来 实现 。 ASP 脚本 程序 通过 IIS 的 个 组件 CollaborationDataObjectsforMicrosoftWindowsNTServer （ CDOforNTS ） 提供 的 邮件 对象 访问 邮件 库 邮件 用户 通过 浏览器 收发 邮件 。 IISWeb 邮件系统 的 特点 　 　 IIS 新 增加 的 一系列 功能 组件 不但 增强 了 Web 服务 和 事务处理 功能 更 增加 了 新闻 服务 、 搜索 服务 和 邮件 服务 等 功能 。 IISSMTP 服务器 是 IIS 的 一体化 信息 服务 解决方案 的 重要 组成部分 用 其 构建 的 Web 邮件系统 有 以下 特点 　 　 IIS 的 SMTP 服务器 是 IIS 的 个 组件 它 与 IIS 紧密 集成 在 一起 。 实质 上 IIS 本身 就是 邮件 服务器 这种 方式 使 邮件 服务 无缝 集成 于 IIS 和 操作系统 提高 了 邮件 服务 的 效率 和 系统 的 稳定性 。 　 　 减小 了 系统 复杂性 和 管理负担 。 只须 在 安装 IIS 时 选中 SMTP 邮件 服务 组件 就 可以 在 系统 上 建立 邮件 服务 。 如果 使用 特定 的 邮件 服务 系统 服务器 就 不得不 运行 另 一套 系统 占用 了 额外 的 服务器资源 系统管理员 也 必须 管理 邮件 用户 系统 。 而 IISWeb 邮件系统 则 减小 了 系统 的 复杂性 和 系统管理员 的 负担 。 　 　 容易 实现 构造 成本低 。 使用 SMTP 服务器 组件 可以 轻松 建立 起 Web 邮件 服务 用户 不 需要 安装 任何 邮件 客户 软件 只要 个 Web 浏览器 即可 。 而 其它 邮件系统 每个 用户 必需 安装 特定 的 客户端 邮件 软件 增加 了 实现 的 难度 也 提高 了 系统 构造 成本 和 费用 。 　 　 IISWeb 邮件系统 提供 简单 方便 的 邮件 服务 。 客户 通过 Web 浏览器 就 可以 实现 用户 主动 注册 邮件 帐号 和 邮件 的 收发 也 可以 在 邮件 中 插入 附件 。 同时 用户 也 可以 使用 客户端 邮件 软件 （ 比如 OutlookExpress ） 来 发送 邮件 。 　 　 可 与 其它 邮件系统 很 好 地 协同 服务 。 　 　 IISWeb 邮件系统 也 有 不足 主要 表现 在 下列 方面 　 　 由于 进入 SMTP 服务器 的 所有 邮件 都 放在 了 同一个 目录 中 而 不是 为 每 一个 帐号 创建 个 单独 的 目录 其 检索 速度 相对 较慢 。 　 　 由于 不能 使用 像 OutlookExpress 这样 的 邮件 客户端 软件 接收 邮件 所以 就 不能 使用 能为 用户 提供 许多 方便 的 各种 InboxAssistant 规则 。 　 　 有待 进一步 完善 。 虽然 网络 开发人员 可以 通过 编写 ASP 脚本 程序实现 所有 的 邮件 功能 但 这 要求 开发人员 精通 ASP 而且 不得不 陷入 令人 头疼 的 编程 。 这 与 其它 邮件系统 的 “ 零 编程 ” 比 起来 有着 明显 的 不足 也 影响 了 其 推广 的 速度 。 IISWeb 邮件系统 各 功能 的 实现 　 　 个 邮件 Web 系统 通过 创建 邮件 站点 来 实现 。 邮件 站点 应该 具有 邮件 的 发送 、 帐号 的 注册 和 注销 、 帐号密码 修改 、 在 发出 的 邮件 中 插入 附件 和 加密 邮件 等 功能 。 下面 重点 介绍 收件 、 发件 和 插入 附件 个 关键 功能 的 实现 。 　 　 使用 CDOFORNTS 从 IIS 邮件 库 读取 邮件 　 　 在 访问 邮件 时 用户 通过 邮件 帐号 的 用户名 和 密码 验证 自己 的 身份 用户 帐号 存放 在 个 数据库 中 。 原 脚本 中 也 有 用户 验证 部分 的 脚本 代码 这里 仅 保留 了 读取 邮件 的 脚本 代码 ASP 代码 如下 　 　 language ″ vbscript ″ 　 　 ′ … … 　 　 ′ 验证 邮件 用户 身份 　 　 ′ … … 　 　 setobjsessionservercreateobject （ ″ cdontssession ″ ） 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 建立 邮件 事务 对象 　 　 objsessionlogonsmtpnameemail ′ 登录 到 SMTP 服务器 　 　 setobjinboxobjsessioninbox ′ 建立 对象 邮箱 　 　 setcollmessagesobjinboxmessages ′ 建立 消息 组 对象 　 　 Ifcollmessagescountthen ′ 如果 消息 组中 没有 邮 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 件 就 终止 ASP 的 运行 　 　 responsewrite ″ user ″ name ″ brSorryyouhave 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 noemail ″ 　 　 objsessionlogoff 　 　 responseend 　 endif 　 html 　 headtitlereademailasptitlehead 　 bodytable 　 fornumtocollmessagescount ′ 显示 邮件 　 　 setobjmessagescollmessages （ num ） 　 　 SetcollAttachmentsobjMessagesAttachments 　 trtd 发件人 tdobjmessagessendername 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 tdtr 　 trtd 邮件 主题 tdtdobjmessagessubject 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 tdtr 　 trtd 邮件 内容 td 　 tdtextarearows ″ ″ name ″ S ″ cols ″ ″ ob 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 jmessagestext 　 textareatdtr 　 next 　 tablebodyhtml 　 　 使用 CDOFORNTS 从 Web 页面 发送 邮件 　 　 IIS 邮件系统 不仅仅 支持 从 邮件 客户程序 （ 比如 OutlookExpress ） 发送 邮件 更 重要 的 是 它 支持 用户 直接 从 Web 页面 发送 邮件 。 下面 是 发送 电子邮件 的 ASP 脚本 程序代码 　 　 language ″ vbscript ″ 　 　 fromrequestform （ ″ from ″ ） 　 　 toorequestform （ ″ to ″ ） 　 　 subjectrequestform （ ″ subject ″ ） 　 　 bodyrequestform （ ″ body ″ ） 　 　 setobjnewmailservercreateobject （ ″ cdontsnewmail ″ ） 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 建立 邮件 对象 　 　 　 　 objnewmailsendfromtoosubjectbody ′ 发送 邮件 　 　 setobjnewmailnothing ′ 释放 邮件 对象 　 　 responsewrite ″ Youremailhavebeensent ″ 　 　 　 　 html 　 　 headtitlesendemailasptitlehead 　 　 bodybody 　 　 html 　 　 在 邮件 中 添加 附件 　 　 电子邮件 应该 不仅 能 发送 文本 还 应该 能 在 邮件 中 添加 附件 。 向 邮件 添加 附件 的 过程 是 首先 从 客户端 向 服务器 上载 附件 接着 利用 CDOFORNTS 的 邮件 对象 把 上载 的 附件 添加 到 邮件 中 最后 删除 附件 文件 。 　 　 由于 ASP 不能 操作 客户端 的 文件系统 文件 的 上载 功能 可以 通过 Activex 控件 实现 各种 高级 程序设计 语言 如 VisualBasic 、 VisualC 、 BorlandDelphi 等 都 可以 编写 该 控件 该 控件 能够 以 FTP 方式 上载 文件 。 在 能够 上载 文件 之前 Web 邮件 服务器 必须 开通 FTP 服务 建立 “ c ： inetpubmailrootftpfujian ” 目录 并 把 该 目录 加入 FTP 虚拟目录 附件 就 上载 到 该 目录 建 ″ cinetpubwwwrootwebfujian ″ 目录 并 把 该 目录 加入 Web 虚拟目录 邮件附件 就 暂时 复制到 该 目录 供 收件人 访问 。 　 　 把 上载 到 服务器 上 的 附件 文件 添加 到 邮件 。 其 主要 的 ASP 代码 如下 　 　 　 　 setobjnewmailservercreateobject （ ″ cdontsnewmail ″ ） 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 　 ′ 建立 邮件 对象 　 　 objnewmailAttachfile ″ cinetpubmailrootftpfujianlawerhtm ″ ″ lawerhtm ″ 　 ′ 将 附件 文件 ″ lawerhtm ″ 添加 到 邮件 　 　 　 　 把 邮件 中 的 附件 复制到 个 临时文件 其 主要 代码 如下 　 　 　 　 SetobjAttachcollAttachmentsItem （ i ） 　 　 ′ 建立 邮件附件 对象 其中 collAttachmetns 是 邮件附件 　 　 ′ 集 对象 　 　 filepath ″ cinetpubmailrootftpfujian ″ objAttach 　 　 　 　 　 　 　 name 　 　 objAttachwritetofile （ filepath ） 　 　 　 　 显示 附件 。 　 　 Ahref ″ httpkyswwwserverwebfujianobjAttach 　 　 　 　 　 　 name ″ 　 　 objAttachnamea 建立 IISWeb 邮件系统 　 　 要 建立 IISWeb 邮件系统 必须 在 网络 服务器上安装 IIS 的 SMTP 服务 组件 并 建立 Web 邮件 服务 站点 。 邮件 服务 站点 应该 提供 邮件 的 发送 和 接收 等 服务 这样 所有 能 访问 该 站点 的 用户 都 可以 申请 邮件 帐号 并 使用 站点 提供 的 邮件 服务 。 　 　 单域 网络 下 的 单 Web 邮件 服务器 系统 　 　 这种 情况 适用 于 小型 网络 。 只要 在 该域 的 任何 一台 服务器 上 建立 了 Web 邮件 站点 该域 的 所有 用户 都 可以 通过 浏览器 使用 其 Web 邮件 服务 。 　 　 多域 网络 下 的 单 Web 邮件 服务器 系统 　 　 这种 情况 适用 于 中型 规模 的 网络 。 如果 多域 网络 的 各个 域 之间 已经 通过 路由 设备 连通 那么 只要 在 该 网络 的 任何 个域 的 任何 台 服务器 上 建立 了 Web 邮件 服务 站点 全 网络 的 所有 用户 都 可以 使用 Web 邮件 服务 。 这时 所有 域 的 用户 的 邮件地址 的 域名 部分 都 相同 都 是 Web 邮件 服务 站点 所在 的 域 的 域名 。 如果 要 让 每个 域 的 用户 的 邮件地址 用 自己 所在 域 的 域名 就 必须 在 IIS 管理 控制台 的 SMTP 服务器 上 添加 其它 各域 的 域名 同时 把 这些 新 添加 的 域 设置 为本 地域 所有 的 域名 都 自动 成为 本 地域 的 别名 。 但 这 对 用户 是 透明 的 在 用户 看来 他们 使用 的 就是 他们 所在 域 的 邮件 服务器 。 　 　 多域 网络 下 的 多 Web 邮件 服务器 系统 　 　 这种 系统 适用 于 大型 、 物理 分散 的 网络系统 。 在 这类 网络 中 或者 用户 规模 庞大 或者 域 之间 的 连接 速度 太慢 。 如果 所有 的 用户 都 使用 同一个 Web 邮件 服务器 势必 对 服务器 有 更 高 的 要求 对于 物理 分散 的 网络 在 多 Web 邮件系统 下 用户 可以 就近 服务 节约 了 宝贵 的 带宽 资源 对 通过 低速 信道 连接 的 个 较大 的 域 尤其 如此 。 在 多 Web 邮件 服务器 系统 中 在 每个 SMTP 服务器 上 必须 添加 所有 其它 SMTP 服务器 所在 的 域 并 把 它们 设置 为 远程 域 而且 各 SMTP 服务器 设置 为 允许 相互 转发 邮件 。 这样 各个 域 的 用户 就 可以 相互 发送 电子邮件 了 。 　 　 将 内部 网络 的 电子邮件发送 到 Internet 　 　 在 能够 把 电子邮件发送 到 Internet 之前 内部 网络 必须 直接 或 通过 代理服务器 接入 Internet 之后 在 IISSMTP 服务器 上 设置 邮件 网关 为 智能 主机 。 所有 外出 的 邮件 不 需要 查找 邮件 目的 域 的 MX 记录 都 直接 发送到 邮件 网关 而 不是 本地 SMTP 服务器 邮件 再 从 邮件 网关 被 发送到 目的 Internet 域 。 总结 　 　 将 IISSMTP 和 ASP 相结合 可以 很快 地 建立 Intranet 和 InternetWeb 邮件系统 。 WEB 邮件系统 因 其 简洁 、 构造 成本低 、 管理 简单 、 使用方便 而 受到 网络 开发人员 和 邮件 用户 的 欢迎 。 事实上 许多 Internet 站点 都 已经 开发 出 Web 邮件 服务 站点 并 提供 免费 的 Web 邮件 服务 。 由于 Web 邮件系统 部分 地 克服 了 传统 的 客户机 服务器 结构 的 邮件系统 的 诸多 不足 它 必将 对 传统 的 邮件系统 构成 挑战 和 冲击 。 同时 Web 邮件系统 也 会 在 不断 改良 中 得到 进一步 的 完善 。 贺 红心 （ 重庆市 解放军 后勤 工程学院 研究生 队 ） 谢 洪涛 （ 重庆市 解放军 后勤 工程学院 研究生 队 ） 卜淮原 （ 重庆市 解放军 后勤 工程学院 研究生 队 ） 收稿 日期 ：